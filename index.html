<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>stunova. – Stundenplan</title>
    <style>
        :root {
            --bg: #f8fafc;
            --card: #fff;
            --text: #0f172a;
            --muted: #475569;
            --border: #e5e7eb;
            --accent: #3b82f6;
            --row-h: 64px;
            --left-col-w: 120px;
            --shadow: 0 2px 6px rgba(0, 0, 0, .06), 0 10px 30px rgba(0, 0, 0, .06);
        }

        /* Dark Mode Variables */
        [data-theme="dark"] {
            --bg: #1a1a1a;
            --card: #2d2d2d;
            --text: #e5e5e5;
            --muted: #a0a0a0;
            --border: #404040;
            --accent: #60a5fa;
        }

        /* Learning Mode Variables */
        [data-theme="learning"] {
            --bg: #f0f9ff;
            --card: #f8fafc;
            --text: #0f172a;
            --muted: #475569;
            --border: #cbd5e1;
            --accent: #0ea5e9;
        }

        /* Dark Learning Mode Variables */
        [data-theme="dark-learning"] {
            --bg: #1a1a2e;
            --card: #2d2d3d;
            --text: #e5e5e5;
            --muted: #a0a0a0;
            --border: #404040;
            --accent: #38bdf8;
        }

        html,
        body {
            height: 100%;
        }

        *,
        :before,
        :after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            background: var(--bg);
            color: var(--text);
        }

        [hidden] {
            display: none !important;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 16px;
        }

        header.sticky {
            position: sticky;
            top: 0;
            z-index: 30;
            backdrop-filter: blur(8px);
            background: var(--card);
            border-bottom: 1px solid var(--border);
        }

        /* Mobile navigation at bottom */
        @media (max-width: 768px) {

            /* Keep header at top */
            header.sticky {
                position: sticky;
                top: 0;
                border-bottom: 1px solid var(--border);
                background: var(--card);
            }

            /* Position nav-container at top below header */
            .nav-container {
                position: fixed;
                top: 62px;
                /* Header height + small gap */
                left: 0;
                right: 0;
                z-index: 30;
                display: flex;
                justify-content: center;
                padding: 8px 16px;
                background: var(--card);
                backdrop-filter: blur(10px);
                border-bottom: 1px solid var(--border);
            }

            /* Style nav-island for mobile bottom positioning - match desktop exactly */
            .nav-island {
                display: flex;
                gap: 20px;
                align-items: center;
                justify-content: center;
                background: var(--card);
                border-radius: 50px;
                padding: 4px;
                margin: 8px auto;
                width: max-content;
                position: relative;
            }

            /* Remove gradient overlay on mobile */
            .nav-island::before {
                content: none;
            }

            /* Add padding to body to prevent content from being hidden behind bottom nav */
            body {
                padding-bottom: 80px;
            }
        }

        /* Profile Switch Styling */
        .profile-switch-container {
            position: relative;
            margin-right: 16px;
        }

        /* Profile Selection Layout - Inside nav-main-content */
        .nav-main-content .profile-selection-area {
            position: absolute;
            left: 0;
            top: 0;
            width: 200px;
            background: var(--card);
            border-right: 1px solid var(--border);
            z-index: 100;
            padding: 16px;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
        }

        .nav-main-content .container {
            margin-left: 200px;
            /* Space for profile selection */
        }

        /* Adjust profile switch for nav-main-content position */
        .nav-main-content .profile-selection-area .profile-switch-container {
            margin-right: 0;
            margin-bottom: 16px;
        }

        .nav-main-content .profile-selection-area .profile-switch {
            min-width: 100%;
            width: 100%;
        }

        .nav-main-content .profile-selection-area .profile-switch-dropdown {
            left: 0;
            right: 0;
            width: 100%;
        }

        /* Overview section: open profile dropdown to the side */
        .ov-section .profile-selection-area {
            position: relative;
        }

        .ov-section .profile-selection-area .profile-switch-dropdown {
            position: absolute;
            top: 0;
            right: calc(100% + 8px);
            left: auto;
            width: 160px;
            max-height: 360px;
            overflow-y: auto;
            display: none;
            opacity: 1;
            visibility: visible;
            transform: none;
            margin-top: 0;
            z-index: 40;
        }

        .ov-section .profile-selection-area .profile-switch-dropdown.open {
            display: block;
        }

        /* On narrow screens, fall back to below the trigger */
        @media (max-width: 900px) {
            .ov-section .profile-selection-area .profile-switch-dropdown {
                position: static;
                left: auto;
                width: 100%;
                margin-top: 8px;
            }

            .plan-week-nav .profile-selection-area .profile-switch-dropdown {
                position: static;
                left: auto;
                right: auto;
                width: 100%;
                margin-top: 8px;
            }
        }

        /* Centered Banner Styling */
        .centered-banner {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 16px;
            margin-bottom: 16px;
        }

        .centered-banner .current-banner {
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
        }

        /* Center the current-stripe element */
        .centered-banner .current-stripe {
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
        }

        /* Position the "keine stunden geplant" box inside container */
        #currentWrap {
            width: 100%;
            max-width: 600px;
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        /* Adjust current-stripe for fixed positioning */
        #currentWrap .current-stripe {
            border-radius: 0 0 20px 20px;
            margin: 0;
            width: 80%;
            max-width: 600px;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .nav-main-content .profile-selection-area {
                position: relative;
                left: auto;
                top: auto;
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                padding: 12px 16px;
            }

            /* Adjust positioning for mobile */
            #currentWrap {
                width: 100%;
                padding: 0 16px;
                margin: 20px 0;
            }

            /* Adjust page container padding for mobile */
            .page-container {
                padding-top: 120px;
                /* Space for header + nav-container on mobile */
            }

            .nav-main-content .container {
                margin-left: 0;
            }

            .nav-main-content .profile-selection-area .profile-switch {
                min-width: auto;
                width: auto;
            }

            .centered-banner {
                margin-top: 12px;
                margin-bottom: 12px;
            }
        }

        .profile-switch {
            display: flex;
            align-items: center;
            padding: 8px 5px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 125px;
            font-size: 13px;
            gap: 8px;
        }

        .profile-switch:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .profile-switch-current {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .profile-switch-chevron {
            width: 16px;
            height: 16px;
            color: var(--muted);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-switch-chevron svg {
            width: 12px;
            height: 12px;
        }

        .profile-switch-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #e2e8f0;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--muted);
            flex-shrink: 0;
        }

        .profile-switch-avatar svg {
            width: 12px;
            height: 12px;
        }

        .profile-switch-info {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }

        .profile-switch-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-switch-type {
            font-size: 12px;
            font-weight: 400;
            color: var(--muted);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-switch-arrow {
            width: 12px;
            height: 12px;
            color: var(--muted);
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }

        .profile-switch.open .profile-switch-arrow {
            transform: rotate(180deg);
        }

        .profile-switch-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.2s ease;
            margin-top: 8px;
        }

        .profile-switch-dropdown.open {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .profile-switch-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border);
        }

        .profile-switch-header h4 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .profile-switch-add {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--muted);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-switch-add:hover {
            background: var(--accent);
            color: var(--card);
            border-color: var(--accent);
        }

        .profile-switch-add svg {
            width: 14px;
            height: 14px;
        }

        .profile-switch-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .profile-switch-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--border);
        }

        .profile-switch-item:last-child {
            border-bottom: none;
        }

        .profile-switch-item:hover {
            background: var(--card);
        }

        .profile-switch-item.active {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--accent);
        }

        .profile-switch-item-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--card);
            flex-shrink: 0;
        }

        .profile-switch-item-avatar svg {
            width: 14px;
            height: 14px;
        }

        .profile-switch-item-info {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
        }

        .profile-switch-item-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-switch-item-type {
            font-size: 11px;
            color: var(--muted);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-switch-item-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .profile-switch-item:hover .profile-switch-item-actions {
            opacity: 1;
        }

        .profile-switch-item-action {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--muted);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-switch-item-action:hover {
            background: var(--accent);
            color: var(--card);
            border-color: var(--accent);
        }

        .profile-switch-item-action svg {
            width: 12px;
            height: 12px;
        }

        /* Profile Creation Form Styles */
        .profile-creation-form {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            background: var(--card);
        }

        .profile-form-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text);
        }

        .form-group input {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            background: var(--card);
            transition: border-color 0.2s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .form-actions .btn {
            flex: 1;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .form-actions .btn-primary {
            background: var(--accent);
            color: var(--card);
        }

        .form-actions .btn-primary:hover {
            background: var(--accent);
        }

        .form-actions .btn-secondary {
            background: var(--border);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .form-actions .btn-secondary:hover {
            background: var(--border);
        }

        .profile-switch-item-action.favorite-btn {
            color: #fbbf24;
        }

        .profile-switch-item-action.favorite-btn.favorited {
            color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .profile-switch-item-action.favorite-btn:hover {
            background: #fbbf24;
            color: var(--card);
            border-color: #fbbf24;
        }

        .profile-switch-item-action.delete-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: var(--border);
            color: var(--muted);
            border-color: var(--border);
        }

        .profile-switch-item-action.delete-btn:disabled:hover {
            background: var(--border);
            color: var(--muted);
            border-color: var(--border);
        }

        .favorite-indicator {
            color: #f59e0b;
            font-size: 12px;
            margin-left: 4px;
        }


        .hstack {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            padding: 6px 0;
            gap: 12px;
        }

        h1 {
            font-size: 20px;
            margin: 0;
            font-weight: 800;
            letter-spacing: -.01em;
            min-width: 120px;
            text-align: left;
        }

        .nav-island {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            background: var(--card);
            border-radius: 50px;
            padding: 4px;
            margin: 8px auto;
            width: max-content;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border);
        }

        .pill-slider {
            display: none;
        }

        .nav-island::before {
            content: none;
        }

        .pill {
            appearance: none;
            border: 0;
            border-radius: 50%;
            padding: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            background: transparent;
            color: var(--muted);
            transition: color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            min-width: 36px;
            height: 36px;
            width: 36px;
            text-align: center;
            letter-spacing: 0.025em;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pill::before {
            display: none;
        }

        .pill:hover {
            color: var(--text);
            background: rgba(99, 102, 241, 0.1);
            border-radius: 50%;
        }

        .pill:hover::before {
            opacity: 0.1;
        }


        /* Navigation icons */
        .nav-icon {
            width: 22px;
            height: 22px;
            stroke-width: 2;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .pill:hover .nav-icon {
            transform: scale(1.1);
        }

        .pill.primary .nav-icon {
            stroke: var(--card);
        }

        .pill:not(.primary) .nav-icon {
            stroke: var(--muted);
        }

        .pill:hover:not(.primary) .nav-icon {
            stroke: var(--accent);
        }

        .btn {
            appearance: none;
            border: 0;
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer
        }

        .btn.primary {
            background: var(--text);
            color: var(--card)
        }

        .btn.ghost {
            background: var(--border);
            color: var(--text)
        }

        .btn.danger {
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent)
        }

        .btn.mini {
            padding: 6px 10px;
            font-size: 12px;
            border-radius: 10px;
            transition: transform 0.15s ease;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: var(--shadow)
        }

        main {
            padding: 12px 0 24px
        }

        footer {
            padding: 24px 0 48px;
            color: var(--muted);
            font-size: 12px
        }

        .layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            ;
            align-items: start
        }

        @media (max-width:1024px) {
            .layout {
                grid-template-columns: 1fr
            }

            .sidebar {
                position: static
            }
        }

        .grid-wrap {
            position: relative;
            overflow: hidden
        }

        .grid {
            display: grid;
            grid-template-columns: var(--left-col-w) 1fr
        }

        .grid.has-days {
            grid-template-columns: var(--left-col-w) repeat(var(--day-count), 1fr)
        }

        .grid .head {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            padding: 12px;
            font-weight: 700;
            text-align: center
        }

        .grid .head.time {
            text-align: center
        }

        .time-col {
            position: relative
        }

        .time-cell {
            height: var(--row-h);
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: space-between;
            padding: 6px 8px 6px 0;
            color: var(--muted);
            font-size: 14px;
            border-bottom: 1px solid var(--border);
            min-width: 80px;
            width: 100%;
            box-sizing: border-box;
        }

        .time-cell>div {
            text-align: right;
            width: 100%;
        }

        .day-col {
            position: relative;
            overflow: hidden;
        }

        .cell {
            position: relative;
            height: var(--row-h);
            border-left: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            background: var(--card);
            contain: layout style paint;
            will-change: background-color;
        }

        .cell.over {
            background: rgba(239, 68, 68, 0.1)
        }

        /* Placeholder row cells that together form a full-width row */
        .placeholder-row {
            height: var(--row-h);
            background: rgba(99, 102, 241, 0.06);
            border-top: 2px dashed #6366f1;
            border-bottom: 2px dashed #6366f1;
            border-left: 0;
            border-right: 0;
            box-sizing: border-box;
            pointer-events: none;
        }

        .placeholder-row.first {
            border-left: 2px dashed #6366f1;
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
        }

        .placeholder-row.last {
            border-right: 2px dashed #6366f1;
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        /* Row drag-and-drop visual feedback - placeholder row */
        .time-cell.drop-zone-active {
            position: relative;
        }

        /* Single full-width placeholder overlay for row reordering */
        .row-placeholder-overlay {
            position: absolute;
            height: var(--row-h);
            left: var(--left-col-w);
            right: 0;
            background: rgba(99, 102, 241, 0.06);
            border-top: 2px dashed #6366f1;
            border-bottom: 2px dashed #6366f1;
            pointer-events: auto;
            z-index: 15;
        }

        /* Click-to-move: selected source row hint */
        .row-pick-source {
            position: absolute;
            height: var(--row-h);
            left: 0;
            width: var(--left-col-w);
            border: 2px dashed #6366f1;
            border-right: none;
            background: rgba(99, 102, 241, 0.06);
            z-index: 14;
            pointer-events: none;
        }

        /* Row drag handle (six dots, 3x2 grid) shown left of row number */
        .row-drag-handle {
            position: absolute;
            left: 0;
            /* align near the very left inside the time column */
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 14px;
            display: grid;
            grid-template-columns: repeat(2, 4px);
            /* 2 columns */
            grid-template-rows: repeat(3, 4px);
            /* 3 rows (vertical) */
            gap: 3px;
            align-content: center;
            justify-content: center;
            pointer-events: none;
            /* purely visual; dragging still works on the cell */
        }

        .row-drag-handle span {
            width: 4px;
            height: 4px;
            background: #94a3b8;
            border-radius: 50%;
            opacity: .9;
        }

        .time-cell.drop-zone-active::after {
            content: "";
            position: absolute;
            bottom: -32px;
            left: 0;
            right: 0;
            height: 64px;
            background: rgba(99, 102, 241, 0.1);
            border: 2px dashed #6366f1;
            border-radius: 8px;
            z-index: 1000;
            pointer-events: none;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 0.4;
            }

            50% {
                opacity: 0.8;
            }
        }

        .cell .add {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent);
            border: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            z-index: 1;
            transition: all 0.2s ease;
            opacity: 0.8;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
        }

        .cell .add:hover {
            background: var(--accent);
            color: var(--card);
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            opacity: 1;
        }

        .cell .add[hidden] {
            display: none
        }

        .lesson {
            position: absolute;
            left: 8px;
            right: 8px;
            border-radius: 5px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0, 0, 0, .06);
            padding: 12px 12px 24px;
            cursor: grab;
            user-select: none;
            overflow: hidden;
            z-index: 2;
            background: var(--card)
        }

        .lesson .row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 8px;
        }

        .lesson .subject {
            font-size: 14px;
            font-weight: 800;
            line-height: 1.2
        }

        .lesson .sub {
            font-size: 12px;
            opacity: .9
        }

        .lesson .room {
            font-size: 12px;
            font-weight: 700;
            opacity: .9
        }

        .lesson .footer {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 20px;
            background: rgba(0, 0, 0, .1);
            font-size: 11px;
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            border-top: 1px solid rgba(0, 0, 0, .06);
            backdrop-filter: saturate(1.4) blur(4px)
        }

        .lesson[data-span="1"] {
            padding: 10px 10px 22px
        }

        .lesson[data-span="1"] .sub,
        .lesson[data-span="1"] .room {
            display: none
        }

        .resizer {
            position: absolute;
            left: 0%;
            right: 0px;
            bottom: 0px;
            height: 20px;
            cursor: ns-resize;
            border-radius: 10px;
            z-index: 10;
            pointer-events: auto;
        }

        .lesson .colorbar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            border-top-left-radius: 16px;
            border-bottom-left-radius: 16px;
            background: currentColor;
            opacity: .9;
            z-index: 1
        }

        .lesson.dragging {
            opacity: .9;
            filter: saturate(1.05);
            outline: 2px dashed rgba(0, 0, 0, .15);
            outline-offset: -4px;
            transform: scale(1.01)
        }

        .lesson.resizing {
            cursor: ns-resize
        }

        .lesson.important {
            background: #fef3c7 !important;
            border: 2px solid #f59e0b !important;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3), var(--shadow) !important;
        }

        .lesson.important .colorbar {
            background: #f59e0b !important;
            opacity: 1;
        }

        /* Completed day column styling */
        .day-col.completed {
            background: rgba(34, 197, 94, 0.1) !important;
            position: relative;
        }

        .day-col.completed::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: 900;
            color: var(--muted);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            z-index: 5;
        }

        .legend {
            margin-top: 16px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            ;
            font-size: 12px;
            color: var(--muted)
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--border);
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 4px 8px;
            font-size: 12px
        }

        .current-stripe {
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent) var(--progress-width, 0%), var(--accent) var(--progress-width, 0%), var(--accent) 100%);
            backdrop-filter: blur(20px);
            border: none;
            border-radius: 0 0 20px 20px;
            padding: 12px 240px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 50px;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .current-stripe:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(25px);
        }

        .current-banner {
            background: var(--accent);
            backdrop-filter: blur(10px);
            border-radius: 12px 12px 0 0;
            padding: 2px;
            margin-bottom: -8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--card);
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
            width: 480px;
            margin-left: auto;
            margin-right: auto;
        }

        .current-folder-box {
            width: 44px;
            height: 44px;
            background: var(--folder-color, #f1f5f9);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            z-index: 1;
            flex-shrink: 0;
        }

        .current-folder-box::before {
            content: '';
            width: 18px;
            height: 14px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 2px;
            position: relative;
            transition: all 0.2s ease;
        }

        .current-folder-box::after {
            content: '';
            position: absolute;
            top: 6px;
            left: 50%;
            transform: translateX(-50%);
            width: 14px;
            height: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 1px;
            transition: all 0.2s ease;
        }

        .current-folder-box:hover {
            transform: scale(1.02);
            background: var(--folder-color, #e2e8f0);
        }

        .current-folder-box:hover::before {
            background: rgba(255, 255, 255, 1);
        }

        .current-folder-box:hover::after {
            background: rgba(255, 255, 255, 0.9);
        }

        .current-status {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: var(--card);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        .current-left {
            display: flex;
            flex-direction: column;
            gap: 4px;
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            padding-left: 20px;
            z-index: 1;
        }

        .current-right {
            display: flex;
            align-items: center;
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            padding-right: 20px;
            z-index: 1;
        }

        .current-subject {
            font-weight: 700;
            font-size: 16px;
            color: var(--card);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
            font-family: sans-serif;
        }

        .current-time-range {
            color: var(--text);
            font-size: 14px;
            white-space: nowrap;
            font-weight: 400;
            font-family: sans-serif;
        }

        .current-subject-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .current-room-teacher {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .current-room {
            font-size: 11px;
            color: var(--text);
            font-weight: 500;
            font-family: sans-serif;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .current-teacher {
            font-size: 11px;
            color: var(--text);
            font-weight: 500;
            font-family: sans-serif;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }


        .current-right-section {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .current-status-label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 600;
            text-transform: uppercase;
            font-family: sans-serif;
            letter-spacing: 0.5px;
        }

        .current-time-label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 600;
            text-transform: uppercase;
            font-family: sans-serif;
            letter-spacing: 0.5px;
        }

        .current-meta {
            font-size: 12px;
            color: var(--text);
            white-space: nowrap;
            font-weight: 400;
            font-family: sans-serif;
        }

        .current-time {
            font-weight: 700;
            font-size: 20px;
            color: var(--card);
            white-space: nowrap;
            font-family: sans-serif;
        }

        .current .title {
            font-weight: 700
        }

        .progress {
            height: 4px;
            background: var(--border);
            border-radius: 999px;
            overflow: hidden;
            margin: 0;
        }

        .progress>div {
            height: 100%;
            background: var(--accent);
            border-radius: 999px;
        }

        .redline {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent);
            box-shadow: 0 0 0 1px rgba(59, 130, 246, .25);
            pointer-events: none;
            /* do not block hover/updates */
            z-index: 30;
            /* keep above overlays */
        }

        .green-overlay {
            position: absolute;
            background: rgba(34, 197, 94, 0.1);
            pointer-events: none;
            z-index: 12;
            /* below redline, above grid */
        }

        .completed-day-overlay {
            position: absolute;
            background: rgba(34, 197, 94, 0.1);
            pointer-events: none;
            z-index: 14;
        }

        .day-checkmark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            font-weight: 900;
            color: #22c55e;
            pointer-events: none;
            z-index: 12;
            text-shadow: 2px 2px 4px rgba(34, 197, 94, 0.7);
            opacity: 0.3;
        }

        /* Row highlighting for timetable and heatmap */
        .row-highlight {
            position: absolute;
            left: 0;
            right: 0;
            background: rgba(99, 102, 241, 0.1);
            border: 2px solid rgba(99, 102, 241, 0.3);
            pointer-events: none;
            z-index: 1;
            transition: all 0.2s ease;
        }

        .timetable-row-highlight {
            background: rgba(99, 102, 241, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .heatmap-row-highlight {
            background: rgba(99, 102, 241, 0.12);
            border: 2px solid rgba(99, 102, 241, 0.4);
        }

        .redline-tip {
            position: absolute;
            transform: translate(-50%, -100%);
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 4px 8px;
            font-size: 12px;
            color: var(--accent);
            box-shadow: var(--shadow);
            white-space: nowrap;
            pointer-events: none;
            z-index: 20
        }

        .sidebar {
            position: sticky;
            top: 88px
        }

        .side-card {
            padding: 12px
        }

        .accordion {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        details {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 8px
        }

        summary {
            list-style: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 700
        }

        summary::-webkit-details-marker {
            display: none
        }

        .side-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            ;
            margin-top: 8px
        }

        .side-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .side-row input {
            flex: 1
        }

        .small {
            font-size: 12px;
            color: var(--muted)
        }

        .folders-wrap {
            padding: 12px
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            ;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px
        }

        .dropzone {
            border: 2px dashed #cbd5e1;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: var(--card)
        }

        .dropzone.over {
            background: #eef2ff;
            border-color: #a5b4fc
        }

        .folders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
            gap: 14px;
            ;
            margin-top: 12px
        }

        .folder-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 0 12px 12px;
            box-shadow: var(--shadow);
            position: relative
        }

        .folder-top {
            height: 48px;
            display: flex;
            align-items: end;
            gap: 10px;
            ;
            padding-top: 8px
        }

        .folder-shape {
            position: relative;
            width: 48px;
            height: 34px;
            border-radius: 8px 8px 6px 6px;
            background: var(--border);
            flex: 0 0 auto
        }

        .folder-tab {
            position: absolute;
            top: -10px;
            left: 6px;
            width: 18px;
            height: 10px;
            border-radius: 6px 6px 0 0;
            background: rgba(0, 0, 0, .1)
        }

        .folder-name {
            font-weight: 800;
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap
        }

        .count-badge {
            font-size: 12px;
            background: #111827;
            color: var(--card);
            padding: 2px 8px;
            border-radius: 999px
        }

        .folder-actions {
            display: flex;
            gap: 6px;
            margin-top: 10px
        }

        .drag-handle {
            position: absolute;
            right: 10px;
            top: 10px;
            font-size: 14px;
            color: var(--muted);
            cursor: grab
        }

        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 10px;
        }

        .file-tile {
            border: 1px dashed #e5e7eb;
            border-radius: 12px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            ;
            background: #fff
        }

        .file-ico {
            width: 44px;
            height: 56px;
            border-radius: 6px;
            position: relative;
            background: #eef2f7;
            display: grid;
            place-items: center;
            font-weight: 800
        }

        .file-ico::after {
            content: "";
            position: absolute;
            right: 0;
            top: 0;
            border-left: 10px solid transparent;
            border-bottom: 10px solid #d1d5db;
            border-top-right-radius: 4px
        }

        .ext {
            font-size: 12px;
            background: #111827;
            color: var(--card);
            border-radius: 999px;
            padding: 2px 6px;
            align-self: start
        }

        .file-name {
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis
        }

        .file-meta {
            font-size: 12px;
            color: var(--muted)
        }

        .tile-actions {
            display: flex;
            gap: 6px;
            justify-content: flex-end
        }

        .settings-wrap {
            padding: 12px
        }

        .grid2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .field {
            margin-top: 10px
        }

        .field label {
            font-size: 13px;
            font-weight: 600;
            display: block
        }

        .field input,
        .field select {
            margin-top: 6px;
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 14px;
            background: #fff
        }

        .modal[aria-hidden="true"] {
            display: none
        }

        .modal[aria-hidden="false"] {
            position: fixed;
            inset: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, .3);
            backdrop-filter: blur(4px)
        }

        .modal .dialog {
            position: relative;
            z-index: 2;
            background: var(--card);
            border-radius: 16px;
            padding: 28px 28px 24px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 6px 40px rgba(0, 0, 0, .25);
            width: min(500px, 95%);
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .modal .backdrop {
            position: absolute;
            inset: 0;
            z-index: 1
        }

        .close-x {
            position: absolute;
            top: 10px;
            right: 14px;
            border: none;
            background: none;
            font-size: 22px;
            cursor: pointer;
            color: var(--muted)
        }

        .modal .grid2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }

        .modal .field label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            display: block
        }

        .modal input,
        .modal select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-size: 14px
        }

        .modal input[type="color"] {
            height: 36px;
            border-radius: 12px;
            border: 1px solid var(--border);
            cursor: pointer;
            padding: 0
        }

        #timePreview {
            font-size: 13px;
            color: var(--muted);
            margin-top: -4px
        }

        .actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            ;
            margin-top: 8px
        }

        .actions.split {
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .actions.split>*:first-child {
            margin-right: auto
        }

        .modal .btn {
            min-width: 90px;
            font-weight: 600;
            transition: background .15s ease, transform .1s ease
        }

        .modal .btn:hover {
            transform: translateY(-1px)
        }

        .modal .btn.primary {
            background: #111827;
            color: #fff
        }

        .modal .btn.ghost {
            background: var(--border);
            color: var(--text)
        }

        .modal .btn.danger {
            background: #dbeafe;
            color: #1d4ed8;
        }

        /* Compact Structured Modal - Well Organized & Space Efficient */
        .structured-modal {
            max-width: 420px;
            width: 90vw;
            padding: 0;
            border-radius: 14px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            background: var(--card);
            overflow: hidden;
        }

        .modal-header-structured {
            background: linear-gradient(135deg, var(--card) 0%, var(--card) 100%);
            padding: 18px 22px;
            border-bottom: 1px solid #e2e8f0;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header-structured h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
            letter-spacing: -0.3px;
        }

        .time-slot {
            background: var(--accent);
            color: var(--card);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .modal-content-structured {
            padding: 20px 22px;
        }

        .form-section {
            margin-bottom: 20px;
        }

        .form-section:last-child {
            margin-bottom: 0;
        }

        .section-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
        }

        .section-label::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, #6366f1 0%, transparent 100%);
            margin-left: 12px;
            opacity: 0.4;
        }

        .form-field {
            margin-bottom: 12px;
        }

        .form-field:last-child {
            margin-bottom: 0;
        }

        .form-row-structured {
            display: flex;
            gap: 12px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .detail-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .field-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .structured-input,
        .structured-select {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--card);
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s ease;
            color: var(--text);
        }

        .primary-input {
            background: var(--card);
            border-color: var(--border);
            font-size: 16px;
            font-weight: 600;
        }

        .structured-input:focus,
        .structured-select:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--card);
            box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .structured-input::placeholder {
            color: var(--muted);
            font-weight: 400;
        }

        .settings-row {
            display: flex;
            gap: 16px;
        }

        .setting-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .setting-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .color-preview {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            background: var(--card);
            border: 2px solid #f1f5f9;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .color-preview:hover {
            border-color: var(--border);
            background: var(--border);
        }

        .color-preview-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent);
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
            flex-shrink: 0;
        }

        .color-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--muted);
        }

        .priority-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 14px 18px;
            background: var(--card);
            border: 2px solid #f1f5f9;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .priority-toggle:hover {
            border-color: var(--border);
            background: var(--border);
        }

        .priority-toggle input[type="checkbox"] {
            display: none;
        }

        .toggle-switch {
            width: 44px;
            height: 24px;
            background: var(--border);
            border-radius: 12px;
            position: relative;
            transition: all 0.3s ease;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: var(--card);
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .priority-toggle input[type="checkbox"]:checked + .toggle-switch {
            background: var(--accent);
        }

        .priority-toggle input[type="checkbox"]:checked + .toggle-switch::after {
            transform: translateX(20px);
        }

        .toggle-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--muted);
        }

        .modal-actions-structured {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 22px 20px;
            background: var(--card);
            border-top: 1px solid #f1f5f9;
        }

        .action-buttons-structured {
            display: flex;
            gap: 10px;
        }

        .structured-modal .btn {
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }

        .structured-modal .btn.primary {
            background: var(--accent);
            color: var(--card);
        }

        .structured-modal .btn.primary:hover {
            background: #5b21b6;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .structured-modal .btn.secondary {
            background: var(--card);
            color: var(--muted);
            border: 2px solid #e2e8f0;
        }

        .structured-modal .btn.secondary:hover {
            background: var(--card);
            color: var(--muted);
            border-color: var(--border);
            transform: translateY(-1px);
        }

        .structured-modal .btn.danger {
            background: #dbeafe;
            color: var(--accent);
            border: 2px solid #bfdbfe;
        }

        .structured-modal .btn.danger:hover {
            background: #bfdbfe;
            color: var(--accent);
            transform: translateY(-1px);
        }

        @media (max-width:480px) {
            .modal .grid2 {
                grid-template-columns: 1fr
            }

            .structured-modal {
                width: 95vw;
                margin: 8px;
            }

            .modal-header-structured {
                padding: 16px 18px;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .modal-header-structured h2 {
                font-size: 18px;
            }

            .time-slot {
                align-self: flex-end;
                margin-top: -6px;
            }

            .modal-content-structured {
                padding: 16px 18px;
            }

            .form-section {
                margin-bottom: 18px;
            }

            .form-row-structured {
                flex-direction: column;
                gap: 12px;
            }

            .details-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .settings-row {
                flex-direction: column;
                gap: 12px;
            }

            .modal-actions-structured {
                padding: 14px 18px 16px;
                flex-direction: column;
                gap: 12px;
            }

            .action-buttons-structured {
                width: 100%;
                justify-content: space-between;
            }

            .structured-modal .btn {
                flex: 1;
                padding: 12px 18px;
            }
        }

        .actions.split {
            flex-direction: column;
            align-items: stretch;
        }

        .actions.split>*:first-child {
            margin-right: 0;
        }

        .container.wide {
            max-width: 1480px;
            margin: 0 auto;
        }

        /* Overview page specific styles */
        .ov-main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .ov-section {
            margin-bottom: 32px;
            margin-top: 40px;
            overflow: visible;
        }

        .ov-section-header {
            margin-bottom: 16px;
        }

        .ov-section-title {
            font-size: 20px;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ov-heatmap-today {
            display: grid;
            grid-template-columns: 2.5fr 1fr;
            gap: 24px;
        }

        .ov-timer-section {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .ov-statistics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .ov-hero-inline {
            margin-bottom: 24px;
        }

        /* Next Up Section */
        .ov-next-up-section {
            margin-bottom: 32px;
        }

        /* Next Up inside Heute card */
        .next-up-in-heute {
            margin-top: 16px;
            padding-top: 16px;
        }

        .next-up-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
            margin-bottom: 12px;
        }

        .next-up-content-heute {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .next-up-icon-small {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--card);
            flex-shrink: 0;
        }

        .next-up-icon-small svg {
            width: 16px;
            height: 16px;
        }

        .next-up-text-heute {
            flex: 1;
            min-width: 0;
        }

        .next-up-title-heute {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 2px;
        }

        .next-up-subtitle-heute {
            font-size: 12px;
            color: var(--muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }


        .next-up-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            position: relative;
            z-index: 1;
        }

        .next-up-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .next-up-icon svg {
            width: 20px;
            height: 20px;
            stroke: white;
            stroke-width: 2;
        }

        .next-up-content {
            flex: 1;
            text-align: left;
        }

        .next-up-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--text);
        }

        .next-up-subtitle {
            font-size: 13px;
            color: var(--muted);
            line-height: 1.3;
        }

        .next-up-actions {
            position: relative;
            z-index: 1;
        }

        .next-up-actions .btn {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            border: none;
            color: var(--card);
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
        }

        .next-up-actions .btn:hover {
            background: linear-gradient(135deg, #5b21b6 0%, #4c1d95 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .next-up-actions .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
        }

        .next-up-actions .btn svg {
            width: 16px;
            height: 16px;
        }

        /* Header timer styling */
        .header-timer {
            margin-left: 0;
        }

        .header-center {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
        }

        .timer-card.compact {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0;
            background: transparent;
            border: none;
            border-radius: 0;
            box-shadow: none;
            height: 40px;
        }

        .timer-card.compact .timer-face {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            min-width: 120px;
            text-align: center;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            height: 40px;
            line-height: 40px;
            display: flex;
            align-items: center;
            cursor: pointer;
            background: linear-gradient(135deg, var(--card) 0%, var(--card) 100%);
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            caret-color: transparent;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .timer-card.compact .timer-display {
            flex: 1;
            text-align: center;
            font-weight: 700;
            letter-spacing: 0.5px;
            padding: 0 12px;
            margin-right: 40px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .timer-card.compact .timer-display.editing {
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid #3b82f6;
            border-radius: 8px;
            outline: none;
            cursor: text;
        }

        .timer-card.compact .reset-inside {
            padding: 0;
            min-width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border: none;
            color: var(--card);
            border-radius: 0 12px 12px 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            flex-shrink: 0;
            box-shadow: 0 1px 2px rgba(59, 130, 246, 0.2);
            position: absolute;
            right: 0;
            top: 0;
        }

        .timer-card.compact .reset-inside:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            color: var(--card);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .timer-card.compact .reset-inside:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(59, 130, 246, 0.2);
        }

        .timer-card.compact .reset-inside .ico {
            width: 18px;
            height: 18px;
        }

        .timer-card.compact .timer-face:hover {
            background: linear-gradient(135deg, var(--card) 0%, var(--border) 100%);
            border-color: var(--border);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .timer-card.compact .timer-face.running {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border-color: #2563eb;
            box-shadow: 0 1px 3px rgba(59, 130, 246, 0.2);
        }

        .timer-card.compact .timer-face.running .timer-display {
            color: var(--card);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .timer-card.compact .timer-face.running:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4), 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .timer-card.compact .timer-face.running:hover .timer-display {
            color: var(--card);
        }

        .timer-controls {
            display: flex;
            gap: 4px;
        }

        .timer-controls .btn.mini {
            padding: 0;
            min-width: 36px;
            height: 36px;
            background: var(--border);
            border: none;
            color: var(--muted);
            border-radius: 10px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }

        .timer-controls .btn.mini:hover {
            background: var(--border);
            color: var(--muted);
            transform: scale(1.05);
        }

        .timer-controls .btn.mini.danger {
            background: #f87171;
            color: var(--card);
        }

        .timer-controls .btn.mini.danger:hover {
            background: var(--accent);
            color: var(--card);
        }

        .timer-controls .btn.mini.clicked {
            transform: scale(0.9);
            transition: transform 0.1s ease;
        }

        .timer-controls .btn.mini .ico {
            width: 16px;
            height: 16px;
        }

        /* Timer end effects */
        .timer-ended {
            background: #fef2f2 !important;
            border-color: #fecaca !important;
            animation: timerBlink 1s ease-in-out infinite;
        }

        .timer-ended .timer-face {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%) !important;
            border-color: #fca5a5 !important;
            animation: timerBlink 1s ease-in-out infinite;
        }

        .timer-ended .timer-face .timer-display {
            color: #1d4ed8 !important;
            text-shadow: 0 1px 2px rgba(29, 78, 216, 0.1);
        }

        @keyframes timerBlink {

            0%,
            50% {
                opacity: 1;
            }

            25%,
            75% {
                opacity: 0.7;
            }
        }

        /* Timer click feedback */
        .timer-face.clicked {
            transform: scale(0.95);
            transition: transform 0.1s ease;
        }

        .timer-face.clicked .timer-display {
            color: var(--accent);
            text-shadow: 0 1px 2px rgba(99, 102, 241, 0.2);
        }

        /* Timer editing state */
        .timer-face .timer-display.editing {
            background: rgba(99, 102, 241, 0.1);
            border: 2px solid #6366f1;
            border-radius: 8px;
            padding: 4px 8px;
            outline: none;
            color: var(--accent);
            font-weight: 600;
        }

        .website-blink {
            animation: websiteBlink 2s ease-in-out 3;
        }

        @keyframes websiteBlink {

            0%,
            100% {
                background-color: transparent;
            }

            50% {
                background-color: rgba(59, 130, 246, 0.1);
            }
        }

        .stat-card {
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .stat-icon svg {
            width: 24px;
            height: 24px;
            stroke: white;
            stroke-width: 2;
        }

        .stat-content {
            flex: 1;
        }

        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--muted);
            font-weight: 500;
        }

        /* Activity List */
        .activity-list {
            display: flex;
            flex-direction: row;
            gap: 12px;
            overflow-x: auto;
            padding: 8px 0;
            width: 100%;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .activity-list::-webkit-scrollbar {
            display: none;
        }

        .activity-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            min-width: 140px;
            flex-shrink: 0;
        }

        .activity-item:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-icon svg {
            width: 16px;
            height: 16px;
            stroke: white;
            stroke-width: 2;
        }

        .activity-content {
            text-align: center;
            width: 100%;
        }

        .activity-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .activity-description {
            font-size: 11px;
            color: var(--muted);
            margin-bottom: 6px;
            line-height: 1.3;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .activity-time {
            font-size: 10px;
            color: var(--muted);
            font-weight: 500;
        }

        /* Quick Actions Grid */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .quick-action-btn {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            text-align: center;
        }

        .quick-action-btn:hover {
            border-color: var(--accent);
            background: var(--card);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
        }

        .action-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-icon svg {
            width: 20px;
            height: 20px;
            stroke: white;
            stroke-width: 2;
        }

        .action-text {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .overview-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 16px;
        }

        .overview-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        @media (max-width:1200px) {
            .overview-grid {
                grid-template-columns: 1fr
            }

            .overview-row {
                grid-template-columns: 1fr
            }
        }

        .hero {
            position: relative;
            overflow: hidden;
            padding: 18px;
            border-radius: 16px;
            background: radial-gradient(1200px 400px at -15% -40%, #e0f2fe 0, transparent 60%), linear-gradient(135deg, #f0f9ff, #f7fee7);
            border: 1px solid var(--border);
            box-shadow: var(--shadow)
        }

        .hero h3 {
            margin: 0 0 6px
        }

        .hero-sub {
            color: var(--muted);
            font-size: 13px
        }

        .hero .clock {
            position: absolute;
            right: 18px;
            top: 18px;
            font-weight: 800;
            font-size: 28px;
            color: var(--text)
        }

        .kpi {
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 14px;
            background: var(--card);
            display: flex;
            flex-direction: column;
            gap: 6px;
            box-shadow: var(--shadow)
        }

        .kpi .label {
            color: var(--muted);
            font-size: 12px
        }

        .kpi .value {
            font-weight: 800;
            font-size: 22px
        }

        .chart-card,
        .list-card,
        .timer-card {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 16px;
            background: var(--card);
            box-shadow: var(--shadow)
        }

        .chart-title {
            font-weight: 700;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Heatmap chart title specific styling */
        #heatmapCard .chart-title {
            justify-content: center;
            margin-bottom: 6px;
        }

        /* Reduce padding for heatmap card to minimize white space */
        #heatmapCard {
            padding: 4px;
        }

        /* Make heatmap container fill more space */
        #heatmap {
            width: 100%;
            min-width: 100%;
        }

        .chart-wrap {
            width: 100%;
            height: auto;
            /* Allow dynamic height based on content */
        }

        .mini-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .mini-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            ;
            padding: 8px 10px;
            border: 1px dashed #e5e7eb;
            border-radius: 10px
        }

        .mini-item-right {
            display: flex;
            align-items: center;
            gap: 8px;
            ;
        }

        .meta {
            font-size: 12px;
            color: var(--muted);
        }

        .mini-item .meta {
            color: var(--muted);
            font-size: 12px
        }

        .timer-controls {
            display: flex;
            gap: 8px;
            ;
            margin-top: 8px
        }

        .timer-face {
            font-size: 28px;
            font-weight: 800
        }

        .badge {
            background: #0f172a;
            color: var(--card);
            border-radius: 999px;
            padding: 2px 8px;
            font-size: 12px
        }

        /* small utility for click affordance without changing your look */
        .clickable {
            cursor: pointer
        }

        .clickable:focus-visible {
            outline: 2px solid #94a3b8;
            outline-offset: 2px;
        }

        /* --- Übersicht layout tweaks --- */
        .overview-grid .full-span {
            grid-column: 1 / -1;
        }

        /* Big, centered Pomodoro */
        .timer-card.big {
            display: grid;
            place-items: center;
            gap: 10px;
            ;
            padding: 22px;
        }

        /* Square Pomodoro, compact, right-aligned */
        .timer-card.big.square {
            aspect-ratio: 1 / 1;
            width: 100%;
            max-width: 360px;
            /* was 420 */
            padding: 16px;
            /* tighter */
            gap: 8px;
            ;
            place-items: center;
            justify-self: end;
            /* push to the right within the grid */
        }

        /* compact digits */
        .timer-face.xl {
            /* keep class name, just tighten */
            font-size: clamp(40px, 6.5vw, 68px);
            /* was up to ~96px */
            font-weight: 900;
            line-height: 1.05;
            letter-spacing: .01em;
            text-align: center;
            margin: 2px 0 4px;
        }

        /* slightly smaller buttons */
        .btn.lg {
            padding: 10px 14px;
            font-size: 14px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            ;
            box-shadow: var(--shadow);
        }

        .btn-row {
            gap: 8px;
            ;
        }

        .btn.lg .ico {
            width: 16px;
            height: 16px;
        }

        .timer-sub {
            color: var(--muted);
            font-size: 13px;
            text-align: center;
        }

        /* XL buttons with icons */
        .btn.xl {
            padding: 12px 18px;
            font-size: 16px;
            border-radius: 14px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            ;
            box-shadow: var(--shadow);
        }

        .btn.xl .ico {
            width: 18px;
            height: 18px;
            display: inline-block;
        }

        .btn-row {
            display: flex;
            gap: 10px;
            ;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* Keyboard focus (keeps your visual style) */
        .clickable:focus-visible,
        .btn:focus-visible {
            outline: 2px solid #94a3b8;
            outline-offset: 2px;
        }

        /* Keep muted meta utility (used in info & lists) */
        .meta {
            font-size: 12px;
            color: var(--muted);
        }

        /* --- Übersicht: structured layout --- */
        .ov-main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-top: 24px;
        }

        .ov-primary-content {
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .ov-secondary-content {
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .ov-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
            ;
        }

        .ov-section-header {
            margin-bottom: 8px;
        }

        .ov-section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        /* KPI row */
        .ov-kpis {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            ;
        }

        /* Charts block (two side-by-side) */
        .ov-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            ;
            margin-top: 16px;
        }

        /* Heatmap and Today side by side */
        .ov-heatmap-today {
            display: grid;
            grid-template-columns: 2.5fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        /* Weekly Plan section improvements */
        .ov-section {
            margin-bottom: 32px;
        }

        .ov-section-header {
            margin-bottom: 20px;
        }

        /* Chart card improvements */
        .chart-card {
            min-height: unset;
            /* Allow dynamic height based on content */
        }

        .list-card {
            min-height: 300px;
        }

        /* Heute card should size to content when empty */
        .list-card:has(.small) {
            min-height: auto;
        }

        /* Timer section */
        .ov-timer-section {
            display: flex;
            justify-content: center;
        }

        /* Tablet responsive design (768px - 1024px) */
        @media (max-width: 1024px) and (min-width: 769px) {
            .ov-heatmap-today {
                grid-template-columns: 2fr 1fr;
                gap: 20px;
            }

            .chart-card,
            .list-card {
                min-height: unset;
                /* Allow dynamic height based on content */
                padding: 18px;
            }

            /* Heute card should size to content when empty on tablet */
            .list-card:has(.small) {
                min-height: auto;
            }

            .chart-title {
                font-size: 17px;
            }

            .ov-section-title {
                font-size: 19px;
            }

            /* Heatmap tablet optimization */
            #heatmap {
                min-height: unset;
                /* Allow dynamic height based on content */
            }

            .chart-card #heatmap {
                min-height: unset;
                /* Allow dynamic height based on content */
            }
        }

        /* Subject section */
        .ov-subject-section {
            width: 100%;
        }

        /* Statistics section */
        .ov-statistics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            background: var(--card);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid #e5e7eb;
        }

        /* Week navigation */
        .week-nav-container {
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
            width: 100%;
        }

        .week-nav {
            display: flex;
            align-items: center;
            gap: 12px;
            ;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .week-nav span {
            font-size: 14px;
            color: var(--muted);
            min-width: 180px;
            text-align: center;
            font-weight: 500;
            line-height: 1.2;
        }

        .week-nav span.current-week {
            color: var(--accent);
            font-weight: 600;
        }

        .week-nav .btn.mini {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: var(--muted);
            font-weight: 600;
            font-size: 14px;
            width: 28px;
            height: 28px;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .week-nav .btn.mini:hover {
            background: rgba(255, 255, 255, 1);
            border-color: rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .week-nav .btn.mini:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Current week button styling */
        .current-week-btn {
            background: var(--card) !important; 
            border: 1px solid var(--border) !important;
            color: var(--text) !important;
            display: none !important; /* Hidden by default, shown conditionally */
            font-weight: 600 !important;
            font-size: 18px !important;
            width: 100px !important;
            height: 20px !important;
            border-radius: 20px 20px 0 0 !important;
            transition: all 0.3s ease !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important;
        }

        .current-week-btn svg {
            width: 18px;
            height: 18px;
            stroke: var(--text);
        }



        /* Charts and lists side by side */
        .ov-charts-lists {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            ;
            margin-top: 16px;
        }

        /* Lists block (two stacked for better scan) */
        .ov-lists {
            display: grid;
            grid-template-rows: auto auto;
            gap: 16px;
            ;
            margin-top: 16px;
        }

        /* Right column wrapper (timer + optional space for future blocks) */
        .ov-right {
            display: grid;
            gap: 16px;
            ;
        }

        /* Make timer compact & square on the right */
        .timer-card.big.square {
            aspect-ratio: 1 / 1;
            width: 100%;
            max-width: 360px;
            padding: 16px;
            gap: 8px;
            ;
            place-items: center;
            justify-self: center;
        }

        /* Unify card paddings a bit */
        .kpi,
        .chart-card,
        .list-card,
        .timer-card {
            padding: 14px;
        }

        /* Dynamic chart height - will be set by JavaScript */
        .chart-wrap {
            min-height: unset;
            /* Allow dynamic height based on content */
            height: auto;
        }

        /* Heatmap tooltip */
        .heatmap-tooltip {
            position: absolute;
            background: #1f2937;
            color: var(--card);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transform: translateY(-4px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            white-space: nowrap;
            max-width: 250px;
        }

        .heatmap-tooltip.show {
            opacity: 1;
            transform: translateY(0);
        }

        .heatmap-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #1f2937;
        }

        /* Plan week navigation */
        .plan-week-nav {
            margin-top: 32px;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            position: relative;
        }

        /* Position profile selection on the left */
        .plan-week-nav .profile-selection-area {
            position: absolute;
            left: 0;
            z-index: 1;
        }

        /* Plan section: open profile dropdown to the left side */
        .plan-week-nav .profile-selection-area .profile-switch-dropdown {
            position: absolute;
            top: 0;
            right: calc(100% + 8px);
            left: auto;
            width: 280px;
            max-height: 360px;
            overflow-y: auto;
            display: none;
            opacity: 1;
            visibility: visible;
            transform: none;
            margin-top: 0;
            z-index: 40;
        }

        .plan-week-nav .profile-selection-area .profile-switch-dropdown.open {
            display: block;
        }

        /* Center the navigation island */
        .plan-week-nav .plan-week-nav-container {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
        }

        /* Position structure button on the right */
        .plan-week-nav .structure-btn {
            position: absolute;
            right: 0;
            z-index: 1;
        }

        /* Heatmap Layout */
        .ov-heatmap-today {
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }

        .heatmap-layout {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Heatmap Navigation Island */
        .heatmap-nav-island {
            background: transparent;
            border-radius: 0;
            padding: 0px 0px 20px 0px;
            margin-bottom: 0px;
            box-shadow: none;
            border: none;
            height: auto;
            display: flex;
            justify-content: center;
            margin-left: 0;
            margin-right: 0;
        }

        .heatmap-nav-island .plan-week-nav {
            margin: 0;
            padding: 0;
            width: 100%;
            position: relative;
        }

        .heatmap-nav-island .plan-week-nav .current-week-btn {
            margin-left: 0;
        }

        .heatmap-nav-island .plan-week-nav .structure-btn {
            margin-right: 0;
        }


        /* Heatmap card with dynamic height */
        .ov-heatmap-today .chart-card {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: unset;
            margin-top: 20px;
            /* Allow dynamic height based on content */
        }

        .ov-heatmap-today .chart-wrap {
            flex: 1;
            min-height: unset;
            /* Allow dynamic height based on content */
        }

        /* Today card matches total height of navigation + heatmap */
        .ov-heatmap-today .list-card {
            width: 300px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: unset;
            /* Remove min-height constraint to allow dynamic height */
        }

        .ov-heatmap-today .list-card .mini-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .plan-week-nav-container {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .plan-week-settings {
            display: flex;
            align-items: center;
            gap: 8px;
            ;
        }

        .daily-hours-setting {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--card);
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .daily-hours-setting label {
            font-size: 12px;
            font-weight: 500;
            color: var(--muted);
            white-space: nowrap;
        }

        .daily-hours-setting input {
            width: 50px;
            padding: 4px 6px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            background: var(--card);
        }

        .daily-hours-setting input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        .add-row-section {
            display: flex;
            justify-content: center;
            padding: 16px;
            border-top: 1px solid #e2e8f0;
            background: var(--card);
        }

        .add-row-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            ;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .add-row-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .add-row-btn .ico {
            font-size: 16px;
            font-weight: 600;
        }


        .plan-week-nav-content {
            display: flex;
            align-items: center;
            gap: 16px;
            ;
            height: 44px;
            padding: 0;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 22px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        /* Position current week button outside, attached to the top edge of the island */
        .plan-week-nav-container .current-week-btn {
            position: absolute;
            top: -20px;
            /* sits just outside, touching the top border of the island */
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
        }

        .plan-week-nav-container {
            position: relative;
        }

        .plan-week-nav-content span {
            font-weight: 600;
            color: var(--muted);
            min-width: 220px;
            text-align: center;
            font-size: 16px;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .plan-week-nav-content span:hover {
            background-color: var(--border);
            cursor: pointer;
        }

        .plan-week-nav-content span.editing {
            background-color: rgba(99, 102, 241, 0.1);
            border: 1px solid #6366f1;
        }

        .plan-week-nav-content span.current-week {
            color: var(--accent);
            font-weight: 700;
        }

        .plan-week-nav-content .btn.mini {
            background: linear-gradient(135deg, var(--card) 0%, var(--card) 100%);
            border: 1px solid var(--border);
            color: var(--muted);
            font-weight: 600;
            font-size: 18px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .plan-week-nav-content .btn.mini:hover {
            background: linear-gradient(135deg, var(--card) 0%, var(--border) 100%);
            border-color: var(--border);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .plan-week-nav-content .btn.mini:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }



        /* =================== MODERN FOLDERS SECTION =================== */
        .folders-section {
            padding: 24px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .folders-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .folders-title h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .folders-count {
            font-size: 14px;
            color: var(--text-secondary);
            margin-left: 8px;
        }

        .folders-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-icon:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border-hover);
        }

        .btn-primary {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--primary);
            color: var(--card);
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        .folders-search {
            margin-bottom: 16px;
            animation: slideDown 0.2s ease;
        }

        .search-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input-wrapper svg {
            position: absolute;
            left: 12px;
            color: var(--text-secondary);
            z-index: 1;
        }

        .search-input-wrapper input {
            width: 100%;
            padding: 12px 40px 12px 40px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .search-input-wrapper input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .search-input-wrapper .btn-icon {
            position: absolute;
            right: 4px;
            width: 28px;
            height: 28px;
        }

        .folders-sort {
            margin-bottom: 16px;
            animation: slideDown 0.2s ease;
        }

        .sort-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .sort-option {
            padding: 6px 12px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sort-option:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .sort-option.active {
            background: var(--primary);
            color: var(--card);
            border-color: var(--primary);
        }

        .folders-upload {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            margin-bottom: 24px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .folders-upload:hover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.02);
        }

        .folders-upload.over {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .upload-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .upload-icon {
            color: var(--text-secondary);
        }

        .upload-text {
            font-size: 16px;
            color: var(--text-primary);
        }

        .upload-link {
            color: var(--primary);
            text-decoration: underline;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }

        .upload-formats {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .upload-formats small {
            display: block;
            margin-top: 4px;
            opacity: 0.7;
        }

        .folders-content {
            min-height: 200px;
        }

        .folders-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .empty-icon {
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .empty-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-subtext {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 24px;
        }

        .folders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .folder-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .folder-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: var(--border-hover);
        }

        .folder-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--folder-color, var(--primary));
        }

        .folder-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .folder-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: var(--folder-color, var(--primary));
            color: var(--card);
        }

        .folder-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .folder-card:hover .folder-actions {
            opacity: 1;
        }

        .folder-action {
            width: 28px;
            height: 28px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .folder-action:hover {
            background: var(--primary);
            color: var(--card);
        }

        .folder-info {
            margin-bottom: 16px;
        }

        .folder-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .folder-meta {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .folder-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .folder-stat {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .folder-stat svg {
            width: 14px;
            height: 14px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .folders-section {
                padding: 16px;
            }

            .folders-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .folders-actions {
                width: 100%;
                justify-content: space-between;
            }

            .folders-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .folder-card {
                padding: 16px;
            }
        }

        .folder-item {
            position: relative;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 6px;
            /* square corners */
            aspect-ratio: 1 / 1;
            /* make square */
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            text-align: center;
        }

        .folder-item:hover {
            border-color: #3b82f6;
            background: var(--card);
        }

        .folder-icon {
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            margin-bottom: 6px;
        }

        .folder-info {
            min-width: 0;
        }

        .folder-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .folder-count {
            font-size: 12px;
            color: var(--muted);
        }

        /* Edit button removed - only available via right-click context menu */

        /* Folder context menu */
        .context-menu {
            position: fixed;
            z-index: 10000;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(2, 6, 23, 0.12);
            min-width: 180px;
            padding: 6px;
            display: none;
        }

        .context-menu .cm-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            font-size: 13px;
            color: var(--text);
            border-radius: 6px;
            cursor: pointer;
            user-select: none;
        }

        .context-menu .cm-item:hover {
            background: var(--border);
        }

        .context-menu .cm-sep {
            height: 1px;
            background: var(--border);
            margin: 6px 4px;
        }

        /* Icon Selection */
        .icon-selection {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-top: 12px;
            padding: 12px;
            background: var(--card);
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .icon-option {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--card);
            font-size: 18px;
        }

        .icon-option:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .icon-option.selected {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.2);
        }

        .icon-preview {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--card) 0%, var(--border) 100%);
            margin: 0 auto 12px;
        }

        /* Settings page styling - matching analysis section */
        .settings-page {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .settings-header {
            margin-bottom: 32px;
            text-align: center;
        }

        .settings-header h2 {
            margin: 0 0 8px 0;
            font-size: 28px;
            font-weight: 700;
            color: var(--text);
        }

        .settings-header p {
            margin: 0;
            color: var(--muted);
            font-size: 16px;
        }

        .settings-content {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .settings-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            ;
        }

        .settings-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .settings-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .settings-card-header {
            margin-bottom: 20px;
            text-align: center;
        }

        .settings-card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin: 0 0 8px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            ;
        }

        .settings-card-description {
            font-size: 14px;
            color: var(--muted);
            margin: 0;
        }

        .settings-field {
            margin-bottom: 20px;
        }

        .settings-field:last-child {
            margin-bottom: 0;
        }

        .settings-field label {
            display: block;
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
            margin-bottom: 8px;
        }

        .settings-field input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }

        .settings-field input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .settings-field small {
            display: block;
            color: var(--muted);
            font-size: 12px;
            margin-top: 4px;
        }

        /* Settings accordion styling */
        .settings-section .accordion {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .settings-section .accordion details {
            background: var(--card);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .settings-section .accordion details:hover {
            border-color: var(--border);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .settings-section .accordion summary {
            padding: 20px 24px;
            background: linear-gradient(135deg, var(--card) 0%, var(--border) 100%);
            border-bottom: 1px solid #e2e8f0;
            font-weight: 700;
            color: var(--text);
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 12px;
            ;
            font-size: 16px;
            letter-spacing: -0.025em;
            transition: all 0.2s ease;
        }

        .settings-section .accordion summary:hover {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            transform: translateY(-1px);
        }

        .settings-section .accordion details[open] summary {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            border-bottom-color: #94a3b8;
        }

        .settings-section .accordion .list {
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            ;
            background: var(--card);
        }

        .settings-section .accordion .row {
            display: flex;
            align-items: center;
            gap: 16px;
            ;
        }

        .settings-section .accordion .row input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .settings-section .accordion .row input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .settings-section .accordion .add-row {
            display: flex;
            align-items: center;
            gap: 16px;
            ;
            margin-top: 12px;
            padding-top: 16px;
            border-top: 2px solid #f1f5f9;
        }

        .settings-section .accordion .add-row input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .settings-section .accordion .add-row input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .settings-section .accordion .add-row button {
            padding: 12px 20px;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: var(--card);
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
        }

        .settings-section .accordion .add-row button:hover {
            background: linear-gradient(135deg, #5b21b6 0%, #4c1d95 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
        }

        .settings-section .accordion .btn.mini.danger {
            padding: 10px 16px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: var(--card);
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
        }

        .settings-section .accordion .btn.mini.danger:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        .settings-actions {
            display: flex;
            justify-content: center;
            padding: 0 4px;
        }

        .settings-auto-save-notice {
            display: inline-flex;
            align-items: center;
            padding: 12px 24px;
            background: var(--card);
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            color: #0369a1;
            font-size: 14px;
            font-weight: 500;
            gap: 8px;
            ;
        }

        .settings-auto-save-notice .ico {
            font-size: 16px;
        }

        /* Settings info section */
        .settings-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 500;
            color: var(--muted);
            font-size: 14px;
        }

        .info-value {
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
        }

        /* Full-width settings sections */
        .settings-info-section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .settings-info-section .settings-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .settings-data-section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-top: 24px;
        }

        .settings-data-section h3 {
            margin: 0 0 20px 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-data-section .settings-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        /* Weekday selector */
        .weekday-selector {
            display: flex;
            gap: 0;
            flex-wrap: wrap;
        }

        .weekday-checkbox {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            background: var(--card);
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            position: relative;
            min-width: 40px;
        }

        .weekday-checkbox:first-child {
            border-radius: 8px 0 0 8px;
        }

        .weekday-checkbox:last-child {
            border-radius: 0 8px 8px 0;
        }

        .weekday-checkbox:not(:first-child) {
            border-left: none;
        }

        .weekday-checkbox:hover {
            background: var(--border);
            border-color: var(--border);
        }

        .weekday-checkbox input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .weekday-checkbox span {
            font-size: 14px;
            color: var(--muted);
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .weekday-checkbox:has(input[type="checkbox"]:checked) {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--card);
        }

        .weekday-checkbox:has(input[type="checkbox"]:checked) span {
            color: var(--card);
            font-weight: 600;
        }

        /* Slider styling */
        .slider-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .slider-container input[type="range"] {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
            transition: all 0.2s ease;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb:hover {
            background: #5b21b6;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.4);
        }

        .slider-container input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
            transition: all 0.2s ease;
        }

        .slider-container input[type="range"]::-moz-range-thumb:hover {
            background: #5b21b6;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.4);
        }

        .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: var(--text);
            background: var(--border);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        /* Page transition system */
        .page-container {
            position: relative;
            overflow: visible;
            min-height: 100vh;
            padding-top: 120px;
            /* Space for header + nav-container */
        }

        /* Ensure pages are mutually exclusive */
        .page-container>.container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            min-height: 100vh;
            background: var(--bg);
            z-index: 1;
        }

        .page-container>.container:not([hidden]) {
            z-index: 2;
        }

        .page-container>.container[hidden] {
            display: none !important;
        }
        
        /* FORCE OVERVIEW VISIBILITY - Only when no other page is active */
        .page-container>.container#pageOverview:not([hidden]).force-visible {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 999 !important;
        }
        
        /* Ensure other pages can be shown when active */
        .page-container>.container.active:not([hidden]) {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 2 !important;
        }

        /* Pill bar selection */
        .pill {
            position: relative;
            z-index: 1;
            cursor: pointer;
            transition: all 0.2s ease;
            background: transparent;
            color: var(--muted);
        }

        .pill.primary {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: var(--card);
            transform: scale(1.05);
            border-radius: 50%;
            padding: 8px;
            min-width: 36px;
            height: 36px;
            width: 36px;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        .pill:not(.primary) {
            background: transparent;
            color: var(--muted);
            opacity: 0.7;
        }

        .pill:not(.primary):hover {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent);
            opacity: 1;
            transform: translateY(-1px);
            border-radius: 50%;
            padding: 8px;
            min-width: 36px;
            height: 36px;
            width: 36px;
        }

        /* Plan layout */
        .plan-main {
            margin-bottom: 24px;
        }

        /* Plan settings styling */
        .plan-settings {
            background: var(--card);
            border-radius: 16px;
            border: 1px solid var(--border);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .plan-settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 32px;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .plan-settings-header:hover {
            background: linear-gradient(135deg, var(--card) 0%, var(--border) 100%);
        }

        .plan-settings-header.collapsed .settings-chevron {
            transform: rotate(180deg);
        }

        .settings-chevron {
            width: 20px;
            height: 20px;
            stroke: var(--muted);
            transition: transform 0.2s ease;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .plan-settings-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .plan-settings-content {
            padding: 32px;
            transition: all 0.3s ease;
        }

        .plan-settings-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .plan-settings-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .plan-settings-form .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .plan-settings-form .weekday-selector {
            display: flex;
            gap: 0;
            flex-wrap: wrap;
        }

        .plan-settings-form .weekday-checkbox {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--card);
            position: relative;
            min-width: 40px;
        }

        .plan-settings-form .weekday-checkbox:first-child {
            border-radius: 8px 0 0 8px;
        }

        .plan-settings-form .weekday-checkbox:last-child {
            border-radius: 0 8px 8px 0;
        }

        .plan-settings-form .weekday-checkbox:not(:first-child) {
            border-left: none;
        }

        .plan-settings-form .weekday-checkbox:hover {
            border-color: var(--accent);
            background: var(--card);
        }

        .plan-settings-form .weekday-checkbox input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .plan-settings-form .weekday-checkbox span {
            font-size: 14px;
            color: var(--muted);
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .plan-settings-form .weekday-checkbox:has(input[type="checkbox"]:checked) {
            border-color: var(--accent);
            background: var(--accent);
            color: var(--card);
        }

        .plan-settings-form .weekday-checkbox:has(input[type="checkbox"]:checked) span {
            color: var(--card);
            font-weight: 600;
        }

        .plan-settings-form .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .plan-settings-form .slider-container input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            outline: none;
            cursor: pointer;
        }

        .plan-settings-form .slider-container input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .plan-settings-form .slider-container input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .plan-settings-form .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: var(--text);
            background: var(--card);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .plan-settings-form label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
        }

        .plan-settings-form small {
            font-size: 12px;
            color: var(--muted);
        }

        /* Timetable Structure Side Panel */
        .timetable-structure-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--card);
            border-left: 1px solid #e2e8f0;
            box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .timetable-structure-panel.open {
            right: 0;
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            background: var(--card);
        }

        .week-banner {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            padding: 16px 24px;
            border-bottom: 1px solid #e2e8f0;
        }

        .week-banner-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .week-nav-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .week-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            text-align: center;
        }

        .global-settings-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 4px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: .4s;
            border-radius: 20px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: var(--card);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #4CAF50;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .toggle-label {
            font-size: 12px;
            color: var(--text);
            user-select: none;
        }

        .week-nav-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: var(--card);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .week-nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .week-nav-btn:active {
            transform: scale(0.95);
        }

        .week-number {
            color: var(--card);
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .week-purpose {
            color: var(--text);
            font-size: 13px;
            font-weight: 500;
        }

        .panel-header h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .panel-header svg {
            width: 18px;
            height: 18px;
            stroke: var(--accent);
        }


        .close-btn {
            background: none;
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: var(--border);
        }

        .close-btn svg {
            width: 16px;
            height: 16px;
            stroke: var(--muted);
        }

        .panel-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .panel-content .form-group {
            margin-bottom: 24px;
        }

        .panel-content .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .panel-content .weekday-selector {
            display: flex;
            gap: 0;
            flex-wrap: wrap;
        }

        .panel-content .weekday-checkbox {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--card);
            position: relative;
            min-width: 40px;
        }

        .panel-content .weekday-checkbox:first-child {
            border-radius: 8px 0 0 8px;
        }

        .panel-content .weekday-checkbox:last-child {
            border-radius: 0 8px 8px 0;
        }

        .panel-content .weekday-checkbox:not(:first-child) {
            border-left: none;
        }

        .panel-content .weekday-checkbox:hover {
            border-color: var(--accent);
            background: var(--card);
        }

        .panel-content .weekday-checkbox input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        .panel-content .weekday-checkbox span {
            font-size: 14px;
            color: var(--muted);
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .panel-content .weekday-checkbox:has(input[type="checkbox"]:checked) {
            border-color: var(--accent);
            background: var(--accent);
            color: var(--card);
        }

        .panel-content .weekday-checkbox:has(input[type="checkbox"]:checked) span {
            color: var(--card);
            font-weight: 600;
        }

        /* Monday checkbox is always required */
        .panel-content .weekday-checkbox:has(#plan-day-mo) {
            position: relative;
        }

        .panel-content .weekday-checkbox:has(#plan-day-mo)::after {
            content: "•";
            position: absolute;
            top: -2px;
            right: -2px;
            color: var(--accent);
            font-size: 12px;
            font-weight: bold;
        }

        .panel-content .slider-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .panel-content .slider-container input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            outline: none;
            cursor: pointer;
        }

        .panel-content .slider-container input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .panel-content .slider-container input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .panel-content .slider-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: var(--text);
            background: var(--card);
        }

        /* Smart Rules Visual Feedback - Better Design */
        .slider-container {
            position: relative;
        }





        /* Foldable Preset Menu */
        .preset-menu {
            margin-bottom: 24px;
        }

        .preset-menu-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: linear-gradient(135deg, var(--card) 0%, var(--card) 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--text);
        }

        .preset-menu-toggle:hover {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(99, 102, 241, 0.05) 100%);
        }

        .preset-menu-toggle::after {
            content: '▼';
            transition: transform 0.3s ease;
            color: var(--accent);
        }

        .preset-menu-toggle.expanded::after {
            transform: rotate(180deg);
        }

        .preset-menu-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: linear-gradient(135deg, var(--card) 0%, var(--card) 100%);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 12px 12px;
            margin-top: -2px;
        }

        .preset-menu-content.expanded {
            max-height: 500px;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 16px;
        }

        .preset-card {
            aspect-ratio: 1;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        }

        .preset-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(99, 102, 241, 0.15);
            border-color: var(--accent);
            background: linear-gradient(135deg, var(--card) 0%, var(--accent) 100%);
        }

        .preset-card:active {
            transform: translateY(-2px);
        }

        .preset-icon {
            width: 32px;
            height: 32px;
            opacity: 0.7;
            transition: all 0.3s ease;
            color: var(--accent);
        }

        .preset-card:hover .preset-icon {
            opacity: 1;
            transform: scale(1.15);
            color: #4f46e5;
        }


        /* Animations */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }


        /* Slider Tooltips */
        .slider-tooltip {
            background: #1f2937;
            color: var(--card);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: fadeInUp 0.2s ease-out;
        }

        .slider-tooltip::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #1f2937;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .panel-content label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 8px;
            display: block;
        }

        .panel-content small {
            font-size: 12px;
            color: var(--muted);
            margin-top: 4px;
            display: block;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .timetable-structure-panel {
                width: 100%;
                right: -100%;
            }

            .panel-content .form-row {
                grid-template-columns: 1fr;
            }
        }

        .plan-settings.collapsed .plan-settings-content {
            display: none;
        }

        /* Structure Section */

        .structure-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            padding: 0;
            background: linear-gradient(135deg, var(--card) 0%, var(--card) 100%);
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .structure-btn:hover {
            background: linear-gradient(135deg, var(--card) 0%, var(--border) 100%);
            border-color: var(--border);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .structure-btn svg {
            width: 18px;
            height: 18px;
            stroke: var(--accent);
        }


        .settings-section {
            margin-bottom: 40px;
        }

        .settings-section:last-child {
            margin-bottom: 0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f1f5f9;
        }

        .section-header h4 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-icon {
            width: 18px;
            height: 18px;
            stroke: var(--accent);
            flex-shrink: 0;
        }

        .section-badge {
            background: var(--accent);
            color: var(--card);
            font-size: 11px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            min-width: 20px;
            text-align: center;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .quick-action-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .quick-action-card:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
        }

        .action-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .action-icon svg {
            width: 24px;
            height: 24px;
            stroke: var(--accent);
        }

        .action-content {
            flex: 1;
        }

        .action-content h5 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin: 0 0 4px 0;
        }

        .action-content p {
            font-size: 12px;
            color: var(--muted);
            margin: 0;
        }

        /* Presets Section */
        .presets-container {
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--card);
        }

        .presets-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: var(--card);
            border-bottom: 1px solid #e2e8f0;
        }

        .presets-info p {
            font-size: 13px;
            color: var(--muted);
            margin: 0;
        }

        .preset-actions {
            display: flex;
            gap: 8px;
        }

        .presets-list {
            padding: 16px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .preset-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .preset-item:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .preset-color {
            width: 20px;
            height: 20px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .preset-info {
            flex: 1;
            min-width: 0;
        }

        .preset-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin: 0 0 2px 0;
        }

        .preset-details {
            font-size: 12px;
            color: var(--muted);
            margin: 0;
        }

        .preset-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: var(--border);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s ease;
            color: var(--muted);
        }

        .preset-btn:hover {
            background: var(--border);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .preset-btn.edit {
            color: var(--muted);
        }

        .preset-btn.edit:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .preset-btn.delete {
            color: var(--muted);
        }

        .preset-btn.delete:hover {
            background: #fee2e2;
            color: var(--accent);
        }

        /* Preset Container and Edit Panel */
        .preset-container {
            display: flex;
            flex-direction: column;
        }

        .preset-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .preset-edit-panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            animation: slideDown 0.2s ease;
            width: 100%;
            box-sizing: border-box;
            margin-top: 8px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .preset-edit-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .preset-edit-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .preset-edit-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .preset-edit-field label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text);
        }

        .preset-edit-input {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            background: var(--card);
            transition: border-color 0.2s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .preset-edit-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        .preset-edit-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 8px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .presets-list {
                padding: 8px;
                display: grid;
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .preset-edit-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .preset-edit-panel {
                padding: 12px;
                margin-top: 8px;
            }

            .preset-item {
                padding: 10px;
                gap: 10px;
            }

            .preset-edit-actions {
                flex-direction: column;
                gap: 6px;
            }

            .preset-edit-actions .btn {
                width: 100%;
            }

            .preferences-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .preference-card {
                padding: 16px;
            }
        }

        /* Data Management */
        .data-management-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .data-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s ease;
        }

        .data-card:hover {
            border-color: var(--accent);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
        }

        .data-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .data-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--card);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .data-icon svg {
            width: 20px;
            height: 20px;
            stroke: var(--accent);
        }

        .data-card-header h5 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin: 0;
            flex: 1;
        }

        .data-count {
            background: var(--accent);
            color: var(--card);
            font-size: 11px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            min-width: 20px;
            text-align: center;
        }

        .data-input-container {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .data-input-container .plan-setting-input {
            flex: 1;
        }

        .data-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .data-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 12px;
            color: var(--muted);
        }

        .data-tag-remove {
            width: 16px;
            height: 16px;
            border: none;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.2s ease;
        }

        .data-tag-remove:hover {
            background: var(--border);
            color: var(--accent);
        }

        /* Colors container */
        .colors-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .color-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .color-preset {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .color-preset:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .color-preset.selected {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }

        .color-preset-preview {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        .color-preset-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--text);
        }

        .color-input-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .data-input-container .color-input {
            width: 40px;
            height: 40px;
            border-radius: 8px;
        }

        .color-input-container .plan-setting-input {
            flex: 1;
        }

        /* Preferences */
        .preferences-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .preference-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
        }

        .preference-header {
            margin-bottom: 20px;
        }

        .preference-header h5 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin: 0 0 4px 0;
        }

        .preference-header p {
            font-size: 12px;
            color: var(--muted);
            margin: 0;
        }

        .preference-options {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .toggle-option {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle-label {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 30px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .toggle-input {
            opacity: 0;
            width: 0;
            height: 0;
            position: absolute;
        }

        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--border);
            border-radius: 30px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: var(--card);
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .toggle-input:checked+.toggle-slider {
            background: var(--accent);
            border-color: #4f46e5;
        }

        .toggle-input:checked+.toggle-slider::before {
            transform: translateX(22px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .toggle-input:focus+.toggle-slider {
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .option-content {
            flex: 1;
        }

        .option-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            display: block;
            margin-bottom: 2px;
        }

        .option-description {
            font-size: 11px;
            color: var(--muted);
        }

        .select-option {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .select-option .option-title {
            margin-bottom: 0;
        }

        .plan-setting-input,
        .plan-setting-select {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            background: var(--card);
            transition: all 0.2s ease;
            width: 100%;
        }

        .plan-setting-input:focus,
        .plan-setting-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .plan-setting-hint {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 2px;
        }

        .color-picker {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .color-input {
            width: 40px;
            height: 40px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .color-input:hover {
            border-color: var(--accent);
        }

        .color-preview {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--accent);
        }

        .color-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--muted);
            min-width: 60px;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle-input {
            display: none;
        }

        .toggle-label {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 28px;
            cursor: pointer;
        }

        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #d1d5db;
            border-radius: 28px;
            transition: background-color 0.2s ease;
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: var(--card);
            border-radius: 50%;
            transition: transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }


        .toggle-description {
            font-size: 12px;
            color: var(--muted);
            margin-top: 4px;
            line-height: 1.4;
        }

        .plan-settings-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid #f1f5f9;
        }

        .plan-settings-actions .btn {
            flex: 1;
            padding: 10px 16px;
            font-size: 13px;
        }

        /* Presets styling */
        .presets-container {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: var(--card);
        }

        .presets-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            background: var(--card);
            border-radius: 8px 8px 0 0;
        }

        .preset-actions {
            display: flex;
            gap: 8px;
        }

        .presets-count {
            font-size: 12px;
            font-weight: 500;
            color: var(--muted);
        }


        .preset-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--card);
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 6px;
            transition: all 0.2s ease;
        }

        .preset-item:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.1);
        }

        .preset-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        .preset-info {
            flex: 1;
            min-width: 0;
        }

        .preset-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
            margin: 0;
        }

        .preset-details {
            font-size: 11px;
            color: var(--muted);
            margin: 0;
        }

        .preset-actions {
            display: flex;
            gap: 4px;
        }

        .preset-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: var(--border);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            transition: all 0.2s ease;
            color: var(--muted);
        }

        .preset-btn:hover {
            background: var(--border);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .preset-btn.edit {
            color: var(--muted);
        }

        .preset-btn.edit:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .preset-btn.delete {
            color: var(--muted);
        }

        .preset-btn.delete:hover {
            background: #fee2e2;
            color: var(--accent);
        }

        /* Data input styling */
        .data-input-container {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .data-input-container .plan-setting-input {
            flex: 1;
        }

        .data-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }

        .data-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 11px;
            color: var(--muted);
        }

        .data-tag-remove {
            width: 14px;
            height: 14px;
            border: none;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.2s ease;
        }

        .data-tag-remove:hover {
            background: var(--border);
            color: var(--accent);
        }

        /* Colors container */
        .colors-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .color-presets {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .color-preset {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: var(--card);
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .color-preset:hover {
            border-color: var(--accent);
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.1);
        }

        .color-preset.selected {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }

        .color-preset-preview {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        .color-preset-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--text);
        }

        .color-input-container {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .data-input-container .color-input {
            width: 36px;
            height: 36px;
            border-radius: 6px;
        }

        .color-input-container .plan-setting-input {
            flex: 1;
        }

        /* Responsive design */
        @media (max-width: 1024px) {
            .plan-settings {
                padding: 16px;
            }

            .plan-settings-grid {
                gap: 12px;
            }
        }

        /* Ultimate Profile Styling */
        .ultimate-profile {
            display: flex;
            flex-direction: column;
            gap: 24px;
            margin-top: 24px;
        }

        /* Quick Access Header */
        .profile-quick-header {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 32px;
            align-items: center;
            padding: 24px;
            background: linear-gradient(135deg, var(--card) 0%, var(--card) 100%);
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .profile-identity {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .profile-avatar-large {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--card);
            font-size: 32px;
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
        }

        .avatar-edit-btn {
            position: absolute;
            bottom: -4px;
            right: -4px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--card);
            border: 2px solid #6366f1;
            color: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .avatar-edit-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .avatar-edit-btn svg {
            width: 14px;
            height: 14px;
        }

        .profile-identity-info h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
            line-height: 1.2;
        }

        .profile-identity-info p {
            margin: 4px 0 8px 0;
            font-size: 16px;
            color: var(--muted);
            font-weight: 500;
        }

        .profile-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #059669;
            font-weight: 500;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .status-indicator.active {
            background: #10b981;
        }

        /* Quick Actions */
        .profile-quick-actions {
            display: flex;
            gap: 12px;
        }

        .quick-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px 20px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
            text-decoration: none;
            color: var(--text);
        }

        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: var(--accent);
            color: var(--accent);
        }

        .quick-action-btn svg {
            width: 24px;
            height: 24px;
        }

        .quick-action-btn span {
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        /* Smart Dashboard */
        .profile-dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .dashboard-card {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .card-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
        }

        .card-date {
            font-size: 14px;
            color: var(--muted);
            font-weight: 500;
        }

        /* Today's Overview */
        .today-overview {
            grid-column: 1 / -1;
        }

        .today-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .today-stat {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--card);
        }

        .stat-icon.today {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        .stat-icon.next {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .stat-icon.progress {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .stat-icon svg {
            width: 24px;
            height: 24px;
        }

        .stat-info .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
            line-height: 1;
        }

        .stat-info .stat-label {
            font-size: 12px;
            color: var(--muted);
            font-weight: 500;
            margin-top: 2px;
        }

        /* Smart Insights */
        .insight-refresh {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--muted);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .insight-refresh:hover {
            background: var(--accent);
            color: var(--card);
            border-color: var(--accent);
        }

        .insight-refresh svg {
            width: 16px;
            height: 16px;
        }

        .insights-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }

        .insight-item:hover {
            background: var(--border);
            border-color: var(--accent);
        }

        .insight-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--card);
            flex-shrink: 0;
        }

        .insight-icon svg {
            width: 20px;
            height: 20px;
        }

        .insight-content {
            flex: 1;
        }

        .insight-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .insight-description {
            font-size: 13px;
            color: var(--muted);
            line-height: 1.4;
        }

        /* Quick Stats */
        .stats-toggle {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--card);
            border: 1px solid var(--border);
            color: var(--muted);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stats-toggle:hover {
            background: var(--accent);
            color: var(--card);
            border-color: var(--accent);
        }

        .stats-toggle svg {
            width: 16px;
            height: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .stat-card {
            padding: 20px;
            background: var(--card);
            border-radius: 12px;
            border: 1px solid var(--border);
            text-align: center;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            background: var(--border);
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 4px;
        }

        .stat-title {
            font-size: 12px;
            color: var(--muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-size: 11px;
            color: #059669;
            font-weight: 500;
        }

        .trend-icon {
            font-size: 12px;
        }

        /* Compact Profile Form */
        .profile-form-compact {
            background: var(--card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .form-section h4 {
            margin: 0 0 20px 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-actions-compact {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .profile-dashboard {
                grid-template-columns: 1fr;
            }

            .today-stats {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .profile-quick-header {
                grid-template-columns: 1fr;
                gap: 20px;
                text-align: center;
            }

            .profile-quick-actions {
                justify-content: center;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .form-actions-compact {
                flex-direction: column;
            }
        }

        .profile-card {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .profile-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        .profile-avatar {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--card);
            font-size: 24px;
        }

        .avatar-placeholder svg {
            width: 32px;
            height: 32px;
        }

        .profile-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--card);
        }

        .profile-icon svg {
            width: 24px;
            height: 24px;
        }

        .profile-info h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
        }

        .profile-info p {
            margin: 4px 0 0 0;
            font-size: 14px;
            color: var(--muted);
        }

        .profile-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
        }

        .stat-item {
            text-align: center;
            padding: 16px;
            background: var(--card);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text);
        }

        .checkbox-label input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #6366f1;
        }

        .btn.success {
            background: #10b981;
            color: var(--card);
        }

        .btn.success:hover {
            background: #059669;
        }

        /* Profile foldable sections */
        .profile-settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 16px 0;
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .profile-settings-header:hover {
            background: rgba(99, 102, 241, 0.05);
            border-radius: 8px;
            padding: 16px;
            margin: 0 -16px;
        }

        .profile-settings-header.collapsed {
            border-bottom: none;
        }

        .profile-settings-content {
            display: none;
            padding-top: 24px;
            animation: slideDown 0.3s ease;
        }

        .profile-settings-content.expanded {
            display: block;
        }

        .settings-chevron {
            width: 20px;
            height: 20px;
            transition: transform 0.3s ease;
            color: var(--muted);
        }

        .profile-settings-header.expanded .settings-chevron {
            transform: rotate(180deg);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Analysis page styling */
        .analysis-page {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .analysis-header {
            margin-bottom: 32px;
            text-align: center;
        }

        .analysis-header h2 {
            margin: 0 0 8px 0;
            font-size: 28px;
            font-weight: 700;
            color: var(--text);
        }

        .analysis-header p {
            margin: 0;
            color: var(--muted);
            font-size: 16px;
        }

        .analysis-content {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            ;
        }

        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--muted);
            font-weight: 500;
        }

        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .chart-container {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .chart-container h3 {
            margin: 0 0 16px 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            text-align: center;
        }

        .chart-container .chart {
            height: 200px;
            width: 100%;
        }

        /* Settings form styling */
        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
            ;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            ;
        }

        .form-group label {
            font-weight: 500;
            color: var(--text);
            font-size: 14px;
        }

        .form-group input {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .form-group small {
            color: var(--muted);
            font-size: 12px;
        }

        .settings-footer {
            margin-top: 24px;
            text-align: center;
        }

        .auto-save-notice {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            ;
            padding: 8px 16px;
            background: var(--card);
            border: 1px solid #bae6fd;
            border-radius: 8px;
            color: #0369a1;
            font-size: 14px;
        }

        .save-icon {
            color: #059669;
            font-weight: bold;
        }

        /* Toggle switches */
        .settings-toggles {
            display: flex;
            flex-direction: column;
            gap: 16px;
            ;
        }

        .toggle-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .toggle-group:last-child {
            border-bottom: none;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            ;
            cursor: pointer;
            flex: 1;
        }

        .toggle-text {
            font-weight: 500;
            color: var(--text);
            font-size: 14px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
            cursor: pointer;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #d1d5db;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: var(--card);
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch input:checked+.toggle-slider {
            background-color: #6366f1;
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(24px);
        }

        .toggle-switch input:focus+.toggle-slider {
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        /* Settings actions */
        .settings-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            ;
        }

        .settings-actions .btn {
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .settings-actions .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Settings-based visual effects */
        .compact-view .chart-container {
            padding: 12px;
        }

        .compact-view .stat-card {
            padding: 12px;
        }

        .compact-view .toggle-group {
            padding: 8px 0;
        }

        .compact-view .form-group {
            gap: 2px;
        }

        .no-animations * {
            transition: none !important;
            animation: none !important;
        }

        .performance-mode .chart-container {
            box-shadow: none;
        }

        .performance-mode .stat-card {
            box-shadow: none;
        }

        .performance-mode .toggle-slider {
            transition: none;
        }

        .performance-mode .toggle-slider:before {
            transition: none;
        }

        /* Analysis page styling */
        .analysis-page {
            padding: 24px 0;
        }

        .analysis-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .analysis-header h2 {
            margin: 0 0 8px 0;
            font-size: 28px;
            font-weight: 700;
            color: var(--text);
        }

        .analysis-header p {
            margin: 0;
            color: var(--muted);
            font-size: 16px;
        }

        .analysis-content {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            ;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--muted);
            font-weight: 500;
        }

        .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }

        /* Info tooltip styling */
        .info-tooltip {
            position: relative;
            display: inline-block;
            margin-left: 8px;
        }

        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: var(--border);
            color: var(--muted);
            border-radius: 50%;
            font-size: 10px;
            font-weight: 600;
            cursor: help;
            transition: all 0.2s ease;
        }

        .info-icon:hover {
            background: var(--accent);
            color: var(--card);
        }

        .info-tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background: #1e293b;
            color: var(--card);
            text-align: left;
            border-radius: 8px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .info-tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1e293b transparent transparent transparent;
        }

        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Touch-friendly interactions */
        .btn,
        .pill,
        .chip,
        .lesson,
        .grid .cell {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* Prevent text selection on interactive elements */
        .btn,
        .pill,
        .chip,
        .lesson,
        .grid .cell,
        .nav-island {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Prevent text cursor and caret globally */
        * {
            caret-color: transparent;
        }

        *:focus {
            outline: none;
        }

        /* Smooth scrolling for mobile */
        html {
            scroll-behavior: smooth;
            -webkit-text-size-adjust: 100%;
        }

        /* Mobile-first responsive design */
        @media (max-width: 768px) {

            /* Global mobile adjustments */
            .container {
                padding: 12px;
            }

            /* Header mobile */
            .header {
                padding: 12px 16px;
            }

            .header h1 {
                font-size: 20px;
            }

            /* Navigation mobile - using desktop styles */

            .pill-slider {
                width: 36px;
                height: 36px;
                top: 4px;
            }

            /* Mobile pill styles removed - using desktop styles */

            .nav-icon {
                width: 20px;
                height: 20px;
            }

            /* Overview mobile */
            .ov-main-grid {
                grid-template-columns: 1fr;
                gap: 20px;
                margin-bottom: 20px;
            }

            .ov-secondary-content {
                order: -1;
            }

            .ov-heatmap-today {
                grid-template-columns: 1fr;
                gap: 16px;
                margin-bottom: 20px;
            }

            /* Weekly Plan mobile improvements */
            .ov-section {
                margin-bottom: 24px;
            }

            .ov-section-header {
                margin-bottom: 16px;
            }

            .ov-section-title {
                font-size: 18px;
            }

            /* Chart cards mobile optimization */
            .chart-card,
            .list-card {
                min-height: unset;
                /* Allow dynamic height based on content */
                padding: 16px;
            }

            /* Heute card should size to content when empty on mobile */
            .list-card:has(.small) {
                min-height: auto;
            }

            .chart-title {
                font-size: 16px;
                margin-bottom: 12px;
            }

            /* Week navigation mobile */
            .week-nav-container {
                flex-direction: row;
                gap: 8px;
                align-items: center;
                justify-content: flex-end;
                flex-wrap: nowrap;
            }

            .week-nav {
                display: flex;
                align-items: center;
                gap: 6px;
                flex-shrink: 0;
            }

            .current-week-btn {
                flex-shrink: 0;
                padding: 6px 10px;
                font-size: 11px;
                white-space: nowrap;
            }

            /* Ensure week display text doesn't wrap */
            #weekDisplay {
                white-space: nowrap;
                font-size: 12px;
            }

            /* Make navigation buttons smaller on mobile */
            .week-nav .btn.mini {
                padding: 4px 8px;
                font-size: 11px;
                min-width: 28px;
                min-height: 28px;
            }

            .ov-statistics {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
                padding: 12px;
            }

            .ov-section-title {
                font-size: 18px;
            }

            /* Mobile-specific overview improvements */
            .ov-section {
                margin-bottom: 24px;
                margin-top: 30px;
            }

            .ov-section-header {
                margin-bottom: 12px;
            }

            /* Next Up card mobile optimization */
            .next-up-card {
                padding: 16px;
            }

            .next-up-header {
                margin-bottom: 12px;
            }

            .next-up-icon {
                width: 36px;
                height: 36px;
            }

            .next-up-icon svg {
                width: 18px;
                height: 18px;
            }

            .next-up-title {
                font-size: 16px;
            }

            .next-up-subtitle {
                font-size: 12px;
            }

            /* Chart cards mobile */
            .chart-card {
                padding: 16px;
            }

            .chart-title {
                font-size: 16px;
                margin-bottom: 12px;
            }

            /* Timer mobile optimization */
            .timer-card.big.square {
                padding: 20px;
            }

            .timer-face.xl {
                font-size: 48px;
            }

            .btn-row {
                gap: 12px;
                margin-top: 16px;
            }

            /* KPI cards mobile - single row */
            .kpi {
                padding: 8px;
                text-align: center;
            }

            .kpi .label {
                font-size: 10px;
                margin-bottom: 4px;
                line-height: 1.2;
            }

            .kpi .value {
                font-size: 18px;
                margin-bottom: 2px;
                font-weight: 700;
            }

            .kpi .meta {
                font-size: 9px;
                line-height: 1.2;
            }

            /* Activity list mobile */
            .activity-list {
                gap: 10px;
                padding: 6px 0;
            }

            .activity-item {
                padding: 10px;
                min-width: 120px;
            }

            .activity-icon {
                width: 28px;
                height: 28px;
            }

            .activity-icon svg {
                width: 14px;
                height: 14px;
            }

            .activity-title {
                font-size: 12px;
            }

            .activity-description {
                font-size: 10px;
            }

            .activity-time {
                font-size: 9px;
            }

            .activity-content h4 {
                font-size: 14px;
            }

            .activity-content p {
                font-size: 12px;
            }

            /* Week navigation mobile */
            .week-nav-container {
                flex-direction: row;
                gap: 8px;
                align-items: center;
                justify-content: flex-end;
            }

            .week-nav {
                justify-content: center;
            }

            .current-week-btn {
                flex-shrink: 0;
                justify-content: center;
            }

            /* Info tooltips mobile */
            .info-tooltip {
                position: relative;
            }

            .info-tooltip .tooltip-text {
                display: none;
            }

            .info-tooltip:hover .tooltip-text {
                display: block;
                position: absolute;
                top: 100%;
                left: 0;
                background: rgba(0, 0, 0, 0.8);
                color: var(--card);
                padding: 8px;
                border-radius: 4px;
                font-size: 12px;
                white-space: nowrap;
                z-index: 1000;
            }

            /* Button adjustments mobile */
            .btn.mini {
                padding: 8px 12px;
                font-size: 12px;
            }

            /* Card hover effects disabled on mobile */
            .chart-card:hover,
            .kpi:hover,
            .timer-card:hover {
                transform: none;
                box-shadow: inherit;
            }

            /* Touch-friendly sizing */
            .btn {
                min-height: 44px;
                min-width: 44px;
            }

            /* Improved spacing for mobile */
            .container {
                padding: 12px;
            }

            /* Mobile-specific font adjustments */
            h1 {
                font-size: 18px;
            }

            h2 {
                font-size: 16px;
            }

            h3 {
                font-size: 15px;
            }

            /* Improved readability */
            .meta {
                font-size: 12px;
                line-height: 1.4;
            }

            /* Better contrast for mobile */
            .kpi .value {
                color: var(--text);
                font-weight: 700;
            }

            /* Mobile-specific layout improvements */
            .ov-primary-content,
            .ov-secondary-content {
                gap: 20px;
            }

            /* Heatmap mobile optimization */
            #heatmap {
                min-height: unset;
                /* Allow dynamic height based on content */
                width: 100%;
                max-width: 100%;
            }

            /* Chart wrap responsive improvements */
            .chart-wrap {
                width: 100%;
            }

            /* Ensure heatmap scales properly on all devices */
            .chart-card #heatmap {
                width: 100%;
                height: auto;
                min-height: unset;
                /* Allow dynamic height based on content */
                max-width: 100%;
            }

            /* Fix heatmap card mobile layout */
            .chart-card {
                width: 100%;
                max-width: 100%;
            }

            /* Prevent heatmap elements from stacking */
            .ov-heatmap-today .chart-card {
                margin-bottom: 16px;
            }

            /* Ensure proper spacing between heatmap and today sections */
            .ov-heatmap-today>* {
                margin-bottom: 16px;
            }

            .ov-heatmap-today>*:last-child {
                margin-bottom: 0;
            }

            /* Timer section mobile layout */
            .ov-timer-section {
                padding: 16px;
            }

            /* Statistics mobile layout */
            .ov-statistics {
                margin-top: 16px;
            }

            /* Activity section mobile */
            .activity-list {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Next Up section mobile */
            .ov-next-up-section {
                margin-bottom: 24px;
            }

            /* Next Up inside Heute card mobile */
            .next-up-in-heute {
                margin-top: 12px;
                padding-top: 12px;
            }

            .next-up-content-heute {
                gap: 10px;
            }

            .next-up-icon-small {
                width: 28px;
                height: 28px;
            }

            .next-up-icon-small svg {
                width: 14px;
                height: 14px;
            }

            .next-up-title-heute {
                font-size: 13px;
            }

            .next-up-subtitle-heute {
                font-size: 11px;
            }

            .next-up-card {
                padding: 14px;
                max-width: 100%;
            }

            .next-up-header {
                gap: 12px;
                margin-bottom: 12px;
            }

            .next-up-icon {
                width: 36px;
                height: 36px;
            }

            .next-up-icon svg {
                width: 18px;
                height: 18px;
            }

            .next-up-title {
                font-size: 18px;
            }

            .next-up-subtitle {
                font-size: 13px;
            }

            .next-up-actions .btn {
                padding: 8px 16px;
                font-size: 13px;
                cursor: pointer;
            }

            /* Quick stats mobile */
            .quick-stats-row {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
                margin-bottom: 24px;
            }

            .stat-card {
                padding: 16px;
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }

            .stat-icon {
                width: 40px;
                height: 40px;
            }

            .stat-icon svg {
                width: 20px;
                height: 20px;
            }

            .stat-number {
                font-size: 20px;
            }

            .stat-label {
                font-size: 12px;
            }

            /* Activity list mobile */
            .activity-item {
                padding: 12px;
                gap: 12px;
            }

            .activity-icon {
                width: 36px;
                height: 36px;
            }

            .activity-icon svg {
                width: 18px;
                height: 18px;
            }

            .activity-title {
                font-size: 14px;
            }

            .activity-description {
                font-size: 13px;
            }

            /* Quick actions mobile */
            .quick-actions-grid {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .quick-action-btn {
                padding: 16px 12px;
                gap: 8px;
            }

            .action-icon {
                width: 36px;
                height: 36px;
            }

            .action-icon svg {
                width: 18px;
                height: 18px;
            }

            .action-text {
                font-size: 13px;
            }

            /* Timer mobile */
            .timer-card.big.square {
                justify-self: center;
                max-width: 280px;
                padding: 20px;
            }

            .timer-face.xl {
                font-size: 32px;
            }

            .btn-row {
                flex-direction: column;
                gap: 8px;
                ;
            }

            /* Plan mobile */
            .plan-week-nav-container {
                flex-direction: column;
                gap: 8px;
                ;
            }

            .plan-week-settings {
                justify-content: center;
            }

            .daily-hours-setting {
                padding: 8px 12px;
            }

            .daily-hours-setting label {
                font-size: 13px;
            }

            .daily-hours-setting input {
                width: 60px;
                padding: 6px 8px;
                font-size: 13px;
            }

            .add-row-section {
                padding: 12px;
            }

            .add-row-btn {
                padding: 12px 24px;
                font-size: 13px;
                width: 100%;
                max-width: 280px;
            }

            .plan-week-nav-content {
                flex-direction: column;
                gap: 8px;
                ;
                padding: 12px;
            }

            /* Mobile positioning for current week button */
            .plan-week-nav-container .current-week-btn {
                position: static;
                transform: none;
                margin-bottom: 8px;
                width: 44px !important;
                height: 44px !important;
                border-radius: 12px !important;
            }

            .plan-week-nav-content span {
                font-size: 14px;
                min-width: auto;
            }

            .grid {
                font-size: 12px;
            }

            .grid .head {
                padding: 8px 4px;
                font-size: 11px;
            }

            .grid .time-cell {
                padding: 4px 4px 4px 22px;
                min-width: 70px;
                width: 70px;
                font-size: 12px;
            }

            .lesson {
                font-size: 10px;
                padding: 4px 6px;
                min-height: 32px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .lesson .subject {
                font-weight: 600;
                line-height: 1.2;
            }

            .lesson .meta {
                font-size: 9px;
                opacity: 0.8;
                margin-top: 2px;
            }

            .legend {
                flex-direction: column;
                gap: 8px;
                ;
                padding: 12px;
            }

            .legend .chip {
                font-size: 11px;
                padding: 6px 8px;
            }

            /* Analysis mobile */
            .analysis-page {
                padding: 12px;
            }

            .analysis-header h2 {
                font-size: 24px;
            }

            .stats-row {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                ;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-number {
                font-size: 24px;
            }

            .stat-label {
                font-size: 12px;
            }

            .charts-row {
                grid-template-columns: 1fr;
                gap: 16px;
                ;
            }

            .chart-container {
                padding: 16px;
            }

            .chart-container h3 {
                font-size: 16px;
            }

            .chart-container .chart {
                height: 150px;
            }

            /* Settings mobile improvements */
            .stats-row {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
                ;
            }

            .stat-card {
                padding: 16px;
            }

            .stat-number {
                font-size: 24px;
            }

            .charts-row {
                grid-template-columns: 1fr;
                gap: 16px;
                ;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
                ;
            }

            .toggle-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
                ;
                padding: 16px 0;
            }

            .toggle-label {
                width: 100%;
            }

            .settings-actions {
                grid-template-columns: 1fr;
                gap: 8px;
                ;
            }

            /* Chart and heatmap mobile improvements */
            .chart-card,
            .list-card {
                padding: 12px;
            }

            .chart-title {
                font-size: 14px;
                margin-bottom: 8px;
            }


            /* Heatmap mobile specific */
            #heatmap {
                min-height: unset;
                /* Allow dynamic height based on content */
            }

            /* KPI cards mobile */
            .kpi {
                padding: 16px;
                text-align: center;
            }

            .kpi .label {
                font-size: 12px;
                margin-bottom: 8px;
            }

            .kpi .value {
                font-size: 24px;
                font-weight: 700;
            }

            .kpi .meta {
                font-size: 11px;
                margin-top: 4px;
            }


            .folders-actions {
                flex-direction: column;
                gap: 8px;
                ;
            }

            .upload-section {
                padding: 16px;
            }

            .dropzone {
                padding: 24px 16px;
            }

            .folders-grid {
                grid-template-columns: 1fr;
                gap: 12px;
                ;
            }

            .folder-card {
                padding: 16px;
            }

            /* Settings mobile */
            .settings-page {
                padding: 12px;
            }

            .settings-header h2 {
                font-size: 24px;
            }

            .settings-row {
                grid-template-columns: 1fr;
                gap: 12px;
                ;
            }

            .settings-card {
                padding: 16px;
            }

            .settings-card-title {
                font-size: 16px;
            }

            .settings-field {
                margin-bottom: 16px;
            }

            .settings-field label {
                font-size: 13px;
            }

            .settings-field input {
                font-size: 16px;
                /* Prevents zoom on iOS */
                padding: 12px;
            }

            /* Full-width settings mobile */
            .settings-info-section .settings-info {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .settings-data-section .settings-actions {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            /* Modals mobile */
            .modal {
                margin: 20px;
                max-width: calc(100vw - 40px);
                max-height: calc(100vh - 40px);
                overflow-y: auto;
            }

            .modal-header h2 {
                font-size: 18px;
            }

            .modal-content {
                padding: 16px;
            }

            .actions {
                flex-direction: column;
                gap: 8px;
                ;
            }

            .actions .btn {
                width: 100%;
                min-height: 44px;
                /* iOS touch target */
            }

            /* Form improvements for mobile */
            .field input,
            .field select,
            .field textarea {
                min-height: 44px;
                /* iOS touch target */
                font-size: 16px;
                /* Prevents zoom on iOS */
                border-radius: 8px;
            }

            .accordion summary {
                min-height: 44px;
                display: flex;
                align-items: center;
            }

            .accordion .row button {
                min-height: 44px;
            }

            /* Info tooltips mobile */
            .info-tooltip .tooltip-text {
                width: 160px;
                font-size: 11px;
                padding: 6px 8px;
            }

            /* Week navigation mobile */
            .week-nav-container {
                flex-direction: row;
                gap: 8px;
                ;
                align-items: center;
                justify-content: flex-end;
            }

            .week-nav {
                flex-direction: row;
                gap: 6px;
                ;
                padding: 6px 8px;
            }

            .week-nav span {
                font-size: 12px;
                min-width: auto;
            }

            .week-nav .btn.mini {
                width: 32px;
                height: 32px;
            }

            .current-week-btn {
                align-self: center;
                min-width: 70px !important;
                height: 36px !important;
                font-size: 13px !important;
                padding: 8px 12px !important;
            }

            /* Drag and drop mobile improvements */
            .grid .cell {
                min-height: 40px;
                position: relative;
            }

            .grid .cell:hover::after {
                content: '+';
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 16px;
                color: var(--muted);
                pointer-events: none;
            }

            .grid .cell:active {
                background: var(--border);
            }

            /* Mobile-specific grid improvements */
            .grid {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .grid-wrap {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Hero section mobile */
            .ov-hero-inline {
                margin: 8px 0 16px;
            }

            .hero-compact {
                padding: 12px;
            }

            .hc-title {
                font-size: 14px;
            }

            .hc-meta {
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {

            /* Extra small mobile adjustments */
            .container {
                padding: 8px;
            }

            /* Extra small mobile nav-island styles removed - using desktop styles */

            .nav-icon {
                width: 18px;
                height: 18px;
            }

            /* Extra small mobile heatmap fixes */
            .ov-heatmap-today {
                gap: 12px;
                margin-bottom: 16px;
            }

            .chart-card {
                padding: 12px;
                min-height: unset;
                /* Allow dynamic height based on content */
            }

            /* Heute card should size to content when empty on small mobile */
            .list-card:has(.small) {
                min-height: auto;
            }

            #heatmap {
                min-height: unset;
                /* Allow dynamic height based on content */
            }

            .chart-card #heatmap {
                min-height: unset;
                /* Allow dynamic height based on content */
            }

            .stats-row {
                grid-template-columns: 1fr;
            }

            .stat-card {
                padding: 12px;
            }

            .stat-number {
                font-size: 20px;
            }

            .chart-container .chart {
                height: 120px;
            }

            .modal {
                margin: 10px;
                max-width: calc(100vw - 20px);
            }

            .info-tooltip .tooltip-text {
                width: 140px;
                font-size: 10px;
            }
        }

        .preset-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .preset-table th,
        .preset-table td {
            border-bottom: 1px solid var(--border);
            padding: 6px 8px;
            text-align: left;
        }

        .preset-row-actions {
            display: flex;
            gap: 6px;
        }

        .inline-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--card);
            font-size: 14px;
        }

        .inline-color {
            width: 42px;
            height: 32px;
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        /* Hero: kompakte Liste */
        .hero-sub ul {
            margin: 6px 0 0;
            padding-left: 16px;
        }

        .hero-sub li {
            margin: 2px 0;
        }

        /* Klickbarer Ordner mit Farbswatch (Square) */
        .folder-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #0f172a;
            color: var(--card);
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 12px;
            line-height: 1;
            cursor: pointer;
        }

        .folder-chip .swatch {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            background: var(--col, #e2e8f0);
        }

        /* Container-Abstand über dem Grid */
        .ov-hero-inline {
            margin: 10px 0 14px;
        }

        /* Kompakte Card – nicht breit */
        .hero-compact {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 16px;
            ;
            padding: 12px 14px;
            border-radius: 14px;
            background: var(--card);
            /* kein Verlauf mehr */
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            width: min(560px, 100%);
            /* kompakt! */
            margin: 0 auto;
            /* horizontal zentrieren */
        }

        .hc-title {
            font-weight: 800;
            font-size: 18px;
            margin: 0 0 4px 0;
        }

        .hc-meta {
            font-size: 13px;
            color: var(--muted);
        }

        /* Quadratischer Ordner-Button rechts */
        .folder-tile {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--card);
            display: grid;
            place-items: center;
            cursor: pointer;
            transition: transform .15s ease;
        }

        .folder-tile:hover {
            transform: scale(1.04);
        }

        .folder-tile .swatch {
            width: 30px;
            height: 20px;
            border-radius: 6px;
            background: var(--col, #e5e7eb);
            position: relative;
        }

        .folder-tile .swatch::after {
            content: "";
            position: absolute;
            left: 4px;
            top: -6px;
            width: 12px;
            height: 6px;
            border-radius: 4px 4px 0 0;
            background: rgba(0, 0, 0, .16);
        }

        /* hide the big time in the hero */
        #ovHeroClock {
            display: none;
        }

        /* Icon sizing */
        .ico {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
        }

        .ico svg {
            width: 100%;
            height: 100%;
        }

    </style>
</head>

<body>
    <header class="sticky">
        <div class="container">
            <div class="hstack">
                <div class="header-left">
                    <h1>stunova.</h1>
                </div>
                <div class="header-center">
                    <div class="nav-island" role="tablist">
                        <div class="pill-slider"></div>
                        <button class="pill" id="navOverview" role="tab" aria-selected="false" title="Overview">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"></rect>
                                <rect x="14" y="3" width="7" height="7"></rect>
                                <rect x="14" y="14" width="7" height="7"></rect>
                                <rect x="3" y="14" width="7" height="7"></rect>
                            </svg>
                        </button>
                        <button class="pill" id="navPlan" role="tab" aria-selected="false" title="Plan">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                                <line x1="8" y1="14" x2="16" y2="14"></line>
                                <line x1="8" y1="18" x2="16" y2="18"></line>
                            </svg>
                        </button>
                        <button class="pill" id="navFolders" role="tab" aria-selected="false" title="Ordner">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z">
                                </path>
                            </svg>
                        </button>
                        <button class="pill" id="navProfile" role="tab" aria-selected="false" title="Profile">
                            <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="header-timer">
                    <div class="timer-card compact" id="pomCard">
                        <div id="pomFace" class="timer-face">
                            <span class="timer-display">25:00</span>
                            <button class="btn mini danger reset-inside" id="pomReset" aria-label="Reset">
                                <span class="ico" aria-hidden="true">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 6V3L8 7l4 4V8a6 6 0 11-6 6H4a8 8 0 108-8z" />
                                    </svg>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation pills - separate from header for mobile positioning -->
    <div class="nav-container">
        <div class="nav-main-content">
            <div class="container" style="display:flex;flex-direction:column;align-items:center;gap:8px">
                <div id="currentBannerWrap" class="centered-banner">
                    <div id="currentWrap" style="width:100%;display:flex;justify-content:center"></div>
                </div>
            </div>
        </div>
    </div>


    <main class="page-container">
        <!-- OVERVIEW Seite -->
        <div class="container" id="pageOverview" hidden>
            <!-- Next Up Section -->



            <!-- Schedule overview section -->
            <section class="ov-section">
                <div class="ov-section-header" style="margin-bottom:0px">
                </div>
                <div class="ov-heatmap-today">
                    <div class="heatmap-layout">
                        <!-- Heatmap Navigation Island -->
                        <div class="heatmap-nav-island">
                            <div class="plan-week-nav">
                                <div class="profile-selection-area"
                                    style="max-width:200px;width:200px;margin-right:12px">
                                    <div class="profile-switch-container" style="width:100%">
                                        <div class="profile-switch" onclick="toggleProfileSwitch()">
                                            <div class="profile-switch-current">
                                                <div class="profile-switch-chevron">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <polyline points="15,18 9,12 15,6" />
                                                    </svg>
                                                </div>
                                                <div class="profile-switch-avatar">
                                                    <!-- Empty circle for avatar placeholder -->
                                                </div>
                                                <div class="profile-switch-info">
                                                    <span class="profile-switch-name"
                                                        id="currentProfileName">name</span>
                                                    <span class="profile-switch-type"
                                                        id="currentProfileType">fefewf</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="profile-switch-dropdown" id="profileSwitchDropdown">
                                            <div class="profile-switch-header">
                                                <h4 data-i18n="profileSwitchTitle">Create New</h4>
                                                <button class="profile-switch-add" onclick="toggleProfileCreation()"
                                                    title="Create new profile">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                        stroke-width="2">
                                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                                    </svg>
                                                </button>
                                            </div>
                                            
                                            <!-- Profile Creation Form -->
                                            <div class="profile-creation-form" id="profileCreationForm" style="display: none;">
                                                <div class="profile-form-content">
                                                    <div class="form-group">
                                                        <label for="profileNameInput">Profilname:</label>
                                                        <input type="text" id="profileNameInput" placeholder="z.B. Schule, Arbeit" maxlength="50">
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="profileTypeInput">Typ:</label>
                                                        <input type="text" id="profileTypeInput" placeholder="z.B. Schule, Universität" maxlength="30">
                                                    </div>
                                                    <div class="form-actions">
                                                        <button class="btn btn-primary" onclick="createProfileFromForm()">Erstellen</button>
                                                        <button class="btn btn-secondary" onclick="cancelProfileCreation()">Abbrechen</button>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="profile-switch-list" id="profileSwitchList">
                                                <!-- Profiles will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="plan-week-nav-container">
                                    <button class="btn mini current-week-btn" id="goToCurrentWeek"
                                        title="Zur aktuellen Woche">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                                            <polyline points="9,22 9,12 15,12 15,22" />
                                        </svg>
                                    </button>
                                    <div class="plan-week-nav-content">
                                        <button class="btn mini" id="weekBack" title="Vorherige Woche">◀</button>
                                        <span id="weekDisplay" title="Klicken zum Kopieren, Doppelklick zum Bearbeiten">KW XX</span>
                                        <button class="btn mini" id="weekForward" title="Nächste Woche">▶</button>
                                    </div>
                                </div>
                                <button class="btn secondary structure-btn" onclick="toggleTimetableStructurePanel()"
                                    title="Timetable Structure">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 3h18v18H3zM9 9h6v6H9z" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Heatmap Card -->
                        <div class="chart-card clickable" id="heatmapCard" title="Zum Plan">
                            <div id="heatmap" class="chart-wrap"></div>
                        </div>
                    </div>

                    <div class="list-card clickable" id="todayCard" title="Zum Plan">
                        <div class="chart-title">Heute
                            <div class="info-tooltip">
                                <span class="info-icon">i</span>
                                <span class="tooltip-text">Zeigt alle Stunden von heute. Grüne Markierung = bereits
                                    vergangene Stunden.</span>
                            </div>
                        </div>
                        <div id="listToday" class="mini-list"></div>
                        <!-- Next Up Section inside Heute card -->
                        <div class="next-up-in-heute" id="nextUpInHeute" style="display: none;">
                            <div class="next-up-divider"></div>
                            <div class="next-up-content-heute">
                                <div class="next-up-icon-small">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12,6 12,12 16,14"></polyline>
                                    </svg>
                                </div>
                                <div class="next-up-text-heute">
                                    <div class="next-up-title-heute" id="nextUpTitleHeute" data-i18n="nextUp">Next Up
                                    </div>
                                    <div class="next-up-subtitle-heute" id="nextUpSubtitleHeute"
                                        data-i18n="noLessonsPlanned">No lessons planned</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </div>

        <!-- PLAN + rechte Datenleiste -->
        <div class="container" id="pagePlan" hidden>


            <div class="layout">
                <div>
                    <!-- Plan week navigation -->
                    <div class="plan-week-nav">
                        <div class="profile-selection-area" style="max-width:280px;width:280px;margin-right:12px">
                            <div class="profile-switch-container" style="width:100%">
                                <div class="profile-switch" onclick="toggleProfileSwitch()">
                                    <div class="profile-switch-current">
                                        <div class="profile-switch-chevron">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="15,18 9,12 15,6" />
                                            </svg>
                                        </div>
                                        <div class="profile-switch-avatar">
                                            <!-- Empty circle for avatar placeholder -->
                                        </div>
                                        <div class="profile-switch-info">
                                            <span class="profile-switch-name" id="currentProfileName">name</span>
                                            <span class="profile-switch-type" id="currentProfileType">fefewf</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="profile-switch-dropdown" id="profileSwitchDropdown">
                                    <div class="profile-switch-header">
                                        <h4 data-i18n="profileSwitchTitle">Create New</h4>
                                        <button class="profile-switch-add" onclick="toggleProfileCreation()"
                                            title="Create new profile">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                                <line x1="5" y1="12" x2="19" y2="12"></line>
                                            </svg>
                                        </button>
                                    </div>
                                    
                                    <!-- Profile Creation Form -->
                                    <div class="profile-creation-form" id="profileCreationForm2" style="display: none;">
                                        <div class="profile-form-content">
                                            <div class="form-group">
                                                <label for="profileNameInput2">Profilname:</label>
                                                <input type="text" id="profileNameInput2" placeholder="z.B. Schule, Arbeit" maxlength="50">
                                            </div>
                                            <div class="form-group">
                                                <label for="profileTypeInput2">Typ:</label>
                                                <input type="text" id="profileTypeInput2" placeholder="z.B. Schule, Universität" maxlength="30">
                                            </div>
                                            <div class="form-actions">
                                                <button class="btn btn-primary" onclick="createProfileFromForm(2)">Erstellen</button>
                                                <button class="btn btn-secondary" onclick="cancelProfileCreation(2)">Abbrechen</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="profile-switch-list" id="profileSwitchList">
                                        <!-- Profiles will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="plan-week-nav-container">
                            <button class="btn mini current-week-btn" id="goToCurrentPlanWeek"
                                title="Zur aktuellen Woche">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                                    <polyline points="9,22 9,12 15,12 15,22" />
                                </svg>
                            </button>
                            <div class="plan-week-nav-content">
                                <button class="btn mini" id="planWeekBack" title="Vorherige Woche">◀</button>
                                <span id="planWeekDisplay" title="Klicken zum Kopieren, Doppelklick zum Bearbeiten">KW XX</span>
                                <button class="btn mini" id="planWeekForward" title="Nächste Woche">▶</button>
                            </div>
                        </div>
                        <button class="btn secondary structure-btn" onclick="toggleTimetableStructurePanel()"
                            title="Timetable Structure">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3h18v18H3zM9 9h6v6H9z" />
                            </svg>
                        </button>
                    </div>

                    <div class="plan-main">
                        <div class="card grid-wrap" style="margin-top: 20px;">
                            <div id="grid" class="grid"></div>
                        </div>
                    </div>

                    <!-- Plan creation settings -->
                    <div class="plan-settings">
                        <div class="plan-settings-header" onclick="togglePlanSettings()">
                            <div class="header-content">
                                <h3 data-i18n="planSettings">Plan Settings</h3>
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text" data-i18n="planSettingsTooltip">Detailed settings for
                                        plan creation. All values are automatically saved.</span>
                                </div>
                            </div>
                            <div class="header-actions">
                                <svg class="settings-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polyline points="6,9 12,15 18,9" />
                                </svg>
                            </div>
                        </div>

                        <div class="plan-settings-content">
                            <!-- Quick Actions -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <h4>
                                        <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                            stroke-width="2">
                                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" />
                                        </svg>
                                        Schnellzugriff
                                    </h4>
                                    <span class="section-badge">3</span>
                                </div>
                                <div class="quick-actions">
                                    <div class="quick-action-card">
                                        <div class="action-icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
                                                <path
                                                    d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />
                                            </svg>
                                        </div>
                                        <div class="action-content">
                                            <h5>Fächer verwalten</h5>
                                            <p>Fächer hinzufügen und bearbeiten</p>
                                        </div>
                                        <button class="btn mini primary"
                                            onclick="focusInput('subjectsInput')">Bearbeiten</button>
                                    </div>
                                    <div class="quick-action-card">
                                        <div class="action-icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                                <circle cx="12" cy="7" r="4" />
                                            </svg>
                                        </div>
                                        <div class="action-content">
                                            <h5 data-i18n="manageTeachers">Manage Teachers</h5>
                                            <p data-i18n="addEditTeachers">Add and edit teachers</p>
                                        </div>
                                        <button class="btn mini primary" onclick="focusInput('teachersInput')"
                                            data-i18n="editLabel">Edit</button>
                                    </div>
                                    <div class="quick-action-card">
                                        <div class="action-icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                                                <polyline points="9,22 9,12 15,12 15,22" />
                                            </svg>
                                        </div>
                                        <div class="action-content">
                                            <h5>Räume verwalten</h5>
                                            <p>Räume hinzufügen und bearbeiten</p>
                                        </div>
                                        <button class="btn mini primary"
                                            onclick="focusInput('roomsInput')">Bearbeiten</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Presets Section -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <h4>
                                        <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                            stroke-width="2">
                                            <path
                                                d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                                        </svg>
                                        Stunden-Presets
                                    </h4>
                                    <span class="section-badge" id="presetsCount">0</span>
                                </div>
                                <div class="presets-container">
                                    <div class="presets-header">
                                        <div class="presets-info">
                                            <p>Vordefinierte Stundenkonfigurationen für schnelle Erstellung</p>
                                        </div>
                                        <div class="preset-actions">
                                            <button class="btn mini secondary" id="createPresetBtn"
                                                title="Preset erstellen">
                                                <span class="ico">✏</span>
                                                Erstellen
                                            </button>
                                            <button class="btn mini primary" id="addPresetBtn"
                                                title="Schnelles Preset hinzufügen">
                                                <span class="ico">+</span>
                                                Preset
                                            </button>
                                        </div>
                                    </div>
                                    <div class="presets-list" id="presetsList">
                                        <!-- Presets will be dynamically added here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Data Management -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <h4>
                                        <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                            stroke-width="2">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                            <polyline points="14,2 14,8 20,8" />
                                            <line x1="16" y1="13" x2="8" y2="13" />
                                            <line x1="16" y1="17" x2="8" y2="17" />
                                            <polyline points="10,9 9,9 8,9" />
                                        </svg>
                                        <span data-i18n="dataSettings">Database Settings</span>
                                    </h4>
                                    <span class="section-badge">4</span>
                                </div>
                                <div class="data-management-grid">
                                    <div class="data-card">
                                        <div class="data-card-header">
                                            <div class="data-icon">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                    stroke-width="2">
                                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
                                                    <path
                                                        d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />
                                                </svg>
                                            </div>
                                            <h5 data-i18n="subjects">Subjects</h5>
                                            <span class="data-count" id="subjectsCount">0</span>
                                        </div>
                                        <div class="data-input-container">
                                            <input type="text" id="subjectsInput"
                                                placeholder="Mathematik, Deutsch, Englisch..."
                                                class="plan-setting-input">
                                            <button class="btn mini" id="addSubjectBtn" title="Add subject"
                                                data-i18n="addSubjectTooltip">+</button>
                                        </div>
                                        <div class="data-list" id="subjectsList"></div>
                                    </div>

                                    <div class="data-card">
                                        <div class="data-card-header">
                                            <div class="data-icon">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                    stroke-width="2">
                                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                                    <circle cx="12" cy="7" r="4" />
                                                </svg>
                                            </div>
                                            <h5 data-i18n="teachers">Teachers</h5>
                                            <span class="data-count" id="teachersCount">0</span>
                                        </div>
                                        <div class="data-input-container">
                                            <input type="text" id="teachersInput"
                                                placeholder="Müller, Schmidt, Weber..." class="plan-setting-input">
                                            <button class="btn mini" id="addTeacherBtn" title="Add teacher"
                                                data-i18n="addTeacherTooltip">+</button>
                                        </div>
                                        <div class="data-list" id="teachersList"></div>
                                    </div>

                                    <div class="data-card">
                                        <div class="data-card-header">
                                            <div class="data-icon">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                    stroke-width="2">
                                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                                                    <polyline points="9,22 9,12 15,12 15,22" />
                                                </svg>
                                            </div>
                                            <h5 data-i18n="rooms">Rooms</h5>
                                            <span class="data-count" id="roomsCount">0</span>
                                        </div>
                                        <div class="data-input-container">
                                            <input type="text" id="roomsInput" placeholder="A101, B205, C301..."
                                                class="plan-setting-input">
                                            <button class="btn mini" id="addRoomBtn" title="Add room"
                                                data-i18n="addRoomTooltip">+</button>
                                        </div>
                                        <div class="data-list" id="roomsList"></div>
                                    </div>

                                    <div class="data-card">
                                        <div class="data-card-header">
                                            <div class="data-icon">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                    stroke-width="2">
                                                    <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z" />
                                                </svg>
                                            </div>
                                            <h5>Farben</h5>
                                            <span class="data-count" id="colorsCount">0</span>
                                        </div>
                                        <div class="data-input-container">
                                            <input type="color" id="customColor" value="#6366f1" class="color-input">
                                            <input type="text" id="colorNameInput" placeholder="Farbname"
                                                class="plan-setting-input">
                                            <button class="btn mini" id="addColorBtn"
                                                title="Farbe hinzufügen">+</button>
                                        </div>
                                        <div class="data-list" id="colorsList"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Preferences -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <h4>
                                        <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                            stroke-width="2">
                                            <circle cx="12" cy="12" r="3" />
                                            <path
                                                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                                        </svg>
                                        <span data-i18n="settingsSection">Settings</span>
                                    </h4>
                                    <span class="section-badge">6</span>
                                </div>
                                <div class="preferences-grid">
                                    <div class="preference-card">
                                        <div class="preference-header">
                                            <h5>Erstellungs-Modi</h5>
                                            <p>Verhalten beim Erstellen von Stunden</p>
                                        </div>
                                        <div class="preference-options">
                                            <div class="toggle-option">
                                                <label class="toggle-label">
                                                    <input type="checkbox" id="quickMode" class="toggle-input">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <div class="option-content">
                                                    <span class="option-title">Schnell-Modus</span>
                                                    <span class="option-description">Einfache Klicks erstellen
                                                        Stunden</span>
                                                </div>
                                            </div>
                                            <div class="toggle-option">
                                                <label class="toggle-label">
                                                    <input type="checkbox" id="autoSave" class="toggle-input" checked>
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <div class="option-content">
                                                    <span class="option-title">Auto-Speichern</span>
                                                    <span class="option-description">Änderungen automatisch
                                                        speichern</span>
                                                </div>
                                            </div>
                                            <div class="toggle-option">
                                                <label class="toggle-label">
                                                    <input type="checkbox" id="confirmActions" class="toggle-input">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <div class="option-content">
                                                    <span class="option-title">Bestätigung</span>
                                                    <span class="option-description">Bestätigung vor Löschen</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="preference-card">
                                        <div class="preference-header">
                                            <h5>Anzeige-Optionen</h5>
                                            <p>Darstellung und Benutzeroberfläche</p>
                                        </div>
                                        <div class="preference-options">
                                            <div class="select-option">
                                                <label class="option-title">Zeit-Format</label>
                                                <select id="timeFormat" class="plan-setting-select">
                                                    <option value="24" selected>24-Stunden (14:30)</option>
                                                    <option value="12">12-Stunden (2:30 PM)</option>
                                                </select>
                                            </div>
                                            <div class="select-option">
                                                <label class="option-title">Grid-Größe</label>
                                                <select id="gridSize" class="plan-setting-select">
                                                    <option value="small">Klein</option>
                                                    <option value="medium" selected>Mittel</option>
                                                    <option value="large">Groß</option>
                                                </select>
                                            </div>
                                            <div class="toggle-option">
                                                <label class="toggle-label">
                                                    <input type="checkbox" id="showTooltips" class="toggle-input"
                                                        checked>
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <div class="option-content">
                                                    <span class="option-title">Tooltips</span>
                                                    <span class="option-description">Hilfetexte anzeigen</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <!-- Timetable Structure Side Panel -->
        <div class="timetable-structure-panel" id="timetableStructurePanel">
            <div class="panel-header">
                <h3>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 3h18v18H3zM9 9h6v6H9z" />
                    </svg>
                    <span data-i18n="timetableStructure">Timetable Structure</span>
                </h3>
                <button class="close-btn" onclick="toggleTimetableStructurePanel()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="week-banner">
                <div class="week-banner-content">
                    <div class="week-nav-container">
                        <button class="week-nav-btn" id="timetableWeekBack" title="Previous Week">◀</button>
                        <div class="week-info">
                            <div class="week-number" id="currentWeekBadge">Week 42</div>
                            <div class="week-purpose">Configure timetable structure for this week</div>
                            <div class="global-settings-toggle">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="applyToAllWeeks" />
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="toggle-label" id="toggleLabel">Apply to all weeks</span>
                            </div>
                        </div>
                        <button class="week-nav-btn" id="timetableWeekForward" title="Next Week">▶</button>
                    </div>
                </div>
            </div>
            <div class="panel-content">
                <div class="form-group">
                    <label data-i18n="weekdays">Weekdays</label>
                    <div class="weekday-selector">
                        <label class="weekday-checkbox">
                            <input type="checkbox" id="plan-day-mo" checked>
                            <span>Mo</span>
                        </label>
                        <label class="weekday-checkbox">
                            <input type="checkbox" id="plan-day-di" checked>
                            <span>Di</span>
                        </label>
                        <label class="weekday-checkbox">
                            <input type="checkbox" id="plan-day-mi" checked>
                            <span>Mi</span>
                        </label>
                        <label class="weekday-checkbox">
                            <input type="checkbox" id="plan-day-do" checked>
                            <span>Do</span>
                        </label>
                        <label class="weekday-checkbox">
                            <input type="checkbox" id="plan-day-fr" checked>
                            <span>Fr</span>
                        </label>
                        <label class="weekday-checkbox">
                            <input type="checkbox" id="plan-day-sa">
                            <span>Sa</span>
                        </label>
                        <label class="weekday-checkbox">
                            <input type="checkbox" id="plan-day-so">
                            <span>So</span>
                        </label>
                    </div>
                    <small data-i18n="selectWeekdays">Select weekdays for this week</small>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="plan-periodMinSlider" data-i18n="periodDuration">Period Duration (minutes)</label>
                        <div class="slider-container">
                            <input id="plan-periodMinSlider" type="range" min="5" max="480" step="5" value="45" />
                            <div class="slider-value" id="plan-periodMinValue">45</div>
                        </div>
                        <small data-i18n="minutes">minutes</small>
                    </div>
                    <div class="form-group">
                        <label for="plan-periodCountSlider" data-i18n="periodsPerDay">Periods per Day</label>
                        <div class="slider-container">
                            <input id="plan-periodCountSlider" type="range" min="1" max="200" step="1" value="8" />
                            <div class="slider-value" id="plan-periodCountValue">8</div>
                        </div>
                        <small data-i18n="perDay">per day</small>
                    </div>
                </div>
                <div class="form-group">
                    <label for="plan-breakMinSlider" data-i18n="breakDuration">Break Duration (minutes)</label>
                    <div class="slider-container">
                        <input id="plan-breakMinSlider" type="range" min="0" max="60" step="5" value="0" />
                        <div class="slider-value" id="plan-breakMinValue">0</div>
                    </div>
                    <small data-i18n="breakMinutes">minutes between periods</small>
                </div>

                <div class="form-group">
                    <label for="plan-startTimeSlider" data-i18n="dayStartTime">Day Start Time</label>
                    <div class="slider-container">
                        <input id="plan-startTimeSlider" type="range" min="0" max="95" step="1" value="32" />
                        <div class="slider-value" id="plan-startTimeValue">08:00</div>
                    </div>
                    <small data-i18n="dayStartTimeDescription">time when the first period begins</small>
                    <div class="week-start-time-info" id="weekStartTimeInfo"
                        style="margin-top: 8px; padding: 8px; background: #f8fafc; border-radius: 6px; font-size: 12px; color: #64748b;">
                        <span data-i18n="weekStartTimeInfo">This setting applies to the current week only</span>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- ANALYSIS Seite -->
        <div class="container" id="pageAnalysis" hidden>
            <div class="analysis-page">
                <!-- Header -->
                <div class="analysis-header">
                    <h2 data-i18n="analysis">Analysis
                        <div class="info-tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltip-text" data-i18n="analysisTooltip">Detailed statistics and evaluations
                                of your timetable. All data is based on the currently displayed week.</span>
                        </div>
                    </h2>
                    <p data-i18n="analysisSubtitle">Statistics and evaluations of your timetable</p>
                </div>

                <!-- Analysis Content -->
                <div class="analysis-content">
                    <!-- Stats Row -->
                    <div class="stats-row">
                        <div class="stat-card">
                            <div class="stat-number" id="analysisTotalHours">–</div>
                            <div class="stat-label">Stunden diese Woche
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Gesamtanzahl der geplanten Stunden in der aktuellen
                                        Woche.</span>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="analysisFreeBlocks">–</div>
                            <div class="stat-label">Freie Blöcke
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Verfügbare Zeitblöcke ohne geplante Stunden.</span>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="analysisUtilization">–</div>
                            <div class="stat-label">Auslastung
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Prozentsatz der belegten Zeitblöcke in der Woche.</span>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="analysisAverage">–</div>
                            <div class="stat-label">Ø Stunden/Tag
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Durchschnittliche Anzahl der Stunden pro Tag.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="charts-row">
                        <div class="chart-container">
                            <h3>Fächer-Verteilung
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Zeigt, wie viele Stunden pro Fach geplant sind.</span>
                                </div>
                            </h3>
                            <div id="barSubjects" class="chart"></div>
                        </div>
                        <div class="chart-container">
                            <h3 data-i18n="teacherDistribution" data-i18n-tooltip="teacherDistributionTooltip">Teacher
                                Distribution
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Shows how many hours are planned per teacher.</span>
                                </div>
                            </h3>
                            <div id="barTeachers" class="chart"></div>
                        </div>
                    </div>

                    <div class="charts-row">
                        <div class="chart-container">
                            <h3 data-i18n="roomUsage" data-i18n-tooltip="roomUsageTooltip">Room Usage
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Shows how often each room is used.</span>
                                </div>
                            </h3>
                            <div id="barRooms" class="chart"></div>
                        </div>
                        <div class="chart-container">
                            <h3 data-i18n="timeDistribution" data-i18n-tooltip="timeDistributionTooltip">Time
                                Distribution
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Shows time distribution throughout the week.</span>
                                </div>
                            </h3>
                            <div id="barTimeSlots" class="chart"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- End main-content-with-profile -->
        </div>

        <!-- FOLDER Seite -->
        <div class="container" id="pageFolders" hidden>
            <!-- Main Content Area -->
            <div class="main-content-with-profile">
                <!-- Modern Folders Section -->
                <div class="folders-section">
                    <!-- Header with actions -->
                    <div class="folders-header">
                        <div class="folders-title">
                            <h2>Ordner</h2>
                            <span class="folders-count" id="foldersCount">0 Ordner</span>
                        </div>
                        <div class="folders-actions">
                            <button class="btn-icon" id="foldersSearchBtn" title="Suchen">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="m21 21-4.35-4.35"></path>
                                </svg>
                            </button>
                            <button class="btn-icon" id="foldersSortBtn" title="Sortieren">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18M7 12h10M10 18h4"></path>
                                </svg>
                            </button>
                            <button class="btn-icon" id="foldersViewBtn" title="Ansicht ändern">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7"></rect>
                                    <rect x="14" y="3" width="7" height="7"></rect>
                                    <rect x="14" y="14" width="7" height="7"></rect>
                                    <rect x="3" y="14" width="7" height="7"></rect>
                                </svg>
                            </button>
                            <button class="btn-primary" id="newFolderBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 5v14M5 12h14"></path>
                                </svg>
                                Neuer Ordner
                            </button>
                        </div>
                    </div>

                    <!-- Search bar (hidden by default) -->
                    <div class="folders-search" id="foldersSearch" hidden>
                        <div class="search-input-wrapper">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                            <input type="text" id="foldersSearchInput" placeholder="Ordner durchsuchen..." />
                            <button class="btn-icon" id="foldersSearchClose">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Sort options (hidden by default) -->
                    <div class="folders-sort" id="foldersSort" hidden>
                        <div class="sort-options">
                            <button class="sort-option active" data-sort="name">Name</button>
                            <button class="sort-option" data-sort="date">Erstellt</button>
                            <button class="sort-option" data-sort="items">Dateien</button>
                            <button class="sort-option" data-sort="color">Farbe</button>
                        </div>
                    </div>

                    <!-- Upload area -->
                    <div class="folders-upload" id="foldersUpload">
                        <div class="upload-content">
                            <div class="upload-icon">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"></path>
                                </svg>
                            </div>
                            <div class="upload-text">
                                <strong>Dateien hierher ziehen</strong> oder <button class="upload-link" id="fileInputBtn">durchsuchen</button>
                            </div>
                            <div class="upload-formats">
                                TXT, MD, JSON, CODE, DOCX, PPTX, XLSX
                                <small>(PDF wird als Platzhalter gespeichert)</small>
                            </div>
                        </div>
                        <input type="file" id="fileInput" multiple accept=".txt,.md,.json,.code,.docx,.pptx,.xlsx,.pdf" hidden>
                    </div>

                    <!-- Folders grid -->
                    <div class="folders-content">
                        <div id="foldersEmpty" class="folders-empty" hidden>
                            <div class="empty-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                </svg>
                            </div>
                            <div class="empty-text">Noch keine Ordner vorhanden</div>
                            <div class="empty-subtext">Erstelle deinen ersten Ordner oder lade Dateien hoch</div>
                            <button class="btn-primary" onclick="openFolderEdit(null)">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 5v14M5 12h14"></path>
                                </svg>
                                Ersten Ordner erstellen
                            </button>
                        </div>
                        <div class="folders-grid" id="foldersGrid"></div>
                    </div>
                </div>
            </div> <!-- End main-content-with-profile -->
        </div>

        <!-- PROFILE Seite -->
        <div class="container" id="pageProfile" hidden>

            <!-- Main Content Area -->
            <div class="main-content-with-profile">
                <div class="analysis-page">
                    <!-- Header -->
                    <div class="analysis-header">
                        <h2 data-i18n="profileTitle">Profile
                            <div class="info-tooltip">
                                <span class="info-icon">i</span>
                                <span class="tooltip-text" data-i18n="profileTooltip">Manage your personal profile and
                                    account settings.</span>
                            </div>
                        </h2>
                        <p data-i18n="profileSubtitle">Personalize your experience</p>
                    </div>

                    <!-- Ultimate Profile Content -->
                    <div class="ultimate-profile">
                        <!-- Quick Access Header -->
                        <div class="profile-quick-header">
                            <div class="profile-identity">
                                <div class="profile-avatar-large">
                                    <div class="avatar-placeholder">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                            <circle cx="12" cy="7" r="4"></circle>
                                        </svg>
                                    </div>
                                    <button class="avatar-edit-btn" onclick="editAvatar()" title="Change avatar">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                    </button>
                                </div>
                                <div class="profile-identity-info">
                                    <h2 id="profileDisplayName" data-i18n="profileWelcome">Welcome to stunova</h2>
                                    <p id="profileDisplayRole" data-i18n="profileRole">Student • Timetable Manager</p>
                                    <div class="profile-status">
                                        <span class="status-indicator active"></span>
                                        <span data-i18n="profileStatusActive">Active</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="profile-quick-actions">
                                <button class="quick-action-btn" onclick="quickAddLesson()" title="Add Lesson">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                    <span data-i18n="quickAddLesson">Add Lesson</span>
                                </button>
                                <button class="quick-action-btn" onclick="quickExport()" title="Export Data">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7,10 12,15 17,10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                    <span data-i18n="quickExport">Export</span>
                                </button>
                                <button class="quick-action-btn" onclick="quickSettings()" title="Quick Settings">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="3"></circle>
                                        <path
                                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 8 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 3.33 15 1.65 1.65 0 0 0 1.82 14H1a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 3 8.6a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 8 4.6a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09c0 .66.39 1.26 1 1.51a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06c-.45.45-.58 1.12-.33 1.82.25.7.92 1.17 1.66 1.17H21a2 2 0 1 1 0 4h-.09c-.74 0-1.41.47-1.66 1.17z">
                                        </path>
                                    </svg>
                                    <span data-i18n="quickSettings">Settings</span>
                                </button>
                            </div>
                        </div>

                        <!-- Smart Dashboard -->
                        <div class="profile-dashboard">
                            <!-- Today's Overview -->
                            <div class="dashboard-card today-overview">
                                <div class="card-header">
                                    <h3 data-i18n="todayOverview">Today's Overview</h3>
                                    <span class="card-date" id="todayDate"></span>
                                </div>
                                <div class="today-stats">
                                    <div class="today-stat">
                                        <div class="stat-icon today">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"></circle>
                                                <polyline points="12,6 12,12 16,14"></polyline>
                                            </svg>
                                        </div>
                                        <div class="stat-info">
                                            <div class="stat-value" id="todayLessons">0</div>
                                            <div class="stat-label" data-i18n="todayLessons">Lessons Today</div>
                                        </div>
                                    </div>
                                    <div class="today-stat">
                                        <div class="stat-icon next">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                                            </svg>
                                        </div>
                                        <div class="stat-info">
                                            <div class="stat-value" id="nextLessonTime">--:--</div>
                                            <div class="stat-label" data-i18n="nextLesson">Next Lesson</div>
                                        </div>
                                    </div>
                                    <div class="today-stat">
                                        <div class="stat-icon progress">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                                            </svg>
                                        </div>
                                        <div class="stat-info">
                                            <div class="stat-value" id="todayProgress">0%</div>
                                            <div class="stat-label" data-i18n="todayProgress">Progress</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Smart Insights -->
                            <div class="dashboard-card smart-insights">
                                <div class="card-header">
                                    <h3 data-i18n="smartInsights">Smart Insights</h3>
                                    <button class="insight-refresh" onclick="refreshInsights()"
                                        title="Refresh insights">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="23,4 23,10 17,10"></polyline>
                                            <polyline points="1,20 1,14 7,14"></polyline>
                                            <path
                                                d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15">
                                            </path>
                                        </svg>
                                    </button>
                                </div>
                                <div class="insights-list" id="insightsList">
                                    <div class="insight-item">
                                        <div class="insight-icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path
                                                    d="M9 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2h-4">
                                                </path>
                                                <rect x="9" y="7" width="6" height="4" rx="1"></rect>
                                            </svg>
                                        </div>
                                        <div class="insight-content">
                                            <div class="insight-title" data-i18n="insightWelcome">Welcome to stunova!
                                            </div>
                                            <div class="insight-description" data-i18n="insightWelcomeDesc">Start by
                                                adding your first lesson to see personalized insights.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Stats -->
                            <div class="dashboard-card quick-stats">
                                <div class="card-header">
                                    <h3 data-i18n="quickStats">Quick Stats</h3>
                                    <button class="stats-toggle" onclick="toggleStatsView()" title="Toggle view">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="3" width="7" height="7"></rect>
                                            <rect x="14" y="3" width="7" height="7"></rect>
                                            <rect x="14" y="14" width="7" height="7"></rect>
                                            <rect x="3" y="14" width="7" height="7"></rect>
                                        </svg>
                                    </button>
                                </div>
                                <div class="stats-grid">
                                    <div class="stat-card">
                                        <div class="stat-number" id="profileTotalLessons">0</div>
                                        <div class="stat-title" data-i18n="totalLessons">Total Lessons</div>
                                        <div class="stat-trend" id="lessonsTrend">
                                            <span class="trend-icon">→</span>
                                            <span data-i18n="thisWeek">This week</span>
                                        </div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number" id="profileTotalHours">0</div>
                                        <div class="stat-title" data-i18n="totalHours">Total Hours</div>
                                        <div class="stat-trend" id="hoursTrend">
                                            <span class="trend-icon">→</span>
                                            <span data-i18n="thisWeek">This week</span>
                                        </div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number" id="profileActiveDays">0</div>
                                        <div class="stat-title" data-i18n="activeDays">Active Days</div>
                                        <div class="stat-trend" id="daysTrend">
                                            <span class="trend-icon">→</span>
                                            <span data-i18n="thisWeek">This week</span>
                                        </div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-number" id="profileEfficiency">0%</div>
                                        <div class="stat-title" data-i18n="efficiency">Efficiency</div>
                                        <div class="stat-trend" id="efficiencyTrend">
                                            <span class="trend-icon">→</span>
                                            <span data-i18n="thisWeek">This week</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Compact Profile Form -->
                        <div class="profile-form-compact">
                            <div class="form-section">
                                <h4 data-i18n="basicInfo">Basic Information</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label data-i18n="profileName">Name</label>
                                        <input type="text" id="profileName" class="form-control"
                                            placeholder="Your name">
                                    </div>
                                    <div class="form-group">
                                        <label data-i18n="profileSchool">School</label>
                                        <input type="text" id="profileSchool" class="form-control"
                                            placeholder="Your school">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label data-i18n="profileGrade">Grade</label>
                                        <select id="profileGrade" class="form-control">
                                            <option value="">Select grade</option>
                                            <option value="1">Grade 1</option>
                                            <option value="2">Grade 2</option>
                                            <option value="3">Grade 3</option>
                                            <option value="4">Grade 4</option>
                                            <option value="5">Grade 5</option>
                                            <option value="6">Grade 6</option>
                                            <option value="7">Grade 7</option>
                                            <option value="8">Grade 8</option>
                                            <option value="9">Grade 9</option>
                                            <option value="10">Grade 10</option>
                                            <option value="11">Grade 11</option>
                                            <option value="12">Grade 12</option>
                                            <option value="university">University</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label data-i18n="profileTheme">Theme</label>
                                        <select id="profileTheme" class="form-control">
                                            <option value="light">Light</option>
                                            <option value="dark">Dark</option>
                                            <option value="auto">Auto</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-actions-compact">
                                    <button class="btn primary" onclick="saveProfile()"
                                        data-i18n="saveProfile">Save</button>
                                    <button class="btn secondary" onclick="resetProfile()"
                                        data-i18n="resetProfile">Reset</button>
                                </div>
                            </div>
                        </div>

                        <!-- Analysis Section -->
                        <div class="profile-card">
                            <div class="profile-settings-header" onclick="toggleProfileSection('analysis')">
                                <div class="header-content">
                                    <div class="profile-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M3 3v18h18"></path>
                                            <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"></path>
                                        </svg>
                                    </div>
                                    <div class="profile-info">
                                        <h3 data-i18n="analysis">Analysis</h3>
                                        <p data-i18n="analysisSubtitle">Statistics and evaluations of your timetable</p>
                                    </div>
                                </div>
                                <div class="header-actions">
                                    <svg class="settings-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <polyline points="6,9 12,15 18,9" />
                                    </svg>
                                </div>
                            </div>

                            <div class="profile-settings-content" id="profileAnalysisContent">
                                <!-- Analysis Content -->
                                <div class="analysis-content">
                                    <!-- Stats Row -->
                                    <div class="stats-row">
                                        <div class="stat-card">
                                            <div class="stat-number" id="analysisTotalHours">–</div>
                                            <div class="stat-label">Stunden diese Woche
                                                <div class="info-tooltip">
                                                    <span class="info-icon">i</span>
                                                    <span class="tooltip-text">Gesamtanzahl der geplanten Stunden in der
                                                        aktuellen Woche.</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-number" id="analysisFreeBlocks">–</div>
                                            <div class="stat-label">Freie Blöcke
                                                <div class="info-tooltip">
                                                    <span class="info-icon">i</span>
                                                    <span class="tooltip-text">Verfügbare Zeitblöcke ohne geplante
                                                        Stunden.</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-number" id="analysisUtilization">–</div>
                                            <div class="stat-label">Auslastung
                                                <div class="info-tooltip">
                                                    <span class="info-icon">i</span>
                                                    <span class="tooltip-text">Prozentsatz der belegten Zeitblöcke in
                                                        der Woche.</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="stat-card">
                                            <div class="stat-number" id="analysisAverage">–</div>
                                            <div class="stat-label">Ø Stunden/Tag
                                                <div class="info-tooltip">
                                                    <span class="info-icon">i</span>
                                                    <span class="tooltip-text">Durchschnittliche Anzahl der Stunden pro
                                                        Tag.</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Settings Section -->
                        <div class="profile-card">
                            <div class="profile-settings-header" onclick="toggleProfileSection('settings')">
                                <div class="header-content">
                                    <div class="profile-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="3"></circle>
                                            <path
                                                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 8 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 3.33 15 1.65 1.65 0 0 0 1.82 14H1a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 3 8.6a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 8 4.6a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09c0 .66.39 1.26 1 1.51a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06c-.45.45-.58 1.12-.33 1.82.25.7.92 1.17 1.66 1.17H21a2 2 0 1 1 0 4h-.09c-.74 0-1.41.47-1.66 1.17z">
                                            </path>
                                        </svg>
                                    </div>
                                    <div class="profile-info">
                                        <h3 data-i18n="settingsTitle">Settings</h3>
                                        <p data-i18n="settingsSubtitle">Customize the app to your needs</p>
                                    </div>
                                </div>
                                <div class="header-actions">
                                    <svg class="settings-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <polyline points="6,9 12,15 18,9" />
                                    </svg>
                                </div>
                            </div>

                            <div class="profile-settings-content" id="profileSettingsContent">
                                <!-- App Information -->
                                <div class="settings-info-section">
                                    <div class="settings-info">
                                        <div class="info-item">
                                            <span class="info-label" data-i18n="version">Version:</span>
                                            <span class="info-value">1.0.0</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label" data-i18n="localStorage">Local Storage:</span>
                                            <span class="info-value">✓ <span data-i18n="active">Active</span></span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label" data-i18n="database">Database:</span>
                                            <span class="info-value">localStorage</span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label" data-i18n="lastBackup">Last Backup:</span>
                                            <span class="info-value" id="lastBackupTime" data-i18n="never">Never</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Settings Content -->
                                <div class="analysis-content">
                                    <div class="chart-container">
                                        <h3 data-i18n="behavior" data-i18n-tooltip="behaviorTooltip">Behavior
                                            <div class="info-tooltip">
                                                <span class="info-icon">i</span>
                                                <span class="tooltip-text">Configure app behavior.</span>
                                            </div>
                                        </h3>
                                        <div class="settings-toggles">
                                            <div class="toggle-group">
                                                <label class="toggle-label">
                                                    <span class="toggle-text" data-i18n="autoSave">Auto-Save
                                                        enabled</span>
                                                    <div class="info-tooltip">
                                                        <span class="info-icon">i</span>
                                                        <span class="tooltip-text" data-i18n="autoSaveTooltip">Changes
                                                            are automatically saved.</span>
                                                    </div>
                                                    <div class="toggle-switch">
                                                        <input type="checkbox" id="autoSaveToggle" checked>
                                                        <span class="toggle-slider"></span>
                                                    </div>
                                                </label>
                                            </div>
                                            <div class="toggle-group">
                                                <label class="toggle-label">
                                                    <span class="toggle-text" data-i18n="redline">Show red
                                                        timeline</span>
                                                    <div class="info-tooltip">
                                                        <span class="info-icon">i</span>
                                                        <span class="tooltip-text" data-i18n="redlineTooltip">Shows
                                                            current time as red line in timetable.</span>
                                                    </div>
                                                    <div class="toggle-switch">
                                                        <input type="checkbox" id="redlineToggle" checked>
                                                        <span class="toggle-slider"></span>
                                                    </div>
                                                </label>
                                            </div>
                                            <div class="toggle-group">
                                                <label class="toggle-label">
                                                    <span class="toggle-text" data-i18n="tooltips">Show tooltips</span>
                                                    <div class="info-tooltip">
                                                        <span class="info-icon">i</span>
                                                        <span class="tooltip-text" data-i18n="tooltipsTooltip">Shows
                                                            help texts on hover over elements.</span>
                                                    </div>
                                                    <div class="toggle-switch">
                                                        <input type="checkbox" id="tooltipsToggle" checked>
                                                        <span class="toggle-slider"></span>
                                                    </div>
                                                </label>
                                            </div>
                                            <div class="toggle-group">
                                                <label class="toggle-label">
                                                    <span class="toggle-text" data-i18n="dragDrop">Drag & Drop
                                                        enabled</span>
                                                    <div class="info-tooltip">
                                                        <span class="info-icon">i</span>
                                                        <span class="tooltip-text" data-i18n="dragDropTooltip">Allows
                                                            moving lessons via drag & drop.</span>
                                                    </div>
                                                    <div class="toggle-switch">
                                                        <input type="checkbox" id="dragDropToggle" checked>
                                                        <span class="toggle-slider"></span>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="chart-container">
                                        <h3 data-i18n="display">Display
                                            <div class="info-tooltip">
                                                <span class="info-icon">i</span>
                                                <span class="tooltip-text">Configure display settings.</span>
                                            </div>
                                        </h3>
                                        <div class="settings-toggles">
                                            <div class="toggle-group">
                                                <label class="toggle-label">
                                                    <span class="toggle-text" data-i18n="compactMode">Compact
                                                        mode</span>
                                                    <div class="info-tooltip">
                                                        <span class="info-icon">i</span>
                                                        <span class="tooltip-text">Reduces spacing for more
                                                            content.</span>
                                                    </div>
                                                    <div class="toggle-switch">
                                                        <input type="checkbox" id="compactModeToggle">
                                                        <span class="toggle-slider"></span>
                                                    </div>
                                                </label>
                                            </div>
                                            <div class="toggle-group">
                                                <label class="toggle-label">
                                                    <span class="toggle-text" data-i18n="showWeekends">Show
                                                        weekends</span>
                                                    <div class="info-tooltip">
                                                        <span class="info-icon">i</span>
                                                        <span class="tooltip-text">Include Saturday and Sunday in
                                                            timetable.</span>
                                                    </div>
                                                    <div class="toggle-switch">
                                                        <input type="checkbox" id="showWeekendsToggle">
                                                        <span class="toggle-slider"></span>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="chart-container">
                                        <h3 data-i18n="language">Language
                                            <div class="info-tooltip">
                                                <span class="info-icon">i</span>
                                                <span class="tooltip-text" data-i18n="languageTooltip">Choose your
                                                    preferred language.</span>
                                            </div>
                                        </h3>
                                        <div class="language-selector">
                                            <select id="languageSelect" class="form-control">
                                                <option value="en" data-i18n="english">English</option>
                                                <option value="de" data-i18n="german">German</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="chart-container">
                                        <h3 data-i18n="dataManagement">Data Management
                                            <div class="info-tooltip">
                                                <span class="info-icon">i</span>
                                                <span class="tooltip-text" data-i18n="dataManagementTooltip">Manage your
                                                    timetable data.</span>
                                            </div>
                                        </h3>
                                        <div class="data-management-grid">
                                            <button class="btn secondary" onclick="exportData()"
                                                data-i18n="exportData">Export Data</button>
                                            <button class="btn secondary" onclick="importData()"
                                                data-i18n="importData">Import Data</button>
                                            <button class="btn danger" onclick="resetAllData()"
                                                data-i18n="resetAllData">Reset All Data</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SETTINGS Seite -->
            <div class="container" id="pageSettings" hidden>
                <div class="analysis-page">
                    <!-- Header -->
                    <div class="analysis-header">
                        <h2>Settings
                            <div class="info-tooltip">
                                <span class="info-icon">i</span>
                                <span class="tooltip-text">Configure your timetable and app settings.</span>
                            </div>
                        </h2>
                        <p>Customize the app to your needs</p>
                    </div>

                    <!-- App Information -->
                    <div class="settings-info-section">
                        <div class="settings-info">
                            <div class="info-item">
                                <span class="info-label" data-i18n="version">Version:</span>
                                <span class="info-value">1.0.0</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label" data-i18n="localStorage">Local Storage:</span>
                                <span class="info-value">✓ <span data-i18n="active">Active</span></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label" data-i18n="database">Database:</span>
                                <span class="info-value">localStorage</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label" data-i18n="lastBackup">Last Backup:</span>
                                <span class="info-value" id="lastBackupTime" data-i18n="never">Never</span>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Content -->
                    <div class="analysis-content">
                        <div class="chart-container">
                            <h3 data-i18n="behavior" data-i18n-tooltip="behaviorTooltip">Behavior
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Configure app behavior.</span>
                                </div>
                            </h3>
                            <div class="settings-toggles">
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <span class="toggle-text" data-i18n="autoSave">Auto-Save enabled</span>
                                        <div class="info-tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text" data-i18n="autoSaveTooltip">Changes are
                                                automatically saved.</span>
                                        </div>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="autoSaveToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <span class="toggle-text" data-i18n="redline">Show red timeline</span>
                                        <div class="info-tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text" data-i18n="redlineTooltip">Shows current time as
                                                red line in timetable.</span>
                                        </div>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="redlineToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <span class="toggle-text" data-i18n="tooltips">Show tooltips</span>
                                        <div class="info-tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text" data-i18n="tooltipsTooltip">Shows help texts on
                                                hover over elements.</span>
                                        </div>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="tooltipsToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <span class="toggle-text" data-i18n="dragDrop">Drag & Drop enabled</span>
                                        <div class="info-tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text" data-i18n="dragDropTooltip">Allows moving lessons
                                                via drag & drop.</span>
                                        </div>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="dragDropToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Language Settings -->
                    <div class="charts-row">
                        <div class="chart-container">
                            <h3 data-i18n="language" data-i18n-tooltip="languageTooltip">Language
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Choose your preferred language.</span>
                                </div>
                            </h3>
                            <div class="settings-form">
                                <div class="form-group">
                                    <label data-i18n="language">Language</label>
                                    <select id="languageSelector" class="form-control">
                                        <option value="en" data-i18n="english">English</option>
                                        <option value="de" data-i18n="german">German</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Display & Performance -->
                    <div class="charts-row">
                        <div class="chart-container">
                            <h3 data-i18n="display" data-i18n-tooltip="displayTooltip">Display
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Configure app display.</span>
                                </div>
                            </h3>
                            <div class="settings-toggles">
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <span class="toggle-text" data-i18n="compactView">Compact view</span>
                                        <div class="info-tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text" data-i18n="compactViewTooltip">Reduces spacing
                                                for a more compact display.</span>
                                        </div>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="compactViewToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <span class="toggle-text" data-i18n="animations">Animations enabled</span>
                                        <div class="info-tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text" data-i18n="animationsTooltip">Enables transition
                                                animations and effects.</span>
                                        </div>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="animationsToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <span class="toggle-text" data-i18n="weekNav">Week navigation</span>
                                        <div class="info-tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text" data-i18n="weekNavTooltip">Shows week navigation
                                                controls.</span>
                                        </div>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="weekNavToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <h3>Performance & Backup
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Performance-Optimierungen und Datensicherung.</span>
                                </div>
                            </h3>
                            <div class="settings-toggles">
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <span class="toggle-text">Performance-Modus</span>
                                        <div class="info-tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text">Optimiert die App für bessere Performance.</span>
                                        </div>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="performanceModeToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <span class="toggle-text">Automatische Backups</span>
                                        <div class="info-tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text">Erstellt automatisch Backups der
                                                Stundenplandaten.</span>
                                        </div>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="autoBackupToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <span class="toggle-text">Debug-Modus</span>
                                        <div class="info-tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text">Zeigt zusätzliche Debug-Informationen in der
                                                Konsole.</span>
                                        </div>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="debugModeToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Data Management -->
                <div class="settings-data-section">
                    <h3 data-i18n="dataManagement">Data Management
                        <div class="info-tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltip-text" data-i18n="dataManagementTooltip">Manage your timetable
                                data.</span>
                        </div>
                    </h3>
                    <div class="settings-actions">
                        <button class="btn primary" id="exportDataBtn">
                            <span class="ico">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7,10 12,15 17,10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                            </span>
                            <span data-i18n="exportData">Export Data</span>
                        </button>
                        <button class="btn ghost" id="importDataBtn">
                            <span class="ico">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17,8 12,3 7,8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                            </span>
                            <span data-i18n="importData">Import Data</span>
                        </button>
                        <button class="btn secondary" id="resetSettingsBtn">
                            <span class="ico">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"></path>
                                </svg>
                            </span>
                            <span data-i18n="resetSettings">Reset Settings</span>
                        </button>
                        <button class="btn danger" id="resetDataBtn">
                            <span class="ico">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3,6 5,6 21,6"></polyline>
                                    <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                    </path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                            </span>
                            <span data-i18n="resetAllData">Reset All Data</span>
                        </button>
                    </div>
                </div>

                <!-- Auto-save notice -->
                <div class="settings-footer">
                    <div class="auto-save-notice">
                        <span class="save-icon">✓</span>
                        <span data-i18n="autoSaveNotice">Settings are automatically saved</span>
                    </div>
                </div>
            </div>
        </div> <!-- End main-content-with-profile -->
        </div>
    </main>

    <footer class="container">Made with ❤️ – lokal speicherbar, kein Server nötig.</footer>

    <!-- LESSON INFO + EDIT (bestehende Modale bleiben) -->
    <div class="modal" id="infoModal" aria-modal="true" aria-hidden="true">
        <div class="backdrop" data-close></div>
        <div class="dialog">
            <button class="close-x" data-close aria-label="Schließen">×</button>
            <h2 data-i18n="subjectInfo">Subject Info</h2>
            <div id="infoColor" style="height:6px;border-radius:6px;margin:-2px 0 12px"></div>
            <div class="field"><label data-i18n="subjectLabel">Subject</label>
                <div id="iSubject" class="meta" style="font-size:14px;color:#0f172a;font-weight:700"></div>
            </div>
            <div class="grid2">
                <div class="field"><label data-i18n="teacherLabel">Teacher</label>
                    <div id="iTeacher" class="meta"></div>
                </div>
                <div class="field"><label data-i18n="roomLabel">Room</label>
                    <div id="iRoom" class="meta"></div>
                </div>
            </div>
            <div class="grid2">
                <div class="field"><label data-i18n="day">Day</label>
                    <div id="iDay" class="meta"></div>
                </div>
                <div class="field"><label data-i18n="timeLabel">Time</label>
                    <div id="iTime" class="meta"></div>
                </div>
            </div>
            <div class="field"><label>Dauer</label>
                <div id="iDuration" class="meta"></div>
            </div>
            <div class="field" id="iImportanceField" style="display:none">
                <label>Status</label>
                <div class="meta" style="color:#f59e0b;font-weight:600">⚠️ Wichtige Stunde (Prüfung/Klausur)</div>
            </div>
            <div class="actions split" style="margin-top:18px">
                <button class="btn danger" id="infoDelete" data-i18n="deleteLabel">Delete</button>
                <div><button class="btn ghost" data-close data-i18n="closeLabel">Close</button><button
                        class="btn primary" id="infoEdit" data-i18n="editLabel">Edit</button></div>
            </div>
        </div>
    </div>

    <div class="modal" id="editModal" aria-modal="true" aria-hidden="true">
        <div class="backdrop" data-close></div>
        <div class="dialog structured-modal">
            <div class="modal-header-structured">
                <div class="header-content">
                    <h2 data-i18n="editSubject">Fach anlegen</h2>
                    <div class="time-slot" id="timePreview">08:00 - 08:45</div>
                </div>
            </div>
            
            <div class="modal-content-structured">
                <div class="form-section">
                    <div class="section-label">Grundinformationen</div>
                    <div class="form-field">
                        <input id="fSubject" placeholder="Fachname eingeben..." class="structured-input primary-input" />
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="section-label">Details</div>
                    <div class="details-grid">
                        <div class="detail-field">
                            <label class="field-label">Lehrer</label>
                            <select id="fTeacherSel" class="structured-select">
                                <option value="">Lehrer auswählen</option>
                            </select>
                        </div>
                        <div class="detail-field">
                            <label class="field-label">Raum</label>
                            <input id="fRoom" list="roomList" placeholder="Raumnummer" class="structured-input" />
                        </div>
                    </div>
                    <datalist id="roomList"></datalist>
                </div>
                
                <div class="form-section">
                    <div class="section-label">Einstellungen</div>
                    <div class="settings-row">
                        <div class="setting-item">
                            <div class="setting-label">Farbe</div>
                            <div class="color-preview">
                                <div id="fColorSwatch" class="color-preview-dot"></div>
                                <span class="color-text">Automatisch</span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">Priorität</div>
                            <label class="priority-toggle">
                                <input type="checkbox" id="fImportance" />
                                <span class="toggle-switch"></span>
                                <span class="toggle-text">Wichtig</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions-structured">
                <button class="btn danger" id="deleteLesson" data-i18n="deleteLabel">Löschen</button>
                <div class="action-buttons-structured">
                    <button class="btn secondary" data-close data-i18n="cancelLabel">Abbrechen</button>
                    <button class="btn primary" id="saveLesson" data-i18n="saveLabel">Anlegen</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FOLDER-Modal Trio (unverändert) -->
    <div class="modal" id="foldersManageModal" aria-hidden="true">
        <div class="backdrop" data-close></div>
        <div class="dialog" style="width:min(720px,100%)">
            <button class="close-x" data-close aria-label="Schließen">×</button>
            <h2>Ordner verwalten & sortieren</h2>
            <div class="small">Ziehe an den ⋮⋮ Griffen, um die Reihenfolge zu ändern. Klick auf einen Ordner zum
                Bearbeiten.</div>
            <div id="manageList" class="list" style="margin-top:8px"></div>
            <div class="actions"><button class="btn ghost" data-close>Fertig</button></div>
        </div>
    </div>
    <div class="modal" id="folderEditModal" aria-hidden="true">
        <div class="backdrop" data-close></div>
        <div class="dialog">
            <button class="close-x" data-close aria-label="Schließen">×</button>
            <h2 id="folderEditTitle">Ordner bearbeiten</h2>
            <div class="field"><label>Name</label><input id="folderNameInput" /></div>
            <div class="field"><label>Farbe</label><input id="folderColorInput" type="color" /></div>
            <div class="field">
                <label>Icon</label>
                <div class="icon-preview" id="folderIconPreview">📁</div>
                <div class="icon-selection" id="folderIconSelection">
                    <!-- Icons will be populated by JavaScript -->
                </div>
            </div>
            <div class="actions split"><button id="folderDeleteBtn" class="btn danger">Ordner löschen</button>
                <div><button class="btn ghost" data-close>Abbrechen</button><button id="folderSaveBtn"
                        class="btn primary">Speichern</button></div>
            </div>
        </div>
    </div>

    <div class="modal" id="folderDetailModal" aria-hidden="true">
        <div class="backdrop" data-close></div>
        <div class="dialog" style="width:min(820px,100%)">
            <button class="close-x" data-close aria-label="Schließen">×</button>
            <h2 id="folderDetailTitle">Ordner</h2>
            <div id="folderDetailGrid" class="file-grid"></div>
            <div class="actions"><button class="btn ghost" data-close>Schließen</button></div>
        </div>
    </div>

    <!-- Global context menu for folders -->
    <div id="folderContextMenu" class="context-menu" aria-hidden="true"></div>

    <script>
        // ULTRA-EARLY OVERVIEW FORCE - Run immediately only if needed
        (function() {
            function ultraEarlyForceOverview() {
                const visiblePages = document.querySelectorAll('.container:not([hidden])');
                const activePages = document.querySelectorAll('.container.active:not([hidden])');
                
                // Only force overview if no pages are visible or active
                if (visiblePages.length === 0 || activePages.length === 0) {
                    const overviewPage = document.getElementById('pageOverview');
                    if (overviewPage) {
                        console.log('ULTRA-EARLY: Forcing overview visibility (no other pages active)');
                        overviewPage.removeAttribute('hidden');
                        overviewPage.classList.add('active', 'force-visible');
                    }
                }
            }
            
            // Run immediately if DOM is ready
            if (document.readyState !== 'loading') {
                ultraEarlyForceOverview();
            } else {
                document.addEventListener('DOMContentLoaded', ultraEarlyForceOverview);
            }
            
            // Also run after a very short delay
            setTimeout(ultraEarlyForceOverview, 1);
        })();
        
        /* =================== TYPES / STATE =================== */
        /** @typedef {{id:string,subject:string,teacher?:string,room?:string,color?:string,day:number,startIndex:number,span:number,importance?:boolean}} Lesson */
        const defaultDays = ["Mo", "Di", "Mi", "Do", "Fr"];
        const dayStart = { h: 8, m: 0 };
        const periodMinutesDefault = 45, breakMinutesDefault = 0;
        const colors = ["#60a5fa", "#f472b6", "#34d399", "#f59e0b", "#a78bfa", "#fb7185", "#22d3ee", "#fca5a5"];
        const LS_PLAN = "custom_timetable_state_v1_vanilla";
        const LS_FOLDERS = "custom_timetable_folders_v1";
        const LS_DATA = "custom_timetable_masterdata_v1";

        const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
        const pad = n => String(n).padStart(2, "0");
        const timeLabelFromMinutes = (base, plus) => { const total = base.h * 60 + base.m + plus; const h = Math.floor(total / 60); const m = total % 60; return `${pad(h)}:${pad(m)}` };
        const minutesSinceStart = (date = new Date()) => {
            const currentPlan = getOrCreateWeekPlan(currentPlanWeek);
            const d = new Date(date);
            const start = new Date(date);
            start.setHours(currentPlan.dayStart.h, currentPlan.dayStart.m, 0, 0);
            return (d - start) / 60000;
        };
        // Compute minutes since the start of day for a specific plan (used by heatmap/overview)
        const minutesSinceStartFor = (plan, date = new Date()) => {
            const d = new Date(date);
            const start = new Date(date);
            const ref = plan?.dayStart || { h: 8, m: 0 };
            start.setHours(ref.h, ref.m, 0, 0);
            return (d - start) / 60000;
        };
        const uid = () => {
            try {
                const g = (typeof crypto !== 'undefined' && crypto && typeof crypto.randomUUID === 'function')
                    ? crypto.randomUUID()
                    : null;
                if (g) return g;
            } catch { /* ignore */ }
            return Math.random().toString(36).slice(2) + Date.now().toString(36);
        };
        const byId = id => document.getElementById(id);

        const state = { days: [...defaultDays], periodMinutes: periodMinutesDefault, breakMinutes: breakMinutesDefault, periodCount: 8, lessons: [] };

        // Week navigation state
        let currentWeekOffset = 0; // 0 = current week, -1 = previous week, 1 = next week, etc. (for Overview heatmap)

        // Multi-week planning system
        const weekPlans = new Map(); // weekKey -> { lessons: [], days: [], periodMinutes, breakMinutes, periodCount }
        let currentPlanWeek = getCurrentWeekKey(); // Track which week plan we're viewing in Plan section

        // Separate week tracking for heatmap (independent from plan timetable)
        let currentHeatmapWeek = getCurrentWeekKey(); // Track which week the heatmap is showing

        // Global flag to prevent event conflicts during week input
        window.weekInputActive = false;
        window.weekInputType = null;


        // Overview-specific week tracking (independent from plan timetable and heatmap)
        let overviewWeekKey = getCurrentWeekKey(); // Track which week the overview is showing

        // Overview-specific state (independent from Plan section)
        let overviewState = {
            lessons: [],
            days: [...defaultDays],
            periodMinutes: periodMinutesDefault,
            breakMinutes: 0, // No breaks between lessons
            periodCount: 8
        };

        function syncOverviewState() {
            // Sync overview state with current settings (but not lessons)
            overviewState.days = [...state.days];
            overviewState.periodMinutes = state.periodMinutes;
            overviewState.breakMinutes = state.breakMinutes;
            overviewState.periodCount = state.periodCount;

            // Calculate overview week key based on offset
            overviewWeekKey = getWeekKeyFromOffset(currentWeekOffset);
        }
        // + subjectColors map and presets
        const dataState = {
            teachers/** @type {string[]}*/: [],
            rooms/** @type {string[]}*/: [],
            subjects/** @type {string[]}*/: [],
            classes/** @type {string[]}*/: [],
            subjectColors/** @type {Record<string,string>}*/: {},      // e.g. { Mathe: "#60a5fa" }
            presets/** @type {Array<{subject:string,teacher?:string,room?:string,color?:string}>}*/: []
        };

        const folderState = { folders/** @type {Array<{id:string,name:string,color:string,items:Array<{id:string,name:string,topic:string,grade:number,notes?:string,added:string,ext:string}>}>}*/: [] };
        const fColorSwatch = byId('fColorSwatch');
        let isCreating = false;
        let creatingDraft = null;
        /* =================== LOAD / SAVE =================== */
        function seedLessons() {
            return [
                { id: uid(), subject: "Mathe", teacher: "Müller", room: "A101", color: colors[0], day: 0, startIndex: 0, span: 2 },
                { id: uid(), subject: "Deutsch", teacher: "Schmidt", room: "B204", color: colors[1], day: 2, startIndex: 3, span: 1 },
                { id: uid(), subject: "Englisch", teacher: "Khan", room: "C3", color: colors[2], day: 4, startIndex: 5, span: 2 }
            ];
        }
        function colorForSubject(subj) {
            const s = (subj || '').trim();
            if (!s) return '#60a5fa';
            const p = findPresetForSubject(s);
            return (p && p.color) || (dataState.subjectColors && dataState.subjectColors[s]) || '#60a5fa';
        }
        function seedFolders() {
            return [
                { id: uid(), name: "Mathe", color: "#60a5fa", icon: "math", items: [] },
                { id: uid(), name: "Deutsch", color: "#f472b6", icon: "language", items: [] },
                { id: uid(), name: "Informatik", color: "#34d399", icon: "work", items: [] },
                { id: uid(), name: "Allgemein", color: "#a78bfa", icon: "folder", items: [] }
            ];
        }
        function seedData() {
            const d = {
                teachers: ["Müller", "Schmidt", "Khan"],
                rooms: ["A101", "B204", "C3"],
                subjects: ["Mathe", "Deutsch", "Englisch", "Informatik"],
                classes: ["8A", "8B"],
                subjectColors: { Mathe: "#60a5fa", Deutsch: "#f472b6", Englisch: "#34d399", Informatik: "#a78bfa" },
                presets: [
                    { subject: "Mathe", teacher: "Müller", room: "A101", color: "#60a5fa" },
                    { subject: "Deutsch", teacher: "Schmidt", room: "B204", color: "#f472b6" },
                    { subject: "Englisch", teacher: "Khan", room: "C3", color: "#34d399" }
                ]
            };
            return d;
        }

        function loadAll() {
            try {
                const r = localStorage.getItem(LS_PLAN);
                if (r) {
                    const o = JSON.parse(r);
                    state.days = Array.isArray(o.days) && o.days.length ? o.days : defaultDays;
                    state.periodMinutes = Number(o.periodMinutes) || periodMinutesDefault;
                    state.breakMinutes = 0; // No breaks between lessons
                    state.periodCount = Number(o.periodCount) || 8;
                    state.lessons = Array.isArray(o.lessons) && o.lessons.length ? o.lessons : seedLessons();
                } else {
                    state.lessons = seedLessons();
                }
            } catch (e) {
                console.warn('Error loading saved data, using defaults:', e);
                // Ensure we have valid default data
                state.days = [...defaultDays];
                state.periodMinutes = periodMinutesDefault;
                state.breakMinutes = 0;
                state.periodCount = 8;
                state.lessons = seedLessons();
            }

            // Load saved current plan week FIRST
            try {
                const savedWeek = localStorage.getItem('currentPlanWeek');
                if (savedWeek) {
                    const currentWeekKey = getCurrentWeekKey();
                    const cmp = weekKeyCompare(savedWeek, currentWeekKey);

                    // If saved week is in the future, reset to current week
                    if (cmp > 0) {
                        currentPlanWeek = currentWeekKey;
                        localStorage.setItem('currentPlanWeek', currentWeekKey);
                    } else {
                        currentPlanWeek = normalizeWeekKey(savedWeek);
                    }
                }
            } catch { /* ignore */ }

            // Load saved week plans
            try {
                const savedWeekPlans = localStorage.getItem('weekPlans');
                if (savedWeekPlans) {
                    const parsedPlans = JSON.parse(savedWeekPlans);
                    weekPlans.clear();
                    for (const [key, value] of Object.entries(parsedPlans)) {
                        weekPlans.set(key, value);
                    }
                }
            } catch (e) {
                console.warn('Failed to load weekPlans:', e);
            }

            // Load saved overview week offset
            try {
                const savedOffset = localStorage.getItem('currentWeekOffset');
                if (savedOffset !== null) {
                    currentWeekOffset = parseInt(savedOffset) || 0;
                }
            } catch { /* ignore */ }

            // Load saved heatmap week
            try {
                const savedHeatmapWeek = localStorage.getItem('currentHeatmapWeek');
                const currentWeekKey = getCurrentWeekKey();
                if (savedHeatmapWeek) {
                    currentHeatmapWeek = normalizeWeekKey(savedHeatmapWeek);
                }
            } catch { /* ignore */ }

            // Load saved overview week
            try {
                const savedOverviewWeek = localStorage.getItem('overviewWeekKey');
                if (savedOverviewWeek) {
                    overviewWeekKey = normalizeWeekKey(savedOverviewWeek);
                }
            } catch { /* ignore */ }

            try { const d = localStorage.getItem(LS_DATA); Object.assign(dataState, d ? JSON.parse(d) : seedData()); }
            catch { Object.assign(dataState, seedData()); }

            try {
                const f = localStorage.getItem(LS_FOLDERS);
                folderState.folders = f ? JSON.parse(f) : seedFolders();
                console.log(`Loaded ${folderState.folders.length} folders from localStorage`);
            }
            catch (error) {
                console.error('Error loading folders:', error);
                folderState.folders = seedFolders();
            }
        }

        // Settings state management
        const settingsState = {
            autoSave: true,
            redline: true,
            tooltips: true,
            dragDrop: true,
            compactView: false,
            animations: true,
            weekNav: true,
            debugMode: false,
            autoBackup: true,
            performanceMode: false,
            language: 'en' // Default to English
        };

        // Internationalization system
        const translations = {
            en: {
                // Navigation
                'navPlan': 'Plan',
                'navOverview': 'Overview',
                'navAnalysis': 'Analysis',
                'navProfile': 'Profile',
                'navSettings': 'Settings',

                // Profile page
                'profileTitle': 'Profile',
                'profileSubtitle': 'Personalize your experience',
                'profileTooltip': 'Manage your personal profile and account settings.',
                'profileInfo': 'Profile Information',
                'profileInfoDescription': 'Manage your personal details and preferences',
                'profileName': 'Name',
                'profileEmail': 'Email',
                'profileSchool': 'School/Institution',
                'profileGrade': 'Grade/Year',
                'profilePreferences': 'Preferences',
                'profilePreferencesDescription': 'Customize your app experience',
                'profileTheme': 'Theme',
                'profileNotifications': 'Notifications',
                'profileNotificationsText': 'Enable notifications',
                'profileAutoSave': 'Auto-Save',
                'profileAutoSaveText': 'Automatically save changes',
                'profileStatistics': 'Statistics',
                'profileStatisticsDescription': 'Your usage statistics',
                'profileTotalLessons': 'Total Lessons',
                'profileTotalHours': 'Total Hours',
                'profileActiveDays': 'Active Days',
                'saveProfile': 'Save Profile',
                'resetProfile': 'Reset',
                'profileWelcome': 'Welcome to stunova',
                'profileRole': 'Student • Timetable Manager',
                'profileStatusActive': 'Active',
                'quickAddLesson': 'Add Lesson',
                'quickExport': 'Export',
                'quickSettings': 'Settings',
                'todayOverview': 'Today\'s Overview',
                'todayLessons': 'Lessons Today',
                'nextLesson': 'Next Lesson',
                'todayProgress': 'Progress',
                'smartInsights': 'Smart Insights',
                'insightWelcome': 'Welcome to stunova!',
                'insightWelcomeDesc': 'Start by adding your first lesson to see personalized insights.',
                'quickStats': 'Quick Stats',
                'totalLessons': 'Total Lessons',
                'totalHours': 'Total Hours',
                'activeDays': 'Active Days',
                'efficiency': 'Efficiency',
                'thisWeek': 'This week',
                'basicInfo': 'Basic Information',
                'profileSwitchTitle': 'Create New Profile',

                // Settings page
                'settingsTitle': 'Settings',
                'settingsSubtitle': 'Customize the app to your needs',
                'settingsTooltip': 'Configure your timetable and app settings.',

                // App info
                'version': 'Version',
                'localStorage': 'Local Storage',
                'active': 'Active',
                'database': 'Database',
                'lastBackup': 'Last Backup',
                'never': 'Never',

                // Language selector
                'language': 'Language',
                'languageTooltip': 'Choose your preferred language.',
                'english': 'English',
                'german': 'German',

                // Timetable structure
                'timetableStructure': 'Timetable Structure',
                'timetableStructureTooltip': 'Define the basic structure of your timetable.',
                'weekdays': 'Weekdays',
                'periodDuration': 'Period Duration (minutes)',
                'breakDuration': 'Break Duration (minutes)',
                'periodsPerDay': 'Periods per Day',
                'dayStartTime': 'Day Start Time',
                'dayStartTimeDescription': 'time when the first period begins (supports flexible work schedules)',
                'weekStartTimeInfo': 'This setting applies to the current week only',

                // Behavior settings
                'behavior': 'Behavior',
                'behaviorTooltip': 'Configure app behavior.',
                'autoSave': 'Auto-Save enabled',
                'autoSaveTooltip': 'Changes are automatically saved.',
                'redline': 'Show red timeline',
                'redlineTooltip': 'Shows current time as red line in timetable.',
                'tooltips': 'Show tooltips',
                'tooltipsTooltip': 'Shows help texts on hover over elements.',
                'dragDrop': 'Drag & Drop enabled',
                'dragDropTooltip': 'Allows moving lessons via drag & drop.',

                // Display settings
                'display': 'Display',
                'displayTooltip': 'Configure app display.',
                'compactView': 'Compact view',
                'compactViewTooltip': 'Reduces spacing for a more compact display.',
                'animations': 'Animations enabled',
                'animationsTooltip': 'Enables transition animations and effects.',
                'weekNav': 'Week navigation',
                'weekNavTooltip': 'Shows week navigation controls.',

                // Advanced settings
                'advanced': 'Advanced',
                'advancedTooltip': 'Advanced app settings.',
                'debugMode': 'Debug mode',
                'debugModeTooltip': 'Enables debug information and console logging.',
                'autoBackup': 'Auto-backup',
                'autoBackupTooltip': 'Automatically creates backups of your data.',
                'performanceMode': 'Performance mode',
                'performanceModeTooltip': 'Optimizes app for better performance.',

                // Actions
                'resetSettings': 'Reset Settings',
                'resetSettingsConfirm': 'Reset all settings? This cannot be undone.',
                'settingsReset': 'Settings have been reset.',
                'autoSaveNotice': 'Settings are automatically saved',

                // Next up section
                'nextUp': 'Next Up',
                'now': 'Now',
                'tomorrow': 'Tomorrow',
                'noLessonsPlanned': 'No lessons planned',
                'createClass': 'Create Class',

                // Structure panel
                'applyToAllWeeks': 'Apply to all weeks',
                'applyToCurrentWeekOnly': 'Apply to current week only',

                // Days
                'monday': 'Monday',
                'tuesday': 'Tuesday',
                'wednesday': 'Wednesday',
                'thursday': 'Thursday',
                'friday': 'Friday',
                'saturday': 'Saturday',
                'sunday': 'Sunday',

                // Lesson modal
                'createSubject': 'Create Subject',
                'editSubject': 'Edit Subject',
                'subject': 'Subject',
                'teacher': 'Teacher',
                'room': 'Room',
                'time': 'Time',
                'create': 'Create',
                'save': 'Save',
                'cancel': 'Cancel',
                'delete': 'Delete',
                'deleteConfirm': 'Really delete this lesson?',

                // Quick actions
                'quickActions': 'Quick Actions',
                'settings': 'Settings',

                // Plan settings
                'planSettings': 'Plan Settings',
                'planSettingsTooltip': 'Detailed settings for plan creation. All values are automatically saved.',
                'dataSettings': 'Database Settings',
                'settingsSection': 'Settings',

                // Overview
                'overview': 'Overview',
                'today': 'Today',
                'todayNothing': 'Today: nothing more pending',
                'allDone': 'All done',
                'minutesLeft': 'minutes left',

                // Analysis
                'analysis': 'Analysis',
                'weeklyStats': 'Weekly Statistics',
                'totalLessons': 'Total Lessons',
                'totalMinutes': 'Total Minutes',
                'totalHours': 'Total Hours',
                'activeSubjects': 'Active Subjects',
                'studyStreak': 'Study Streak',
                'days': 'days',

                // Common
                'min': 'Min',
                'h': 'h',
                'room': 'Room',
                'subject': 'Subject',
                'teacher': 'Teacher',
                'time': 'Time',
                'day': 'Day',
                'week': 'Week',
                'month': 'Month',
                'year': 'Year',

                // Form labels and placeholders
                'minutes': 'minutes',
                'perDay': 'per day',
                'minutesBetweenLessons': 'minutes between lessons',
                'selectWeekdays': 'Select weekdays for your timetable',
                'addTimeSlot': 'Add time slot',
                'newTimeSlot': 'New time slot',
                'manageTeachers': 'Manage Teachers',
                'addEditTeachers': 'Add and edit teachers',
                'edit': 'Edit',
                'close': 'Close',
                'delete': 'Delete',
                'addSubject': 'Add subject',
                'addTeacher': 'Add teacher',
                'addRoom': 'Add room',
                'teachers': 'Teachers',
                'rooms': 'Rooms',
                'subjects': 'Subjects',
                'subjectInfo': 'Subject Info',
                'editSubject': 'Edit Subject',
                'createSubject': 'Create Subject',
                'teacherLabel': 'Teacher',
                'roomLabel': 'Room',
                'subjectLabel': 'Subject',
                'timeLabel': 'Time',
                'autoSave': 'Auto-Save',
                'confirmation': 'Confirmation',
                'confirmationDescription': 'Confirmation before deleting',
                'timeFormat': 'Time Format',
                'timeFormat24': '24-hour (14:30)',
                'timeFormat12': '12-hour (2:30 PM)',
                'teacherDistribution': 'Teacher Distribution',
                'roomUsage': 'Room Usage',
                'timeDistribution': 'Time Distribution',
                'showsTeacherHours': 'Shows how many hours are planned per teacher',
                'showsRoomUsage': 'Shows how often each room is used',
                'showsTimeDistribution': 'Shows time distribution throughout the week',
                'availableTimeBlocks': 'Available time blocks without planned lessons',
                'percentageOccupied': 'Percentage of occupied time blocks in the week',
                'showsSubjectHours': 'Shows how many hours are planned per subject',
                'heatmapDescription': 'Shows your lesson distribution as heatmap. Red line = current time. Green areas = already past lessons',
                'availableBlocksToday': 'Available time blocks without planned lessons for today',
                'availableBlocks': 'Available time blocks without planned lessons',
                'quickActions': 'Quick Actions',
                'settings': 'Settings',
                'exportData': 'Export Data',
                'importData': 'Import Data',
                'resetAllData': 'Reset All Data',
                'resetAllDataConfirm': 'Really reset all data? This cannot be undone.',
                'dataReset': 'All data has been reset.',
                'closeLabel': 'Close',
                'editLabel': 'Edit',
                'deleteLabel': 'Delete',
                'saveLabel': 'Save',
                'cancelLabel': 'Cancel',
                'createLabel': 'Create',
                'addLabel': 'Add',
                'manageLabel': 'Manage',
                'subjectPlaceholder': 'Mathematics, German, English...',
                'teacherPlaceholder': 'Müller, Schmidt, Weber...',
                'roomPlaceholder': 'A101, B205, C301...',
                'minutesLabel': 'minutes',
                'betweenLessons': 'between lessons',
                'perDayLabel': 'per day',
                'weekdaySelection': 'Select weekdays for your timetable',
                'heatmapTooltip': 'Shows your lesson distribution as heatmap. Red line = current time. Green areas = already past lessons.',
                'availableBlocksTooltip': 'Available time blocks without planned lessons for today.',
                'percentageTooltip': 'Percentage of occupied time blocks in the week.',
                'subjectDistributionTooltip': 'Shows how many hours are planned per subject.',
                'teacherDistributionTooltip': 'Shows how many hours are planned per teacher.',
                'roomUsageTooltip': 'Shows how often each room is used.',
                'timeDistributionTooltip': 'Shows time distribution throughout the week.',
                'addTimeSlotTooltip': 'Add new time slot',
                'manageTeachersTooltip': 'Add and edit teachers',
                'addSubjectTooltip': 'Add subject',
                'addTeacherTooltip': 'Add teacher',
                'addRoomTooltip': 'Add room',
                'dataManagement': 'Data Management',
                'dataManagementTooltip': 'Manage your timetable data.',
                'analysisTooltip': 'Detailed statistics and evaluations of your timetable. All data is based on the currently displayed week.',
                'analysisSubtitle': 'Statistics and evaluations of your timetable'
            },
            de: {
                // Navigation
                'navPlan': 'Plan',
                'navOverview': 'Übersicht',
                'navAnalysis': 'Analyse',
                'navProfile': 'Profil',
                'navSettings': 'Einstellungen',

                // Profile page
                'profileTitle': 'Profil',
                'profileSubtitle': 'Personalisiere deine Erfahrung',
                'profileTooltip': 'Verwalte dein persönliches Profil und Kontoeinstellungen.',
                'profileInfo': 'Profilinformationen',
                'profileInfoDescription': 'Verwalte deine persönlichen Daten und Einstellungen',
                'profileName': 'Name',
                'profileEmail': 'E-Mail',
                'profileSchool': 'Schule/Institution',
                'profileGrade': 'Klasse/Jahrgang',
                'profilePreferences': 'Einstellungen',
                'profilePreferencesDescription': 'Passe deine App-Erfahrung an',
                'profileTheme': 'Design',
                'profileNotifications': 'Benachrichtigungen',
                'profileNotificationsText': 'Benachrichtigungen aktivieren',
                'profileAutoSave': 'Auto-Speichern',
                'profileAutoSaveText': 'Änderungen automatisch speichern',
                'profileStatistics': 'Statistiken',
                'profileStatisticsDescription': 'Deine Nutzungsstatistiken',
                'profileTotalLessons': 'Stunden gesamt',
                'profileTotalHours': 'Stunden gesamt',
                'profileActiveDays': 'Aktive Tage',
                'saveProfile': 'Profil speichern',
                'resetProfile': 'Zurücksetzen',
                'profileWelcome': 'Willkommen bei stunova',
                'profileRole': 'Schüler • Stundenplan-Manager',
                'profileStatusActive': 'Aktiv',
                'quickAddLesson': 'Stunde hinzufügen',
                'quickExport': 'Exportieren',
                'quickSettings': 'Einstellungen',
                'todayOverview': 'Heute im Überblick',
                'todayLessons': 'Stunden heute',
                'nextLesson': 'Nächste Stunde',
                'todayProgress': 'Fortschritt',
                'smartInsights': 'Intelligente Einblicke',
                'insightWelcome': 'Willkommen bei stunova!',
                'insightWelcomeDesc': 'Füge deine erste Stunde hinzu, um personalisierte Einblicke zu sehen.',
                'quickStats': 'Schnelle Statistiken',
                'totalLessons': 'Stunden gesamt',
                'totalHours': 'Stunden gesamt',
                'activeDays': 'Aktive Tage',
                'efficiency': 'Effizienz',
                'thisWeek': 'Diese Woche',
                'basicInfo': 'Grundinformationen',
                'profileSwitchTitle': 'Neues Profil erstellen',

                // Settings page
                'settingsTitle': 'Einstellungen',
                'settingsSubtitle': 'Passe die App an deine Bedürfnisse an',
                'settingsTooltip': 'Konfiguriere deinen Stundenplan und App-Einstellungen.',

                // App info
                'version': 'Version',
                'localStorage': 'Lokale Speicherung',
                'active': 'Aktiv',
                'database': 'Datenbank',
                'lastBackup': 'Letztes Backup',
                'never': 'Nie',

                // Language selector
                'language': 'Sprache',
                'languageTooltip': 'Wähle deine bevorzugte Sprache.',
                'english': 'Englisch',
                'german': 'Deutsch',

                // Timetable structure
                'timetableStructure': 'Stundenplan-Struktur',
                'timetableStructureTooltip': 'Definiere die Grundstruktur deines Stundenplans.',
                'weekdays': 'Wochentage',
                'periodDuration': 'Stundendauer (Minuten)',
                'breakDuration': 'Pausendauer (Minuten)',
                'periodsPerDay': 'Stunden pro Tag',
                'dayStartTime': 'Tagesbeginn',
                'dayStartTimeDescription': 'Zeit, zu der die erste Stunde beginnt (unterstützt Gleitzeit)',
                'weekStartTimeInfo': 'Diese Einstellung gilt nur für die aktuelle Woche',

                // Behavior settings
                'behavior': 'Verhalten',
                'behaviorTooltip': 'Konfiguriere das Verhalten der App.',
                'autoSave': 'Auto-Save aktiviert',
                'autoSaveTooltip': 'Änderungen werden automatisch gespeichert.',
                'redline': 'Rote Zeitlinie anzeigen',
                'redlineTooltip': 'Zeigt die aktuelle Uhrzeit als rote Linie im Stundenplan.',
                'tooltips': 'Tooltips anzeigen',
                'tooltipsTooltip': 'Zeigt Hilfetexte bei Hover über Elemente.',
                'dragDrop': 'Drag & Drop aktiviert',
                'dragDropTooltip': 'Erlaubt das Verschieben von Stunden per Drag & Drop.',

                // Display settings
                'display': 'Darstellung',
                'displayTooltip': 'Konfiguriere die Darstellung der App.',
                'compactView': 'Kompakte Ansicht',
                'compactViewTooltip': 'Reduziert Abstände für eine kompaktere Darstellung.',
                'animations': 'Animationen aktiviert',
                'animationsTooltip': 'Aktiviert Übergangsanimationen und Effekte.',
                'weekNav': 'Wochen-Navigation',
                'weekNavTooltip': 'Zeigt Wochen-Navigationssteuerungen.',

                // Advanced settings
                'advanced': 'Erweitert',
                'advancedTooltip': 'Erweiterte App-Einstellungen.',
                'debugMode': 'Debug-Modus',
                'debugModeTooltip': 'Aktiviert Debug-Informationen und Konsolenprotokollierung.',
                'autoBackup': 'Auto-Backup',
                'autoBackupTooltip': 'Erstellt automatisch Backups deiner Daten.',
                'performanceMode': 'Leistungsmodus',
                'performanceModeTooltip': 'Optimiert die App für bessere Leistung.',

                // Actions
                'resetSettings': 'Einstellungen zurücksetzen',
                'resetSettingsConfirm': 'Alle Einstellungen zurücksetzen? Dies kann nicht rückgängig gemacht werden.',
                'settingsReset': 'Einstellungen wurden zurückgesetzt.',
                'autoSaveNotice': 'Einstellungen werden automatisch gespeichert',

                // Next up section
                'nextUp': 'Als Nächstes',
                'now': 'Jetzt',
                'tomorrow': 'Morgen',
                'noLessonsPlanned': 'Keine Stunden geplant',
                'createClass': 'Stunde hinzufügen',

                // Structure panel
                'applyToAllWeeks': 'Auf alle Wochen anwenden',
                'applyToCurrentWeekOnly': 'Nur auf aktuelle Woche anwenden',

                // Days
                'monday': 'Montag',
                'tuesday': 'Dienstag',
                'wednesday': 'Mittwoch',
                'thursday': 'Donnerstag',
                'friday': 'Freitag',
                'saturday': 'Samstag',
                'sunday': 'Sonntag',

                // Lesson modal
                'createSubject': 'Fach anlegen',
                'editSubject': 'Fach bearbeiten',
                'subject': 'Fach',
                'teacher': 'Lehrer',
                'room': 'Raum',
                'time': 'Zeit',
                'create': 'Anlegen',
                'save': 'Speichern',
                'cancel': 'Abbrechen',
                'delete': 'Löschen',
                'deleteConfirm': 'Diesen Stunden wirklich löschen?',

                // Quick actions
                'quickActions': 'Schnellaktionen',
                'settings': 'Einstellungen',

                // Plan settings
                'planSettings': 'Plan-Einstellungen',
                'planSettingsTooltip': 'Detaillierte Einstellungen für die Plan-Erstellung. Alle Werte werden automatisch gespeichert.',
                'dataSettings': 'Datenbank-Einstellungen',
                'settingsSection': 'Einstellungen',

                // Overview
                'overview': 'Übersicht',
                'today': 'Heute',
                'todayNothing': 'Heute: nichts mehr anstehend',
                'allDone': 'Alles geschafft',
                'minutesLeft': 'Min übrig',

                // Analysis
                'analysis': 'Analyse',
                'weeklyStats': 'Wochenstatistiken',
                'totalLessons': 'Gesamte Stunden',
                'totalMinutes': 'Gesamte Minuten',
                'totalHours': 'Gesamte Stunden',
                'activeSubjects': 'Aktive Fächer',
                'studyStreak': 'Lernstreak',
                'days': 'Tage',

                // Common
                'min': 'Min',
                'h': 'h',
                'room': 'Raum',
                'subject': 'Fach',
                'teacher': 'Lehrer',
                'time': 'Zeit',
                'day': 'Tag',
                'week': 'Woche',
                'month': 'Monat',
                'year': 'Jahr',

                // Form labels and placeholders
                'minutes': 'Minuten',
                'perDay': 'pro Tag',
                'minutesBetweenLessons': 'Minuten zwischen den Stunden',
                'selectWeekdays': 'Wähle die Wochentage für deinen Stundenplan',
                'addTimeSlot': 'Zeitstunde hinzufügen',
                'newTimeSlot': 'Neue Zeitstunde',
                'manageTeachers': 'Lehrer verwalten',
                'addEditTeachers': 'Lehrer hinzufügen und bearbeiten',
                'edit': 'Bearbeiten',
                'close': 'Schließen',
                'delete': 'Löschen',
                'addSubject': 'Fach hinzufügen',
                'addTeacher': 'Lehrer hinzufügen',
                'addRoom': 'Raum hinzufügen',
                'teachers': 'Lehrer',
                'rooms': 'Räume',
                'subjects': 'Fächer',
                'subjectInfo': 'Fach-Info',
                'editSubject': 'Fach bearbeiten',
                'createSubject': 'Fach anlegen',
                'teacherLabel': 'Lehrer:in',
                'roomLabel': 'Raum',
                'subjectLabel': 'Fach',
                'timeLabel': 'Zeit',
                'autoSave': 'Auto-Speichern',
                'confirmation': 'Bestätigung',
                'confirmationDescription': 'Bestätigung vor Löschen',
                'timeFormat': 'Zeit-Format',
                'timeFormat24': '24-Stunden (14:30)',
                'timeFormat12': '12-Stunden (2:30 PM)',
                'teacherDistribution': 'Lehrer-Verteilung',
                'roomUsage': 'Raum-Nutzung',
                'timeDistribution': 'Zeit-Verteilung',
                'showsTeacherHours': 'Zeigt, wie viele Stunden pro Lehrer geplant sind',
                'showsRoomUsage': 'Zeigt, wie oft jeder Raum verwendet wird',
                'showsTimeDistribution': 'Zeigt Zeitverteilung über die Woche',
                'availableTimeBlocks': 'Verfügbare Zeitblöcke ohne geplante Stunden',
                'percentageOccupied': 'Prozentsatz der belegten Zeitblöcke in der Woche',
                'showsSubjectHours': 'Zeigt, wie viele Stunden pro Fach geplant sind',
                'heatmapDescription': 'Zeigt deine Stundenverteilung als Heatmap. Rote Linie = aktuelle Zeit. Grüne Bereiche = bereits vergangene Stunden',
                'availableBlocksToday': 'Verfügbare Zeitblöcke ohne geplante Stunden für heute',
                'availableBlocks': 'Verfügbare Zeitblöcke ohne geplante Stunden',
                'quickActions': 'Schnellaktionen',
                'settings': 'Einstellungen',
                'exportData': 'Daten exportieren',
                'importData': 'Daten importieren',
                'resetAllData': 'Alle Daten zurücksetzen',
                'resetAllDataConfirm': 'Wirklich alle Daten zurücksetzen? Dies kann nicht rückgängig gemacht werden.',
                'dataReset': 'Alle Daten wurden zurückgesetzt.',
                'closeLabel': 'Schließen',
                'editLabel': 'Bearbeiten',
                'deleteLabel': 'Löschen',
                'saveLabel': 'Speichern',
                'cancelLabel': 'Abbrechen',
                'createLabel': 'Anlegen',
                'addLabel': 'Hinzufügen',
                'manageLabel': 'Verwalten',
                'subjectPlaceholder': 'Mathematik, Deutsch, Englisch...',
                'teacherPlaceholder': 'Müller, Schmidt, Weber...',
                'roomPlaceholder': 'A101, B205, C301...',
                'minutesLabel': 'Minuten',
                'betweenLessons': 'zwischen den Stunden',
                'perDayLabel': 'pro Tag',
                'weekdaySelection': 'Wähle die Wochentage für deinen Stundenplan',
                'heatmapTooltip': 'Zeigt deine Stundenverteilung als Heatmap. Rote Linie = aktuelle Zeit. Grüne Bereiche = bereits vergangene Stunden.',
                'availableBlocksTooltip': 'Verfügbare Zeitblöcke ohne geplante Stunden für heute.',
                'percentageTooltip': 'Prozentsatz der belegten Zeitblöcke in der Woche.',
                'subjectDistributionTooltip': 'Zeigt, wie viele Stunden pro Fach geplant sind.',
                'teacherDistributionTooltip': 'Zeigt, wie viele Stunden pro Lehrer geplant sind.',
                'roomUsageTooltip': 'Zeigt, wie oft jeder Raum verwendet wird.',
                'timeDistributionTooltip': 'Zeigt Zeitverteilung über die Woche.',
                'addTimeSlotTooltip': 'Neue Zeitstunde hinzufügen',
                'manageTeachersTooltip': 'Lehrer hinzufügen und bearbeiten',
                'addSubjectTooltip': 'Fach hinzufügen',
                'addTeacherTooltip': 'Lehrer hinzufügen',
                'addRoomTooltip': 'Raum hinzufügen',
                'dataManagement': 'Datenverwaltung',
                'dataManagementTooltip': 'Verwalte deine Stundenplandaten.',
                'analysisTooltip': 'Detaillierte Statistiken und Auswertungen deines Stundenplans. Alle Daten basieren auf der aktuell angezeigten Woche.',
                'analysisSubtitle': 'Statistiken und Auswertungen deines Stundenplans'
            }
        };

        // Translation function
        function t(key) {
            const lang = settingsState.language || 'en';
            return translations[lang][key] || translations['en'][key] || key;
        }

        // Update UI text function
        function updateUIText() {
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });

            // Update tooltips
            document.querySelectorAll('[data-i18n-tooltip]').forEach(el => {
                const key = el.getAttribute('data-i18n-tooltip');
                const tooltip = el.querySelector('.tooltip-text');
                if (tooltip) tooltip.textContent = t(key);
            });

            // Update select options
            document.querySelectorAll('option[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });
        }

        function loadSettingsState() {
            try {
                const saved = localStorage.getItem('appSettings');
                if (saved) {
                    Object.assign(settingsState, JSON.parse(saved));
                }
            } catch (e) {
                console.warn('Failed to load settings:', e);
            }
        }

        function saveSettingsState() {
            try {
                localStorage.setItem('appSettings', JSON.stringify(settingsState));
            } catch (e) {
                console.warn('Failed to save settings:', e);
            }
        }

        function applySettingsState() {
            // Apply settings to UI
            const autoSaveToggle = byId('autoSaveToggle');
            const redlineToggle = byId('redlineToggle');
            const tooltipsToggle = byId('tooltipsToggle');
            const dragDropToggle = byId('dragDropToggle');

            // Apply auto-save setting
            if (autoSaveToggle) {
                if (settingsState.autoSave) {
                    startAutoSave();
                } else {
                    stopAutoSave();
                }
            }
            const compactViewToggle = byId('compactViewToggle');
            const animationsToggle = byId('animationsToggle');
            const weekNavToggle = byId('weekNavToggle');
            const debugModeToggle = byId('debugModeToggle');
            const autoBackupToggle = byId('autoBackupToggle');
            const performanceModeToggle = byId('performanceModeToggle');

            if (autoSaveToggle) autoSaveToggle.checked = settingsState.autoSave;
            if (redlineToggle) redlineToggle.checked = settingsState.redline;
            if (tooltipsToggle) tooltipsToggle.checked = settingsState.tooltips;
            if (dragDropToggle) dragDropToggle.checked = settingsState.dragDrop;
            if (compactViewToggle) compactViewToggle.checked = settingsState.compactView;
            if (animationsToggle) animationsToggle.checked = settingsState.animations;
            if (weekNavToggle) weekNavToggle.checked = settingsState.weekNav;
            if (debugModeToggle) debugModeToggle.checked = settingsState.debugMode;
            if (autoBackupToggle) autoBackupToggle.checked = settingsState.autoBackup;
            if (performanceModeToggle) performanceModeToggle.checked = settingsState.performanceMode;

            // Apply visual effects
            document.body.classList.toggle('compact-view', settingsState.compactView);
            document.body.classList.toggle('no-animations', !settingsState.animations);
            document.body.classList.toggle('performance-mode', settingsState.performanceMode);
        }

        function initializeSettingsToggles() {
            // Load and apply settings
            loadSettingsState();
            applySettingsState();

            // Initialize language selector
            const languageSelector = byId('languageSelector');
            if (languageSelector) {
                languageSelector.value = settingsState.language || 'en';
                languageSelector.addEventListener('change', (e) => {
                    settingsState.language = e.target.value;
                    saveSettingsState();
                    updateUIText();
                });
            }

            // Add event listeners for all toggles
            const toggles = [
                'autoSaveToggle', 'redlineToggle', 'tooltipsToggle', 'dragDropToggle',
                'compactViewToggle', 'animationsToggle', 'weekNavToggle',
                'debugModeToggle', 'autoBackupToggle', 'performanceModeToggle'
            ];

            toggles.forEach(toggleId => {
                const toggle = byId(toggleId);
                if (toggle) {
                    toggle.addEventListener('change', (e) => {
                        const settingKey = toggleId.replace('Toggle', '');
                        settingsState[settingKey] = e.target.checked;
                        saveSettingsState();
                        applySettingsState();

                        // Handle auto-save toggle specifically
                        if (settingKey === 'autoSave') {
                            if (e.target.checked) {
                                startAutoSave();
                            } else {
                                stopAutoSave();
                            }
                        }

                        // Apply specific settings
                        if (settingKey === 'redline') {
                            // Toggle redline visibility
                            const redlineElements = document.querySelectorAll('.redline');
                            redlineElements.forEach(el => {
                                el.style.display = settingsState.redline ? 'block' : 'none';
                            });
                        }

                        if (settingKey === 'tooltips') {
                            // Toggle tooltips visibility
                            const tooltipElements = document.querySelectorAll('.info-tooltip');
                            tooltipElements.forEach(el => {
                                el.style.display = settingsState.tooltips ? 'inline-block' : 'none';
                            });
                        }
                    });
                }
            });
        }

        function updateLastBackupTime() {
            const lastBackupTimeEl = byId('lastBackupTime');
            if (lastBackupTimeEl) {
                const lastBackup = localStorage.getItem('lastBackupTime');
                if (lastBackup) {
                    const date = new Date(lastBackup);
                    lastBackupTimeEl.textContent = date.toLocaleString('de-DE');
                } else {
                    lastBackupTimeEl.textContent = 'Nie';
                }
            }
        }

        function initializeSettingsActions() {
            // Update backup time display
            updateLastBackupTime();

            // Reset settings button
            byId('resetSettingsBtn')?.addEventListener('click', () => {
                if (confirm(t('resetSettingsConfirm'))) {
                    Object.keys(settingsState).forEach(key => {
                        settingsState[key] = key === 'autoSave' || key === 'redline' || key === 'tooltips' ||
                            key === 'dragDrop' || key === 'animations' || key === 'weekNav' ||
                            key === 'autoBackup' ? true : false;
                    });
                    saveSettingsState();
                    applySettingsState();
                    alert(t('settingsReset'));
                }
            });

            // Reset data button
            byId('resetDataBtn')?.addEventListener('click', () => {
                if (confirm('ALLE DATEN LÖSCHEN? Dies kann nicht rückgängig gemacht werden!')) {
                    resetAllTimetableSettings();
                    alert('Alle Daten wurden gelöscht.');
                }
            });

            // Export data button
            byId('exportDataBtn')?.addEventListener('click', () => {
                try {
                    const data = {
                        state: state,
                        dataState: dataState,
                        folderState: folderState,
                        weekPlans: Object.fromEntries(weekPlans),
                        settings: settingsState
                    };
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `stunova-backup-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);

                    // Update last backup time
                    localStorage.setItem('lastBackupTime', new Date().toISOString());
                    updateLastBackupTime();
                } catch (e) {
                    alert('Fehler beim Exportieren der Daten.');
                }
            });

            // Import data button
            byId('importDataBtn')?.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const data = JSON.parse(e.target.result);
                                if (confirm('Daten importieren? Bestehende Daten werden überschrieben.')) {
                                    if (data.state) Object.assign(state, data.state);
                                    if (data.dataState) Object.assign(dataState, data.dataState);
                                    if (data.folderState) Object.assign(folderState, data.folderState);
                                    if (data.weekPlans) {
                                        weekPlans.clear();
                                        Object.entries(data.weekPlans).forEach(([key, value]) => {
                                            weekPlans.set(key, value);
                                        });
                                    }
                                    if (data.settings) Object.assign(settingsState, data.settings);

                                    savePlan();
                                    saveData();
                                    saveFolders();
                                    saveWeekPlans();
                                    saveSettingsState();

                                    renderGrid();
                                    renderOverview();
                                    renderFolders();
                                    applySettingsState();

                                    alert('Daten erfolgreich importiert.');
                                }
                            } catch (e) {
                                alert('Fehler beim Importieren der Daten.');
                            }
                        };
                        reader.readAsText(file);
                    }
                };
                input.click();
            });

            // Structure panel listeners are now initialized when the panel is opened
        }
        function savePlan() {
            try {
                localStorage.setItem(LS_PLAN, JSON.stringify(state));
                saveCurrentWeekPlan();
                saveWeekPlans();
                saveCurrentProfileData(); // Save to current profile
                console.log('Plan data saved successfully');
            } catch (e) {
                console.error('Failed to save plan:', e);
            }
        }

        function saveWeekPlans() {
            try {
                const weekPlansObj = Object.fromEntries(weekPlans);
                localStorage.setItem('weekPlans', JSON.stringify(weekPlansObj));
                saveCurrentProfileData(); // Also save to current profile
                console.log('Week plans saved successfully');
            } catch (e) {
                console.warn('Failed to save weekPlans:', e);
            }
        }

        // Auto-save function that saves all data periodically
        function autoSaveAll() {
            if (settingsState.autoSave) {
                try {
                    savePlan();
                    saveData();
                    saveFolders();
                    saveSettingsState();
                    console.log('Auto-save completed');
                } catch (e) {
                    console.error('Auto-save failed:', e);
                }
            }
        }

        // Set up auto-save interval (every 30 seconds)
        let autoSaveInterval;
        function startAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
            autoSaveInterval = setInterval(autoSaveAll, 30000); // Save every 30 seconds
        }

        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
        }

        function validateAndFixTimeSlots(plan) {
            if (!plan.timeSlots || !Array.isArray(plan.timeSlots)) {
                return false;
            }

            // Check if time slots are corrupted (starting at wrong time or invalid values)
            const hasCorruptedSlots = plan.timeSlots.some(slot => {
                if (!slot || typeof slot.startTime !== 'number' || typeof slot.endTime !== 'number') {
                    return true;
                }

                // Check if start time is invalid (negative or exceeds 24:00)
                if (slot.startTime < 0 || slot.startTime >= 24 * 60) {
                    return true;
                }

                // Check if end time is invalid or exceeds 23:59
                if (slot.endTime <= slot.startTime || slot.endTime >= 24 * 60) {
                    return true;
                }

                return false;
            });

            if (hasCorruptedSlots) {
                console.warn('Corrupted time slots detected, resetting to default');
                return false;
            }

            return true;
        }

        function resetTimeSlotsForWeek(weekKey) {
            const plan = weekPlans.get(weekKey);
            if (!plan) return;

            // Reset to default time slots starting at plan.dayStart
            plan.timeSlots = [];
            plan.periodCount = 8; // Default period count

            // Generate default time slots starting from plan.dayStart
            for (let i = 0; i < plan.periodCount; i++) {
                // No breaks: startTime = i * periodMinutes
                const startTime = i * state.periodMinutes;
                const endTime = startTime + state.periodMinutes;

                // Calculate absolute time to check if it exceeds midnight
                const absoluteStartTime = plan.dayStart.h * 60 + plan.dayStart.m + startTime;
                const absoluteEndTime = plan.dayStart.h * 60 + plan.dayStart.m + endTime;

                // Ensure we don't exceed 23:59 (max time in a day)
                if (absoluteEndTime >= 24 * 60) {
                    console.warn('Time slot would exceed 23:59, stopping at', i, 'periods');
                    plan.periodCount = i;
                    break;
                }

                plan.timeSlots.push({
                    startTime: startTime,
                    endTime: endTime,
                    label: timeLabelFromMinutes(plan.dayStart, startTime)
                });
            }

            console.log('Reset time slots for week:', weekKey, 'starting at', plan.dayStart.h + ':' + String(plan.dayStart.m).padStart(2, '0'));
            saveWeekPlans();
        }

        function fixAllCorruptedTimeSlots() {
            console.log('Checking all weeks for corrupted time slots...');
            let fixedCount = 0;

            // Check if weekPlans exists and has entries
            if (!weekPlans || weekPlans.size === 0) {
                console.log('No week plans found');
                return;
            }

            for (const [weekKey, plan] of weekPlans.entries()) {
                console.log('Checking week:', weekKey, 'has timeSlots:', !!plan.timeSlots);

                if (plan.timeSlots && !validateAndFixTimeSlots(plan)) {
                    console.log('Fixing corrupted time slots for week:', weekKey);
                    resetTimeSlotsForWeek(weekKey);
                    fixedCount++;
                } else if (!plan.timeSlots) {
                    console.log('Week has no timeSlots, creating default ones:', weekKey);
                    resetTimeSlotsForWeek(weekKey);
                    fixedCount++;
                }
            }

            if (fixedCount > 0) {
                console.log(`Fixed ${fixedCount} weeks with corrupted time slots`);
                // Re-render the current grid
                renderGrid();
            } else {
                console.log('No corrupted time slots found');
            }
        }

        function resetAllTimetableSettings() {
            console.log('Resetting all timetable settings...');

            // Reset state to defaults
            state.days = [...defaultDays];
            state.periodMinutes = periodMinutesDefault;
            state.breakMinutes = 0; // No breaks between lessons
            state.periodCount = 8;
            state.lessons = [];

            // Clear all week plans
            weekPlans.clear();

            // Reset current week to current week
            currentPlanWeek = getCurrentWeekKey();
            currentHeatmapWeek = getCurrentWeekKey();
            currentWeekOffset = 0;

            // Create fresh week plan for current week
            getOrCreateWeekPlan(currentPlanWeek);

            // Save everything
            savePlan();
            saveWeekPlans();

            // Update displays
            updatePlanWeekDisplay();
            updateWeekDisplay();

            // Re-render
            renderGrid();
            renderOverview();

            console.log('All timetable settings reset to defaults');
            console.log('Timetable now starts at:', dayStart.h + ':' + String(dayStart.m).padStart(2, '0'));
        }

        function resetOnlyTimeSlots() {
            console.log('Resetting only time slots while preserving other settings...');

            // Keep existing settings but reset time slots
            for (const [weekKey, plan] of weekPlans.entries()) {
                resetTimeSlotsForWeek(weekKey);
            }

            // Save week plans
            saveWeekPlans();

            // Re-render
            renderGrid();

            console.log('Time slots reset while preserving other settings');
        }
        function saveData() { try { localStorage.setItem(LS_DATA, JSON.stringify(dataState)); } catch { } }
        function saveFolders() {
            try {
                localStorage.setItem(LS_FOLDERS, JSON.stringify(folderState.folders));
                console.log(`Saved ${folderState.folders.length} folders to localStorage`);
            }
            catch (error) {
                console.error('Error saving folders:', error);
            }
        }

        /* =================== NAV =================== */
        const pageOverview = byId('pageOverview'),
            pagePlan = byId('pagePlan'),
            pageFolders = byId('pageFolders'),
            pageProfile = byId('pageProfile');

        // Page transition system
        let currentPage = localStorage.getItem('lastActivePage') || 'pageOverview';
        const pageOrder = ['pageOverview', 'pagePlan', 'pageFolders', 'pageProfile'];

        function slideToPage(targetPageId) {
            const currentPageEl = currentPage ? byId(currentPage) : null;
            const targetPageEl = byId(targetPageId);

            console.log('slideToPage called:', { targetPageId, currentPage, currentPageEl: !!currentPageEl, targetPageEl: !!targetPageEl });

            if (!targetPageEl) {
                console.error('Target page not found:', targetPageId);
                return;
            }

            // Always ensure the target page is visible, even if it's the same as current
            // This fixes the issue where clicking overview after reload doesn't show the page
            if (targetPageId === currentPage && !targetPageEl.hidden) {
                // Page is already visible, just ensure it's properly rendered
                if (targetPageId === 'pageOverview') {
                    renderOverview();
                }
                return;
            }

            // Hide current page if it exists and is different
            if (currentPageEl && targetPageId !== currentPage) {
                currentPageEl.classList.remove('active', 'force-visible');
                currentPageEl.hidden = true;
                // Remove any inline styles that might override
                currentPageEl.style.removeProperty('display');
                currentPageEl.style.removeProperty('visibility');
                currentPageEl.style.removeProperty('opacity');
            }
            
            // Remove force-visible from all other pages
            document.querySelectorAll('.container').forEach(page => {
                if (page.id !== targetPageId) {
                    page.classList.remove('force-visible');
                    page.style.removeProperty('display');
                    page.style.removeProperty('visibility');
                    page.style.removeProperty('opacity');
                }
            });

            // Show target page
            console.log('Showing target page:', targetPageId);
            targetPageEl.hidden = false;
            targetPageEl.classList.add('active');
            // Force display style to override CSS !important rule
            targetPageEl.style.display = 'block';
            console.log('Target page visibility after show:', { 
                hidden: targetPageEl.hidden, 
                hasActive: targetPageEl.classList.contains('active'),
                display: targetPageEl.style.display,
                computedDisplay: window.getComputedStyle(targetPageEl).display
            });

            currentPage = targetPageId;
            try { localStorage.setItem('lastActivePage', targetPageId); } catch { }
            
            // Update structure panel if it's open and we're switching between Plan and Overview
            const structurePanel = byId('timetableStructurePanel');
            if (structurePanel && structurePanel.classList.contains('open')) {
                if (targetPageId === 'pagePlan' || targetPageId === 'pageOverview') {
                    console.log('Updating structure panel for new page:', targetPageId);
                    updatePlanSettingsForCurrentWeek();
                }
            }
            
            // Ensure content is rendered for the target page
            setTimeout(() => {
                if (targetPageId === 'pageOverview') {
                    try {
                        renderOverview();
                        console.log('Overview rendered after page switch');
                    } catch (error) {
                        console.error('Failed to render overview after page switch:', error);
                    }
                }
            }, 50);
        }

        function resetAllPills() {
            document.querySelectorAll('.nav-island .pill').forEach(p => {
                p.classList.remove('primary');
                p.style.background = '';
                p.style.color = '';
                p.style.opacity = '';
                p.style.transform = '';
                p.style.boxShadow = '';
                p.setAttribute('aria-selected', 'false');
            });
        }

        function activatePill(btn) {
            if (!btn) return;

            // Only reset if the target pill is not already active
            if (!btn.classList.contains('primary')) {
                resetAllPills();
            }

            // Add primary class to selected pill
            btn.classList.add('primary');
            btn.setAttribute('aria-selected', 'true');
        }

// Ensure exactly one pill is active on startup; default to Overview
function ensureOnePillActive() {
    const active = document.querySelector('.nav-island .pill.primary');
    if (!active) {
        const ov = byId('navOverview');
        if (ov) {
            activatePill(ov);
            try { localStorage.setItem('lastActivePage', 'pageOverview'); } catch {}
        }
    }
}

        byId('navOverview')?.addEventListener('click', e => {
            activatePill(e.currentTarget);
            slideToPage('pageOverview');
            updateWeekDisplay(); // Update overview week display independently
            
            // Force render overview with delay to ensure DOM is ready
            setTimeout(() => {
                try {
                    renderOverview();
                    console.log('Overview rendered on click');
                } catch (error) {
                    console.error('Error rendering overview on click:', error);
                }
            }, 50);
        });

        // After listeners are attached, ensure a default selection
        (function ensureDefaultSelection() {
            const hasActive = !!document.querySelector('.nav-island .pill.primary');
            if (!hasActive) {
                const ov = byId('navOverview');
                if (ov) {
                    // Defer to end of tick so DOM/visibility is settled
                    setTimeout(() => {
                        try { localStorage.setItem('lastActivePage', 'pageOverview'); } catch {}
                        ov.click();
                    }, 0);
                }
            }
        })();

        // Week navigation event listeners
        function attachWeekNavigationListeners() {
            const weekBackBtn = byId('weekBack');
            const weekForwardBtn = byId('weekForward');

            if (weekBackBtn) {
                weekBackBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log('Week back clicked');
                    const btn = e.target.closest('button');
                    if (btn) {
                        btn.style.transform = 'scale(0.95)';
                        setTimeout(() => btn.style.transform = '', 150);
                    }
                    navigateWeek(-1);
                });
            } else {
                console.warn('weekBack button not found');
            }

            if (weekForwardBtn) {
                weekForwardBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log('Week forward clicked');
                    const btn = e.target.closest('button');
                    if (btn) {
                        btn.style.transform = 'scale(0.95)';
                        setTimeout(() => btn.style.transform = '', 150);
                    }
                    navigateWeek(1);
                });
            } else {
                console.warn('weekForward button not found');
            }
        }

        attachWeekNavigationListeners();
        
        // Initialize structure panel listeners on page load
        initializeStructurePanelListeners();

        // Current week navigation for overview (heatmap only)
        byId('goToCurrentWeek')?.addEventListener('click', (e) => {
            e.stopPropagation();
            // Reset heatmap to current week (independent from plan timetable)
            currentHeatmapWeek = getCurrentWeekKey();
            overviewWeekKey = getCurrentWeekKey(); // Keep overview in sync
            try {
                localStorage.setItem('currentHeatmapWeek', currentHeatmapWeek);
                localStorage.setItem('overviewWeekKey', overviewWeekKey);
            } catch (e) {
                console.warn('Failed to save week keys:', e);
            }
            updateWeekDisplay();
            renderOverview();
        });

        // Current week navigation for plan
        byId('goToCurrentPlanWeek')?.addEventListener('click', (e) => {
            e.stopPropagation();
            const currentWeekKey = getCurrentWeekKey();
            switchToWeekPlan(currentWeekKey);

            // Update both displays (plan and heatmap)
            updatePlanWeekDisplay();
            updateWeekDisplay();
        });



        // Plan week navigation event listeners
        function attachPlanWeekNavigationListeners() {
            const planWeekBackBtn = byId('planWeekBack');
            const planWeekForwardBtn = byId('planWeekForward');

            if (planWeekBackBtn) {
                planWeekBackBtn.addEventListener('click', (e) => {
                    console.log('Plan week back clicked');
                    const btn = e.target.closest('button');
                    if (btn) {
                        btn.style.transform = 'scale(0.95)';
                        btn.style.opacity = '0.7';
                        setTimeout(() => {
                            btn.style.transform = '';
                            btn.style.opacity = '';
                        }, 150);
                    }
                    navigatePlanWeek(-1);
                });
            } else {
                console.warn('planWeekBack button not found');
            }

            if (planWeekForwardBtn) {
                planWeekForwardBtn.addEventListener('click', (e) => {
                    console.log('Plan week forward clicked');
                    const btn = e.target.closest('button');
                    if (btn) {
                        btn.style.transform = 'scale(0.95)';
                        btn.style.opacity = '0.7';
                        setTimeout(() => {
                            btn.style.transform = '';
                            btn.style.opacity = '';
                        }, 150);
                    }
                    navigatePlanWeek(1);
                });
            } else {
                console.warn('planWeekForward button not found');
            }
        }

        attachPlanWeekNavigationListeners();

        // Setup week input functionality
        setupWeekInput();

        // Timetable structure panel week navigation is now handled by initializeStructurePanelListeners()
        // to ensure it uses the correct navigation function based on current section

        byId('navPlan')?.addEventListener('click', e => {
            activatePill(e.currentTarget);
            slideToPage('pagePlan');

            // Initialize current week plan if not exists
            if (!weekPlans.has(currentPlanWeek)) {
                getOrCreateWeekPlan(currentPlanWeek);
                // Copy current state to the week plan
                saveCurrentWeekPlan();
            }

            updatePlanWeekDisplay();
            renderGrid(); // Ensure grid is rendered when switching to Plan
            updatePlanSettingsForCurrentWeek(); // Update plan settings with current week's values
        });

        byId('navFolders')?.addEventListener('click', e => {
            activatePill(e.currentTarget);
            slideToPage('pageFolders');
            // Ensure folders are rendered with error handling
            try {
                renderFolders();
                console.log('Folders rendered on navigation');
            } catch (error) {
                console.error('Error rendering folders on navigation:', error);
                // Retry after a short delay
                setTimeout(() => {
                    try {
                        renderFolders();
                        console.log('Folders rendered on retry');
                    } catch (retryError) {
                        console.error('Retry failed:', retryError);
                    }
                }, 100);
            }
        });

        byId('navProfile')?.addEventListener('click', e => {
            activatePill(e.currentTarget);
            slideToPage('pageProfile');
            // Load profile data and render statistics
            loadProfileData();
            renderProfileStats();
            updateTodayOverview();
            updateProfileDisplay();
            generateSmartInsights();
        });

        function findPresetForSubject(subj) {
            const s = (subj || '').trim();
            if (!s) return null;
            // exact match first, then case-insensitive
            let p = (dataState.presets || []).find(x => x.subject === s);
            if (!p) p = (dataState.presets || []).find(x => (x.subject || '').toLowerCase() === s.toLowerCase());
            return p || null;
        }
        /* =================== PLAN (grid etc.) =================== */
        const gridEl = byId('grid'); const headerCenter = document.querySelector('.header-center'); let redlineTip = null; let isResizing = false;

        function regenerateTimeSlotsForPeriodCount(plan) {
            // Regenerate ALL time slots based on current periodCount, periodMinutes, and breakMinutes
            plan.timeSlots = [];

            console.log('=== REGENERATING TIME SLOTS ===');
            console.log('Plan values:', {
                periodMinutes: plan.periodMinutes,
                breakMinutes: plan.breakMinutes,
                periodCount: plan.periodCount
            });
            console.log('plan.dayStart:', plan.dayStart);

            // Generate time slots based on the periods per day slider setting
            // The slider should be the primary control, not the calculated maximum
            const maxSlotsToGenerate = plan.periodCount;

            for (let i = 0; i < maxSlotsToGenerate; i++) {
                // No breaks: startTime = i * periodMinutes
                const startTime = i * plan.periodMinutes;
                let endTime = startTime + plan.periodMinutes;

                // Calculate absolute time to check if it exceeds midnight
                const absoluteStartTime = plan.dayStart.h * 60 + plan.dayStart.m + startTime;
                const absoluteEndTime = plan.dayStart.h * 60 + plan.dayStart.m + endTime;

                // Handle the edge case: if the last period would hit exactly 24:00, make it 1 minute shorter
                if (absoluteEndTime > 24 * 60) {
                    // Would exceed 24:00, stop generating
                    console.warn('Time slot would exceed 24:00, stopping at', i, 'periods');
                    break;
                } else if (absoluteEndTime === 24 * 60 && i === maxSlotsToGenerate - 1) {
                    // Last period would hit exactly 24:00, make it 1 minute shorter
                    endTime = startTime + plan.periodMinutes - 1;
                    console.log(`Last period adjusted to be 1 minute shorter to avoid hitting 24:00`);
                }

                const slot = {
                    startTime: startTime,
                    endTime: endTime
                };

                plan.timeSlots.push(slot);

                const startLabel = timeLabelFromMinutes(plan.dayStart, startTime);
                const endLabel = timeLabelFromMinutes(plan.dayStart, endTime);
                console.log(`Slot ${i}: ${startLabel} - ${endLabel} (startTime: ${startTime}, endTime: ${endTime})`);
            }

            // Remove any lessons that are now outside the valid period range
            plan.lessons = plan.lessons.filter(lesson =>
                lesson.startIndex < plan.periodCount &&
                lesson.startIndex + lesson.span <= plan.periodCount
            );

            console.log('=== TIME SLOTS REGENERATED ===');
            console.log('Final count:', plan.timeSlots.length, 'slots');
        }

        function resetAllTimeSlots() {
            // Reset time slots for all weeks to ensure consistency
            console.log('Resetting all time slots to fix inconsistencies...');

            weekPlans.forEach((plan, weekKey) => {
                console.log(`Resetting time slots for week: ${weekKey}`);
                regenerateTimeSlotsForPeriodCount(plan);
            });

            // Save and re-render
            saveWeekPlans();
            renderGrid();
            renderOverview();

            console.log('All time slots have been reset and regenerated');
        }

        function generatePeriods() {
            // Always use current plan values for consistency
            const plan = weekPlans.get(currentPlanWeek);
            if (!plan) {
                console.warn('No plan found for current week:', currentPlanWeek);
                return [];
            }

            console.log('=== GENERATING PERIODS ===');
            console.log('Using plan values:', {
                periodMinutes: plan.periodMinutes,
                breakMinutes: plan.breakMinutes,
                periodCount: plan.periodCount
            });

            const periods = [];

            for (let i = 0; i < plan.periodCount; i++) {
                // No breaks: each period starts after the previous period
                const startMin = i * plan.periodMinutes;
                const endMin = startMin + plan.periodMinutes;

                const period = {
                    startMin: startMin,
                    endMin: endMin,
                    startLabel: timeLabelFromMinutes(plan.dayStart, startMin),
                    endLabel: timeLabelFromMinutes(plan.dayStart, endMin)
                };

                periods.push(period);
                console.log(`Period ${i + 1}: ${period.startLabel} - ${period.endLabel}`);
            }

            console.log('=== PERIODS GENERATED ===');
            console.log('Total periods:', periods.length);
            console.log('First period:', periods[0]);
            console.log('Last period:', periods[periods.length - 1]);
            return periods;
        }
        function renderGrid() {
            console.log('=== RENDERING GRID ===');

            // Get the current week plan
            const currentPlan = getOrCreateWeekPlan(currentPlanWeek);
            if (!gridEl) {
                console.warn('Grid element not found');
                return;
            }

            console.log('Current plan:', {
                periodMinutes: currentPlan.periodMinutes,
                breakMinutes: currentPlan.breakMinutes,
                periodCount: currentPlan.periodCount,
                days: currentPlan.days
            });

            // Clear grid
            gridEl.innerHTML = '';
            gridEl.style.setProperty('--day-count', currentPlan.days.length);
            gridEl.classList.add('has-days');

            const clearPlaceholder = () => {
                gridEl.querySelector('#timePlaceholderRow')?.remove();
                gridEl.querySelector('#rowPlaceholderOverlay')?.remove();
                gridEl.querySelectorAll('.day-col .placeholder-row').forEach(n => n.remove());
                lastPlaceholderIndex = -1;
            };

            let lastPlaceholderIndex = -1;
            let placeholderRaf = 0;
            let pendingPlaceholderIndex = -1;
            let currentHoverIndex = -1;

            // Guard to avoid multiple reorder executions when dropping quickly across targets
            let isRowDragActive = false;
            let rowDragFromIndex = -1;
            let rowDropHandled = false;

            // Click-to-move mode state
            let clickMoveActive = false;
            let clickMoveFromIndex = -1;
            let clickSourceMarker = null;
            let isMouseDown = false;
            let dragTimer = null;
            
            // Global mouse tracking
            document.addEventListener('mousedown', () => {
                isMouseDown = true;
            });
            
            document.addEventListener('mouseup', () => {
                isMouseDown = false;
                // Clear timer if mouse is released quickly
                if (dragTimer) {
                    clearTimeout(dragTimer);
                    dragTimer = null;
                }
                // Clear placeholder when mouse is released
                if (clickMoveActive) {
                    clearPlaceholder();
                }
            });
            // Helper: perform true row insert and remap lessons/timeSlots
            const reorderRowInsert = (fromIdx, toIdx) => {
                const plan = getOrCreateWeekPlan(currentPlanWeek);
                const order = Array.from({ length: plan.periodCount }, (_, i) => i);
                const [removed] = order.splice(fromIdx, 1);
                order.splice(toIdx, 0, removed);
                const indexMap = new Map(order.map((oldIdx, newIdx) => [oldIdx, newIdx]));

                plan.lessons = plan.lessons.map(l => ({
                    ...l,
                    startIndex: indexMap.has(l.startIndex) ? /** @type {number} */ (indexMap.get(l.startIndex)) : l.startIndex
                }));

                if (Array.isArray(plan.timeSlots) && plan.timeSlots.length === plan.periodCount) {
                    const tsOrder = Array.from({ length: plan.periodCount }, (_, i) => i);
                    const [r] = tsOrder.splice(fromIdx, 1);
                    tsOrder.splice(toIdx, 0, r);
                    plan.timeSlots = tsOrder.map(i => plan.timeSlots[i]);
                }

                state.lessons = [...plan.lessons];
                saveCurrentWeekPlan();
                saveWeekPlans();
                renderGrid();
            };
            const showPlaceholderAt = (rowIndex) => {
                if (rowIndex === lastPlaceholderIndex) { currentHoverIndex = rowIndex; return; }
                pendingPlaceholderIndex = rowIndex;
                if (placeholderRaf) return;
                placeholderRaf = requestAnimationFrame(() => {
                    placeholderRaf = 0;
                    const idx = pendingPlaceholderIndex;
                    pendingPlaceholderIndex = -1;
                    if (idx === lastPlaceholderIndex) return;

                    // Create/update single full-width overlay across all day columns
                    // Align overlay to the actual time cell position to avoid header offsets
                    const timeCells2 = timeCol.querySelectorAll('.time-cell');
                    const refCell = timeCells2[idx] || null;
                    const gridRect = gridEl.getBoundingClientRect();
                    const rowTop = refCell ? (refCell.getBoundingClientRect().top - gridRect.top) : (idx * parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-h')));
                    let overlay = gridEl.querySelector('#rowPlaceholderOverlay');
                    if (!overlay) {
                        overlay = document.createElement('div');
                        overlay.id = 'rowPlaceholderOverlay';
                        overlay.className = 'row-placeholder-overlay';
                        overlay.addEventListener('dragover', (e) => { e.preventDefault(); });
                        overlay.addEventListener('drop', (e) => {
                            e.preventDefault();
                            const fromRaw = e.dataTransfer && e.dataTransfer.getData && e.dataTransfer.getData('text/row-index');
                            const fromIdx = fromRaw ? parseInt(fromRaw) : NaN;
                            if (Number.isFinite(fromIdx) && isRowDragActive && !rowDropHandled && fromIdx === rowDragFromIndex) { rowDropHandled = true; reorderRowInsert(fromIdx, idx); }
                        });
                        gridEl.appendChild(overlay);
                    }
                    overlay.style.top = rowTop + 'px';

                    lastPlaceholderIndex = idx;
                    currentHoverIndex = idx;
                });
            };

            // Add headers
            gridEl.appendChild(div('head time', 'Zeit'));
            currentPlan.days.forEach(d => gridEl.appendChild(div('head', d)));

            // Generate and render time periods
            const periods = generatePeriods();
            console.log('Generated periods:', periods.length);
            console.log('About to render', periods.length, 'time cells');

            const timeCol = div('time-col');
            // Allow dropping anywhere in the left time column
            timeCol.addEventListener('dragover', (e) => {
                // If a row is being dragged, show placeholder at computed index
                const fromRow = e.dataTransfer && e.dataTransfer.getData && e.dataTransfer.getData('text/row-index');
                if (fromRow !== null && fromRow !== undefined && fromRow !== '') {
                    e.preventDefault();
                    const rect = timeCol.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    const rowHStr = getComputedStyle(document.documentElement).getPropertyValue('--row-h');
                    const rowH = parseInt(rowHStr || '64');
                    const plan = getOrCreateWeekPlan(currentPlanWeek);
                    const idx = Math.max(0, Math.min(plan.periodCount - 1, Math.floor(y / rowH)));
                    try { showPlaceholderAt(idx); } catch { }
                }
                // Also update preview for click-to-move when hovering time column
                if (clickMoveActive) {
                    const rect = timeCol.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    const rowHStr = getComputedStyle(document.documentElement).getPropertyValue('--row-h');
                    const rowH = parseInt(rowHStr || '64');
                    const plan = getOrCreateWeekPlan(currentPlanWeek);
                    const idx = Math.max(0, Math.min(plan.periodCount - 1, Math.floor(y / rowH)));
                    try { showPlaceholderAt(idx); } catch { }
                }
            });
            timeCol.addEventListener('drop', (e) => {
                const fromRow = e.dataTransfer && e.dataTransfer.getData && e.dataTransfer.getData('text/row-index');
                if (fromRow !== null && fromRow !== undefined && fromRow !== '') {
                    e.preventDefault();
                    const rect = timeCol.getBoundingClientRect();
                    const y = e.clientY - rect.top;
                    const rowHStr = getComputedStyle(document.documentElement).getPropertyValue('--row-h');
                    const rowH = parseInt(rowHStr || '64');
                    const plan = getOrCreateWeekPlan(currentPlanWeek);
                    const idx = Math.max(0, Math.min(plan.periodCount - 1, Math.floor(y / rowH)));
                    const fromIdx = parseInt(fromRow);
                    if (isRowDragActive && !rowDropHandled && fromIdx === rowDragFromIndex) {
                        rowDropHandled = true;
                        try { reorderRowInsert(fromIdx, idx); } catch { }
                    }
                }
                // Finalize click-to-move if active and user clicks time column
                if (clickMoveActive && Number.isFinite(currentHoverIndex) && currentHoverIndex >= 0) {
                    reorderRowInsert(clickMoveFromIndex, currentHoverIndex);
                    clickMoveActive = false;
                    clickMoveFromIndex = -1;
                    gridEl.querySelector('#rowPickSource')?.remove();
                    clearPlaceholder();
                }
            });
            periods.forEach((p, index) => {
                const cell = div('time-cell');
                // Enable dragging a whole row (period) to reorder by swapping rows
                cell.setAttribute('draggable', 'true');
                cell.dataset.periodIndex = String(index);
                cell.addEventListener('dragstart', (e) => {
                    try { e.dataTransfer?.setData('text/row-index', String(index)); } catch { /* ignore */ }
                    // mark active row drag so only one drop handler runs
                    isRowDragActive = true;
                    rowDragFromIndex = index;
                    rowDropHandled = false;

                    // Create drag ghost that shows the actual row content across all days
                    const ghost = document.createElement('div');
                    ghost.style.position = 'absolute';
                    ghost.style.top = '-1000px';
                    ghost.style.left = '-1000px';
                    ghost.style.width = '600px';
                    ghost.style.height = '64px';
                    ghost.style.background = 'rgba(255, 255, 255, 0.95)';
                    ghost.style.border = '1px solid #e5e7eb';
                    ghost.style.borderRadius = '8px';
                    ghost.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
                    ghost.style.opacity = '0.9';
                    ghost.style.display = 'flex';
                    ghost.style.alignItems = 'center';
                    ghost.style.padding = '0 12px';
                    ghost.style.fontSize = '12px';
                    ghost.style.fontWeight = '600';
                    ghost.style.color = '#374151';

                    // Get lessons in this row across all days
                    const plan = getOrCreateWeekPlan(currentPlanWeek);
                    const rowLessons = plan.lessons.filter(l => l.startIndex === index);
                    const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr'];

                    let content = `Zeile ${index + 1}: `;
                    if (rowLessons.length > 0) {
                        const lessonTexts = rowLessons.map(l => `${dayNames[l.day]} ${l.subject || 'Fach'}`);
                        content += lessonTexts.join(', ');
                    } else {
                        content += 'Leer';
                    }

                    ghost.textContent = content;
                    document.body.appendChild(ghost);

                    try {
                        e.dataTransfer.setDragImage(ghost, 200, 32);
                    } catch { /* ignore */ }

                    // Clean up ghost after drag
                    setTimeout(() => {
                        if (ghost.parentNode) {
                            ghost.parentNode.removeChild(ghost);
                        }
                    }, 0);
                });
                cell.addEventListener('dragend', () => {
                    clearPlaceholder();
                    isRowDragActive = false;
                    rowDragFromIndex = -1;
                    rowDropHandled = false;
                });

                // Click-to-move: pick up with click on time cell
                cell.addEventListener('click', (e) => {
                    // If already in click mode and clicking the same row, cancel
                    if (clickMoveActive && clickMoveFromIndex === index) {
                        clickMoveActive = false;
                        clickMoveFromIndex = -1;
                        gridEl.querySelector('#rowPickSource')?.remove();
                        clearPlaceholder();
                        return;
                    }

                    clickMoveActive = true;
                    clickMoveFromIndex = index;
                    // Don't create marker immediately - wait for actual drag
                });
                
                // Track mouse down/up for drag detection
                cell.addEventListener('mousedown', () => {
                    isMouseDown = true;
                    // Start timer to show drag effects only after a delay
                    if (clickMoveActive) {
                        dragTimer = setTimeout(() => {
                            if (isMouseDown && clickMoveActive) {
                                // Create source marker after delay
                                let marker = gridEl.querySelector('#rowPickSource');
                                if (!marker) {
                                    marker = document.createElement('div');
                                    marker.id = 'rowPickSource';
                                    marker.className = 'row-pick-source';
                                    gridEl.appendChild(marker);
                                }
                                const rowHVal2 = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-h'));
                                marker.style.top = (clickMoveFromIndex * rowHVal2) + 'px';
                            }
                        }, 150); // 150ms delay before showing drag effects
                    }
                });
                
                cell.addEventListener('mouseup', () => {
                    isMouseDown = false;
                    // Clear timer if mouse is released quickly
                    if (dragTimer) {
                        clearTimeout(dragTimer);
                        dragTimer = null;
                    }
                });
                cell.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    // Show overlay aligned to the row you hover (not just midline)
                    showPlaceholderAt(index);
                });
                // Do not clear on dragleave to prevent flicker when moving between cells in same row
                cell.addEventListener('dragleave', () => { });
                cell.addEventListener('drop', (e) => {
                    e.preventDefault();
                    clearPlaceholder();
                    const fromRaw = e.dataTransfer?.getData('text/row-index');
                    const targetEl = (e.currentTarget && /** @type {*} */ (e.currentTarget)) || cell;
                    const toRaw = (targetEl && targetEl.dataset && targetEl.dataset.periodIndex) || String(index);
                    const fromIdx = fromRaw ? parseInt(fromRaw) : NaN;
                    const toIdx = toRaw ? parseInt(toRaw) : NaN;
                    if (!Number.isFinite(fromIdx) || !Number.isFinite(toIdx) || fromIdx === toIdx) return;
                    if (!isRowDragActive || rowDropHandled || fromIdx !== rowDragFromIndex) return;
                    rowDropHandled = true;
                    reorderRowInsert(fromIdx, toIdx);
                });

                // Click-to-move: when active, clicking a target row performs the move
                cell.addEventListener('mouseenter', () => {
                    if (!clickMoveActive) return;
                    // Only show placeholder if mouse is actually being dragged (not just moved)
                    if (isMouseDown) {
                        showPlaceholderAt(index);
                    }
                });
                cell.addEventListener('mouseleave', () => {
                    if (!clickMoveActive) return;
                    // keep placeholder; it will move on next enter
                });
                
                // Add row highlighting on hover (independent of click-to-move)
                cell.addEventListener('mouseenter', () => {
                    highlightTimetableRow(index);
                });
                cell.addEventListener('mouseleave', () => {
                    removeTimetableRowHighlight();
                });
                // Allow both click and mouseup to finalize quickly
                const finalizeClickMove = (targetIndex) => {
                    if (!clickMoveActive) return;
                    if (!Number.isFinite(targetIndex)) return;
                    if (clickMoveFromIndex === targetIndex) return;
                    reorderRowInsert(clickMoveFromIndex, targetIndex);
                    clickMoveActive = false;
                    clickMoveFromIndex = -1;
                    gridEl.querySelector('#rowPickSource')?.remove();
                    clearPlaceholder();
                };
                cell.addEventListener('mouseup', () => finalizeClickMove(index));
                cell.addEventListener('click', () => finalizeClickMove(index));

                // Add period number and drag handle (left side)
                const periodNumber = document.createElement('div');
                periodNumber.textContent = (index + 1).toString();
                periodNumber.style.fontSize = '14px';
                periodNumber.style.opacity = '0.7';
                periodNumber.style.fontWeight = '600';
                periodNumber.style.position = 'absolute';
                periodNumber.style.left = '30px';
                periodNumber.style.top = '50%';
                periodNumber.style.transform = 'translateY(-50%)';
                periodNumber.style.textAlign = 'left';
                periodNumber.style.width = 'auto';
                periodNumber.style.pointerEvents = 'none';
                periodNumber.style.userSelect = 'none';

                const dots = document.createElement('div');
                dots.className = 'row-drag-handle';
                // six dots
                for (let i = 0; i < 6; i++) {
                    const s = document.createElement('span');
                    dots.appendChild(s);
                }

                // Add time labels (right side)
                const top = document.createElement('div');
                top.textContent = p.startLabel;
                top.style.fontSize = '15px';
                top.style.fontWeight = '600';
                top.style.position = 'absolute';
                top.style.right = '4px';
                top.style.top = '4px';
                top.style.pointerEvents = 'none';
                top.style.userSelect = 'none';

                const bottom = document.createElement('div');
                bottom.textContent = p.endLabel;
                bottom.style.fontSize = '13px';
                bottom.style.opacity = '0.8';
                bottom.style.position = 'absolute';
                bottom.style.right = '4px';
                bottom.style.bottom = '4px';
                bottom.style.pointerEvents = 'none';
                bottom.style.userSelect = 'none';

                cell.style.position = 'relative';
                // ensure dots sit to the left of number by placing before other absolutely positioned content
                cell.appendChild(dots);
                cell.appendChild(periodNumber);
                cell.appendChild(top);
                cell.appendChild(bottom);
                timeCol.appendChild(cell);

                console.log(`Rendered time cell ${index + 1}: ${p.startLabel} - ${p.endLabel}`);
            });
            gridEl.appendChild(timeCol);
            console.log('Time column created with', timeCol.children.length, 'cells');

            if (!redlineTip) { redlineTip = document.createElement('div'); redlineTip.className = 'redline-tip'; redlineTip.hidden = true; gridEl.parentElement.appendChild(redlineTip); }

            const currentTime = new Date();
            const dayOfWeek = currentTime.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            const today = (dayOfWeek + 6) % 7; // Mo=0..Fr=4 (school days only)
            // Calculate the end time of the last period
            // For N periods: total time = N * periodMinutes (no breaks)
            const lastBlockEnd = currentPlan.periodCount * currentPlan.periodMinutes;

            const currentWeekKey = getCurrentWeekKey();

            function isDayCompleted(dayIndex) {
                const cmp = weekKeyCompare(currentPlanWeek, currentWeekKey);

                // Future weeks should never show completed days
                if (cmp > 0) return false;

                // Past weeks show all days as completed
                if (cmp < 0) return true;

                // If it's weekend (Saturday or Sunday), don't mark any days as completed
                // because we're showing the upcoming week
                if (dayOfWeek === 0 || dayOfWeek === 6) return false;

                // Current week: only show completed for past days
                if (dayIndex < today) return true;

                // Future days in current week should never be marked as completed
                if (dayIndex > today) return false;

                // Today: only show completed if school day is completely finished
                // Only mark today as completed if we're past the end of the school day
                if (dayIndex === today) {
                    const totalSchoolDayMinutes = currentPlan.periodCount * currentPlan.periodMinutes;
                    return minutesSinceStart(new Date()) >= totalSchoolDayMinutes;
                }

                return false;
            }

            currentPlan.days.forEach((_, dayIndex) => {
                const dayCol = div('day-col');
                const occ = new Set(); currentPlan.lessons.filter(l => l.day === dayIndex).forEach(l => { for (let i = 0; i < l.span; i++)occ.add(l.startIndex + i); });
                periods.forEach((_, pIdx) => {
                    const cell = div('cell'); cell.dataset.day = String(dayIndex); cell.dataset.period = String(pIdx);
                    const add = document.createElement('button'); add.className = 'add'; add.title = 'Fach hinzufügen'; add.textContent = '+';
                    if (occ.has(pIdx)) add.hidden = true;
                    add.addEventListener('click', e => { 
                        console.log('Add button clicked for day:', dayIndex, 'period:', pIdx);
                        e.stopPropagation(); 
                        openCreate(dayIndex, pIdx); 
                    });
                    cell.appendChild(add);

                    cell.addEventListener('dragover', e => {
                        e.preventDefault();
                        cell.classList.add('over');
                        // If a row is being dragged, show row placeholder at this period index
                        const fromRow = e.dataTransfer && e.dataTransfer.getData && e.dataTransfer.getData('text/row-index');
                        if (fromRow !== null && fromRow !== undefined && fromRow !== '') {
                            try { showPlaceholderAt(pIdx); } catch { }
                        }
                    });
                    cell.addEventListener('dragleave', () => cell.classList.remove('over'));
                    cell.addEventListener('drop', e => {
                        e.preventDefault();
                        cell.classList.remove('over');
                        // 1) Check if this is a row-reorder drop
                        const fromRowRaw = e.dataTransfer && e.dataTransfer.getData && e.dataTransfer.getData('text/row-index');
                        if (fromRowRaw !== null && fromRowRaw !== undefined && fromRowRaw !== '') {
                            const fromIdx = parseInt(fromRowRaw);
                            const toIdx = pIdx;
                            if (Number.isFinite(fromIdx) && Number.isFinite(toIdx) && fromIdx !== toIdx && isRowDragActive && !rowDropHandled && fromIdx === rowDragFromIndex) {
                                rowDropHandled = true;
                                const plan = getOrCreateWeekPlan(currentPlanWeek);
                                // Build order and mapping (true insert semantics)
                                const order = Array.from({ length: plan.periodCount }, (_, i) => i);
                                const [removed] = order.splice(fromIdx, 1);
                                order.splice(toIdx, 0, removed);
                                const indexMap = new Map(order.map((oldIdx, newIdx) => [oldIdx, newIdx]));

                                plan.lessons = plan.lessons.map(l => ({
                                    ...l,
                                    startIndex: indexMap.has(l.startIndex) ? /** @type {number} */ (indexMap.get(l.startIndex)) : l.startIndex
                                }));

                                if (Array.isArray(plan.timeSlots) && plan.timeSlots.length === plan.periodCount) {
                                    const tsOrder = Array.from({ length: plan.periodCount }, (_, i) => i);
                                    const [r] = tsOrder.splice(fromIdx, 1);
                                    tsOrder.splice(toIdx, 0, r);
                                    plan.timeSlots = tsOrder.map(i => plan.timeSlots[i]);
                                }

                                state.lessons = [...plan.lessons];
                                try { saveCurrentWeekPlan(); saveWeekPlans(); } catch { }
                                try { renderGrid(); } catch { }
                                return;
                            }
                        }

                        // 2) Otherwise, treat as lesson drop into this cell
                        const id = e.dataTransfer?.getData('text/plain');
                        if (!id) return;
                        const idx = currentPlan.lessons.findIndex(l => l.id === id);
                        if (idx < 0) return;
                        const l = { ...currentPlan.lessons[idx] };
                        l.day = dayIndex;
                        l.startIndex = clamp(pIdx, 0, currentPlan.periodCount - 1);
                        l.span = Math.min(l.span, currentPlan.periodCount - l.startIndex);
                        const next = [...currentPlan.lessons];
                        next[idx] = l;
                        currentPlan.lessons = resolveCollisions(next, currentPlan.periodCount);
                        state.lessons = [...currentPlan.lessons];
                        saveCurrentWeekPlan();
                        renderGrid();
                    });

                    // Add row highlighting on hover
                    cell.addEventListener('mouseenter', () => {
                        highlightTimetableRow(pIdx);
                    });
                    cell.addEventListener('mouseleave', () => {
                        removeTimetableRowHighlight();
                    });

                    dayCol.appendChild(cell);
                });
                console.log('Day column', dayIndex, 'created with', dayCol.children.length, 'cells');

                currentPlan.lessons.filter(l => l.day === dayIndex).forEach(l => dayCol.appendChild(renderLesson(l)));

                // Add green overlay for completed days (past days or past weeks)
                if (isDayCompleted(dayIndex)) {
                    const rowH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-h'));
                    const totalHeight = currentPlan.periodCount * rowH;

                    const completedOverlay = div('completed-day-overlay');
                    completedOverlay.style.position = 'absolute';
                    completedOverlay.style.top = '0';
                    completedOverlay.style.left = '0';
                    completedOverlay.style.width = '100%';
                    completedOverlay.style.height = totalHeight + 'px';
                    completedOverlay.style.backgroundColor = 'rgba(34, 197, 94, 0.1)';
                    completedOverlay.style.pointerEvents = 'none';
                    completedOverlay.style.zIndex = '10';
                    dayCol.appendChild(completedOverlay);

                    // Add checkmark
                    const checkmark = div('day-checkmark');
                    checkmark.textContent = '✓';
                    dayCol.appendChild(checkmark);
                }

                // red line and green overlay - only show on current day of current week
                const now = new Date();
                const weekday = ((now.getDay() + 6) % 7);
                const withinDay = minutesSinceStart(now);
                const totalSpan = currentPlan.periodCount * currentPlan.periodMinutes;

                // Check if we're in the current week
                const currentWeekKey = getCurrentWeekKey();
                const isCurrentWeek = weekKeyCompare(currentPlanWeek, currentWeekKey) === 0;

                const showRed = isCurrentWeek && weekday < currentPlan.days.length && withinDay >= 0 && withinDay <= totalSpan;

                // Add green overlay for past time on current day
                if (isCurrentWeek && weekday === dayIndex && withinDay > 0 && withinDay <= totalSpan) {
                    const rowH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-h'));
                    const actualBlockSize = currentPlan.periodMinutes; // No breaks
                    const greenHeight = clamp((withinDay / actualBlockSize) * rowH, 0, currentPlan.periodCount * rowH);

                    if (greenHeight > 0) {
                        const greenOverlay = div('green-overlay');
                        greenOverlay.style.position = 'absolute';
                        greenOverlay.style.top = '0';
                        greenOverlay.style.left = '0';
                        greenOverlay.style.width = '100%';
                        greenOverlay.style.height = greenHeight + 'px';
                        greenOverlay.style.backgroundColor = 'rgba(34, 197, 94, 0.1)';
                        greenOverlay.style.pointerEvents = 'none';
                        // Place above lessons with normal blending so it's not influenced by content
                        greenOverlay.style.zIndex = '100';
                        greenOverlay.style.mixBlendMode = 'normal';
                        dayCol.appendChild(greenOverlay);
                    }
                }

                if (showRed && weekday === dayIndex) {
                    const rowH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-h'));
                    // No breaks for redline positioning
                    const actualBlockSize = currentPlan.periodMinutes;
                    const top = clamp((withinDay / actualBlockSize) * rowH, 0, currentPlan.periodCount * rowH);
                    const rl = div('redline'); rl.style.top = top + 'px'; dayCol.appendChild(rl);
                    const updateTipText = () => { const now2 = new Date(); redlineTip.textContent = now2.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }); };
                    rl.addEventListener('mouseenter', () => { updateTipText(); redlineTip.hidden = false; const rect = dayCol.getBoundingClientRect(); redlineTip.style.left = (rect.left + rect.width / 2 + window.scrollX) + 'px'; redlineTip.style.top = (rl.getBoundingClientRect().top + window.scrollY - 6) + 'px'; });
                    rl.addEventListener('mousemove', () => { updateTipText(); const rect = dayCol.getBoundingClientRect(); redlineTip.style.left = (rect.left + rect.width / 2 + window.scrollX) + 'px'; redlineTip.style.top = (rl.getBoundingClientRect().top + window.scrollY - 6) + 'px'; });
                    rl.addEventListener('mouseleave', () => redlineTip.hidden = true);
                }
                gridEl.appendChild(dayCol);
            });
        }

        // Row highlighting functions for timetable
        function highlightTimetableRow(periodIndex) {
            // Remove any existing highlights
            removeTimetableRowHighlight();

            const grid = byId('grid');
            if (!grid) return;

            const rowH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-h'));
            const timeCol = grid.querySelector('.time-col');
            const dayCols = grid.querySelectorAll('.day-col');

            // Create highlight overlay
            const highlight = document.createElement('div');
            highlight.className = 'row-highlight timetable-row-highlight';
            highlight.id = 'timetable-row-highlight';
            highlight.style.top = (periodIndex * rowH) + 'px';
            highlight.style.height = rowH + 'px';
            highlight.style.zIndex = '5';

            // Add to each day column
            dayCols.forEach(dayCol => {
                const dayHighlight = highlight.cloneNode(true);
                dayCol.appendChild(dayHighlight);
            });

            // Also highlight the time column
            if (timeCol) {
                const timeHighlight = highlight.cloneNode(true);
                timeHighlight.style.left = '0';
                timeHighlight.style.right = '0';
                timeCol.appendChild(timeHighlight);
            }
        }

        function removeTimetableRowHighlight() {
            const highlights = document.querySelectorAll('#timetable-row-highlight, .timetable-row-highlight');
            highlights.forEach(highlight => {
                if (highlight.parentNode) {
                    highlight.parentNode.removeChild(highlight);
                }
            });
        }
        function renderLesson(lesson) {
            const currentPlan = getOrCreateWeekPlan(currentPlanWeek);
            const rowH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-h'));
            const el = div('lesson'); el.style.top = (lesson.startIndex * rowH + 2) + 'px'; el.style.height = (lesson.span * rowH - 8) + 'px'; el.style.color = lesson.color || '#60a5fa';
            el.setAttribute('data-span', String(lesson.span)); el.title = `${lesson.subject} (${lesson.span}×)`; el.draggable = true;

            // Add importance class if lesson is marked as important
            if (lesson.importance) {
                el.classList.add('important');
            }

            el.addEventListener('dragstart', (e) => {
                if (el.classList.contains('resizing')) { e.preventDefault(); return; }
                e.dataTransfer?.setData('text/plain', lesson.id); el.classList.add('dragging');
                const g = el.cloneNode(true); g.style.width = (el.getBoundingClientRect().width) + 'px'; g.style.height = (el.getBoundingClientRect().height) + 'px';
                g.style.position = 'absolute'; g.style.top = '-1000px'; g.style.left = '-1000px'; g.style.transform = 'none'; g.classList.remove('dragging'); g.style.opacity = '1'; g.style.boxShadow = '0 6px 24px rgba(0,0,0,.12)';
                document.body.appendChild(g); e.dataTransfer.setDragImage(g, 20, 20); setTimeout(() => document.body.removeChild(g), 0);
            });
            el.addEventListener('dragend', () => el.classList.remove('dragging'));
            el.addEventListener('click', () => { if (el.classList.contains('resizing')) return; openInfo(lesson.id); });
            el.addEventListener('contextmenu', (e) => { e.preventDefault(); if (el.classList.contains('resizing')) return; openEdit(lesson.id); });
            
            // Add row highlighting on hover
            el.addEventListener('mouseenter', (e) => {
                // Calculate which row the mouse is hovering over based on position
                const rect = el.getBoundingClientRect();
                const mouseY = e.clientY;
                const relativeY = mouseY - rect.top;
                const rowH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-h'));
                const hoveredRowIndex = Math.floor(relativeY / rowH);
                const actualRowIndex = lesson.startIndex + hoveredRowIndex;
                
                highlightTimetableRow(actualRowIndex);
            });
            el.addEventListener('mousemove', (e) => {
                // Update highlighting as mouse moves within the lesson cell
                const rect = el.getBoundingClientRect();
                const mouseY = e.clientY;
                const relativeY = mouseY - rect.top;
                const rowH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-h'));
                const hoveredRowIndex = Math.floor(relativeY / rowH);
                const actualRowIndex = lesson.startIndex + hoveredRowIndex;
                
                highlightTimetableRow(actualRowIndex);
            });
            el.addEventListener('mouseleave', () => {
                removeTimetableRowHighlight();
            });

            const row = div('row'); const left = div(); const subj = div('subject', lesson.subject); const sub = div('sub', lesson.teacher || ''); left.append(subj, sub);
            const room = div('room', lesson.room || ''); row.append(left, room);
            const endLabel = timeLabelFromMinutes(currentPlan.dayStart, (lesson.startIndex * (currentPlan.periodMinutes + currentPlan.breakMinutes)) + (lesson.span * currentPlan.periodMinutes));
            const footer = div('footer', `${endLabel}`);
            const colorbar = div('colorbar'); const resizer = div('resizer');
            let resizing = false; let draftSpan = lesson.span;

            function maxEndIndexForResize(base) { const nextStart = currentPlan.lessons.filter(l => l.day === base.day && l.id !== base.id && l.startIndex >= base.startIndex).reduce((min, l) => Math.min(min, l.startIndex), currentPlan.periodCount); return nextStart; }
            const onMove = (ev) => {
                if (!resizing) return; const parent = el.parentElement; if (!parent) return; const rect = parent.getBoundingClientRect();
                const y = ev.clientY - rect.top; const rawEnd = Math.ceil((y - 2) / rowH); const maxEnd = maxEndIndexForResize(lesson); const endIndex = clamp(rawEnd, lesson.startIndex + 1, maxEnd);
                const newSpan = endIndex - lesson.startIndex; if (newSpan !== draftSpan) { draftSpan = newSpan; el.style.height = (draftSpan * rowH - 8) + 'px'; footer.textContent = timeLabelFromMinutes(currentPlan.dayStart, (lesson.startIndex * (currentPlan.periodMinutes + currentPlan.breakMinutes)) + (draftSpan * currentPlan.periodMinutes)); updatePlusButtonsDuringResize(parent, lesson.startIndex, draftSpan); }
            };
            const onUp = () => {
                if (!resizing) return; resizing = false; isResizing = false; window.removeEventListener('mousemove', onMove); el.classList.remove('resizing'); el.draggable = true; document.body.style.userSelect = '';
                const updated = { ...lesson, span: draftSpan }; currentPlan.lessons = resolveCollisions(currentPlan.lessons.map(l => l.id === lesson.id ? updated : l), currentPlan.periodCount);
                // Sync state.lessons with currentPlan.lessons for immediate "Als Nächstes" updates
                state.lessons = [...currentPlan.lessons];
                saveCurrentWeekPlan(); renderGrid();
            };
            resizer.addEventListener('mousedown', (e) => {
                console.log('Resizer mousedown event fired!', e);
                e.stopPropagation();
                e.preventDefault();
                resizing = true;
                draftSpan = lesson.span;
                isResizing = true;
                el.classList.add('resizing');
                el.draggable = false;
                document.body.style.userSelect = 'none';
                window.addEventListener('mousemove', onMove);
                window.addEventListener('mouseup', onUp, { once: true });
            });
            el.append(colorbar, row, footer, resizer); return el;
        }
        function updatePlusButtonsDuringResize(dayCol, startIndex, span) { const cells = [...dayCol.querySelectorAll('.cell')]; cells.forEach(c => { const btn = c.querySelector('.add'); if (btn) btn.hidden = false; }); for (let i = 0; i < span; i++) { const c = dayCol.querySelector(`.cell[data-period="${startIndex + i}"] .add`); if (c) c.hidden = true; } }
        function formatRange(l) { const currentPlan = getOrCreateWeekPlan(currentPlanWeek); const startMin = l.startIndex * (currentPlan.periodMinutes + currentPlan.breakMinutes); const endMin = startMin + l.span * currentPlan.periodMinutes; return `${timeLabelFromMinutes(currentPlan.dayStart, startMin)}–${timeLabelFromMinutes(currentPlan.dayStart, endMin)}`; }
        function hasOverlap(occ, day, start, span) { for (let i = 0; i < span; i++) if (occ.has(`${day}:${start + i}`)) return true; return false; }
        function occupiedSet(occ, day, start, span, l) { for (let i = 0; i < span; i++) occ.set(`${day}:${start + i}`, l); }
        function resolveCollisions(list, maxPeriods) { const arr = [...list].sort((a, b) => a.startIndex - b.startIndex); const occ = new Map(); for (const l of arr) { let s = l.startIndex; while (hasOverlap(occ, l.day, s, l.span)) s = Math.min(s + 1, maxPeriods - l.span); l.startIndex = s; occupiedSet(occ, l.day, s, l.span, l); } return [...arr]; }

        function currentLessonInfo() { const currentPlan = getOrCreateWeekPlan(currentPlanWeek); const now = new Date(); const weekday = ((now.getDay() + 6) % 7); const nowMin = minutesSinceStart(now); const cand = currentPlan.lessons.filter(l => l.day === weekday); for (const l of cand) { const start = l.startIndex * (currentPlan.periodMinutes + currentPlan.breakMinutes); const end = start + (l.span * currentPlan.periodMinutes); if (nowMin >= start && nowMin <= end) { const elapsed = Math.floor(nowMin - start); const total = end - start; return { l, elapsed, total, now }; } } return null; }
        function renderCurrent() {
            const currentWrap = byId('currentWrap');
            const currentBannerWrap = byId('currentBannerWrap');
            if (!currentWrap || !currentBannerWrap) return;
            currentWrap.innerHTML = '';
            currentBannerWrap.innerHTML = '';

            // First check if there's a current lesson
            const currentInfo = currentLessonInfo();
            if (currentInfo) {
                // No banner; only render the current progress stripe
                const stripe = div('current-stripe');

                // Set progress width as CSS custom property
                const progressPercent = ((currentInfo.elapsed / currentInfo.total) * 100) + '%';
                stripe.style.setProperty('--progress-width', progressPercent);


                // Left content
                const leftContent = div('current-left');
                const subjectContainer = div('current-subject-container');
                const subject = div('current-subject', currentInfo.l.subject);
                const roomTeacher = div('current-room-teacher');
                const room = div('current-room', currentInfo.l.room || '—');
                const teacher = div('current-teacher', currentInfo.l.teacher || '—');
                roomTeacher.appendChild(room);
                roomTeacher.appendChild(teacher);
                subjectContainer.appendChild(subject);
                subjectContainer.appendChild(roomTeacher);
                const timeRange = div('current-time-range', formatRange(currentInfo.l));
                leftContent.appendChild(subjectContainer);
                leftContent.appendChild(timeRange);

                // Right content
                const rightContent = div('current-right');
                const time = div('current-time', currentInfo.now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                rightContent.appendChild(time);

                stripe.appendChild(leftContent);
                stripe.appendChild(rightContent);

                // Add click functionality to open folder for this subject
                stripe.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Timetable entry clicked for subject:', currentInfo.l.subject);
                    const folder = findFolderForSubject(currentInfo.l.subject);
                    if (folder) {
                        console.log('Opening existing folder:', folder.name);
                        byId('navFolders')?.click();
                        openFolderDetail(folder.id);
                    } else {
                        console.log('Creating new folder for:', currentInfo.l.subject);
                        // Create new folder for this subject
                        byId('navFolders')?.click();
                        openFolderEdit(null);
                        setTimeout(() => {
                            const nameInput = byId('folderNameInput');
                            const colorInput = byId('folderColorInput');
                            if (nameInput) nameInput.value = currentInfo.l.subject;
                            if (colorInput) colorInput.value = currentInfo.l.color || colorForSubject(currentInfo.l.subject);
                        }, 100);
                    }
                });

                currentWrap.appendChild(stripe);
                return;
            }

            // No current lesson - show next upcoming lesson
            const nextInfo = getCurrentOrNextLesson();
            if (nextInfo) {
                // Clear banner since no current lesson
                currentBannerWrap.innerHTML = '';

                const stripe = div('current-stripe');

                // Set progress width to 0% for future lessons
                stripe.style.setProperty('--progress-width', '0%');

                // Status badge
                const status = div('current-status', 'Als Nächstes');

                // Left content
                const leftContent = div('current-left');
                const subjectContainer = div('current-subject-container');
                const subject = div('current-subject', nextInfo.l.subject);
                const roomTeacher = div('current-room-teacher');
                const room = div('current-room', nextInfo.l.room || '—');
                const teacher = div('current-teacher', nextInfo.l.teacher || '—');
                roomTeacher.appendChild(room);
                roomTeacher.appendChild(teacher);
                subjectContainer.appendChild(subject);
                subjectContainer.appendChild(roomTeacher);
                const timeRange = div('current-time-range', `${timeLabelFromMinutes(state.dayStart, nextInfo.start)}-${timeLabelFromMinutes(state.dayStart, nextInfo.end)}`);
                leftContent.appendChild(subjectContainer);
                leftContent.appendChild(timeRange);

                // Right content
                const rightContent = div('current-right');
                const now = new Date();
                const time = div('current-time', now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                rightContent.appendChild(time);

                stripe.appendChild(status);
                stripe.appendChild(leftContent);
                stripe.appendChild(rightContent);

                // Add click functionality to open folder for this subject
                stripe.addEventListener('click', (e) => {
                    e.preventDefault();
                    const folder = findFolderForSubject(nextInfo.l.subject);
                    if (folder) {
                        byId('navFolders')?.click();
                        openFolderDetail(folder.id);
                    } else {
                        // Create new folder for this subject
                        byId('navFolders')?.click();
                        openFolderEdit(null);
                        setTimeout(() => {
                            const nameInput = byId('folderNameInput');
                            const colorInput = byId('folderColorInput');
                            if (nameInput) nameInput.value = nextInfo.l.subject;
                            if (colorInput) colorInput.value = nextInfo.l.color || colorForSubject(nextInfo.l.subject);
                        }, 100);
                    }
                });

                currentWrap.appendChild(stripe);
            } else {
                // No lessons at all
                // Clear banner since no lessons
                currentBannerWrap.innerHTML = '';

                const stripe = div('current-stripe');

                // Set progress width to 0% for empty state
                stripe.style.setProperty('--progress-width', '0%');

                // Left content
                const leftContent = div('current-left');
                const subject = div('current-subject', 'Keine Stunden geplant'); // keep subject line
                leftContent.appendChild(subject);

                // Right content
                const rightContent = div('current-right');
                const time = div('current-time', new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                rightContent.appendChild(time);

                stripe.appendChild(leftContent);
                stripe.appendChild(rightContent);
                currentWrap.appendChild(stripe);
            }
        }

        /* INFO / EDIT / CREATE */
        const infoModal = byId('infoModal'); const iSubject = byId('iSubject'); const iTeacher = byId('iTeacher'); const iRoom = byId('iRoom'); const iDay = byId('iDay'); const iTime = byId('iTime'); const iDuration = byId('iDuration'); const infoColor = byId('infoColor'); const infoEditBtn = byId('infoEdit'); const infoDeleteBtn = byId('infoDelete'); let infoId = null;
        function openInfo(id) {
            const currentPlan = getOrCreateWeekPlan(currentPlanWeek);
            const l = currentPlan.lessons.find(x => x.id === id); if (!l) return; infoId = id; iSubject.textContent = l.subject || '—'; iTeacher.textContent = l.teacher || '—'; iRoom.textContent = l.room || '—'; iDay.textContent = currentPlan.days[l.day] ?? `Tag ${l.day + 1}`; iTime.textContent = formatRange(l); const totalMin = l.span * currentPlan.periodMinutes; iDuration.textContent = `${totalMin} Min (${l.span} × ${currentPlan.periodMinutes} Min)`; infoColor.style.background = l.color || '#e5e7eb';

            // Show/hide importance field
            const importanceField = byId('iImportanceField');
            if (l.importance) {
                importanceField.style.display = 'block';
            } else {
                importanceField.style.display = 'none';
            }

            showModal(infoModal, '[data-close]');
        }
        infoEditBtn.addEventListener('click', () => { if (!infoId) return; hideModal(infoModal); openEdit(infoId); });
        infoDeleteBtn.addEventListener('click', () => { if (!infoId) return; const id = infoId; infoId = null; removeLesson(id); });

        const editModal = byId('editModal'); const fSubject = byId('fSubject'); const fTeacherSel = byId('fTeacherSel'); const fRoom = byId('fRoom'); const fColor = byId('fColor'); const timePreview = byId('timePreview'); const roomList = byId('roomList'); let editId = null;
        function renderTeacherSelect(selected) {
            if (!fTeacherSel) return;
            fTeacherSel.innerHTML = ''; const optNone = document.createElement('option'); optNone.value = ''; optNone.textContent = '— (keine Auswahl)'; fTeacherSel.appendChild(optNone);
            dataState.teachers.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; if (selected && selected === t) o.selected = true; fTeacherSel.appendChild(o); });
            if (roomList) {
                roomList.innerHTML = ''; dataState.rooms.forEach(r => { const o = document.createElement('option'); o.value = r; roomList.appendChild(o); });
            }
        }
        function openEdit(id) {
            const currentPlan = getOrCreateWeekPlan(currentPlanWeek);
            const l = currentPlan.lessons.find(x => x.id === id); if (!l) return;
            isCreating = false; creatingDraft = null; editId = id;

            fSubject.value = l.subject || '';
            fRoom.value = l.room || '';
            renderTeacherSelect(l.teacher || '');

            const col = colorForSubject(l.subject) || l.color || '#60a5fa';
            if (fColorSwatch) fColorSwatch.style.background = col;

            // Set importance checkbox
            const fImportance = byId('fImportance');
            if (fImportance) fImportance.checked = !!l.importance;

            timePreview.textContent = `Zeit: ${formatRange(l)}`;

            document.querySelector('#editModal h2').textContent = 'Fach bearbeiten';
            byId('deleteLesson').style.display = '';
            byId('saveLesson').textContent = 'Speichern';

            showModal(editModal, '#fSubject');
        }

        // Whenever the subject changes in the modal, pull preset + color if available
        fSubject?.addEventListener('input', () => {
            const subj = (fSubject.value || '').trim();
            const p = findPresetForSubject(subj);
            if (p?.teacher) fTeacherSel.value = p.teacher;
            if (p?.room) fRoom.value = p.room;
            // set swatch only (no manual input)
            if (fColorSwatch) fColorSwatch.style.background = colorForSubject(subj);
        });

        function updateLessonFromForm() {
            console.log('updateLessonFromForm called');
            console.log('Current state:', { isCreating, editId, creatingDraft });

            try {
                // Check if required elements exist
                if (!fSubject) {
                    console.error('fSubject not found');
                    alert('Error: Subject input not found. Please refresh the page.');
                    return;
                }

                const subject = (fSubject.value || '').trim() || 'Fach';
                const teacher = fTeacherSel ? fTeacherSel.value || '' : '';
                const room = fRoom ? (fRoom.value || '').trim() : '';
                const color = colorForSubject(subject);
                const importance = byId('fImportance')?.checked || false;

                console.log('Form data:', { subject, teacher, room, color, importance });

                const currentPlan = getOrCreateWeekPlan(currentPlanWeek);
                console.log('Current plan:', currentPlan);

                if (isCreating && creatingDraft) {
                    console.log('Creating new lesson...');
                    const l = {
                        id: uid(),
                        subject,
                        teacher,
                        room,
                        color,
                        day: creatingDraft.day,
                        startIndex: creatingDraft.startIndex,
                        span: creatingDraft.span,
                        importance
                    };
                    console.log('New lesson:', l);

                    // Check for conflicts before adding
                    const hasConflict = currentPlan.lessons.some(existing => 
                        existing.day === l.day && 
                        existing.startIndex < l.startIndex + l.span && 
                        existing.startIndex + existing.span > l.startIndex
                    );

                    if (hasConflict) {
                        console.warn('Conflict detected, resolving...');
                    }

                    currentPlan.lessons = resolveCollisions([...currentPlan.lessons, l], currentPlan.periodCount);
                    // Sync state.lessons with currentPlan.lessons for immediate "Als Nächstes" updates
                    state.lessons = [...currentPlan.lessons];

                    console.log('Lesson added, current plan lessons:', currentPlan.lessons.length);

                    // Add activity
                    addActivity('lesson_added', 'Stunde hinzugefügt', `${subject} am ${getDayName(creatingDraft.day)}`, 'plus');
                } else if (editId) {
                    console.log('Editing existing lesson:', editId);
                    const l = currentPlan.lessons.find(x => x.id === editId);
                    if (!l) {
                        console.error('Lesson not found for edit:', editId);
                        alert('Error: Lesson not found. Please try again.');
                        return;
                    }
                    const oldSubject = l.subject;
                    l.subject = subject; 
                    l.teacher = teacher; 
                    l.room = room; 
                    l.color = color; 
                    l.importance = importance;
                    currentPlan.lessons = currentPlan.lessons.map(x => x.id === l.id ? { ...l } : x);
                    // Sync state.lessons with currentPlan.lessons for immediate "Als Nächstes" updates
                    state.lessons = [...currentPlan.lessons];

                    // Add activity
                    addActivity('lesson_edited', 'Stunde bearbeitet', `${oldSubject} → ${subject}`, 'edit');
                } else {
                    console.warn('Neither creating nor editing - no action taken');
                    alert('Error: No action to perform. Please try again.');
                    return;
                }

                isCreating = false; 
                creatingDraft = null; 
                editId = null;
                console.log('Saving and rendering...');
                saveCurrentWeekPlan();
                renderGrid();
                hideModal(editModal);
                console.log('Lesson form update completed successfully');
            } catch (error) {
                console.error('Error in updateLessonFromForm:', error);
                alert('Error saving lesson: ' + error.message + '. Please try again.');
            }
        }

        function currentOrNextLesson() {
            const now = new Date();
            const today = (now.getDay() + 6) % 7; // Mo=0
            const nowMin = minutesSinceStart(now);
            const currentWeekKey = getCurrentWeekKey();

            // 1) Check current week for lesson happening right now
            const currentPlan = weekPlans.get(currentWeekKey);
            if (currentPlan) {
                const todayLs = currentPlan.lessons.filter(l => l.day === today);
                for (const l of todayLs) {
                    const start = l.startIndex * (currentPlan.periodMinutes + currentPlan.breakMinutes);
                    const end = start + l.span * currentPlan.periodMinutes;
                    if (nowMin >= start && nowMin < end) {
                        return { type: "now", l, start, end, dayIndex: today, offset: 0 };
                    }
                }
            }

            // 2) Search for next lesson across ALL weeks
            const allUpcomingLessons = [];

            // Get all week keys and sort them chronologically
            const allWeekKeys = Array.from(weekPlans.keys()).sort((a, b) => weekKeyCompare(a, b));

            // Find current week index and check from there onwards
            const currentWeekIndex = allWeekKeys.findIndex(key => key === currentWeekKey);
            const weeksToCheck = allWeekKeys.slice(Math.max(0, currentWeekIndex));

            for (const weekKey of weeksToCheck) {
                const plan = weekPlans.get(weekKey);
                if (!plan || !plan.lessons.length) continue;

                const weekOffset = weekKeyCompare(weekKey, currentWeekKey);
                for (const l of plan.lessons) {
                    const start = l.startIndex * (plan.periodMinutes + plan.breakMinutes);
                    const end = start + l.span * plan.periodMinutes;

                    // Skip if this is in the past (only for current week)
                    if (weekOffset === 0) {
                        if (l.day < today) continue;
                        if (l.day === today && start <= nowMin) continue;
                    }

                    // Calculate actual day offset from today
                    const currentDay = (now.getDay() + 6) % 7; // Monday = 0
                    const daysFromToday = (weekOffset * 7) + l.day - currentDay;

                    allUpcomingLessons.push({
                        l,
                        start,
                        end,
                        dayIndex: l.day,
                        offset: Math.max(0, daysFromToday)
                    });
                }
            }

            // Sort by week offset first, then by day, then by start time
            allUpcomingLessons.sort((a, b) => {
                if (a.offset !== b.offset) return a.offset - b.offset;
                if (a.dayIndex !== b.dayIndex) return a.dayIndex - b.dayIndex;
                return a.start - b.start;
            });

            if (allUpcomingLessons.length > 0) {
                return { type: "next", ...allUpcomingLessons[0] };
            }

            return null;
        }

        function findFolderForSubject(subject) {
            const s = (subject || "").trim().toLowerCase();
            return folderState.folders.find(f => (f.name || "").trim().toLowerCase() === s) || null;
        }



        function removeLesson(id) {
            const currentPlan = getOrCreateWeekPlan(currentPlanWeek);
            const lesson = currentPlan.lessons.find(l => l.id === id);
            currentPlan.lessons = currentPlan.lessons.filter(l => l.id !== id);
            // Sync state.lessons with currentPlan.lessons for immediate "Als Nächstes" updates
            state.lessons = [...currentPlan.lessons];
            saveCurrentWeekPlan();
            renderGrid();
            hideModal(editModal);
            hideModal(infoModal);

            // Add activity
            if (lesson) {
                addActivity('lesson_deleted', 'Stunde gelöscht', `${lesson.subject} am ${getDayName(lesson.day)}`, 'trash');
            }
        }
        function openCreate(day, periodIndex) {
            console.log('openCreate called with:', { day, periodIndex });

            try {
                // Check if required elements exist
                if (!editModal) {
                    console.error('editModal not found');
                    alert('Error: Modal element not found. Please refresh the page.');
                    return;
                }
                if (!fSubject) {
                    console.error('fSubject not found');
                    alert('Error: Subject input not found. Please refresh the page.');
                    return;
                }

                // Ensure modal is properly initialized
                if (editModal.getAttribute('aria-hidden') === null) {
                    editModal.setAttribute('aria-hidden', 'true');
                }

                const defaultSubject = dataState.subjects[0] || 'Neues Fach';
                const preset = findPresetForSubject(defaultSubject);
                const suggestedColor = colorForSubject(defaultSubject);

                console.log('Setting up create state:', { defaultSubject, suggestedColor });

                isCreating = true;
                creatingDraft = { day, startIndex: periodIndex, span: 1, color: suggestedColor };

                editId = null;
                fSubject.value = defaultSubject;
                renderTeacherSelect(preset?.teacher || '');
                fRoom.value = preset?.room || '';
                if (fColorSwatch) fColorSwatch.style.background = suggestedColor;

                // Reset importance checkbox
                const fImportance = byId('fImportance');
                if (fImportance) fImportance.checked = false;

                const timeText = `Zeit: ${timeLabelFromMinutes(dayStart, (periodIndex * (state.periodMinutes + state.breakMinutes)))}–` +
                    `${timeLabelFromMinutes(dayStart, (periodIndex * (state.periodMinutes + state.breakMinutes)) + state.periodMinutes)}`;
                
                if (timePreview) {
                    timePreview.textContent = timeText;
                } else {
                    console.warn('timePreview element not found');
                }

                const modalTitle = document.querySelector('#editModal h2');
                if (modalTitle) {
                    modalTitle.textContent = 'Fach anlegen';
                }

                const deleteBtn = byId('deleteLesson');
                if (deleteBtn) {
                    deleteBtn.style.display = 'none';
                }

                const saveBtn = byId('saveLesson');
                if (saveBtn) {
                    saveBtn.textContent = 'Anlegen';
                }

                console.log('Showing edit modal...');
                
                // Try to show modal with error handling
                try {
                    showModal(editModal, '#fSubject');
                    console.log('Edit modal shown successfully');
                } catch (modalError) {
                    console.error('Error showing modal:', modalError);
                    // Fallback: manually show the modal
                    editModal.setAttribute('aria-hidden', 'false');
                    document.body.style.overflow = 'hidden';
                    const subjectInput = editModal.querySelector('#fSubject');
                    if (subjectInput) {
                        setTimeout(() => subjectInput.focus(), 100);
                    }
                    console.log('Modal shown using fallback method');
                }
            } catch (error) {
                console.error('Error in openCreate:', error);
                alert('Error opening create dialog: ' + error.message + '. Please try again.');
            }
        }

        byId('saveLesson')?.addEventListener('click', updateLessonFromForm);
        byId('deleteLesson')?.addEventListener('click', () => { if (editId) removeLesson(editId); });
        editModal.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); updateLessonFromForm(); } });
        
        // Ensure close buttons work properly
        document.querySelectorAll('[data-close]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const modal = btn.closest('.modal');
                if (modal) {
                    console.log('Closing modal via data-close button');
                    hideModal(modal);
                }
            });
        });
        
        // Additional direct listener for cancel button in edit modal
        const cancelBtn = editModal.querySelector('button[data-close]');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', (e) => {
                e.preventDefault();
                console.log('Cancel button clicked directly');
                hideModal(editModal);
            });
        }

        // --- Activity Tracking System ---------------------------------

        function addActivity(type, title, description, icon = 'document') {
            const activities = JSON.parse(localStorage.getItem('recentActivities') || '[]');
            const now = new Date();

            const activity = {
                id: Date.now(),
                type: type,
                title: title,
                description: description,
                icon: icon,
                timestamp: now.toISOString(),
                timeAgo: getTimeAgo(now)
            };

            // Add to beginning of array
            activities.unshift(activity);

            // Keep only last 10 activities
            if (activities.length > 10) {
                activities.splice(10);
            }

            // Save to localStorage
            localStorage.setItem('recentActivities', JSON.stringify(activities));

            // Update display
            updateActivityDisplay();
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);

            if (diffMins < 1) return 'Gerade eben';
            if (diffMins < 60) return `Vor ${diffMins} Min`;
            if (diffHours < 24) return `Vor ${diffHours} Std`;
            if (diffDays < 7) return `Vor ${diffDays} Tag${diffDays > 1 ? 'en' : ''}`;
            return date.toLocaleDateString('de-DE');
        }

        function updateActivityDisplay() {
            const container = byId('recentActivity');
            if (!container) return;

            const activities = JSON.parse(localStorage.getItem('recentActivities') || '[]');

            if (activities.length === 0) {
                container.innerHTML = `
                    <div class="activity-item">
                        <div class="activity-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14,2 14,8 20,8"></polyline>
                            </svg>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Willkommen bei stunova!</div>
                            <div class="activity-description">Erstelle deinen ersten Stundenplan oder lade Daten aus einer Datei hoch.</div>
                            <div class="activity-time">Gerade eben</div>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = activities.map(activity => {
                const iconSvg = getActivityIcon(activity.icon);
                return `
                    <div class="activity-item">
                        <div class="activity-icon">
                            ${iconSvg}
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-description">${activity.description}</div>
                            <div class="activity-time">${activity.timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getActivityIcon(iconType) {
            const icons = {
                'document': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14,2 14,8 20,8"></polyline>
                </svg>`,
                'plus': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>`,
                'edit': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>`,
                'trash': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3,6 5,6 21,6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>`,
                'calendar': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>`,
                'settings': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>`
            };
            return icons[iconType] || icons['document'];
        }

        function getDayName(dayIndex) {
            const days = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
            return days[dayIndex] || 'Unbekannt';
        }

        // --- helpers (singleton listeners) ---------------------------------
        const OPEN_KEY = 'sidebar_open_states_v1';
        let openStates = {};
        try { openStates = JSON.parse(localStorage.getItem(OPEN_KEY) || '{}'); } catch { openStates = {}; }
        const saveOpenStates = () => localStorage.setItem(OPEN_KEY, JSON.stringify(openStates));

        let accordionHandlersInstalled = false;
        let sidebarOutsideHandler = null;
        let sidebarEscHandler = null;

        function installAccordionGlobalHandlers() {
            if (accordionHandlersInstalled) return; // prevent stacking
            const acc = document.getElementById('dataSidebar');
            if (!acc) return;

            sidebarOutsideHandler = (e) => {
                if (!e.target.closest('#dataSidebar')) {
                    acc.querySelectorAll('details[open]').forEach(d => {
                        d.open = false;
                        const key = d.dataset.groupKey;
                        if (key) openStates[key] = false;
                    });
                    saveOpenStates();
                }
            };
            document.addEventListener('mousedown', sidebarOutsideHandler);

            sidebarEscHandler = (e) => {
                if (e.key === 'Escape') {
                    acc.querySelectorAll('details[open]').forEach(d => {
                        d.open = false;
                        const key = d.dataset.groupKey;
                        if (key) openStates[key] = false;
                    });
                    saveOpenStates();
                }
            };
            window.addEventListener('keydown', sidebarEscHandler);

            accordionHandlersInstalled = true;
        }

        /* =================== DATEN-SEITENLEISTE (foldable) =================== */
        const dataSidebar = byId('dataSidebar');
        function renderDataSidebar() {
            if (!dataSidebar) return;
            dataSidebar.innerHTML = '';

            const groups = [
                { key: 'teachers', label: 'Lehrkräfte' },
                { key: 'rooms', label: 'Räume' },
                { key: 'subjects', label: 'Fächer (Vorlagen)' },
                { key: 'classes', label: 'Klassen' }
            ];

            groups.forEach(g => {
                const det = document.createElement('details');
                det.dataset.groupKey = g.key;
                det.open = openStates[g.key] !== undefined ? !!openStates[g.key] : true;

                const sum = document.createElement('summary');
                sum.textContent = g.label;

                // Prevent closing when already open; allow opening when closed
                sum.addEventListener('click', (e) => {
                    if (det.open) {           // currently open -> keep open
                        e.preventDefault();
                        e.stopPropagation();
                    }
                    // if closed, native toggle will open it; we sync state on 'toggle'
                });

                det.addEventListener('toggle', () => {
                    openStates[g.key] = det.open;
                    saveOpenStates();
                });

                det.appendChild(sum);

                const list = document.createElement('div');
                list.className = 'side-list';

                const arr = dataState[g.key];
                arr.forEach((val, idx) => {
                    const row = document.createElement('div'); row.className = 'side-row';
                    const inp = document.createElement('input'); inp.value = val;
                    const del = document.createElement('button'); del.className = 'btn mini danger'; del.textContent = 'Löschen';

                    del.addEventListener('click', () => {
                        arr.splice(idx, 1);
                        saveData();
                        renderDataSidebar();
                        renderTeacherSelect();
                    });
                    inp.addEventListener('input', () => {
                        arr[idx] = inp.value;
                        saveData();
                        renderTeacherSelect();
                    });

                    row.append(inp, del);
                    list.appendChild(row);
                });

                const addRow = document.createElement('div'); addRow.className = 'side-row';
                const addInp = document.createElement('input'); addInp.placeholder = `Neu (${g.label.slice(0, -1)})`;
                const addBtn = document.createElement('button'); addBtn.className = 'btn mini primary'; addBtn.textContent = 'Hinzufügen';

                const doAdd = () => {
                    const v = (addInp.value || '').trim();
                    if (!v) return;
                    if (!arr.includes(v)) arr.push(v);
                    addInp.value = '';
                    saveData();
                    renderDataSidebar();
                    renderTeacherSelect();
                };
                addBtn.addEventListener('click', doAdd);
                addInp.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); doAdd(); } });

                addRow.append(addInp, addBtn);
                list.appendChild(addRow);

                det.appendChild(list);
                dataSidebar.appendChild(det);
            });

            // ensure outside click / Esc behaviour stays wired after every render
            installAccordionGlobalHandlers();
        }

        function renderSettingsStats() {
            // Update settings stats cards
            byId('settingsDaysCount').textContent = state.days.length;
            byId('settingsPeriodLength').textContent = state.periodMinutes;
            byId('settingsPeriodCount').textContent = state.periodCount;
            byId('settingsBreakLength').textContent = state.breakMinutes;
        }

        function upcomingLessons(max = 3) {
            const now = new Date();
            const todayIdx = (now.getDay() + 6) % 7;
            const nowMin = minutesSinceStart(now);

            // alle kommenden (inkl. aktuell laufend)
            const result = [];
            for (let offset = 0; offset < 14 && result.length < max; offset++) {
                const dayIndex = (todayIdx + offset) % state.days.length;
                const list = state.lessons
                    .filter(l => l.day === dayIndex)
                    .map(l => {
                        const startMin = l.startIndex * (state.periodMinutes + state.breakMinutes);
                        const endMin = startMin + l.span * state.periodMinutes;
                        const isToday = offset === 0;
                        const type = isToday && nowMin >= startMin && nowMin < endMin ? 'now' : 'next';
                        return { l, dayIndex, startMin, endMin, offset, type };
                    })
                    .filter(x => x.type === 'now' || x.offset > 0 || (x.offset === 0 && x.startMin >= nowMin))
                    .sort((a, b) => a.startMin - b.startMin);

                for (const it of list) {
                    result.push(it);
                    if (result.length >= max) break;
                }
            }
            return result;
        }
        function folderChipHtml(subject) {
            const folder = findFolderForSubject(subject);
            if (!folder) {
                return `<button class="btn mini primary" id="ovHeroCreateFolder">Ordner anlegen</button>`;
            }
            const col = folder.color || '#e2e8f0';
            return `<span class="folder-chip clickable" id="ovHeroFolder" data-folder-id="${folder.id}" style="--col:${col}">
                <span class="swatch"></span>${folder.name}
            </span>`;
        }
        function renderHeroSingle() {
            const info = getCurrentOrNextLesson();
            const heroSub = byId('ovHeroSub');

            if (!info) {
                heroSub.innerHTML = 'Heute: <strong>keine Stunde mehr</strong>.';
                return;
            }

            const { l, type, start, end, offset } = info;
            const startLbl = timeLabelFromMinutes(dayStart, start);
            const endLbl = timeLabelFromMinutes(dayStart, end);
            const dayLbl =
                type === 'now' ? 'Jetzt' :
                    offset === 0 ? 'Als Nächstes' :
                        offset === 1 ? 'Morgen' :
                            (state.days[(l.day)] || `Tag ${l.day + 1}`);

            const rest = type === 'now'
                ? ` <span class="meta">(${Math.max(0, Math.ceil(end - minutesSinceStart(new Date())))} Min übrig)</span>`
                : '';

            heroSub.innerHTML = `${dayLbl}: <strong>${l.subject}</strong> · ${startLbl}–${endLbl} · Raum ${l.room || '–'} · ${l.teacher || ''}${rest}
                        &nbsp; ${folderChipHtml(l.subject)}`;
        }

        function buildHeroSingleHtml() {
            const info = getCurrentOrNext();
            if (!info) return 'Heute: <strong>keine Stunde mehr</strong>.';

            const { l } = info;
            const start = timeLabelFromMinutes(dayStart, info.startMin);
            const end = timeLabelFromMinutes(dayStart, info.endMin);

            const label =
                info.type === 'now' ? 'Jetzt' :
                    info.offset === 0 ? 'Als Nächstes' :
                        info.offset === 1 ? 'Morgen' :
                            (state.days[info.dayIndex] || `Tag ${info.dayIndex + 1}`);

            const rest = info.type === 'now'
                ? ` <span class="meta">(${Math.max(0, Math.ceil(info.endMin - minutesSinceStart(new Date())))} Min übrig)</span>`
                : '';

            return `<div><strong>${label}:</strong> ${l.subject} · ${start}–${end} · Raum ${l.room || '–'} · ${l.teacher || ''}${rest}
                    &nbsp; ${folderChipHtml(l.subject)}</div>`;
        }

        function buildHeroListHtml() {
            const items = upcomingLessons(3);
            if (!items.length) return 'Heute: <strong>keine Stunde mehr</strong>.';

            const li = items.map(info => {
                const { l } = info;
                const start = timeLabelFromMinutes(dayStart, info.startMin);
                const end = timeLabelFromMinutes(dayStart, info.endMin);

                const dayLabel =
                    info.type === 'now' ? 'Jetzt' :
                        info.offset === 0 ? 'Als Nächstes' :
                            info.offset === 1 ? 'Morgen' :
                                (state.days[info.dayIndex] || `Tag ${info.dayIndex + 1}`);

                // optional: Restzeit bei "Jetzt"
                const rest = info.type === 'now'
                    ? ` <span class="meta">(${Math.max(0, Math.ceil(info.endMin - minutesSinceStart(new Date())))} Min übrig)</span>`
                    : '';

                return `<li>
        <strong>${dayLabel}:</strong> ${l.subject} · ${start}–${end} · Raum ${l.room || '–'} · ${l.teacher || ''}${rest}
        &nbsp; ${folderChipHtml(l.subject)}
        </li>`;
            });

            return `<ul>${li.join('')}</ul>`;
        }

        function getCurrentOrNext() {
            const now = new Date();
            const todayIdx = (now.getDay() + 6) % 7;
            const nowMin = minutesSinceStart(now);

            // 1) Läuft gerade (heute)?
            const today = state.lessons
                .filter(l => l.day === todayIdx)
                .map(l => {
                    const startMin = l.startIndex * (state.periodMinutes + state.breakMinutes);
                    const endMin = startMin + l.span * state.periodMinutes;
                    return { l, dayIndex: todayIdx, startMin, endMin, offset: 0 };
                })
                .sort((a, b) => a.startMin - b.startMin);

            const running = today.find(x => nowMin >= x.startMin && nowMin < x.endMin);
            if (running) return { ...running, type: 'now' };

            // 2) Nächste Stunde ab jetzt vorwärts suchen (heute inkl. nach jetzt)
            for (let offset = 0; offset < 14; offset++) {
                const d = (todayIdx + offset) % state.days.length;
                const list = state.lessons
                    .filter(l => l.day === d)
                    .map(l => {
                        const startMin = l.startIndex * (state.periodMinutes + state.breakMinutes);
                        const endMin = startMin + l.span * state.periodMinutes;
                        return { l, dayIndex: d, startMin, endMin, offset };
                    })
                    .filter(x => offset > 0 ? true : x.startMin >= nowMin)
                    .sort((a, b) => a.startMin - b.startMin);

                if (list.length) return { ...list[0], type: 'next' };
            }

            return null; // gar nichts in den nächsten 2 Wochen
        }
        function renderHeroCompact() {
            const host = byId('ovHeroSub');
            const info = currentOrNextLesson();

            if (!info) {
                host.innerHTML = `<div class="hero-compact">
                                    <div>
                                    <div class="hc-title">Heute: keine Stunde mehr</div>
                                    <div class="hc-meta">Alles erledigt ✨</div>
                                    </div>
                                    <div style="width:56px;height:56px"></div>
                                </div>`;
                return;
            }

            const { l, type, start, end, dayIndex, offset } = info;
            const title = (type === 'now') ? 'Jetzt' : (offset === 0 ? 'Als Nächstes' : (offset === 1 ? 'Morgen' : (state.days[dayIndex] || 'Demnächst')));
            const startLbl = timeLabelFromMinutes(dayStart, start);
            const endLbl = timeLabelFromMinutes(dayStart, end);
            const dayLbl = state.days[dayIndex] || `Tag ${dayIndex + 1}`;

            const meta = `${dayLbl}: <strong>${l.subject}</strong> ${startLbl}–${endLbl} | Raum ${l.room || '–'} · ${l.teacher || ''}`;

            // folder tile
            const folder = findFolderForSubject(l.subject);
            const col = folder?.color || '#e5e7eb';
            const rightHtml = folder
                ? `<button class="folder-tile" id="ovHeroFolder" data-folder-id="${folder.id}" style="--col:${col}">
                        <span class="swatch"></span>
                    </button>`
                : `<button class="folder-tile" id="ovHeroCreateFolder" style="--col:#e5e7eb" title="Ordner anlegen">
                        <span class="swatch"></span>
                    </button>`;

            host.innerHTML = `<div class="hero-compact">
                    <div>
                        <div class="hc-title">${title}</div>
                        <div class="hc-meta">${meta}</div>
                    </div>
                    ${rightHtml}
                </div>`;

            // clicks
            byId('ovHeroFolder')?.addEventListener('click', (e) => {
                const id = e.currentTarget.getAttribute('data-folder-id');
                if (id) { byId('navFolders').click(); openFolderDetail(id); }
            });
            byId('ovHeroCreateFolder')?.addEventListener('click', () => {
                // prefill with subject name + color
                byId('navFolders').click();
                openFolderEdit(null);
                folderNameInput.value = l.subject || 'Neuer Ordner';
                folderColorInput.value = col;
            });
        }

        /* =================== ANALYSIS =================== */
        function renderAnalysis() {
            // Get current week's plan for analysis
            const currentPlan = getDisplayWeekPlan();

            // Calculate statistics
            const weekStats = calcWeekStatsFor(currentPlan);
            const busyFree = calcBusyFreeBlocksFor(currentPlan);
            const utilization = Math.round((busyFree.busyBlocks / (currentPlan.periodCount * currentPlan.days.length)) * 100);
            const avgPerDay = Math.round(weekStats.count / currentPlan.days.length);

            // Update stat cards
            byId('analysisTotalHours').textContent = weekStats.hours;
            byId('analysisFreeBlocks').textContent = busyFree.freeBlocks;
            byId('analysisUtilization').textContent = `${utilization}%`;
            byId('analysisAverage').textContent = avgPerDay;

            // Render charts
            const subjDist = subjectDistributionFor(currentPlan);
            drawBars('barSubjects', subjDist.labels, subjDist.values);

            const teacherDist = teacherDistributionFor(currentPlan);
            drawBars('barTeachers', teacherDist.labels, teacherDist.values);

            const roomDist = roomDistributionFor(currentPlan);
            drawBars('barRooms', roomDist.labels, roomDist.values);

            const timeDist = timeSlotDistributionFor(currentPlan);
            drawBars('barTimeSlots', timeDist.labels, timeDist.values);
        }

        function teacherDistributionFor(plan) {
            const map = new Map();
            plan.lessons.forEach(l => {
                const teacher = l.teacher || 'Unbekannt';
                map.set(teacher, (map.get(teacher) || 0) + l.span);
            });
            const labels = [...map.keys()];
            const values = labels.map(k => map.get(k));
            return { labels, values };
        }

        function roomDistributionFor(plan) {
            const map = new Map();
            plan.lessons.forEach(l => {
                const room = l.room || 'Unbekannt';
                map.set(room, (map.get(room) || 0) + l.span);
            });
            const labels = [...map.keys()];
            const values = labels.map(k => map.get(k));
            return { labels, values };
        }

        function timeSlotDistributionFor(plan) {
            const map = new Map();
            plan.lessons.forEach(l => {
                const timeSlot = `${l.startIndex + 1}. Stunde`;
                map.set(timeSlot, (map.get(timeSlot) || 0) + 1);
            });
            const labels = [...map.keys()];
            const values = labels.map(k => map.get(k));
            return { labels, values };
        }

        /* =================== OVERVIEW (breit & visuals) =================== */

        // Week key generation and management
        function getCurrentWeekKey() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday

            // If it's Saturday (6) or Sunday (0), show the next week
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                // Move to next Monday to get the next week
                const nextMonday = new Date(now);
                nextMonday.setDate(now.getDate() + (dayOfWeek === 0 ? 1 : 2)); // Sunday -> Monday, Saturday -> Monday

                const year = nextMonday.getFullYear();
                const week = getWeekNumber(nextMonday);
                return `${year}-W${week}`;
            }

            // For Monday-Friday, use the current week
            const year = now.getFullYear();
            const week = getWeekNumber(now);
            return `${year}-W${week}`;
        }

        function normalizeWeekKey(weekKey) {
            // Ensure week key is properly formatted and valid
            if (!weekKey || typeof weekKey !== 'string') {
                return getCurrentWeekKey();
            }

            const parts = weekKey.split('-W');
            if (parts.length !== 2) {
                return getCurrentWeekKey();
            }

            const year = parseInt(parts[0]);
            const week = parseInt(parts[1]);

            if (isNaN(year) || isNaN(week) || week < 1 || week > 53) {
                return getCurrentWeekKey();
            }

            return weekKey;
        }

        function weekKeyCompare(a, b) { // "YYYY-Www"
            const [ay, aw] = a.split('-W').map(Number);
            const [by, bw] = b.split('-W').map(Number);
            if (ay !== by) return ay - by;
            return aw - bw;
        }

        function getWeekKeyFromOffset(offset) {
            const now = new Date();
            const targetDate = new Date(now);
            targetDate.setDate(now.getDate() + (offset * 7));
            const year = targetDate.getFullYear();
            const week = getWeekNumber(targetDate);
            return `${year}-W${week}`;
        }

        function getMaxPeriodsForDay(dayStartHour, dayStartMinute, periodMinutes, breakMinutes) {
            const dayStartTotalMinutes = dayStartHour * 60 + dayStartMinute;
            // Available minutes until 24:00 (end of day)
            const availableMinutes = 24 * 60 - dayStartTotalMinutes;

            // Formula: N periods = N * periodMinutes + (N-1) * breakMinutes
            // Solving for N: N = (availableMinutes + breakMinutes) / (periodMinutes + breakMinutes)
            let maxPeriods = 0;

            if (breakMinutes === 0) {
                // Special case: no breaks, so we can fit as many periods as possible
                maxPeriods = Math.floor(availableMinutes / periodMinutes);
            } else {
                // General case: with breaks between periods
                maxPeriods = Math.floor((availableMinutes + breakMinutes) / (periodMinutes + breakMinutes));
            }

            // Special handling for very long periods (480 minutes = 8 hours)
            // Allow at least 3 periods per day even for 8-hour periods
            if (periodMinutes >= 480) {
                maxPeriods = Math.max(maxPeriods, 3);
            }

            return Math.max(0, maxPeriods);
        }

        // Smart Rules Configuration
        const SMART_RULES = {
            presets: {
                'standard-school': {
                    name: 'Standard School',
                    description: 'Traditional school schedule with balanced periods',
                    settings: { periodMinutes: 45, breakMinutes: 5, periodCount: 8, startHour: 8, startMinute: 0 }
                },
                'university': {
                    name: 'University',
                    description: 'Longer periods typical for higher education',
                    settings: { periodMinutes: 90, breakMinutes: 15, periodCount: 4, startHour: 9, startMinute: 0 }
                },
                'intensive-course': {
                    name: 'Intensive Course',
                    description: 'Short periods for intensive learning',
                    settings: { periodMinutes: 30, breakMinutes: 10, periodCount: 10, startHour: 8, startMinute: 30 }
                },
                'workshop': {
                    name: 'Workshop',
                    description: 'Extended periods for hands-on activities',
                    settings: { periodMinutes: 120, breakMinutes: 20, periodCount: 3, startHour: 9, startMinute: 0 }
                }
            },
            constraints: {
                minPeriodDuration: 5,  // Allow very short periods for creative schedules
                maxPeriodDuration: 480, // Allow longer periods (8 hours)
                minBreakDuration: 0,
                maxBreakDuration: 120, // Allow longer breaks
                minPeriodsPerDay: 1,
                maxPeriodsPerDay: 200, // Allow many periods for intensive schedules
                earliestStartTime: 0,  // Allow starting at midnight
                latestEndTime: 24      // Allow 24-hour schedules
            },
            recommendations: {
                optimalPeriodDuration: [15, 30, 45, 60, 90, 120], // Include shorter periods
                optimalBreakDuration: [0, 5, 10, 15, 20, 30], // Include 0 breaks
                optimalPeriodCount: [4, 6, 8, 10, 12, 15, 20, 30] // Include more periods
            }
        };

        function validateAndAdjustSettings() {
            const startTimeSlider = byId('plan-startTimeSlider');
            const periodMinSlider = byId('plan-periodMinSlider');
            const periodCountSlider = byId('plan-periodCountSlider');

            if (!startTimeSlider || !periodMinSlider || !periodCountSlider) {
                return;
            }

            // Get current values
            const sliderValue = parseInt(startTimeSlider.value);
            const startHour = Math.floor(sliderValue / 4);
            const startMinute = (sliderValue % 4) * 15;
            const periodMinutes = parseInt(periodMinSlider.value);
            const breakMinutes = state.breakMinutes; // slider removed; use current state
            const periodCount = parseInt(periodCountSlider.value);

            // Calculate total day time in minutes
            const dayStartMinutes = startHour * 60 + startMinute;
            const dayEndMinutes = SMART_RULES.constraints.latestEndTime * 60; // 22:00 = 1320 minutes
            const availableMinutes = dayEndMinutes - dayStartMinutes;

            // Step 1: Ensure basic constraints
            let adjustedPeriodMinutes = Math.max(SMART_RULES.constraints.minPeriodDuration,
                Math.min(periodMinutes, SMART_RULES.constraints.maxPeriodDuration));
            let adjustedBreakMinutes = Math.max(SMART_RULES.constraints.minBreakDuration,
                Math.min(breakMinutes, SMART_RULES.constraints.maxBreakDuration));

            // Step 2: Calculate what's actually possible with current time constraints
            // Correct formula: N periods = N * periodMinutes + (N-1) * breakMinutes
            // Solving for N: N = (availableMinutes + breakMinutes) / (periodMinutes + breakMinutes)
            const maxPossiblePeriods = Math.floor((availableMinutes + adjustedBreakMinutes) / (adjustedPeriodMinutes + adjustedBreakMinutes));

            // Step 3: Handle impossible combinations by adjusting in priority order
            let adjustments = [];

            if (maxPossiblePeriods === 0) {
                // No periods possible - need to adjust something
                if (adjustedPeriodMinutes > availableMinutes) {
                    // Period too long - reduce it
                    adjustedPeriodMinutes = Math.min(availableMinutes, SMART_RULES.constraints.maxPeriodDuration);
                    adjustments.push(`Period duration reduced to ${adjustedPeriodMinutes} minutes to fit in available time`);
                }

                // Check if we can fit at least one period with current break time
                if (adjustedPeriodMinutes <= availableMinutes) {
                    // We can fit at least one period, so the issue is with break time
                    // For 1 period, we need: 1 * periodMinutes + 0 * breakMinutes = periodMinutes
                    // So break time doesn't matter for 1 period, but let's keep it reasonable
                    if (adjustedBreakMinutes > 0) {
                        adjustedBreakMinutes = 0;
                        adjustments.push(`Break duration reduced to 0 minutes to allow at least one period`);
                    }
                }
            }

            // Step 4: Recalculate after adjustments
            const finalMaxPeriods = Math.floor((availableMinutes + adjustedBreakMinutes) / (adjustedPeriodMinutes + adjustedBreakMinutes));
            const constrainedMaxPeriods = Math.min(finalMaxPeriods, SMART_RULES.constraints.maxPeriodsPerDay);

            // Step 5: Allow user to set period count freely (don't auto-adjust)
            // The user should have full control over the periods per day slider
            let adjustedPeriodCount = periodCount;

            // Only warn if the configuration would be impossible, but don't auto-adjust
            if (periodCount > constrainedMaxPeriods) {
                console.warn(`Period count ${periodCount} exceeds calculated maximum ${constrainedMaxPeriods}, but allowing user choice`);
                // Don't auto-adjust, let the user decide
            }

            // Step 6: Apply all adjustments to sliders
            if (adjustedPeriodMinutes !== periodMinutes) {
                periodMinSlider.value = adjustedPeriodMinutes;
                const periodMinValue = byId('plan-periodMinValue');
                if (periodMinValue) periodMinValue.textContent = adjustedPeriodMinutes;
            }

            if (adjustedBreakMinutes !== breakMinutes) {
                breakMinSlider.value = adjustedBreakMinutes;
                const breakMinValue = byId('plan-breakMinValue');
                if (breakMinValue) breakMinValue.textContent = adjustedBreakMinutes;
            }

            if (adjustedPeriodCount !== periodCount) {
                periodCountSlider.value = adjustedPeriodCount;
                const periodCountValue = byId('plan-periodCountValue');
                if (periodCountValue) periodCountValue.textContent = adjustedPeriodCount;
            }

            // Step 7: Update slider constraints
            periodCountSlider.max = Math.max(1, constrainedMaxPeriods);



            // Step 10: Calculate final schedule info
            // Correct formula: N periods = N * periodMinutes + (N-1) * breakMinutes
            const totalScheduleMinutes = (adjustedPeriodCount * adjustedPeriodMinutes) + ((adjustedPeriodCount - 1) * adjustedBreakMinutes);
            const endTimeMinutes = dayStartMinutes + totalScheduleMinutes;
            const endHour = Math.floor(endTimeMinutes / 60);
            const endMinute = endTimeMinutes % 60;

            console.log(`Smart validation complete: ${startHour}:${startMinute.toString().padStart(2, '0')} - ${endHour}:${endMinute.toString().padStart(2, '0')} (${totalScheduleMinutes}min total, ${adjustedPeriodCount} periods)`);

            // Step 11: Provide comprehensive feedback (disabled - was annoying)
            // provideSmartFeedback(constrainedMaxPeriods, adjustedPeriodMinutes, adjustedBreakMinutes, adjustedPeriodCount);
        }

        function updateSliderMaxValues() {
            // Update the periods per day slider maximum based on current settings
            const periodCountSlider = byId('plan-periodCountSlider');
            if (periodCountSlider) {
                const maxPeriods = getMaxPeriodsForCurrentSettings();
                const currentValue = parseInt(periodCountSlider.value);

                // Update the max attribute
                periodCountSlider.max = Math.max(maxPeriods, 1);

                // If current value exceeds new max, adjust it
                if (currentValue > maxPeriods) {
                    periodCountSlider.value = maxPeriods;
                    const periodCountValue = byId('plan-periodCountValue');
                    if (periodCountValue) {
                        periodCountValue.textContent = maxPeriods;
                    }
                }
            }
        }






        // Toggle preset menu
        function togglePresetMenu() {
            const toggle = document.querySelector('.preset-menu-toggle');
            const content = byId('presetMenuContent');

            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
            }
        }


        // Apply preset configuration
        function applyPreset(presetKey) {
            const preset = SMART_RULES.presets[presetKey];
            if (!preset) return;

            const { periodMinutes, breakMinutes, periodCount, startHour, startMinute } = preset.settings;

            // Update sliders
            const periodMinSlider = byId('plan-periodMinSlider');
            const periodCountSlider = byId('plan-periodCountSlider');
            const startTimeSlider = byId('plan-startTimeSlider');

            if (periodMinSlider) {
                periodMinSlider.value = periodMinutes;
                const periodMinValue = byId('plan-periodMinValue');
                if (periodMinValue) periodMinValue.textContent = periodMinutes;
            }

            if (breakMinSlider) {
                breakMinSlider.value = breakMinutes;
                const breakMinValue = byId('plan-breakMinValue');
                if (breakMinValue) breakMinValue.textContent = breakMinutes;
            }

            if (periodCountSlider) {
                periodCountSlider.value = periodCount;
                const periodCountValue = byId('plan-periodCountValue');
                if (periodCountValue) periodCountValue.textContent = periodCount;
            }

            if (startTimeSlider) {
                const sliderValue = (startHour * 4) + (startMinute / 15);
                startTimeSlider.value = sliderValue;
                const startTimeValue = byId('plan-startTimeValue');
                if (startTimeValue) {
                    startTimeValue.textContent = `${startHour.toString().padStart(2, '0')}:${startMinute.toString().padStart(2, '0')}`;
                }
            }

            // Save settings
            savePlanSettingsForCurrentWeek();

            // Close the preset menu after applying
            const toggle = document.querySelector('.preset-menu-toggle');
            const content = byId('presetMenuContent');
            content.classList.remove('expanded');
            toggle.classList.remove('expanded');

        }

        // Smart tooltip system for sliders
        function showSliderTooltip(slider, message) {
            // Remove existing tooltip
            const existingTooltip = document.querySelector('.slider-tooltip');
            if (existingTooltip) {
                existingTooltip.remove();
            }

            // Create tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'slider-tooltip';
            tooltip.textContent = message;

            // Position tooltip near slider
            const rect = slider.getBoundingClientRect();
            tooltip.style.position = 'fixed';
            tooltip.style.top = (rect.top - 40) + 'px';
            tooltip.style.left = (rect.left + rect.width / 2) + 'px';
            tooltip.style.transform = 'translateX(-50%)';
            tooltip.style.zIndex = '1001';

            document.body.appendChild(tooltip);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (tooltip.parentElement) {
                    tooltip.remove();
                }
            }, 3000);
        }

        // Contextual tooltip messages
        function getPeriodDurationTooltip(minutes) {
            if (minutes <= 30) return 'Short periods - good for intensive learning';
            if (minutes <= 45) return 'Standard duration - balanced for most subjects';
            if (minutes <= 60) return 'Longer periods - good for complex topics';
            if (minutes <= 90) return 'Extended periods - ideal for workshops';
            return 'Very long periods - consider shorter breaks';
        }

        function getBreakDurationTooltip(minutes) {
            if (minutes === 0) return 'No breaks - may cause fatigue';
            if (minutes <= 5) return 'Short breaks - quick refresh';
            if (minutes <= 10) return 'Standard breaks - good balance';
            if (minutes <= 15) return 'Longer breaks - good for social time';
            return 'Extended breaks - consider shorter periods';
        }

        function getPeriodCountTooltip(count) {
            if (count <= 3) return 'Few periods - good for intensive focus';
            if (count <= 6) return 'Moderate schedule - balanced learning';
            if (count <= 8) return 'Standard schedule - typical school day';
            if (count <= 10) return 'Full schedule - comprehensive coverage';
            return 'Many periods - ensure adequate breaks';
        }

        function getStartTimeTooltip(hour, minute) {
            const time = hour + minute / 60;
            if (time < 7) return 'Very early start - consider student fatigue';
            if (time < 8) return 'Early start - good for morning focus';
            if (time < 9) return 'Standard start time - optimal for most';
            if (time < 10) return 'Late start - good for older students';
            return 'Very late start - may affect evening activities';
        }


        function getMaxPeriodsForCurrentSettings() {
            const startTimeSlider = byId('plan-startTimeSlider');
            const periodMinSlider = byId('plan-periodMinSlider');
            const breakMinSlider = byId('plan-breakMinSlider');

            if (!startTimeSlider || !periodMinSlider) {
                return 0;
            }

            const sliderValue = parseInt(startTimeSlider.value);
            const startHour = Math.floor(sliderValue / 4);
            const startMinute = (sliderValue % 4) * 15;
            const periodMinutes = parseInt(periodMinSlider.value);
            const breakMinutes = state.breakMinutes;

            return getMaxPeriodsForDay(startHour, startMinute, periodMinutes, breakMinutes);
        }

        function getOrCreateWeekPlan(weekKey) {
            if (!weekPlans.has(weekKey)) {
                const newPlan = {
                    lessons: [],
                    days: [...state.days], // Use state for consistency
                    periodMinutes: state.periodMinutes,
                    breakMinutes: 0, // No breaks between lessons
                    periodCount: state.periodCount,
                    timeSlots: [], // Individual time slots for this week
                    dayStart: { h: dayStart.h, m: dayStart.m } // Week-specific start time, initialized from global dayStart
                };
                weekPlans.set(weekKey, newPlan);
            }
            return weekPlans.get(weekKey);
        }
        function getDisplayWeekPlan() {
            // Use the current plan week for overview data (where lessons are actually stored)
            const plan = getOrCreateWeekPlan(currentPlanWeek);

            return plan;
        }

        function getHeatmapWeekPlan() {
            // Use the heatmap week for heatmap-specific data
            const plan = getOrCreateWeekPlan(currentHeatmapWeek);

            return plan;
        }
        function calcWeekStatsFor(plan) {
            const minutes = plan.lessons.reduce((sum, l) => sum + l.span * plan.periodMinutes, 0);
            return { count: plan.lessons.length, minutes, hours: Math.round(minutes / 60) };
        }

        function calcTodayStatsFor(plan) {
            const now = new Date();
            const day = (now.getDay() + 6) % 7;
            const occ = new Set(plan.lessons.filter(l => l.day === day).flatMap(l =>
                Array.from({ length: l.span }, (_, i) => l.startIndex + i)
            ));
            const busy = occ.size;
            const free = Math.max(0, plan.periodCount - busy);
            return { busyBlocks: busy, freeBlocks: free };
        }
        function buildHeatMatrixFor(plan) {
            // Create matrix with days as rows (as expected by drawHeatmap)
            const m = Array.from({ length: plan.days.length }, () => []);

            // Only show data if the week has lessons
            if (!plan.lessons || plan.lessons.length === 0) {
                return m; // Return empty matrix for weeks with no lessons
            }

            for (const l of plan.lessons) {
                const color = (l.color && l.color.trim()) || dataState.subjectColors[(l.subject || "").trim()] || "#60a5fa";
                if (l.day >= 0 && l.day < plan.days.length) {
                    // Apply same adjustment logic as Heute box
                    const currentPeriodCount = plan.periodCount || state.periodCount;
                    const adjustedSpan = Math.min(l.span, currentPeriodCount - l.startIndex);

                    // Only include lessons that still fit
                    if (adjustedSpan > 0) {
                        m[l.day].push({
                            subject: l.subject,
                            teacher: l.teacher,
                            room: l.room,
                            color: color,
                            importance: !!l.importance,
                            startIndex: l.startIndex,
                            span: adjustedSpan // Use adjusted span
                        });
                    }
                }
            }
            return m;
        }

        function subjectDistributionFor(plan) {
            const map = new Map();
            for (const l of plan.lessons) {
                const key = (l.subject || '—').trim();
                map.set(key, (map.get(key) || 0) + 1);
            }
            const labels = [...map.keys()];
            const values = labels.map(k => map.get(k));
            return { labels, values };
        }

        function switchToWeekPlan(weekKey) {
            try {
                console.log('Switching to week:', weekKey);

                const plan = getOrCreateWeekPlan(weekKey);
                if (!plan) {
                    console.error('Failed to get or create plan for week:', weekKey);
                    return;
                }

                currentPlanWeek = weekKey;

                // Save the current plan week to localStorage
                try {
                    localStorage.setItem('currentPlanWeek', weekKey);
                } catch (e) {
                    console.warn('Failed to save currentPlanWeek to localStorage:', e);
                }

                // Update state with the selected week's data
                state.lessons = [...plan.lessons];
                state.days = [...plan.days];
                state.periodMinutes = plan.periodMinutes;
                state.breakMinutes = plan.breakMinutes;
                state.periodCount = plan.periodCount;

                console.log('Updated state with plan values:', {
                    periodMinutes: state.periodMinutes,
                    periodCount: state.periodCount,
                    breakMinutes: state.breakMinutes
                });

                // Save current state and render
                savePlan();
                renderGrid();
                updatePlanWeekDisplay();

                // Update side panel if it's open
                const panel = byId('timetableStructurePanel');
                if (panel && panel.classList.contains('open')) {
                    updatePlanSettingsForCurrentWeek();
                }

                console.log('Successfully switched to week:', weekKey);

            } catch (error) {
                console.error('Error in switchToWeekPlan:', error);
            }
        }

        function saveCurrentWeekPlan() {
            const plan = weekPlans.get(currentPlanWeek);
            if (plan) {
                // Don't overwrite plan.lessons - they may have been updated by resize/drag operations
                // Only update other properties if they differ
                if (plan.days.length !== state.days.length || !plan.days.every((d, i) => d === state.days[i])) {
                    plan.days = [...state.days];
                }
                if (plan.periodMinutes !== state.periodMinutes) {
                    plan.periodMinutes = state.periodMinutes;
                }
                if (plan.breakMinutes !== state.breakMinutes) {
                    plan.breakMinutes = state.breakMinutes;
                }
                // Don't overwrite plan.periodCount if it's larger than state.periodCount
                // This allows dynamic row creation beyond the slider limit
                if (plan.periodCount < state.periodCount) {
                    plan.periodCount = state.periodCount;
                }
            } else {
                // Create the plan if it doesn't exist
                weekPlans.set(currentPlanWeek, {
                    lessons: [...state.lessons],
                    days: [...state.days],
                    periodMinutes: state.periodMinutes,
                    breakMinutes: 0, // No breaks between lessons
                    periodCount: state.periodCount
                });
            }
        }

        // Week navigation functions
        function updateWeekDisplay(forceUpdate = false) {
            const weekDisplay = byId('weekDisplay');
            if (!weekDisplay) {
                console.warn('weekDisplay element not found');
                return;
            }

            // Don't update if week input is currently active, unless forced
            if (!forceUpdate && window.weekInputActive && window.weekInputType === 'heatmap') {
                console.log('Skipping updateWeekDisplay - week input is active');
                return;
            }

            // Heatmap now uses its own independent week
            const dateRange = getWeekDateRange(currentHeatmapWeek);
            const currentWeekKey = getCurrentWeekKey();

            // Check if this is the current week
            const isCurrentWeek = currentHeatmapWeek === currentWeekKey;
            console.log('updateWeekDisplay - currentHeatmapWeek:', currentHeatmapWeek, 'currentWeekKey:', currentWeekKey, 'isCurrentWeek:', isCurrentWeek);

            const heatmapWeekNumber = currentHeatmapWeek.split('-W')[1];
            console.log('updateWeekDisplay: Setting innerHTML to:', `<strong>W${heatmapWeekNumber}</strong><br>${dateRange}`);
            weekDisplay.innerHTML = `<strong>W${heatmapWeekNumber}</strong><br>${dateRange}`;
            weekDisplay.classList.toggle('current-week', isCurrentWeek);

            // Show/hide current week button based on whether we're viewing current week
            const goToCurrentWeekBtn = byId('goToCurrentWeek');
            if (goToCurrentWeekBtn) {
                console.log('Setting goToCurrentWeek button display to:', isCurrentWeek ? 'none' : 'flex');
                if (isCurrentWeek) {
                    goToCurrentWeekBtn.style.setProperty('display', 'none', 'important');
                } else {
                    goToCurrentWeekBtn.style.setProperty('display', 'flex', 'important');
                }
            }
        }

        function updatePlanWeekDisplay() {
            const planWeekDisplay = byId('planWeekDisplay');
            if (!planWeekDisplay) {
                console.warn('planWeekDisplay element not found');
                return;
            }

            if (!currentPlanWeek) {
                console.warn('currentPlanWeek is not set');
                return;
            }

            const weekNumber = currentPlanWeek.split('-W')[1];
            if (!weekNumber) {
                console.warn('Invalid currentPlanWeek format:', currentPlanWeek);
                return;
            }

            const dateRange = getWeekDateRange(currentPlanWeek);
            const currentWeekKey = getCurrentWeekKey();

            // Update timetable structure banner week display
            const timetableWeekBadge = byId('currentWeekBadge');
            if (timetableWeekBadge) {
                timetableWeekBadge.textContent = `Week ${weekNumber}`;
            }

            // Check if this is the current week
            const isCurrentWeek = currentPlanWeek === currentWeekKey;
            console.log('updatePlanWeekDisplay - currentPlanWeek:', currentPlanWeek, 'currentWeekKey:', currentWeekKey, 'isCurrentWeek:', isCurrentWeek);

            const planWeekNumber = currentPlanWeek.split('-W')[1];
            planWeekDisplay.innerHTML = `<strong>W${planWeekNumber}</strong><br>${dateRange}`;
            planWeekDisplay.classList.toggle('current-week', isCurrentWeek);

            // Show/hide current week button based on whether we're viewing current week
            const goToCurrentPlanWeekBtn = byId('goToCurrentPlanWeek');
            if (goToCurrentPlanWeekBtn) {
                console.log('Setting goToCurrentPlanWeek button display to:', isCurrentWeek ? 'none' : 'flex');
                if (isCurrentWeek) {
                    goToCurrentPlanWeekBtn.style.setProperty('display', 'none', 'important');
                } else {
                    goToCurrentPlanWeekBtn.style.setProperty('display', 'flex', 'important');
                }
            }

            console.log('Updated plan week display to:', dateRange);
        }

        // Week input functionality
        function setupWeekInput() {
            const weekDisplay = byId('weekDisplay');
            const planWeekDisplay = byId('planWeekDisplay');

            // Single click to copy week data for heatmap navigation island
            if (weekDisplay) {
                let clickTimeout;
                
                // Remove any existing event listeners to avoid conflicts
                weekDisplay.removeEventListener('click', copyWeekData);
                
                weekDisplay.addEventListener('click', (e) => {
                    console.log('Heatmap weekDisplay clicked');
                    e.stopPropagation(); // Prevent event from bubbling to heatmapCard
                    e.preventDefault(); // Prevent default behavior
                    
                    // Clear any existing timeout
                    if (clickTimeout) {
                        clearTimeout(clickTimeout);
                    }
                    
                    // Set a timeout to detect if this is a single click or part of a double-click
                    clickTimeout = setTimeout(() => {
                        console.log('Heatmap single click detected, copying...');
                        copyWeekData(weekDisplay);
                    }, 200); // 200ms delay to detect double-click
                });
                
                weekDisplay.addEventListener('dblclick', (e) => {
                    console.log('Heatmap weekDisplay double-clicked');
                    e.stopPropagation(); // Prevent event from bubbling to heatmapCard
                    e.preventDefault(); // Prevent default behavior
                    
                    // Clear the single-click timeout
                    if (clickTimeout) {
                        clearTimeout(clickTimeout);
                    }
                    handleWeekInput(weekDisplay, 'heatmap');
                });
                
                // Also prevent mousedown events from interfering
                weekDisplay.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                });
            }

            if (planWeekDisplay) {
                let clickTimeout;
                
                planWeekDisplay.addEventListener('click', () => {
                    // Clear any existing timeout
                    if (clickTimeout) {
                        clearTimeout(clickTimeout);
                    }
                    
                    // Set a timeout to detect if this is a single click or part of a double-click
                    clickTimeout = setTimeout(() => {
                        copyWeekData(planWeekDisplay);
                    }, 200); // 200ms delay to detect double-click
                });
                
                planWeekDisplay.addEventListener('dblclick', () => {
                    // Clear the single-click timeout
                    if (clickTimeout) {
                        clearTimeout(clickTimeout);
                    }
                    handleWeekInput(planWeekDisplay, 'plan');
                });
            }
        }

        function copyWeekData(element) {
            const text = element.textContent.trim();
            // Don't copy if we're showing the "✓ Copied!" message
            if (text && text !== 'KW XX' && !text.includes('✓ Copied!')) {
                // Format the text with proper formatting
                let formattedText = text;
                
                // Debug: log the actual text content
                console.log('Original text:', text);
                
                // The week display uses <br> tags, so textContent will have the week and date on separate lines
                // We need to parse this correctly
                const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                
                console.log('Split lines:', lines);
                
                if (lines.length >= 2) {
                    // First line should be the week number (e.g., "W42")
                    // Second line should be the date range (e.g., "13.10.2025 – 17.10.2025")
                    const weekPart = lines[0];
                    const datePart = lines[1];
                    formattedText = `${weekPart} | ${datePart}`;
                } else if (lines.length === 1) {
                    // If it's all on one line, try to split by looking for the date pattern
                    const textStr = lines[0];
                    // Look for pattern like "W42" followed immediately by date (e.g., "W4213.10.2025 – 17.10.2025")
                    const weekMatch = textStr.match(/^(W\d+)(\d{2}\.\d{2}\.\d{4}.*)$/);
                    if (weekMatch) {
                        const weekPart = weekMatch[1]; // "W42"
                        const datePart = weekMatch[2]; // "13.10.2025 – 17.10.2025"
                        formattedText = `${weekPart} | ${datePart}`;
                    }
                }
                
                console.log('Formatted text:', formattedText);
                
                // Copy to clipboard
                navigator.clipboard.writeText(formattedText).then(() => {
                    // Visual feedback
                    const originalText = element.innerHTML;
                    element.innerHTML = '<span style="color: #10b981; font-weight: 700;">✓ Copied!</span>';
                    
                    // Restore original text after 1 second
                    setTimeout(() => {
                        element.innerHTML = originalText;
                    }, 1000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = formattedText;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        // Visual feedback
                        const originalText = element.innerHTML;
                        element.innerHTML = '<span style="color: #10b981; font-weight: 700;">✓ Copied!</span>';
                        setTimeout(() => {
                            element.innerHTML = originalText;
                        }, 1000);
                    } catch (err) {
                        console.error('Fallback copy failed: ', err);
                    }
                    document.body.removeChild(textArea);
                });
            }
        }

        function handleWeekInput(element, type) {
            const currentText = element.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = '';
            input.style.cssText = `
                background: #e0e7ff;
                border: 1px solid #6366f1;
                border-radius: 4px;
                padding: 4px 8px;
                font-size: 16px;
                font-weight: 600;
                text-align: center;
                width: 100%;
                min-width: 220px;
                color: var(--muted);
                letter-spacing: 0.5px;
            `;
            input.placeholder = 'z.B. W50, Woche 50, 10.10.2025';

            // Set a global flag to prevent other handlers from interfering
            window.weekInputActive = true;
            window.weekInputType = type;

            element.classList.add('editing');
            element.innerHTML = '';
            element.appendChild(input);
            
            // Add a small delay before focusing to ensure DOM is ready
            setTimeout(() => {
                input.focus();
                input.select();
            }, 50);
            
            // Add a safety mechanism to prevent automatic closing
            const preventAutoClose = () => {
                if (window.weekInputActive && window.weekInputType === type) {
                    // If somehow the input gets closed, reopen it
                    setTimeout(() => {
                        if (!element.classList.contains('editing') && window.weekInputActive) {
                            element.classList.add('editing');
                            element.innerHTML = '';
                            element.appendChild(input);
                            input.focus();
                        }
                    }, 10);
                }
            };
            
            // Monitor for any attempts to close the input
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        if (!element.classList.contains('editing') && window.weekInputActive) {
                            preventAutoClose();
                        }
                    }
                });
            });
            
            observer.observe(element, { attributes: true });
            
            // Store observer for cleanup
            input._observer = observer;

            const handleSubmit = () => {
                const value = input.value.trim();
                console.log('handleSubmit called with value:', value, 'type:', type);
                if (value) {
                    const weekKey = parseWeekInput(value);
                    console.log('parseWeekInput returned:', weekKey);
                    if (weekKey) {
                        if (type === 'plan') {
                            currentPlanWeek = weekKey;
                            updatePlanWeekDisplay();
                            switchToWeekPlan(weekKey);
                        } else if (type === 'heatmap') {
                            currentHeatmapWeek = weekKey;
                            
                            // Ensure the week plan exists
                            const plan = getOrCreateWeekPlan(weekKey);
                            if (!plan) {
                                console.error('Failed to get or create plan for heatmap week:', weekKey);
                                return;
                            }
                            
                            // Update overview week key to match
                            overviewWeekKey = weekKey;
                            
                            updateWeekDisplay(true); // Force update even if input is active
                            
                            // Save to localStorage
                            try {
                                localStorage.setItem('currentHeatmapWeek', weekKey);
                                localStorage.setItem('overviewWeekKey', weekKey);
                            } catch (e) {
                                console.warn('Failed to save heatmap week to localStorage:', e);
                            }
                            
                            // Update overview display
                            console.log('About to call renderOverview for heatmap');
                            renderOverview();
                            console.log('renderOverview completed for heatmap');
                        }
                    }
                }
                // Clear the global flag
                window.weekInputActive = false;
                window.weekInputType = null;
                
                // Re-enable events if they were disabled
                if (input._reEnableEvents) {
                    input._reEnableEvents();
                }
                
                // Clean up observer
                if (input._observer) {
                    input._observer.disconnect();
                }
                
                element.classList.remove('editing');
                if (type === 'plan') {
                    updatePlanWeekDisplay();
                } else if (type === 'heatmap') {
                    updateWeekDisplay(true); // Force update when submitting
                }
            };

            const handleCancel = () => {
                // Clear the global flag
                window.weekInputActive = false;
                window.weekInputType = null;
                
                // Re-enable events if they were disabled
                if (input._reEnableEvents) {
                    input._reEnableEvents();
                }
                
                // Clean up observer
                if (input._observer) {
                    input._observer.disconnect();
                }
                
                element.classList.remove('editing');
                if (type === 'plan') {
                    updatePlanWeekDisplay();
                } else if (type === 'heatmap') {
                    updateWeekDisplay(true); // Force update when canceling
                }
            };

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSubmit();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    handleCancel();
                }
            });

            // Prevent clicks on the input from closing it
            input.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                e.preventDefault();
            });
            
            input.addEventListener('click', (e) => {
                e.stopPropagation();
                e.preventDefault();
            });
            
            // Additional event prevention for heatmap
            if (type === 'heatmap') {
                input.addEventListener('focus', (e) => {
                    e.stopPropagation();
                });
                
                input.addEventListener('blur', (e) => {
                    e.stopPropagation();
                });
            }
            
            // Add global click handler to detect clicks outside - but only close on explicit outside clicks
            const handleOutsideClick = (e) => {
                // Don't close if clicking on the input or its container
                if (!element.contains(e.target)) {
                    // For heatmap, also check if we're clicking on the heatmapCard
                    if (type === 'heatmap') {
                        const heatmapCard = byId('heatmapCard');
                        if (heatmapCard && heatmapCard.contains(e.target)) {
                            // Don't close if clicking on the heatmap card itself
                            return;
                        }
                    }
                    // Only close if the flag is still active and it's a genuine outside click
                    if (window.weekInputActive && window.weekInputType === type) {
                        // Add a small delay to prevent accidental closes
                        setTimeout(() => {
                            if (window.weekInputActive && window.weekInputType === type) {
                                handleSubmit();
                            }
                        }, 100);
                    }
                    document.removeEventListener('click', handleOutsideClick);
                }
            };
            
            // Add the global click handler after a longer delay for heatmap to prevent conflicts
            const delay = type === 'heatmap' ? 1000 : 200;
            setTimeout(() => {
                document.addEventListener('click', handleOutsideClick);
            }, delay);
            
            // For heatmap, add event prevention but allow outside clicks
            if (type === 'heatmap') {
                // Simply disable pointer events on the heatmap card temporarily
                const heatmapCard = byId('heatmapCard');
                if (heatmapCard) {
                    const originalPointerEvents = heatmapCard.style.pointerEvents;
                    heatmapCard.style.pointerEvents = 'none';
                    
                    // Re-enable after input is closed
                    const reEnableEvents = () => {
                        heatmapCard.style.pointerEvents = originalPointerEvents || 'auto';
                    };
                    
                    // Store the re-enable function for later use
                    input._reEnableEvents = reEnableEvents;
                }
            }
        }

        function parseWeekInput(input) {
            const trimmed = input.trim().toLowerCase();
            console.log('parseWeekInput called with:', input, 'trimmed:', trimmed);
            
            // Handle "W50" or "w50" format
            const weekMatch = trimmed.match(/^w(\d+)$/);
            if (weekMatch) {
                const weekNum = parseInt(weekMatch[1]);
                console.log('Found week match:', weekNum);
                if (weekNum >= 1 && weekNum <= 53) {
                    const currentYear = new Date().getFullYear();
                    const result = `${currentYear}-W${weekNum}`;
                    console.log('Returning week key:', result);
                    return result;
                }
            }

            // Handle "Woche 50" format
            const wocheMatch = trimmed.match(/^woche\s+(\d+)$/);
            if (wocheMatch) {
                const weekNum = parseInt(wocheMatch[1]);
                if (weekNum >= 1 && weekNum <= 53) {
                    const currentYear = new Date().getFullYear();
                    return `${currentYear}-W${weekNum}`;
                }
            }

            // Handle date formats: "10.10.2025", "10/10/2025", "10-10-2025"
            const dateMatch = trimmed.match(/^(\d{1,2})[.\/-](\d{1,2})[.\/-](\d{4})$/);
            if (dateMatch) {
                const day = parseInt(dateMatch[1]);
                const month = parseInt(dateMatch[2]);
                const year = parseInt(dateMatch[3]);
                
                if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 2020 && year <= 2030) {
                    const date = new Date(year, month - 1, day);
                    if (date.getDate() === day && date.getMonth() === month - 1) {
                        const weekNum = getWeekNumber(date);
                        return `${year}-W${weekNum}`;
                    }
                }
            }

            return null;
        }



        function attachCellEventListeners(cell, dayIndex, periodIndex) {
            // Use event delegation for better performance
            cell.addEventListener('dragover', e => {
                e.preventDefault();
                cell.classList.add('over');
            });

            cell.addEventListener('dragleave', () => cell.classList.remove('over'));

            cell.addEventListener('drop', e => {
                e.preventDefault();
                cell.classList.remove('over');
                const id = e.dataTransfer?.getData('text/plain');
                if (!id) return;

                const currentPlan = getOrCreateWeekPlan(currentPlanWeek);
                const idx = currentPlan.lessons.findIndex(l => l.id === id);
                if (idx < 0) return;

                const l = { ...currentPlan.lessons[idx] };
                l.day = dayIndex;
                l.startIndex = periodIndex;
                l.span = Math.min(l.span, currentPlan.timeSlots.length - l.startIndex);

                const next = [...currentPlan.lessons];
                next[idx] = l;
                currentPlan.lessons = resolveCollisions(next, currentPlan.timeSlots.length);
                // Sync state.lessons with currentPlan.lessons for immediate "Als Nächstes" updates
                state.lessons = [...currentPlan.lessons];
                saveCurrentWeekPlan();
                renderGrid();
            });
        }

        function removeTimeSlot(index) {
            const plan = weekPlans.get(currentPlanWeek);
            if (!plan || !plan.timeSlots || index >= plan.timeSlots.length) {
                console.warn('Invalid time slot index:', index);
                return;
            }

            // Remove the time slot
            plan.timeSlots.splice(index, 1);

            // Don't override the slider setting - keep the user's period count choice
            // plan.periodCount = plan.timeSlots.length;

            // Save and re-render
            saveWeekPlans();
            renderGrid();

            console.log('Removed time slot at index:', index, 'for week:', currentPlanWeek);
        }

        function getWeekNumber(date) {
            // ISO 8601 week number calculation
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7; // Convert Sunday (0) to 7
            d.setUTCDate(d.getUTCDate() + 4 - dayNum); // Move to Thursday of the same week
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        function getWeekDateRange(weekKey) {
            try {
                const [year, week] = weekKey.split('-W').map(Number);

                // Use ISO 8601 week calculation to get the Monday of the given week
                // This ensures we get the correct Monday for the ISO week number
                const simple = new Date(year, 0, 1 + (week - 1) * 7);
                const dow = simple.getDay();
                const ISOweekStart = simple;

                // Adjust to get the Monday of the ISO week
                if (dow <= 4) {
                    ISOweekStart.setDate(simple.getDate() - dow + 1);
                } else {
                    ISOweekStart.setDate(simple.getDate() + 8 - dow);
                }

                // Calculate Friday of the same week (Monday + 4 days)
                const targetFriday = new Date(ISOweekStart);
                targetFriday.setDate(ISOweekStart.getDate() + 4);

                // Format dates as DD.MM.YYYY
                const formatDate = (date) => {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}.${month}.${year}`;
                };

                // Return formatted date range with better spacing
                return `${formatDate(ISOweekStart)} – ${formatDate(targetFriday)}`;
            } catch (error) {
                console.error('Error calculating week date range:', error);
                return weekKey; // Fallback to week key
            }
        }

        function navigateWeek(direction) {
            // Heatmap navigation is now independent from plan timetable
            navigateHeatmapWeek(direction);

            // Update heatmap display only
            updateWeekDisplay();
            renderOverview();
            
            // Update structure panel if we're in Overview section (regardless of whether it's open)
            if (currentPage === 'pageOverview') {
                console.log('Updating structure panel for overview week navigation');
                updatePlanSettingsForCurrentWeek();
            }
        }

        function navigateHeatmapWeek(direction) {
            try {
                const currentWeekKey = currentHeatmapWeek;
                if (!currentWeekKey) {
                    console.error('currentHeatmapWeek is not set');
                    return;
                }

                const [year, week] = currentWeekKey.split('-W').map(Number);
                const currentDate = new Date(year, 0, 1);
                const weekStart = new Date(currentDate.getTime() + (week - 1) * 7 * 24 * 60 * 60 * 1000);

                // Add/subtract weeks
                const newDate = new Date(weekStart.getTime() + direction * 7 * 24 * 60 * 60 * 1000);
                const newYear = newDate.getFullYear();
                const newWeek = getWeekNumber(newDate);
                const newWeekKey = `${newYear}-W${newWeek}`;

                currentHeatmapWeek = newWeekKey;

                // Calculate new offset for overview
                const baseWeekKey = getCurrentWeekKey();
                const weekDiff = weekKeyCompare(newWeekKey, baseWeekKey);
                currentWeekOffset = weekDiff;
                overviewWeekKey = newWeekKey; // Update overview week key

                // Save to localStorage
                try {
                    localStorage.setItem('currentHeatmapWeek', newWeekKey);
                    localStorage.setItem('currentWeekOffset', currentWeekOffset.toString());
                    localStorage.setItem('overviewWeekKey', newWeekKey);
                } catch (e) {
                    console.warn('Failed to save week keys to localStorage:', e);
                }

                console.log('Heatmap week changed to:', newWeekKey);
                
                // Update structure panel if we're in Overview section (regardless of whether it's open)
                if (currentPage === 'pageOverview') {
                    console.log('Updating structure panel for heatmap week change');
                    updatePlanSettingsForCurrentWeek();
                }
            } catch (error) {
                console.error('Error navigating heatmap week:', error);
            }
        }
        function getDisplayWeekLessons() {
            const plan = weekPlans.get(currentPlanWeek);
            return plan ? plan.lessons : [];
        }
        function navigatePlanWeek(direction) {
            try {
                const currentWeekKey = currentPlanWeek;
                if (!currentWeekKey) {
                    console.error('currentPlanWeek is not set');
                    return;
                }

                const currentWeekNum = parseInt(currentWeekKey.split('-W')[1]);
                const year = parseInt(currentWeekKey.split('-W')[0]);

                if (isNaN(currentWeekNum) || isNaN(year)) {
                    console.error('Invalid week key format:', currentWeekKey);
                    return;
                }

                // Calculate target week
                let targetWeekNum = currentWeekNum + direction;
                let targetYear = year;

                // Handle year boundaries
                if (targetWeekNum < 1) {
                    targetYear--;
                    // Check if previous year has 53 weeks
                    const prevYearWeeks = getWeekNumber(new Date(targetYear, 11, 31));
                    targetWeekNum = prevYearWeeks;
                } else if (targetWeekNum > 52) {
                    // Check if current year has 53 weeks
                    const currentYearWeeks = getWeekNumber(new Date(targetYear, 11, 31));
                    if (targetWeekNum > currentYearWeeks) {
                        targetYear++;
                        targetWeekNum = 1;
                    }
                }

                const targetWeekKey = `${targetYear}-W${targetWeekNum}`;

                // Check if week exists or create it
                if (!weekPlans.has(targetWeekKey)) {
                    // Create new week
                    getOrCreateWeekPlan(targetWeekKey);
                }

                switchToWeekPlan(targetWeekKey);

                // Update both displays (plan and heatmap)
                updatePlanWeekDisplay();
                updateWeekDisplay();
                
                // Update structure panel if we're in Plan section (regardless of whether it's open)
                if (currentPage === 'pagePlan') {
                    console.log('Updating structure panel for plan week change');
                    updatePlanSettingsForCurrentWeek();
                }

            } catch (error) {
                console.error('Error in navigatePlanWeek:', error);
            }
        }


        function checkAutoNextWeek() {
            // Auto-switching disabled - user controls week navigation manually
            // This prevents the heatmap from automatically switching to future weeks
            return;
        }

        function renderOverview() {
            try {
                // Check if we should auto-switch to next week
                checkAutoNextWeek();

                // Ensure overview week plan exists
                if (!weekPlans.has(overviewWeekKey)) {
                    getOrCreateWeekPlan(overviewWeekKey);
                }

                // Force save all week plans to ensure data persistence
                saveWeekPlans();

                // Get the overview week plan for statistics (where lessons are actually stored)
                const selectedPlan = getOrCreateWeekPlan(overviewWeekKey);
                if (!selectedPlan) {
                    console.error('Failed to get or create overview week plan');
                    return;
                }

                // Use selected week's data for statistics
                const weekStats = calcWeekStatsFor(selectedPlan);
                const kpiWeekLessons = byId('kpiWeekLessons');
                const kpiWeekMinutes = byId('kpiWeekMinutes');
                if (kpiWeekLessons) kpiWeekLessons.textContent = weekStats.count.toString();
                if (kpiWeekMinutes) kpiWeekMinutes.textContent = `${weekStats.minutes} Min · ${weekStats.hours} h`;

                const todayStats = calcTodayStatsFor(selectedPlan);
                const kpiFreeToday = byId('kpiFreeToday');
                const kpiBusyToday = byId('kpiBusyToday');
                if (kpiFreeToday) kpiFreeToday.textContent = todayStats.freeBlocks.toString();
                if (kpiBusyToday) kpiBusyToday.textContent = `${todayStats.busyBlocks} belegt`;

                const subjectsSet = new Set(selectedPlan.lessons.map(l => (l.subject || '').trim()).filter(Boolean));
                const kpiSubjects = byId('kpiSubjects');
                const kpiFolders = byId('kpiFolders');
                if (kpiSubjects) kpiSubjects.textContent = subjectsSet.size.toString();
                if (kpiFolders) kpiFolders.textContent = `Ordner: ${folderState.folders.length}`;

                // Update week display
                updateWeekDisplay();

                // Use overview week for heatmap display (same as statistics)
                // Ensure heatmap week is synchronized with overview week
                currentHeatmapWeek = overviewWeekKey;
                const heatmapMatrix = buildHeatMatrixFor(selectedPlan);
                const heatmapElement = byId('heatmap');
                if (heatmapElement) {
                    drawHeatmap('heatmap', heatmapMatrix);
                }

                // Use overview week for other displays
                const subjDist = subjectDistributionFor(selectedPlan);
                const barSubjectsElement = byId('barSubjects');
                if (barSubjectsElement) {
                    drawBars('barSubjects', subjDist.labels, subjDist.values);
                }
                const listTodayElement = byId('listToday');
                if (listTodayElement) {
                    renderTodayList('listToday', selectedPlan);
                }
                const listRecentElement = byId('listRecent');
                if (listRecentElement) {
                    renderRecentFiles('listRecent');
                }

                // **NEU**: Kompakte Box in den neuen Platzhalter
                const host = byId('ovHeroInline');
                if (host) {
                    // nutzt deine vorhandene current/next-Logik:
                    const info = getCurrentOrNextLesson();   // oder currentOrNextLesson()
                    if (!info) {
                        // Always show "Als Nächstes" even when no lessons found
                        host.innerHTML = `
                        <div class="hero-compact">
                            <div>
                                <div class="hc-title">Als Nächstes</div>
                                <div class="hc-meta">Keine Stunden geplant</div>
                            </div>
                            <div style="width:56px;height:56px"></div>
                        </div>`;
                    } else {
                        const { l, type, start, end, dayIndex, weekKey, offset } = info;
                        const title = type === 'now' ? 'Jetzt' : 'Als Nächstes';
                        const startLbl = timeLabelFromMinutes(dayStart, start);
                        const endLbl = timeLabelFromMinutes(dayStart, end);
                        const dayLbl = state.days[dayIndex] || `Tag ${dayIndex + 1}`;

                        // Add week information if it's in a different week
                        let weekInfo = '';
                        if (weekKey && offset > 0) {
                            const weekNumber = weekKey.split('-W')[1];
                            weekInfo = ` (KW ${weekNumber})`;
                        }

                        const meta = `${dayLbl}${weekInfo}: <strong>${l.subject}</strong> ${startLbl}–${endLbl} | Raum ${l.room || '–'} | ${l.teacher || ''}`;

                        const folder = findFolderForSubject(l.subject);
                        const col = folder?.color || '#e5e7eb';
                        const folderHtml = folder
                            ? `<button class="folder-tile" id="ovHeroFolder" data-folder-id="${folder.id}" style="--col:${col}"><span class="swatch"></span></button>`
                            : `<button class="folder-tile" id="ovHeroCreateFolder" style="--col:#e5e7eb" title="Ordner anlegen"><span class="swatch"></span></button>`;
                        host.innerHTML = `
                            <div class="hero-compact">
                                <div>
                                <div class="hc-title">${title}</div>
                                <div class="hc-meta">${meta}</div>
                                </div>
                                ${folderHtml}
                            </div>`;

                        byId('ovHeroFolder')?.addEventListener('click', e => {
                            const id = e.currentTarget.getAttribute('data-folder-id');
                            if (id) { byId('navFolders').click(); openFolderDetail(id); }
                        });
                        byId('ovHeroCreateFolder')?.addEventListener('click', () => {
                            byId('navFolders').click(); openFolderEdit(null);
                        });
                    }
                }

                // Pomodoro-Init wie gehabt
                initPomodoroOnce();


                // Update "Als Nächstes" section
                updateNextUpSection();

                // Ensure height sync after overview is rendered
                setTimeout(() => {
                    syncHeuteBoxHeight();
                }, 50);

            } catch (error) {
                console.error('renderOverview: Error during render:', error);
                // Try to render at least the basic content
                const host = byId('ovHeroInline');
                if (host) {
                    host.innerHTML = `
                        <div class="hero-compact">
                            <div>
                                <div class="hc-title">Übersicht</div>
                                <div class="hc-meta">Lade Inhalt...</div>
                            </div>
                            <div style="width:56px;height:56px"></div>
                        </div>`;
                }
            }
        }


        function updateNextUpSection() {
            try {
                const nextUpTitle = byId('nextUpTitle');
                const nextUpSubtitle = byId('nextUpSubtitle');
                const nextUpTitleHeute = byId('nextUpTitleHeute');
                const nextUpSubtitleHeute = byId('nextUpSubtitleHeute');
                const nextUpInHeute = byId('nextUpInHeute');
                const nextUpActions = document.querySelector('.next-up-actions');

                if (!nextUpTitle || !nextUpSubtitle) return;

                // Get current or next lesson using existing logic
                const info = getCurrentOrNextLesson();

                if (!info) {
                    // No lessons found - show create button
                    nextUpTitle.textContent = t('nextUp');
                    nextUpSubtitle.textContent = t('noLessonsPlanned');

                    // Show create button
                    if (nextUpActions) {
                        nextUpActions.style.display = 'block';
                        const createBtn = nextUpActions.querySelector('.btn');
                        if (createBtn) {
                            createBtn.textContent = t('createClass') || 'Stunde hinzufügen';
                            createBtn.onclick = () => navigateToWeekWithRemainingDays();
                        }
                    }

                    // Hide next up in Heute card
                    if (nextUpInHeute) {
                        nextUpInHeute.style.display = 'none';
                    }
                } else {
                    const { l, type, start, end, dayIndex, offset, weekKey } = info;
                    const startLbl = timeLabelFromMinutes(dayStart, start);
                    const endLbl = timeLabelFromMinutes(dayStart, end);
                    const dayLbl = state.days[dayIndex] || `Tag ${dayIndex + 1}`;

                    // Calculate time until lesson
                    const now = new Date();
                    const lessonDate = new Date(now);
                    lessonDate.setDate(now.getDate() + offset);
                    const timeUntil = Math.max(0, Math.ceil((lessonDate.getTime() - now.getTime()) / (1000 * 60)));

                    // Determine title based on type and offset
                    let title = t('nextUp');
                    if (type === 'now') {
                        title = t('now');
                    } else if (offset === 0) {
                        title = t('nextUp');
                    } else if (offset === 1) {
                        title = t('tomorrow');
                    } else if (offset > 1) {
                        title = `${dayLbl} (in ${offset} Tagen)`;
                    }

                    // Format subtitle with comprehensive lesson details
                    let subtitle = `${l.subject} ${startLbl}–${endLbl}`;

                    // Add room information
                    if (l.room) {
                        subtitle += ` • Raum ${l.room}`;
                    }

                    // Add teacher information
                    if (l.teacher) {
                        subtitle += ` • ${l.teacher}`;
                    }

                    // Add duration information
                    const duration = l.span * state.periodMinutes;
                    subtitle += ` • ${duration} Min`;

                    // Add importance indicator
                    if (l.importance) {
                        subtitle += ` • <span class="ico"><svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon></svg></span> Wichtig`;
                    }

                    // Add week info if it's in a different week
                    if (weekKey && weekKey !== getCurrentWeekKey()) {
                        const weekNum = getWeekNumber(new Date(weekKey));
                        subtitle += ` • KW ${weekNum}`;
                    }

                    // Add time until lesson
                    if (type !== 'now' && offset >= 0) {
                        if (offset === 0) {
                            subtitle += ` • in ${Math.max(0, Math.ceil((start - minutesSinceStart(now)) / 60))}h`;
                        } else {
                            subtitle += ` • in ${offset} Tag${offset > 1 ? 'en' : ''}`;
                        }
                    }

                    // Update main next up section
                    nextUpTitle.textContent = title;
                    nextUpSubtitle.textContent = subtitle;

                    // Hide create button when lessons exist
                    if (nextUpActions) {
                        nextUpActions.style.display = 'none';
                    }

                    // Update Heute card - show all today's lessons using existing renderTodayList
                    const listTodayElement = byId('listToday');
                    if (listTodayElement) {
                        renderTodayList('listToday', selectedPlan);
                    }

                    // Hide the old next-up section since we're using the list now
                    if (nextUpInHeute) {
                        nextUpInHeute.style.display = 'none';
                    }
                }

            } catch (error) {
                console.error('Error updating next up section:', error);
            }
        }

        function navigateToWeekWithRemainingDays() {
            try {
                const now = new Date();
                const today = (now.getDay() + 6) % 7; // Convert to Monday=0 format
                const currentWeekKey = getCurrentWeekKey();

                // Get all week keys and sort them chronologically
                const allWeekKeys = Array.from(weekPlans.keys()).sort((a, b) => weekKeyCompare(a, b));

                // Find current week index and check from there onwards
                const currentWeekIndex = allWeekKeys.findIndex(key => key === currentWeekKey);
                const weeksToCheck = allWeekKeys.slice(Math.max(0, currentWeekIndex));

                // Look for the first week that has remaining days
                for (const weekKey of weeksToCheck) {
                    const plan = weekPlans.get(weekKey);
                    if (!plan || !plan.days || plan.days.length === 0) continue;

                    const weekOffset = weekKeyCompare(weekKey, currentWeekKey);

                    // Check if this week has any remaining days
                    for (let dayIndex = 0; dayIndex < plan.days.length; dayIndex++) {
                        // For current week, only check days from today onwards
                        if (weekOffset === 0 && dayIndex < today) continue;

                        // Check if this day has any lessons
                        const dayLessons = plan.lessons.filter(l => l.day === dayIndex);

                        // If this day has no lessons or has some empty periods, it's a good candidate
                        if (dayLessons.length === 0 || dayLessons.length < plan.periodCount) {
                            // Navigate to Plan section and switch to this week
                            slideToPage('pagePlan');
                            activatePill(byId('navPlan'));

                            // Switch to the target week
                            currentPlanWeek = weekKey;
                            localStorage.setItem('currentPlanWeek', currentPlanWeek);

                            // Render the grid for this week
                            renderGrid();
                            updatePlanSettingsForCurrentWeek();

                            console.log(`Navigated to week ${weekKey}, day ${dayIndex} (${plan.days[dayIndex]})`);
                            return;
                        }
                    }
                }

                // If no week with remaining days found, just go to current week
                slideToPage('pagePlan');
                activatePill(byId('navPlan'));
                currentPlanWeek = currentWeekKey;
                localStorage.setItem('currentPlanWeek', currentWeekKey);
                renderGrid();
                updatePlanSettingsForCurrentWeek();

            } catch (error) {
                console.error('Error navigating to week with remaining days:', error);
                // Fallback: just go to Plan section
                slideToPage('pagePlan');
                activatePill(byId('navPlan'));
                updatePlanSettingsForCurrentWeek();
            }
        }

        function getCurrentOrNextLesson() {
            const now = new Date();
            const today = (now.getDay() + 6) % 7;
            const nowMin = minutesSinceStart(now);
            const currentWeekKey = getCurrentWeekKey();

            // First, check if there's a lesson happening right now (current week only)
            const currentPlan = weekPlans.get(currentWeekKey);
            if (currentPlan && currentPlan.lessons.length > 0) {
                const todayLs = currentPlan.lessons.filter(l => l.day === today);
                for (const l of todayLs) {
                    const start = l.startIndex * (state.periodMinutes + state.breakMinutes);
                    const end = start + l.span * state.periodMinutes;
                    if (nowMin >= start && nowMin < end) {
                        return { type: 'now', l, start, end, dayIndex: today, offset: 0, weekKey: currentWeekKey };
                    }
                }
            }

            // Search for next lesson across ALL weeks
            const allUpcomingLessons = [];

            // Get all week keys and sort them chronologically
            const allWeekKeys = Array.from(weekPlans.keys()).sort((a, b) => weekKeyCompare(a, b));

            // Find current week index and check from there onwards
            const currentWeekIndex = allWeekKeys.findIndex(key => key === currentWeekKey);
            const weeksToCheck = allWeekKeys.slice(Math.max(0, currentWeekIndex));

            for (const weekKey of weeksToCheck) {
                const plan = weekPlans.get(weekKey);
                if (!plan || !plan.lessons.length) continue;

                const weekOffset = weekKeyCompare(weekKey, currentWeekKey);

                for (const l of plan.lessons) {
                    const start = l.startIndex * (state.periodMinutes + state.breakMinutes);
                    const end = start + l.span * state.periodMinutes;
                    const lessonDay = l.day;

                    // Skip lessons in the past
                    if (weekOffset === 0) {
                        if (lessonDay < today) continue;
                        if (lessonDay === today && start <= nowMin) continue;
                    }

                    // Calculate actual day offset from today
                    const currentDay = (now.getDay() + 6) % 7; // Monday = 0
                    const daysFromToday = (weekOffset * 7) + lessonDay - currentDay;

                    allUpcomingLessons.push({
                        l,
                        start,
                        end,
                        dayIndex: lessonDay,
                        offset: Math.max(0, daysFromToday),
                        weekKey,
                        absoluteDay: lessonDay + (weekOffset * 7)
                    });
                }
            }

            // Fallback to state.lessons if no week plans exist
            if (allUpcomingLessons.length === 0 && state.lessons.length > 0) {
                for (const l of state.lessons) {
                    const start = l.startIndex * (state.periodMinutes + state.breakMinutes);
                    const end = start + l.span * state.periodMinutes;
                    const lessonDay = l.day;

                    // Skip if this lesson is in the past
                    if (lessonDay < today) continue;
                    if (lessonDay === today && start <= nowMin) continue;
                    // Calculate actual day offset from today for fallback lessons
                    const currentDay = (now.getDay() + 6) % 7; // Monday = 0
                    const daysFromToday = lessonDay - currentDay;

                    allUpcomingLessons.push({
                        l,
                        start,
                        end,
                        dayIndex: lessonDay,
                        offset: Math.max(0, daysFromToday),
                        weekKey: currentWeekKey,
                        absoluteDay: lessonDay
                    });
                }
            }

            // Sort by day offset first, then by day, then by start time
            allUpcomingLessons.sort((a, b) => {
                if (a.offset !== b.offset) return a.offset - b.offset;
                if (a.dayIndex !== b.dayIndex) return a.dayIndex - b.dayIndex;
                return a.start - b.start;
            });

            if (allUpcomingLessons.length > 0) {
                return { type: "next", ...allUpcomingLessons[0] };
            }

            return null;
        }

        function getTodayLessons() {
            const now = new Date();
            const today = (now.getDay() + 6) % 7;
            const nowMin = minutesSinceStart(now);
            const currentWeekKey = getCurrentWeekKey();

            const currentPlan = weekPlans.get(currentWeekKey);
            if (!currentPlan || !currentPlan.lessons.length) {
                return { lessons: [], currentLesson: null };
            }

            // Check if today is enabled in the week settings
            const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            const todayName = dayNames[today];
            const isTodayEnabled = currentPlan.days?.includes(todayName) || state.days?.includes(todayName);

            if (!isTodayEnabled) {
                return { lessons: [], currentLesson: null };
            }

            const todayLs = currentPlan.lessons.filter(l => l.day === today);
            const allTodayLessons = [];
            let currentLesson = null;

            for (const l of todayLs) {
                const start = l.startIndex * (state.periodMinutes + state.breakMinutes);
                const currentPeriodMinutes = currentPlan.periodMinutes || state.periodMinutes;
                const currentPeriodCount = currentPlan.periodCount || state.periodCount;

                // Adjust lesson span if it exceeds available periods
                const adjustedSpan = Math.min(l.span, currentPeriodCount - l.startIndex);
                if (adjustedSpan <= 0) continue; // Skip lessons that no longer fit

                const end = start + adjustedSpan * currentPeriodMinutes;

                const lessonInfo = {
                    l: { ...l, span: adjustedSpan }, // Use adjusted span
                    start,
                    end,
                    dayIndex: today,
                    offset: 0,
                    weekKey: currentWeekKey,
                    isCurrent: nowMin >= start && nowMin < end,
                    isPast: end <= nowMin,
                    isFuture: start > nowMin
                };

                allTodayLessons.push(lessonInfo);

                if (lessonInfo.isCurrent) {
                    currentLesson = lessonInfo;
                }
            }

            // Sort by start time
            allTodayLessons.sort((a, b) => a.start - b.start);

            return {
                lessons: allTodayLessons,
                currentLesson: currentLesson,
                hasLessons: allTodayLessons.length > 0
            };
        }
        function renderOverviewHeroCompact() {
            const heroSub = byId('ovHeroSub');
            const info = getCurrentOrNextLesson();

            if (!info) {
                heroSub.innerHTML = `<div class="hero-compact">
                    <div><div class="hc-title">Heute: nichts mehr anstehend</div>
                    <div class="hc-meta">Alles geschafft <span class="ico"><svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4"></path><circle cx="12" cy="12" r="10"></circle></svg></span></div></div>
                    <div style="width:60px;height:60px"></div>
                    </div>`;
                return;
            }

            const { l, type, start, end, dayIndex } = info;
            const title = type === 'now' ? 'Jetzt' : 'Als Nächstes';
            const startLbl = timeLabelFromMinutes(dayStart, start);
            const endLbl = timeLabelFromMinutes(dayStart, end);
            const dayLbl = state.days[dayIndex] || `Tag ${dayIndex + 1}`;
            const meta = `${dayLbl}: <strong>${l.subject}</strong> ${startLbl}–${endLbl} | Raum ${l.room || '–'} | ${l.teacher || ''}`;

            const folder = findFolderForSubject(l.subject);
            const col = folder?.color || '#e5e7eb';
            const folderHtml = folder
                ? `<button class="folder-tile" id="ovHeroFolder" data-folder-id="${folder.id}" style="--col:${col}">
                        <span class="swatch"></span>
                    </button>`
                : `<button class="folder-tile" id="ovHeroCreateFolder" style="--col:#e5e7eb" title="Ordner anlegen">
                        <span class="swatch"></span>
                    </button>`;

            heroSub.innerHTML = `
                    <div class="hero-compact">
                    <div>
                    <div class="hc-title">${title}</div>
                    <div class="hc-meta">${meta}</div>
                    </div>
                    ${folderHtml}
                    </div>`;

            // Ordner-Klicks
            byId('ovHeroFolder')?.addEventListener('click', e => {
                const id = e.currentTarget.getAttribute('data-folder-id');
                if (id) { byId('navFolders').click(); openFolderDetail(id); }
            });
            byId('ovHeroCreateFolder')?.addEventListener('click', () => {
                byId('navFolders').click();
                openFolderEdit(null);
            });
        }


        function nextLessonLabel() {
            const info = currentOrNextLesson();
            if (info.type === 'none') return 'Heute: <strong>keine Stunde mehr</strong>.';

            const l = info.lesson;
            const start = timeLabelFromMinutes(dayStart, info.startMin);
            const end = timeLabelFromMinutes(dayStart, info.endMin);

            const dayLabel =
                (info.type === 'now')
                    ? 'Jetzt'
                    : (info.offset === 0
                        ? 'Als Nächstes'
                        : (info.offset === 1
                            ? 'Morgen'
                            : (state.days[info.dayIndex] || `Tag ${info.dayIndex + 1}`)));

            // Ordner ermitteln
            const folder = findFolderForSubject(l.subject);
            const folderHtml = folder
                ? `<span class="badge clickable" id="ovHeroFolder" data-folder-id="${folder.id}">Ordner: ${folder.name}</span>`
                : `<button class="btn mini primary" id="ovHeroCreateFolder">Ordner anlegen</button>`;

            // Restzeit, wenn gerade läuft
            let restHtml = '';
            if (info.type === 'now') {
                const minsLeft = Math.max(0, Math.ceil(info.endMin - minutesSinceStart(new Date())));
                restHtml = ` • <span class="meta">(${minsLeft} Min übrig)</span>`;
            }

            return `${dayLabel}: <strong>${l.subject}</strong> · ${start}–${end} · Raum ${l.room || '–'} · ${l.teacher || ''}${restHtml} &nbsp; ${folderHtml}`;
        }


        function calcWeekStats() {
            const minutes = state.lessons.reduce((sum, l) => sum + l.span * state.periodMinutes, 0);
            return { count: state.lessons.length, minutes, hours: Math.round(minutes / 60) };
        }
        function calcTodayStats() {
            const now = new Date(); const day = (now.getDay() + 6) % 7;
            const occ = new Set(state.lessons.filter(l => l.day === day).flatMap(l => {
                return Array.from({ length: l.span }, (_, i) => l.startIndex + i);
            }));
            const busy = occ.size;
            const free = Math.max(0, state.periodCount - busy);
            return { busyBlocks: busy, freeBlocks: free };
        }

        // returns an array of same shape but with color strings or null
        function buildHeatMatrix() {
            // matrix[period][day] = { color, importance } | null
            const m = Array.from({ length: state.periodCount }, () => Array(state.days.length).fill(null));

            for (const l of state.lessons) {
                const color = (l.color && l.color.trim()) || dataState.subjectColors[(l.subject || "").trim()] || "#60a5fa";
                for (let i = 0; i < l.span; i++) {
                    const p = l.startIndex + i;
                    if (p >= 0 && p < state.periodCount && l.day < state.days.length) {
                        // if multiple items collide visually, first wins
                        if (!m[p][l.day]) {
                            m[p][l.day] = { color, importance: !!l.importance };
                        }
                    }
                }
            }
            return m; // periods as rows (colors)
        }


        function subjectDistribution() {
            const map = new Map();
            for (const l of state.lessons) {
                const key = (l.subject || '—').trim();
                map.set(key, (map.get(key) || 0) + 1);
            }
            const labels = [...map.keys()];
            const values = labels.map(k => map.get(k));
            return { labels, values };
        }

        function syncHeuteBoxHeight() {
            const heatmapNavIsland = document.querySelector('.ov-heatmap-today .heatmap-nav-island');
            const heatmapElement = document.querySelector('#heatmap');
            const heuteBox = document.querySelector('.ov-heatmap-today .list-card');

            if (heatmapNavIsland && heatmapElement && heuteBox) {
                // Wait for next frame to ensure heatmap is fully rendered
                requestAnimationFrame(() => {
                    const islandHeight = heatmapNavIsland.offsetHeight;
                    const heatmapHeight = heatmapElement.offsetHeight;
                    const totalHeight = islandHeight + heatmapHeight + 8; // Add small padding to match bottom
                    heuteBox.style.height = totalHeight + 'px';
                });
            }
        }

        // Set up ResizeObserver to sync heights when heatmap changes size
        function setupHeatmapHeightSync() {
            const heatmapNavIsland = document.querySelector('.ov-heatmap-today .heatmap-nav-island');
            const heatmapElement = document.querySelector('#heatmap');

            if (heatmapNavIsland && heatmapElement && !heatmapElement._heightSyncSetup) {
                const resizeObserver = new ResizeObserver(() => {
                    syncHeuteBoxHeight();
                });
                resizeObserver.observe(heatmapNavIsland);
                resizeObserver.observe(heatmapElement);
                heatmapElement._heightSyncSetup = true;
            }
        }

        function drawHeatmap(id, matrix) {
            const el = byId(id); if (!el) return;

            // If the element is not laid out yet (width 0) retry shortly
            const computedW = el.clientWidth;
            if (!computedW || computedW < 10) {
                setTimeout(() => drawHeatmap(id, matrix), 50);
                return;
            }

            // Clean up any existing tooltips before redrawing
            document.querySelectorAll('.heatmap-tooltip').forEach(tooltip => {
                if (tooltip.parentNode) {
                    tooltip.parentNode.removeChild(tooltip);
                }
            });

            el.innerHTML = '';
            const containerW = computedW || 300;

            // Use heatmap plan for dimensions
            const heatmapPlan = getHeatmapWeekPlan();
            const days = heatmapPlan.days;
            const periodCount = heatmapPlan.periodCount;

            // Calculate cell dimensions - make cells much wider to reduce white space
            const cellW = Math.max(35, Math.floor(containerW / (days.length + 0.5)));

            // Reduce time column width further
            const timeColumnWidth = Math.max(30, Math.floor(cellW * 0.5)); // Make time column even narrower

            // Calculate total dimensions based on actual content
            const w = timeColumnWidth + cellW * days.length;

            // Calculate cell height with fixed size - don't stretch based on period count
            const fixedCellHeight = 30; // Fixed cell height to maintain consistent hour size
            const cellH = fixedCellHeight;
            const h = cellH * (periodCount + 1);

            // Update container height to fit content
            el.style.height = h + 'px';

            // Sync "Heute" box height with heatmap layout height
            syncHeuteBoxHeight();

            // Set up automatic height sync for future changes
            setupHeatmapHeightSync();

            // Force height sync after a short delay to ensure DOM is updated
            setTimeout(() => {
                syncHeuteBoxHeight();
            }, 100);

            const svg = svgEl('svg', { width: w, height: h });

            // day headers
            days.forEach((d, dx) => svg.appendChild(svgText(d, timeColumnWidth + cellW * dx + cellW / 2, cellH * 0.6)));

            // period labels with hover functionality
            for (let p = 0; p < periodCount; p++) {
                const lbl = timeLabelFromMinutes(heatmapPlan.dayStart, p * (heatmapPlan.periodMinutes + heatmapPlan.breakMinutes));
                const textEl = svgText(lbl, timeColumnWidth * 0.5, cellH * (p + 1.5));

                // Add hover functionality to time labels
                textEl.style.cursor = 'pointer';
                textEl.addEventListener('mouseenter', () => {
                    highlightHeatmapRow(p);
                });
                textEl.addEventListener('mouseleave', () => {
                    removeHeatmapRowHighlight();
                });

                svg.appendChild(textEl);
            }

            // Add horizontal lines between hours (only in the lesson area)
            for (let p = 1; p < periodCount; p++) {
                const lineY = cellH * (p + 1);
                const horizontalLine = svgEl('line', {
                    x1: timeColumnWidth,
                    y1: lineY,
                    x2: w,
                    y2: lineY,
                    stroke: 'var(--border)',
                    'stroke-width': '1'
                });
                svg.appendChild(horizontalLine);
            }

            // Render lessons as continuous blocks
            for (let d = 0; d < days.length; d++) {
                const dayLessons = matrix[d] || [];

                dayLessons.forEach(lesson => {
                    const x = timeColumnWidth + cellW * d;
                    const y = cellH * (lesson.startIndex + 1);
                    const width = cellW;
                    const height = cellH * lesson.span;

                    const color = lesson.color || dataState.subjectColors[(lesson.subject || "").trim()] || "#60a5fa";
                    const rect = svgRect(x + 2, y + 2, width - 4, height - 4, 6, color);

                    // Add hover functionality
                    rect.style.cursor = 'pointer';
                    rect.addEventListener('mouseenter', (e) => {
                        // Calculate which row the mouse is hovering over based on position
                        const rectBounds = rect.getBoundingClientRect();
                        const mouseY = e.clientY;
                        const relativeY = mouseY - rectBounds.top;
                        const cellH = fixedCellHeight; // Use the same cell height as defined in drawHeatmap
                        const hoveredRowIndex = Math.floor(relativeY / cellH);
                        const actualRowIndex = lesson.startIndex + hoveredRowIndex;
                        
                        // Highlight the row
                        highlightHeatmapRow(actualRowIndex);
                        
                        const timeRange = formatRange(lesson);
                        const importanceText = lesson.importance ? ' ⚠️ Wichtig' : '';
                        const tooltipContent = `${lesson.subject}${importanceText}\n${timeRange}\nRaum: ${lesson.room || '–'}\nLehrer: ${lesson.teacher || '–'}`;

                        // Create tooltip
                        const tooltip = document.createElement('div');
                        tooltip.className = 'heatmap-tooltip';
                        tooltip.textContent = tooltipContent;
                        tooltip.style.whiteSpace = 'pre-line';
                        document.body.appendChild(tooltip);

                        // Position tooltip
                        const tooltipBounds = tooltip.getBoundingClientRect();

                        let left = rectBounds.left + (rectBounds.width / 2) - (tooltipBounds.width / 2);
                        let top = rectBounds.top - tooltipBounds.height - 10;

                        // Adjust if tooltip goes off screen
                        if (left < 10) left = 10;
                        if (left + tooltipBounds.width > window.innerWidth - 10) {
                            left = window.innerWidth - tooltipBounds.width - 10;
                        }
                        if (top < 10) {
                            top = rectBounds.bottom + 10;
                            tooltip.style.transform = 'translateY(0)';
                        }

                        tooltip.style.left = left + 'px';
                        tooltip.style.top = top + 'px';

                        // Show tooltip
                        setTimeout(() => tooltip.classList.add('show'), 10);

                        // Store tooltip reference for cleanup
                        rect._tooltip = tooltip;
                    });

                    rect.addEventListener('mousemove', (e) => {
                        // Update highlighting as mouse moves within the lesson cell
                        const rectBounds = rect.getBoundingClientRect();
                        const mouseY = e.clientY;
                        const relativeY = mouseY - rectBounds.top;
                        const cellH = fixedCellHeight;
                        const hoveredRowIndex = Math.floor(relativeY / cellH);
                        const actualRowIndex = lesson.startIndex + hoveredRowIndex;
                        
                        highlightHeatmapRow(actualRowIndex);
                    });

                    rect.addEventListener('mouseleave', () => {
                        // Remove row highlight
                        removeHeatmapRowHighlight();
                        
                        if (rect._tooltip) {
                            rect._tooltip.classList.remove('show');
                            setTimeout(() => {
                                if (rect._tooltip && rect._tooltip.parentNode) {
                                    rect._tooltip.parentNode.removeChild(rect._tooltip);
                                }
                                rect._tooltip = null;
                            }, 200);
                        }
                    });

                    svg.appendChild(rect);

                    // Add border for important lessons
                    if (lesson.importance) {
                        const border = svgRect(x + 1, y + 1, width - 2, height - 2, 6, 'none');
                        border.setAttribute('stroke', '#f59e0b');
                        border.setAttribute('stroke-width', '2');
                        svg.appendChild(border);
                    }
                });
            }
            
            // Add invisible hover areas for empty cells to enable row highlighting
            for (let d = 0; d < days.length; d++) {
                for (let p = 0; p < periodCount; p++) {
                    const x = timeColumnWidth + cellW * d;
                    const y = cellH * (p + 1);
                    const width = cellW;
                    const height = cellH;
                    
                    // Check if this cell has a lesson
                    const hasLesson = matrix[d] && matrix[d].some(lesson => 
                        lesson.startIndex <= p && p < lesson.startIndex + lesson.span
                    );
                    
                    if (!hasLesson) {
                        // Create invisible hover area
                        const hoverArea = svgRect(x, y, width, height, 0, 'transparent');
                        hoverArea.style.cursor = 'pointer';
                        hoverArea.addEventListener('mouseenter', () => {
                            highlightHeatmapRow(p);
                        });
                        hoverArea.addEventListener('mouseleave', () => {
                            removeHeatmapRowHighlight();
                        });
                        svg.appendChild(hoverArea);
                    }
                }
            }
            
            el.appendChild(svg);


            // Add red time line to heatmap (only on current weekday of current week, solid line)
            const currentTime = new Date();
            const today = ((currentTime.getDay() + 6) % 7); // Mo=0

            // Check if we're showing the current week
            const currentWeekKeyHeatmap = getCurrentWeekKey();
            const isCurrentWeekHeatmap = weekKeyCompare(currentHeatmapWeek, currentWeekKeyHeatmap) === 0;

            // Use current plan for red line calculation if we're viewing the current week
            const planForRedLine = isCurrentWeekHeatmap ? getOrCreateWeekPlan(currentWeekKeyHeatmap) : heatmapPlan;
            const nowMin = minutesSinceStartFor(planForRedLine, currentTime);
            
            // Calculate the actual end of the school day based on the last lesson or time slot
            let schoolDayEndMin = 0;
            if (planForRedLine.timeSlots && planForRedLine.timeSlots.length > 0) {
                // Use the end time of the last time slot
                const lastTimeSlot = planForRedLine.timeSlots[planForRedLine.timeSlots.length - 1];
                schoolDayEndMin = lastTimeSlot.endTime - (planForRedLine.dayStart.h * 60 + planForRedLine.dayStart.m);
            } else {
                // Fallback to period-based calculation
                schoolDayEndMin = planForRedLine.periodCount * (planForRedLine.periodMinutes + planForRedLine.breakMinutes) - planForRedLine.breakMinutes;
            }

            const showRed = isCurrentWeekHeatmap && today < days.length && nowMin >= 0 && nowMin <= schoolDayEndMin;

            if (showRed) {
                // Clamp the red line position to stay within the school day bounds
                const clampedNowMin = Math.min(nowMin, schoolDayEndMin);
                // Calculate position based on periods: each period takes periodMinutes + breakMinutes time
                const redLineY = ((clampedNowMin / (planForRedLine.periodMinutes + planForRedLine.breakMinutes)) * cellH) + cellH; // +cellH for header offset

                // Create solid red line only on current weekday
                const currentDayX = timeColumnWidth + cellW * today;
                const redLine = svgEl('line', {
                    x1: currentDayX,
                    y1: redLineY,
                    x2: currentDayX + cellW,
                    y2: redLineY,
                    stroke: 'var(--accent)',
                    'stroke-width': '2'
                });
                svg.appendChild(redLine);
            }

            // Removed transparent green overlay - only mark completed days/lessons

            // Add completed overlays for past days and individual lessons
            const currentWeekKeyOverlay = getCurrentWeekKey();
            const isPastWeek = weekKeyCompare(currentHeatmapWeek, currentWeekKeyOverlay) < 0;
            const isCurrentWeekOverlay = currentHeatmapWeek === currentWeekKeyOverlay;
            const dayOfWeek = new Date().getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            for (let d = 0; d < days.length; d++) {
                const dayLessons = heatmapPlan.lessons.filter(l => l.day === d);

                if (isPastWeek) {
                    // Past weeks: full overlay for all days
                    const completedOverlay = svgEl('rect', {
                        x: timeColumnWidth + cellW * d,
                        y: cellH,
                        width: cellW,
                        height: h - cellH,
                        fill: 'rgba(34, 197, 94, 0.1)',
                        'pointer-events': 'none'
                    });
                    svg.appendChild(completedOverlay);

                    const checkmark = svgEl('text', {
                        x: timeColumnWidth + cellW * d + cellW / 2,
                        y: h / 2,
                        'text-anchor': 'middle',
                        'dominant-baseline': 'middle',
                        fill: '#22c55e',
                        'font-size': '60',
                        'font-weight': '900',
                        'font-family': 'Arial, sans-serif',
                        'pointer-events': 'none',
                        'opacity': '0.3',
                        'filter': 'drop-shadow(2px 2px 4px rgba(34, 197, 94, 0.7))',
                        'overflow': 'hidden'
                    });
                    checkmark.textContent = '✓';
                    svg.appendChild(checkmark);
                } else if (isCurrentWeekOverlay && d < today && dayOfWeek !== 0 && dayOfWeek !== 6) {
                    // Current week: only past days (but not on weekends)
                    const completedOverlay = svgEl('rect', {
                        x: timeColumnWidth + cellW * d,
                        y: cellH,
                        width: cellW,
                        height: h - cellH,
                        fill: 'rgba(34, 197, 94, 0.1)',
                        'pointer-events': 'none'
                    });
                    svg.appendChild(completedOverlay);

                    const checkmark = svgEl('text', {
                        x: timeColumnWidth + cellW * d + cellW / 2,
                        y: h / 2,
                        'text-anchor': 'middle',
                        'dominant-baseline': 'middle',
                        fill: '#22c55e',
                        'font-size': '60',
                        'font-weight': '900',
                        'font-family': 'Arial, sans-serif',
                        'pointer-events': 'none',
                        'opacity': '0.3',
                        'filter': 'drop-shadow(2px 2px 4px rgba(34, 197, 94, 0.7))',
                        'overflow': 'hidden'
                    });
                    checkmark.textContent = '✓';
                    svg.appendChild(checkmark);
                } else if (isCurrentWeekOverlay && d === today && nowMin > 0 && dayOfWeek !== 0 && dayOfWeek !== 6) {
                    // Today: check if school day has ended
                    let schoolDayEndMin = 0;
                    if (heatmapPlan.timeSlots && heatmapPlan.timeSlots.length > 0) {
                        // Use the end time of the last time slot
                        const lastTimeSlot = heatmapPlan.timeSlots[heatmapPlan.timeSlots.length - 1];
                        schoolDayEndMin = lastTimeSlot.endTime - (heatmapPlan.dayStart.h * 60 + heatmapPlan.dayStart.m);
                    } else {
                        // Fallback to period-based calculation
                        schoolDayEndMin = heatmapPlan.periodCount * (heatmapPlan.periodMinutes + heatmapPlan.breakMinutes) - heatmapPlan.breakMinutes;
                    }

                    if (nowMin >= schoolDayEndMin) {
                        // School day has ended: show full overlay
                        const completedOverlay = svgEl('rect', {
                            x: timeColumnWidth + cellW * d,
                            y: cellH,
                            width: cellW,
                            height: h - cellH,
                            fill: 'rgba(34, 197, 94, 0.1)',
                            'pointer-events': 'none'
                        });
                        svg.appendChild(completedOverlay);

                        const checkmark = svgEl('text', {
                            x: timeColumnWidth + cellW * d + cellW / 2,
                            y: h / 2,
                            'text-anchor': 'middle',
                            'dominant-baseline': 'middle',
                            fill: '#22c55e',
                            'font-size': '60',
                            'font-weight': '900',
                            'font-family': 'Arial, sans-serif',
                            'pointer-events': 'none',
                            'opacity': '0.3',
                            'filter': 'drop-shadow(2px 2px 4px rgba(34, 197, 94, 0.7))',
                            'overflow': 'hidden'
                        });
                        checkmark.textContent = '✓';
                        svg.appendChild(checkmark);
                    } else {
                        // School day is still ongoing: overlay only fully completed time blocks
                        const currentBlock = Math.floor(nowMin / (heatmapPlan.periodMinutes + heatmapPlan.breakMinutes));
                        const completedBlocks = Math.max(0, currentBlock - 1); // Only blocks that are fully completed
                        const currentProgressY = (completedBlocks * cellH) + cellH;

                        if (currentProgressY > cellH) {
                            const completedOverlay = svgEl('rect', {
                                x: timeColumnWidth + cellW * d,
                                y: cellH,
                                width: cellW,
                                height: currentProgressY - cellH,
                                fill: 'rgba(34, 197, 94, 0.1)',
                                'pointer-events': 'none'
                            });
                            svg.appendChild(completedOverlay);
                        }
                    }

                    // Mark individual completed lessons
                    dayLessons.forEach(lesson => {
                        const lessonEnd = (lesson.startIndex * (heatmapPlan.periodMinutes + heatmapPlan.breakMinutes)) + (lesson.span * heatmapPlan.periodMinutes);
                        if (nowMin > lessonEnd) {
                            const lessonY = cellH * (lesson.startIndex + 1);
                            const lessonHeight = cellH * lesson.span;

                            const lessonOverlay = svgEl('rect', {
                                x: timeColumnWidth + cellW * d + 2,
                                y: lessonY + 2,
                                width: cellW - 4,
                                height: lessonHeight - 4,
                                fill: 'rgba(34, 197, 94, 0.2)',
                                'pointer-events': 'none'
                            });
                            svg.appendChild(lessonOverlay);
                        }
                    });
                }
            }

            // Add global cleanup for tooltips on scroll/resize
            const cleanupTooltips = () => {
                document.querySelectorAll('.heatmap-tooltip').forEach(tooltip => {
                    if (tooltip.parentNode) {
                        tooltip.parentNode.removeChild(tooltip);
                    }
                });
            };

            // Clean up tooltips on various events
            window.addEventListener('scroll', cleanupTooltips);
            window.addEventListener('resize', cleanupTooltips);

            // Also clean up when clicking elsewhere
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.chart-wrap')) {
                    cleanupTooltips();
                }
            });
        }

        // Global heatmap row highlighting functions
        function highlightHeatmapRow(periodIndex) {
            // Remove any existing highlights
            removeHeatmapRowHighlight();

            const heatmapEl = byId('heatmap');
            if (!heatmapEl) return;

            const svg = heatmapEl.querySelector('svg');
            if (!svg) return;

            const heatmapPlan = getHeatmapWeekPlan();
            const days = heatmapPlan.days;
            const containerW = heatmapEl.clientWidth || 300;
            const cellW = Math.max(35, Math.floor(containerW / (days.length + 0.5)));
            const timeColumnWidth = Math.max(30, Math.floor(cellW * 0.5));
            const cellH = 30; // Fixed cell height from drawHeatmap

            // Create highlight overlay
            const highlight = svgEl('rect', {
                x: timeColumnWidth,
                y: cellH * (periodIndex + 1),
                width: cellW * days.length,
                height: cellH,
                fill: 'rgba(99, 102, 241, 0.12)',
                stroke: 'rgba(99, 102, 241, 0.4)',
                'stroke-width': '2',
                'id': 'heatmap-row-highlight',
                'pointer-events': 'none'
            });

            svg.appendChild(highlight);
        }

        function removeHeatmapRowHighlight() {
            const highlight = document.querySelector('#heatmap-row-highlight');
            if (highlight && highlight.parentNode) {
                highlight.parentNode.removeChild(highlight);
            }
        }

        function drawBars(id, labels, values) {
            const el = byId(id); if (!el) return; el.innerHTML = '';
            if (!labels.length) { el.innerHTML = '<div class="small">Keine Daten</div>'; return; }

            // Wait for layout: if container has no size yet, retry shortly
            const w0 = el.clientWidth; const h0 = el.clientHeight;
            if (!w0 || !h0) { setTimeout(() => drawBars(id, labels, values), 50); return; }
            const w = w0; const h = h0;
            const padL = 90, padR = 12, padT = 10, padB = 24;
            const max = Math.max(...values, 1);
            const barH = Math.min(26, Math.floor((h - padT - padB) / labels.length) - 6);

            const svg = svgEl('svg', { width: w, height: h });
            labels.forEach((lab, i) => {
                const y = padT + i * (barH + 8);
                const val = values[i];
                const bw = ((w - padL - padR) * val) / max;
                svg.appendChild(svgText(lab, padL - 10, y + barH * 0.75, 'end'));
                svg.appendChild(svgRect(padL, y, bw, barH, 8, '#34d399'));
                svg.appendChild(svgText(String(val), padL + bw + 6, y + barH * 0.75, 'start', 12, '#475569'));
            });
            el.appendChild(svg);
        }

        function svgEl(tag, attrs) { const n = document.createElementNS('http://www.w3.org/2000/svg', tag); for (const k in attrs) n.setAttribute(k, attrs[k]); return n; }
        function svgRect(x, y, w, h, r, fill) { const rct = svgEl('rect', { x, y, width: w, height: h, rx: r, ry: r, fill }); return rct; }
        function svgText(text, x, y, anchor = 'middle', size = 12, fill = 'var(--text)') {
            const t = svgEl('text', { x, y, 'text-anchor': anchor, 'dominant-baseline': 'middle', fill, 'font-size': size }); t.textContent = text; return t;
        }

        /* ===== Listen ===== */
        function renderTodayList(targetId, plan = null) {
            const box = byId(targetId); if (!box) return; box.innerHTML = '';
            const now = new Date(); const day = (now.getDay() + 6) % 7;
            const lessons = plan?.lessons || state.lessons;

            // Check if today is enabled in the week settings
            const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            const todayName = dayNames[day];
            const isTodayEnabled = plan?.days?.includes(todayName) || state.days?.includes(todayName);

            // If today is disabled, show message
            if (!isTodayEnabled) {
                box.innerHTML = '<div class="small">Heute ist kein Schultag.</div>';
                return;
            }

            const list = lessons
                .filter(l => l.day === day)
                .map(l => {
                    const startMin = l.startIndex * ((plan?.periodMinutes || state.periodMinutes) + (plan?.breakMinutes || state.breakMinutes));
                    const currentPeriodMinutes = plan?.periodMinutes || state.periodMinutes;
                    const currentPeriodCount = plan?.periodCount || state.periodCount;

                    // Adjust lesson span if it exceeds available periods
                    const adjustedSpan = Math.min(l.span, currentPeriodCount - l.startIndex);
                    const endMin = startMin + adjustedSpan * currentPeriodMinutes;

                    return {
                        l: { ...l, span: adjustedSpan }, // Use adjusted span
                        start: timeLabelFromMinutes(plan?.dayStart || state.dayStart, startMin),
                        end: timeLabelFromMinutes(plan?.dayStart || state.dayStart, endMin)
                    };
                })
                .filter(item => item.l.span > 0) // Only show lessons that still have duration
                .sort((a, b) => a.start.localeCompare(b.start));

            if (!list.length) { box.innerHTML = '<div class="small">Heute nichts geplant.</div>'; return; }
            list.forEach(it => {
                const row = document.createElement('div'); row.className = 'mini-item';

                // Find folder for this subject
                const folder = findFolderForSubject(it.l.subject);
                const folderHtml = folder
                    ? `<button class="folder-tile" data-folder-id="${folder.id}" style="--col:${folder.color || '#e5e7eb'}" title="Ordner öffnen"><span class="swatch"></span></button>`
                    : `<button class="folder-tile" data-folder-id="create" style="--col:#e5e7eb" title="Ordner anlegen"><span class="swatch"></span></button>`;

                const currentPeriodMinutes = plan?.periodMinutes || state.periodMinutes;
                row.innerHTML = `<div><strong>${it.l.subject}</strong><div class="meta">${it.start}–${it.end} · Raum ${it.l.room || '–'} · ${it.l.teacher || ''}</div></div>
                <div class="mini-item-right">
                    <span class="badge">${it.l.span}×${currentPeriodMinutes}</span>
                    ${folderHtml}
                </div>`;

                // Add click handlers
                row.addEventListener('click', (e) => {
                    if (!e.target.closest('.folder-tile')) {
                        openInfo(it.l.id);
                    }
                });

                // Folder click handler
                const folderBtn = row.querySelector('.folder-tile');
                folderBtn?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const folderId = folderBtn.getAttribute('data-folder-id');
                    if (folderId === 'create') {
                        byId('navFolders')?.click();
                        openFolderEdit(null);
                    } else {
                        byId('navFolders')?.click();
                        openFolderDetail(folderId);
                    }
                });

                box.appendChild(row);
            });
        }

        function renderRecentFiles(targetId) {
            const box = byId(targetId); if (!box) return; box.innerHTML = '';
            const items = folderState.folders.flatMap(f => f.items.map(it => ({ ...it, folder: f.name })))
                .sort((a, b) => new Date(b.added) - new Date(a.added)).slice(0, 6);
            if (!items.length) { box.innerHTML = '<div class="small">Noch keine Dateien.</div>'; return; }
            items.forEach(it => {
                const row = document.createElement('div'); row.className = 'mini-item';
                row.innerHTML = `<div><strong>${it.name}</strong><div class="meta">${it.folder} • ${it.ext.toUpperCase()} • ${new Date(it.added).toLocaleString()}</div></div>
                    <span class="badge">${it.topic}</span>`;
                row.addEventListener('click', () => { hideModal(document.querySelector('.modal[aria-hidden="false"]') || { setAttribute: () => { } }); byId('navFolders').click(); });
                box.appendChild(row);
            });
        }
        /* ===== Pomodoro-Timer (25/5) ===== */
        /* ===== Pomodoro-Timer (25/5) – Toggle Start/Pause ===== */
        let pom = {
            lenFocus: 25 * 60,
            lenBreak: 5 * 60,
            left: 25 * 60,
            mode: 'focus',
            running: false,
            toggling: false,
            t: null
        };

        function initPomodoroOnce() {
            if (initPomodoroOnce.did) return; initPomodoroOnce.did = true;

            const face = byId('pomFace');
            const pomCard = byId('pomCard');

            // Check if all required elements exist
            if (!face || !pomCard) {
                console.warn('Pomodoro elements not found, skipping initialization');
                return;
            }

            const fmt = s => {
                if (s >= 3600) {
                    // HH:MM:SS format for times >= 1 hour
                    const hours = Math.floor(s / 3600);
                    const minutes = Math.floor((s % 3600) / 60);
                    const seconds = s % 60;
                    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                } else {
                    // MM:SS format for times < 1 hour
                    return `${String(Math.floor(s / 60)).padStart(2, '0')}:${String(s % 60).padStart(2, '0')}`;
                }
            };

            const setToggleUI = () => {
                if (pom.running) {
                    face.classList.add('running');
                } else {
                    face.classList.remove('running');
                }
            };

            const render = () => {
                const timerDisplay = face.querySelector('.timer-display');
                if (timerDisplay) {
                    timerDisplay.textContent = fmt(pom.left);
                } else {
                    face.textContent = fmt(pom.left);
                }
            };

            const formatTimeInput = (input) => {
                // Remove all non-digits
                const digits = input.replace(/\D/g, '');

                if (digits.length === 0) return '';
                if (digits.length <= 2) return digits;
                if (digits.length === 3) return digits.slice(0, 2) + ':' + digits.slice(2);
                if (digits.length === 4) return digits.slice(0, 2) + ':' + digits.slice(2);
                if (digits.length === 5) return digits.slice(0, 2) + ':' + digits.slice(2, 4) + ':' + digits.slice(4);
                if (digits.length === 6) return digits.slice(0, 2) + ':' + digits.slice(2, 4) + ':' + digits.slice(4);

                // Limit to 6 digits (99:59:59)
                return digits.slice(0, 6).replace(/(\d{2})(\d{2})(\d{2})/, '$1:$2:$3');
            };

            const parseTimeInput = (input) => {
                // Remove all non-digits and colons
                const clean = input.replace(/[^\d:]/g, '');

                if (clean === '') return null;

                // Split by colons
                const parts = clean.split(':');

                if (parts.length === 1) {
                    // Single number - determine format
                    const num = parseInt(parts[0]);
                    if (num < 60) {
                        return num; // seconds
                    } else if (num < 100) {
                        return num * 60; // minutes
                    } else if (parts[0].length === 4) {
                        // 4 digits: HHMM or MMSS format
                        const str = parts[0].padStart(4, '0');
                        const first = parseInt(str.slice(0, 2));
                        const second = parseInt(str.slice(2, 4));

                        if (first < 24) {
                            return first * 3600 + second * 60; // HH:MM format
                        } else {
                            return first * 60 + second; // MM:SS format
                        }
                    } else if (parts[0].length === 6) {
                        // 6 digits: HHMMSS format
                        const str = parts[0].padStart(6, '0');
                        const hours = parseInt(str.slice(0, 2));
                        const minutes = parseInt(str.slice(2, 4));
                        const seconds = parseInt(str.slice(4, 6));
                        return hours * 3600 + minutes * 60 + seconds;
                    } else {
                        // Other lengths: treat as MM:SS
                        const str = parts[0].padStart(4, '0');
                        const first = parseInt(str.slice(0, 2));
                        const second = parseInt(str.slice(2, 4));
                        return first * 60 + second;
                    }
                } else if (parts.length === 2) {
                    // MM:SS format - normalize invalid values
                    let minutes = parseInt(parts[0]) || 0;
                    let seconds = parseInt(parts[1]) || 0;

                    // Normalize seconds (carry over to minutes)
                    if (seconds >= 60) {
                        minutes += Math.floor(seconds / 60);
                        seconds = seconds % 60;
                    }

                    // Limit minutes to 99 (99:59 = 5999 seconds)
                    if (minutes > 99) {
                        minutes = 99;
                        seconds = 59;
                    }

                    return minutes * 60 + seconds;
                } else if (parts.length === 3) {
                    // HH:MM:SS format - normalize invalid values
                    let hours = parseInt(parts[0]) || 0;
                    let minutes = parseInt(parts[1]) || 0;
                    let seconds = parseInt(parts[2]) || 0;

                    // Normalize seconds (carry over to minutes)
                    if (seconds >= 60) {
                        minutes += Math.floor(seconds / 60);
                        seconds = seconds % 60;
                    }

                    // Normalize minutes (carry over to hours)
                    if (minutes >= 60) {
                        hours += Math.floor(minutes / 60);
                        minutes = minutes % 60;
                    }

                    // Limit hours to 99 (99:59:59 = 359999 seconds)
                    if (hours > 99) {
                        hours = 99;
                        minutes = 59;
                        seconds = 59;
                    }

                    return hours * 3600 + minutes * 60 + seconds;
                }

                return null;
            };

            const startEditMode = () => {
                if (pom.running || pom.toggling) return; // Don't allow editing while running or toggling

                const timerDisplay = face.querySelector('.timer-display');
                if (!timerDisplay) return;

                // Clear any pending clicks
                if (clickTimeout) {
                    clearTimeout(clickTimeout);
                    clickTimeout = null;
                }
                clickCount = 0;

                const currentTime = timerDisplay.textContent;
                timerDisplay.contentEditable = true;
                timerDisplay.textContent = '';
                timerDisplay.focus();

                // Add edit mode styling
                timerDisplay.classList.add('editing');

                const finishEdit = () => {
                    timerDisplay.contentEditable = false;
                    timerDisplay.classList.remove('editing');

                    const timeText = timerDisplay.textContent.trim();
                    const totalSeconds = parseTimeInput(timeText);

                    if (totalSeconds !== null && totalSeconds > 0 && totalSeconds <= 359999) { // Max 99:59:59
                        pom.left = totalSeconds;
                        pom.lenFocus = totalSeconds;
                        render();
                    } else {
                        // Reset to valid default if invalid
                        pom.lenFocus = 25 * 60;
                        pom.left = pom.lenFocus;
                        render();
                    }
                };

                // Handle input events for real-time formatting
                timerDisplay.addEventListener('input', (e) => {
                    const formatted = formatTimeInput(e.target.textContent);
                    e.target.textContent = formatted;

                    // Set cursor to end
                    const range = document.createRange();
                    const sel = window.getSelection();
                    range.selectNodeContents(e.target);
                    range.collapse(false);
                    sel.removeAllRanges();
                    sel.addRange(range);
                });

                // Finish edit on Enter key
                timerDisplay.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        finishEdit();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        timerDisplay.contentEditable = false;
                        timerDisplay.classList.remove('editing');
                        render(); // Reset to current time
                    }
                });

                // Finish edit on blur (click outside)
                timerDisplay.addEventListener('blur', finishEdit);
            };

            const triggerTimerEndEffects = () => {
                // Add red background and blinking to timer
                pomCard.classList.add('timer-ended');

                // Add website blinking effect
                document.body.classList.add('website-blink');

                // Remove effects after animation completes
                setTimeout(() => {
                    pomCard.classList.remove('timer-ended');
                    document.body.classList.remove('website-blink');
                }, 6000); // 2s * 3 blinks = 6s total
            };

            const tick = () => {
                if (!pom.running || !pom.t) return;

                // Ensure left time is valid
                if (pom.left <= 0) {
                    pom.left = 0;
                } else {
                    pom.left--;
                }

                if (pom.left <= 0) {
                    // Stop the timer when it reaches 0
                    pom.running = false;
                    if (pom.t) {
                        clearInterval(pom.t);
                        pom.t = null;
                    }

                    // Trigger end effects when timer reaches 0
                    triggerTimerEndEffects();

                    // Update UI to show stopped state
                    setToggleUI();
                }
                render();
            };

            const toggleTimer = () => {
                // Prevent rapid toggling
                if (pom.toggling) return;
                pom.toggling = true;

                // Add visual feedback
                face.classList.add('clicked');
                setTimeout(() => face.classList.remove('clicked'), 150);

                // If timer is at 00:00 and we're starting, switch to next mode
                if (pom.left <= 0 && !pom.running) {
                    if (pom.mode === 'focus') {
                        pom.mode = 'break';
                        pom.left = pom.lenBreak;
                    } else {
                        pom.mode = 'focus';
                        pom.left = pom.lenFocus;
                    }
                }

                pom.running = !pom.running;
                if (pom.running && !pom.t) {
                    pom.t = setInterval(tick, 1000);
                } else if (!pom.running && pom.t) {
                    clearInterval(pom.t);
                    pom.t = null;
                }
                setToggleUI();
                render();

                // Reset toggling flag after a short delay
                setTimeout(() => {
                    pom.toggling = false;
                }, 300);
            };

            // Improved click handling with better state management
            let clickCount = 0;
            let clickTimeout = null;
            let lastClickTime = 0;

            const handleClick = (e) => {
                const now = Date.now();
                const timeSinceLastClick = now - lastClickTime;
                lastClickTime = now;

                // Clear any existing timeout
                if (clickTimeout) {
                    clearTimeout(clickTimeout);
                    clickTimeout = null;
                }

                clickCount++;

                // If it's been more than 300ms since last click, reset counter
                if (timeSinceLastClick > 300) {
                    clickCount = 1;
                }

                if (clickCount === 1) {
                    // Single click - wait to see if there's a second click
                    clickTimeout = setTimeout(() => {
                        if (clickCount === 1) {
                            // Confirmed single click
                            toggleTimer();
                        }
                        clickCount = 0;
                    }, 250);
                } else if (clickCount === 2) {
                    // Double click detected
                    clickCount = 0;
                    startEditMode();
                }
            };

            face.addEventListener('click', handleClick);

            // Add double-click to edit mode for timer display (backup)
            const timerDisplay = face.querySelector('.timer-display');
            if (timerDisplay) {
                timerDisplay.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    // Clear any pending single click
                    if (clickTimeout) {
                        clearTimeout(clickTimeout);
                        clickTimeout = null;
                    }
                    clickCount = 0;
                    startEditMode();
                });
            }

            byId('pomReset')?.addEventListener('click', (e) => {
                e.stopPropagation();

                // Add visual feedback
                const resetBtn = e.target;
                resetBtn.classList.add('clicked');
                setTimeout(() => resetBtn.classList.remove('clicked'), 150);

                // Clear any pending clicks
                if (clickTimeout) {
                    clearTimeout(clickTimeout);
                    clickTimeout = null;
                }
                clickCount = 0;

                // Reset timer state
                pom.running = false;
                pom.mode = 'focus';
                pom.toggling = false;

                // Ensure lenFocus is valid, fallback to 25 minutes
                if (pom.lenFocus <= 0 || pom.lenFocus > 359999) {
                    pom.lenFocus = 25 * 60;
                }
                pom.left = pom.lenFocus;

                // Clear interval safely
                if (pom.t) {
                    clearInterval(pom.t);
                    pom.t = null;
                }

                setToggleUI();
                render();
            });

            setToggleUI();
            render();
        }

        // Quick-Links
        byId('ovGoPlan')?.addEventListener('click', () => byId('navPlan').click());
        byId('ovGoFolders')?.addEventListener('click', () => byId('navFolders').click());
        byId('ovGoSettings')?.addEventListener('click', () => byId('navSettings').click());

        /* ===== Profile Switch System ===== */
        let currentTimetableProfile = localStorage.getItem('currentTimetableProfile') || 'default';
        let timetableProfiles = JSON.parse(localStorage.getItem('timetableProfiles') || '{}');

        function initializeTimetableProfiles() {
            console.log('Initializing timetable profiles...');
            console.log('Current profile from localStorage:', currentTimetableProfile);
            console.log('Existing profiles:', Object.keys(timetableProfiles));

            // Initialize default profile if none exists
            if (!timetableProfiles['default']) {
                console.log('No default profile found, creating one...');
                timetableProfiles['default'] = {
                    id: 'default',
                    name: 'Default',
                    type: 'School',
                    color: '#6366f1',
                    created: new Date().toISOString(),
                    description: 'Main school timetable',
                    favorited: false
                };
                saveTimetableProfiles();
                console.log('Default profile created successfully');
            } else {
                console.log('Default profile already exists:', timetableProfiles['default']);
            }

            // Ensure all existing profiles have the favorited field
            Object.values(timetableProfiles).forEach(profile => {
                if (profile.favorited === undefined) {
                    profile.favorited = false;
                }
            });
            saveTimetableProfiles();

            // Set current profile if not set or if current profile doesn't exist
            if (!timetableProfiles[currentTimetableProfile]) {
                console.log('Current profile not found, switching to default');
                currentTimetableProfile = 'default';
                localStorage.setItem('currentTimetableProfile', currentTimetableProfile);
                console.log('Current profile set to default');
            } else {
                console.log('Current profile found:', timetableProfiles[currentTimetableProfile]);
            }

            // Double-check that the default profile exists and is valid
            if (!timetableProfiles['default'] || !timetableProfiles['default'].id) {
                console.error('Default profile is missing or corrupted, resetting...');
                resetDefaultProfile();
                return; // Exit early, resetDefaultProfile will handle the rest
            }

            // Load current profile data
            console.log('Loading current profile data...');
            loadCurrentProfileData();

            console.log('Updating profile switch display...');
            updateProfileSwitchDisplay();
            loadProfileSwitchList();

            console.log('Timetable profiles initialized successfully:', {
                currentProfile: currentTimetableProfile,
                availableProfiles: Object.keys(timetableProfiles),
                profileDetails: timetableProfiles
            });
        }

        function saveTimetableProfiles() {
            localStorage.setItem('timetableProfiles', JSON.stringify(timetableProfiles));
        }

        // Function to reset and recreate the default profile if it's corrupted
        function resetDefaultProfile() {
            console.log('Resetting default profile...');

            // Remove any existing default profile data
            localStorage.removeItem('timetableProfile_default');

            // Create a fresh default profile
            timetableProfiles['default'] = {
                id: 'default',
                name: 'Default',
                type: 'School',
                color: '#6366f1',
                created: new Date().toISOString(),
                description: 'Main school timetable',
                favorited: false
            };

            // Save the profiles
            saveTimetableProfiles();

            // Set as current profile
            currentTimetableProfile = 'default';
            localStorage.setItem('currentTimetableProfile', 'default');

            // Create empty profile data
            createEmptyProfileData('default');

            // Update displays
            updateProfileSwitchDisplay();
            loadProfileSwitchList();

            console.log('Default profile reset successfully');
        }

        function toggleProfileSwitch() {
            console.log('toggleProfileSwitch called');

            // Find the profile switch that was clicked
            const clickedSwitch = event.target.closest('.profile-switch');
            if (!clickedSwitch) {
                console.error('No profile switch found');
                return;
            }

            const dropdown = clickedSwitch.parentElement.querySelector('.profile-switch-dropdown');

            console.log('Elements found:', { dropdown: !!dropdown, switchEl: !!clickedSwitch });

            if (dropdown && clickedSwitch) {
                const isOpen = dropdown.classList.contains('open');
                console.log('Current state:', { isOpen });

                if (isOpen) {
                    dropdown.classList.remove('open');
                    clickedSwitch.classList.remove('open');
                    console.log('Profile switch closed');
                } else {
                    // Close any other open dropdowns
                    document.querySelectorAll('.profile-switch-dropdown.open').forEach(el => {
                        el.classList.remove('open');
                    });
                    document.querySelectorAll('.profile-switch.open').forEach(el => {
                        el.classList.remove('open');
                    });

                    dropdown.classList.add('open');
                    clickedSwitch.classList.add('open');
                    console.log('Profile switch opened, loading list...');
                    loadProfileSwitchList();
                }
            } else {
                console.error('Profile switch elements not found');
            }
        }

        function loadProfileSwitchList() {
            console.log('loadProfileSwitchList called');

            // Find all profile switch lists on all pages
            const lists = document.querySelectorAll('.profile-switch-list');
            if (lists.length === 0) {
                console.error('No profile switch lists found');
                return;
            }

            const profiles = Object.values(timetableProfiles);
            console.log('Loading profiles:', profiles.map(p => ({ id: p.id, name: p.name })));

            const profileListHTML = profiles.map(profile => `
                <div class="profile-switch-item ${profile.id === currentTimetableProfile ? 'active' : ''}" 
                     onclick="switchToProfile('${profile.id}')">
                    <div class="profile-switch-item-avatar" style="background: ${profile.color}">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                    </div>
                    <div class="profile-switch-item-info">
                        <div class="profile-switch-item-name">
                            ${profile.name}
                            ${profile.favorited ? '<span class="favorite-indicator">★</span>' : ''}
                        </div>
                        <div class="profile-switch-item-type">${profile.type}</div>
                    </div>
                    <div class="profile-switch-item-actions">
                        <button class="profile-switch-item-action favorite-btn ${profile.favorited ? 'favorited' : ''}" 
                                onclick="event.stopPropagation(); toggleProfileFavorite('${profile.id}')" 
                                title="${profile.favorited ? 'Unfavorite' : 'Favorite'} profile">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon>
                            </svg>
                        </button>
                        <button class="profile-switch-item-action delete-btn" 
                                onclick="event.stopPropagation(); deleteProfile('${profile.id}')" 
                                title="Delete profile"
                                ${profile.favorited ? 'disabled' : ''}>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3,6 5,6 21,6"></polyline>
                                <path d="M19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `).join('');

            // Update all profile switch lists
            lists.forEach(list => {
                list.innerHTML = profileListHTML;
            });

            console.log('Profile switch lists loaded with', profiles.length, 'profiles on', lists.length, 'pages');
        }

        function updateProfileSwitchDisplay() {
            const currentProfile = timetableProfiles[currentTimetableProfile];
            if (!currentProfile) {
                console.warn('No current profile found:', currentTimetableProfile);
                return;
            }

            // Find all profile switch displays on all pages
            const nameEls = document.querySelectorAll('.profile-switch-name');
            const typeEls = document.querySelectorAll('.profile-switch-type');
            const avatarEls = document.querySelectorAll('.profile-switch-avatar');

            console.log('Updating profile display:', currentProfile);
            console.log('Found elements:', { nameEls: nameEls.length, typeEls: typeEls.length, avatarEls: avatarEls.length });

            // Update all name elements
            nameEls.forEach(nameEl => {
                nameEl.textContent = currentProfile.name;
            });
            console.log('Updated profile name to:', currentProfile.name);

            // Update all type elements
            typeEls.forEach(typeEl => {
                typeEl.textContent = currentProfile.type;
            });
            console.log('Updated profile type to:', currentProfile.type);

            // Update all avatar elements
            avatarEls.forEach(avatarEl => {
                avatarEl.style.background = currentProfile.color;
            });
            console.log('Updated profile color to:', currentProfile.color);
        }

        function switchToProfile(profileId) {
            console.log('switchToProfile called with:', profileId);

            if (profileId === currentTimetableProfile) {
                console.log('Already on this profile, just closing dropdown');
                toggleProfileSwitch();
                return;
            }

            // Check if profile exists
            if (!timetableProfiles[profileId]) {
                console.error('Profile not found:', profileId);
                alert('Profile not found. Please refresh the page.');
                return;
            }

            try {
                // Save current profile data
                console.log('Saving current profile data...');
                saveCurrentProfileData();

                // Switch to new profile
                currentTimetableProfile = profileId;
                localStorage.setItem('currentTimetableProfile', profileId);
                console.log('Switched to profile ID:', profileId);

                // Load new profile data
                console.log('Loading new profile data...');
                loadCurrentProfileData();

                // Update display
                console.log('Updating profile switch display...');
                updateProfileSwitchDisplay();
                loadProfileSwitchList();

                // Close dropdown
                toggleProfileSwitch();

                // Force complete refresh of all displays
                console.log('Refreshing all displays...');
                refreshAllDisplays();

                console.log(`Successfully switched to profile: ${timetableProfiles[profileId].name}`);
            } catch (error) {
                console.error('Error switching profile:', error);
                alert('Error switching profile. Please try again.');
            }
        }

        function refreshAllDisplays() {
            // Refresh all data-dependent displays
            renderGrid();
            renderOverview();

            // Update plan settings if on plan page
            if (!byId('pagePlan').hidden) {
                updatePlanSettingsForCurrentWeek();
                populateSettingsInputs();
            }

            // Update heatmap if on analysis page
            if (!byId('pageProfile').hidden) {
                const analysisContent = byId('profileAnalysisContent');
                if (analysisContent && analysisContent.classList.contains('expanded')) {
                    renderAnalysis();
                }
            }

            // Force re-render of current page
            const currentPage = document.querySelector('.container:not([hidden])');
            if (currentPage) {
                // Trigger a small delay to ensure all data is loaded
                setTimeout(() => {
                    if (currentPage.id === 'pagePlan') {
                        renderGrid();
                    } else if (currentPage.id === 'pageOverview') {
                        renderOverview();
                    }
                }, 100);
            }
        }

        function createNewProfile() {
            const name = prompt('Enter profile name:');
            if (!name || name.trim() === '') return;

            const type = prompt('Enter profile type (e.g., School, Work, University):') || 'Custom';
            const profileId = 'profile_' + Date.now();

            const newProfile = {
                id: profileId,
                name: name.trim(),
                type: type.trim(),
                color: '#6366f1',
                created: new Date().toISOString(),
                description: `${type} timetable profile`
            };

            timetableProfiles[profileId] = newProfile;
            saveTimetableProfiles();

            // Create empty profile data instead of copying default
            createEmptyProfileData(profileId);

            // Switch to new profile
            switchToProfile(profileId);

            console.log(`Created new profile: ${name} (empty profile)`);
        }

        // New profile creation functions
        function toggleProfileCreation(formId = 1) {
            const formElement = byId(`profileCreationForm${formId === 1 ? '' : formId}`);
            const listElement = byId(`profileSwitchList${formId === 1 ? '' : formId}`);
            
            if (!formElement || !listElement) return;
            
            const isVisible = formElement.style.display !== 'none';
            
            if (isVisible) {
                // Hide form
                formElement.style.display = 'none';
                listElement.style.display = 'block';
            } else {
                // Show form
                formElement.style.display = 'block';
                listElement.style.display = 'none';
                
                // Focus on name input
                const nameInput = byId(`profileNameInput${formId === 1 ? '' : formId}`);
                if (nameInput) {
                    setTimeout(() => nameInput.focus(), 100);
                }
            }
        }

        function createProfileFromForm(formId = 1) {
            const nameInput = byId(`profileNameInput${formId === 1 ? '' : formId}`);
            const typeInput = byId(`profileTypeInput${formId === 1 ? '' : formId}`);
            
            if (!nameInput || !typeInput) return;
            
            const name = nameInput.value.trim();
            const type = typeInput.value.trim();
            
            if (!name) {
                alert('Bitte gib einen Profilnamen ein.');
                nameInput.focus();
                return;
            }
            
            const profileId = 'profile_' + Date.now();
            const newProfile = {
                id: profileId,
                name: name,
                type: type || 'Custom',
                color: '#6366f1',
                created: new Date().toISOString(),
                description: `${type || 'Custom'} timetable profile`
            };

            timetableProfiles[profileId] = newProfile;
            saveTimetableProfiles();

            // Create empty profile data
            createEmptyProfileData(profileId);

            // Switch to new profile
            switchToProfile(profileId);

            // Reset form and hide it
            nameInput.value = '';
            typeInput.value = '';
            toggleProfileCreation(formId);

            console.log(`Created new profile: ${name} (empty profile)`);
        }

        function cancelProfileCreation(formId = 1) {
            const nameInput = byId(`profileNameInput${formId === 1 ? '' : formId}`);
            const typeInput = byId(`profileTypeInput${formId === 1 ? '' : formId}`);
            
            if (nameInput) nameInput.value = '';
            if (typeInput) typeInput.value = '';
            
            toggleProfileCreation(formId);
        }

        // Add Enter key support for profile creation forms
        function setupProfileFormEvents() {
            // Setup for first form
            const nameInput1 = byId('profileNameInput');
            const typeInput1 = byId('profileTypeInput');
            
            if (nameInput1) {
                nameInput1.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        createProfileFromForm(1);
                    }
                });
            }
            
            if (typeInput1) {
                typeInput1.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        createProfileFromForm(1);
                    }
                });
            }
            
            // Setup for second form
            const nameInput2 = byId('profileNameInput2');
            const typeInput2 = byId('profileTypeInput2');
            
            if (nameInput2) {
                nameInput2.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        createProfileFromForm(2);
                    }
                });
            }
            
            if (typeInput2) {
                typeInput2.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        createProfileFromForm(2);
                    }
                });
            }
        }

        function createEmptyProfileData(targetProfileId) {
            // Create completely empty profile data
            const emptyProfileData = {
                weekPlans: {},
                state: {
                    lessons: [],
                    days: ['Mo', 'Di', 'Mi', 'Do', 'Fr'],
                    periodMinutes: 45,
                    breakMinutes: 5,
                    periodCount: 8,
                    dayStart: { h: 8, m: 0 },
                    currentPlanWeek: getCurrentWeekKey(),
                    currentHeatmapWeek: getCurrentWeekKey(),
                    overviewWeekKey: getCurrentWeekKey()
                },
                folderState: {
                    folders: []
                },
                dataState: {
                    subjectColors: {},
                    presets: []
                }
            };

            localStorage.setItem(`timetableProfile_${targetProfileId}`, JSON.stringify(emptyProfileData));
            console.log(`Created empty profile data for ${targetProfileId}`);
        }

        function copyDefaultProfileData(targetProfileId) {
            // Get default profile data
            const defaultProfileData = JSON.parse(localStorage.getItem('timetableProfile_default') || '{}');

            if (defaultProfileData.weekPlans || defaultProfileData.state) {
                // Copy all default data to new profile
                localStorage.setItem(`timetableProfile_${targetProfileId}`, JSON.stringify(defaultProfileData));
                console.log(`Copied default profile data to ${targetProfileId}`);
            } else {
                // If no default data exists, create basic structure
                createEmptyProfileData(targetProfileId);
            }
        }

        function deleteProfile(profileId) {
            const profile = timetableProfiles[profileId];
            if (!profile) return;

            // Check if profile is favorited
            if (profile.favorited) {
                alert('Cannot delete a favorited profile. Please unfavorite it first.');
                return;
            }

            if (confirm(`Are you sure you want to delete the profile "${profile.name}"?`)) {
                // If deleting current profile, switch to another profile first
                if (profileId === currentTimetableProfile) {
                    const remainingProfiles = Object.keys(timetableProfiles).filter(id => id !== profileId);
                    if (remainingProfiles.length > 0) {
                        switchToProfile(remainingProfiles[0]);
                    } else {
                        // If this is the last profile, create a new default
                        createNewDefaultProfile();
                        return;
                    }
                }

                // Delete profile data
                delete timetableProfiles[profileId];
                localStorage.removeItem(`timetableProfile_${profileId}`);

                // If we deleted the default profile, create a new one
                if (profileId === 'default') {
                    createNewDefaultProfile();
                } else {
                    saveTimetableProfiles();
                }

                loadProfileSwitchList();

                console.log(`Deleted profile: ${profileId}`);
            }
        }

        function createNewDefaultProfile() {
            // Create a new default profile with consistent ID
            const newDefaultProfile = {
                id: 'default',
                name: 'Default',
                type: 'School',
                color: '#6366f1',
                created: new Date().toISOString(),
                description: 'Main school timetable',
                favorited: false
            };

            // Store the profile with the correct ID
            timetableProfiles['default'] = newDefaultProfile;
            saveTimetableProfiles();

            // Create empty data for the new default
            createEmptyProfileData('default');

            // Switch to the new default
            currentTimetableProfile = 'default';
            localStorage.setItem('currentTimetableProfile', 'default');

            // Update displays
            updateProfileSwitchDisplay();
            loadProfileSwitchList();
            refreshAllDisplays();

            console.log('Created new default profile with ID: default');
        }

        function toggleProfileFavorite(profileId) {
            const profile = timetableProfiles[profileId];
            if (!profile) return;

            profile.favorited = !profile.favorited;
            saveTimetableProfiles();
            loadProfileSwitchList();

            console.log(`Profile ${profile.name} ${profile.favorited ? 'favorited' : 'unfavorited'}`);
        }

        function saveCurrentProfileData() {
            console.log(`Saving profile data for: ${currentTimetableProfile}`);

            // Save all current data with profile prefix
            const profileData = {
                weekPlans: Object.fromEntries(weekPlans),
                state: { ...state }, // Create a copy to avoid reference issues
                folderState: { ...folderState },
                dataState: { ...dataState }
            };

            console.log('Profile data to save:', profileData);

            localStorage.setItem(`timetableProfile_${currentTimetableProfile}`, JSON.stringify(profileData));

            console.log('Profile data saved successfully');
        }

        function loadCurrentProfileData() {
            console.log(`Loading profile data for: ${currentTimetableProfile}`);

            // Load profile-specific data
            const profileData = JSON.parse(localStorage.getItem(`timetableProfile_${currentTimetableProfile}`) || '{}');

            console.log('Profile data loaded:', profileData);

            if (profileData.weekPlans) {
                weekPlans.clear();
                Object.entries(profileData.weekPlans).forEach(([key, value]) => {
                    weekPlans.set(key, value);
                });
                console.log('Week plans loaded:', Object.fromEntries(weekPlans));
            }

            if (profileData.state) {
                // Clear current state and assign new state
                // Clear arrays properly
                state.lessons.length = 0;
                state.days.length = 0;

                // Assign new data
                if (profileData.state.lessons) state.lessons.push(...profileData.state.lessons);
                if (profileData.state.days) state.days.push(...profileData.state.days);
                if (profileData.state.periodMinutes !== undefined) state.periodMinutes = profileData.state.periodMinutes;
                if (profileData.state.breakMinutes !== undefined) state.breakMinutes = profileData.state.breakMinutes;
                if (profileData.state.periodCount !== undefined) state.periodCount = profileData.state.periodCount;
                if (profileData.state.currentPlanWeek !== undefined) state.currentPlanWeek = profileData.state.currentPlanWeek;
                if (profileData.state.currentHeatmapWeek !== undefined) state.currentHeatmapWeek = profileData.state.currentHeatmapWeek;
                if (profileData.state.overviewWeekKey !== undefined) state.overviewWeekKey = profileData.state.overviewWeekKey;

                console.log('State loaded:', state);
            }

            if (profileData.folderState) {
                // Clear current folder state and assign new state
                // Clear arrays properly
                folderState.folders.length = 0;

                // Assign new data
                if (profileData.folderState.folders) folderState.folders.push(...profileData.folderState.folders);

                console.log('Folder state loaded:', folderState);
            }

            if (profileData.dataState) {
                // Clear current data state and assign new state
                // Clear arrays and objects properly
                dataState.teachers.length = 0;
                dataState.rooms.length = 0;
                dataState.subjects.length = 0;
                dataState.classes.length = 0;
                dataState.presets.length = 0;
                dataState.subjectColors = {};

                // Assign new data
                if (profileData.dataState.teachers) dataState.teachers.push(...profileData.dataState.teachers);
                if (profileData.dataState.rooms) dataState.rooms.push(...profileData.dataState.rooms);
                if (profileData.dataState.subjects) dataState.subjects.push(...profileData.dataState.subjects);
                if (profileData.dataState.classes) dataState.classes.push(...profileData.dataState.classes);
                if (profileData.dataState.presets) dataState.presets.push(...profileData.dataState.presets);
                if (profileData.dataState.subjectColors) Object.assign(dataState.subjectColors, profileData.dataState.subjectColors);

                console.log('Data state loaded:', dataState);
            }

            // Update current week keys
            currentPlanWeek = state.currentPlanWeek || getCurrentWeekKey();
            currentHeatmapWeek = state.currentHeatmapWeek || getCurrentWeekKey();
            overviewWeekKey = state.overviewWeekKey || getCurrentWeekKey();

            console.log('Current week keys updated:', {
                currentPlanWeek,
                currentHeatmapWeek,
                overviewWeekKey
            });

            // Force save to global localStorage for compatibility
            if (profileData.state) {
                localStorage.setItem(LS_PLAN, JSON.stringify(state));
            }
            if (profileData.weekPlans) {
                localStorage.setItem('weekPlans', JSON.stringify(Object.fromEntries(weekPlans)));
            }
        }

        // Close profile switch when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.profile-switch-container')) {
                const dropdown = byId('profileSwitchDropdown');
                const switchEl = document.querySelector('.profile-switch');
                if (dropdown && switchEl) {
                    dropdown.classList.remove('open');
                    switchEl.classList.remove('open');
                }
            }
        });

        // Auto-save profile data when changes are made
        function autoSaveProfileData() {
            if (currentTimetableProfile && currentTimetableProfile !== 'default') {
                saveCurrentProfileData();
            }
        }

        // Override the original save functions to also save profile data
        const originalSavePlan = savePlan;
        savePlan = function () {
            originalSavePlan();
            autoSaveProfileData();
        };

        const originalSaveWeekPlans = saveWeekPlans;
        saveWeekPlans = function () {
            originalSaveWeekPlans();
            autoSaveProfileData();
        };

        // Debug function to check profile data
        function debugProfileData() {
            console.log('=== PROFILE DEBUG ===');
            console.log('Current Profile:', currentTimetableProfile);
            console.log('Available Profiles:', Object.keys(timetableProfiles));
            console.log('Profile Details:', timetableProfiles);

            Object.keys(timetableProfiles).forEach(profileId => {
                const profileData = JSON.parse(localStorage.getItem(`timetableProfile_${profileId}`) || '{}');
                console.log(`Profile ${profileId}:`, {
                    name: timetableProfiles[profileId].name,
                    lessons: profileData.state?.lessons?.length || 0,
                    weekPlans: Object.keys(profileData.weekPlans || {}).length
                });
            });

            console.log('Current Global State:', {
                lessons: state.lessons?.length || 0,
                weekPlans: weekPlans.size
            });
            console.log('=== END DEBUG ===');
        }

        // Function to fix profile issues - can be called from console
        function fixProfileIssues() {
            console.log('=== FIXING PROFILE ISSUES ===');

            // Check if default profile exists
            if (!timetableProfiles['default']) {
                console.log('Default profile missing, creating...');
                resetDefaultProfile();
                return;
            }

            // Check if current profile exists
            if (!timetableProfiles[currentTimetableProfile]) {
                console.log('Current profile missing, switching to default...');
                currentTimetableProfile = 'default';
                localStorage.setItem('currentTimetableProfile', 'default');
                updateProfileSwitchDisplay();
                loadProfileSwitchList();
                return;
            }

            // Refresh displays
            updateProfileSwitchDisplay();
            loadProfileSwitchList();
            refreshAllDisplays();

            console.log('Profile issues fixed!');
        }

        // Make debug and fix functions globally available
        window.debugProfileData = debugProfileData;
        window.fixProfileIssues = fixProfileIssues;

        /* ===== Profile Functions ===== */
        function loadProfileData() {
            // Load profile data from localStorage
            const profileData = JSON.parse(localStorage.getItem('userProfile') || '{}');

            // Populate form fields
            const nameInput = byId('profileName');
            const emailInput = byId('profileEmail');
            const schoolInput = byId('profileSchool');
            const gradeInput = byId('profileGrade');
            const themeInput = byId('profileTheme');
            const notificationsInput = byId('profileNotifications');
            const autoSaveInput = byId('profileAutoSave');

            if (nameInput) nameInput.value = profileData.name || '';
            if (emailInput) emailInput.value = profileData.email || '';
            if (schoolInput) schoolInput.value = profileData.school || '';
            if (gradeInput) gradeInput.value = profileData.grade || '';
            if (themeInput) themeInput.value = profileData.theme || 'light';
            if (notificationsInput) notificationsInput.checked = profileData.notifications !== false;
            if (autoSaveInput) autoSaveInput.checked = profileData.autoSave !== false;
        }

        function saveProfile() {
            // Collect form data
            const profileData = {
                name: byId('profileName')?.value || '',
                email: byId('profileEmail')?.value || '',
                school: byId('profileSchool')?.value || '',
                grade: byId('profileGrade')?.value || '',
                theme: byId('profileTheme')?.value || 'light',
                notifications: byId('profileNotifications')?.checked !== false,
                autoSave: byId('profileAutoSave')?.checked !== false,
                lastUpdated: new Date().toISOString()
            };

            // Save to localStorage
            localStorage.setItem('userProfile', JSON.stringify(profileData));

            // Show success feedback
            const saveBtn = byId('saveProfile');
            if (saveBtn) {
                const originalText = saveBtn.textContent;
                saveBtn.textContent = 'Saved!';
                saveBtn.classList.add('success');
                setTimeout(() => {
                    saveBtn.textContent = originalText;
                    saveBtn.classList.remove('success');
                }, 2000);
            }

            console.log('Profile saved:', profileData);
        }

        function resetProfile() {
            // Clear all form fields
            byId('profileName').value = '';
            byId('profileEmail').value = '';
            byId('profileSchool').value = '';
            byId('profileGrade').value = '';
            byId('profileTheme').value = 'light';
            byId('profileNotifications').checked = true;
            byId('profileAutoSave').checked = true;

            // Clear localStorage
            localStorage.removeItem('userProfile');

            console.log('Profile reset');
        }

        function renderProfileStats() {
            // Calculate statistics from all week plans
            let totalLessons = 0;
            let totalHours = 0;
            let activeDays = new Set();

            // Iterate through all week plans
            for (const [weekKey, plan] of weekPlans.entries()) {
                if (plan.lessons) {
                    totalLessons += plan.lessons.length;

                    // Calculate total hours
                    plan.lessons.forEach(lesson => {
                        const lessonHours = (lesson.span * plan.periodMinutes) / 60;
                        totalHours += lessonHours;

                        // Track active days
                        if (lesson.day >= 0 && lesson.day < plan.days.length) {
                            activeDays.add(lesson.day);
                        }
                    });
                }
            }

            // Update display
            const totalLessonsEl = byId('profileTotalLessons');
            const totalHoursEl = byId('profileTotalHours');
            const activeDaysEl = byId('profileActiveDays');

            if (totalLessonsEl) totalLessonsEl.textContent = totalLessons;
            if (totalHoursEl) totalHoursEl.textContent = Math.round(totalHours);
            if (activeDaysEl) activeDaysEl.textContent = activeDays.size;
        }

        /* ===== Ultimate Profile Functions ===== */
        function editAvatar() {
            // Simple avatar edit - could be expanded to upload images
            const avatar = document.querySelector('.profile-avatar-large .avatar-placeholder');
            if (avatar) {
                avatar.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    avatar.style.transform = 'scale(1)';
                }, 200);
            }
            console.log('Avatar edit clicked - feature can be expanded');
        }

        function quickAddLesson() {
            // Navigate to plan and open lesson creation
            byId('navPlan')?.click();
            setTimeout(() => {
                // Find first empty cell and click it
                const firstAddBtn = document.querySelector('.cell .add:not([hidden])');
                if (firstAddBtn) {
                    firstAddBtn.click();
                }
            }, 100);
        }

        function quickExport() {
            // Quick export functionality
            exportData();
        }

        function quickSettings() {
            // Expand settings section in profile
            toggleProfileSection('settings');
        }

        function refreshInsights() {
            // Refresh smart insights
            generateSmartInsights();
        }

        function toggleStatsView() {
            // Toggle between different stats views
            const statsGrid = document.querySelector('.stats-grid');
            if (statsGrid) {
                statsGrid.style.gridTemplateColumns = statsGrid.style.gridTemplateColumns === 'repeat(4, 1fr)'
                    ? 'repeat(2, 1fr)'
                    : 'repeat(4, 1fr)';
            }
        }

        function generateSmartInsights() {
            const insightsList = byId('insightsList');
            if (!insightsList) return;

            const insights = [];
            const currentPlan = weekPlans.get(currentPlanWeek);

            // Generate insights based on current data
            if (!currentPlan || !currentPlan.lessons || currentPlan.lessons.length === 0) {
                insights.push({
                    icon: 'lock',
                    title: 'Welcome to stunova!',
                    description: 'Start by adding your first lesson to see personalized insights.',
                    type: 'welcome'
                });
            } else {
                // Analyze lesson distribution
                const lessonCount = currentPlan.lessons.length;
                const totalHours = currentPlan.lessons.reduce((sum, lesson) => sum + (lesson.span * currentPlan.periodMinutes), 0) / 60;

                if (lessonCount < 5) {
                    insights.push({
                        icon: 'plus',
                        title: 'Add More Lessons',
                        description: `You have ${lessonCount} lessons. Consider adding more to optimize your schedule.`,
                        type: 'suggestion'
                    });
                }

                if (totalHours > 40) {
                    insights.push({
                        icon: 'alert-triangle',
                        title: 'Heavy Schedule',
                        description: `You have ${Math.round(totalHours)} hours this week. Make sure to take breaks!`,
                        type: 'warning'
                    });
                }

                // Check for gaps
                const dayCounts = [0, 0, 0, 0, 0, 0, 0];
                currentPlan.lessons.forEach(lesson => {
                    if (lesson.day >= 0 && lesson.day < 7) {
                        dayCounts[lesson.day]++;
                    }
                });

                const emptyDays = dayCounts.filter(count => count === 0).length;
                if (emptyDays > 2) {
                    insights.push({
                        icon: 'calendar',
                        title: 'Free Days Available',
                        description: `You have ${emptyDays} days without lessons. Great for rest or additional activities!`,
                        type: 'info'
                    });
                }
            }

            // Render insights
            insightsList.innerHTML = insights.map(insight => `
                <div class="insight-item" data-type="${insight.type}">
                    <div class="insight-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            ${getInsightIcon(insight.icon)}
                        </svg>
                    </div>
                    <div class="insight-content">
                        <div class="insight-title">${insight.title}</div>
                        <div class="insight-description">${insight.description}</div>
                    </div>
                </div>
            `).join('');
        }

        function getInsightIcon(iconType) {
            const icons = {
                'lock': '<path d="M9 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2h-4"></path><rect x="9" y="7" width="6" height="4" rx="1"></rect>',
                'plus': '<line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>',
                'alert-triangle': '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>',
                'calendar': '<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>'
            };
            return icons[iconType] || icons['lock'];
        }

        function updateTodayOverview() {
            const today = new Date();
            const dayOfWeek = (today.getDay() + 6) % 7; // Convert to Monday=0 format
            const currentPlan = weekPlans.get(currentPlanWeek);

            // Update today's date
            const todayDateEl = byId('todayDate');
            if (todayDateEl) {
                todayDateEl.textContent = today.toLocaleDateString();
            }

            // Calculate today's lessons
            let todayLessons = 0;
            let nextLessonTime = '--:--';
            let todayProgress = 0;

            if (currentPlan && currentPlan.lessons) {
                const todayLessonsList = currentPlan.lessons.filter(lesson => lesson.day === dayOfWeek);
                todayLessons = todayLessonsList.length;

                // Find next lesson
                const now = new Date();
                const currentTime = now.getHours() * 60 + now.getMinutes();

                for (const lesson of todayLessonsList) {
                    const lessonStart = (lesson.startIndex * (currentPlan.periodMinutes + currentPlan.breakMinutes));
                    const lessonStartTime = currentPlan.dayStart.h * 60 + currentPlan.dayStart.m + lessonStart;

                    if (lessonStartTime > currentTime) {
                        const hours = Math.floor(lessonStartTime / 60);
                        const minutes = lessonStartTime % 60;
                        nextLessonTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                        break;
                    }
                }

                // Calculate progress (simplified)
                if (todayLessons > 0) {
                    const completedLessons = todayLessonsList.filter(lesson => {
                        const lessonEnd = (lesson.startIndex * (currentPlan.periodMinutes + currentPlan.breakMinutes)) + (lesson.span * currentPlan.periodMinutes);
                        const lessonEndTime = currentPlan.dayStart.h * 60 + currentPlan.dayStart.m + lessonEnd;
                        return currentTime > lessonEndTime;
                    }).length;
                    todayProgress = Math.round((completedLessons / todayLessons) * 100);
                }
            }

            // Update display
            const todayLessonsEl = byId('todayLessons');
            const nextLessonTimeEl = byId('nextLessonTime');
            const todayProgressEl = byId('todayProgress');

            if (todayLessonsEl) todayLessonsEl.textContent = todayLessons;
            if (nextLessonTimeEl) nextLessonTimeEl.textContent = nextLessonTime;
            if (todayProgressEl) todayProgressEl.textContent = `${todayProgress}%`;
        }

        function updateProfileDisplay() {
            const profileData = JSON.parse(localStorage.getItem('userProfile') || '{}');

            // Update display name
            const displayNameEl = byId('profileDisplayName');
            if (displayNameEl && profileData.name) {
                displayNameEl.textContent = `Welcome back, ${profileData.name}!`;
            }

            // Update role based on grade
            const displayRoleEl = byId('profileDisplayRole');
            if (displayRoleEl) {
                if (profileData.grade === 'university') {
                    displayRoleEl.textContent = 'University Student • Timetable Manager';
                } else if (profileData.grade && profileData.grade !== 'other') {
                    displayRoleEl.textContent = `Grade ${profileData.grade} Student • Timetable Manager`;
                } else {
                    displayRoleEl.textContent = 'Student • Timetable Manager';
                }
            }
        }

        function toggleProfileSection(section) {
            const header = document.querySelector(`[onclick="toggleProfileSection('${section}')"]`);
            const content = byId(`profile${section.charAt(0).toUpperCase() + section.slice(1)}Content`);

            if (header && content) {
                if (content.classList.contains('expanded')) {
                    content.classList.remove('expanded');
                    header.classList.remove('expanded');
                    header.classList.add('collapsed');
                } else {
                    content.classList.add('expanded');
                    header.classList.add('expanded');
                    header.classList.remove('collapsed');

                    // Initialize settings if it's the settings section
                    if (section === 'settings') {
                        setTimeout(() => {
                            populateSettingsInputs();
                            initializeSettingsControls();
                            renderSettingsStats();
                            initializeSettingsToggles();
                            initializeSettingsActions();
                        }, 100);
                    }

                    // Initialize analysis if it's the analysis section
                    if (section === 'analysis') {
                        setTimeout(() => {
                            renderAnalysis();
                        }, 100);
                    }
                }
            }
        }

        function renderPresetManager() {
            const host = byId('presetManager');
            if (!host) return;
            const subjColors = dataState.subjectColors || {};
            const presets = dataState.presets || [];

            // subjects + colors editor
            const subjects = [...new Set([...(dataState.subjects || []), ...Object.keys(subjColors)])].sort((a, b) => a.localeCompare(b));
            let html = `
                            <h4 style="margin:8px 0 6px">Fachfarben</h4>
                            <table class="preset-table">
                            <thead><tr><th>Fach</th><th>Farbe</th><th style="width:1%"></th></tr></thead>
                            <tbody>
                                ${subjects.map(s => `
                                <tr data-subj="${s}">
                                    <td>${s}</td>
                                    <td><input class="inline-color" type="color" value="${subjColors[s] || '#60a5fa'}" data-role="subj-color"></td>
                                    <td><button class="btn mini danger" data-role="remove-subj">Entfernen</button></td>
                                </tr>
                                `).join('')}
                                <tr>
                                <td><input class="inline-input" placeholder="Neues Fach"></td>
                                <td><input class="inline-color" type="color" value="#60a5fa"></td>
                                <td><button class="btn mini primary" data-role="add-subj">Hinzufügen</button></td>
                                </tr>
                            </tbody>
                            </table>
                        `;

            // presets editor
            html += `
                            <h4 style="margin:16px 0 6px">Presets (Fach → Vorgaben)</h4>
                            <table class="preset-table">
                            <thead><tr><th>Fach</th><th>Lehrer:in</th><th>Raum</th><th>Farbe</th><th style="width:1%"></th></tr></thead>
                            <tbody>
                                ${presets.map((p, i) => `
                                <tr data-idx="${i}">
                                    <td><input class="inline-input" value="${p.subject || ''}" placeholder="Fach"></td>
                                    <td><input class="inline-input" value="${p.teacher || ''}" list="teacherList" placeholder="Lehrer:in"></td>
                                    <td><input class="inline-input" value="${p.room || ''}" list="roomList" placeholder="Raum"></td>
                                    <td><input class="inline-color" type="color" value="${p.color || dataState.subjectColors[p.subject] || '#60a5fa'}"></td>
                                    <td class="preset-row-actions"><button class="btn mini danger" data-role="remove-preset">×</button></td>
                                </tr>
                                `).join('')}
                                <tr data-idx="new">
                                <td><input class="inline-input" placeholder="Fach"></td>
                                <td><input class="inline-input" list="teacherList" placeholder="Lehrer:in"></td>
                                <td><input class="inline-input" list="roomList" placeholder="Raum"></td>
                                <td><input class="inline-color" type="color" value="#60a5fa"></td>
                                <td><button class="btn mini primary" data-role="add-preset">Hinzufügen</button></td>
                                </tr>
                            </tbody>
                            </table>
                        `;

            host.innerHTML = html;

            // Wire subject color table
            host.querySelectorAll('[data-role="subj-color"]').forEach(inp => {
                inp.addEventListener('input', (e) => {
                    const row = e.target.closest('tr');
                    const subj = row.dataset.subj;
                    dataState.subjectColors[subj] = e.target.value;
                    saveData();
                });
            });
            host.querySelectorAll('[data-role="remove-subj"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const row = btn.closest('tr'); const subj = row.dataset.subj;
                    delete dataState.subjectColors[subj];
                    // do not remove from subjects[] list here; color removal only
                    saveData(); renderPresetManager();
                });
            });
            host.querySelector('[data-role="add-subj"]')?.addEventListener('click', () => {
                const row = host.querySelector('table tbody tr:last-child');
                const subj = row.querySelector('input.inline-input').value.trim();
                const col = row.querySelector('input.inline-color').value;
                if (!subj) return;
                if (!dataState.subjects.includes(subj)) dataState.subjects.push(subj);
                dataState.subjectColors[subj] = col;
                saveData(); renderPresetManager();
            });

            // Wire presets table
            host.querySelectorAll('[data-role="remove-preset"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const i = Number(btn.closest('tr').dataset.idx);
                    dataState.presets.splice(i, 1);
                    saveData(); renderPresetManager();
                });
            });
            host.querySelector('[data-role="add-preset"]')?.addEventListener('click', () => {
                const row = host.querySelector('tr[data-idx="new"]');
                const [s, t, r] = row.querySelectorAll('input.inline-input');
                const col = row.querySelector('input.inline-color').value;
                const subject = (s.value || '').trim();
                if (!subject) return;
                dataState.presets.push({ subject, teacher: t.value.trim(), room: r.value.trim(), color: col });
                if (!dataState.subjects.includes(subject)) dataState.subjects.push(subject);
                if (!dataState.subjectColors[subject]) dataState.subjectColors[subject] = col;
                saveData(); renderPresetManager();
            });
        }

        /* =================== FOLDERS (wie gehabt) =================== */
        // Modern folder section event listeners
        const foldersSearchBtn = byId('foldersSearchBtn');
        const foldersSearch = byId('foldersSearch');
        const foldersSearchInput = byId('foldersSearchInput');
        const foldersSearchClose = byId('foldersSearchClose');
        const foldersSortBtn = byId('foldersSortBtn');
        const foldersSort = byId('foldersSort');
        const foldersViewBtn = byId('foldersViewBtn');
        const fileInputBtn = byId('fileInputBtn');

        // Search functionality
        if (foldersSearchBtn) {
            foldersSearchBtn.addEventListener('click', () => {
                foldersSearch.hidden = !foldersSearch.hidden;
                if (!foldersSearch.hidden) {
                    foldersSearchInput.focus();
                } else {
                    window.foldersSearchQuery = '';
                    foldersSearchInput.value = '';
                    renderFolders();
                }
            });
        }

        if (foldersSearchInput) {
            foldersSearchInput.addEventListener('input', (e) => {
                window.foldersSearchQuery = e.target.value;
                renderFolders();
            });
        }

        if (foldersSearchClose) {
            foldersSearchClose.addEventListener('click', () => {
                foldersSearch.hidden = true;
                window.foldersSearchQuery = '';
                foldersSearchInput.value = '';
                renderFolders();
            });
        }

        // Sort functionality
        if (foldersSortBtn) {
            foldersSortBtn.addEventListener('click', () => {
                foldersSort.hidden = !foldersSort.hidden;
            });
        }

        // Sort options
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('sort-option')) {
                // Remove active class from all sort options
                document.querySelectorAll('.sort-option').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to clicked option
                e.target.classList.add('active');
                
                // Set sort by
                window.foldersSortBy = e.target.dataset.sort;
                renderFolders();
            }
        });

        // View toggle (placeholder for future grid/list view)
        if (foldersViewBtn) {
            foldersViewBtn.addEventListener('click', () => {
                // Toggle between grid and list view (future feature)
                console.log('View toggle clicked');
            });
        }

        // File input button
        if (fileInputBtn) {
            fileInputBtn.addEventListener('click', () => {
                fileInput.click();
            });
        }

        const foldersGrid = byId('foldersGrid'); 
        const foldersEmpty = byId('foldersEmpty'); 
        const dropzone = byId('foldersUpload'); 
        const fileInput = byId('fileInput'); 
        const newFolderBtn = byId('newFolderBtn'); 
        const manageFoldersBtn = byId('manageFoldersBtn');
        const folderEditModal = byId('folderEditModal'); 
        const folderNameInput = byId('folderNameInput'); 
        const folderColorInput = byId('folderColorInput'); 
        const folderSaveBtn = byId('folderSaveBtn'); 
        const folderDeleteBtn = byId('folderDeleteBtn');
        const folderIconPreview = byId('folderIconPreview'); 
        const folderIconSelection = byId('folderIconSelection');
        const foldersManageModal = byId('foldersManageModal'); 
        const manageList = byId('manageList');
        const folderDetailModal = byId('folderDetailModal'); 
        const folderDetailTitle = byId('folderDetailTitle'); 
        const folderDetailGrid = byId('folderDetailGrid');
        // Initialize folder state
        window.foldersSearchQuery = '';
        window.foldersSortBy = 'name';

        // Update seedFolders to include createdAt timestamp
        function seedFolders() {
            const now = Date.now();
            return [
                { id: uid(), name: "Mathe", color: "#60a5fa", icon: "math", items: [], createdAt: now },
                { id: uid(), name: "Deutsch", color: "#f472b6", icon: "language", items: [], createdAt: now },
                { id: uid(), name: "Informatik", color: "#34d399", icon: "work", items: [], createdAt: now },
                { id: uid(), name: "Allgemein", color: "#a78bfa", icon: "folder", items: [], createdAt: now }
            ];
        }

        function renderFolders() {
            try {
                if (!foldersGrid) {
                    console.error('foldersGrid not found');
                    return;
                }

                foldersGrid.innerHTML = '';

                // Update folder count
                const foldersCount = byId('foldersCount');
                if (foldersCount) {
                    const count = folderState.folders ? folderState.folders.length : 0;
                    foldersCount.textContent = `${count} Ordner${count !== 1 ? '' : ''}`;
                }

                if (!folderState.folders || !folderState.folders.length) {
                    if (foldersEmpty) foldersEmpty.hidden = false;
                    console.log('No folders to render');
                    return;
                }

                if (foldersEmpty) foldersEmpty.hidden = true;

                // Apply search filter if active
                let filteredFolders = folderState.folders;
                if (window.foldersSearchQuery) {
                    const query = window.foldersSearchQuery.toLowerCase();
                    filteredFolders = folderState.folders.filter(f => 
                        f.name.toLowerCase().includes(query)
                    );
                }

                // Apply sorting
                if (window.foldersSortBy) {
                    filteredFolders = [...filteredFolders].sort((a, b) => {
                        switch (window.foldersSortBy) {
                            case 'name':
                                return a.name.localeCompare(b.name);
                            case 'date':
                                return (b.createdAt || 0) - (a.createdAt || 0);
                            case 'items':
                                return b.items.length - a.items.length;
                            case 'color':
                                return (a.color || '').localeCompare(b.color || '');
                            default:
                                return 0;
                        }
                    });
                }

                filteredFolders.forEach(f => {
                    const folderCard = div('folder-card');
                    folderCard.setAttribute('data-folder-id', f.id);
                    folderCard.style.setProperty('--folder-color', f.color || '#6366f1');

                    // Folder header with icon and actions
                    const folderHeader = div('folder-header');
                    
                    const folderIcon = div('folder-icon');
                    folderIcon.innerHTML = getFolderIcon(f.icon || 'folder');
                    
                    const folderActions = div('folder-actions');
                    const editBtn = div('folder-action');
                    editBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>';
                    editBtn.title = 'Bearbeiten';
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openFolderEdit(f.id);
                    });
                    
                    const deleteBtn = div('folder-action');
                    deleteBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3,6 5,6 21,6"></polyline><path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path></svg>';
                    deleteBtn.title = 'Löschen';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (confirm(`Ordner "${f.name}" wirklich löschen?`)) {
                            deleteFolder(f.id);
                        }
                    });
                    
                    folderActions.append(editBtn, deleteBtn);
                    folderHeader.append(folderIcon, folderActions);

                    // Folder info
                    const folderInfo = div('folder-info');
                    const folderName = div('folder-name', f.name);
                    const folderMeta = div('folder-meta', `Erstellt ${formatDate(f.createdAt)}`);
                    folderInfo.append(folderName, folderMeta);

                    // Folder stats
                    const folderStats = div('folder-stats');
                    const fileCount = div('folder-stat');
                    fileCount.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline></svg>';
                    fileCount.innerHTML += ` ${f.items.length} Datei${f.items.length !== 1 ? 'en' : ''}`;
                    
                    const sizeStat = div('folder-stat');
                    const totalSize = f.items.reduce((sum, item) => sum + (item.size || 0), 0);
                    sizeStat.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7,10 12,15 17,10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>';
                    sizeStat.innerHTML += ` ${formatFileSize(totalSize)}`;
                    
                    folderStats.append(fileCount, sizeStat);

                    // Assemble card
                    folderCard.append(folderHeader, folderInfo, folderStats);

                    // Click to open folder
                    folderCard.addEventListener('click', () => openFolderDetail(f.id));

                    // Context menu
                    folderCard.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showFolderContextMenu(e.clientX, e.clientY, f.id);
                    });

                    foldersGrid.appendChild(folderCard);
                });

                console.log(`Successfully rendered ${filteredFolders.length} folders`);

            } catch (error) {
                console.error('Error in renderFolders:', error);
                if (foldersGrid) {
                    foldersGrid.innerHTML = '<div style="text-align: center; padding: 40px; color: #ef4444;">Fehler beim Laden der Ordner</div>';
                }
            }
        }

        // Helper functions for modern folder section
        function formatDate(timestamp) {
            if (!timestamp) return 'Unbekannt';
            const date = new Date(timestamp);
            return date.toLocaleDateString('de-DE', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        function deleteFolder(folderId) {
            folderState.folders = folderState.folders.filter(f => f.id !== folderId);
            saveFolders();
            renderFolders();
        }

        function createFileItem(item, folderId) {
            const fileItem = div('file-item');

            // File icon based on extension
            const fileIcon = div('file-icon');
            const iconClass = getFileIconClass(item.ext);
            fileIcon.className = `file-icon ${iconClass}`;
            fileIcon.innerHTML = getFileIcon(item.ext);

            // File info
            const fileInfo = div('file-info');
            const fileName = div('file-name', item.name);
            const fileMeta = div('file-meta', `${item.ext.toUpperCase()} • ${new Date(item.added).toLocaleDateString()}`);
            fileInfo.append(fileName, fileMeta);

            // File actions
            const fileActions = div('file-actions');
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'btn mini ghost';
            downloadBtn.textContent = 'Download';
            downloadBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                downloadFile(item);
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn mini danger';
            deleteBtn.textContent = 'Löschen';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteFile(item.id, folderId);
            });

            fileActions.append(downloadBtn, deleteBtn);

            fileItem.append(fileIcon, fileInfo, fileActions);
            return fileItem;
        }

        function getFileIconClass(ext) {
            const iconMap = {
                'pdf': 'pdf',
                'docx': 'docx',
                'pptx': 'pptx',
                'xlsx': 'xlsx',
                'txt': 'txt',
                'md': 'md',
                'json': 'json',
                'js': 'code',
                'ts': 'code',
                'html': 'code',
                'css': 'code',
                'jpg': 'image',
                'jpeg': 'image',
                'png': 'image',
                'gif': 'image',
                'mp4': 'video',
                'avi': 'video',
                'mp3': 'audio',
                'wav': 'audio',
                'zip': 'archive',
                'rar': 'archive'
            };
            return iconMap[ext.toLowerCase()] || 'default';
        }

        function getFileIcon(ext) {
            const iconMap = {
                'pdf': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10,9 9,9 8,9"></polyline></svg>',
                'docx': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10,9 9,9 8,9"></polyline></svg>',
                'pptx': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="15"></line><line x1="15" y1="9" x2="9" y2="15"></line></svg>',
                'xlsx': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10,9 9,9 8,9"></polyline></svg>',
                'txt': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10,9 9,9 8,9"></polyline></svg>',
                'md': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10,9 9,9 8,9"></polyline></svg>',
                'json': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10,9 9,9 8,9"></polyline></svg>',
                'js': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10,9 9,9 8,9"></polyline></svg>',
                'ts': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10,9 9,9 8,9"></polyline></svg>',
                'html': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10,9 9,9 8,9"></polyline></svg>',
                'css': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10,9 9,9 8,9"></polyline></svg>',
                'jpg': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21,15 16,10 5,21"></polyline></svg>',
                'jpeg': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21,15 16,10 5,21"></polyline></svg>',
                'png': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21,15 16,10 5,21"></polyline></svg>',
                'gif': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21,15 16,10 5,21"></polyline></svg>',
                'mp4': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>',
                'avi': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>',
                'mp3': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>',
                'wav': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>',
                'zip': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27,6.96 12,12.01 20.73,6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>',
                'rar': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27,6.96 12,12.01 20.73,6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>'
            };
            return iconMap[ext.toLowerCase()] || '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10,9 9,9 8,9"></polyline></svg>';
        }

        function getFolderIcon(iconName) {
            const iconMap = {
                'folder': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>',
                'math': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>',
                'science': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11H1l3-7 5 7z"></path><path d="M23 11H15l3-7 5 7z"></path><path d="M12 2v20"></path></svg>',
                'language': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>',
                'art': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>',
                'music': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>',
                'sports': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>',
                'games': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>',
                'books': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>',
                'work': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>',
                'default': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>'
            };
            return iconMap[iconName.toLowerCase()] || iconMap['default'];
        }

        function toggleFolder(folderId) {
            const folderItem = document.querySelector(`[data-folder-id="${folderId}"]`);
            if (folderItem) {
                folderItem.classList.toggle('expanded');
            }
        }

        function downloadFile(item) {
            // Create a blob with the file content
            const content = item.content || `Content of ${item.name}`;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);

            // Create download link
            const a = document.createElement('a');
            a.href = url;
            a.download = item.name;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function deleteFile(fileId, folderId) {
            if (!confirm('Diese Datei wirklich löschen?')) return;

            const folder = folderState.folders.find(f => f.id === folderId);
            if (folder) {
                folder.items = folder.items.filter(item => item.id !== fileId);
                saveFolders();
                renderFolders();
            }
        }
        // Simple folder functions
        function openFolderDetail(folderId) {
            const folder = folderState.folders.find(f => f.id === folderId);
            if (!folder) return;

            folderDetailTitle.textContent = folder.name;
            folderDetailGrid.innerHTML = '';

            if (folder.items.length === 0) {
                folderDetailGrid.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">Keine Dateien in diesem Ordner</div>';
            } else {
                folder.items.forEach(item => {
                    const fileItem = createSimpleFileItem(item, folderId);
                    folderDetailGrid.appendChild(fileItem);
                });
            }

            showModal(folderDetailModal);
        }

        function createSimpleFileItem(item, folderId) {
            const fileItem = div('file-item');
            fileItem.style.display = 'flex';
            fileItem.style.alignItems = 'center';
            fileItem.style.gap = '12px';
            fileItem.style.padding = '12px';
            fileItem.style.border = '1px solid #e5e7eb';
            fileItem.style.borderRadius = '8px';
            fileItem.style.marginBottom = '8px';

            // File icon
            const fileIcon = div('file-icon');
            fileIcon.innerHTML = getFileIcon(item.ext);
            fileIcon.style.fontSize = '16px';

            // File info
            const fileInfo = div('file-info');
            fileInfo.style.flex = '1';
            const fileName = div('file-name', item.name);
            fileName.style.fontWeight = '500';
            fileName.style.marginBottom = '4px';
            const fileMeta = div('file-meta', `${item.ext.toUpperCase()} • ${new Date(item.added).toLocaleDateString()}`);
            fileMeta.style.fontSize = '12px';
            fileMeta.style.color = '#6b7280';
            fileInfo.append(fileName, fileMeta);

            // File actions
            const fileActions = div('file-actions');
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'btn mini ghost';
            downloadBtn.textContent = 'Download';
            downloadBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                downloadFile(item);
            });

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn mini danger';
            deleteBtn.textContent = 'Löschen';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteFile(item.id, folderId);
            });

            fileActions.append(downloadBtn, deleteBtn);

            fileItem.append(fileIcon, fileInfo, fileActions);
            return fileItem;
        }
        function openFolderEdit(id = null) {
            editingFolderId = id;
            let name = '', color = colors[Math.floor(Math.random() * colors.length)], icon = 'folder';
            if (id) {
                const f = folderState.folders.find(x => x.id === id);
                if (!f) return;
                name = f.name;
                color = f.color || color;
                icon = f.icon || 'folder';
            }
            folderNameInput.value = name;
            folderColorInput.value = color;
            folderIconPreview.innerHTML = getFolderIcon(icon);
            folderDeleteBtn.style.display = id ? '' : 'none';

            // Populate icon selection
            populateIconSelection(icon);

            showModal(folderEditModal, '#folderNameInput');
        }

        function populateIconSelection(selectedIcon = 'folder') {
            if (!folderIconSelection) return;

            const icons = [
                'folder', 'math', 'science', 'language', 'art', 'music',
                'sports', 'games', 'books', 'work', 'default'
            ];

            folderIconSelection.innerHTML = '';

            icons.forEach(iconName => {
                const iconOption = div('icon-option');
                iconOption.innerHTML = getFolderIcon(iconName);
                iconOption.setAttribute('data-icon', iconName);

                if (iconName === selectedIcon) {
                    iconOption.classList.add('selected');
                }

                iconOption.addEventListener('click', () => {
                    // Remove previous selection
                    folderIconSelection.querySelectorAll('.icon-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });

                    // Add selection to clicked icon
                    iconOption.classList.add('selected');

                    // Update preview
                    folderIconPreview.innerHTML = getFolderIcon(iconName);
                });

                folderIconSelection.appendChild(iconOption);
            });
        }
        folderSaveBtn.addEventListener('click', () => {
            const name = (folderNameInput.value || '').trim() || 'Neuer Ordner';
            const color = folderColorInput.value || '#e2e8f0';
            const selectedIconOption = folderIconSelection.querySelector('.icon-option.selected');
            const icon = selectedIconOption ? selectedIconOption.getAttribute('data-icon') : 'folder';

            if (editingFolderId) {
                const idx = folderState.folders.findIndex(f => f.id === editingFolderId);
                if (idx >= 0) folderState.folders[idx] = { ...folderState.folders[idx], name, color, icon };
            }
            else {
                folderState.folders.push({ 
                    id: uid(), 
                    name, 
                    color, 
                    icon, 
                    items: [], 
                    createdAt: Date.now() 
                });
            }
            saveFolders(); 
            hideModal(folderEditModal); 
            renderFolders();
        });
        folderDeleteBtn.addEventListener('click', () => { if (!editingFolderId) return; if (!confirm('Diesen Ordner wirklich löschen? Dateien darin werden verworfen.')) return; folderState.folders = folderState.folders.filter(f => f.id !== editingFolderId); saveFolders(); hideModal(folderEditModal); renderFolders(); });
        newFolderBtn.addEventListener('click', () => openFolderEdit(null));
        manageFoldersBtn.addEventListener('click', () => openFoldersManage());

        function openFoldersManage() {
            manageList.innerHTML = ''; if (!folderState.folders.length) { manageList.innerHTML = '<div class="small" style="padding:8px">Keine Ordner vorhanden.</div>'; }
            else folderState.folders.forEach((f, idx) => {
                const row = div('file-tile'); row.setAttribute('draggable', 'true'); row.dataset.index = String(idx); row.style.borderStyle = 'solid';
                row.innerHTML = `<div><strong>⋮⋮ ${f.name}</strong></div><div class="small">${f.items.length} Elemente</div>`;
                row.addEventListener('dragstart', e => { row.classList.add('dragging'); e.dataTransfer.setData('text/plain', row.dataset.index); });
                row.addEventListener('dragend', () => row.classList.remove('dragging'));
                row.addEventListener('dragover', e => e.preventDefault());
                row.addEventListener('drop', e => { e.preventDefault(); const from = Number(e.dataTransfer.getData('text/plain')); const to = Number(row.dataset.index); if (Number.isNaN(from) || Number.isNaN(to) || from === to) return; const arr = [...folderState.folders]; const [moved] = arr.splice(from, 1); arr.splice(to, 0, moved); folderState.folders = arr; saveFolders(); openFoldersManage(); });
                row.addEventListener('click', () => { hideModal(foldersManageModal); openFolderEdit(f.id); });
                manageList.appendChild(row);
            });
            showModal(foldersManageModal, '.file-tile');
        }
        function openFolderDetail(id) {
            const f = folderState.folders.find(x => x.id === id); if (!f) return; folderDetailTitle.textContent = `Ordner: ${f.name}`;
            folderDetailGrid.innerHTML = ''; if (!f.items.length) { folderDetailGrid.innerHTML = '<div class="small">Keine Dateien in diesem Ordner.</div>'; }
            else f.items.forEach(it => folderDetailGrid.appendChild(fileTile(it, () => { f.items = f.items.filter(x => x.id !== it.id); saveFolders(); openFolderDetail(id); renderFolders(); })));
            showModal(folderDetailModal, '.btn.ghost');
        }

        /* Upload & analysis */
        // Modern upload area
        dropzone?.addEventListener('click', () => fileInput.click());
        dropzone?.addEventListener('dragover', e => {
            e.preventDefault();
            dropzone.classList.add('over');
        });
        dropzone?.addEventListener('dragleave', () => dropzone.classList.remove('over'));
        dropzone?.addEventListener('drop', e => {
            e.preventDefault();
            dropzone.classList.remove('over');
            const files = [...(e.dataTransfer?.files || [])];
            if (files.length) handleFiles(files);
        });
        fileInput?.addEventListener('change', () => {
            const files = [...(fileInput.files || [])];
            if (files.length) handleFiles(files);
            fileInput.value = '';
        });

        // Simple drag & drop
        function setupFolderDragDrop() {
            document.addEventListener('dragover', e => e.preventDefault());
            document.addEventListener('drop', e => {
                e.preventDefault();
                const folderItem = e.target.closest('.folder-item');
                if (folderItem && e.dataTransfer.files.length > 0) {
                    const folderId = folderItem.getAttribute('data-folder-id');
                    const files = [...e.dataTransfer.files];
                    addFilesToFolder(files, folderId);
                }
            });
        }

        function addFilesToFolder(files, folderId) {
            console.log('addFilesToFolder called with:', { files: files.length, folderId });

            const folder = folderState.folders.find(f => f.id === folderId);
            if (!folder) {
                console.error('Folder not found:', folderId);
                console.log('Available folders:', folderState.folders.map(f => ({ id: f.id, name: f.name })));
                return;
            }

            console.log('Found folder:', folder.name, 'ID:', folder.id);

            // Process files sequentially to avoid race conditions
            const processFiles = async () => {
                for (const file of files) {
                    const name = file.name;
                    const ext = extFromName(name);
                    let content = '';

                    console.log('Processing file:', name);

                    try {
                        if (file.type?.startsWith('text/') || /\.(md|json|js|ts|html|css|txt)$/i.test(name)) {
                            content = await file.text();
                        } else if (file.type?.startsWith('image/')) {
                            // Convert image to base64 data URL
                            const arrayBuffer = await file.arrayBuffer();
                            const base64 = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
                            content = `data:${file.type};base64,${base64}`;
                            console.log('Image converted to base64, size:', base64.length);
                        } else {
                            content = '[Datei-Inhalt]';
                        }
                    } catch (error) {
                        console.error('Error reading file:', name, error);
                        content = '[Fehler beim Lesen]';
                    }

                    const newFile = {
                        id: uid(),
                        name: name,
                        ext: ext,
                        content: content,
                        added: new Date().toISOString(),
                        topic: 'Allgemein',
                        grade: 0,
                        notes: ''
                    };

                    folder.items.push(newFile);
                    console.log('Added file to folder:', name);
                }

                saveFolders();
                renderFolders();
                console.log('Files added successfully to folder:', folder.name);

                // Force refresh folder detail if open
                if (folderDetailModal && !folderDetailModal.hidden) {
                    const currentFolderId = folderDetailModal.getAttribute('data-folder-id');
                    if (currentFolderId === folderId) {
                        console.log('Refreshing folder detail view');
                        openFolderDetail(folderId);
                    }
                }
            };

            processFiles().catch(error => {
                console.error('Error processing files:', error);
            });
        }

        // Initialize drag & drop
        document.addEventListener('DOMContentLoaded', () => {
            setupFolderDragDrop();
            setupProfileFormEvents();
            // Ensure structure panel listeners are initialized
            initializeStructurePanelListeners();
        });

        /* ---------- Folder context menu logic ---------- */
        const folderContextMenu = byId('folderContextMenu');
        let contextFolderId = null;

        function showFolderContextMenu(x, y, folderId) {
            console.log('showFolderContextMenu called with:', { x, y, folderId });
            contextFolderId = folderId;
            if (!folderContextMenu) {
                console.error('folderContextMenu element not found');
                return;
            }

            // Hide any existing context menu first
            hideFolderContextMenu();

            folderContextMenu.innerHTML = '';

            const open = div('cm-item');
            open.textContent = 'Öffnen';
            open.addEventListener('click', (e) => {
                e.stopPropagation();
                hideFolderContextMenu();
                openFolderDetail(contextFolderId);
            });

            const upload = div('cm-item');
            upload.textContent = 'Dateien hochladen…';
            upload.addEventListener('click', (e) => {
                e.stopPropagation();

                // Save folder ID before hiding menu
                const targetFolderId = contextFolderId;
                console.log('Upload clicked for folder:', targetFolderId);

                hideFolderContextMenu();

                const input = document.createElement('input');
                input.type = 'file';
                input.multiple = true;
                input.style.display = 'none';

                input.addEventListener('change', (event) => {
                    const files = [...(event.target.files || [])];
                    console.log('Files selected:', files.length, 'for folder:', targetFolderId);
                    console.log('File names:', files.map(f => f.name));

                    if (files.length > 0 && targetFolderId) {
                        console.log('Calling addFilesToFolder with:', { files: files.length, folderId: targetFolderId });
                        addFilesToFolder(files, targetFolderId);
                    } else {
                        console.error('No files selected or folder ID missing:', { files: files.length, targetFolderId });
                    }

                    // Reset input
                    event.target.value = '';
                });

                // Add to DOM temporarily
                document.body.appendChild(input);
                input.click();

                // Clean up after a delay
                setTimeout(() => {
                    if (input.parentNode) {
                        input.parentNode.removeChild(input);
                    }
                }, 1000);
            });

            const edit = div('cm-item');
            edit.textContent = 'Bearbeiten';
            edit.addEventListener('click', (e) => {
                e.stopPropagation();
                hideFolderContextMenu();
                openFolderEdit(contextFolderId);
            });

            const del = div('cm-item');
            del.textContent = 'Löschen';
            del.addEventListener('click', (e) => {
                e.stopPropagation();
                hideFolderContextMenu();
                if (confirm('Diesen Ordner wirklich löschen?')) {
                    folderState.folders = folderState.folders.filter(f => f.id !== contextFolderId);
                    saveFolders();
                    renderFolders();
                }
            });

            folderContextMenu.append(open, div('cm-sep'), upload, div('cm-sep'), edit, del);

            // Position with viewport bounds check
            const vw = window.innerWidth, vh = window.innerHeight;
            const rect = { w: 200, h: 180 };
            const left = Math.min(x, vw - rect.w - 8);
            const top = Math.min(y, vh - rect.h - 8);
            folderContextMenu.style.left = left + 'px';
            folderContextMenu.style.top = top + 'px';
            folderContextMenu.style.display = 'block';
            folderContextMenu.setAttribute('aria-hidden', 'false');

            console.log('Context menu positioned at:', { left, top });

            // Dismiss handlers
            setTimeout(() => {
                document.addEventListener('click', onDismissOnce, { once: true });
                document.addEventListener('contextmenu', onDismissOnce, { once: true });
                document.addEventListener('keydown', onEscDismiss, { once: true });
            }, 0);
        }

        function onDismissOnce() { hideFolderContextMenu(); }
        function onEscDismiss(e) { if (e.key === 'Escape') hideFolderContextMenu(); }
        function hideFolderContextMenu() {
            if (!folderContextMenu) return;
            folderContextMenu.style.display = 'none';
            folderContextMenu.setAttribute('aria-hidden', 'true');
            contextFolderId = null;
        }

        function extFromName(name) { const m = /\.([a-z0-9]+)$/i.exec(name); return m ? m[1].toLowerCase() : 'txt'; }
        function fileTile(item, onRemove) {
            const t = div('file-tile');
            const ico = div('file-ico');
            const ext = div('ext', item.ext.toUpperCase());
            const name = div('file-name', item.name);
            const meta = div('file-meta', `${item.topic} • Note: ${item.grade}/100 • ${new Date(item.added).toLocaleString()}`);

            // Check if it's an image
            if (item.content && item.content.startsWith('data:image/')) {
                // Display actual image
                ico.innerHTML = `<img src="${item.content}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;" alt="${item.name}">`;
                ico.style.background = 'transparent';
                ext.style.display = 'none'; // Hide ext label for images
            } else {
                // Regular file icon
                const hueMap = { pdf: '#ef4444', doc: '#5b21b6', docx: '#5b21b6', ppt: '#d97706', pptx: '#d97706', xls: '#16a34a', xlsx: '#16a34a', md: '#0ea5e9', txt: '#64748b', json: '#10b981', js: '#f59e0b', ts: '#6366f1', py: '#22c55e', cs: '#9333ea', java: '#ea580c', jpg: '#f59e0b', jpeg: '#f59e0b', png: '#f59e0b', gif: '#f59e0b' };
                ico.style.background = (hueMap[item.ext] || '#eef2f7');
            }

            t.append(ico, ext, name, meta);
            const actions = div('tile-actions');
            const del = document.createElement('button');
            del.className = 'btn mini danger';
            del.textContent = 'Entfernen';
            del.addEventListener('click', onRemove);
            actions.append(del);
            t.append(actions);
            return t;
        }
        async function handleFiles(files) {
            for (const file of files) {
                const name = file.name; const ext = extFromName(name);
                let text = ''; if (file.type?.startsWith('text/') || /\.(md|json|cs|py|js|ts|java|html|css)$/i.test(name)) { text = await file.text(); }
                else if (/\.pdf$/i.test(name)) { text = '[PDF – Inhalt nicht analysiert]'; } else { text = '[Unbekannter Dateityp – rudimentär analysiert]'; }
                const analysis = analyzeFileContent(text, name);
                const folderId = ensureFolderForTopic(analysis.topic);
                const item = { id: uid(), name, ext, topic: analysis.topic, grade: analysis.grade, notes: analysis.notes, added: new Date().toISOString() };
                const f = folderState.folders.find(x => x.id === folderId); f.items.unshift(item);
            }
            saveFolders(); renderFolders(); alert('Dateien analysiert und einsortiert.');
        }
        function analyzeFileContent(text, filename) {
            const lower = (text + ' ' + filename).toLowerCase();
            const topics = [{ topic: 'Mathe', kws: ['mathe', 'algebra', 'geometrie', 'gleichung', 'funktion', 'statistik', 'integral', 'ableitung'] }, { topic: 'Deutsch', kws: ['deutsch', 'grammatik', 'gedicht', 'satz', 'analyse', 'interpretation', 'rechtschreibung'] }, { topic: 'Englisch', kws: ['englisch', 'english', 'grammar', 'essay', 'vocabulary'] }, { topic: 'Informatik', kws: ['informatik', 'programm', 'code', 'algorithmus', 'java', 'python', 'javascript', 'html', 'css', 'daten'] }, { topic: 'Biologie', kws: ['biologie', 'zelle', 'gen', 'dna', 'evolution', 'pflanze', 'tier'] }, { topic: 'Chemie', kws: ['chemie', 'reaktion', 'säure', 'base', 'molekül', 'atom', 'periodensystem'] }, { topic: 'Physik', kws: ['physik', 'kraft', 'energie', 'bewegung', 'spannung', 'strom', 'welle'] }, { topic: 'Geschichte', kws: ['geschichte', 'antik', 'mittelalter', 'krieg', 'revolution', 'historisch'] }, { topic: 'Geographie', kws: ['geographie', 'erde', 'klima', 'karte', 'kontinent', 'geologie'] }];
            let best = { topic: 'Allgemein', score: 0 }; topics.forEach(t => { const hits = t.kws.reduce((a, kw) => a + (lower.includes(kw) ? 1 : 0), 0); if (hits > best.score) best = { topic: t.topic, score: hits }; });
            let grade = 60; const rewards = [/\b\d{2,}\b/g, /#{1,6}\s\w+/g, /```[\s\S]*?```/g, /\b(formel|beweis|beispiel|definition)\b/gi, /\bquelle|referenz|literatur\b/gi];
            const penalties = [/\b(stimmt nicht|falsch|fehler|unklar|widerspruch)\b/gi, /\?\?/g, /\b(lorem ipsum|platzhalter)\b/gi];
            rewards.forEach(rx => { const m = lower.match(rx); if (m) grade += Math.min(10, m.length * 2); });
            penalties.forEach(rx => { const m = lower.match(rx); if (m) grade -= Math.min(20, m.length * 4); });
            grade = clamp(Math.round(grade), 1, 100);
            const notes = `Erkannter Themenbereich: ${best.topic}. (Heuristische Bewertung – offline)`;
            return { topic: best.topic, grade, notes };
        }
        function ensureFolderForTopic(topic) { let f = folderState.folders.find(x => x.name.toLowerCase() === topic.toLowerCase()); if (!f) { const color = colors[Math.floor(Math.random() * colors.length)]; f = { id: uid(), name: topic, color, items: [] }; folderState.folders.push(f); } return f.id; }

        /* =================== SETTINGS (Section) =================== */
        const daysInput = byId('daysInput'), periodMinInput = byId('periodMinInput'), periodCountInput = byId('periodCountInput'), breakMinInput = byId('breakMinInput');

        // Auto-save settings on input change
        function autoSaveSettings() {
            // Get selected weekdays from checkboxes
            const selectedDays = [];
            const dayCheckboxes = ['plan-day-mo', 'plan-day-di', 'plan-day-mi', 'plan-day-do', 'plan-day-fr', 'plan-day-sa', 'plan-day-so'];
            const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];

            dayCheckboxes.forEach((id, index) => {
                const checkbox = byId(id);
                if (checkbox && checkbox.checked) {
                    selectedDays.push(dayNames[index]);
                }
            });

            state.days = selectedDays.length ? selectedDays : defaultDays;
            const newPeriodMinutes = clamp(parseInt(byId('periodMinSlider')?.value || '45', 10), 15, 120);
            const newPeriodCount = clamp(parseInt(byId('periodCountSlider')?.value || '8', 10), 4, 50);
            const newBreakMinutes = clamp(parseInt(byId('breakMinSlider')?.value || '5', 10), 0, 60);

            // Check if any settings changed and regenerate time slots for all weeks if needed
            const settingsChanged = state.periodMinutes !== newPeriodMinutes ||
                state.periodCount !== newPeriodCount ||
                state.breakMinutes !== newBreakMinutes;

            state.periodMinutes = newPeriodMinutes;
            state.periodCount = newPeriodCount;
            state.breakMinutes = newBreakMinutes;

            if (settingsChanged) {
                // Regenerate time slots for all existing week plans
                weekPlans.forEach((plan, weekKey) => {
                    plan.periodMinutes = state.periodMinutes;
                    plan.periodCount = state.periodCount;
                    plan.breakMinutes = state.breakMinutes;
                    regenerateTimeSlotsForPeriodCount(plan);
                });
            }

            // Sync overview state with new settings
            syncOverviewState();

            savePlan();
            renderGrid();
            renderOverview();
            renderSettingsStats(); // Update settings stats cards
        }

        // Populate settings inputs with current state
        function populateSettingsInputs() {
            // Set weekday checkboxes
            const dayCheckboxes = ['plan-day-mo', 'plan-day-di', 'plan-day-mi', 'plan-day-do', 'plan-day-fr', 'plan-day-sa', 'plan-day-so'];
            const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];

            dayCheckboxes.forEach((id, index) => {
                const checkbox = byId(id);
                if (checkbox) {
                    checkbox.checked = state.days.includes(dayNames[index]);
                }
            });

            // Set sliders and their values
            const periodMinSlider = byId('periodMinSlider');
            const periodMinValue = byId('periodMinValue');
            if (periodMinSlider && periodMinValue) {
                periodMinSlider.value = state.periodMinutes;
                periodMinValue.textContent = state.periodMinutes;
            }

            const periodCountSlider = byId('periodCountSlider');
            const periodCountValue = byId('periodCountValue');
            if (periodCountSlider && periodCountValue) {
                periodCountSlider.value = state.periodCount;
                periodCountValue.textContent = state.periodCount;
            }

            // break slider removed

            // Update slider max values after populating
            updateSliderMaxValues();
        }

        // Add event listeners for auto-save
        function initializeSettingsControls() {
            // Weekday selection is now handled by attachWeekSpecificSettingsListeners()
            // to avoid duplicate event listeners

            // Sliders with value updates
            const periodMinSlider = byId('periodMinSlider');
            const periodMinValue = byId('periodMinValue');
            if (periodMinSlider && periodMinValue) {
                periodMinSlider.addEventListener('input', (e) => {
                    periodMinValue.textContent = e.target.value;
                    autoSaveSettings();
                });
            }

            const periodCountSlider = byId('periodCountSlider');
            const periodCountValue = byId('periodCountValue');
            if (periodCountSlider && periodCountValue) {
                periodCountSlider.addEventListener('input', (e) => {
                    periodCountValue.textContent = e.target.value;
                    autoSaveSettings();
                });
            }

            // break slider removed
        }

        // Initialize settings controls
        initializeSettingsControls();

        // Initialize plan settings
        initializePlanSettings();

        // Navigation initialization is now handled in initializeApp() to avoid conflicts

        // Populate settings inputs on page load
        populateSettingsInputs();

        // Plan settings functionality
        function initializePlanSettings() {
            // Initialize data arrays
            window.planData = {
                subjects: JSON.parse(localStorage.getItem('planSubjects') || '[]'),
                teachers: JSON.parse(localStorage.getItem('planTeachers') || '[]'),
                rooms: JSON.parse(localStorage.getItem('planRooms') || '[]'),
                colors: JSON.parse(localStorage.getItem('planColors') || '[]'),
                presets: JSON.parse(localStorage.getItem('planPresets') || '[]')
            };

            // Initialize default colors if empty
            if (window.planData.colors.length === 0) {
                window.planData.colors = [
                    { name: 'Blau', color: '#6366f1' },
                    { name: 'Rot', color: '#ef4444' },
                    { name: 'Grün', color: '#10b981' },
                    { name: 'Gelb', color: '#f59e0b' },
                    { name: 'Lila', color: '#8b5cf6' },
                    { name: 'Orange', color: '#f97316' }
                ];
                savePlanData();
            }

            // Render all components
            renderDataLists();
            renderColorPresets();
            renderPresets();

            // Attach event listeners
            attachPlanSettingsListeners();

            // Initialize week-specific settings
            updatePlanSettingsForCurrentWeek();
            attachWeekSpecificSettingsListeners();

            // Initialize slider max values (with a small delay to ensure DOM is ready)
            setTimeout(() => {
                updateSliderMaxValues();
            }, 100);
        }
        function getCurrentWeekForStructurePanel() {
            // Determine which week to use based on current page
            if (currentPage === 'pagePlan') {
                return currentPlanWeek;
            } else if (currentPage === 'pageOverview') {
                return overviewWeekKey;
            } else {
                // Default to plan week for other pages
                return currentPlanWeek;
            }
        }

        function updatePlanSettingsForCurrentWeek() {
            const weekToUse = getCurrentWeekForStructurePanel();
            const plan = weekPlans.get(weekToUse);
            if (!plan) {
                console.warn('No plan found for week:', weekToUse);
                return;
            }

            console.log('Updating plan settings for week:', weekToUse, 'with values:', {
                periodMinutes: plan.periodMinutes,
                periodCount: plan.periodCount,
                breakMinutes: plan.breakMinutes
            });

            // Update week badge
            const weekBadge = byId('currentWeekBadge');
            if (weekBadge) {
                const weekNumber = weekToUse.split('-W')[1];
                weekBadge.textContent = `W${weekNumber}`;
            }

            // Update weekday checkboxes
            const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            dayNames.forEach((day, index) => {
                const checkbox = byId(`plan-day-${day.toLowerCase()}`);
                if (checkbox) {
                    checkbox.checked = plan.days.includes(day);
                }
            });

            // Update sliders
            const periodMinSlider = byId('plan-periodMinSlider');
            const periodMinValue = byId('plan-periodMinValue');
            if (periodMinSlider && periodMinValue) {
                periodMinSlider.value = plan.periodMinutes;
                periodMinValue.textContent = plan.periodMinutes;
                console.log('Updated periodMinSlider to:', plan.periodMinutes);
            }

            const periodCountSlider = byId('plan-periodCountSlider');
            const periodCountValue = byId('plan-periodCountValue');
            if (periodCountSlider && periodCountValue) {
                periodCountSlider.value = plan.periodCount;
                periodCountValue.textContent = plan.periodCount;
                console.log('Updated periodCountSlider to:', plan.periodCount);
            }

            const breakMinSlider = byId('plan-breakMinSlider');
            const breakMinValue = byId('plan-breakMinValue');
            if (breakMinSlider && breakMinValue) {
                breakMinSlider.value = plan.breakMinutes;
                breakMinValue.textContent = plan.breakMinutes;
                console.log('Updated breakMinSlider to:', plan.breakMinutes);
            }

            const startTimeSlider = byId('plan-startTimeSlider');
            const startTimeValue = byId('plan-startTimeValue');
            if (startTimeSlider && startTimeValue) {
                const sliderValue = (plan.dayStart.h * 2) + (plan.dayStart.m / 30);
                startTimeSlider.value = sliderValue;
                startTimeValue.textContent = `${plan.dayStart.h.toString().padStart(2, '0')}:${plan.dayStart.m.toString().padStart(2, '0')}`;
                console.log('Updated startTimeSlider to:', sliderValue, 'for time:', plan.dayStart.h + ':' + plan.dayStart.m);
            }

            // Update slider max values after setting all values
            updateSliderMaxValues();
        }

        function attachWeekSpecificSettingsListeners() {
            // Weekday selection is now handled by initializeStructurePanelListeners()
            // to avoid duplicate event listeners

            // Enhanced Sliders with Smart Rules
            const periodMinSlider = byId('plan-periodMinSlider');
            const periodMinValue = byId('plan-periodMinValue');
            if (periodMinSlider && periodMinValue) {
                // Remove any existing listeners to avoid conflicts
                periodMinSlider.removeEventListener('input', periodMinSlider._oldListener);
                
                // Create new listener that provides live updates
                periodMinSlider._oldListener = (e) => {
                    const value = parseInt(e.target.value);
                    periodMinValue.textContent = value;

                    // Update slider max values
                    updateSliderMaxValues();

                    // Show contextual tooltip
                    showSliderTooltip(e.target, getPeriodDurationTooltip(value));

                    // Check if apply to all weeks is enabled
                    const applyToAllWeeks = byId('applyToAllWeeks')?.checked || false;
                    
                    if (applyToAllWeeks) {
                        // Apply to all weeks
                        weekPlans.forEach((plan, weekKey) => {
                            plan.periodMinutes = value;
                        });
                    } else {
                        // Update only the current week plan
                        const weekToUse = getCurrentWeekForStructurePanel();
                        const plan = getOrCreateWeekPlan(weekToUse);
                        plan.periodMinutes = value;
                    }
                    
                    saveWeekPlans();
                    renderGrid(); // Live update the grid
                    renderOverview(); // Live update the heatmap
                };
                
                periodMinSlider.addEventListener('input', periodMinSlider._oldListener);
            }

            const periodCountSlider = byId('plan-periodCountSlider');
            const periodCountValue = byId('plan-periodCountValue');
            if (periodCountSlider && periodCountValue) {
                // Remove any existing listeners to avoid conflicts
                periodCountSlider.removeEventListener('input', periodCountSlider._oldListener);
                
                // Create new listener that provides live updates
                periodCountSlider._oldListener = (e) => {
                    const value = parseInt(e.target.value);
                    periodCountValue.textContent = value;

                    // Show contextual tooltip
                    showSliderTooltip(e.target, getPeriodCountTooltip(value));

                    // Check if apply to all weeks is enabled
                    const applyToAllWeeks = byId('applyToAllWeeks')?.checked || false;
                    
                    if (applyToAllWeeks) {
                        // Apply to all weeks
                        weekPlans.forEach((plan, weekKey) => {
                            plan.periodCount = value;
                        });
                    } else {
                        // Update only the current week plan
                        const weekToUse = getCurrentWeekForStructurePanel();
                        const plan = getOrCreateWeekPlan(weekToUse);
                        plan.periodCount = value;
                    }
                    
                    saveWeekPlans();
                    renderGrid(); // Live update the grid
                    renderOverview(); // Live update the heatmap
                };
                
                periodCountSlider.addEventListener('input', periodCountSlider._oldListener);
            }

            const breakMinSlider = byId('plan-breakMinSlider');
            const breakMinValue = byId('plan-breakMinValue');
            if (breakMinSlider && breakMinValue) {
                // Remove any existing listeners to avoid conflicts
                breakMinSlider.removeEventListener('input', breakMinSlider._oldListener);
                
                // Create new listener that provides live updates
                breakMinSlider._oldListener = (e) => {
                    const value = parseInt(e.target.value);
                    breakMinValue.textContent = value;

                    // Update slider max values
                    updateSliderMaxValues();

                    // Show contextual tooltip
                    showSliderTooltip(e.target, getBreakDurationTooltip(value));

                    // Check if apply to all weeks is enabled
                    const applyToAllWeeks = byId('applyToAllWeeks')?.checked || false;
                    
                    if (applyToAllWeeks) {
                        // Apply to all weeks
                        weekPlans.forEach((plan, weekKey) => {
                            plan.breakMinutes = value;
                        });
                    } else {
                        // Update only the current week plan
                        const weekToUse = getCurrentWeekForStructurePanel();
                        const plan = getOrCreateWeekPlan(weekToUse);
                        plan.breakMinutes = value;
                    }
                    
                    saveWeekPlans();
                    renderGrid(); // Live update the grid
                    renderOverview(); // Live update the heatmap
                };
                
                breakMinSlider.addEventListener('input', breakMinSlider._oldListener);
            }

            const startTimeSlider = byId('plan-startTimeSlider');
            const startTimeValue = byId('plan-startTimeValue');
            if (startTimeSlider && startTimeValue) {
                // Remove any existing listeners to avoid conflicts
                startTimeSlider.removeEventListener('input', startTimeSlider._oldListener);
                
                // Create new listener that provides live updates
                startTimeSlider._oldListener = (e) => {
                    const sliderValue = parseInt(e.target.value);
                    const hour = Math.floor(sliderValue / 4);
                    const minute = (sliderValue % 4) * 15;
                    startTimeValue.textContent = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;

                    // Update slider max values
                    updateSliderMaxValues();

                    // Show contextual tooltip
                    showSliderTooltip(e.target, getStartTimeTooltip(hour, minute));

                    // Check if apply to all weeks is enabled
                    const applyToAllWeeks = byId('applyToAllWeeks')?.checked || false;
                    
                    if (applyToAllWeeks) {
                        // Apply to all weeks
                        weekPlans.forEach((plan, weekKey) => {
                            plan.dayStart = { h: hour, m: minute };
                        });
                    } else {
                        // Update only the current week plan
                        const weekToUse = getCurrentWeekForStructurePanel();
                        const plan = getOrCreateWeekPlan(weekToUse);
                        plan.dayStart = { h: hour, m: minute };
                    }
                    
                    saveWeekPlans();
                    renderGrid(); // Live update the grid
                    renderOverview(); // Live update the heatmap
                };
                
                startTimeSlider.addEventListener('input', startTimeSlider._oldListener);
            }
        }

        function savePlanSettingsForCurrentWeek() {
            console.log('=== SAVE PLAN SETTINGS ===');

            const plan = weekPlans.get(currentPlanWeek);
            if (!plan) {
                console.warn('No plan found for current week:', currentPlanWeek);
                return;
            }

            // Update days
            const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            const selectedDays = [];
            dayNames.forEach((day, index) => {
                const checkbox = byId(`plan-day-${day.toLowerCase()}`);
                if (checkbox && checkbox.checked) {
                    selectedDays.push(day);
                }
            });
            plan.days = selectedDays.length ? selectedDays : ['Mo', 'Di', 'Mi', 'Do', 'Fr'];

            // Update period settings from sliders
            const newPeriodMinutes = clamp(parseInt(byId('plan-periodMinSlider')?.value || '45', 10), 5, 480);
            const newPeriodCount = clamp(parseInt(byId('plan-periodCountSlider')?.value || '8', 10), 1, 100);
            const newBreakMinutes = clamp(parseInt(byId('plan-breakMinSlider')?.value || '5', 10), 0, 60);
            const sliderValue = clamp(parseInt(byId('plan-startTimeSlider')?.value || '32', 10), 0, 95);
            const newStartHour = Math.floor(sliderValue / 4);
            const newStartMinute = (sliderValue % 4) * 15;

            console.log('Slider values:', {
                periodMinutes: newPeriodMinutes,
                periodCount: newPeriodCount,
                breakMinutes: newBreakMinutes,
                startHour: newStartHour
            });

            console.log('Old plan values:', {
                periodMinutes: plan.periodMinutes,
                periodCount: plan.periodCount,
                breakMinutes: plan.breakMinutes,
                dayStart: plan.dayStart
            });

            // Always update plan values
            plan.periodMinutes = newPeriodMinutes;
            plan.breakMinutes = newBreakMinutes;
            plan.dayStart = { h: newStartHour, m: newStartMinute }; // Update week-specific start time

            // Calculate maximum possible periods for this start time
            const maxPeriods = getMaxPeriodsForDay(newStartHour, newStartMinute, newPeriodMinutes, newBreakMinutes);
            // Allow user to set more periods than fit in a day, but only generate time slots up to the limit
            plan.periodCount = newPeriodCount;
            plan.maxPossiblePeriods = maxPeriods;

            console.log('Max periods for start time', newStartHour + ':' + newStartMinute.toString().padStart(2, '0') + ':', maxPeriods);
            console.log('Setting period count to:', plan.periodCount);

            // Also update the global state to ensure consistency
            state.periodMinutes = newPeriodMinutes;
            state.periodCount = newPeriodCount;
            state.breakMinutes = newBreakMinutes;

            console.log('Updated plan values:', {
                periodMinutes: plan.periodMinutes,
                periodCount: plan.periodCount,
                breakMinutes: plan.breakMinutes,
                dayStart: plan.dayStart
            });

            // Save and re-render
            saveWeekPlans();
            renderGrid();
            renderOverview();

            console.log('=== PLAN SETTINGS SAVED ===');
        }

        function attachPlanSettingsListeners() {
            // Data input listeners
            byId('addSubjectBtn')?.addEventListener('click', () => addDataItem('subjects'));
            byId('addTeacherBtn')?.addEventListener('click', () => addDataItem('teachers'));
            byId('addRoomBtn')?.addEventListener('click', () => addDataItem('rooms'));
            byId('addColorBtn')?.addEventListener('click', () => addColorPreset());

            // Preset listeners
            const addPresetBtn = byId('addPresetBtn');
            const createPresetBtn = byId('createPresetBtn');

            if (addPresetBtn && !addPresetBtn.hasAttribute('data-listener-added')) {
                addPresetBtn.addEventListener('click', () => addQuickPreset());
                addPresetBtn.setAttribute('data-listener-added', 'true');
            }

            if (createPresetBtn && !createPresetBtn.hasAttribute('data-listener-added')) {
                createPresetBtn.addEventListener('click', () => showPresetModal());
                createPresetBtn.setAttribute('data-listener-added', 'true');
            }

            // Enter key listeners
            ['subjectsInput', 'teachersInput', 'roomsInput', 'colorNameInput'].forEach(id => {
                byId(id)?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (id === 'colorNameInput') {
                            addColorPreset();
                        } else {
                            addDataItem(id.replace('Input', ''));
                        }
                    }
                });
            });
        }

        function addDataItem(type) {
            const input = byId(`${type}Input`);
            if (!input || !input.value.trim()) return;

            const items = input.value.split(',').map(s => s.trim()).filter(Boolean);
            window.planData[type].push(...items);
            window.planData[type] = [...new Set(window.planData[type])]; // Remove duplicates

            input.value = '';
            renderDataLists();
            savePlanData();
        }

        function removeDataItem(type, index) {
            window.planData[type].splice(index, 1);
            renderDataLists();
            savePlanData();
        }

        function addColorPreset() {
            const colorInput = byId('customColor');
            const nameInput = byId('colorNameInput');

            if (!colorInput || !nameInput || !nameInput.value.trim()) return;

            const newColor = {
                name: nameInput.value.trim(),
                color: colorInput.value
            };

            window.planData.colors.push(newColor);
            nameInput.value = '';
            renderColorPresets();
            savePlanData();
        }

        function removeColorPreset(index) {
            window.planData.colors.splice(index, 1);
            renderColorPresets();
            savePlanData();
        }

        function renderDataLists() {
            ['subjects', 'teachers', 'rooms'].forEach(type => {
                const container = byId(`${type}List`);
                const countElement = byId(`${type}Count`);

                if (!container) return;

                container.innerHTML = window.planData[type].map((item, index) => `
                    <div class="color-preset">
                        <span class="color-preset-name">${item}</span>
                        <button class="preset-btn delete" onclick="removeDataItem('${type}', ${index})" title="Entfernen">×</button>
                    </div>
                `).join('');

                if (countElement) {
                    countElement.textContent = window.planData[type].length;
                }
            });

            // Update colors count
            const colorsCount = byId('colorsCount');
            if (colorsCount) {
                colorsCount.textContent = window.planData.colors.length;
            }
        }

        function renderColorPresets() {
            const container = byId('colorsList');
            if (!container) return;

            container.innerHTML = window.planData.colors.map((colorPreset, index) => `
                <div class="color-preset" onclick="selectColorPreset(${index})">
                    <div class="color-preset-preview" style="background: ${colorPreset.color}"></div>
                    <span class="color-preset-name">${colorPreset.name}</span>
                    <button class="preset-btn delete" onclick="event.stopPropagation(); removeColorPreset(${index})" title="Entfernen">×</button>
                </div>
            `).join('');
        }

        function selectColorPreset(index) {
            const colorPreset = window.planData.colors[index];
            byId('customColor').value = colorPreset.color;
            byId('colorNameInput').value = colorPreset.name;
        }

        function renderPresets() {
            const container = byId('presetsList');
            const count = byId('presetsCount');

            if (!container) return;

            if (window.planData.presets.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #9ca3af; font-size: 13px;">
                        Noch keine Presets erstellt.<br>
                        Klicken Sie auf "Preset" um ein neues zu erstellen.
                    </div>
                `;
            } else {
                container.innerHTML = window.planData.presets.map((preset, index) => `
                    <div class="preset-container">
                        <div class="preset-item" data-index="${index}">
                            <div class="preset-color" style="background: ${preset.color}"></div>
                            <div class="preset-info">
                                <h4 class="preset-name">${preset.name}</h4>
                                <p class="preset-details">${preset.subject} • ${preset.teacher} • ${preset.room}</p>
                            </div>
                            <div class="preset-actions">
                                <button class="preset-btn edit" onclick="togglePresetEdit(${index})" title="Bearbeiten">✏</button>
                                <button class="preset-btn delete" onclick="deletePreset(${index})" title="Löschen">×</button>
                            </div>
                        </div>
                        <div class="preset-edit-panel" id="presetEdit${index}" style="display: none;">
                            <div class="preset-edit-form">
                                <div class="preset-edit-row">
                                    <div class="preset-edit-field">
                                        <label>Name</label>
                                        <input type="text" id="editName${index}" value="${preset.name}" class="preset-edit-input">
                                    </div>
                                    <div class="preset-edit-field">
                                        <label>Fach</label>
                                        <select id="editSubject${index}" class="preset-edit-input">
                                            <option value="">Fach wählen...</option>
                                            ${window.planData.subjects.map(subject => `<option value="${subject}" ${subject === preset.subject ? 'selected' : ''}>${subject}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                                <div class="preset-edit-row">
                                    <div class="preset-edit-field">
                                        <label>Lehrer</label>
                                        <select id="editTeacher${index}" class="preset-edit-input">
                                            <option value="">Lehrer wählen...</option>
                                            ${window.planData.teachers.map(teacher => `<option value="${teacher}" ${teacher === preset.teacher ? 'selected' : ''}>${teacher}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="preset-edit-field">
                                        <label>Raum</label>
                                        <select id="editRoom${index}" class="preset-edit-input">
                                            <option value="">Raum wählen...</option>
                                            ${window.planData.rooms.map(room => `<option value="${room}" ${room === preset.room ? 'selected' : ''}>${room}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                                <div class="preset-edit-row">
                                    <div class="preset-edit-field">
                                        <label>Farbe</label>
                                        <select id="editColor${index}" class="preset-edit-input">
                                            <option value="">Farbe wählen...</option>
                                            ${window.planData.colors.map(colorPreset => `<option value="${colorPreset.color}" ${colorPreset.color === preset.color ? 'selected' : ''}>${colorPreset.name}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="preset-edit-field">
                                        <label>Dauer</label>
                                        <input type="number" id="editDuration${index}" value="${preset.duration || 2}" min="1" max="8" class="preset-edit-input">
                                    </div>
                                </div>
                                <div class="preset-edit-actions">
                                    <button class="btn mini ghost" onclick="cancelPresetEdit(${index})">Abbrechen</button>
                                    <button class="btn mini primary" onclick="savePresetEdit(${index})">Speichern</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            if (count) {
                count.textContent = `${window.planData.presets.length} Preset${window.planData.presets.length !== 1 ? 's' : ''}`;
            }
        }

        function showPresetModal() {
            // Check if modal already exists
            const existingModal = document.querySelector('.preset-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create preset modal
            const modal = document.createElement('div');
            modal.className = 'modal preset-modal';
            modal.setAttribute('aria-hidden', 'true');
            modal.innerHTML = `
                <div class="backdrop"></div>
                <div class="dialog">
                    <button class="close-x" onclick="closePresetModal()">×</button>
                    <h3>Neues Preset erstellen</h3>
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="presetName" placeholder="z.B. Mathematik Grundkurs" class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Fach</label>
                            <select id="presetSubject" class="form-input">
                                <option value="">Fach wählen...</option>
                                ${window.planData.subjects.map(subject => `<option value="${subject}">${subject}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Lehrer</label>
                            <select id="presetTeacher" class="form-input">
                                <option value="">Lehrer wählen...</option>
                                ${window.planData.teachers.map(teacher => `<option value="${teacher}">${teacher}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Raum</label>
                            <select id="presetRoom" class="form-input">
                                <option value="">Raum wählen...</option>
                                ${window.planData.rooms.map(room => `<option value="${room}">${room}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Farbe</label>
                            <select id="presetColor" class="form-input">
                                <option value="">Farbe wählen...</option>
                                ${window.planData.colors.map(colorPreset => `<option value="${colorPreset.color}" data-name="${colorPreset.name}">${colorPreset.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Dauer</label>
                            <select id="presetDuration" class="form-input">
                                <option value="1">1 Stunde (45 Min)</option>
                                <option value="2" selected>2 Stunden (90 Min)</option>
                                <option value="3">3 Stunden (135 Min)</option>
                                <option value="4">4 Stunden (180 Min)</option>
                                <option value="5">5 Stunden (225 Min)</option>
                                <option value="6">6 Stunden (270 Min)</option>
                            </select>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn ghost" onclick="closePresetModal()">Abbrechen</button>
                        <button class="btn primary" onclick="savePreset()">Speichern</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            showModal(modal, '#presetName');
        }

        function closePresetModal() {
            const modal = document.querySelector('.preset-modal');
            if (modal) {
                hideModal(modal);
                setTimeout(() => modal.remove(), 300);
            }
        }

        function savePreset() {
            const name = byId('presetName')?.value.trim();
            const subject = byId('presetSubject')?.value;
            const teacher = byId('presetTeacher')?.value;
            const room = byId('presetRoom')?.value;
            const color = byId('presetColor')?.value;
            const duration = parseInt(byId('presetDuration')?.value || '2');

            if (!name || !subject || !teacher || !room || !color) {
                alert('Bitte füllen Sie alle Felder aus.');
                return;
            }

            const preset = {
                id: Date.now(),
                name,
                subject,
                teacher,
                room,
                color,
                duration
            };

            window.planData.presets.push(preset);
            renderPresets();
            savePlanData();
            closePresetModal();
        }

        function togglePresetEdit(index) {
            const editPanel = byId(`presetEdit${index}`);
            if (!editPanel) return;

            // Close any other open edit panels
            document.querySelectorAll('.preset-edit-panel').forEach(panel => {
                if (panel.id !== `presetEdit${index}`) {
                    panel.style.display = 'none';
                }
            });

            // Toggle current panel
            if (editPanel.style.display === 'none') {
                editPanel.style.display = 'block';
            } else {
                editPanel.style.display = 'none';
            }
        }

        function cancelPresetEdit(index) {
            const editPanel = byId(`presetEdit${index}`);
            if (editPanel) {
                editPanel.style.display = 'none';
            }
        }

        function savePresetEdit(index) {
            const name = byId(`editName${index}`)?.value.trim();
            const subject = byId(`editSubject${index}`)?.value;
            const teacher = byId(`editTeacher${index}`)?.value;
            const room = byId(`editRoom${index}`)?.value;
            const color = byId(`editColor${index}`)?.value;
            const duration = parseInt(byId(`editDuration${index}`)?.value || '2');

            if (!name || !subject || !teacher || !room || !color) {
                alert('Bitte füllen Sie alle Felder aus.');
                return;
            }

            // Update preset
            window.planData.presets[index] = {
                ...window.planData.presets[index],
                name,
                subject,
                teacher,
                room,
                color,
                duration
            };

            // Close edit panel and re-render
            cancelPresetEdit(index);
            renderPresets();
            savePlanData();
        }

        function updatePreset(index) {
            const name = byId('presetName')?.value.trim();
            const subject = byId('presetSubject')?.value;
            const teacher = byId('presetTeacher')?.value;
            const room = byId('presetRoom')?.value;
            const color = byId('presetColor')?.value;
            const duration = parseInt(byId('presetDuration')?.value || '2');

            if (!name || !subject || !teacher || !room || !color) {
                alert('Bitte füllen Sie alle Felder aus.');
                return;
            }

            window.planData.presets[index] = {
                ...window.planData.presets[index],
                name,
                subject,
                teacher,
                room,
                color,
                duration
            };

            renderPresets();
            savePlanData();
            closePresetModal();
        }

        function deletePreset(index) {
            if (confirm('Preset wirklich löschen?')) {
                window.planData.presets.splice(index, 1);
                renderPresets();
                savePlanData();
            }
        }
        function addQuickPreset() {
            // Prevent multiple rapid clicks
            const addPresetBtn = byId('addPresetBtn');
            if (addPresetBtn && addPresetBtn.disabled) {
                return;
            }

            // Disable button temporarily
            if (addPresetBtn) {
                addPresetBtn.disabled = true;
                setTimeout(() => {
                    addPresetBtn.disabled = false;
                }, 500);
            }

            // Check if we have data to create a preset
            if (window.planData.subjects.length === 0 || window.planData.teachers.length === 0 || window.planData.rooms.length === 0 || window.planData.colors.length === 0) {
                alert('Bitte fügen Sie zuerst Fächer, Lehrer, Räume und Farben hinzu.');
                return;
            }

            // Create a quick preset with first available data
            const preset = {
                id: Date.now(),
                name: `Preset ${window.planData.presets.length + 1}`,
                subject: window.planData.subjects[0],
                teacher: window.planData.teachers[0],
                room: window.planData.rooms[0],
                color: window.planData.colors[0].color,
                duration: 2
            };

            window.planData.presets.push(preset);
            renderPresets();
            savePlanData();
        }

        function savePlanData() {
            localStorage.setItem('planSubjects', JSON.stringify(window.planData.subjects));
            localStorage.setItem('planTeachers', JSON.stringify(window.planData.teachers));
            localStorage.setItem('planRooms', JSON.stringify(window.planData.rooms));
            localStorage.setItem('planColors', JSON.stringify(window.planData.colors));
            localStorage.setItem('planPresets', JSON.stringify(window.planData.presets));
        }

        function focusInput(inputId) {
            const input = byId(inputId);
            if (input) {
                input.focus();
                input.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function togglePlanSettings() {
            const settingsContainer = document.querySelector('.plan-settings');
            const header = document.querySelector('.plan-settings-header');

            if (settingsContainer && header) {
                const willCollapse = !settingsContainer.classList.contains('collapsed');
                settingsContainer.classList.toggle('collapsed');
                header.classList.toggle('collapsed');
                try { localStorage.setItem('planSettingsCollapsed', String(willCollapse)); } catch { }
            }
        }

        // Collapse Plan settings by default (and persist)
        (function ensurePlanSettingsDefaultCollapsed() {
            const settingsContainer = document.querySelector('.plan-settings');
            const header = document.querySelector('.plan-settings-header');
            if (!settingsContainer || !header) return;
            let collapsed = true;
            try {
                const saved = localStorage.getItem('planSettingsCollapsed');
                if (saved != null) collapsed = saved === 'true';
            } catch { }
            if (collapsed) {
                settingsContainer.classList.add('collapsed');
                header.classList.add('collapsed');
            } else {
                settingsContainer.classList.remove('collapsed');
                header.classList.remove('collapsed');
            }
        })();

        function toggleTimetableStructurePanel() {
            const panel = byId('timetableStructurePanel');
            if (panel) {
                panel.classList.toggle('open');

                // Update settings when opening panel
                if (panel.classList.contains('open')) {
                    updatePlanSettingsForCurrentWeek();
                    initializeStructurePanelListeners();
                }
            }
        }

        function initializeStructurePanelListeners() {
            // Week navigation buttons - use the proper navigation functions for each section
            const backBtn = byId('timetableWeekBack');
            const forwardBtn = byId('timetableWeekForward');
            
            console.log('Initializing structure panel listeners...');
            console.log('Back button found:', !!backBtn);
            console.log('Forward button found:', !!forwardBtn);
            console.log('Current page:', currentPage);
            
            // Remove existing listeners to avoid duplicates
            if (backBtn && backBtn._structureListener) {
                backBtn.removeEventListener('click', backBtn._structureListener);
                backBtn._structureListener = null;
            }
            if (forwardBtn && forwardBtn._structureListener) {
                forwardBtn.removeEventListener('click', forwardBtn._structureListener);
                forwardBtn._structureListener = null;
            }
            
            // Create new listeners
            if (backBtn) {
                backBtn._structureListener = (e) => {
                    console.log('Structure panel week back clicked, currentPage:', currentPage);
                    // Add visual feedback
                    const btn = e.target.closest('button');
                    if (btn) {
                        btn.style.transform = 'scale(0.95)';
                        btn.style.opacity = '0.7';
                        setTimeout(() => {
                            btn.style.transform = '';
                            btn.style.opacity = '';
                        }, 150);
                    }
                    
                    // Use the appropriate navigation function based on current page
                    if (currentPage === 'pagePlan') {
                        console.log('Calling navigatePlanWeek(-1)');
                        navigatePlanWeek(-1);
                    } else if (currentPage === 'pageOverview') {
                        console.log('Calling navigateHeatmapWeek(-1)');
                        navigateHeatmapWeek(-1);
                    }
                    
                    // Force update structure panel display after navigation
                    console.log('Forcing structure panel update');
                    updatePlanSettingsForCurrentWeek();
                    
                    // Force update all week displays
                    setTimeout(() => {
                        updateWeekDisplay(true);
                        updatePlanWeekDisplay();
                        
                        // Also update the structure panel week badge directly
                        const weekBadge = byId('currentWeekBadge');
                        if (weekBadge) {
                            const weekToUse = getCurrentWeekForStructurePanel();
                            const weekNumber = weekToUse.split('-W')[1];
                            weekBadge.textContent = `W${weekNumber}`;
                            console.log('Structure panel week badge updated to:', `W${weekNumber}`);
                        }
                        
                        console.log('All week displays updated after back navigation');
                    }, 50);
                };
                backBtn.addEventListener('click', backBtn._structureListener);
                console.log('Back button listener attached successfully');
            } else {
                console.warn('Back button not found - week navigation may not work');
            }

            if (forwardBtn) {
                forwardBtn._structureListener = (e) => {
                    console.log('Structure panel week forward clicked, currentPage:', currentPage);
                    // Add visual feedback
                    const btn = e.target.closest('button');
                    if (btn) {
                        btn.style.transform = 'scale(0.95)';
                        btn.style.opacity = '0.7';
                        setTimeout(() => {
                            btn.style.transform = '';
                            btn.style.opacity = '';
                        }, 150);
                    }
                    
                    // Use the appropriate navigation function based on current page
                    if (currentPage === 'pagePlan') {
                        console.log('Calling navigatePlanWeek(1)');
                        navigatePlanWeek(1);
                    } else if (currentPage === 'pageOverview') {
                        console.log('Calling navigateHeatmapWeek(1)');
                        navigateHeatmapWeek(1);
                    }
                    
                    // Force update structure panel display after navigation
                    console.log('Forcing structure panel update');
                    updatePlanSettingsForCurrentWeek();
                    
                    // Force update all week displays
                    setTimeout(() => {
                        updateWeekDisplay(true);
                        updatePlanWeekDisplay();
                        
                        // Also update the structure panel week badge directly
                        const weekBadge = byId('currentWeekBadge');
                        if (weekBadge) {
                            const weekToUse = getCurrentWeekForStructurePanel();
                            const weekNumber = weekToUse.split('-W')[1];
                            weekBadge.textContent = `W${weekNumber}`;
                            console.log('Structure panel week badge updated to:', `W${weekNumber}`);
                        }
                        
                        console.log('All week displays updated after forward navigation');
                    }, 50);
                };
                forwardBtn.addEventListener('click', forwardBtn._structureListener);
                console.log('Forward button listener attached successfully');
            } else {
                console.warn('Forward button not found - week navigation may not work');
            }

            // Slider listeners
            const sliders = [
                { id: 'plan-periodMinSlider', valueId: 'plan-periodMinValue', key: 'periodMinutes' },
                { id: 'plan-periodCountSlider', valueId: 'plan-periodCountValue', key: 'periodCount' },
                { id: 'plan-breakMinSlider', valueId: 'plan-breakMinValue', key: 'breakMinutes' },
                { id: 'plan-startTimeSlider', valueId: 'plan-startTimeValue', key: 'dayStart' }
            ];

            sliders.forEach(({ id, valueId, key }) => {
                const slider = byId(id);
                const valueDisplay = byId(valueId);
                if (slider && valueDisplay) {
                    // Remove existing listeners to avoid duplicates
                    slider.removeEventListener('input', slider._structureListener);
                    
                    // Create new listener
                    slider._structureListener = (e) => {
                        const value = parseInt(e.target.value);
                        valueDisplay.textContent = value;
                        
                        // Check if apply to all weeks is enabled
                        const applyToAllWeeks = byId('applyToAllWeeks')?.checked || false;
                        
                        if (applyToAllWeeks) {
                            // Apply to all weeks
                            console.log(`Applying ${key} = ${value} to all weeks`);
                            weekPlans.forEach((plan, weekKey) => {
                                if (key === 'dayStart') {
                                    const hours = Math.floor(value / 2);
                                    const minutes = (value % 2) * 30;
                                    plan.dayStart = { h: hours, m: minutes };
                                } else {
                                    plan[key] = value;
                                }
                            });
                        } else {
                            // Update only the current week plan
                            const weekToUse = getCurrentWeekForStructurePanel();
                            const plan = getOrCreateWeekPlan(weekToUse);
                            if (key === 'dayStart') {
                                const hours = Math.floor(value / 2);
                                const minutes = (value % 2) * 30;
                                plan.dayStart = { h: hours, m: minutes };
                                valueDisplay.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                            } else {
                                plan[key] = value;
                            }
                        }
                        
                        saveWeekPlans();
                        renderGrid();
                        renderOverview(); // Live update the heatmap
                    };
                    
                    slider.addEventListener('input', slider._structureListener);
                }
            });

            // Weekday checkbox listeners with continuous range selection
            const dayNames = ['mo', 'di', 'mi', 'do', 'fr', 'sa', 'so'];
            dayNames.forEach((day, index) => {
                const checkbox = byId(`plan-day-${day}`);
                if (checkbox) {
                    // Remove existing listeners to avoid duplicates
                    checkbox.removeEventListener('change', checkbox._structureListener);
                    
                    // Create new listener with continuous range selection
                    checkbox._structureListener = (e) => {
                        // Check if apply to all weeks is enabled
                        const applyToAllWeeks = byId('applyToAllWeeks')?.checked || false;
                        
                        if (e.target.checked) {
                            // Select this day and all previous days
                            for (let i = 0; i <= index; i++) {
                                const prevCheckbox = byId(`plan-day-${dayNames[i]}`);
                                if (prevCheckbox) {
                                    prevCheckbox.checked = true;
                                }
                            }
                        } else {
                            // Prevent Monday from being unselected
                            if (index === 0) {
                                // If trying to unselect Monday, keep it selected
                                e.target.checked = true;
                                return;
                            }
                            
                            // Unselect this day and all following days
                            for (let i = index; i < dayNames.length; i++) {
                                const nextCheckbox = byId(`plan-day-${dayNames[i]}`);
                                if (nextCheckbox) {
                                    nextCheckbox.checked = false;
                                }
                            }
                        }
                        
                        // Update plan.days based on current selection
                        const selectedDays = [];
                        dayNames.forEach((dayName, idx) => {
                            const cb = byId(`plan-day-${dayName}`);
                            if (cb && cb.checked) {
                                const capitalizedDay = dayName.charAt(0).toUpperCase() + dayName.slice(1);
                                selectedDays.push(capitalizedDay);
                            }
                        });
                        
                        // Ensure Monday is always included
                        if (selectedDays.length === 0 || !selectedDays.includes('Mo')) {
                            selectedDays.unshift('Mo'); // Add Monday at the beginning
                            // Also ensure Monday checkbox is checked
                            const mondayCheckbox = byId('plan-day-mo');
                            if (mondayCheckbox) {
                                mondayCheckbox.checked = true;
                            }
                        }
                        
                        if (applyToAllWeeks) {
                            // Apply to all weeks
                            console.log(`Applying days = [${selectedDays.join(', ')}] to all weeks`);
                            weekPlans.forEach((plan, weekKey) => {
                                plan.days = [...selectedDays];
                            });
                        } else {
                            // Update only the current week plan
                            const weekToUse = getCurrentWeekForStructurePanel();
                            const plan = getOrCreateWeekPlan(weekToUse);
                            plan.days = selectedDays;
                        }
                        
                        saveWeekPlans();
                        renderGrid();
                        renderOverview(); // Update heatmap when weekday selection changes
                    };
                    
                    checkbox.addEventListener('change', checkbox._structureListener);
                }
            });

            // Toggle switch listener
            const applyToAllWeeksToggle = byId('applyToAllWeeks');
            const toggleLabel = byId('toggleLabel');
            if (applyToAllWeeksToggle && toggleLabel) {
                applyToAllWeeksToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        toggleLabel.textContent = t('applyToAllWeeks');
                        console.log('Global settings enabled - changes will apply to all weeks');
                    } else {
                        toggleLabel.textContent = t('applyToCurrentWeekOnly');
                        console.log('Global settings disabled - changes will apply to current week only');
                    }
                });
                
                // Initialize the label text
                toggleLabel.textContent = t('applyToCurrentWeekOnly');
            }
        }
        function saveSettingsFromForm() {
            const parsedDays = daysInput.value.split(',').map(s => s.trim()).filter(Boolean);
            state.days = parsedDays.length ? parsedDays : defaultDays;
            state.periodMinutes = clamp(parseInt(periodMinInput.value || '45', 10), 15, 120);
            state.periodCount = clamp(parseInt(periodCountInput.value || '8', 10), 4, 16);
            state.breakMinutes = clamp(parseInt(breakMinInput.value || '5', 10), 0, 60);
            savePlan(); renderGrid(); activatePill(byId('navPlan')); pagePlan.hidden = false; pageSettings.hidden = true;
        }

        /* =================== MODAL helpers =================== */
        let lastActiveEl = null;
        function showModal(modal, focusSel) { 
            try {
                lastActiveEl = document.activeElement; 
                modal.setAttribute('aria-hidden', 'false'); 
                document.body.style.overflow = 'hidden'; 
                const focusElement = (focusSel && modal.querySelector(focusSel)) || modal.querySelector('input,button,select,textarea,[tabindex]');
                if (focusElement) focusElement.focus();
            } catch (error) {
                console.error('Error in showModal:', error);
                // Fallback: just show the modal without focus management
                modal.setAttribute('aria-hidden', 'false');
                document.body.style.overflow = 'hidden';
            }
        }
        function hideModal(modal) { 
            try {
                modal.setAttribute('aria-hidden', 'true'); 
                document.body.style.overflow = ''; 
                if (lastActiveEl && lastActiveEl.focus) lastActiveEl.focus();
            } catch (error) {
                console.error('Error in hideModal:', error);
                // Fallback: just hide the modal
                modal.setAttribute('aria-hidden', 'true');
                document.body.style.overflow = '';
            }
        }
        // Close modal only if the actual backdrop itself was clicked
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', e => {
                // Only close if click target IS the modal element or its .backdrop
                if (e.target === modal || e.target.classList.contains('backdrop')) {
                    console.log('Closing modal via backdrop click');
                    hideModal(modal);
                }
            });
        });
        document.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', () => { const m = btn.closest('.modal'); if (m) hideModal(m); }));
        // esc + focus trap
        function trapFocus(e) { 
            const open = [byId('infoModal'), byId('editModal'), byId('foldersManageModal'), byId('folderEditModal'), byId('folderDetailModal')].find(m => m.getAttribute('aria-hidden') === 'false'); 
            if (!open) return; 
            const f = [...open.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])')].filter(el => !el.hasAttribute('disabled')); 
            if (!f.length) return; 
            const first = f[0], last = f[f.length - 1]; 
            if (e.key === 'Tab') { 
                if (e.shiftKey && document.activeElement === first) { 
                    last.focus(); 
                    e.preventDefault(); 
                } else if (!e.shiftKey && document.activeElement === last) { 
                    first.focus(); 
                    e.preventDefault(); 
                } 
            } else if (e.key === 'Escape') { 
                console.log('Closing modal via ESC key');
                hideModal(open); 
            } 
        }
        window.addEventListener('keydown', trapFocus);

        /* =================== HELPERS / INIT =================== */
        function div(cls, html) { const d = document.createElement('div'); if (cls) d.className = cls; if (html != null) d.innerHTML = html; return d; }

        // Initialize everything when DOM is ready
        function initializeApp() {
            try {
                loadAll();

                // Initialize timetable profiles system
                initializeTimetableProfiles();

                // Initialize settings early
                initializeSettingsToggles();
                initializeSettingsActions();

                // Start auto-save functionality
                startAutoSave();

                // Update UI text based on current language
                updateUIText();

                // Sync overview state with current settings
                syncOverviewState();

                // Ensure overview week plan exists
                if (!weekPlans.has(overviewWeekKey)) {
                    getOrCreateWeekPlan(overviewWeekKey);
                }

                // Only reset if no valid settings exist
                if (!localStorage.getItem(LS_PLAN) || state.lessons.length === 0) {
                    console.log('No saved settings found, initializing with defaults');
                    resetAllTimetableSettings();
                } else {
                    console.log('Loading saved settings from localStorage');
                    // Ensure current week plan exists
                    if (!weekPlans.has(currentPlanWeek)) {
                        getOrCreateWeekPlan(currentPlanWeek);
                    }
                }

                // Initialize current week plan if it doesn't exist
                if (!weekPlans.has(currentPlanWeek)) {
                    getOrCreateWeekPlan(currentPlanWeek);
                    // Copy current state to the week plan
                    saveCurrentWeekPlan();
                } else {
                    // Load the current week plan data into state
                    const plan = weekPlans.get(currentPlanWeek);
                    if (plan) {
                        state.lessons = [...plan.lessons];
                        state.days = [...plan.days];
                        state.periodMinutes = plan.periodMinutes;
                        state.breakMinutes = plan.breakMinutes;
                        state.periodCount = plan.periodCount;
                    }
                }

                // Ensure overview week plan exists
                if (!weekPlans.has(overviewWeekKey)) {
                    getOrCreateWeekPlan(overviewWeekKey);
                }

                // Ensure current week plan has the latest data from state
                saveCurrentWeekPlan();

                // Heatmap and Plan sections are independent - no synchronization

                // Initialize page visibility - restore last active page or default to overview
            const lastActivePage = (function(){
                try { return localStorage.getItem('lastActivePage') || 'pageOverview'; } catch { return 'pageOverview'; }
            })();

                // Hide all pages first
                if (pageOverview) pageOverview.hidden = true;
                if (pagePlan) pagePlan.hidden = true;
                if (pageFolders) pageFolders.hidden = true;
                if (pageProfile) pageProfile.hidden = true;
                
                // Ensure currentPage is properly initialized
                if (!currentPage || currentPage === 'pageNone') {
                    currentPage = 'pageOverview';
                }

                // Use the transition system to show the desired page reliably
                // Don't set currentPage to 'pageNone' as it doesn't exist
                console.log('Initializing page visibility:', { lastActivePage, currentPage });
                if (byId(lastActivePage)) {
                    console.log('Showing last active page:', lastActivePage);
                    slideToPage(lastActivePage);
                } else {
                    console.log('Last active page not found, showing overview');
                    slideToPage('pageOverview');
                }

                // Activate corresponding pill with small delay to ensure DOM is ready
                setTimeout(() => {
                    ensureOnePillActive();
                    const lastActivePillId = lastActivePage.replace('page', 'nav');
                    const targetPill = byId(lastActivePillId);
                    if (targetPill) {
                        activatePill(targetPill);
                    } else {
                        // Fallback to overview pill
                        const overviewPill = byId('navOverview');
                        if (overviewPill) {
                            activatePill(overviewPill);
                        }
                    }
            }, 50);

            // Immediate check to ensure a page is visible
            setTimeout(() => {
                const visiblePages = document.querySelectorAll('.container:not([hidden])');
                console.log('Immediate visibility check:', { visibleCount: visiblePages.length, visiblePages: Array.from(visiblePages).map(p => p.id) });
                if (visiblePages.length === 0) {
                    console.warn('No pages visible immediately after initialization, forcing overview');
                    if (pageOverview) {
                        pageOverview.hidden = false;
                        pageOverview.classList.add('active');
                        pageOverview.style.display = 'block'; // Force display
                        currentPage = 'pageOverview';
                        console.log('Overview forced visible with display override');
                    }
                }
            }, 10);

            } catch (initError) {
                console.error('Error during app initialization:', initError);
                // Enhanced fallback: ensure overview page is visible and rendered
                try {
                    const overviewPage = byId('pageOverview');
                    if (overviewPage) {
                        overviewPage.hidden = false;
                        overviewPage.classList.add('active');
                        currentPage = 'pageOverview';
                        
                        // Activate overview pill
                        const overviewPill = byId('navOverview');
                        if (overviewPill) {
                            activatePill(overviewPill);
                        }
                        
                        // Force display style
                        overviewPage.style.display = 'block';
                        
                        // Force render overview content
                        try {
                            renderOverview();
                            console.log('Overview rendered in initialization fallback');
                        } catch (renderError) {
                            console.error('Failed to render overview in fallback:', renderError);
                        }
                    }
                } catch (fallbackError) {
                    console.error('Fallback initialization failed:', fallbackError);
                }
            }

            // Ensure at least one page is visible as fallback
            setTimeout(() => {
                const visiblePages = document.querySelectorAll('.container:not([hidden])');
                if (visiblePages.length === 0) {
                    console.warn('No pages visible, showing overview as fallback');
                    if (pageOverview) {
                        pageOverview.hidden = false;
                        pageOverview.classList.add('active');
                        currentPage = 'pageOverview';
                        const overviewPill = byId('navOverview');
                        if (overviewPill) {
                            activatePill(overviewPill);
                        }
                        // Force display style
                        pageOverview.style.display = 'block';
                        
                        // Force render overview content
                        try {
                            renderOverview();
                            console.log('Overview rendered in final fallback');
                        } catch (renderError) {
                            console.error('Failed to render overview in final fallback:', renderError);
                        }
                    }
                }
            }, 100);

            // Render all components with error handling
            try {
                renderGrid();
                renderCurrent();
                renderTeacherSelect();
                renderDataSidebar();
                renderFolders();
                
                // Ensure overview is rendered with specific error handling
                try {
                    renderOverview();
                    console.log('Overview rendered successfully');
                } catch (overviewError) {
                    console.error('Error rendering overview:', overviewError);
                    // Try to render basic overview content
                    const overviewPage = byId('pageOverview');
                    if (overviewPage && !overviewPage.hidden) {
                        console.log('Attempting to render basic overview content');
                        // Force render basic content
                        setTimeout(() => {
                            try {
                                renderOverview();
                                console.log('Overview rendered on retry');
                            } catch (retryError) {
                                console.error('Overview retry failed:', retryError);
                            }
                        }, 100);
                    }
                }
            } catch (error) {
                console.error('Error rendering components:', error);
                // Try to render folders specifically
                setTimeout(() => {
                    try {
                        renderFolders();
                        console.log('Folders rendered successfully');
                    } catch (folderError) {
                        console.error('Error rendering folders:', folderError);
                    }
                }, 100);
            }

            // Ensure folders are rendered after a delay
            setTimeout(() => {
                try {
                    renderFolders();
                    console.log('Folders rendered successfully');
                } catch (error) {
                    console.error('Delayed folder rendering failed:', error);
                }
            }, 200);

            // Initialize week displays after loading
            updatePlanWeekDisplay();
            updateWeekDisplay();

            // Initialize activity display
            updateActivityDisplay();
            
            // Final check: ensure current page is properly rendered
            setTimeout(() => {
                const currentPageEl = byId(currentPage);
                if (currentPageEl && !currentPageEl.hidden) {
                    console.log('Final render check for current page:', currentPage);
                    if (currentPage === 'pageOverview') {
                        try {
                            renderOverview();
                            console.log('Final overview render completed');
                        } catch (error) {
                            console.error('Final overview render failed:', error);
                        }
                    } else if (currentPage === 'pagePlan') {
                        try {
                            renderGrid();
                            console.log('Final plan render completed');
                        } catch (error) {
                            console.error('Final plan render failed:', error);
                        }
                    } else if (currentPage === 'pageFolders') {
                        try {
                            renderFolders();
                            console.log('Final folders render completed');
                        } catch (error) {
                            console.error('Final folders render failed:', error);
                        }
                    }
                }
            }, 300);
        }

        // Global error handling for robust loading
        window.addEventListener('error', function(e) {
            console.error('Global error caught:', e.error);
            // Ensure basic functionality still works
            try {
                const overviewPage = document.getElementById('pageOverview');
                if (overviewPage) {
                    overviewPage.hidden = false;
                    overviewPage.classList.add('active');
                }
            } catch (fallbackError) {
                console.error('Fallback error handling failed:', fallbackError);
            }
        });

        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
        });

        // Run initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            // DOM is already ready
            initializeApp();
        }
        
        // Emergency fallback: ensure overview is visible immediately after DOM is ready
        function emergencyShowOverview() {
            const overviewPage = byId('pageOverview');
            if (overviewPage && overviewPage.hidden) {
                console.log('Emergency: Forcing overview to be visible');
                overviewPage.hidden = false;
                overviewPage.classList.add('active');
                overviewPage.style.display = 'block';
                currentPage = 'pageOverview';
                
                // Activate overview pill
                const overviewPill = byId('navOverview');
                if (overviewPill) {
                    activatePill(overviewPill);
                }
                
                // Render overview content
                try {
                    renderOverview();
                    console.log('Emergency overview render completed');
                } catch (error) {
                    console.error('Emergency overview render failed:', error);
                }
            }
        }
        
        // Run emergency fallback immediately
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', emergencyShowOverview);
        } else {
            emergencyShowOverview();
        }
        
        // AGGRESSIVE SOLUTION: Force overview to be visible only if no other page is active
        function forceOverviewVisible() {
            const visiblePages = document.querySelectorAll('.container:not([hidden])');
            const activePages = document.querySelectorAll('.container.active:not([hidden])');
            
            // Only force overview if no pages are visible or active
            if (visiblePages.length === 0 || activePages.length === 0) {
                const overviewPage = byId('pageOverview');
                if (overviewPage) {
                    console.log('AGGRESSIVE: Forcing overview visibility (no other pages active)');
                    
                    // Method 1: Remove hidden attribute
                    overviewPage.removeAttribute('hidden');
                    
                    // Method 2: Add active class and force-visible class
                    overviewPage.classList.add('active', 'force-visible');
                    
                    // Method 3: Set currentPage
                    currentPage = 'pageOverview';
                    
                    // Method 4: Activate pill
                    const overviewPill = byId('navOverview');
                    if (overviewPill) {
                        activatePill(overviewPill);
                    }
                    
                    // Method 5: Force render
                    try {
                        renderOverview();
                        console.log('AGGRESSIVE: Overview forced visible and rendered');
                    } catch (error) {
                        console.error('AGGRESSIVE: Render failed:', error);
                    }
                }
            } else {
                console.log('AGGRESSIVE: Other pages are active, not forcing overview');
            }
        }
        
        // Run aggressive solution multiple times
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', forceOverviewVisible);
        } else {
            forceOverviewVisible();
        }
        
        // Additional aggressive checks
        setTimeout(forceOverviewVisible, 50);
        setTimeout(forceOverviewVisible, 100);
        setTimeout(forceOverviewVisible, 200);
        setTimeout(forceOverviewVisible, 500);
        
        // Enhanced safety check: ensure overview is visible after initialization
        function ensureOverviewVisible() {
            const visiblePages = document.querySelectorAll('.container:not([hidden])');
            const activePages = document.querySelectorAll('.container.active:not([hidden])');
            
            if (visiblePages.length === 0 || activePages.length === 0) {
                console.warn('No pages visible after initialization, forcing overview display');
                const overviewPage = byId('pageOverview');
                if (overviewPage) {
                    overviewPage.hidden = false;
                    overviewPage.classList.add('active', 'force-visible');
                    currentPage = 'pageOverview';
                    const overviewPill = byId('navOverview');
                    if (overviewPill) {
                        activatePill(overviewPill);
                    }
                    // Force render overview content
                    try {
                        renderOverview();
                        console.log('Overview forced render completed');
                    } catch (error) {
                        console.error('Forced overview render failed:', error);
                    }
                }
            }
        }

        // Ensure overview content actually renders once it's visible
        let _overviewRenderedOnce = false;
        function ensureOverviewContentRendered() {
            const ov = byId('pageOverview');
            if (!ov || ov.hidden) return;
            if (_overviewRenderedOnce) return;
            try {
                renderOverview();
                _overviewRenderedOnce = true;
                console.log('Overview content rendered on startup');
            } catch (e) {
                // Try again shortly if rendering failed due to timing/layout
                setTimeout(ensureOverviewContentRendered, 50);
            }
        }

        // Final post-init guard: force-select Overview and render it
        function guaranteeInitialOverview() {
            const overviewPage = byId('pageOverview');
            const overviewPill = byId('navOverview');
            if (overviewPage) {
                overviewPage.hidden = false;
                overviewPage.classList.add('active');
                overviewPage.classList.add('force-visible');
            }
            if (overviewPill) {
                activatePill(overviewPill);
            }
            currentPage = 'pageOverview';
            try { localStorage.setItem('lastActivePage', 'pageOverview'); } catch {}
            try { renderOverview(); } catch {}
        }

        // Multiple safety checks with different timeouts
        setTimeout(() => { ensureOverviewVisible(); ensureOverviewContentRendered(); ensureOnePillActive(); guaranteeInitialOverview(); }, 50);
        setTimeout(() => { ensureOverviewVisible(); ensureOverviewContentRendered(); ensureOnePillActive(); }, 150);
        setTimeout(() => { ensureOverviewVisible(); ensureOverviewContentRendered(); ensureOnePillActive(); }, 500);
        setTimeout(() => { ensureOverviewVisible(); ensureOverviewContentRendered(); ensureOnePillActive(); }, 1000);
        setTimeout(ensureOverviewVisible, 2000);  // Final fallback

        // Save data before page unload
        window.addEventListener('beforeunload', () => {
            try {
                autoSaveAll();
                console.log('Data saved before page unload');
            } catch (e) {
                console.error('Failed to save data before unload:', e);
            }
        });

        // Additional folder rendering on window load
        window.addEventListener('load', () => {
            setTimeout(() => {
                try {
                    renderFolders();
                    console.log('Folders rendered on window load');
                    // Ensure overview is visible after window load
                    ensureOverviewVisible();
                } catch (error) {
                    console.error('Error rendering folders on window load:', error);
                }
            }, 500);
        });

        // Additional safety: ensure overview on page focus/visibility
        window.addEventListener('focus', () => {
            setTimeout(ensureOverviewVisible, 100);
        });

        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                setTimeout(ensureOverviewVisible, 100);
            }
        });

        // Force folder rendering on page visibility change
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                setTimeout(() => {
                    try {
                        renderFolders();
                        console.log('Folders rendered on visibility change');
                    } catch (error) {
                        console.error('Error rendering folders on visibility change:', error);
                    }
                }, 100);
            }
        });

        // ticker
        setInterval(() => {
            if (isResizing) {
                renderCurrent();
                if (redlineTip && !redlineTip.hidden) {
                    redlineTip.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                }
                return;
            }

            if (!pagePlan.hidden) {
                renderGrid();
                renderCurrent();
            } else if (!pageOverview.hidden) {
                renderOverview();
                renderCurrent(); // die kleine Leiste unter der Pillbar bleibt aktuell
            }

            if (redlineTip && !redlineTip.hidden) {
                redlineTip.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            }
        }, 1000);

        // --- Additions: helper to jump to tabs + make overview boxes clickable ---
        const goTo = (which) => {
            if (which === 'plan') byId('navPlan')?.click();
            else if (which === 'folders') byId('navFolders')?.click();
            else if (which === 'profile') byId('navProfile')?.click();
            else byId('navOverview')?.click();
        };

        // after your existing renderOverview() definition runs, we (re)wire clicks each time:
        const _renderOverviewOrig = window.renderOverview;
        window.renderOverview = function () {
            _renderOverviewOrig();
            // Ordner-Badge im Hero: direkt zum Ordner
            const folderBadge = byId('ovHeroFolder');
            if (folderBadge) {
                folderBadge.addEventListener('click', (e) => {
                    e.stopPropagation(); // verhindert, dass der Hero zum Plan springt
                    const fid = folderBadge.getAttribute('data-folder-id');
                    if (!fid) return;
                    // Ordner-Detail öffnen
                    const f = folderState.folders.find(x => x.id === fid);
                    if (f) { openFolderDetail(f.id); }
                    // außerdem zur Folders-Seite wechseln
                    byId('navFolders')?.click();
                }, { once: false });
            }

            // Falls noch kein Ordner existiert: Anlegen-Button
            const createBtn = byId('ovHeroCreateFolder');
            if (createBtn) {
                createBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Fachname aus dem gerade/nächsten Lesson-Label ziehen
                    const info = currentOrNextLesson();
                    const subj = info && info.lesson ? (info.lesson.subject || 'Allgemein') : 'Allgemein';
                    // neuen Ordner anlegen (Farbe aus Fachfarbe)
                    const color = colorForSubject(subj);
                    const f = { id: uid(), name: subj, color, items: [] };
                    folderState.folders.unshift(f);
                    saveFolders();
                    renderFolders();
                    // gleich öffnen
                    byId('navFolders')?.click();
                    openFolderDetail(f.id);
                }, { once: true });
            }

            // click targets
            byId('ovHeroBox')?.addEventListener('click', () => goTo('plan'), { once: false });
            byId('kpiWeekBox')?.addEventListener('click', () => goTo('plan'), { once: false });
            byId('kpiFreeBox')?.addEventListener('click', () => goTo('plan'), { once: false });
            byId('kpiSubjectsBox')?.addEventListener('click', () => goTo('plan'), { once: false });
            byId('kpiFolders')?.addEventListener('click', (e) => { e.stopPropagation(); goTo('folders'); }, { once: false });

            byId('heatmapCard')?.addEventListener('click', (e) => {
                // Don't navigate if week input is active
                if (window.weekInputActive && window.weekInputType === 'heatmap') {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
                const weekDisplay = byId('weekDisplay');
                if (weekDisplay && weekDisplay.classList.contains('editing')) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
                goTo('plan');
            }, { once: false });

            byId('todayCard')?.addEventListener('click', () => {
                const currentWeekKey = getCurrentWeekKey();
                switchToWeekPlan(currentWeekKey);
                updatePlanWeekDisplay();
                updateWeekDisplay();
                goTo('plan');
            }, { once: false });
            byId('recentCard')?.addEventListener('click', () => goTo('folders'), { once: false });
        };

        // Additional safety check for renderOverview after initialization
        setTimeout(() => {
            if (typeof window.renderOverview === 'function') {
                window.renderOverview();
            }
        }, 200);
        // smoke tests
        (function () { console.log('%cSelf-tests…', 'font-weight:bold'); console.assert(timeLabelFromMinutes({ h: 8, m: 0 }, 45) === '08:45', 'timeLabelFromMinutes'); console.log('%cOK', 'color:green'); })();
    </script>
    <!-- Support Widget -->
    <style>
        /* Theme Toggle Button (Left Side) */
        .theme-fab {
            position: fixed;
            left: 20px;
            bottom: 20px;
            z-index: 10000;
        }

        .theme-fab button {
            background: #1a1a1a;
            color: var(--card);
            border: 1px solid #404040;
            border-radius: 999px;
            padding: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, .15);
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Dark mode: white background with black sun */
        [data-theme="dark"] .theme-fab button,
        [data-theme="dark-learning"] .theme-fab button {
            background: white;
            color: black;
            border: 1px solid #e0e0e0;
        }

        .theme-fab button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, .2);
        }

        .theme-fab button:active {
            transform: translateY(0);
        }

        .theme-fab .ico {
            width: 20px;
            height: 20px;
            position: relative;
        }

        .theme-fab .sun-icon,
        .theme-fab .moon-icon {
            position: absolute;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Show sun icon in dark mode (black), moon icon in light mode (white) */
        [data-theme="dark"] .theme-fab .sun-icon,
        [data-theme="dark-learning"] .theme-fab .sun-icon {
            opacity: 1;
            transform: rotate(0deg);
            stroke: black;
        }

        [data-theme="dark"] .theme-fab .moon-icon,
        [data-theme="dark-learning"] .theme-fab .moon-icon {
            opacity: 0;
            transform: rotate(90deg);
        }

        [data-theme="light"] .theme-fab .sun-icon,
        [data-theme="learning"] .theme-fab .sun-icon,
        :root:not([data-theme]) .theme-fab .sun-icon {
            opacity: 0;
            transform: rotate(-90deg);
        }

        [data-theme="light"] .theme-fab .moon-icon,
        [data-theme="learning"] .theme-fab .moon-icon,
        :root:not([data-theme]) .theme-fab .moon-icon {
            opacity: 1;
            transform: rotate(0deg);
            stroke: white;
        }

        .support-fab {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 10000;
        }

        .support-fab button {
            background: #2563eb;
            color: var(--card);
            border: none;
            border-radius: 999px;
            padding: 12px 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, .15);
            cursor: pointer;
            font-weight: 700;
        }

        .support-panel {
            position: fixed;
            right: 20px;
            bottom: 80px;
            width: 280px;
            min-width: 260px;
            max-height: 50vh;
            min-height: 500px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 12px 28px rgba(0, 0, 0, .16);
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 10000;
        }

        .support-panel.open {
            display: flex;
        }

        .support-header {
            background: #111827;
            color: var(--card);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .support-tabs {
            display: flex;
            gap: 4px;
            padding: 6px;
        }

        .support-tab {
            appearance: none;
            border: none;
            background: transparent;
            color: #d1d5db;
            font-weight: 700;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
        }

        .support-tab.active {
            background: rgba(255, 255, 255, .12);
            color: var(--card);
        }

        .support-close {
            background: transparent;
            color: var(--card);
            border: none;
            cursor: pointer;
            font-weight: 700;
            padding: 6px 10px;
        }

        .support-messages {
            padding: 8px;
            overflow: auto;
            flex: 1;
            background: var(--card);
        }

        .support-input {
            display: flex;
            gap: 6px;
            padding: 8px;
            border-top: 1px solid var(--border);
            background: var(--card);
        }

        .support-input input {
            flex: 1;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 10px;
        }

        .support-input button {
            background: #2563eb;
            color: var(--card);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-weight: 700;
            cursor: pointer;
        }

        .support-actions {
            display: flex;
            gap: 6px;
            padding: 8px;
            border-top: 1px solid var(--border);
            background: var(--card);
        }

        .support-actions button {
            flex: 1;
            border: 1px solid var(--border);
            background: var(--card);
            border-radius: 8px;
            padding: 6px 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .msg {
            display: flex;
            margin: 6px 0;
        }

        .msg.me {
            justify-content: flex-end;
        }

        .msg .bubble {
            max-width: 80%;
            padding: 6px 8px;
            border-radius: 12px;
            font-size: 12px;
            line-height: 1.35;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .06);
        }

        .msg.me .bubble {
            background: rgba(59, 130, 246, 0.1);
            color: var(--text);
            border-top-right-radius: 4px;
        }

        .msg.them .bubble {
            background: var(--card);
            border: 1px solid var(--border);
            border-top-left-radius: 4px;
        }

        /* In-panel history view via tabs */
        #supportHistoryPane {
            display: none;
            padding: 8px;
            overflow: auto;
            background: var(--card);
            flex: 1;
        }

        .support-panel.mode-history #supportHistoryPane {
            display: block;
        }

        .support-panel.mode-history .support-messages,
        .support-panel.mode-history .support-input {
            display: none;
        }

        .support-history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .ticket-row {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            background: var(--card);
        }

        .ticket-row h4 {
            margin: 0 0 6px 0;
            font-size: 14px;
        }

        .ticket-row small {
            color: var(--muted);
        }
    </style>
    <!-- Theme Toggle Button (Left Side) -->
    <div id="themeFab" class="theme-fab">
        <button id="themeToggle" aria-label="Toggle Dark Mode">
            <span class="ico" aria-hidden="true">
                <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </span>
        </button>
    </div>

    <div id="supportFab" class="support-fab">
        <button id="supportOpenBtn">Support</button>
    </div>
    <div id="supportPanel" class="support-panel" aria-hidden="true">
        <div class="support-header">
            <div class="support-tabs">
                <button id="tabChat" class="support-tab active">Chat</button>
                <button id="tabHistory" class="support-tab">History</button>
            </div>
            <button id="supportCloseBtn" class="support-close">×</button>
        </div>
        <div id="supportMessages" class="support-messages"></div>
        <div id="supportHistoryPane">
            <div style="padding: 0 0 8px 0; font-weight: 700; color:#111827;">Support History</div>
            <div id="supportHistoryList" class="support-history-list"></div>
        </div>
        <div class="support-input">
            <input id="supportInput" type="text" placeholder="Describe your issue…">
            <button id="supportSendBtn">Send</button>
        </div>
        <div class="support-actions">
            <button id="supportCloseTicketBtn">Close</button>
            <button id="supportNewTicketBtn">New</button>
        </div>
    </div>
    <!-- No external modal; history is embedded in the panel -->
    <script>
        (function () {
            const STORAGE_KEY = 'supportTickets.v1';
            const state = { currentTicketId: null, tickets: [] };

            function loadTickets() {
                try { state.tickets = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
                catch { state.tickets = []; }
            }
            function saveTickets() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state.tickets));
            }
            function uid() { return Math.random().toString(36).slice(2) + Date.now().toString(36); }
            function now() { return new Date().toISOString(); }

            function getCurrentTicket() {
                return state.tickets.find(t => t.id === state.currentTicketId) || null;
            }
            function ensureOpenTicket() {
                let t = getCurrentTicket();
                if (!t || t.status !== 'open') {
                    t = { id: uid(), status: 'open', createdAt: now(), closedAt: null, messages: [] };
                    state.tickets.unshift(t);
                    state.currentTicketId = t.id;
                    saveTickets();
                }
                return t;
            }

            function renderMessages() {
                const box = document.getElementById('supportMessages');
                const t = getCurrentTicket();
                box.innerHTML = '';
                if (!t) return;
                t.messages.forEach(m => {
                    const row = document.createElement('div');
                    row.className = 'msg ' + (m.sender === 'me' ? 'me' : 'them');
                    const b = document.createElement('div');
                    b.className = 'bubble';
                    b.textContent = m.text;
                    row.appendChild(b);
                    box.appendChild(row);
                });
                box.scrollTop = box.scrollHeight;
            }

            function renderHistory() {
                const list = document.getElementById('supportHistoryList');
                list.innerHTML = '';
                state.tickets.forEach(t => {
                    const row = document.createElement('div');
                    row.className = 'ticket-row';
                    const title = document.createElement('h4');
                    const firstLine = (t.messages[0]?.text || '(no message)').slice(0, 60);
                    title.textContent = `#${t.id.slice(0, 6)} · ${t.status.toUpperCase()} · ${firstLine}`;
                    const meta = document.createElement('small');
                    meta.textContent = `Created: ${t.createdAt}${t.closedAt ? ' · Closed: ' + t.closedAt : ''}`;
                    row.appendChild(title);
                    row.appendChild(meta);
                    row.addEventListener('click', () => {
                        state.currentTicketId = t.id;
                        switchTab('chat');
                    });
                    list.appendChild(row);
                });
            }
            function switchTab(mode) {
                const panel = document.getElementById('supportPanel');
                const chatTab = document.getElementById('tabChat');
                const histTab = document.getElementById('tabHistory');
                if (mode === 'history') {
                    panel.classList.add('mode-history');
                    chatTab.classList.remove('active');
                    histTab.classList.add('active');
                    renderHistory();
                } else {
                    panel.classList.remove('mode-history');
                    chatTab.classList.add('active');
                    histTab.classList.remove('active');
                    renderMessages();
                }
            }
            function openPanel() {
                document.getElementById('supportPanel').classList.add('open');
                document.getElementById('supportPanel').setAttribute('aria-hidden', 'false');
                ensureOpenTicket();
                switchTab('chat');
                setTimeout(() => document.getElementById('supportInput').focus(), 0);
            }
            function closePanel() {
                document.getElementById('supportPanel').classList.remove('open');
                document.getElementById('supportPanel').setAttribute('aria-hidden', 'true');
            }
            function sendMessage() {
                const input = document.getElementById('supportInput');
                const text = (input.value || '').trim();
                if (!text) return;
                const t = ensureOpenTicket();
                t.messages.push({ sender: 'me', text, at: now() });
                saveTickets();
                input.value = '';
                renderMessages();
                // Optional: echo acknowledgement
                setTimeout(() => {
                    t.messages.push({ sender: 'them', text: 'Thanks! We received your ticket.', at: now() });
                    saveTickets();
                    renderMessages();
                }, 300);
            }
            function closeTicket() {
                const t = getCurrentTicket();
                if (!t || t.status === 'closed') return;
                t.status = 'closed';
                t.closedAt = now();
                saveTickets();
                state.currentTicketId = null;
                renderMessages();
            }
            // remove modal-like history toggling; now via tabs

            // Wire up
            loadTickets();
            document.getElementById('supportOpenBtn').addEventListener('click', openPanel, { once: false });
            document.getElementById('supportCloseBtn').addEventListener('click', closePanel, { once: false });
            document.getElementById('supportSendBtn').addEventListener('click', sendMessage, { once: false });
            document.getElementById('supportInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); }, { once: false });
            document.getElementById('supportCloseTicketBtn').addEventListener('click', closeTicket, { once: false });
            document.getElementById('supportNewTicketBtn').addEventListener('click', () => { state.currentTicketId = null; ensureOpenTicket(); switchTab('chat'); }, { once: false });
            document.getElementById('tabChat').addEventListener('click', () => switchTab('chat'), { once: false });
            document.getElementById('tabHistory').addEventListener('click', () => switchTab('history'), { once: false });
        })();
    </script>

    <!-- Theme and Learning Mode Script -->
    <script>
        (function() {
            // Theme management
            const themeToggle = document.getElementById('themeToggle');
            const pomFace = document.getElementById('pomFace');
            let isLearningMode = false;
            let currentTheme = 'light'; // light, dark, learning, dark-learning

            // Load saved theme from localStorage
            function loadTheme() {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme) {
                    currentTheme = savedTheme;
                    applyTheme();
                }
            }

            // Save theme to localStorage
            function saveTheme() {
                localStorage.setItem('theme', currentTheme);
            }

            // Apply theme to document
            function applyTheme() {
                document.documentElement.setAttribute('data-theme', currentTheme);
                saveTheme();
            }

            // Toggle between light and dark mode
            function toggleTheme() {
                if (isLearningMode) {
                    // If in learning mode, toggle between learning and dark-learning
                    currentTheme = currentTheme === 'learning' ? 'dark-learning' : 'learning';
                } else {
                    // If not in learning mode, toggle between light and dark
                    currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                }
                applyTheme();
            }

            // Toggle learning mode
            function toggleLearningMode() {
                isLearningMode = !isLearningMode;
                
                if (isLearningMode) {
                    // Enter learning mode
                    if (currentTheme === 'light') {
                        currentTheme = 'learning';
                    } else if (currentTheme === 'dark') {
                        currentTheme = 'dark-learning';
                    }
                } else {
                    // Exit learning mode
                    if (currentTheme === 'learning') {
                        currentTheme = 'light';
                    } else if (currentTheme === 'dark-learning') {
                        currentTheme = 'dark';
                    }
                }
                
                applyTheme();
            }

            // Add click event to theme toggle button
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }

            // Add click event to timer face for learning mode
            if (pomFace) {
                pomFace.addEventListener('click', function(e) {
                    // Don't trigger if clicking on the reset button
                    if (e.target.closest('.reset-inside')) {
                        return;
                    }
                    toggleLearningMode();
                });
            }

            // Initialize theme on page load
            loadTheme();
        })();
    </script>
</body>

</html>