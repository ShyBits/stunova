<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>stunova. – Stundenplan</title>
<style>
    :root {
        --bg: #f8fafc;
        --card: #fff;
        --text: #0f172a;
        --muted: #475569;
        --border: #e5e7eb;
        --accent: #ef4444;
        --row-h: 64px;
        --left-col-w: 120px;
        --shadow: 0 2px 6px rgba(0, 0, 0, .06), 0 10px 30px rgba(0, 0, 0, .06);
    }

    html,
    body {
        height: 100%;
    }

    *,
    :before,
    :after {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, Helvetica Neue, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: var(--bg);
        color: var(--text);
    }

    [hidden] {
        display: none !important;
    }

    .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 0 16px;
    }

    header.sticky {
        position: sticky;
        top: 0;
        z-index: 30;
        backdrop-filter: blur(8px);
        background: rgba(255, 255, 255, .7);
        border-bottom: 1px solid var(--border);
    }

    /* Mobile navigation at bottom */
    @media (max-width: 768px) {
        /* Keep header at top */
        header.sticky {
            position: sticky;
            top: 0;
            border-bottom: 1px solid var(--border);
            background: rgba(255, 255, 255, .7);
        }

        /* Position nav-container at bottom on mobile */
        .nav-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 40;
            display: flex;
            justify-content: center;
            padding: 8px 16px;
            background: transparent;
        }

        /* Style nav-island for mobile bottom positioning - match desktop exactly */
        .nav-island {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            background: #f1f5f9;
            border-radius: 50px;
            padding: 6px;
            margin: 12px auto;
            width: max-content;
            position: relative;
        }

        /* Ensure ::before pseudo-element works on mobile */
        .nav-island::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.6) 0%, rgba(248, 250, 252, 0.4) 100%);
            border-radius: 50px;
            z-index: -1;
        }

        /* Add padding to body to prevent content from being hidden behind bottom nav */
        body {
            padding-bottom: 80px;
        }
    }

    .hstack {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        padding: 6px 0;
        gap: 12px;
    }

    h1 {
        font-size: 20px;
        margin: 0;
        font-weight: 800;
        letter-spacing: -.01em
    }

    .nav-island {
        display: flex;
        gap: 20px;
        align-items: center;
        justify-content: center;
        background: #f1f5f9;
        border-radius: 50px;
        padding: 6px;
        margin: 12px auto;
        width: max-content;
        position: relative;
        overflow: hidden;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
    }

    .pill-slider {
        display: none;
    }
    
    .nav-island::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.6) 0%, rgba(248, 250, 252, 0.4) 100%);
        border-radius: 50px;
        z-index: -1;
    }

    .pill {
        appearance: none;
        border: 0;
        border-radius: 50px;
        padding: 10px 10px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        background: transparent;
        color: #64748b;
        transition: color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        min-width: 44px;
        height: 44px;
        width: 44px;
        text-align: center;
        letter-spacing: 0.025em;
        z-index: 2;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .pill::before {
        display: none;
    }

    .pill:hover {
        color: #1e293b;
        background: rgba(255, 255, 255, 0.8);
    }
    
    .pill:hover::before {
        opacity: 0.1;
    }


    /* Navigation icons */
    .nav-icon {
        width: 22px;
        height: 22px;
        stroke-width: 2;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .pill:hover .nav-icon {
        transform: scale(1.1);
    }

    .pill.primary .nav-icon {
        stroke: #ffffff;
    }

    .pill:not(.primary) .nav-icon {
        stroke: #64748b;
    }

    .pill:hover:not(.primary) .nav-icon {
        stroke: #6366f1;
    }

    .btn {
        appearance: none;
        border: 0;
        border-radius: 12px;
        padding: 8px 12px;
        font-size: 14px;
        cursor: pointer
    }

    .btn.primary {
        background: #111827;
        color: #fff
    }

    .btn.ghost {
        background: #e5e7eb;
        color: #111827
    }

    .btn.danger {
        background: #fee2e2;
        color: #b91c1c
    }

    .btn.mini {
        padding: 6px 10px;
        font-size: 12px;
        border-radius: 10px;
        transition: transform 0.15s ease;
    }

    .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: var(--shadow)
    }

    main {
        padding: 12px 0 24px
    }

    footer {
        padding: 24px 0 48px;
        color: #64748b;
        font-size: 12px
    }

    .layout {
        display: grid;
        grid-template-columns: 1fr;
        gap: 16px;;
        align-items: start
    }

    @media (max-width:1024px) {
        .layout {
            grid-template-columns: 1fr
        }

        .sidebar {
            position: static
        }
    }

    .grid-wrap {
        position: relative;
        overflow: hidden
    }

    .grid {
        display: grid;
        grid-template-columns: var(--left-col-w) 1fr
    }

    .grid.has-days {
        grid-template-columns: var(--left-col-w) repeat(var(--day-count), 1fr)
    }

    .grid .head {
        position: sticky;
        top: 0;
        z-index: 10;
        background: #f8fafc;
        border-bottom: 1px solid var(--border);
        padding: 12px;
        font-weight: 700;
        text-align: center
    }

    .grid .head.time {
        text-align: center
    }

    .time-col {
        position: relative
    }

    .time-cell {
        height: var(--row-h);
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        justify-content: space-between;
        padding: 6px 8px;
        color: #64748b;
        font-size: 14px;
        border-bottom: 1px solid var(--border);
        min-width: 80px;
        width: 100%;
        box-sizing: border-box;
    }
    
    .time-cell > div {
        text-align: right;
        width: 100%;
    }

    .day-col {
        position: relative
    }

    .cell {
        position: relative;
        height: var(--row-h);
        border-left: 1px solid var(--border);
        border-bottom: 1px solid var(--border);
        background: #fff;
        contain: layout style paint;
        will-change: background-color;
    }

    .cell.over {
        background: #fff1f2
    }

    .cell .add {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 28px;
        height: 28px;
        border-radius: 8px;
        background: #f8fafc;
        color: #64748b;
        border: 1px solid #e2e8f0;
        cursor: pointer;
        display: grid;
        place-items: center;
        font-size: 16px;
        font-weight: 500;
        z-index: 1;
        transition: transform .08s ease, background .12s ease, box-shadow .12s ease;
        opacity: 0.7;
        will-change: transform, background-color;
        contain: layout style paint;
    }

    .cell .add:hover {
        background: #e2e8f0;
        color: #475569;
        transform: translate(-50%, -50%) scale(1.05);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        opacity: 1;
    }

    .cell .add[hidden] {
        display: none
    }

    .lesson {
        position: absolute;
        left: 8px;
        right: 8px;
        border-radius: 10px;
        box-shadow: var(--shadow);
        border: 1px solid rgba(0, 0, 0, .06);
        padding: 12px 12px 24px;
        cursor: grab;
        user-select: none;
        overflow: hidden;
        z-index: 2;
        background: var(--card)
    }

    .lesson .row {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 8px;
    }

    .lesson .subject {
        font-size: 14px;
        font-weight: 800;
        line-height: 1.2
    }

    .lesson .sub {
        font-size: 12px;
        opacity: .9
    }

    .lesson .room {
        font-size: 12px;
        font-weight: 700;
        opacity: .9
    }

    .lesson .footer {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 22px;
        background: rgba(255, 255, 255, .55);
        font-size: 11px;
        color: #0f172a;
        display: flex;
        align-items: center;
        justify-content: center;
        border-top: 1px solid rgba(0, 0, 0, .06);
        backdrop-filter: saturate(1.4) blur(4px)
    }

    .lesson[data-span="1"] {
        padding: 10px 10px 22px
    }

    .lesson[data-span="1"] .sub,
    .lesson[data-span="1"] .room {
        display: none
    }

    .resizer {
        position: absolute;
        left: 8px;
        right: 8px;
        bottom: 2px;
        height: 10px;
        cursor: ns-resize;
        border-radius: 6px
    }

    .lesson .colorbar {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 6px;
        border-top-left-radius: 16px;
        border-bottom-left-radius: 16px;
        background: currentColor;
        opacity: .9;
        z-index: 1
    }

    .lesson.dragging {
        opacity: .9;
        filter: saturate(1.05);
        outline: 2px dashed rgba(0, 0, 0, .15);
        outline-offset: -4px;
        transform: scale(1.01)
    }

    .lesson.resizing {
        cursor: ns-resize
    }

    .lesson.important {
        background: #fef3c7 !important;
        border: 2px solid #f59e0b !important;
        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3), var(--shadow) !important;
    }

    .lesson.important .colorbar {
        background: #f59e0b !important;
        opacity: 1;
    }

    /* Completed day column styling */
    .day-col.completed {
        background: rgba(34, 197, 94, 0.1) !important;
        position: relative;
    }

    .day-col.completed::after {
        content: '✓';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 48px;
        font-weight: 900;
        color: rgba(255, 255, 255, 0.8);
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        pointer-events: none;
        z-index: 5;
    }

    .legend {
        margin-top: 16px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;;
        font-size: 12px;
        color: #475569
    }

    .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: #f1f5f9;
        border: 1px solid var(--border);
        border-radius: 999px;
        padding: 4px 8px;
        font-size: 12px
    }

    .current {
        display: flex;
        gap: 16px;;
        padding: 12px;
        align-items: center
    }

    .current .title {
        font-weight: 700
    }

    .progress {
        height: 8px;
        background: #f1f5f9;
        border-radius: 999px;
        overflow: hidden;
        margin-top: 6px
    }

    .progress>div {
        height: 100%;
        background: var(--accent)
    }

    .redline {
        position: absolute;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--accent);
        box-shadow: 0 0 0 1px rgba(239, 68, 68, .25);
        pointer-events: auto
    }

    .redline-tip {
        position: absolute;
        transform: translate(-50%, -100%);
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 4px 8px;
        font-size: 12px;
        color: var(--accent);
        box-shadow: var(--shadow);
        white-space: nowrap;
        pointer-events: none;
        z-index: 20
    }

    .sidebar {
        position: sticky;
        top: 88px
    }

    .side-card {
        padding: 12px
    }

    .accordion {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    details {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow);
        padding: 8px
    }

    summary {
        list-style: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: 700
    }

    summary::-webkit-details-marker {
        display: none
    }

    .side-list {
        display: flex;
        flex-direction: column;
        gap: 8px;;
        margin-top: 8px
    }

    .side-row {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .side-row input {
        flex: 1
    }

    .small {
        font-size: 12px;
        color: #64748b
    }

    .folders-wrap {
        padding: 12px
    }

    .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px
    }

    .dropzone {
        border: 2px dashed #cbd5e1;
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        background: #f8fafc
    }

    .dropzone.over {
        background: #eef2ff;
        border-color: #a5b4fc
    }

    .folders-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
        gap: 14px;;
        margin-top: 12px
    }

    .folder-card {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 0 12px 12px;
        box-shadow: var(--shadow);
        position: relative
    }

    .folder-top {
        height: 48px;
        display: flex;
        align-items: end;
        gap: 10px;;
        padding-top: 8px
    }

    .folder-shape {
        position: relative;
        width: 48px;
        height: 34px;
        border-radius: 8px 8px 6px 6px;
        background: #e2e8f0;
        flex: 0 0 auto
    }

    .folder-tab {
        position: absolute;
        top: -10px;
        left: 6px;
        width: 18px;
        height: 10px;
        border-radius: 6px 6px 0 0;
        background: rgba(0, 0, 0, .1)
    }

    .folder-name {
        font-weight: 800;
        flex: 1;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap
    }

    .count-badge {
        font-size: 12px;
        background: #111827;
        color: #fff;
        padding: 2px 8px;
        border-radius: 999px
    }

    .folder-actions {
        display: flex;
        gap: 6px;
        margin-top: 10px
    }

    .drag-handle {
        position: absolute;
        right: 10px;
        top: 10px;
        font-size: 14px;
        color: #64748b;
        cursor: grab
    }

    .file-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 10px;
    }

    .file-tile {
        border: 1px dashed #e5e7eb;
        border-radius: 12px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;;
        background: #fff
    }

    .file-ico {
        width: 44px;
        height: 56px;
        border-radius: 6px;
        position: relative;
        background: #eef2f7;
        display: grid;
        place-items: center;
        font-weight: 800
    }

    .file-ico::after {
        content: "";
        position: absolute;
        right: 0;
        top: 0;
        border-left: 10px solid transparent;
        border-bottom: 10px solid #d1d5db;
        border-top-right-radius: 4px
    }

    .ext {
        font-size: 12px;
        background: #111827;
        color: #fff;
        border-radius: 999px;
        padding: 2px 6px;
        align-self: start
    }

    .file-name {
        font-weight: 700;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis
    }

    .file-meta {
        font-size: 12px;
        color: #64748b
    }

    .tile-actions {
        display: flex;
        gap: 6px;
        justify-content: flex-end
    }

    .settings-wrap {
        padding: 12px
    }

    .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    .field {
        margin-top: 10px
    }

    .field label {
        font-size: 13px;
        font-weight: 600;
        display: block
    }

    .field input,
    .field select {
        margin-top: 6px;
        width: 100%;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 12px;
        font-size: 14px;
        background: #fff
    }

    .modal[aria-hidden="true"] {
        display: none
    }

    .modal[aria-hidden="false"] {
        position: fixed;
        inset: 0;
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, .3);
        backdrop-filter: blur(4px)
    }

    .modal .dialog {
        position: relative;
        z-index: 2;
        background: #fff;
        border-radius: 16px;
        padding: 28px 28px 24px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 6px 40px rgba(0, 0, 0, .25);
        width: min(500px, 95%);
        display: flex;
        flex-direction: column;
        gap: 18px;
    }

    .modal .backdrop {
        position: absolute;
        inset: 0;
        z-index: 1
    }

    .close-x {
        position: absolute;
        top: 10px;
        right: 14px;
        border: none;
        background: none;
        font-size: 22px;
        cursor: pointer;
        color: #475569
    }

    .modal .grid2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 14px;
    }

    .modal .field label {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 6px;
        display: block
    }

    .modal input,
    .modal select {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 12px;
        font-size: 14px
    }

    .modal input[type="color"] {
        height: 36px;
        border-radius: 12px;
        border: 1px solid var(--border);
        cursor: pointer;
        padding: 0
    }

    #timePreview {
        font-size: 13px;
        color: #475569;
        margin-top: -4px
    }

    .actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;;
        margin-top: 8px
    }

    .actions.split {
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
    }

    .actions.split>*:first-child {
        margin-right: auto
    }

    .modal .btn {
        min-width: 90px;
        font-weight: 600;
        transition: background .15s ease, transform .1s ease
    }

    .modal .btn:hover {
        transform: translateY(-1px)
    }

    .modal .btn.primary {
        background: #111827;
        color: #fff
    }

    .modal .btn.ghost {
        background: #e5e7eb;
        color: #111827
    }

    .modal .btn.danger {
        background: #fee2e2;
        color: #b91c1c
    }

    @media (max-width:480px) {
        .modal .grid2 {
            grid-template-columns: 1fr
        }

        .actions.split {
            flex-direction: column;
            align-items: stretch
        }

        .actions.split>*:first-child {
            margin-right: 0
        }
    }

    .container.wide {
        max-width: 1480px;
        margin: 0 auto;
    }
    
    /* Overview page specific styles */
    .ov-main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
    }
    
    .ov-section {
        margin-bottom: 32px;
        overflow: visible;
    }
    
    .ov-section-header {
        margin-bottom: 16px;
    }
    
    .ov-section-title {
        font-size: 20px;
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .ov-heatmap-today {
        display: grid;
        grid-template-columns: 2.5fr 1fr;
        gap: 24px;
    }
    
    .ov-timer-section {
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .ov-statistics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
    }
    
    .ov-hero-inline {
        margin-bottom: 24px;
    }
    
    /* Next Up Section */
    .ov-next-up-section {
        margin-bottom: 32px;
    }
    
    /* Next Up inside Heute card */
    .next-up-in-heute {
        margin-top: 16px;
        padding-top: 16px;
    }
    
    .next-up-divider {
        height: 1px;
        background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
        margin-bottom: 12px;
    }
    
    .next-up-content-heute {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .next-up-icon-small {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        flex-shrink: 0;
    }
    
    .next-up-icon-small svg {
        width: 16px;
        height: 16px;
    }
    
    .next-up-text-heute {
        flex: 1;
        min-width: 0;
    }
    
    .next-up-title-heute {
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 2px;
    }
    
    .next-up-subtitle-heute {
        font-size: 12px;
        color: #64748b;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .next-up-card {
        background: white;
        border-radius: 16px;
        padding: 16px;
        color: #1f2937;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
        max-width: 600px;
        margin: 0 auto;
    }
    
    .next-up-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .next-up-header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
        position: relative;
        z-index: 1;
    }
    
    .next-up-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .next-up-icon svg {
        width: 20px;
        height: 20px;
        stroke: white;
        stroke-width: 2;
    }
    
    .next-up-content {
        flex: 1;
        text-align: left;
    }
    
    .next-up-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 6px;
        color: #1f2937;
    }
    
    .next-up-subtitle {
        font-size: 13px;
        color: #64748b;
        line-height: 1.3;
    }
    
    .next-up-actions {
        position: relative;
        z-index: 1;
    }
    
    .next-up-actions .btn {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        border: none;
        color: white;
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 600;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s ease;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
    }
    
    .next-up-actions .btn:hover {
        background: linear-gradient(135deg, #5b21b6 0%, #4c1d95 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    
    .next-up-actions .btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
    }
    
    .next-up-actions .btn svg {
        width: 16px;
        height: 16px;
    }
    
    /* Header timer styling */
    .header-timer {
        margin-left: auto;
    }
    
    .timer-card.compact {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 0;
        background: transparent;
        border: none;
        border-radius: 0;
        box-shadow: none;
        height: 40px;
    }
    
    .timer-card.compact .timer-face {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        min-width: 120px;
        text-align: center;
        font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
        height: 40px;
        line-height: 40px;
        display: flex;
        align-items: center;
        cursor: pointer;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 0;
        box-sizing: border-box;
        user-select: none;
        caret-color: transparent;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        position: relative;
        overflow: hidden;
    }
    
    .timer-card.compact .timer-display {
        flex: 1;
        text-align: center;
        font-weight: 700;
        letter-spacing: 0.5px;
        padding: 0 12px;
        margin-right: 40px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .timer-card.compact .timer-display.editing {
        background: rgba(59, 130, 246, 0.1);
        border: 2px solid #3b82f6;
        border-radius: 8px;
        outline: none;
        cursor: text;
    }
    
    .timer-card.compact .reset-inside {
        padding: 0;
        min-width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border: none;
        color: white;
        border-radius: 0 12px 12px 0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
        flex-shrink: 0;
        box-shadow: 0 1px 2px rgba(239, 68, 68, 0.2);
        position: absolute;
        right: 0;
        top: 0;
    }
    
    .timer-card.compact .reset-inside:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
    }
    
    .timer-card.compact .reset-inside:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(239, 68, 68, 0.2);
    }
    
    .timer-card.compact .reset-inside .ico {
        width: 18px;
        height: 18px;
    }
    
    .timer-card.compact .timer-face:hover {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        border-color: #cbd5e1;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .timer-card.compact .timer-face.running {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        border-color: #2563eb;
        box-shadow: 0 1px 3px rgba(59, 130, 246, 0.2);
    }
    
    .timer-card.compact .timer-face.running .timer-display {
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }
    
    .timer-card.compact .timer-face.running:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4), 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .timer-card.compact .timer-face.running:hover .timer-display {
        color: white;
    }
    
    .timer-controls {
        display: flex;
        gap: 4px;
    }
    
    .timer-controls .btn.mini {
        padding: 0;
        min-width: 36px;
        height: 36px;
        background: #f1f5f9;
        border: none;
        color: #64748b;
        border-radius: 10px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
    }
    
    .timer-controls .btn.mini:hover {
        background: #e2e8f0;
        color: #475569;
        transform: scale(1.05);
    }
    
    .timer-controls .btn.mini.danger {
        background: #f87171;
        color: white;
    }
    
    .timer-controls .btn.mini.danger:hover {
        background: #ef4444;
        color: white;
    }
    
    .timer-controls .btn.mini .ico {
        width: 16px;
        height: 16px;
    }
    
    /* Timer end effects */
    .timer-ended {
        background: #fef2f2 !important;
        border-color: #fecaca !important;
        animation: timerBlink 1s ease-in-out infinite;
    }
    
    .timer-ended .timer-face {
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%) !important;
        border-color: #fca5a5 !important;
        animation: timerBlink 1s ease-in-out infinite;
    }
    
    .timer-ended .timer-face .timer-display {
        color: #dc2626 !important;
        text-shadow: 0 1px 2px rgba(220, 38, 38, 0.1);
    }
    
    @keyframes timerBlink {
        0%, 50% { opacity: 1; }
        25%, 75% { opacity: 0.7; }
    }
    
    .website-blink {
        animation: websiteBlink 2s ease-in-out 3;
    }
    
    @keyframes websiteBlink {
        0%, 100% { background-color: transparent; }
        50% { background-color: rgba(239, 68, 68, 0.1); }
    }
    
    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 16px;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .stat-icon svg {
        width: 24px;
        height: 24px;
        stroke: white;
        stroke-width: 2;
    }
    
    .stat-content {
        flex: 1;
    }
    
    .stat-number {
        font-size: 24px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 4px;
    }
    
    .stat-label {
        font-size: 14px;
        color: #64748b;
        font-weight: 500;
    }
    
    /* Activity List */
    .activity-list {
        display: flex;
        flex-direction: row;
        gap: 12px;
        overflow-x: auto;
        padding: 8px 0;
        width: 100%;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    
    .activity-list::-webkit-scrollbar {
        display: none;
    }
    
    .activity-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 12px;
        background: white;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
        min-width: 140px;
        flex-shrink: 0;
    }
    
    .activity-item:hover {
        border-color: #6366f1;
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
        transform: translateY(-2px);
    }
    
    .activity-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .activity-icon svg {
        width: 16px;
        height: 16px;
        stroke: white;
        stroke-width: 2;
    }
    
    .activity-content {
        text-align: center;
        width: 100%;
    }
    
    .activity-title {
        font-size: 13px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 4px;
        line-height: 1.2;
    }
    
    .activity-description {
        font-size: 11px;
        color: #64748b;
        margin-bottom: 6px;
        line-height: 1.3;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .activity-time {
        font-size: 10px;
        color: #94a3b8;
        font-weight: 500;
    }
    
    /* Quick Actions Grid */
    .quick-actions-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .quick-action-btn {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px 16px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        text-align: center;
    }
    
    .quick-action-btn:hover {
        border-color: #6366f1;
        background: #f8fafc;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
    }
    
    .action-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .action-icon svg {
        width: 20px;
        height: 20px;
        stroke: white;
        stroke-width: 2;
    }
    
    .action-text {
        font-size: 14px;
        font-weight: 600;
        color: #374151;
    }

    .overview-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: 16px;
    }

    .overview-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 16px;
    }

    @media (max-width:1200px) {
        .overview-grid {
            grid-template-columns: 1fr
        }

        .overview-row {
            grid-template-columns: 1fr
        }
    }

    .hero {
        position: relative;
        overflow: hidden;
        padding: 18px;
        border-radius: 16px;
        background: radial-gradient(1200px 400px at -15% -40%, #e0f2fe 0, transparent 60%), linear-gradient(135deg, #f0f9ff, #f7fee7);
        border: 1px solid var(--border);
        box-shadow: var(--shadow)
    }

    .hero h3 {
        margin: 0 0 6px
    }

    .hero-sub {
        color: var(--muted);
        font-size: 13px
    }

    .hero .clock {
        position: absolute;
        right: 18px;
        top: 18px;
        font-weight: 800;
        font-size: 28px;
        color: #0f172a
    }

    .kpi {
        padding: 14px;
        border: 1px solid var(--border);
        border-radius: 14px;
        background: #fff;
        display: flex;
        flex-direction: column;
        gap: 6px;
        box-shadow: var(--shadow)
    }

    .kpi .label {
        color: var(--muted);
        font-size: 12px
    }

    .kpi .value {
        font-weight: 800;
        font-size: 22px
    }

    .chart-card,
    .list-card,
    .timer-card {
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: 16px;
        background: #fff;
        box-shadow: var(--shadow)
    }

    .chart-title {
        font-weight: 700;
        margin-bottom: 6px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    /* Heatmap chart title specific styling */
    #heatmapCard .chart-title {
        justify-content: center;
        margin-bottom: 6px;
    }
    
    /* Reduce padding for heatmap card to minimize white space */
    #heatmapCard {
        padding: 4px;
    }
    
    /* Make heatmap container fill more space */
    #heatmap {
        width: 100%;
        min-width: 100%;
    }

    .chart-wrap {
        width: 100%;
        height: 220px
    }

    .mini-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .mini-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;;
        padding: 8px 10px;
        border: 1px dashed #e5e7eb;
        border-radius: 10px
    }

    .mini-item-right {
        display: flex;
        align-items: center;
        gap: 8px;;
    }

    .meta {
        font-size: 12px;
        color: var(--muted);
    }

    .mini-item .meta {
        color: var(--muted);
        font-size: 12px
    }

    .timer-controls {
        display: flex;
        gap: 8px;;
        margin-top: 8px
    }

    .timer-face {
        font-size: 28px;
        font-weight: 800
    }

    .badge {
        background: #0f172a;
        color: #fff;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 12px
    }

    /* small utility for click affordance without changing your look */
    .clickable {
        cursor: pointer
    }

    .clickable:focus-visible {
        outline: 2px solid #94a3b8;
        outline-offset: 2px;
    }

    /* --- Übersicht layout tweaks --- */
    .overview-grid .full-span {
        grid-column: 1 / -1;
    }

    /* Big, centered Pomodoro */
    .timer-card.big {
        display: grid;
        place-items: center;
        gap: 10px;;
        padding: 22px;
    }

    /* Square Pomodoro, compact, right-aligned */
    .timer-card.big.square {
        aspect-ratio: 1 / 1;
        width: 100%;
        max-width: 360px;
        /* was 420 */
        padding: 16px;
        /* tighter */
        gap: 8px;;
        place-items: center;
        justify-self: end;
        /* push to the right within the grid */
    }

    /* compact digits */
    .timer-face.xl {
        /* keep class name, just tighten */
        font-size: clamp(40px, 6.5vw, 68px);
        /* was up to ~96px */
        font-weight: 900;
        line-height: 1.05;
        letter-spacing: .01em;
        text-align: center;
        margin: 2px 0 4px;
    }

    /* slightly smaller buttons */
    .btn.lg {
        padding: 10px 14px;
        font-size: 14px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        gap: 8px;;
        box-shadow: var(--shadow);
    }

    .btn-row {
        gap: 8px;;
    }

    .btn.lg .ico {
        width: 16px;
        height: 16px;
    }

    .timer-sub {
        color: var(--muted);
        font-size: 13px;
        text-align: center;
    }

    /* XL buttons with icons */
    .btn.xl {
        padding: 12px 18px;
        font-size: 16px;
        border-radius: 14px;
        display: inline-flex;
        align-items: center;
        gap: 10px;;
        box-shadow: var(--shadow);
    }

    .btn.xl .ico {
        width: 18px;
        height: 18px;
        display: inline-block;
    }

    .btn-row {
        display: flex;
        gap: 10px;;
        flex-wrap: wrap;
        justify-content: center;
    }

    /* Keyboard focus (keeps your visual style) */
    .clickable:focus-visible,
    .btn:focus-visible {
        outline: 2px solid #94a3b8;
        outline-offset: 2px;
    }

    /* Keep muted meta utility (used in info & lists) */
    .meta {
        font-size: 12px;
        color: var(--muted);
    }

    /* --- Übersicht: structured layout --- */
    .ov-main-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 24px;
        margin-top: 24px;
    }

    .ov-primary-content {
        display: flex;
        flex-direction: column;
        gap: 32px;
    }

    .ov-secondary-content {
        display: flex;
        flex-direction: column;
        gap: 32px;
    }

    .ov-section {
        display: flex;
        flex-direction: column;
        gap: 16px;;
    }

    .ov-section-header {
        margin-bottom: 8px;
    }

    .ov-section-title {
        font-size: 18px;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
    }

    /* KPI row */
    .ov-kpis {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;;
    }

    /* Charts block (two side-by-side) */
    .ov-charts {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;;
        margin-top: 16px;
    }

    /* Heatmap and Today side by side */
    .ov-heatmap-today {
        display: grid;
        grid-template-columns: 2.5fr 1fr;
        gap: 24px;
        margin-bottom: 24px;
    }
    
    /* Weekly Plan section improvements */
    .ov-section {
        margin-bottom: 32px;
    }
    
    .ov-section-header {
        margin-bottom: 20px;
    }
    
    /* Chart card improvements */
    .chart-card {
        min-height: 300px;
    }
    
    .list-card {
        min-height: 300px;
    }
    
    /* Heute card should size to content when empty */
    .list-card:has(.small) {
        min-height: auto;
    }

    /* Timer section */
    .ov-timer-section {
        display: flex;
        justify-content: center;
    }
    
    /* Tablet responsive design (768px - 1024px) */
    @media (max-width: 1024px) and (min-width: 769px) {
        .ov-heatmap-today {
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        
        .chart-card, .list-card {
            min-height: 280px;
            padding: 18px;
        }
        
        /* Heute card should size to content when empty on tablet */
        .list-card:has(.small) {
            min-height: auto;
        }
        
        .chart-title {
            font-size: 17px;
        }
        
        .ov-section-title {
            font-size: 19px;
        }
        
        /* Heatmap tablet optimization */
        #heatmap {
            min-height: 250px;
        }
        
        .chart-card #heatmap {
            min-height: 250px;
        }
    }

    /* Subject section */
    .ov-subject-section {
        width: 100%;
    }

    /* Statistics section */
    .ov-statistics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        background: #fafafa;
        padding: 24px;
        border-radius: 16px;
        border: 1px solid #e5e7eb;
    }

    /* Week navigation */
    .week-nav-container {
        display: flex;
        align-items: center;
        gap: 12px;
        justify-content: center;
        width: 100%;
    }
    
    .week-nav {
        display: flex;
        align-items: center;
        gap: 12px;;
        background: rgba(255, 255, 255, 0.1);
        padding: 8px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .week-nav span {
        font-size: 14px;
        color: #64748b;
        min-width: 180px;
        text-align: center;
        font-weight: 500;
        line-height: 1.2;
    }
    
    .week-nav span.current-week {
        color: #6366f1;
        font-weight: 600;
    }
    
    .week-nav .btn.mini {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.1);
        color: #475569;
        font-weight: 600;
        font-size: 14px;
        width: 28px;
        height: 28px;
        border-radius: 8px;
        transition: all 0.2s ease;
    }
    
    .week-nav .btn.mini:hover {
        background: rgba(255, 255, 255, 1);
        border-color: rgba(0, 0, 0, 0.2);
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    
    .week-nav .btn.mini:active {
        transform: translateY(0);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    /* Current week button styling */
    .current-week-btn {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
        border: 1px solid #e2e8f0 !important;
        color: #475569 !important;
        font-weight: 600 !important;
        font-size: 18px !important;
        width: 44px !important;
        height: 44px !important;
        border-radius: 12px !important;
        transition: all 0.3s ease !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important;
    }

    .current-week-btn svg {
        width: 18px;
        height: 18px;
        stroke: #374151;
    }
    
    .current-week-btn:hover {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%) !important;
        border-color: #cbd5e1 !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    }
    
    .current-week-btn:active {
        transform: translateY(0) !important;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
    }
    

    /* Charts and lists side by side */
    .ov-charts-lists {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;;
        margin-top: 16px;
    }

    /* Lists block (two stacked for better scan) */
    .ov-lists {
        display: grid;
        grid-template-rows: auto auto;
        gap: 16px;;
        margin-top: 16px;
    }

    /* Right column wrapper (timer + optional space for future blocks) */
    .ov-right {
        display: grid;
        gap: 16px;;
    }

    /* Make timer compact & square on the right */
    .timer-card.big.square {
        aspect-ratio: 1 / 1;
        width: 100%;
        max-width: 360px;
        padding: 16px;
        gap: 8px;;
        place-items: center;
        justify-self: center;
    }

    /* Unify card paddings a bit */
    .kpi,
    .chart-card,
    .list-card,
    .timer-card {
        padding: 14px;
    }

    /* Dynamic chart height - will be set by JavaScript */
    .chart-wrap {
        min-height: 200px;
        height: auto;
    }

    /* Heatmap tooltip */
    .heatmap-tooltip {
        position: absolute;
        background: #1f2937;
        color: #fff;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        pointer-events: none;
        opacity: 0;
        transform: translateY(-4px);
        transition: opacity 0.2s ease, transform 0.2s ease;
        white-space: nowrap;
        max-width: 250px;
    }

    .heatmap-tooltip.show {
        opacity: 1;
        transform: translateY(0);
    }

    .heatmap-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 5px solid transparent;
        border-top-color: #1f2937;
    }

    /* Plan week navigation */
    .plan-week-nav {
        margin-top: 32px;
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .plan-week-nav-container {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .plan-week-settings {
        display: flex;
        align-items: center;
        gap: 8px;;
    }
    
    .daily-hours-setting {
        display: flex;
        align-items: center;
        gap: 6px;
        background: #f8fafc;
        padding: 6px 10px;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }
    
    .daily-hours-setting label {
        font-size: 12px;
        font-weight: 500;
        color: #475569;
        white-space: nowrap;
    }
    
    .daily-hours-setting input {
        width: 50px;
        padding: 4px 6px;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        font-size: 12px;
        text-align: center;
        background: white;
    }
    
    .daily-hours-setting input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
    }
    
    .add-row-section {
        display: flex;
        justify-content: center;
        padding: 16px;
        border-top: 1px solid #e2e8f0;
        background: #f8fafc;
    }
    
    .add-row-btn {
        display: flex;
        align-items: center;
        gap: 8px;;
        padding: 10px 20px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 8px;
        transition: all 0.2s ease;
    }
    
    .add-row-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
    }
    
    .add-row-btn .ico {
        font-size: 16px;
        font-weight: 600;
    }
    
    
    .plan-week-nav-content {
        display: flex;
        align-items: center;
        gap: 16px;;
        height: 44px;
        padding: 0;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 22px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .plan-week-nav-content span {
        font-weight: 600;
        color: #475569;
        min-width: 220px;
        text-align: center;
        font-size: 16px;
        letter-spacing: 0.5px;
    }
    
    .plan-week-nav-content span.current-week {
        color: #6366f1;
        font-weight: 700;
    }
    
    .plan-week-nav-content .btn.mini {
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 1px solid #e2e8f0;
        color: #475569;
        font-weight: 600;
        font-size: 18px;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .plan-week-nav-content .btn.mini:hover {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        border-color: #cbd5e1;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .plan-week-nav-content .btn.mini:active {
        transform: translateY(0);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Improved Ordner section */
    .folders-page {
        max-width: 1200px;
        margin: 0 auto;
    }

    .folders-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 32px;
        padding: 0 4px;
    }

    .folders-title h2 {
        margin: 0 0 4px 0;
        font-size: 28px;
        font-weight: 700;
        color: #1e293b;
    }

    .folders-subtitle {
        margin: 0;
        color: #64748b;
        font-size: 16px;
    }

    .folders-actions {
        display: flex;
        gap: 12px;;
        align-items: center;
    }

    .folders-actions .btn {
        display: flex;
        align-items: center;
        gap: 8px;;
        padding: 12px 20px;
    }

    .folders-actions .ico {
        font-size: 16px;
    }

    .upload-section {
        margin-bottom: 32px;
    }

    .dropzone {
        border: 2px dashed #cbd5e1;
        border-radius: 16px;
        padding: 40px 20px;
        text-align: center;
        background: #f8fafc;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .dropzone:hover {
        border-color: #6366f1;
        background: #eff6ff;
    }

    .dropzone.over {
        border-color: #6366f1;
        background: #dbeafe;
        transform: scale(1.02);
    }

    .dropzone-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;;
    }

    .dropzone-icon {
        font-size: 48px;
        opacity: 0.6;
    }

    .dropzone-text {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .dropzone-text strong {
        font-size: 18px;
        color: #1e293b;
    }

    .dropzone-text span {
        color: #64748b;
        font-size: 14px;
    }

    .dropzone-formats {
        color: #64748b;
        font-size: 12px;
    }

    .dropzone-formats small {
        display: block;
        margin-top: 4px;
        opacity: 0.7;
    }

    .folders-content {
        min-height: 300px;
    }

    .folders-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        text-align: center;
    }

    .empty-icon {
        font-size: 64px;
        opacity: 0.3;
        margin-bottom: 16px;
    }

    .empty-text {
        font-size: 18px;
        font-weight: 600;
        color: #64748b;
        margin-bottom: 8px;
    }

    .empty-subtext {
        color: #94a3b8;
        font-size: 14px;
    }

    .folders-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
    }

    /* Settings page styling - matching analysis section */
    .settings-page {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }

    .settings-header {
        margin-bottom: 32px;
        text-align: center;
    }

    .settings-header h2 {
        margin: 0 0 8px 0;
        font-size: 28px;
        font-weight: 700;
        color: #1e293b;
    }

    .settings-header p {
        margin: 0;
        color: #64748b;
        font-size: 16px;
    }

    .settings-content {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .settings-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 16px;;
    }

    .settings-card {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }

    .settings-card:hover {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .settings-card-header {
        margin-bottom: 20px;
        text-align: center;
    }

    .settings-card-title {
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        margin: 0 0 8px 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;;
    }

    .settings-card-description {
        font-size: 14px;
        color: #64748b;
        margin: 0;
    }

    .settings-field {
        margin-bottom: 20px;
    }

    .settings-field:last-child {
        margin-bottom: 0;
    }

    .settings-field label {
        display: block;
        font-weight: 600;
        color: #374151;
        font-size: 14px;
        margin-bottom: 8px;
    }

    .settings-field input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.2s ease;
        box-sizing: border-box;
    }

    .settings-field input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .settings-field small {
        display: block;
        color: #6b7280;
        font-size: 12px;
        margin-top: 4px;
    }
    
    /* Settings accordion styling */
    .settings-section .accordion {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .settings-section .accordion details {
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 16px;
        overflow: hidden;
        transition: all 0.2s ease;
    }
    
    .settings-section .accordion details:hover {
        border-color: #cbd5e1;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .settings-section .accordion summary {
        padding: 20px 24px;
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        border-bottom: 1px solid #e2e8f0;
        font-weight: 700;
        color: #0f172a;
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 12px;;
        font-size: 16px;
        letter-spacing: -0.025em;
        transition: all 0.2s ease;
    }
    
    .settings-section .accordion summary:hover {
        background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
        transform: translateY(-1px);
    }
    
    .settings-section .accordion details[open] summary {
        background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
        border-bottom-color: #94a3b8;
    }
    
    .settings-section .accordion .list {
        padding: 24px;
        display: flex;
        flex-direction: column;
        gap: 16px;;
        background: #fff;
    }
    
    .settings-section .accordion .row {
        display: flex;
        align-items: center;
        gap: 16px;;
    }
    
    .settings-section .accordion .row input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .settings-section .accordion .row input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        transform: translateY(-1px);
    }
    
    .settings-section .accordion .add-row {
        display: flex;
        align-items: center;
        gap: 16px;;
        margin-top: 12px;
        padding-top: 16px;
        border-top: 2px solid #f1f5f9;
    }
    
    .settings-section .accordion .add-row input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 500;
        transition: all 0.2s ease;
    }
    
    .settings-section .accordion .add-row input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        transform: translateY(-1px);
    }
    
    .settings-section .accordion .add-row button {
        padding: 12px 20px;
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.2);
    }
    
    .settings-section .accordion .add-row button:hover {
        background: linear-gradient(135deg, #5b21b6 0%, #4c1d95 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
    }
    
    .settings-section .accordion .btn.mini.danger {
        padding: 10px 16px;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
    }
    
    .settings-section .accordion .btn.mini.danger:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
    }

    .settings-actions {
        display: flex;
        justify-content: center;
        padding: 0 4px;
    }

    .settings-auto-save-notice {
        display: inline-flex;
        align-items: center;
        padding: 12px 24px;
        background: #f0f9ff;
        border: 1px solid #0ea5e9;
        border-radius: 8px;
        color: #0369a1;
        font-size: 14px;
        font-weight: 500;
        gap: 8px;;
    }

    .settings-auto-save-notice .ico {
        font-size: 16px;
    }

    /* Settings info section */
    .settings-info {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f1f5f9;
    }

    .info-item:last-child {
        border-bottom: none;
    }

    .info-label {
        font-weight: 500;
        color: #64748b;
        font-size: 14px;
    }

    .info-value {
        font-weight: 600;
        color: #1e293b;
        font-size: 14px;
    }

    /* Full-width settings sections */
    .settings-info-section {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
    }

    .settings-info-section .settings-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .settings-data-section {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        margin-top: 24px;
    }

    .settings-data-section h3 {
        margin: 0 0 20px 0;
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .settings-data-section .settings-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
    }

    /* Weekday selector */
    .weekday-selector {
        display: flex;
        gap: 0;
        flex-wrap: wrap;
    }

    .weekday-checkbox {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px 12px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
        position: relative;
        min-width: 40px;
    }

    .weekday-checkbox:first-child {
        border-radius: 8px 0 0 8px;
    }

    .weekday-checkbox:last-child {
        border-radius: 0 8px 8px 0;
    }

    .weekday-checkbox:not(:first-child) {
        border-left: none;
    }

    .weekday-checkbox:hover {
        background: #f1f5f9;
        border-color: #cbd5e1;
    }

    .weekday-checkbox input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }

    .weekday-checkbox span {
        font-size: 14px;
        color: #64748b;
        transition: all 0.2s ease;
        font-weight: 500;
    }

    .weekday-checkbox:has(input[type="checkbox"]:checked) {
        background: #6366f1;
        border-color: #6366f1;
        color: white;
    }

    .weekday-checkbox:has(input[type="checkbox"]:checked) span {
        color: white;
        font-weight: 600;
    }

    /* Slider styling */
    .slider-container {
        position: relative;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .slider-container input[type="range"] {
        flex: 1;
        height: 6px;
        background: #e2e8f0;
        border-radius: 3px;
        outline: none;
        -webkit-appearance: none;
        appearance: none;
    }

    .slider-container input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        background: #6366f1;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
        transition: all 0.2s ease;
    }

    .slider-container input[type="range"]::-webkit-slider-thumb:hover {
        background: #5b21b6;
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(99, 102, 241, 0.4);
    }

    .slider-container input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: #6366f1;
        border-radius: 50%;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
        transition: all 0.2s ease;
    }

    .slider-container input[type="range"]::-moz-range-thumb:hover {
        background: #5b21b6;
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(99, 102, 241, 0.4);
    }

    .slider-value {
        min-width: 40px;
        text-align: center;
        font-weight: 600;
        color: #1e293b;
        background: #f1f5f9;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 14px;
    }

    /* Page transition system */
    .page-container {
        position: relative;
        overflow: visible;
        min-height: 100vh;
    }
    
    /* Ensure pages are mutually exclusive */
    .page-container > .container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        width: 100%;
        min-height: 100vh;
        background: var(--bg);
        z-index: 1;
    }
    
    .page-container > .container:not([hidden]) {
        z-index: 2;
    }
    
    .page-container > .container[hidden] {
        display: none !important;
    }

    /* Pill bar selection */
    .pill {
        position: relative;
        z-index: 1;
        cursor: pointer;
        transition: all 0.2s ease;
        background: transparent;
        color: #64748b;
    }

    .pill.primary {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: #ffffff;
        transform: scale(1.05);
        border-radius: 50px;
        padding: 10px 10px;
        min-width: 44px;
        height: 44px;
        width: 44px;
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }

    .pill:not(.primary) {
        background: transparent;
        color: #64748b;
        opacity: 0.7;
    }

    .pill:not(.primary):hover {
        background: rgba(99, 102, 241, 0.1);
        color: #6366f1;
        opacity: 1;
        transform: translateY(-1px);
        border-radius: 50px;
        padding: 10px 10px;
        min-width: 44px;
        height: 44px;
        width: 44px;
    }

    /* Plan layout */
    .plan-main {
        margin-bottom: 24px;
    }

    /* Plan settings styling */
    .plan-settings {
        background: #fff;
        border-radius: 16px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }

    .plan-settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px 32px;
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        border-bottom: 1px solid #e2e8f0;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .plan-settings-header:hover {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    }

    .plan-settings-header.collapsed .settings-chevron {
        transform: rotate(180deg);
    }

    .settings-chevron {
        width: 20px;
        height: 20px;
        stroke: #64748b;
        transition: transform 0.2s ease;
    }

    .header-content {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .plan-settings-header h3 {
        font-size: 20px;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
    }

    .header-actions {
        display: flex;
        gap: 12px;
    }

    .plan-settings-content {
        padding: 32px;
        transition: all 0.3s ease;
    }

    .plan-settings-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .plan-settings-form .form-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .plan-settings-form .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }

    .plan-settings-form .weekday-selector {
        display: flex;
        gap: 0;
        flex-wrap: wrap;
    }

    .plan-settings-form .weekday-checkbox {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        cursor: pointer;
        transition: all 0.2s ease;
        background: #fff;
        position: relative;
        min-width: 40px;
    }

    .plan-settings-form .weekday-checkbox:first-child {
        border-radius: 8px 0 0 8px;
    }

    .plan-settings-form .weekday-checkbox:last-child {
        border-radius: 0 8px 8px 0;
    }

    .plan-settings-form .weekday-checkbox:not(:first-child) {
        border-left: none;
    }

    .plan-settings-form .weekday-checkbox:hover {
        border-color: #6366f1;
        background: #f8fafc;
    }

    .plan-settings-form .weekday-checkbox input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }

    .plan-settings-form .weekday-checkbox span {
        font-size: 14px;
        color: #64748b;
        transition: all 0.2s ease;
        font-weight: 500;
    }

    .plan-settings-form .weekday-checkbox:has(input[type="checkbox"]:checked) {
        border-color: #6366f1;
        background: #6366f1;
        color: white;
    }

    .plan-settings-form .weekday-checkbox:has(input[type="checkbox"]:checked) span {
        color: white;
        font-weight: 600;
    }

    .plan-settings-form .slider-container {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .plan-settings-form .slider-container input[type="range"] {
        flex: 1;
        height: 6px;
        border-radius: 3px;
        background: #e2e8f0;
        outline: none;
        cursor: pointer;
    }

    .plan-settings-form .slider-container input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #6366f1;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .plan-settings-form .slider-container input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #6366f1;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .plan-settings-form .slider-value {
        min-width: 40px;
        text-align: center;
        font-weight: 600;
        color: #374151;
        background: #f9fafb;
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
    }

    .plan-settings-form label {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
    }

    .plan-settings-form small {
        font-size: 12px;
        color: #6b7280;
    }

    /* Timetable Structure Side Panel */
    .timetable-structure-panel {
        position: fixed;
        top: 0;
        right: -400px;
        width: 400px;
        height: 100vh;
        background: #fff;
        border-left: 1px solid #e2e8f0;
        box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        transition: right 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    .timetable-structure-panel.open {
        right: 0;
    }

    .panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 1px solid #e2e8f0;
        background: #f8fafc;
    }

    .week-banner {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        padding: 16px 24px;
        border-bottom: 1px solid #e2e8f0;
    }

    .week-banner-content {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .week-nav-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
    }

    .week-info {
        display: flex;
        flex-direction: column;
        gap: 4px;
        flex: 1;
        text-align: center;
    }

    .week-nav-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #fff;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .week-nav-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        transform: scale(1.05);
    }

    .week-nav-btn:active {
        transform: scale(0.95);
    }

    .week-number {
        color: #fff;
        font-size: 18px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .week-purpose {
        color: rgba(255, 255, 255, 0.9);
        font-size: 13px;
        font-weight: 500;
    }

    .panel-header h3 {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 16px;
        font-weight: 600;
        color: #374151;
        margin: 0;
    }

    .panel-header svg {
        width: 18px;
        height: 18px;
        stroke: #6366f1;
    }


    .close-btn {
        background: none;
        border: none;
        padding: 8px;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .close-btn:hover {
        background: #f1f5f9;
    }

    .close-btn svg {
        width: 16px;
        height: 16px;
        stroke: #6b7280;
    }

    .panel-content {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
    }

    .panel-content .form-group {
        margin-bottom: 24px;
    }

    .panel-content .form-row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
    }

    .panel-content .weekday-selector {
        display: flex;
        gap: 0;
        flex-wrap: wrap;
    }

    .panel-content .weekday-checkbox {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px 12px;
        border: 1px solid #e2e8f0;
        cursor: pointer;
        transition: all 0.2s ease;
        background: #fff;
        position: relative;
        min-width: 40px;
    }

    .panel-content .weekday-checkbox:first-child {
        border-radius: 8px 0 0 8px;
    }

    .panel-content .weekday-checkbox:last-child {
        border-radius: 0 8px 8px 0;
    }

    .panel-content .weekday-checkbox:not(:first-child) {
        border-left: none;
    }

    .panel-content .weekday-checkbox:hover {
        border-color: #6366f1;
        background: #f8fafc;
    }

    .panel-content .weekday-checkbox input[type="checkbox"] {
        position: absolute;
        opacity: 0;
        pointer-events: none;
    }

    .panel-content .weekday-checkbox span {
        font-size: 14px;
        color: #64748b;
        transition: all 0.2s ease;
        font-weight: 500;
    }

    .panel-content .weekday-checkbox:has(input[type="checkbox"]:checked) {
        border-color: #6366f1;
        background: #6366f1;
        color: white;
    }

    .panel-content .weekday-checkbox:has(input[type="checkbox"]:checked) span {
        color: white;
        font-weight: 600;
    }

    .panel-content .slider-container {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .panel-content .slider-container input[type="range"] {
        flex: 1;
        height: 6px;
        border-radius: 3px;
        background: #e2e8f0;
        outline: none;
        cursor: pointer;
    }

    .panel-content .slider-container input[type="range"]::-webkit-slider-thumb {
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #6366f1;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .panel-content .slider-container input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #6366f1;
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .panel-content .slider-value {
        min-width: 40px;
        text-align: center;
        font-weight: 600;
        color: #374151;
        background: #f9fafb;
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid #e2e8f0;
    }

    .panel-content label {
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 8px;
        display: block;
    }

    .panel-content small {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
        display: block;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
        .timetable-structure-panel {
            width: 100%;
            right: -100%;
        }
        
        .panel-content .form-row {
            grid-template-columns: 1fr;
        }
    }

    .plan-settings.collapsed .plan-settings-content {
        display: none;
    }

    /* Structure Section */

    .structure-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 44px;
        height: 44px;
        padding: 0;
        background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .structure-btn:hover {
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        border-color: #cbd5e1;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .structure-btn svg {
        width: 18px;
        height: 18px;
        stroke: #6366f1;
    }


    .settings-section {
        margin-bottom: 40px;
    }

    .settings-section:last-child {
        margin-bottom: 0;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 2px solid #f1f5f9;
    }

    .section-header h4 {
        font-size: 16px;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .section-icon {
        width: 18px;
        height: 18px;
        stroke: #6366f1;
        flex-shrink: 0;
    }

    .section-badge {
        background: #6366f1;
        color: #fff;
        font-size: 11px;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 12px;
        min-width: 20px;
        text-align: center;
    }

    /* Quick Actions */
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
    }

    .quick-action-card {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 20px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        transition: all 0.2s ease;
    }

    .quick-action-card:hover {
        border-color: #6366f1;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
        transform: translateY(-2px);
    }

    .action-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fff;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
    }

    .action-icon svg {
        width: 24px;
        height: 24px;
        stroke: #6366f1;
    }

    .action-content {
        flex: 1;
    }

    .action-content h5 {
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
        margin: 0 0 4px 0;
    }

    .action-content p {
        font-size: 12px;
        color: #64748b;
        margin: 0;
    }

    /* Presets Section */
    .presets-container {
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        background: #fafafa;
    }

    .presets-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: #fff;
        border-bottom: 1px solid #e2e8f0;
    }

    .presets-info p {
        font-size: 13px;
        color: #64748b;
        margin: 0;
    }

    .preset-actions {
        display: flex;
        gap: 8px;
    }

    .presets-list {
        padding: 16px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    .preset-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-bottom: 8px;
        transition: all 0.2s ease;
    }

    .preset-item:hover {
        border-color: #6366f1;
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
    }

    .preset-color {
        width: 20px;
        height: 20px;
        border-radius: 6px;
        border: 1px solid #d1d5db;
    }

    .preset-info {
        flex: 1;
        min-width: 0;
    }

    .preset-name {
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
        margin: 0 0 2px 0;
    }

    .preset-details {
        font-size: 12px;
        color: #64748b;
        margin: 0;
    }

    .preset-btn {
        width: 28px;
        height: 28px;
        border: none;
        background: #f1f5f9;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all 0.2s ease;
        color: #64748b;
    }

    .preset-btn:hover {
        background: #e2e8f0;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .preset-btn.edit {
        color: #475569;
    }

    .preset-btn.edit:hover {
        background: #dbeafe;
        color: #1e40af;
    }

    .preset-btn.delete {
        color: #64748b;
    }

    .preset-btn.delete:hover {
        background: #fee2e2;
        color: #dc2626;
    }

    /* Preset Container and Edit Panel */
    .preset-container {
        display: flex;
        flex-direction: column;
    }

    .preset-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .preset-edit-panel {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 16px;
        animation: slideDown 0.2s ease;
        width: 100%;
        box-sizing: border-box;
        margin-top: 8px;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .preset-edit-form {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .preset-edit-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    .preset-edit-field {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .preset-edit-field label {
        font-size: 12px;
        font-weight: 500;
        color: #374151;
    }

    .preset-edit-input {
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        background: #fff;
        transition: border-color 0.2s ease;
        width: 100%;
        box-sizing: border-box;
    }

    .preset-edit-input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
    }

    .preset-edit-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 8px;
        padding-top: 12px;
        border-top: 1px solid #e2e8f0;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
        .presets-list {
            padding: 8px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .preset-edit-row {
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .preset-edit-panel {
            padding: 12px;
            margin-top: 8px;
        }
        
        .preset-item {
            padding: 10px;
            gap: 10px;
        }
        
        .preset-edit-actions {
            flex-direction: column;
            gap: 6px;
        }
        
        .preset-edit-actions .btn {
            width: 100%;
        }
        
        .preferences-grid {
            grid-template-columns: 1fr;
            gap: 16px;
        }
        
        .preference-card {
            padding: 16px;
        }
    }

    /* Data Management */
    .data-management-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .data-card {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.2s ease;
    }

    .data-card:hover {
        border-color: #6366f1;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
    }

    .data-card-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }

    .data-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fff;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    .data-icon svg {
        width: 20px;
        height: 20px;
        stroke: #6366f1;
    }

    .data-card-header h5 {
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
        margin: 0;
        flex: 1;
    }

    .data-count {
        background: #6366f1;
        color: #fff;
        font-size: 11px;
        font-weight: 600;
        padding: 4px 8px;
        border-radius: 12px;
        min-width: 20px;
        text-align: center;
    }

    .data-input-container {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
    }

    .data-input-container .plan-setting-input {
        flex: 1;
    }

    .data-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .data-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 6px 10px;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        font-size: 12px;
        color: #475569;
    }

    .data-tag-remove {
        width: 16px;
        height: 16px;
        border: none;
        background: transparent;
        color: #64748b;
        cursor: pointer;
        border-radius: 3px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        transition: all 0.2s ease;
    }

    .data-tag-remove:hover {
        background: #f1f5f9;
        color: #ef4444;
    }

    /* Colors container */
    .colors-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .color-presets {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .color-preset {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .color-preset:hover {
        border-color: #6366f1;
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
    }

    .color-preset.selected {
        border-color: #6366f1;
        background: #eff6ff;
    }

    .color-preset-preview {
        width: 18px;
        height: 18px;
        border-radius: 4px;
        border: 1px solid #d1d5db;
    }

    .color-preset-name {
        font-size: 12px;
        font-weight: 500;
        color: #374151;
    }

    .color-input-container {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .data-input-container .color-input {
        width: 40px;
        height: 40px;
        border-radius: 8px;
    }

    .color-input-container .plan-setting-input {
        flex: 1;
    }

    /* Preferences */
    .preferences-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
    }

    .preference-card {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 24px;
    }

    .preference-header {
        margin-bottom: 20px;
    }

    .preference-header h5 {
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
        margin: 0 0 4px 0;
    }

    .preference-header p {
        font-size: 12px;
        color: #64748b;
        margin: 0;
    }

    .preference-options {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .toggle-option {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .toggle-label {
        position: relative;
        display: inline-block;
        width: 52px;
        height: 30px;
        cursor: pointer;
        flex-shrink: 0;
    }

    .toggle-input {
        opacity: 0;
        width: 0;
        height: 0;
        position: absolute;
    }

    .toggle-slider {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #e5e7eb;
        border-radius: 30px;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .toggle-slider::before {
        content: '';
        position: absolute;
        top: 3px;
        left: 3px;
        width: 20px;
        height: 20px;
        background: #fff;
        border-radius: 50%;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }

    .toggle-input:checked + .toggle-slider {
        background: #6366f1;
        border-color: #4f46e5;
    }

    .toggle-input:checked + .toggle-slider::before {
        transform: translateX(22px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .toggle-input:focus + .toggle-slider {
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .option-content {
        flex: 1;
    }

    .option-title {
        font-size: 13px;
        font-weight: 600;
        color: #1e293b;
        display: block;
        margin-bottom: 2px;
    }

    .option-description {
        font-size: 11px;
        color: #64748b;
    }

    .select-option {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .select-option .option-title {
        margin-bottom: 0;
    }

    .plan-setting-input,
    .plan-setting-select {
        padding: 10px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 14px;
        background: #fff;
        transition: all 0.2s ease;
        width: 100%;
    }

    .plan-setting-input:focus,
    .plan-setting-select:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .plan-setting-hint {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 2px;
    }

    .color-picker {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .color-input {
        width: 40px;
        height: 40px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: border-color 0.2s ease;
    }

    .color-input:hover {
        border-color: #6366f1;
    }

    .color-preview {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        border: 1px solid #d1d5db;
        background: #6366f1;
    }

    .color-name {
        font-size: 13px;
        font-weight: 500;
        color: #6b7280;
        min-width: 60px;
    }

    .toggle-switch {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .toggle-input {
        display: none;
    }

    .toggle-label {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 28px;
        cursor: pointer;
    }

    .toggle-slider {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #d1d5db;
        border-radius: 28px;
        transition: background-color 0.2s ease;
    }

    .toggle-slider::before {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 24px;
        height: 24px;
        background: #fff;
        border-radius: 50%;
        transition: transform 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }


    .toggle-description {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
        line-height: 1.4;
    }

    .plan-settings-actions {
        display: flex;
        gap: 12px;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid #f1f5f9;
    }

    .plan-settings-actions .btn {
        flex: 1;
        padding: 10px 16px;
        font-size: 13px;
    }

    /* Presets styling */
    .presets-container {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: #fafafa;
    }

    .presets-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid #e5e7eb;
        background: #fff;
        border-radius: 8px 8px 0 0;
    }

    .preset-actions {
        display: flex;
        gap: 8px;
    }

    .presets-count {
        font-size: 12px;
        font-weight: 500;
        color: #6b7280;
    }


    .preset-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        margin-bottom: 6px;
        transition: all 0.2s ease;
    }

    .preset-item:hover {
        border-color: #6366f1;
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.1);
    }

    .preset-color {
        width: 16px;
        height: 16px;
        border-radius: 4px;
        border: 1px solid #d1d5db;
    }

    .preset-info {
        flex: 1;
        min-width: 0;
    }

    .preset-name {
        font-size: 13px;
        font-weight: 500;
        color: #1f2937;
        margin: 0;
    }

    .preset-details {
        font-size: 11px;
        color: #6b7280;
        margin: 0;
    }

    .preset-actions {
        display: flex;
        gap: 4px;
    }

    .preset-btn {
        width: 24px;
        height: 24px;
        border: none;
        background: #f1f5f9;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        transition: all 0.2s ease;
        color: #64748b;
    }

    .preset-btn:hover {
        background: #e2e8f0;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .preset-btn.edit {
        color: #475569;
    }

    .preset-btn.edit:hover {
        background: #dbeafe;
        color: #1e40af;
    }

    .preset-btn.delete {
        color: #64748b;
    }

    .preset-btn.delete:hover {
        background: #fee2e2;
        color: #dc2626;
    }

    /* Data input styling */
    .data-input-container {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
    }

    .data-input-container .plan-setting-input {
        flex: 1;
    }

    .data-list {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 8px;
    }

    .data-tag {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 8px;
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        font-size: 11px;
        color: #475569;
    }

    .data-tag-remove {
        width: 14px;
        height: 14px;
        border: none;
        background: transparent;
        color: #64748b;
        cursor: pointer;
        border-radius: 2px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        transition: all 0.2s ease;
    }

    .data-tag-remove:hover {
        background: #e2e8f0;
        color: #ef4444;
    }

    /* Colors container */
    .colors-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .color-presets {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .color-preset {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .color-preset:hover {
        border-color: #6366f1;
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.1);
    }

    .color-preset.selected {
        border-color: #6366f1;
        background: #eff6ff;
    }

    .color-preset-preview {
        width: 16px;
        height: 16px;
        border-radius: 4px;
        border: 1px solid #d1d5db;
    }

    .color-preset-name {
        font-size: 12px;
        font-weight: 500;
        color: #374151;
    }

    .color-input-container {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .data-input-container .color-input {
        width: 36px;
        height: 36px;
        border-radius: 6px;
    }

    .color-input-container .plan-setting-input {
        flex: 1;
    }

    /* Responsive design */
    @media (max-width: 1024px) {
        .plan-settings {
            padding: 16px;
        }
        
        .plan-settings-grid {
            gap: 12px;
        }
    }

    /* Analysis page styling */
    .analysis-page {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }

    .analysis-header {
        margin-bottom: 32px;
        text-align: center;
    }

    .analysis-header h2 {
        margin: 0 0 8px 0;
        font-size: 28px;
        font-weight: 700;
        color: #1e293b;
    }

    .analysis-header p {
        margin: 0;
        color: #64748b;
        font-size: 16px;
    }

    .analysis-content {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;;
    }

    .stat-card {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 24px;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .stat-number {
        font-size: 32px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 8px;
    }

    .stat-label {
        font-size: 14px;
        color: #64748b;
        font-weight: 500;
    }

    .charts-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 20px;
    }

    .chart-container {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .chart-container h3 {
        margin: 0 0 16px 0;
        font-size: 18px;
        font-weight: 600;
        color: #374151;
        text-align: center;
    }

    .chart-container .chart {
        height: 200px;
        width: 100%;
    }

    /* Settings form styling */
    .settings-form {
        display: flex;
        flex-direction: column;
        gap: 16px;;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;;
    }

    .form-group label {
        font-weight: 500;
        color: #374151;
        font-size: 14px;
    }

    .form-group input {
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.2s;
    }

    .form-group input:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .form-group small {
        color: #6b7280;
        font-size: 12px;
    }

    .settings-footer {
        margin-top: 24px;
        text-align: center;
    }

    .auto-save-notice {
        display: inline-flex;
        align-items: center;
        gap: 8px;;
        padding: 8px 16px;
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 8px;
        color: #0369a1;
        font-size: 14px;
    }

    .save-icon {
        color: #059669;
        font-weight: bold;
    }

    /* Toggle switches */
    .settings-toggles {
        display: flex;
        flex-direction: column;
        gap: 16px;;
    }

    .toggle-group {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #f3f4f6;
    }

    .toggle-group:last-child {
        border-bottom: none;
    }

    .toggle-label {
        display: flex;
        align-items: center;
        gap: 8px;;
        cursor: pointer;
        flex: 1;
    }

    .toggle-text {
        font-weight: 500;
        color: #374151;
        font-size: 14px;
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 24px;
        cursor: pointer;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #d1d5db;
        transition: 0.3s;
        border-radius: 24px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-switch input:checked + .toggle-slider {
        background-color: #6366f1;
    }

    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(24px);
    }

    .toggle-switch input:focus + .toggle-slider {
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    /* Settings actions */
    .settings-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;;
    }

    .settings-actions .btn {
        padding: 12px 16px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .settings-actions .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* Settings-based visual effects */
    .compact-view .chart-container {
        padding: 12px;
    }

    .compact-view .stat-card {
        padding: 12px;
    }

    .compact-view .toggle-group {
        padding: 8px 0;
    }

    .compact-view .form-group {
        gap: 2px;
    }

    .no-animations * {
        transition: none !important;
        animation: none !important;
    }

    .performance-mode .chart-container {
        box-shadow: none;
    }

    .performance-mode .stat-card {
        box-shadow: none;
    }

    .performance-mode .toggle-slider {
        transition: none;
    }

    .performance-mode .toggle-slider:before {
        transition: none;
    }

    /* Analysis page styling */
    .analysis-page {
        padding: 24px 0;
    }

    .analysis-header {
        text-align: center;
        margin-bottom: 32px;
    }

    .analysis-header h2 {
        margin: 0 0 8px 0;
        font-size: 28px;
        font-weight: 700;
        color: #111827;
    }

    .analysis-header p {
        margin: 0;
        color: #6b7280;
        font-size: 16px;
    }

    .analysis-content {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;;
        margin-bottom: 24px;
    }

    .stat-card {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .stat-number {
        font-size: 32px;
        font-weight: 700;
        color: #111827;
        margin-bottom: 8px;
    }

    .stat-label {
        font-size: 14px;
        color: #6b7280;
        font-weight: 500;
    }

    .charts-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 24px;
    }

    /* Info tooltip styling */
    .info-tooltip {
        position: relative;
        display: inline-block;
        margin-left: 8px;
    }

    .info-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        background: #e2e8f0;
        color: #64748b;
        border-radius: 50%;
        font-size: 10px;
        font-weight: 600;
        cursor: help;
        transition: all 0.2s ease;
    }

    .info-icon:hover {
        background: #6366f1;
        color: white;
    }

    .info-tooltip .tooltip-text {
        visibility: hidden;
        width: 200px;
        background: #1e293b;
        color: white;
        text-align: left;
        border-radius: 8px;
        padding: 8px 12px;
        position: absolute;
        z-index: 1000;
        bottom: 125%;
        left: 50%;
        margin-left: -100px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 12px;
        line-height: 1.4;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .info-tooltip .tooltip-text::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        margin-left: -5px;
        border-width: 5px;
        border-style: solid;
        border-color: #1e293b transparent transparent transparent;
    }

    .info-tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
    }

    /* Touch-friendly interactions */
    .btn, .pill, .chip, .lesson, .grid .cell {
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
    }
    
    /* Prevent text selection on interactive elements */
    .btn, .pill, .chip, .lesson, .grid .cell, .nav-island {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
    
    /* Prevent text cursor and caret globally */
    * {
        caret-color: transparent;
    }
    
    *:focus {
        outline: none;
    }
    
    /* Smooth scrolling for mobile */
    html {
        scroll-behavior: smooth;
        -webkit-text-size-adjust: 100%;
    }
    
    /* Mobile-first responsive design */
    @media (max-width: 768px) {
        /* Global mobile adjustments */
        .container {
            padding: 12px;
        }
        
        /* Header mobile */
        .header {
            padding: 12px 16px;
        }
        
        .header h1 {
            font-size: 20px;
        }
        
        /* Navigation mobile - using desktop styles */
        
        .pill-slider {
            width: 46px;
            height: 46px;
            top: 10px;
        }
        
        /* Mobile pill styles removed - using desktop styles */

        .nav-icon {
            width: 20px;
            height: 20px;
        }
        
         /* Overview mobile */
         .ov-main-grid {
             grid-template-columns: 1fr;
             gap: 20px;
             margin-bottom: 20px;
         }
         
         .ov-secondary-content {
             order: -1;
         }
         
         .ov-heatmap-today {
             grid-template-columns: 1fr;
             gap: 16px;
             margin-bottom: 20px;
         }
         
         /* Weekly Plan mobile improvements */
         .ov-section {
             margin-bottom: 24px;
         }
         
         .ov-section-header {
             margin-bottom: 16px;
         }
         
         .ov-section-title {
             font-size: 18px;
         }
         
         /* Chart cards mobile optimization */
         .chart-card, .list-card {
             min-height: 250px;
             padding: 16px;
         }
         
         /* Heute card should size to content when empty on mobile */
         .list-card:has(.small) {
             min-height: auto;
         }
         
         .chart-title {
             font-size: 16px;
             margin-bottom: 12px;
         }
         
         /* Week navigation mobile */
         .week-nav-container {
             flex-direction: row;
             gap: 8px;
             align-items: center;
             justify-content: flex-end;
             flex-wrap: nowrap;
         }
         
         .week-nav {
             display: flex;
             align-items: center;
             gap: 6px;
             flex-shrink: 0;
         }
         
         .current-week-btn {
             flex-shrink: 0;
             padding: 6px 10px;
             font-size: 11px;
             white-space: nowrap;
         }
         
         /* Ensure week display text doesn't wrap */
         #weekDisplay {
             white-space: nowrap;
             font-size: 12px;
         }
         
         /* Make navigation buttons smaller on mobile */
         .week-nav .btn.mini {
             padding: 4px 8px;
             font-size: 11px;
             min-width: 28px;
             min-height: 28px;
         }
         
         .ov-statistics {
             grid-template-columns: repeat(4, 1fr);
             gap: 8px;
             padding: 12px;
         }
         
         .ov-section-title {
             font-size: 18px;
         }
         
         /* Mobile-specific overview improvements */
         .ov-section {
             margin-bottom: 24px;
         }
         
         .ov-section-header {
             margin-bottom: 12px;
         }
         
         /* Next Up card mobile optimization */
         .next-up-card {
             padding: 16px;
         }
         
         .next-up-header {
             margin-bottom: 12px;
         }
         
         .next-up-icon {
             width: 36px;
             height: 36px;
         }
         
         .next-up-icon svg {
             width: 18px;
             height: 18px;
         }
         
         .next-up-title {
             font-size: 16px;
         }
         
         .next-up-subtitle {
             font-size: 12px;
         }
         
         /* Chart cards mobile */
         .chart-card {
             padding: 16px;
         }
         
         .chart-title {
             font-size: 16px;
             margin-bottom: 12px;
         }
         
         /* Timer mobile optimization */
         .timer-card.big.square {
             padding: 20px;
         }
         
         .timer-face.xl {
             font-size: 48px;
         }
         
         .btn-row {
             gap: 12px;
             margin-top: 16px;
         }
         
         /* KPI cards mobile - single row */
         .kpi {
             padding: 8px;
             text-align: center;
         }
         
         .kpi .label {
             font-size: 10px;
             margin-bottom: 4px;
             line-height: 1.2;
         }
         
         .kpi .value {
             font-size: 18px;
             margin-bottom: 2px;
             font-weight: 700;
         }
         
         .kpi .meta {
             font-size: 9px;
             line-height: 1.2;
         }
         
         /* Activity list mobile */
         .activity-list {
             gap: 10px;
             padding: 6px 0;
         }
         
         .activity-item {
             padding: 10px;
             min-width: 120px;
         }
         
         .activity-icon {
             width: 28px;
             height: 28px;
         }
         
         .activity-icon svg {
             width: 14px;
             height: 14px;
         }
         
         .activity-title {
             font-size: 12px;
         }
         
         .activity-description {
             font-size: 10px;
         }
         
         .activity-time {
             font-size: 9px;
         }
         
         .activity-content h4 {
             font-size: 14px;
         }
         
         .activity-content p {
             font-size: 12px;
         }
         
         /* Week navigation mobile */
         .week-nav-container {
             flex-direction: row;
             gap: 8px;
             align-items: center;
             justify-content: flex-end;
         }
         
         .week-nav {
             justify-content: center;
         }
         
        .current-week-btn {
            flex-shrink: 0;
            justify-content: center;
        }
         
         /* Info tooltips mobile */
         .info-tooltip {
             position: relative;
         }
         
         .info-tooltip .tooltip-text {
             display: none;
         }
         
         .info-tooltip:hover .tooltip-text {
             display: block;
             position: absolute;
             top: 100%;
             left: 0;
             background: rgba(0, 0, 0, 0.8);
             color: white;
             padding: 8px;
             border-radius: 4px;
             font-size: 12px;
             white-space: nowrap;
             z-index: 1000;
         }
         
         /* Button adjustments mobile */
         .btn.mini {
             padding: 8px 12px;
             font-size: 12px;
         }
         
         /* Card hover effects disabled on mobile */
         .chart-card:hover,
         .kpi:hover,
         .timer-card:hover {
             transform: none;
             box-shadow: inherit;
         }
         
         /* Touch-friendly sizing */
         .btn {
             min-height: 44px;
             min-width: 44px;
         }
         
         /* Improved spacing for mobile */
         .container {
             padding: 12px;
         }
         
         /* Mobile-specific font adjustments */
         h1 {
             font-size: 18px;
         }
         
         h2 {
             font-size: 16px;
         }
         
         h3 {
             font-size: 15px;
         }
         
         /* Improved readability */
         .meta {
             font-size: 12px;
             line-height: 1.4;
         }
         
         /* Better contrast for mobile */
         .kpi .value {
             color: #1f2937;
             font-weight: 700;
         }
         
         /* Mobile-specific layout improvements */
         .ov-primary-content,
         .ov-secondary-content {
             gap: 20px;
         }
         
         /* Heatmap mobile optimization */
         #heatmap {
             min-height: 200px;
             width: 100%;
             max-width: 100%;
         }
         
         /* Chart wrap responsive improvements */
         .chart-wrap {
             width: 100%;
         }
         
         /* Ensure heatmap scales properly on all devices */
         .chart-card #heatmap {
             width: 100%;
             height: auto;
             min-height: 200px;
             max-width: 100%;
         }
         
         /* Fix heatmap card mobile layout */
         .chart-card {
             width: 100%;
             max-width: 100%;
         }
         
         /* Prevent heatmap elements from stacking */
         .ov-heatmap-today .chart-card {
             margin-bottom: 16px;
         }
         
         /* Ensure proper spacing between heatmap and today sections */
         .ov-heatmap-today > * {
             margin-bottom: 16px;
         }
         
         .ov-heatmap-today > *:last-child {
             margin-bottom: 0;
         }
         
         /* Timer section mobile layout */
         .ov-timer-section {
             padding: 16px;
         }
         
         /* Statistics mobile layout */
         .ov-statistics {
             margin-top: 16px;
         }
         
         /* Activity section mobile */
         .activity-list {
             overflow-x: auto;
             -webkit-overflow-scrolling: touch;
         }
         
         /* Next Up section mobile */
         .ov-next-up-section {
             margin-bottom: 24px;
         }
         
         /* Next Up inside Heute card mobile */
         .next-up-in-heute {
             margin-top: 12px;
             padding-top: 12px;
         }
         
         .next-up-content-heute {
             gap: 10px;
         }
         
         .next-up-icon-small {
             width: 28px;
             height: 28px;
         }
         
         .next-up-icon-small svg {
             width: 14px;
             height: 14px;
         }
         
         .next-up-title-heute {
             font-size: 13px;
         }
         
         .next-up-subtitle-heute {
             font-size: 11px;
         }
         
        .next-up-card {
            padding: 14px;
            max-width: 100%;
        }
         
         .next-up-header {
             gap: 12px;
             margin-bottom: 12px;
         }
         
         .next-up-icon {
             width: 36px;
             height: 36px;
         }
         
         .next-up-icon svg {
             width: 18px;
             height: 18px;
         }
         
         .next-up-title {
             font-size: 18px;
         }
         
         .next-up-subtitle {
             font-size: 13px;
         }
         
        .next-up-actions .btn {
            padding: 8px 16px;
            font-size: 13px;
            cursor: pointer;
        }
         
         /* Quick stats mobile */
         .quick-stats-row {
             grid-template-columns: repeat(4, 1fr);
             gap: 8px;
             margin-bottom: 24px;
         }
         
         .stat-card {
             padding: 16px;
             flex-direction: column;
             text-align: center;
             gap: 12px;
         }
         
         .stat-icon {
             width: 40px;
             height: 40px;
         }
         
         .stat-icon svg {
             width: 20px;
             height: 20px;
         }
         
         .stat-number {
             font-size: 20px;
         }
         
         .stat-label {
             font-size: 12px;
         }
         
         /* Activity list mobile */
         .activity-item {
             padding: 12px;
             gap: 12px;
         }
         
         .activity-icon {
             width: 36px;
             height: 36px;
         }
         
         .activity-icon svg {
             width: 18px;
             height: 18px;
         }
         
         .activity-title {
             font-size: 14px;
         }
         
         .activity-description {
             font-size: 13px;
         }
         
         /* Quick actions mobile */
         .quick-actions-grid {
             grid-template-columns: 1fr;
             gap: 8px;
         }
         
         .quick-action-btn {
             padding: 16px 12px;
             gap: 8px;
         }
         
         .action-icon {
             width: 36px;
             height: 36px;
         }
         
         .action-icon svg {
             width: 18px;
             height: 18px;
         }
         
         .action-text {
             font-size: 13px;
         }
        
        /* Timer mobile */
        .timer-card.big.square {
            justify-self: center;
            max-width: 280px;
            padding: 20px;
        }
        
        .timer-face.xl {
            font-size: 32px;
        }
        
        .btn-row {
            flex-direction: column;
            gap: 8px;;
        }
        
        /* Plan mobile */
        .plan-week-nav-container {
            flex-direction: column;
            gap: 8px;;
        }
        
        .plan-week-settings {
            justify-content: center;
        }
        
        .daily-hours-setting {
            padding: 8px 12px;
        }
        
        .daily-hours-setting label {
            font-size: 13px;
        }
        
        .daily-hours-setting input {
            width: 60px;
            padding: 6px 8px;
            font-size: 13px;
        }
        
        .add-row-section {
            padding: 12px;
        }
        
        .add-row-btn {
            padding: 12px 24px;
            font-size: 13px;
            width: 100%;
            max-width: 280px;
        }
        
        .plan-week-nav-content {
            flex-direction: column;
            gap: 8px;;
            padding: 12px;
        }
        
        .plan-week-nav-content span {
            font-size: 14px;
            min-width: auto;
        }
        
        .grid {
            font-size: 12px;
        }
        
        .grid .head {
            padding: 8px 4px;
            font-size: 11px;
        }
        
        .grid .time-cell {
            padding: 4px;
            min-width: 70px;
            width: 70px;
            font-size: 12px;
        }
        
        .lesson {
            font-size: 10px;
            padding: 4px 6px;
            min-height: 32px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .lesson .subject {
            font-weight: 600;
            line-height: 1.2;
        }
        
        .lesson .meta {
            font-size: 9px;
            opacity: 0.8;
            margin-top: 2px;
        }
        
        .legend {
            flex-direction: column;
            gap: 8px;;
            padding: 12px;
        }
        
        .legend .chip {
            font-size: 11px;
            padding: 6px 8px;
        }
        
        /* Analysis mobile */
        .analysis-page {
            padding: 12px;
        }
        
        .analysis-header h2 {
            font-size: 24px;
        }
        
        .stats-row {
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;;
        }
        
        .stat-card {
            padding: 16px;
        }
        
        .stat-number {
            font-size: 24px;
        }
        
        .stat-label {
            font-size: 12px;
        }
        
        .charts-row {
            grid-template-columns: 1fr;
            gap: 16px;;
        }
        
        .chart-container {
            padding: 16px;
        }
        
        .chart-container h3 {
            font-size: 16px;
        }
        
        .chart-container .chart {
            height: 150px;
        }
        
        /* Settings mobile improvements */
        .stats-row {
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;;
        }
        
        .stat-card {
            padding: 16px;
        }
        
        .stat-number {
            font-size: 24px;
        }
        
        .charts-row {
            grid-template-columns: 1fr;
            gap: 16px;;
        }
        
        .form-row {
            grid-template-columns: 1fr;
            gap: 12px;;
        }
        
        .toggle-group {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;;
            padding: 16px 0;
        }
        
        .toggle-label {
            width: 100%;
        }
        
        .settings-actions {
            grid-template-columns: 1fr;
            gap: 8px;;
        }
        
        /* Chart and heatmap mobile improvements */
        .chart-card, .list-card {
            padding: 12px;
        }
        
        .chart-title {
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        
        /* Heatmap mobile specific */
        #heatmap {
            min-height: 200px;
        }
        
        /* KPI cards mobile */
        .kpi {
            padding: 16px;
            text-align: center;
        }
        
        .kpi .label {
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .kpi .value {
            font-size: 24px;
            font-weight: 700;
        }
        
        .kpi .meta {
            font-size: 11px;
            margin-top: 4px;
        }
        
        /* Folders mobile */
        .folders-header {
            flex-direction: column;
            gap: 16px;;
            text-align: center;
        }
        
        .folders-actions {
            flex-direction: column;
            gap: 8px;;
        }
        
        .upload-section {
            padding: 16px;
        }
        
        .dropzone {
            padding: 24px 16px;
        }
        
        .folders-grid {
            grid-template-columns: 1fr;
            gap: 12px;;
        }
        
        .folder-card {
            padding: 16px;
        }
        
        /* Settings mobile */
        .settings-page {
            padding: 12px;
        }
        
        .settings-header h2 {
            font-size: 24px;
        }
        
        .settings-row {
            grid-template-columns: 1fr;
            gap: 12px;;
        }
        
        .settings-card {
            padding: 16px;
        }
        
        .settings-card-title {
            font-size: 16px;
        }
        
        .settings-field {
            margin-bottom: 16px;
        }
        
        .settings-field label {
            font-size: 13px;
        }
        
        .settings-field input {
            font-size: 16px; /* Prevents zoom on iOS */
            padding: 12px;
        }
        
        /* Full-width settings mobile */
        .settings-info-section .settings-info {
            grid-template-columns: 1fr;
            gap: 12px;
        }
        
        .settings-data-section .settings-actions {
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        /* Modals mobile */
        .modal {
            margin: 20px;
            max-width: calc(100vw - 40px);
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }
        
        .modal-header h2 {
            font-size: 18px;
        }
        
        .modal-content {
            padding: 16px;
        }
        
        .actions {
            flex-direction: column;
            gap: 8px;;
        }
        
        .actions .btn {
            width: 100%;
            min-height: 44px; /* iOS touch target */
        }
        
        /* Form improvements for mobile */
        .field input, .field select, .field textarea {
            min-height: 44px; /* iOS touch target */
            font-size: 16px; /* Prevents zoom on iOS */
            border-radius: 8px;
        }
        
        .accordion summary {
            min-height: 44px;
            display: flex;
            align-items: center;
        }
        
        .accordion .row button {
            min-height: 44px;
        }
        
        /* Info tooltips mobile */
        .info-tooltip .tooltip-text {
            width: 160px;
            font-size: 11px;
            padding: 6px 8px;
        }
        
        /* Week navigation mobile */
        .week-nav-container {
            flex-direction: row;
            gap: 8px;;
            align-items: center;
            justify-content: flex-end;
        }
        
        .week-nav {
            flex-direction: row;
            gap: 6px;;
            padding: 6px 8px;
        }
        
        .week-nav span {
            font-size: 12px;
            min-width: auto;
        }
        
        .week-nav .btn.mini {
            width: 32px;
            height: 32px;
        }
        
        .current-week-btn {
            align-self: center;
            min-width: 70px !important;
            height: 36px !important;
            font-size: 13px !important;
            padding: 8px 12px !important;
        }
        
        /* Drag and drop mobile improvements */
        .grid .cell {
            min-height: 40px;
            position: relative;
        }
        
        .grid .cell:hover::after {
            content: '+';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            color: #94a3b8;
            pointer-events: none;
        }
        
        .grid .cell:active {
            background: #f1f5f9;
        }
        
        /* Mobile-specific grid improvements */
        .grid {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .grid-wrap {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Hero section mobile */
        .ov-hero-inline {
            margin: 8px 0 16px;
        }
        
        .hero-compact {
            padding: 12px;
        }
        
        .hc-title {
            font-size: 14px;
        }
        
        .hc-meta {
            font-size: 12px;
        }
    }
    
    @media (max-width: 480px) {
        /* Extra small mobile adjustments */
        .container {
            padding: 8px;
        }
        
        /* Extra small mobile nav-island styles removed - using desktop styles */

        .nav-icon {
            width: 18px;
            height: 18px;
        }
        
        /* Extra small mobile heatmap fixes */
        .ov-heatmap-today {
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .chart-card {
            padding: 12px;
            min-height: 180px;
        }
        
        /* Heute card should size to content when empty on small mobile */
        .list-card:has(.small) {
            min-height: auto;
        }
        
        #heatmap {
            min-height: 180px;
        }
        
        .chart-card #heatmap {
            min-height: 180px;
        }
        
        .stats-row {
            grid-template-columns: 1fr;
        }
        
        .stat-card {
            padding: 12px;
        }
        
        .stat-number {
            font-size: 20px;
        }
        
        .chart-container .chart {
            height: 120px;
        }
        
        .modal {
            margin: 10px;
            max-width: calc(100vw - 20px);
        }
        
        .info-tooltip .tooltip-text {
            width: 140px;
            font-size: 10px;
        }
    }

    .preset-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }

    .preset-table th,
    .preset-table td {
        border-bottom: 1px solid var(--border);
        padding: 6px 8px;
        text-align: left;
    }

    .preset-row-actions {
        display: flex;
        gap: 6px;
    }

    .inline-input {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #fff;
        font-size: 14px;
    }

    .inline-color {
        width: 42px;
        height: 32px;
        border: 1px solid var(--border);
        border-radius: 8px;
    }

    /* Hero: kompakte Liste */
    .hero-sub ul {
        margin: 6px 0 0;
        padding-left: 16px;
    }

    .hero-sub li {
        margin: 2px 0;
    }

    /* Klickbarer Ordner mit Farbswatch (Square) */
    .folder-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: #0f172a;
        color: #fff;
        border-radius: 8px;
        padding: 4px 8px;
        font-size: 12px;
        line-height: 1;
        cursor: pointer;
    }

    .folder-chip .swatch {
        width: 12px;
        height: 12px;
        border-radius: 3px;
        background: var(--col, #e2e8f0);
    }

    /* Container-Abstand über dem Grid */
    .ov-hero-inline {
        margin: 10px 0 14px;
    }

    /* Kompakte Card – nicht breit */
    .hero-compact {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: 16px;;
        padding: 12px 14px;
        border-radius: 14px;
        background: #fff;
        /* kein Verlauf mehr */
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        width: min(560px, 100%);
        /* kompakt! */
        margin: 0 auto;
        /* horizontal zentrieren */
    }

    .hc-title {
        font-weight: 800;
        font-size: 18px;
        margin: 0 0 4px 0;
    }

    .hc-meta {
        font-size: 13px;
        color: var(--muted);
    }

    /* Quadratischer Ordner-Button rechts */
    .folder-tile {
        width: 56px;
        height: 56px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #fff;
        display: grid;
        place-items: center;
        cursor: pointer;
        transition: transform .15s ease;
    }

    .folder-tile:hover {
        transform: scale(1.04);
    }

    .folder-tile .swatch {
        width: 30px;
        height: 20px;
        border-radius: 6px;
        background: var(--col, #e5e7eb);
        position: relative;
    }

    .folder-tile .swatch::after {
        content: "";
        position: absolute;
        left: 4px;
        top: -6px;
        width: 12px;
        height: 6px;
        border-radius: 4px 4px 0 0;
        background: rgba(0, 0, 0, .16);
    }

    /* hide the big time in the hero */
    #ovHeroClock {
        display: none;
    }
    
    /* Icon sizing */
    .ico {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
    }
    
    .ico svg {
        width: 100%;
        height: 100%;
    }
</style>
</head>

<body>
    <header class="sticky">
        <div class="container">
            <div class="hstack">
                <h1>stunova.</h1>
                <div class="header-timer">
                    <div class="timer-card compact" id="pomCard">
                        <div id="pomFace" class="timer-face">
                            <span class="timer-display">25:00</span>
                            <button class="btn mini danger reset-inside" id="pomReset" aria-label="Reset">
                                <span class="ico" aria-hidden="true">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12 6V3L8 7l4 4V8a6 6 0 11-6 6H4a8 8 0 108-8z" />
                                    </svg>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="container" id="currentWrap"></div>
    </header>

    <!-- Navigation pills - separate from header for mobile positioning -->
    <div class="nav-container">
        <div class="container" style="display:flex;justify-content:center">
            <div class="nav-island" role="tablist">
                <div class="pill-slider"></div>
                <button class="pill" id="navOverview" role="tab" aria-selected="false" title="Overview">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                </button>
                <button class="pill" id="navPlan" role="tab" aria-selected="false" title="Plan">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                        <line x1="8" y1="14" x2="16" y2="14"></line>
                        <line x1="8" y1="18" x2="16" y2="18"></line>
                    </svg>
                </button>
                <button class="pill" id="navAnalysis" role="tab" aria-selected="false" title="Analysis">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 20V10"></path>
                        <path d="M12 20V4"></path>
                        <path d="M6 20v-6"></path>
                    </svg>
                </button>
                <button class="pill" id="navFolders" role="tab" aria-selected="false" title="Ordner">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                    </svg>
                </button>
                <button class="pill" id="navSettings" role="tab" aria-selected="false" title="Settings">
                    <svg class="nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <main class="page-container">
        <!-- OVERVIEW Seite -->
        <div class="container" id="pageOverview" hidden>
            <!-- Next Up Section -->
            <div class="ov-next-up-section">
                <div class="next-up-card" id="nextUpCard">
                    <div class="next-up-header">
                        <div class="next-up-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12,6 12,12 16,14"></polyline>
                            </svg>
                        </div>
                        <div class="next-up-content">
                            <div class="next-up-title" id="nextUpTitle" data-i18n="nextUp">Next Up</div>
                            <div class="next-up-subtitle" id="nextUpSubtitle" data-i18n="noLessonsPlanned">No lessons planned</div>
                        </div>
                    </div>
                    <div class="next-up-actions">
                        <button class="btn primary" onclick="slideToPage('pagePlan'); activatePill(byId('navPlan')); updatePlanSettingsForCurrentWeek();">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Stunde hinzufügen
                        </button>
                    </div>
                </div>
            </div>


            <!-- Schedule overview section -->
            <section class="ov-section">
                <div class="ov-section-header">
                    <h2 class="ov-section-title" data-i18n="weeklyPlan">Weekly Plan
                        <div class="info-tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltip-text" data-i18n="heatmapTooltip">Shows your lesson distribution as heatmap. Red line = current time. Green areas = already past lessons.</span>
                        </div>
                    </h2>
                </div>
                <div class="ov-heatmap-today">
                    <div class="chart-card clickable" id="heatmapCard" title="Zum Plan">
                        <div class="chart-title">
                            <div class="week-nav-container">
                                <div class="week-nav">
                                    <button class="btn mini" id="weekBack" title="Vorherige Woche">‹</button>
                                    <span id="weekDisplay">KW XX</span>
                                    <button class="btn mini" id="weekForward" title="Nächste Woche">›</button>
                                </div>
                                <button class="btn mini current-week-btn" id="goToCurrentWeek" title="Zur aktuellen Woche">Heute</button>
                            </div>
                        </div>
                        <div id="heatmap" class="chart-wrap"></div>
                    </div>
                    <div class="list-card clickable" id="todayCard" title="Zum Plan">
                        <div class="chart-title">Heute
                            <div class="info-tooltip">
                                <span class="info-icon">i</span>
                                <span class="tooltip-text">Zeigt alle Stunden von heute. Grüne Markierung = bereits vergangene Stunden.</span>
                            </div>
                        </div>
                        <div id="listToday" class="mini-list"></div>
                        <!-- Next Up Section inside Heute card -->
                        <div class="next-up-in-heute" id="nextUpInHeute" style="display: none;">
                            <div class="next-up-divider"></div>
                            <div class="next-up-content-heute">
                                <div class="next-up-icon-small">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12,6 12,12 16,14"></polyline>
                                    </svg>
                                </div>
                                <div class="next-up-text-heute">
                                    <div class="next-up-title-heute" id="nextUpTitleHeute" data-i18n="nextUp">Next Up</div>
                                    <div class="next-up-subtitle-heute" id="nextUpSubtitleHeute" data-i18n="noLessonsPlanned">No lessons planned</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Recent Activity Section -->
            <section class="ov-section">
                <div class="ov-section-header">
                    <h2 class="ov-section-title">Letzte Aktivitäten</h2>
                </div>
                <div class="activity-list" id="recentActivity">
                    <div class="activity-item">
                        <div class="activity-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14,2 14,8 20,8"></polyline>
                            </svg>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Willkommen bei stunova!</div>
                            <div class="activity-description">Erstelle deinen ersten Stundenplan oder lade Daten aus einer Datei hoch.</div>
                            <div class="activity-time">Gerade eben</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Statistics section -->
            <section class="ov-section">
                <div class="ov-section-header">
                    <h2 class="ov-section-title">Detaillierte Statistiken</h2>
                </div>
                <div class="ov-statistics">
                    <div class="kpi clickable" id="kpiWeekBox" title="Zum Plan">
                        <div class="label">Stunden diese Woche
                            <div class="info-tooltip">
                                <span class="info-icon">i</span>
                                <span class="tooltip-text">Anzahl der geplanten Stunden in der aktuell angezeigten Woche.</span>
                            </div>
                        </div>
                        <div id="kpiWeekLessons" class="value">–</div>
                        <div class="meta" id="kpiWeekMinutes">–</div>
                    </div>
                    <div class="kpi clickable" id="kpiFreeBox" title="Zum Plan">
                        <div class="label">Freie Blöcke heute
                            <div class="info-tooltip">
                                <span class="info-icon">i</span>
                                <span class="tooltip-text">Verfügbare Zeitblöcke ohne geplante Stunden für heute.</span>
                            </div>
                        </div>
                        <div id="kpiFreeToday" class="value">–</div>
                        <div class="meta" id="kpiBusyToday">–</div>
                    </div>
                    <div class="kpi clickable" id="kpiSubjectsBox" title="Zum Plan">
                        <div class="label">Fächer insgesamt
                            <div class="info-tooltip">
                                <span class="info-icon">i</span>
                                <span class="tooltip-text">Anzahl der verschiedenen Fächer in deinem Stundenplan.</span>
                            </div>
                        </div>
                        <div id="kpiSubjects" class="value">–</div>
                        <div class="meta"><span id="kpiFolders" class="badge clickable" title="Zu Ordnern">Ordner: –</span></div>
                    </div>
                </div>
            </section>
        </div>

        <!-- PLAN + rechte Datenleiste -->
        <div class="container" id="pagePlan" hidden>
            <div class="layout">
                <div>
                    <!-- Plan week navigation -->
                    <div class="plan-week-nav">
                        <button class="btn mini current-week-btn" id="goToCurrentPlanWeek" title="Zur aktuellen Woche">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                <polyline points="9,22 9,12 15,12 15,22"/>
                            </svg>
                        </button>
                        <div class="plan-week-nav-container">
                            <div class="plan-week-nav-content">
                                <button class="btn mini" id="planWeekBack" title="Vorherige Woche">◀</button>
                                <span id="planWeekDisplay">KW XX</span>
                                <button class="btn mini" id="planWeekForward" title="Nächste Woche">▶</button>
                            </div>
                        </div>
                        <button class="btn secondary structure-btn" onclick="toggleTimetableStructurePanel()" title="Timetable Structure">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3h18v18H3zM9 9h6v6H9z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="plan-main">
                        <div class="card grid-wrap">
                            <div id="grid" class="grid"></div>
                        </div>
                    </div>
                    
                    <!-- Plan creation settings -->
                    <div class="plan-settings">
                        <div class="plan-settings-header" onclick="togglePlanSettings()">
                            <div class="header-content">
                                <h3 data-i18n="planSettings">Plan Settings</h3>
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text" data-i18n="planSettingsTooltip">Detailed settings for plan creation. All values are automatically saved.</span>
                                </div>
                            </div>
                            <div class="header-actions">
                                <svg class="settings-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"/>
                                </svg>
                            </div>
                        </div>
                        
                        <div class="plan-settings-content">
                            <!-- Quick Actions -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <h4>
                                        <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                                        </svg>
                                        Schnellzugriff
                                    </h4>
                                    <span class="section-badge">3</span>
                                </div>
                                <div class="quick-actions">
                                    <div class="quick-action-card">
                                        <div class="action-icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                                            </svg>
                                        </div>
                                        <div class="action-content">
                                            <h5>Fächer verwalten</h5>
                                            <p>Fächer hinzufügen und bearbeiten</p>
                                        </div>
                                        <button class="btn mini primary" onclick="focusInput('subjectsInput')">Bearbeiten</button>
                                    </div>
                                    <div class="quick-action-card">
                                        <div class="action-icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                                <circle cx="12" cy="7" r="4"/>
                                            </svg>
                                        </div>
                                        <div class="action-content">
                                            <h5 data-i18n="manageTeachers">Manage Teachers</h5>
                                            <p data-i18n="addEditTeachers">Add and edit teachers</p>
                                        </div>
                                        <button class="btn mini primary" onclick="focusInput('teachersInput')" data-i18n="editLabel">Edit</button>
                                    </div>
                                    <div class="quick-action-card">
                                        <div class="action-icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                                <polyline points="9,22 9,12 15,12 15,22"/>
                                            </svg>
                                        </div>
                                        <div class="action-content">
                                            <h5>Räume verwalten</h5>
                                            <p>Räume hinzufügen und bearbeiten</p>
                                        </div>
                                        <button class="btn mini primary" onclick="focusInput('roomsInput')">Bearbeiten</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Presets Section -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <h4>
                                        <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                        </svg>
                                        Stunden-Presets
                                    </h4>
                                    <span class="section-badge" id="presetsCount">0</span>
                                </div>
                                <div class="presets-container">
                                    <div class="presets-header">
                                        <div class="presets-info">
                                            <p>Vordefinierte Stundenkonfigurationen für schnelle Erstellung</p>
                                        </div>
                                        <div class="preset-actions">
                                            <button class="btn mini secondary" id="createPresetBtn" title="Preset erstellen">
                                                <span class="ico">✏</span>
                                                Erstellen
                                            </button>
                                            <button class="btn mini primary" id="addPresetBtn" title="Schnelles Preset hinzufügen">
                                                <span class="ico">+</span>
                                                Preset
                                            </button>
                                        </div>
                                    </div>
                                    <div class="presets-list" id="presetsList">
                                        <!-- Presets will be dynamically added here -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Data Management -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <h4>
                                        <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                            <polyline points="14,2 14,8 20,8"/>
                                            <line x1="16" y1="13" x2="8" y2="13"/>
                                            <line x1="16" y1="17" x2="8" y2="17"/>
                                            <polyline points="10,9 9,9 8,9"/>
                                        </svg>
                                        <span data-i18n="dataSettings">Database Settings</span>
                                    </h4>
                                    <span class="section-badge">4</span>
                                </div>
                                <div class="data-management-grid">
                                    <div class="data-card">
                                        <div class="data-card-header">
                                            <div class="data-icon">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                                                </svg>
                                            </div>
                                            <h5 data-i18n="subjects">Subjects</h5>
                                            <span class="data-count" id="subjectsCount">0</span>
                                        </div>
                                        <div class="data-input-container">
                                            <input type="text" id="subjectsInput" placeholder="Mathematik, Deutsch, Englisch..." class="plan-setting-input">
                                            <button class="btn mini" id="addSubjectBtn" title="Add subject" data-i18n="addSubjectTooltip">+</button>
                                        </div>
                                        <div class="data-list" id="subjectsList"></div>
                                    </div>
                                    
                                    <div class="data-card">
                                        <div class="data-card-header">
                                            <div class="data-icon">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                                    <circle cx="12" cy="7" r="4"/>
                                                </svg>
                                            </div>
                                            <h5 data-i18n="teachers">Teachers</h5>
                                            <span class="data-count" id="teachersCount">0</span>
                                        </div>
                                        <div class="data-input-container">
                                            <input type="text" id="teachersInput" placeholder="Müller, Schmidt, Weber..." class="plan-setting-input">
                                            <button class="btn mini" id="addTeacherBtn" title="Add teacher" data-i18n="addTeacherTooltip">+</button>
                                        </div>
                                        <div class="data-list" id="teachersList"></div>
                                    </div>
                                    
                                    <div class="data-card">
                                        <div class="data-card-header">
                                            <div class="data-icon">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                                    <polyline points="9,22 9,12 15,12 15,22"/>
                                                </svg>
                                            </div>
                                            <h5 data-i18n="rooms">Rooms</h5>
                                            <span class="data-count" id="roomsCount">0</span>
                                        </div>
                                        <div class="data-input-container">
                                            <input type="text" id="roomsInput" placeholder="A101, B205, C301..." class="plan-setting-input">
                                            <button class="btn mini" id="addRoomBtn" title="Add room" data-i18n="addRoomTooltip">+</button>
                                        </div>
                                        <div class="data-list" id="roomsList"></div>
                                    </div>
                                    
                                    <div class="data-card">
                                        <div class="data-card-header">
                                            <div class="data-icon">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
                                                </svg>
                                            </div>
                                            <h5>Farben</h5>
                                            <span class="data-count" id="colorsCount">0</span>
                                        </div>
                                        <div class="data-input-container">
                                            <input type="color" id="customColor" value="#6366f1" class="color-input">
                                            <input type="text" id="colorNameInput" placeholder="Farbname" class="plan-setting-input">
                                            <button class="btn mini" id="addColorBtn" title="Farbe hinzufügen">+</button>
                                        </div>
                                        <div class="data-list" id="colorsList"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Preferences -->
                            <div class="settings-section">
                                <div class="section-header">
                                    <h4>
                                        <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="3"/>
                                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                                        </svg>
                                        <span data-i18n="settingsSection">Settings</span>
                                    </h4>
                                    <span class="section-badge">6</span>
                                </div>
                                <div class="preferences-grid">
                                    <div class="preference-card">
                                        <div class="preference-header">
                                            <h5>Erstellungs-Modi</h5>
                                            <p>Verhalten beim Erstellen von Stunden</p>
                                        </div>
                                        <div class="preference-options">
                                            <div class="toggle-option">
                                                <label class="toggle-label">
                                                    <input type="checkbox" id="quickMode" class="toggle-input">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <div class="option-content">
                                                    <span class="option-title">Schnell-Modus</span>
                                                    <span class="option-description">Einfache Klicks erstellen Stunden</span>
                                                </div>
                                            </div>
                                            <div class="toggle-option">
                                                <label class="toggle-label">
                                                    <input type="checkbox" id="autoSave" class="toggle-input" checked>
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <div class="option-content">
                                                    <span class="option-title">Auto-Speichern</span>
                                                    <span class="option-description">Änderungen automatisch speichern</span>
                                                </div>
                                            </div>
                                            <div class="toggle-option">
                                                <label class="toggle-label">
                                                    <input type="checkbox" id="confirmActions" class="toggle-input">
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <div class="option-content">
                                                    <span class="option-title">Bestätigung</span>
                                                    <span class="option-description">Bestätigung vor Löschen</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="preference-card">
                                        <div class="preference-header">
                                            <h5>Anzeige-Optionen</h5>
                                            <p>Darstellung und Benutzeroberfläche</p>
                                        </div>
                                        <div class="preference-options">
                                            <div class="select-option">
                                                <label class="option-title">Zeit-Format</label>
                                                <select id="timeFormat" class="plan-setting-select">
                                                    <option value="24" selected>24-Stunden (14:30)</option>
                                                    <option value="12">12-Stunden (2:30 PM)</option>
                                                </select>
                                            </div>
                                            <div class="select-option">
                                                <label class="option-title">Grid-Größe</label>
                                                <select id="gridSize" class="plan-setting-select">
                                                    <option value="small">Klein</option>
                                                    <option value="medium" selected>Mittel</option>
                                                    <option value="large">Groß</option>
                                                </select>
                                            </div>
                                            <div class="toggle-option">
                                                <label class="toggle-label">
                                                    <input type="checkbox" id="showTooltips" class="toggle-input" checked>
                                                    <span class="toggle-slider"></span>
                                                </label>
                                                <div class="option-content">
                                                    <span class="option-title">Tooltips</span>
                                                    <span class="option-description">Hilfetexte anzeigen</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                        </div>
                    </div>
            
            <!-- Timetable Structure Side Panel -->
            <div class="timetable-structure-panel" id="timetableStructurePanel">
                <div class="panel-header">
                    <h3>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3h18v18H3zM9 9h6v6H9z"/>
                        </svg>
                        <span data-i18n="timetableStructure">Timetable Structure</span>
                    </h3>
                    <button class="close-btn" onclick="toggleTimetableStructurePanel()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="week-banner">
                    <div class="week-banner-content">
                        <div class="week-nav-container">
                            <button class="week-nav-btn" id="timetableWeekBack" title="Previous Week">◀</button>
                            <div class="week-info">
                                <div class="week-number" id="currentWeekBadge">Week 42</div>
                                <div class="week-purpose">Configure timetable structure for this week</div>
                            </div>
                            <button class="week-nav-btn" id="timetableWeekForward" title="Next Week">▶</button>
                        </div>
                    </div>
                </div>
                <div class="panel-content">
                    <div class="form-group">
                        <label data-i18n="weekdays">Weekdays</label>
                        <div class="weekday-selector">
                            <label class="weekday-checkbox">
                                <input type="checkbox" id="plan-day-mo" checked>
                                <span>Mo</span>
                            </label>
                            <label class="weekday-checkbox">
                                <input type="checkbox" id="plan-day-di" checked>
                                <span>Di</span>
                            </label>
                            <label class="weekday-checkbox">
                                <input type="checkbox" id="plan-day-mi" checked>
                                <span>Mi</span>
                            </label>
                            <label class="weekday-checkbox">
                                <input type="checkbox" id="plan-day-do" checked>
                                <span>Do</span>
                            </label>
                            <label class="weekday-checkbox">
                                <input type="checkbox" id="plan-day-fr" checked>
                                <span>Fr</span>
                            </label>
                            <label class="weekday-checkbox">
                                <input type="checkbox" id="plan-day-sa">
                                <span>Sa</span>
                            </label>
                            <label class="weekday-checkbox">
                                <input type="checkbox" id="plan-day-so">
                                <span>So</span>
                            </label>
                        </div>
                        <small data-i18n="selectWeekdays">Select weekdays for this week</small>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="plan-periodMinSlider" data-i18n="periodDuration">Period Duration (minutes)</label>
                            <div class="slider-container">
                                <input id="plan-periodMinSlider" type="range" min="15" max="120" step="5" value="45" />
                                <div class="slider-value" id="plan-periodMinValue">45</div>
                            </div>
                            <small data-i18n="minutes">minutes</small>
                        </div>
                        <div class="form-group">
                            <label for="plan-periodCountSlider" data-i18n="periodsPerDay">Periods per Day</label>
                            <div class="slider-container">
                                <input id="plan-periodCountSlider" type="range" min="4" max="50" step="1" value="8" />
                                <div class="slider-value" id="plan-periodCountValue">8</div>
                            </div>
                            <small data-i18n="perDay">per day</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="plan-breakMinSlider" data-i18n="breakDuration">Break Duration (minutes)</label>
                        <div class="slider-container">
                            <input id="plan-breakMinSlider" type="range" min="0" max="30" step="5" value="5" />
                            <div class="slider-value" id="plan-breakMinValue">5</div>
                        </div>
                        <small data-i18n="minutesBetweenLessons">minutes between lessons</small>
                    </div>
                    <div class="form-group">
                        <label for="plan-startTimeSlider" data-i18n="dayStartTime">Day Start Time</label>
                        <div class="slider-container">
                            <input id="plan-startTimeSlider" type="range" min="0" max="23" step="1" value="8" />
                            <div class="slider-value" id="plan-startTimeValue">08:00</div>
                        </div>
                        <small data-i18n="dayStartTimeDescription">time when the first period begins</small>
                        <div class="week-start-time-info" id="weekStartTimeInfo" style="margin-top: 8px; padding: 8px; background: #f8fafc; border-radius: 6px; font-size: 12px; color: #64748b;">
                            <span data-i18n="weekStartTimeInfo">This setting applies to the current week only</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ANALYSIS Seite -->
        <div class="container" id="pageAnalysis" hidden>
            <div class="analysis-page">
                <!-- Header -->
                <div class="analysis-header">
                    <h2 data-i18n="analysis">Analysis
                        <div class="info-tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltip-text" data-i18n="analysisTooltip">Detailed statistics and evaluations of your timetable. All data is based on the currently displayed week.</span>
                        </div>
                    </h2>
                    <p data-i18n="analysisSubtitle">Statistics and evaluations of your timetable</p>
                </div>

                <!-- Analysis Content -->
                <div class="analysis-content">
                    <!-- Stats Row -->
                    <div class="stats-row">
                        <div class="stat-card">
                            <div class="stat-number" id="analysisTotalHours">–</div>
                            <div class="stat-label">Stunden diese Woche
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Gesamtanzahl der geplanten Stunden in der aktuellen Woche.</span>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="analysisFreeBlocks">–</div>
                            <div class="stat-label">Freie Blöcke
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Verfügbare Zeitblöcke ohne geplante Stunden.</span>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="analysisUtilization">–</div>
                            <div class="stat-label">Auslastung
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Prozentsatz der belegten Zeitblöcke in der Woche.</span>
                                </div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="analysisAverage">–</div>
                            <div class="stat-label">Ø Stunden/Tag
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Durchschnittliche Anzahl der Stunden pro Tag.</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="charts-row">
                        <div class="chart-container">
                            <h3>Fächer-Verteilung
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Zeigt, wie viele Stunden pro Fach geplant sind.</span>
                                </div>
                            </h3>
                            <div id="barSubjects" class="chart"></div>
                        </div>
                        <div class="chart-container">
                            <h3 data-i18n="teacherDistribution" data-i18n-tooltip="teacherDistributionTooltip">Teacher Distribution
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Shows how many hours are planned per teacher.</span>
                                </div>
                            </h3>
                            <div id="barTeachers" class="chart"></div>
                        </div>
                    </div>

                    <div class="charts-row">
                        <div class="chart-container">
                            <h3 data-i18n="roomUsage" data-i18n-tooltip="roomUsageTooltip">Room Usage
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Shows how often each room is used.</span>
                                </div>
                            </h3>
                            <div id="barRooms" class="chart"></div>
                        </div>
                        <div class="chart-container">
                            <h3 data-i18n="timeDistribution" data-i18n-tooltip="timeDistributionTooltip">Time Distribution
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Shows time distribution throughout the week.</span>
                                </div>
                            </h3>
                            <div id="barTimeSlots" class="chart"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FOLDER Seite -->
        <div class="container" id="pageFolders" hidden>
            <div class="folders-page">
                <!-- Header with actions -->
                <div class="folders-header">
                    <div class="folders-title">
                        <h2>Meine Ordner
                            <div class="info-tooltip">
                                <span class="info-icon">i</span>
                                <span class="tooltip-text">Organisiere deine Dateien nach Fächern. Ziehe Dateien hierher oder klicke auf "Datei hinzufügen".</span>
                            </div>
                        </h2>
                        <p class="folders-subtitle">Organisiere deine Dateien nach Fächern</p>
                    </div>
                    <div class="folders-actions">
                        <button id="newFolderBtn" class="btn primary">
                            <span class="ico">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                                </svg>
                            </span>
                            Neuer Ordner
                        </button>
                        <button id="manageFoldersBtn" class="btn ghost">
                            <span class="ico">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"></path>
                                </svg>
                            </span>
                            Verwalten
                        </button>
                    </div>
                </div>

                <!-- Quick upload area -->
                <div class="upload-section">
                    <div class="dropzone" id="dropzone">
                        <input id="fileInput" type="file" multiple hidden>
                        <div class="dropzone-content">
                            <div class="dropzone-icon">📎</div>
                            <div class="dropzone-text">
                                <strong>Dateien hier ablegen</strong>
                                <span>oder klicken zum Auswählen</span>
                            </div>
                            <div class="dropzone-formats">
                                TXT, MD, JSON, CODE, DOCX, PPTX, XLSX
                                <small>(PDF wird als Platzhalter gespeichert)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Folders grid -->
                <div class="folders-content">
                    <div id="foldersEmpty" class="folders-empty" hidden>
                        <div class="empty-icon">📂</div>
                        <div class="empty-text">Noch keine Ordner vorhanden</div>
                        <div class="empty-subtext">Erstelle deinen ersten Ordner oder lade Dateien hoch</div>
                    </div>
                    <div class="folders-grid" id="foldersGrid"></div>
                </div>
            </div>
        </div>

        <!-- SETTINGS Seite -->
        <div class="container" id="pageSettings" hidden>
            <div class="analysis-page">
                <!-- Header -->
                <div class="analysis-header">
                    <h2>Settings
                        <div class="info-tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltip-text">Configure your timetable and app settings.</span>
                        </div>
                    </h2>
                    <p>Customize the app to your needs</p>
                </div>

                <!-- App Information -->
                <div class="settings-info-section">
                    <div class="settings-info">
                        <div class="info-item">
                            <span class="info-label" data-i18n="version">Version:</span>
                            <span class="info-value">1.0.0</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label" data-i18n="localStorage">Local Storage:</span>
                            <span class="info-value">✓ <span data-i18n="active">Active</span></span>
                        </div>
                        <div class="info-item">
                            <span class="info-label" data-i18n="database">Database:</span>
                            <span class="info-value">localStorage</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label" data-i18n="lastBackup">Last Backup:</span>
                            <span class="info-value" id="lastBackupTime" data-i18n="never">Never</span>
                        </div>
                    </div>
                </div>

                <!-- Settings Content -->
                <div class="analysis-content">
                        <div class="chart-container">
                            <h3 data-i18n="behavior" data-i18n-tooltip="behaviorTooltip">Behavior
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Configure app behavior.</span>
                                </div>
                            </h3>
                            <div class="settings-toggles">
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <span class="toggle-text" data-i18n="autoSave">Auto-Save enabled</span>
                                        <div class="info-tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text" data-i18n="autoSaveTooltip">Changes are automatically saved.</span>
                                        </div>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="autoSaveToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <span class="toggle-text" data-i18n="redline">Show red timeline</span>
                                        <div class="info-tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text" data-i18n="redlineTooltip">Shows current time as red line in timetable.</span>
                                        </div>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="redlineToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <span class="toggle-text" data-i18n="tooltips">Show tooltips</span>
                                        <div class="info-tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text" data-i18n="tooltipsTooltip">Shows help texts on hover over elements.</span>
                                        </div>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="tooltipsToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <span class="toggle-text" data-i18n="dragDrop">Drag & Drop enabled</span>
                                        <div class="info-tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text" data-i18n="dragDropTooltip">Allows moving lessons via drag & drop.</span>
                                        </div>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="dragDropToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Language Settings -->
                    <div class="charts-row">
                        <div class="chart-container">
                            <h3 data-i18n="language" data-i18n-tooltip="languageTooltip">Language
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Choose your preferred language.</span>
                                </div>
                            </h3>
                            <div class="settings-form">
                                <div class="form-group">
                                    <label data-i18n="language">Language</label>
                                    <select id="languageSelector" class="form-control">
                                        <option value="en" data-i18n="english">English</option>
                                        <option value="de" data-i18n="german">German</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Display & Performance -->
                    <div class="charts-row">
                        <div class="chart-container">
                            <h3 data-i18n="display" data-i18n-tooltip="displayTooltip">Display
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Configure app display.</span>
                                </div>
                            </h3>
                            <div class="settings-toggles">
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <span class="toggle-text" data-i18n="compactView">Compact view</span>
                                        <div class="info-tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text" data-i18n="compactViewTooltip">Reduces spacing for a more compact display.</span>
                                        </div>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="compactViewToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <span class="toggle-text" data-i18n="animations">Animations enabled</span>
                                        <div class="info-tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text" data-i18n="animationsTooltip">Enables transition animations and effects.</span>
                                        </div>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="animationsToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <span class="toggle-text" data-i18n="weekNav">Week navigation</span>
                                        <div class="info-tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text" data-i18n="weekNavTooltip">Shows week navigation controls.</span>
                                        </div>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="weekNavToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container">
                            <h3>Performance & Backup
                                <div class="info-tooltip">
                                    <span class="info-icon">i</span>
                                    <span class="tooltip-text">Performance-Optimierungen und Datensicherung.</span>
                                </div>
                            </h3>
                            <div class="settings-toggles">
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <span class="toggle-text">Performance-Modus</span>
                                        <div class="info-tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text">Optimiert die App für bessere Performance.</span>
                                        </div>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="performanceModeToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <span class="toggle-text">Automatische Backups</span>
                                        <div class="info-tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text">Erstellt automatisch Backups der Stundenplandaten.</span>
                                        </div>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="autoBackupToggle" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-group">
                                    <label class="toggle-label">
                                        <span class="toggle-text">Debug-Modus</span>
                                        <div class="info-tooltip">
                                            <span class="info-icon">i</span>
                                            <span class="tooltip-text">Zeigt zusätzliche Debug-Informationen in der Konsole.</span>
                                        </div>
                                    </label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="debugModeToggle">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Data Management -->
                <div class="settings-data-section">
                    <h3 data-i18n="dataManagement">Data Management
                        <div class="info-tooltip">
                            <span class="info-icon">i</span>
                            <span class="tooltip-text" data-i18n="dataManagementTooltip">Manage your timetable data.</span>
                        </div>
                    </h3>
                    <div class="settings-actions">
                        <button class="btn primary" id="exportDataBtn">
                            <span class="ico">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7,10 12,15 17,10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                            </span>
                            <span data-i18n="exportData">Export Data</span>
                        </button>
                        <button class="btn ghost" id="importDataBtn">
                            <span class="ico">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="17,8 12,3 7,8"></polyline>
                                    <line x1="12" y1="3" x2="12" y2="15"></line>
                                </svg>
                            </span>
                            <span data-i18n="importData">Import Data</span>
                        </button>
                        <button class="btn secondary" id="resetSettingsBtn">
                            <span class="ico">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"></path>
                                </svg>
                            </span>
                            <span data-i18n="resetSettings">Reset Settings</span>
                        </button>
                        <button class="btn danger" id="resetDataBtn">
                            <span class="ico">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3,6 5,6 21,6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                            </span>
                            <span data-i18n="resetAllData">Reset All Data</span>
                        </button>
                    </div>
                </div>

                <!-- Auto-save notice -->
                <div class="settings-footer">
                    <div class="auto-save-notice">
                        <span class="save-icon">✓</span>
                        <span data-i18n="autoSaveNotice">Settings are automatically saved</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="container">Made with ❤️ – lokal speicherbar, kein Server nötig.</footer>

    <!-- LESSON INFO + EDIT (bestehende Modale bleiben) -->
    <div class="modal" id="infoModal" aria-modal="true" aria-hidden="true">
        <div class="backdrop" data-close></div>
        <div class="dialog">
            <button class="close-x" data-close aria-label="Schließen">×</button>
            <h2 data-i18n="subjectInfo">Subject Info</h2>
            <div id="infoColor" style="height:6px;border-radius:6px;margin:-2px 0 12px"></div>
            <div class="field"><label data-i18n="subjectLabel">Subject</label>
                <div id="iSubject" class="meta" style="font-size:14px;color:#0f172a;font-weight:700"></div>
            </div>
            <div class="grid2">
                <div class="field"><label data-i18n="teacherLabel">Teacher</label>
                    <div id="iTeacher" class="meta"></div>
                </div>
                <div class="field"><label data-i18n="roomLabel">Room</label>
                    <div id="iRoom" class="meta"></div>
                </div>
            </div>
            <div class="grid2">
                <div class="field"><label data-i18n="day">Day</label>
                    <div id="iDay" class="meta"></div>
                </div>
                <div class="field"><label data-i18n="timeLabel">Time</label>
                    <div id="iTime" class="meta"></div>
                </div>
            </div>
            <div class="field"><label>Dauer</label>
                <div id="iDuration" class="meta"></div>
            </div>
            <div class="field" id="iImportanceField" style="display:none">
                <label>Status</label>
                <div class="meta" style="color:#f59e0b;font-weight:600">⚠️ Wichtige Stunde (Prüfung/Klausur)</div>
            </div>
            <div class="actions split" style="margin-top:18px">
                <button class="btn danger" id="infoDelete" data-i18n="deleteLabel">Delete</button>
                <div><button class="btn ghost" data-close data-i18n="closeLabel">Close</button><button class="btn primary"
                        id="infoEdit" data-i18n="editLabel">Edit</button></div>
            </div>
        </div>
    </div>

    <div class="modal" id="editModal" aria-modal="true" aria-hidden="true">
        <div class="backdrop" data-close></div>
        <div class="dialog">
            <button class="close-x" data-close aria-label="Schließen">×</button>
            <h2 data-i18n="editSubject">Edit Subject</h2>
            <div class="field"><label data-i18n="subjectLabel">Subject</label><input id="fSubject" /></div>
            <div class="grid2">
                <div class="field"><label data-i18n="teacherLabel">Teacher</label><select id="fTeacherSel"></select></div>
                <div class="field"><label data-i18n="roomLabel">Room</label><input id="fRoom" list="roomList" /></div>
            </div>
            <datalist id="roomList"></datalist>
            <div class="field">
                <label>Farbe (aus Einstellungen)</label>
                <div id="fColorSwatch"
                    style="height:10px;border-radius:8px;border:1px solid var(--border);background:#60a5fa">
                </div>
            </div>
            <div class="field">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
                    <input type="checkbox" id="fImportance" style="margin:0">
                    <span>Wichtig (Prüfung, Klausur, etc.)</span>
                </label>
            </div>
            <div class="meta" id="timePreview"></div>
            <div class="actions split">
                <button class="btn danger" id="deleteLesson" data-i18n="deleteLabel">Delete</button>
                <div><button class="btn ghost" data-close data-i18n="cancelLabel">Cancel</button><button class="btn primary"
                        id="saveLesson" data-i18n="saveLabel">Save</button></div>
            </div>
        </div>
    </div>

    <!-- FOLDER-Modal Trio (unverändert) -->
    <div class="modal" id="foldersManageModal" aria-hidden="true">
        <div class="backdrop" data-close></div>
        <div class="dialog" style="width:min(720px,100%)">
            <button class="close-x" data-close aria-label="Schließen">×</button>
            <h2>Ordner verwalten & sortieren</h2>
            <div class="small">Ziehe an den ⋮⋮ Griffen, um die Reihenfolge zu ändern. Klick auf einen Ordner zum
                Bearbeiten.</div>
            <div id="manageList" class="list" style="margin-top:8px"></div>
            <div class="actions"><button class="btn ghost" data-close>Fertig</button></div>
        </div>
    </div>

    <div class="modal" id="folderEditModal" aria-hidden="true">
        <div class="backdrop" data-close></div>
        <div class="dialog">
            <button class="close-x" data-close aria-label="Schließen">×</button>
            <h2 id="folderEditTitle">Ordner bearbeiten</h2>
            <div class="field"><label>Name</label><input id="folderNameInput" /></div>
            <div class="field"><label>Farbe</label><input id="folderColorInput" type="color" /></div>
            <div class="actions split"><button id="folderDeleteBtn" class="btn danger">Ordner löschen</button>
                <div><button class="btn ghost" data-close>Abbrechen</button><button id="folderSaveBtn"
                        class="btn primary">Speichern</button></div>
            </div>
        </div>
    </div>

    <div class="modal" id="folderDetailModal" aria-hidden="true">
        <div class="backdrop" data-close></div>
        <div class="dialog" style="width:min(820px,100%)">
            <button class="close-x" data-close aria-label="Schließen">×</button>
            <h2 id="folderDetailTitle">Ordner</h2>
            <div id="folderDetailGrid" class="file-grid"></div>
            <div class="actions"><button class="btn ghost" data-close>Schließen</button></div>
        </div>
    </div>

    <script>
        /* =================== TYPES / STATE =================== */
        /** @typedef {{id:string,subject:string,teacher?:string,room?:string,color?:string,day:number,startIndex:number,span:number,importance?:boolean}} Lesson */
        const defaultDays = ["Mo", "Di", "Mi", "Do", "Fr"];
        const dayStart = { h: 8, m: 0 };
        const periodMinutesDefault = 45, breakMinutesDefault = 5;
        const colors = ["#60a5fa", "#f472b6", "#34d399", "#f59e0b", "#a78bfa", "#fb7185", "#22d3ee", "#fca5a5"];
        const LS_PLAN = "custom_timetable_state_v1_vanilla";
        const LS_FOLDERS = "custom_timetable_folders_v1";
        const LS_DATA = "custom_timetable_masterdata_v1";

        const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
        const pad = n => String(n).padStart(2, "0");
        const timeLabelFromMinutes = (base, plus) => { const total = base.h * 60 + base.m + plus; const h = Math.floor(total / 60); const m = total % 60; return `${pad(h)}:${pad(m)}` };
        const minutesSinceStart = (date = new Date()) => { 
            const currentPlan = getOrCreateWeekPlan(currentPlanWeek);
            const d = new Date(date); 
            const start = new Date(date); 
            start.setHours(currentPlan.dayStart.h, currentPlan.dayStart.m, 0, 0); 
            return (d - start) / 60000 
        };
        const uid = () => (crypto && crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));
        const byId = id => document.getElementById(id);

        const state = { days: [...defaultDays], periodMinutes: periodMinutesDefault, breakMinutes: breakMinutesDefault, periodCount: 8, lessons/** @type {Lesson[]}*/: [] };
        
        // Week navigation state
        let currentWeekOffset = 0; // 0 = current week, -1 = previous week, 1 = next week, etc. (for Overview heatmap)
        
        // Multi-week planning system
        const weekPlans = new Map(); // weekKey -> { lessons: [], days: [], periodMinutes, breakMinutes, periodCount }
        let currentPlanWeek = getCurrentWeekKey(); // Track which week plan we're viewing in Plan section
        
        // Separate week tracking for heatmap (independent from plan timetable)
        let currentHeatmapWeek = getCurrentWeekKey(); // Track which week the heatmap is showing
        
        
        // Overview-specific week tracking (independent from plan timetable and heatmap)
        let overviewWeekKey = getCurrentWeekKey(); // Track which week the overview is showing
        
        // Overview-specific state (independent from Plan section)
        let overviewState = {
            lessons: [],
            days: [...defaultDays],
            periodMinutes: periodMinutesDefault,
            breakMinutes: breakMinutesDefault,
            periodCount: 8
        };
        
        function syncOverviewState() {
            // Sync overview state with current settings (but not lessons)
            overviewState.days = [...state.days];
            overviewState.periodMinutes = state.periodMinutes;
            overviewState.breakMinutes = state.breakMinutes;
            overviewState.periodCount = state.periodCount;
            
            // Calculate overview week key based on offset
            overviewWeekKey = getWeekKeyFromOffset(currentWeekOffset);
        }
        // + subjectColors map and presets
        const dataState = {
            teachers/** @type {string[]}*/: [],
            rooms/** @type {string[]}*/: [],
            subjects/** @type {string[]}*/: [],
            classes/** @type {string[]}*/: [],
            subjectColors/** @type {Record<string,string>}*/: {},      // e.g. { Mathe: "#60a5fa" }
            presets/** @type {Array<{subject:string,teacher?:string,room?:string,color?:string}>}*/: []
        };

        const folderState = { folders/** @type {Array<{id:string,name:string,color:string,items:Array<{id:string,name:string,topic:string,grade:number,notes?:string,added:string,ext:string}>}>}*/: [] };
        const fColorSwatch = byId('fColorSwatch');
        let isCreating = false;
        let creatingDraft = null;
        /* =================== LOAD / SAVE =================== */
        function seedLessons() {
            return [
                { id: uid(), subject: "Mathe", teacher: "Müller", room: "A101", color: colors[0], day: 0, startIndex: 0, span: 2 },
                { id: uid(), subject: "Deutsch", teacher: "Schmidt", room: "B204", color: colors[1], day: 2, startIndex: 3, span: 1 },
                { id: uid(), subject: "Englisch", teacher: "Khan", room: "C3", color: colors[2], day: 4, startIndex: 5, span: 2 }
            ];
        }
        function colorForSubject(subj) {
            const s = (subj || '').trim();
            if (!s) return '#60a5fa';
            const p = findPresetForSubject(s);
            return (p && p.color) || (dataState.subjectColors && dataState.subjectColors[s]) || '#60a5fa';
        }
        function seedFolders() {
            return [
                { id: uid(), name: "Mathe", color: "#60a5fa", items: [] },
                { id: uid(), name: "Deutsch", color: "#f472b6", items: [] },
                { id: uid(), name: "Informatik", color: "#34d399", items: [] },
                { id: uid(), name: "Allgemein", color: "#a78bfa", items: [] }
            ];
        }
        function seedData() {
            const d = {
                teachers: ["Müller", "Schmidt", "Khan"],
                rooms: ["A101", "B204", "C3"],
                subjects: ["Mathe", "Deutsch", "Englisch", "Informatik"],
                classes: ["8A", "8B"],
                subjectColors: { Mathe: "#60a5fa", Deutsch: "#f472b6", Englisch: "#34d399", Informatik: "#a78bfa" },
                presets: [
                    { subject: "Mathe", teacher: "Müller", room: "A101", color: "#60a5fa" },
                    { subject: "Deutsch", teacher: "Schmidt", room: "B204", color: "#f472b6" },
                    { subject: "Englisch", teacher: "Khan", room: "C3", color: "#34d399" }
                ]
            };
            return d;
        }

        function loadAll() {
            try {
                const r = localStorage.getItem(LS_PLAN);
                if (r) {
                    const o = JSON.parse(r); 
                    state.days = Array.isArray(o.days) && o.days.length ? o.days : defaultDays;
                    state.periodMinutes = Number(o.periodMinutes) || periodMinutesDefault;
                    state.breakMinutes = Number(o.breakMinutes) >= 0 ? Number(o.breakMinutes) : breakMinutesDefault;
                    state.periodCount = Number(o.periodCount) || 8;
                    state.lessons = Array.isArray(o.lessons) && o.lessons.length ? o.lessons : seedLessons();
                } else {
                    state.lessons = seedLessons();
                }
            } catch (e) { 
                state.lessons = seedLessons(); 
            }
            
            // Load saved current plan week FIRST
            try {
                const savedWeek = localStorage.getItem('currentPlanWeek');
                if (savedWeek) {
                    const currentWeekKey = getCurrentWeekKey();
                    const cmp = weekKeyCompare(savedWeek, currentWeekKey);
                    
                    // If saved week is in the future, reset to current week
                    if (cmp > 0) {
                        currentPlanWeek = currentWeekKey;
                        localStorage.setItem('currentPlanWeek', currentWeekKey);
                    } else {
                        currentPlanWeek = normalizeWeekKey(savedWeek);
                    }
                }
            } catch { /* ignore */ }
            
            // Load saved week plans
            try {
                const savedWeekPlans = localStorage.getItem('weekPlans');
                if (savedWeekPlans) {
                    const parsedPlans = JSON.parse(savedWeekPlans);
                    weekPlans.clear();
                    for (const [key, value] of Object.entries(parsedPlans)) {
                        weekPlans.set(key, value);
                    }
                }
            } catch (e) {
                console.warn('Failed to load weekPlans:', e);
            }
            
            // Load saved overview week offset
            try {
                const savedOffset = localStorage.getItem('currentWeekOffset');
                if (savedOffset !== null) {
                    currentWeekOffset = parseInt(savedOffset) || 0;
                }
            } catch { /* ignore */ }
            
            // Load saved heatmap week
            try {
                const savedHeatmapWeek = localStorage.getItem('currentHeatmapWeek');
                const currentWeekKey = getCurrentWeekKey();
                if (savedHeatmapWeek) {
                    currentHeatmapWeek = normalizeWeekKey(savedHeatmapWeek);
                }
            } catch { /* ignore */ }
            
            // Load saved overview week
            try {
                const savedOverviewWeek = localStorage.getItem('overviewWeekKey');
                if (savedOverviewWeek) {
                    overviewWeekKey = normalizeWeekKey(savedOverviewWeek);
                }
            } catch { /* ignore */ }

            try { const d = localStorage.getItem(LS_DATA); Object.assign(dataState, d ? JSON.parse(d) : seedData()); }
            catch { Object.assign(dataState, seedData()); }

            try { const f = localStorage.getItem(LS_FOLDERS); folderState.folders = f ? JSON.parse(f) : seedFolders(); }
            catch { folderState.folders = seedFolders(); }
        }

        // Settings state management
        const settingsState = {
            autoSave: true,
            redline: true,
            tooltips: true,
            dragDrop: true,
            compactView: false,
            animations: true,
            weekNav: true,
            debugMode: false,
            autoBackup: true,
            performanceMode: false,
            language: 'en' // Default to English
        };

        // Internationalization system
        const translations = {
            en: {
                // Navigation
                'navPlan': 'Plan',
                'navOverview': 'Overview',
                'navAnalysis': 'Analysis',
                'navSettings': 'Settings',
                
                // Settings page
                'settingsTitle': 'Settings',
                'settingsSubtitle': 'Customize the app to your needs',
                'settingsTooltip': 'Configure your timetable and app settings.',
                
                // App info
                'version': 'Version',
                'localStorage': 'Local Storage',
                'active': 'Active',
                'database': 'Database',
                'lastBackup': 'Last Backup',
                'never': 'Never',
                
                // Language selector
                'language': 'Language',
                'languageTooltip': 'Choose your preferred language.',
                'english': 'English',
                'german': 'German',
                
                // Timetable structure
                'timetableStructure': 'Timetable Structure',
                'timetableStructureTooltip': 'Define the basic structure of your timetable.',
                'weekdays': 'Weekdays',
                'periodDuration': 'Period Duration (minutes)',
                'breakDuration': 'Break Duration (minutes)',
                'periodsPerDay': 'Periods per Day',
                'dayStartTime': 'Day Start Time',
                'dayStartTimeDescription': 'time when the first period begins (supports flexible work schedules)',
                'weekStartTimeInfo': 'This setting applies to the current week only',
                
                // Behavior settings
                'behavior': 'Behavior',
                'behaviorTooltip': 'Configure app behavior.',
                'autoSave': 'Auto-Save enabled',
                'autoSaveTooltip': 'Changes are automatically saved.',
                'redline': 'Show red timeline',
                'redlineTooltip': 'Shows current time as red line in timetable.',
                'tooltips': 'Show tooltips',
                'tooltipsTooltip': 'Shows help texts on hover over elements.',
                'dragDrop': 'Drag & Drop enabled',
                'dragDropTooltip': 'Allows moving lessons via drag & drop.',
                
                // Display settings
                'display': 'Display',
                'displayTooltip': 'Configure app display.',
                'compactView': 'Compact view',
                'compactViewTooltip': 'Reduces spacing for a more compact display.',
                'animations': 'Animations enabled',
                'animationsTooltip': 'Enables transition animations and effects.',
                'weekNav': 'Week navigation',
                'weekNavTooltip': 'Shows week navigation controls.',
                
                // Advanced settings
                'advanced': 'Advanced',
                'advancedTooltip': 'Advanced app settings.',
                'debugMode': 'Debug mode',
                'debugModeTooltip': 'Enables debug information and console logging.',
                'autoBackup': 'Auto-backup',
                'autoBackupTooltip': 'Automatically creates backups of your data.',
                'performanceMode': 'Performance mode',
                'performanceModeTooltip': 'Optimizes app for better performance.',
                
                // Actions
                'resetSettings': 'Reset Settings',
                'resetSettingsConfirm': 'Reset all settings? This cannot be undone.',
                'settingsReset': 'Settings have been reset.',
                'autoSaveNotice': 'Settings are automatically saved',
                
                // Next up section
                'nextUp': 'Next Up',
                'now': 'Now',
                'tomorrow': 'Tomorrow',
                'noLessonsPlanned': 'No lessons planned',
                'createClass': 'Create Class',
                
                // Days
                'monday': 'Monday',
                'tuesday': 'Tuesday',
                'wednesday': 'Wednesday',
                'thursday': 'Thursday',
                'friday': 'Friday',
                'saturday': 'Saturday',
                'sunday': 'Sunday',
                
                // Lesson modal
                'createSubject': 'Create Subject',
                'editSubject': 'Edit Subject',
                'subject': 'Subject',
                'teacher': 'Teacher',
                'room': 'Room',
                'time': 'Time',
                'create': 'Create',
                'save': 'Save',
                'cancel': 'Cancel',
                'delete': 'Delete',
                'deleteConfirm': 'Really delete this lesson?',
                
                // Quick actions
                'quickActions': 'Quick Actions',
                'settings': 'Settings',
                
                // Plan settings
                'planSettings': 'Plan Settings',
                'planSettingsTooltip': 'Detailed settings for plan creation. All values are automatically saved.',
                'dataSettings': 'Database Settings',
                'settingsSection': 'Settings',
                
                // Overview
                'overview': 'Overview',
                'today': 'Today',
                'todayNothing': 'Today: nothing more pending',
                'allDone': 'All done',
                'minutesLeft': 'minutes left',
                
                // Analysis
                'analysis': 'Analysis',
                'weeklyStats': 'Weekly Statistics',
                'totalLessons': 'Total Lessons',
                'totalMinutes': 'Total Minutes',
                'totalHours': 'Total Hours',
                'activeSubjects': 'Active Subjects',
                'studyStreak': 'Study Streak',
                'days': 'days',
                
                // Common
                'min': 'Min',
                'h': 'h',
                'room': 'Room',
                'subject': 'Subject',
                'teacher': 'Teacher',
                'time': 'Time',
                'day': 'Day',
                'week': 'Week',
                'month': 'Month',
                'year': 'Year',
                
                // Form labels and placeholders
                'minutes': 'minutes',
                'perDay': 'per day',
                'minutesBetweenLessons': 'minutes between lessons',
                'selectWeekdays': 'Select weekdays for your timetable',
                'addTimeSlot': 'Add time slot',
                'newTimeSlot': 'New time slot',
                'manageTeachers': 'Manage Teachers',
                'addEditTeachers': 'Add and edit teachers',
                'edit': 'Edit',
                'close': 'Close',
                'delete': 'Delete',
                'addSubject': 'Add subject',
                'addTeacher': 'Add teacher',
                'addRoom': 'Add room',
                'teachers': 'Teachers',
                'rooms': 'Rooms',
                'subjects': 'Subjects',
                'subjectInfo': 'Subject Info',
                'editSubject': 'Edit Subject',
                'createSubject': 'Create Subject',
                'teacherLabel': 'Teacher',
                'roomLabel': 'Room',
                'subjectLabel': 'Subject',
                'timeLabel': 'Time',
                'autoSave': 'Auto-Save',
                'confirmation': 'Confirmation',
                'confirmationDescription': 'Confirmation before deleting',
                'timeFormat': 'Time Format',
                'timeFormat24': '24-hour (14:30)',
                'timeFormat12': '12-hour (2:30 PM)',
                'teacherDistribution': 'Teacher Distribution',
                'roomUsage': 'Room Usage',
                'timeDistribution': 'Time Distribution',
                'showsTeacherHours': 'Shows how many hours are planned per teacher',
                'showsRoomUsage': 'Shows how often each room is used',
                'showsTimeDistribution': 'Shows time distribution throughout the week',
                'availableTimeBlocks': 'Available time blocks without planned lessons',
                'percentageOccupied': 'Percentage of occupied time blocks in the week',
                'showsSubjectHours': 'Shows how many hours are planned per subject',
                'heatmapDescription': 'Shows your lesson distribution as heatmap. Red line = current time. Green areas = already past lessons',
                'availableBlocksToday': 'Available time blocks without planned lessons for today',
                'availableBlocks': 'Available time blocks without planned lessons',
                'quickActions': 'Quick Actions',
                'settings': 'Settings',
                'exportData': 'Export Data',
                'importData': 'Import Data',
                'resetAllData': 'Reset All Data',
                'resetAllDataConfirm': 'Really reset all data? This cannot be undone.',
                'dataReset': 'All data has been reset.',
                'closeLabel': 'Close',
                'editLabel': 'Edit',
                'deleteLabel': 'Delete',
                'saveLabel': 'Save',
                'cancelLabel': 'Cancel',
                'createLabel': 'Create',
                'addLabel': 'Add',
                'manageLabel': 'Manage',
                'subjectPlaceholder': 'Mathematics, German, English...',
                'teacherPlaceholder': 'Müller, Schmidt, Weber...',
                'roomPlaceholder': 'A101, B205, C301...',
                'minutesLabel': 'minutes',
                'betweenLessons': 'between lessons',
                'perDayLabel': 'per day',
                'weekdaySelection': 'Select weekdays for your timetable',
                'heatmapTooltip': 'Shows your lesson distribution as heatmap. Red line = current time. Green areas = already past lessons.',
                'availableBlocksTooltip': 'Available time blocks without planned lessons for today.',
                'percentageTooltip': 'Percentage of occupied time blocks in the week.',
                'subjectDistributionTooltip': 'Shows how many hours are planned per subject.',
                'teacherDistributionTooltip': 'Shows how many hours are planned per teacher.',
                'roomUsageTooltip': 'Shows how often each room is used.',
                'timeDistributionTooltip': 'Shows time distribution throughout the week.',
                'addTimeSlotTooltip': 'Add new time slot',
                'manageTeachersTooltip': 'Add and edit teachers',
                'addSubjectTooltip': 'Add subject',
                'addTeacherTooltip': 'Add teacher',
                'addRoomTooltip': 'Add room',
                'dataManagement': 'Data Management',
                'dataManagementTooltip': 'Manage your timetable data.',
                'weeklyPlan': 'Weekly Plan',
                'analysisTooltip': 'Detailed statistics and evaluations of your timetable. All data is based on the currently displayed week.',
                'analysisSubtitle': 'Statistics and evaluations of your timetable'
            },
            de: {
                // Navigation
                'navPlan': 'Plan',
                'navOverview': 'Übersicht',
                'navAnalysis': 'Analyse',
                'navSettings': 'Einstellungen',
                
                // Settings page
                'settingsTitle': 'Einstellungen',
                'settingsSubtitle': 'Passe die App an deine Bedürfnisse an',
                'settingsTooltip': 'Konfiguriere deinen Stundenplan und App-Einstellungen.',
                
                // App info
                'version': 'Version',
                'localStorage': 'Lokale Speicherung',
                'active': 'Aktiv',
                'database': 'Datenbank',
                'lastBackup': 'Letztes Backup',
                'never': 'Nie',
                
                // Language selector
                'language': 'Sprache',
                'languageTooltip': 'Wähle deine bevorzugte Sprache.',
                'english': 'Englisch',
                'german': 'Deutsch',
                
                // Timetable structure
                'timetableStructure': 'Stundenplan-Struktur',
                'timetableStructureTooltip': 'Definiere die Grundstruktur deines Stundenplans.',
                'weekdays': 'Wochentage',
                'periodDuration': 'Stundendauer (Minuten)',
                'breakDuration': 'Pausendauer (Minuten)',
                'periodsPerDay': 'Stunden pro Tag',
                'dayStartTime': 'Tagesbeginn',
                'dayStartTimeDescription': 'Zeit, zu der die erste Stunde beginnt (unterstützt Gleitzeit)',
                'weekStartTimeInfo': 'Diese Einstellung gilt nur für die aktuelle Woche',
                
                // Behavior settings
                'behavior': 'Verhalten',
                'behaviorTooltip': 'Konfiguriere das Verhalten der App.',
                'autoSave': 'Auto-Save aktiviert',
                'autoSaveTooltip': 'Änderungen werden automatisch gespeichert.',
                'redline': 'Rote Zeitlinie anzeigen',
                'redlineTooltip': 'Zeigt die aktuelle Uhrzeit als rote Linie im Stundenplan.',
                'tooltips': 'Tooltips anzeigen',
                'tooltipsTooltip': 'Zeigt Hilfetexte bei Hover über Elemente.',
                'dragDrop': 'Drag & Drop aktiviert',
                'dragDropTooltip': 'Erlaubt das Verschieben von Stunden per Drag & Drop.',
                
                // Display settings
                'display': 'Darstellung',
                'displayTooltip': 'Konfiguriere die Darstellung der App.',
                'compactView': 'Kompakte Ansicht',
                'compactViewTooltip': 'Reduziert Abstände für eine kompaktere Darstellung.',
                'animations': 'Animationen aktiviert',
                'animationsTooltip': 'Aktiviert Übergangsanimationen und Effekte.',
                'weekNav': 'Wochen-Navigation',
                'weekNavTooltip': 'Zeigt Wochen-Navigationssteuerungen.',
                
                // Advanced settings
                'advanced': 'Erweitert',
                'advancedTooltip': 'Erweiterte App-Einstellungen.',
                'debugMode': 'Debug-Modus',
                'debugModeTooltip': 'Aktiviert Debug-Informationen und Konsolenprotokollierung.',
                'autoBackup': 'Auto-Backup',
                'autoBackupTooltip': 'Erstellt automatisch Backups deiner Daten.',
                'performanceMode': 'Leistungsmodus',
                'performanceModeTooltip': 'Optimiert die App für bessere Leistung.',
                
                // Actions
                'resetSettings': 'Einstellungen zurücksetzen',
                'resetSettingsConfirm': 'Alle Einstellungen zurücksetzen? Dies kann nicht rückgängig gemacht werden.',
                'settingsReset': 'Einstellungen wurden zurückgesetzt.',
                'autoSaveNotice': 'Einstellungen werden automatisch gespeichert',
                
                // Next up section
                'nextUp': 'Als Nächstes',
                'now': 'Jetzt',
                'tomorrow': 'Morgen',
                'noLessonsPlanned': 'Keine Stunden geplant',
                'createClass': 'Stunde hinzufügen',
                
                // Days
                'monday': 'Montag',
                'tuesday': 'Dienstag',
                'wednesday': 'Mittwoch',
                'thursday': 'Donnerstag',
                'friday': 'Freitag',
                'saturday': 'Samstag',
                'sunday': 'Sonntag',
                
                // Lesson modal
                'createSubject': 'Fach anlegen',
                'editSubject': 'Fach bearbeiten',
                'subject': 'Fach',
                'teacher': 'Lehrer',
                'room': 'Raum',
                'time': 'Zeit',
                'create': 'Anlegen',
                'save': 'Speichern',
                'cancel': 'Abbrechen',
                'delete': 'Löschen',
                'deleteConfirm': 'Diesen Stunden wirklich löschen?',
                
                // Quick actions
                'quickActions': 'Schnellaktionen',
                'settings': 'Einstellungen',
                
                // Plan settings
                'planSettings': 'Plan-Einstellungen',
                'planSettingsTooltip': 'Detaillierte Einstellungen für die Plan-Erstellung. Alle Werte werden automatisch gespeichert.',
                'dataSettings': 'Datenbank-Einstellungen',
                'settingsSection': 'Einstellungen',
                
                // Overview
                'overview': 'Übersicht',
                'today': 'Heute',
                'todayNothing': 'Heute: nichts mehr anstehend',
                'allDone': 'Alles geschafft',
                'minutesLeft': 'Min übrig',
                
                // Analysis
                'analysis': 'Analyse',
                'weeklyStats': 'Wochenstatistiken',
                'totalLessons': 'Gesamte Stunden',
                'totalMinutes': 'Gesamte Minuten',
                'totalHours': 'Gesamte Stunden',
                'activeSubjects': 'Aktive Fächer',
                'studyStreak': 'Lernstreak',
                'days': 'Tage',
                
                // Common
                'min': 'Min',
                'h': 'h',
                'room': 'Raum',
                'subject': 'Fach',
                'teacher': 'Lehrer',
                'time': 'Zeit',
                'day': 'Tag',
                'week': 'Woche',
                'month': 'Monat',
                'year': 'Jahr',
                
                // Form labels and placeholders
                'minutes': 'Minuten',
                'perDay': 'pro Tag',
                'minutesBetweenLessons': 'Minuten zwischen den Stunden',
                'selectWeekdays': 'Wähle die Wochentage für deinen Stundenplan',
                'addTimeSlot': 'Zeitstunde hinzufügen',
                'newTimeSlot': 'Neue Zeitstunde',
                'manageTeachers': 'Lehrer verwalten',
                'addEditTeachers': 'Lehrer hinzufügen und bearbeiten',
                'edit': 'Bearbeiten',
                'close': 'Schließen',
                'delete': 'Löschen',
                'addSubject': 'Fach hinzufügen',
                'addTeacher': 'Lehrer hinzufügen',
                'addRoom': 'Raum hinzufügen',
                'teachers': 'Lehrer',
                'rooms': 'Räume',
                'subjects': 'Fächer',
                'subjectInfo': 'Fach-Info',
                'editSubject': 'Fach bearbeiten',
                'createSubject': 'Fach anlegen',
                'teacherLabel': 'Lehrer:in',
                'roomLabel': 'Raum',
                'subjectLabel': 'Fach',
                'timeLabel': 'Zeit',
                'autoSave': 'Auto-Speichern',
                'confirmation': 'Bestätigung',
                'confirmationDescription': 'Bestätigung vor Löschen',
                'timeFormat': 'Zeit-Format',
                'timeFormat24': '24-Stunden (14:30)',
                'timeFormat12': '12-Stunden (2:30 PM)',
                'teacherDistribution': 'Lehrer-Verteilung',
                'roomUsage': 'Raum-Nutzung',
                'timeDistribution': 'Zeit-Verteilung',
                'showsTeacherHours': 'Zeigt, wie viele Stunden pro Lehrer geplant sind',
                'showsRoomUsage': 'Zeigt, wie oft jeder Raum verwendet wird',
                'showsTimeDistribution': 'Zeigt Zeitverteilung über die Woche',
                'availableTimeBlocks': 'Verfügbare Zeitblöcke ohne geplante Stunden',
                'percentageOccupied': 'Prozentsatz der belegten Zeitblöcke in der Woche',
                'showsSubjectHours': 'Zeigt, wie viele Stunden pro Fach geplant sind',
                'heatmapDescription': 'Zeigt deine Stundenverteilung als Heatmap. Rote Linie = aktuelle Zeit. Grüne Bereiche = bereits vergangene Stunden',
                'availableBlocksToday': 'Verfügbare Zeitblöcke ohne geplante Stunden für heute',
                'availableBlocks': 'Verfügbare Zeitblöcke ohne geplante Stunden',
                'quickActions': 'Schnellaktionen',
                'settings': 'Einstellungen',
                'exportData': 'Daten exportieren',
                'importData': 'Daten importieren',
                'resetAllData': 'Alle Daten zurücksetzen',
                'resetAllDataConfirm': 'Wirklich alle Daten zurücksetzen? Dies kann nicht rückgängig gemacht werden.',
                'dataReset': 'Alle Daten wurden zurückgesetzt.',
                'closeLabel': 'Schließen',
                'editLabel': 'Bearbeiten',
                'deleteLabel': 'Löschen',
                'saveLabel': 'Speichern',
                'cancelLabel': 'Abbrechen',
                'createLabel': 'Anlegen',
                'addLabel': 'Hinzufügen',
                'manageLabel': 'Verwalten',
                'subjectPlaceholder': 'Mathematik, Deutsch, Englisch...',
                'teacherPlaceholder': 'Müller, Schmidt, Weber...',
                'roomPlaceholder': 'A101, B205, C301...',
                'minutesLabel': 'Minuten',
                'betweenLessons': 'zwischen den Stunden',
                'perDayLabel': 'pro Tag',
                'weekdaySelection': 'Wähle die Wochentage für deinen Stundenplan',
                'heatmapTooltip': 'Zeigt deine Stundenverteilung als Heatmap. Rote Linie = aktuelle Zeit. Grüne Bereiche = bereits vergangene Stunden.',
                'availableBlocksTooltip': 'Verfügbare Zeitblöcke ohne geplante Stunden für heute.',
                'percentageTooltip': 'Prozentsatz der belegten Zeitblöcke in der Woche.',
                'subjectDistributionTooltip': 'Zeigt, wie viele Stunden pro Fach geplant sind.',
                'teacherDistributionTooltip': 'Zeigt, wie viele Stunden pro Lehrer geplant sind.',
                'roomUsageTooltip': 'Zeigt, wie oft jeder Raum verwendet wird.',
                'timeDistributionTooltip': 'Zeigt Zeitverteilung über die Woche.',
                'addTimeSlotTooltip': 'Neue Zeitstunde hinzufügen',
                'manageTeachersTooltip': 'Lehrer hinzufügen und bearbeiten',
                'addSubjectTooltip': 'Fach hinzufügen',
                'addTeacherTooltip': 'Lehrer hinzufügen',
                'addRoomTooltip': 'Raum hinzufügen',
                'dataManagement': 'Datenverwaltung',
                'dataManagementTooltip': 'Verwalte deine Stundenplandaten.',
                'weeklyPlan': 'Wochenplan',
                'analysisTooltip': 'Detaillierte Statistiken und Auswertungen deines Stundenplans. Alle Daten basieren auf der aktuell angezeigten Woche.',
                'analysisSubtitle': 'Statistiken und Auswertungen deines Stundenplans'
            }
        };

        // Translation function
        function t(key) {
            const lang = settingsState.language || 'en';
            return translations[lang][key] || translations['en'][key] || key;
        }

        // Update UI text function
        function updateUIText() {
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });
            
            // Update tooltips
            document.querySelectorAll('[data-i18n-tooltip]').forEach(el => {
                const key = el.getAttribute('data-i18n-tooltip');
                const tooltip = el.querySelector('.tooltip-text');
                if (tooltip) tooltip.textContent = t(key);
            });
            
            // Update select options
            document.querySelectorAll('option[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.textContent = t(key);
            });
        }

        function loadSettingsState() {
            try {
                const saved = localStorage.getItem('appSettings');
                if (saved) {
                    Object.assign(settingsState, JSON.parse(saved));
                }
            } catch (e) {
                console.warn('Failed to load settings:', e);
            }
        }

        function saveSettingsState() {
            try {
                localStorage.setItem('appSettings', JSON.stringify(settingsState));
            } catch (e) {
                console.warn('Failed to save settings:', e);
            }
        }

        function applySettingsState() {
            // Apply settings to UI
            const autoSaveToggle = byId('autoSaveToggle');
            const redlineToggle = byId('redlineToggle');
            const tooltipsToggle = byId('tooltipsToggle');
            const dragDropToggle = byId('dragDropToggle');
            const compactViewToggle = byId('compactViewToggle');
            const animationsToggle = byId('animationsToggle');
            const weekNavToggle = byId('weekNavToggle');
            const debugModeToggle = byId('debugModeToggle');
            const autoBackupToggle = byId('autoBackupToggle');
            const performanceModeToggle = byId('performanceModeToggle');

            if (autoSaveToggle) autoSaveToggle.checked = settingsState.autoSave;
            if (redlineToggle) redlineToggle.checked = settingsState.redline;
            if (tooltipsToggle) tooltipsToggle.checked = settingsState.tooltips;
            if (dragDropToggle) dragDropToggle.checked = settingsState.dragDrop;
            if (compactViewToggle) compactViewToggle.checked = settingsState.compactView;
            if (animationsToggle) animationsToggle.checked = settingsState.animations;
            if (weekNavToggle) weekNavToggle.checked = settingsState.weekNav;
            if (debugModeToggle) debugModeToggle.checked = settingsState.debugMode;
            if (autoBackupToggle) autoBackupToggle.checked = settingsState.autoBackup;
            if (performanceModeToggle) performanceModeToggle.checked = settingsState.performanceMode;

            // Apply visual effects
            document.body.classList.toggle('compact-view', settingsState.compactView);
            document.body.classList.toggle('no-animations', !settingsState.animations);
            document.body.classList.toggle('performance-mode', settingsState.performanceMode);
        }

        function initializeSettingsToggles() {
            // Load and apply settings
            loadSettingsState();
            applySettingsState();
            
            // Initialize language selector
            const languageSelector = byId('languageSelector');
            if (languageSelector) {
                languageSelector.value = settingsState.language || 'en';
                languageSelector.addEventListener('change', (e) => {
                    settingsState.language = e.target.value;
                    saveSettingsState();
                    updateUIText();
                });
            }

            // Add event listeners for all toggles
            const toggles = [
                'autoSaveToggle', 'redlineToggle', 'tooltipsToggle', 'dragDropToggle',
                'compactViewToggle', 'animationsToggle', 'weekNavToggle',
                'debugModeToggle', 'autoBackupToggle', 'performanceModeToggle'
            ];

            toggles.forEach(toggleId => {
                const toggle = byId(toggleId);
                if (toggle) {
                    toggle.addEventListener('change', (e) => {
                        const settingKey = toggleId.replace('Toggle', '');
                        settingsState[settingKey] = e.target.checked;
                        saveSettingsState();
                        applySettingsState();
                        
                        // Apply specific settings
                        if (settingKey === 'redline') {
                            // Toggle redline visibility
                            const redlineElements = document.querySelectorAll('.redline');
                            redlineElements.forEach(el => {
                                el.style.display = settingsState.redline ? 'block' : 'none';
                            });
                        }
                        
                        if (settingKey === 'tooltips') {
                            // Toggle tooltips visibility
                            const tooltipElements = document.querySelectorAll('.info-tooltip');
                            tooltipElements.forEach(el => {
                                el.style.display = settingsState.tooltips ? 'inline-block' : 'none';
                            });
                        }
                    });
                }
            });
        }

        function updateLastBackupTime() {
            const lastBackupTimeEl = byId('lastBackupTime');
            if (lastBackupTimeEl) {
                const lastBackup = localStorage.getItem('lastBackupTime');
                if (lastBackup) {
                    const date = new Date(lastBackup);
                    lastBackupTimeEl.textContent = date.toLocaleString('de-DE');
                } else {
                    lastBackupTimeEl.textContent = 'Nie';
                }
            }
        }

        function initializeSettingsActions() {
            // Update backup time display
            updateLastBackupTime();
            
            // Reset settings button
            byId('resetSettingsBtn')?.addEventListener('click', () => {
                if (confirm(t('resetSettingsConfirm'))) {
                    Object.keys(settingsState).forEach(key => {
                        settingsState[key] = key === 'autoSave' || key === 'redline' || key === 'tooltips' || 
                                          key === 'dragDrop' || key === 'animations' || key === 'weekNav' || 
                                          key === 'autoBackup' ? true : false;
                    });
                    saveSettingsState();
                    applySettingsState();
                    alert(t('settingsReset'));
                }
            });

            // Reset data button
            byId('resetDataBtn')?.addEventListener('click', () => {
                if (confirm('ALLE DATEN LÖSCHEN? Dies kann nicht rückgängig gemacht werden!')) {
                    resetAllTimetableSettings();
                    alert('Alle Daten wurden gelöscht.');
                }
            });

            // Export data button
            byId('exportDataBtn')?.addEventListener('click', () => {
                try {
                    const data = {
                        state: state,
                        dataState: dataState,
                        folderState: folderState,
                        weekPlans: Object.fromEntries(weekPlans),
                        settings: settingsState
                    };
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `stunova-backup-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    // Update last backup time
                    localStorage.setItem('lastBackupTime', new Date().toISOString());
                    updateLastBackupTime();
                } catch (e) {
                    alert('Fehler beim Exportieren der Daten.');
                }
            });

            // Import data button
            byId('importDataBtn')?.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const data = JSON.parse(e.target.result);
                                if (confirm('Daten importieren? Bestehende Daten werden überschrieben.')) {
                                    if (data.state) Object.assign(state, data.state);
                                    if (data.dataState) Object.assign(dataState, data.dataState);
                                    if (data.folderState) Object.assign(folderState, data.folderState);
                                    if (data.weekPlans) {
                                        weekPlans.clear();
                                        Object.entries(data.weekPlans).forEach(([key, value]) => {
                                            weekPlans.set(key, value);
                                        });
                                    }
                                    if (data.settings) Object.assign(settingsState, data.settings);
                                    
                                    savePlan();
                                    saveData();
                                    saveFolders();
                                    saveWeekPlans();
                                    saveSettingsState();
                                    
                                    renderGrid();
                                    renderOverview();
                                    renderFolders();
                                    applySettingsState();
                                    
                                    alert('Daten erfolgreich importiert.');
                                }
                            } catch (e) {
                                alert('Fehler beim Importieren der Daten.');
                            }
                        };
                        reader.readAsText(file);
                    }
                };
                input.click();
            });
        }
        function savePlan() { 
            try { 
                localStorage.setItem(LS_PLAN, JSON.stringify(state)); 
                saveCurrentWeekPlan();
                saveWeekPlans();
            } catch { } 
        }
        
        function saveWeekPlans() {
            try {
                const weekPlansObj = Object.fromEntries(weekPlans);
                localStorage.setItem('weekPlans', JSON.stringify(weekPlansObj));
            } catch (e) {
                console.warn('Failed to save weekPlans:', e);
            }
        }
        
        function validateAndFixTimeSlots(plan) {
            if (!plan.timeSlots || !Array.isArray(plan.timeSlots)) {
                return false;
            }
            
            // Check if time slots are corrupted (starting at wrong time or invalid values)
            const hasCorruptedSlots = plan.timeSlots.some(slot => {
                if (!slot || typeof slot.startTime !== 'number' || typeof slot.endTime !== 'number') {
                    return true;
                }
                
                // Check if start time is invalid (negative or exceeds 24:00)
                if (slot.startTime < 0 || slot.startTime >= 24 * 60) {
                    return true;
                }
                
                // Check if end time is invalid or exceeds 23:59
                if (slot.endTime <= slot.startTime || slot.endTime >= 24 * 60) {
                    return true;
                }
                
                return false;
            });
            
            if (hasCorruptedSlots) {
                console.warn('Corrupted time slots detected, resetting to default');
                return false;
            }
            
            return true;
        }
        
        function resetTimeSlotsForWeek(weekKey) {
            const plan = weekPlans.get(weekKey);
            if (!plan) return;
            
            // Reset to default time slots starting at plan.dayStart
            plan.timeSlots = [];
            plan.periodCount = 8; // Default period count
            
            // Generate default time slots starting from plan.dayStart
            const block = state.periodMinutes + state.breakMinutes;
            for (let i = 0; i < plan.periodCount; i++) {
                const startTime = i * block; // This starts at 0 (relative to plan.dayStart)
                const endTime = startTime + state.periodMinutes;
                
                // Calculate absolute time to check if it exceeds midnight
                const absoluteStartTime = plan.dayStart.h * 60 + plan.dayStart.m + startTime;
                const absoluteEndTime = plan.dayStart.h * 60 + plan.dayStart.m + endTime;
                
                // Ensure we don't exceed 23:59 (max time in a day)
                if (absoluteEndTime >= 24 * 60) {
                    console.warn('Time slot would exceed 23:59, stopping at', i, 'periods');
                    plan.periodCount = i;
                    break;
                }
                
                plan.timeSlots.push({
                    startTime: startTime,
                    endTime: endTime,
                    label: timeLabelFromMinutes(plan.dayStart, startTime)
                });
            }
            
            console.log('Reset time slots for week:', weekKey, 'starting at', plan.dayStart.h + ':' + String(plan.dayStart.m).padStart(2, '0'));
            saveWeekPlans();
        }
        
        function fixAllCorruptedTimeSlots() {
            console.log('Checking all weeks for corrupted time slots...');
            let fixedCount = 0;
            
            // Check if weekPlans exists and has entries
            if (!weekPlans || weekPlans.size === 0) {
                console.log('No week plans found');
                return;
            }
            
            for (const [weekKey, plan] of weekPlans.entries()) {
                console.log('Checking week:', weekKey, 'has timeSlots:', !!plan.timeSlots);
                
                if (plan.timeSlots && !validateAndFixTimeSlots(plan)) {
                    console.log('Fixing corrupted time slots for week:', weekKey);
                    resetTimeSlotsForWeek(weekKey);
                    fixedCount++;
                } else if (!plan.timeSlots) {
                    console.log('Week has no timeSlots, creating default ones:', weekKey);
                    resetTimeSlotsForWeek(weekKey);
                    fixedCount++;
                }
            }
            
            if (fixedCount > 0) {
                console.log(`Fixed ${fixedCount} weeks with corrupted time slots`);
                // Re-render the current grid
                renderGrid();
            } else {
                console.log('No corrupted time slots found');
            }
        }
        
        function resetAllTimetableSettings() {
            console.log('Resetting all timetable settings...');
            
            // Reset state to defaults
            state.days = [...defaultDays];
            state.periodMinutes = periodMinutesDefault;
            state.breakMinutes = breakMinutesDefault;
            state.periodCount = 8;
            state.lessons = [];
            
            // Clear all week plans
            weekPlans.clear();
            
            // Reset current week to current week
            currentPlanWeek = getCurrentWeekKey();
            currentHeatmapWeek = getCurrentWeekKey();
            currentWeekOffset = 0;
            
            // Create fresh week plan for current week
            getOrCreateWeekPlan(currentPlanWeek);
            
            // Save everything
            savePlan();
            saveWeekPlans();
            
            // Update displays
            updatePlanWeekDisplay();
            updateWeekDisplay();
            
            // Re-render
            renderGrid();
            renderOverview();
            
            console.log('All timetable settings reset to defaults');
            console.log('Timetable now starts at:', dayStart.h + ':' + String(dayStart.m).padStart(2, '0'));
        }
        
        function resetOnlyTimeSlots() {
            console.log('Resetting only time slots while preserving other settings...');
            
            // Keep existing settings but reset time slots
            for (const [weekKey, plan] of weekPlans.entries()) {
                resetTimeSlotsForWeek(weekKey);
            }
            
            // Save week plans
            saveWeekPlans();
            
            // Re-render
            renderGrid();
            
            console.log('Time slots reset while preserving other settings');
        }
        function saveData() { try { localStorage.setItem(LS_DATA, JSON.stringify(dataState)); } catch { } }
        function saveFolders() { try { localStorage.setItem(LS_FOLDERS, JSON.stringify(folderState.folders)); } catch { } }

        /* =================== NAV =================== */
        const pageOverview = byId('pageOverview'),
            pagePlan = byId('pagePlan'),
            pageAnalysis = byId('pageAnalysis'),
            pageFolders = byId('pageFolders'),
            pageSettings = byId('pageSettings');

        // Page transition system
        let currentPage = sessionStorage.getItem('lastActivePage') || 'pageOverview';
        const pageOrder = ['pageOverview', 'pagePlan', 'pageAnalysis', 'pageFolders', 'pageSettings'];
        
        function slideToPage(targetPageId) {
            if (targetPageId === currentPage) return;
            
            const currentPageEl = byId(currentPage);
            const targetPageEl = byId(targetPageId);
            
            if (!currentPageEl || !targetPageEl) return;
            
            // Simple instant switch for now
            currentPageEl.classList.remove('active');
            currentPageEl.hidden = true;
            
            targetPageEl.hidden = false;
            targetPageEl.classList.add('active');
            
            currentPage = targetPageId;
            sessionStorage.setItem('lastActivePage', targetPageId);
        }

        function resetAllPills() {
            document.querySelectorAll('.nav-island .pill').forEach(p => {
                p.classList.remove('primary');
                p.style.background = '';
                p.style.color = '';
                p.style.opacity = '';
                p.style.transform = '';
                p.style.boxShadow = '';
            });
        }

        function activatePill(btn) {
            if (!btn) return;
            
            // Only reset if the target pill is not already active
            if (!btn.classList.contains('primary')) {
                resetAllPills();
            }
            
            // Add primary class to selected pill
            btn.classList.add('primary');
        }

        byId('navOverview')?.addEventListener('click', e => {
            activatePill(e.currentTarget);
            slideToPage('pageOverview');
            updateWeekDisplay(); // Update overview week display independently
            renderOverview(); // Ensure overview is rendered when switching to Overview
        });

        // Week navigation event listeners
        function attachWeekNavigationListeners() {
            const weekBackBtn = byId('weekBack');
            const weekForwardBtn = byId('weekForward');
            
            if (weekBackBtn) {
                weekBackBtn.addEventListener('click', (e) => {
            e.stopPropagation();
                    console.log('Week back clicked');
            const btn = e.target.closest('button');
            if (btn) {
                btn.style.transform = 'scale(0.95)';
                setTimeout(() => btn.style.transform = '', 150);
            }
            navigateWeek(-1);
        });
            } else {
                console.warn('weekBack button not found');
            }
            
            if (weekForwardBtn) {
                weekForwardBtn.addEventListener('click', (e) => {
            e.stopPropagation();
                    console.log('Week forward clicked');
            const btn = e.target.closest('button');
            if (btn) {
                btn.style.transform = 'scale(0.95)';
                setTimeout(() => btn.style.transform = '', 150);
            }
            navigateWeek(1);
        });
            } else {
                console.warn('weekForward button not found');
            }
        }
        
        attachWeekNavigationListeners();
        
        // Current week navigation for overview (heatmap only)
        byId('goToCurrentWeek')?.addEventListener('click', (e) => {
            e.stopPropagation();
            // Reset heatmap to current week (independent from plan timetable)
            currentHeatmapWeek = getCurrentWeekKey();
            overviewWeekKey = getCurrentWeekKey(); // Keep overview in sync
            try {
                localStorage.setItem('currentHeatmapWeek', currentHeatmapWeek);
                localStorage.setItem('overviewWeekKey', overviewWeekKey);
            } catch (e) {
                console.warn('Failed to save week keys:', e);
            }
            updateWeekDisplay();
            renderOverview();
        });
        
        // Current week navigation for plan
        byId('goToCurrentPlanWeek')?.addEventListener('click', (e) => {
            e.stopPropagation();
            const currentWeekKey = getCurrentWeekKey();
            switchToWeekPlan(currentWeekKey);
            
            // Update both displays (plan and heatmap)
            updatePlanWeekDisplay();
            updateWeekDisplay();
        });
        
        
        
        // Plan week navigation event listeners
        function attachPlanWeekNavigationListeners() {
            const planWeekBackBtn = byId('planWeekBack');
            const planWeekForwardBtn = byId('planWeekForward');
            
            if (planWeekBackBtn) {
                planWeekBackBtn.addEventListener('click', (e) => {
                    console.log('Plan week back clicked');
            const btn = e.target.closest('button');
            if (btn) {
                btn.style.transform = 'scale(0.95)';
                        btn.style.opacity = '0.7';
                        setTimeout(() => {
                            btn.style.transform = '';
                            btn.style.opacity = '';
                        }, 150);
            }
            navigatePlanWeek(-1);
        });
            } else {
                console.warn('planWeekBack button not found');
            }
            
            if (planWeekForwardBtn) {
                planWeekForwardBtn.addEventListener('click', (e) => {
                    console.log('Plan week forward clicked');
            const btn = e.target.closest('button');
            if (btn) {
                btn.style.transform = 'scale(0.95)';
                        btn.style.opacity = '0.7';
                        setTimeout(() => {
                            btn.style.transform = '';
                            btn.style.opacity = '';
                        }, 150);
            }
            navigatePlanWeek(1);
        });
            } else {
                console.warn('planWeekForward button not found');
            }
        }
        
        attachPlanWeekNavigationListeners();
        
        // Timetable structure panel week navigation event listeners
        function attachTimetableWeekNavigationListeners() {
            const timetableWeekBackBtn = byId('timetableWeekBack');
            const timetableWeekForwardBtn = byId('timetableWeekForward');
            
            if (timetableWeekBackBtn) {
                timetableWeekBackBtn.addEventListener('click', (e) => {
                    console.log('Timetable week back clicked');
                    const btn = e.target.closest('button');
                    if (btn) {
                        btn.style.transform = 'scale(0.95)';
                        btn.style.opacity = '0.7';
                        setTimeout(() => {
                            btn.style.transform = '';
                            btn.style.opacity = '';
                        }, 150);
                    }
                    navigatePlanWeek(-1);
                });
            } else {
                console.warn('timetableWeekBack button not found');
            }
            
            if (timetableWeekForwardBtn) {
                timetableWeekForwardBtn.addEventListener('click', (e) => {
                    console.log('Timetable week forward clicked');
                    const btn = e.target.closest('button');
                    if (btn) {
                        btn.style.transform = 'scale(0.95)';
                        btn.style.opacity = '0.7';
                        setTimeout(() => {
                            btn.style.transform = '';
                            btn.style.opacity = '';
                        }, 150);
                    }
                    navigatePlanWeek(1);
                });
            } else {
                console.warn('timetableWeekForward button not found');
            }
        }
        
        attachTimetableWeekNavigationListeners();

        byId('navPlan')?.addEventListener('click', e => {
            activatePill(e.currentTarget);
            slideToPage('pagePlan');
            
            // Initialize current week plan if not exists
            if (!weekPlans.has(currentPlanWeek)) {
                getOrCreateWeekPlan(currentPlanWeek);
                // Copy current state to the week plan
                saveCurrentWeekPlan();
            }
            
            updatePlanWeekDisplay();
            renderGrid(); // Ensure grid is rendered when switching to Plan
            updatePlanSettingsForCurrentWeek(); // Update plan settings with current week's values
        });

        byId('navAnalysis')?.addEventListener('click', e => {
            activatePill(e.currentTarget);
            slideToPage('pageAnalysis');
            renderAnalysis();
        });

        byId('navFolders')?.addEventListener('click', e => {
            activatePill(e.currentTarget);
            slideToPage('pageFolders');
            renderFolders();
        });

        byId('navSettings')?.addEventListener('click', e => {
            activatePill(e.currentTarget);
            slideToPage('pageSettings');
            // fülle Settings Felder
            populateSettingsInputs();
            initializeSettingsControls(); // Initialize new interactive controls
            renderSettingsStats(); // Update settings stats cards
            initializeSettingsToggles(); // Initialize toggle switches
            initializeSettingsActions(); // Initialize action buttons
        });
        function findPresetForSubject(subj) {
            const s = (subj || '').trim();
            if (!s) return null;
            // exact match first, then case-insensitive
            let p = (dataState.presets || []).find(x => x.subject === s);
            if (!p) p = (dataState.presets || []).find(x => (x.subject || '').toLowerCase() === s.toLowerCase());
            return p || null;
        }
        /* =================== PLAN (grid etc.) =================== */
        const gridEl = byId('grid'); const currentWrap = byId('currentWrap'); let redlineTip = null; let isResizing = false;

        function regenerateTimeSlotsForPeriodCount(plan) {
            // Regenerate ALL time slots based on current periodCount, periodMinutes, and breakMinutes
            const block = plan.periodMinutes + plan.breakMinutes;
            plan.timeSlots = [];
            
            console.log('=== REGENERATING TIME SLOTS ===');
            console.log('Plan values:', {
                periodMinutes: plan.periodMinutes,
                breakMinutes: plan.breakMinutes,
                block: block,
                periodCount: plan.periodCount
            });
            console.log('plan.dayStart:', plan.dayStart);
            
            for (let i = 0; i < plan.periodCount; i++) {
                const startTime = i * block;
                const endTime = startTime + plan.periodMinutes;
                
                // Calculate absolute time to check if it exceeds midnight
                const absoluteStartTime = plan.dayStart.h * 60 + plan.dayStart.m + startTime;
                const absoluteEndTime = plan.dayStart.h * 60 + plan.dayStart.m + endTime;
                
                // Ensure we don't exceed 23:59 (max time in a day)
                if (absoluteEndTime >= 24 * 60) {
                    console.warn('Time slot would exceed 23:59, stopping at', i, 'periods');
                    plan.periodCount = i;
                    break;
                }
                
                const slot = {
                    startTime: startTime,
                    endTime: endTime
                };
                
                plan.timeSlots.push(slot);
                
                const startLabel = timeLabelFromMinutes(plan.dayStart, startTime);
                const endLabel = timeLabelFromMinutes(plan.dayStart, endTime);
                console.log(`Slot ${i}: ${startLabel} - ${endLabel} (startTime: ${startTime}, endTime: ${endTime})`);
            }
            
            // Remove any lessons that are now outside the valid period range
            plan.lessons = plan.lessons.filter(lesson => 
                lesson.startIndex < plan.periodCount && 
                lesson.startIndex + lesson.span <= plan.periodCount
            );
            
            console.log('=== TIME SLOTS REGENERATED ===');
            console.log('Final count:', plan.timeSlots.length, 'slots');
        }

        function resetAllTimeSlots() {
            // Reset time slots for all weeks to ensure consistency
            console.log('Resetting all time slots to fix inconsistencies...');
            
            weekPlans.forEach((plan, weekKey) => {
                console.log(`Resetting time slots for week: ${weekKey}`);
                regenerateTimeSlotsForPeriodCount(plan);
            });
            
            // Save and re-render
            saveWeekPlans();
            renderGrid();
            renderOverview();
            
            console.log('All time slots have been reset and regenerated');
        }

        function generatePeriods() {
            // Always use current plan values for consistency
            const plan = weekPlans.get(currentPlanWeek);
            if (!plan) {
                console.warn('No plan found for current week:', currentPlanWeek);
                return [];
            }

            console.log('=== GENERATING PERIODS ===');
            console.log('Using plan values:', {
                periodMinutes: plan.periodMinutes,
                breakMinutes: plan.breakMinutes,
                periodCount: plan.periodCount
            });

            const block = plan.periodMinutes + plan.breakMinutes;
            const periods = [];

            for (let i = 0; i < plan.periodCount; i++) {
                const startMin = i * block;
                const endMin = startMin + plan.periodMinutes;
                
                const period = {
                    startMin: startMin,
                    endMin: endMin,
                    startLabel: timeLabelFromMinutes(plan.dayStart, startMin),
                    endLabel: timeLabelFromMinutes(plan.dayStart, endMin)
                };
                
                periods.push(period);
                console.log(`Period ${i}: ${period.startLabel} - ${period.endLabel}`);
            }

            console.log('=== PERIODS GENERATED ===');
            console.log('Total periods:', periods.length);
            return periods;
        }
        function renderGrid() {
            console.log('=== RENDERING GRID ===');
            
            // Get the current week plan
            const currentPlan = getOrCreateWeekPlan(currentPlanWeek);
            if (!gridEl) {
                console.warn('Grid element not found');
                return;
            }
            
            console.log('Current plan:', {
                periodMinutes: currentPlan.periodMinutes,
                breakMinutes: currentPlan.breakMinutes,
                periodCount: currentPlan.periodCount,
                days: currentPlan.days
            });
            
            // Clear grid
            gridEl.innerHTML = '';
            gridEl.style.setProperty('--day-count', currentPlan.days.length);
            gridEl.classList.add('has-days');
            
            // Add headers
            gridEl.appendChild(div('head time', 'Zeit'));
            currentPlan.days.forEach(d => gridEl.appendChild(div('head', d)));

            // Generate and render time periods
            const periods = generatePeriods();
            console.log('Generated periods:', periods.length);
            
            const timeCol = div('time-col');
            periods.forEach((p, index) => {
                const cell = div('time-cell');
                
                // Add period number (left side)
                const periodNumber = document.createElement('div');
                periodNumber.textContent = (index + 1).toString();
                periodNumber.style.fontSize = '14px';
                periodNumber.style.opacity = '0.7';
                periodNumber.style.fontWeight = '600';
                periodNumber.style.position = 'absolute';
                periodNumber.style.left = '8px';
                periodNumber.style.top = '50%';
                periodNumber.style.transform = 'translateY(-50%)';
                periodNumber.style.textAlign = 'left';
                periodNumber.style.width = 'auto';
                
                // Add time labels (right side)
                const top = document.createElement('div');
                top.textContent = p.startLabel;
                top.style.fontSize = '15px';
                top.style.fontWeight = '600';
                top.style.position = 'absolute';
                top.style.right = '4px';
                top.style.top = '4px';
                
                const bottom = document.createElement('div');
                bottom.textContent = p.endLabel;
                bottom.style.fontSize = '13px';
                bottom.style.opacity = '0.8';
                bottom.style.position = 'absolute';
                bottom.style.right = '4px';
                bottom.style.bottom = '4px';
                
                cell.style.position = 'relative';
                cell.append(periodNumber, top, bottom);
                timeCol.appendChild(cell);
                
                console.log(`Rendered time cell ${index + 1}: ${p.startLabel} - ${p.endLabel}`);
            });
            gridEl.appendChild(timeCol);

            if (!redlineTip) { redlineTip = document.createElement('div'); redlineTip.className = 'redline-tip'; redlineTip.hidden = true; gridEl.parentElement.appendChild(redlineTip); }

            const currentTime = new Date();
            const dayOfWeek = currentTime.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            const today = (dayOfWeek + 6) % 7; // Mo=0..Fr=4 (school days only)
            const block = currentPlan.periodMinutes + currentPlan.breakMinutes;
            const lastBlockEnd = currentPlan.periodCount * block - currentPlan.breakMinutes;

            const currentWeekKey = getCurrentWeekKey();

            function isDayCompleted(dayIndex) {
                const cmp = weekKeyCompare(currentPlanWeek, currentWeekKey);
                
                // Future weeks should never show completed days
                if (cmp > 0) return false;
                
                // Past weeks show all days as completed
                if (cmp < 0) return true;
                
                // If it's weekend (Saturday or Sunday), don't mark any days as completed
                // because we're showing the upcoming week
                if (dayOfWeek === 0 || dayOfWeek === 6) return false;
                
                // Current week: only show completed for past days
                if (dayIndex < today) return true;
                
                // Today: only show completed if school day is completely finished
                if (dayIndex === today && minutesSinceStart(new Date()) >= lastBlockEnd) return true;
                
                return false;
            }

            currentPlan.days.forEach((_, dayIndex) => {
                const dayCol = div('day-col');
                const occ = new Set(); currentPlan.lessons.filter(l => l.day === dayIndex).forEach(l => { for (let i = 0; i < l.span; i++)occ.add(l.startIndex + i); });
                periods.forEach((_, pIdx) => {
                    const cell = div('cell'); cell.dataset.day = String(dayIndex); cell.dataset.period = String(pIdx);
                    const add = document.createElement('button'); add.className = 'add'; add.title = 'Fach hinzufügen'; add.textContent = '+';
                    if (occ.has(pIdx)) add.hidden = true;
                    add.addEventListener('click', e => { e.stopPropagation(); openCreate(dayIndex, pIdx); });
                    cell.appendChild(add);

                    cell.addEventListener('dragover', e => { e.preventDefault(); cell.classList.add('over'); });
                    cell.addEventListener('dragleave', () => cell.classList.remove('over'));
                    cell.addEventListener('drop', e => {
                        e.preventDefault(); cell.classList.remove('over');
                        const id = e.dataTransfer?.getData('text/plain'); if (!id) return;
                        const idx = currentPlan.lessons.findIndex(l => l.id === id); if (idx < 0) return;
                        const l = { ...currentPlan.lessons[idx] }; l.day = dayIndex; l.startIndex = clamp(pIdx, 0, currentPlan.periodCount - 1); l.span = Math.min(l.span, currentPlan.periodCount - l.startIndex);
                        const next = [...currentPlan.lessons]; next[idx] = l; currentPlan.lessons = resolveCollisions(next, currentPlan.periodCount); 
                        // Sync state.lessons with currentPlan.lessons for immediate "Als Nächstes" updates
                        state.lessons = [...currentPlan.lessons];
                        saveCurrentWeekPlan(); renderGrid();
                    });
                    dayCol.appendChild(cell);
                });

                currentPlan.lessons.filter(l => l.day === dayIndex).forEach(l => dayCol.appendChild(renderLesson(l)));

                // red line
                const now = new Date(); const weekday = ((now.getDay() + 6) % 7); const withinDay = minutesSinceStart(now);
                const totalSpan = currentPlan.periodCount * (currentPlan.periodMinutes + currentPlan.breakMinutes);
                const showRed = weekday < currentPlan.days.length && withinDay >= 0 && withinDay <= totalSpan;
                if (showRed && weekday === dayIndex) {
                    const rowH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-h'));
                    // Use fixed 60-minute intervals for redline positioning to prevent movement when sliders change
                    const fixedBlockSize = 60; // Always use 60 minutes as base unit
                    const top = clamp((withinDay / fixedBlockSize) * rowH, 0, currentPlan.periodCount * rowH);
                    const rl = div('redline'); rl.style.top = top + 'px'; dayCol.appendChild(rl);
                    const updateTipText = () => { const now2 = new Date(); redlineTip.textContent = now2.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }); };
                    rl.addEventListener('mouseenter', () => { updateTipText(); redlineTip.hidden = false; const rect = dayCol.getBoundingClientRect(); redlineTip.style.left = (rect.left + rect.width / 2 + window.scrollX) + 'px'; redlineTip.style.top = (rl.getBoundingClientRect().top + window.scrollY - 6) + 'px'; });
                    rl.addEventListener('mousemove', () => { updateTipText(); const rect = dayCol.getBoundingClientRect(); redlineTip.style.left = (rect.left + rect.width / 2 + window.scrollX) + 'px'; redlineTip.style.top = (rl.getBoundingClientRect().top + window.scrollY - 6) + 'px'; });
                    rl.addEventListener('mouseleave', () => redlineTip.hidden = true);
                }
                gridEl.appendChild(dayCol);
            });
        }
        function renderLesson(lesson) {
            const currentPlan = getOrCreateWeekPlan(currentPlanWeek);
            const rowH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--row-h'));
            const el = div('lesson'); el.style.top = (lesson.startIndex * rowH + 2) + 'px'; el.style.height = (lesson.span * rowH - 8) + 'px'; el.style.color = lesson.color || '#60a5fa';
            el.setAttribute('data-span', String(lesson.span)); el.title = `${lesson.subject} (${lesson.span}×)`; el.draggable = true;

            // Add importance class if lesson is marked as important
            if (lesson.importance) {
                el.classList.add('important');
            }

            el.addEventListener('dragstart', (e) => {
                if (el.classList.contains('resizing')) { e.preventDefault(); return; }
                e.dataTransfer?.setData('text/plain', lesson.id); el.classList.add('dragging');
                const g = el.cloneNode(true); g.style.width = (el.getBoundingClientRect().width) + 'px'; g.style.height = (el.getBoundingClientRect().height) + 'px';
                g.style.position = 'absolute'; g.style.top = '-1000px'; g.style.left = '-1000px'; g.style.transform = 'none'; g.classList.remove('dragging'); g.style.opacity = '1'; g.style.boxShadow = '0 6px 24px rgba(0,0,0,.12)';
                document.body.appendChild(g); e.dataTransfer.setDragImage(g, 20, 20); setTimeout(() => document.body.removeChild(g), 0);
            });
            el.addEventListener('dragend', () => el.classList.remove('dragging'));
            el.addEventListener('click', () => { if (el.classList.contains('resizing')) return; openInfo(lesson.id); });
            el.addEventListener('contextmenu', (e) => { e.preventDefault(); if (el.classList.contains('resizing')) return; openEdit(lesson.id); });

            const row = div('row'); const left = div(); const subj = div('subject', lesson.subject); const sub = div('sub', lesson.teacher || ''); left.append(subj, sub);
            const room = div('room', lesson.room || ''); row.append(left, room);
            const block = currentPlan.periodMinutes + currentPlan.breakMinutes;
            const endLabel = timeLabelFromMinutes(currentPlan.dayStart, (lesson.startIndex * block) + (lesson.span * currentPlan.periodMinutes));
            const footer = div('footer', `${endLabel}`);
            const colorbar = div('colorbar'); const resizer = div('resizer');
            let resizing = false; let draftSpan = lesson.span;

            function maxEndIndexForResize(base) { const nextStart = currentPlan.lessons.filter(l => l.day === base.day && l.id !== base.id && l.startIndex >= base.startIndex).reduce((min, l) => Math.min(min, l.startIndex), currentPlan.periodCount); return nextStart; }
            const onMove = (ev) => {
                if (!resizing) return; const parent = el.parentElement; if (!parent) return; const rect = parent.getBoundingClientRect();
                const y = ev.clientY - rect.top; const rawEnd = Math.ceil((y - 2) / rowH); const maxEnd = maxEndIndexForResize(lesson); const endIndex = clamp(rawEnd, lesson.startIndex + 1, maxEnd);
                const newSpan = endIndex - lesson.startIndex; if (newSpan !== draftSpan) { draftSpan = newSpan; el.style.height = (draftSpan * rowH - 8) + 'px'; footer.textContent = timeLabelFromMinutes(currentPlan.dayStart, (lesson.startIndex * block) + (draftSpan * currentPlan.periodMinutes)); updatePlusButtonsDuringResize(parent, lesson.startIndex, draftSpan); }
            };
            const onUp = () => {
                if (!resizing) return; resizing = false; isResizing = false; window.removeEventListener('mousemove', onMove); el.classList.remove('resizing'); el.draggable = true; document.body.style.userSelect = '';
                const updated = { ...lesson, span: draftSpan }; currentPlan.lessons = resolveCollisions(currentPlan.lessons.map(l => l.id === lesson.id ? updated : l), currentPlan.periodCount); 
                // Sync state.lessons with currentPlan.lessons for immediate "Als Nächstes" updates
                state.lessons = [...currentPlan.lessons];
                saveCurrentWeekPlan(); renderGrid();
            };
            resizer.addEventListener('mousedown', (e) => { e.stopPropagation(); e.preventDefault(); resizing = true; draftSpan = lesson.span; isResizing = true; el.classList.add('resizing'); el.draggable = false; document.body.style.userSelect = 'none'; window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp, { once: true }); });
            el.append(colorbar, row, footer, resizer); return el;
        }
        function updatePlusButtonsDuringResize(dayCol, startIndex, span) { const cells = [...dayCol.querySelectorAll('.cell')]; cells.forEach(c => { const btn = c.querySelector('.add'); if (btn) btn.hidden = false; }); for (let i = 0; i < span; i++) { const c = dayCol.querySelector(`.cell[data-period="${startIndex + i}"] .add`); if (c) c.hidden = true; } }
        function formatRange(l) { const currentPlan = getOrCreateWeekPlan(currentPlanWeek); const block = currentPlan.periodMinutes + currentPlan.breakMinutes; const startMin = l.startIndex * block; const endMin = startMin + l.span * currentPlan.periodMinutes; return `${timeLabelFromMinutes(currentPlan.dayStart, startMin)}–${timeLabelFromMinutes(currentPlan.dayStart, endMin)}`; }
        function hasOverlap(occ, day, start, span) { for (let i = 0; i < span; i++) if (occ.has(`${day}:${start + i}`)) return true; return false; }
        function occupiedSet(occ, day, start, span, l) { for (let i = 0; i < span; i++) occ.set(`${day}:${start + i}`, l); }
        function resolveCollisions(list, maxPeriods) { const arr = [...list].sort((a, b) => a.startIndex - b.startIndex); const occ = new Map(); for (const l of arr) { let s = l.startIndex; while (hasOverlap(occ, l.day, s, l.span)) s = Math.min(s + 1, maxPeriods - l.span); l.startIndex = s; occupiedSet(occ, l.day, s, l.span, l); } return [...arr]; }

        function currentLessonInfo() { const currentPlan = getOrCreateWeekPlan(currentPlanWeek); const now = new Date(); const weekday = ((now.getDay() + 6) % 7); const nowMin = minutesSinceStart(now); const block = currentPlan.periodMinutes + currentPlan.breakMinutes; const cand = currentPlan.lessons.filter(l => l.day === weekday); for (const l of cand) { const start = l.startIndex * block; const end = start + (l.span * currentPlan.periodMinutes); if (nowMin >= start && nowMin <= end) { const elapsed = Math.floor(nowMin - start); const total = end - start; return { l, elapsed, total, now }; } } return null; }
        function renderCurrent() {
            if (!currentWrap) return;
            const info = currentLessonInfo(); currentWrap.innerHTML = ''; if (!info) { return; }
            const box = div('card current'); const label = div(null, '<span style="font-weight:600;font-size:13px">Gerade:</span>'); label.style.flexShrink = '0';
            const content = div(); content.style.flex = '1'; const title = div('title', `${info.l.subject} <span style="color:#64748b;font-weight:600;font-size:13px">${formatRange(info.l)}</span>`);
            const bar = div('progress'); const fill = div(); fill.style.width = ((info.elapsed / info.total) * 100) + '%'; bar.append(fill);
            const meta = div('meta', `${info.elapsed} / ${info.total} Min · Raum ${info.l.room || '-'} · ${info.l.teacher || ''}`);
            content.append(title, bar, meta); const right = div('meta'); right.innerHTML = `${info.now.toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: '2-digit', day: '2-digit' })}<div style="font-size:18px;font-weight:800;color:#0f172a">${info.now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>`;
            box.append(label, content, right); currentWrap.appendChild(box);
        }

        /* INFO / EDIT / CREATE */
        const infoModal = byId('infoModal'); const iSubject = byId('iSubject'); const iTeacher = byId('iTeacher'); const iRoom = byId('iRoom'); const iDay = byId('iDay'); const iTime = byId('iTime'); const iDuration = byId('iDuration'); const infoColor = byId('infoColor'); const infoEditBtn = byId('infoEdit'); const infoDeleteBtn = byId('infoDelete'); let infoId = null;
        function openInfo(id) {
            const currentPlan = getOrCreateWeekPlan(currentPlanWeek);
            const l = currentPlan.lessons.find(x => x.id === id); if (!l) return; infoId = id; iSubject.textContent = l.subject || '—'; iTeacher.textContent = l.teacher || '—'; iRoom.textContent = l.room || '—'; iDay.textContent = currentPlan.days[l.day] ?? `Tag ${l.day + 1}`; iTime.textContent = formatRange(l); const totalMin = l.span * currentPlan.periodMinutes; iDuration.textContent = `${totalMin} Min (${l.span} × ${currentPlan.periodMinutes} Min)`; infoColor.style.background = l.color || '#e5e7eb';

            // Show/hide importance field
            const importanceField = byId('iImportanceField');
            if (l.importance) {
                importanceField.style.display = 'block';
            } else {
                importanceField.style.display = 'none';
            }

            showModal(infoModal, '[data-close]');
        }
        infoEditBtn.addEventListener('click', () => { if (!infoId) return; hideModal(infoModal); openEdit(infoId); });
        infoDeleteBtn.addEventListener('click', () => { if (!infoId) return; const id = infoId; infoId = null; removeLesson(id); });

        const editModal = byId('editModal'); const fSubject = byId('fSubject'); const fTeacherSel = byId('fTeacherSel'); const fRoom = byId('fRoom'); const fColor = byId('fColor'); const timePreview = byId('timePreview'); const roomList = byId('roomList'); let editId = null;
        function renderTeacherSelect(selected) {
            if (!fTeacherSel) return;
            fTeacherSel.innerHTML = ''; const optNone = document.createElement('option'); optNone.value = ''; optNone.textContent = '— (keine Auswahl)'; fTeacherSel.appendChild(optNone);
            dataState.teachers.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; if (selected && selected === t) o.selected = true; fTeacherSel.appendChild(o); });
            if (roomList) {
                roomList.innerHTML = ''; dataState.rooms.forEach(r => { const o = document.createElement('option'); o.value = r; roomList.appendChild(o); });
            }
        }
        function openEdit(id) {
            const currentPlan = getOrCreateWeekPlan(currentPlanWeek);
            const l = currentPlan.lessons.find(x => x.id === id); if (!l) return;
            isCreating = false; creatingDraft = null; editId = id;

            fSubject.value = l.subject || '';
            fRoom.value = l.room || '';
            renderTeacherSelect(l.teacher || '');

            const col = colorForSubject(l.subject) || l.color || '#60a5fa';
            if (fColorSwatch) fColorSwatch.style.background = col;

            // Set importance checkbox
            const fImportance = byId('fImportance');
            if (fImportance) fImportance.checked = !!l.importance;

            timePreview.textContent = `Zeit: ${formatRange(l)}`;

            document.querySelector('#editModal h2').textContent = 'Fach bearbeiten';
            byId('deleteLesson').style.display = '';
            byId('saveLesson').textContent = 'Speichern';

            showModal(editModal, '#fSubject');
        }

        // Whenever the subject changes in the modal, pull preset + color if available
        fSubject?.addEventListener('input', () => {
            const subj = (fSubject.value || '').trim();
            const p = findPresetForSubject(subj);
            if (p?.teacher) fTeacherSel.value = p.teacher;
            if (p?.room) fRoom.value = p.room;
            // set swatch only (no manual input)
            if (fColorSwatch) fColorSwatch.style.background = colorForSubject(subj);
        });

        function updateLessonFromForm() {
            const subject = (fSubject.value || '').trim() || 'Fach';
            const teacher = fTeacherSel.value || '';
            const room = (fRoom.value || '').trim();
            const color = colorForSubject(subject);
            const importance = byId('fImportance')?.checked || false;

            const currentPlan = getOrCreateWeekPlan(currentPlanWeek);
            
            if (isCreating && creatingDraft) {
                const l = {
                    id: uid(),
                    subject,
                    teacher,
                    room,
                    color,
                    day: creatingDraft.day,
                    startIndex: creatingDraft.startIndex,
                    span: creatingDraft.span,
                    importance
                };
                currentPlan.lessons = resolveCollisions([...currentPlan.lessons, l], currentPlan.periodCount);
                // Sync state.lessons with currentPlan.lessons for immediate "Als Nächstes" updates
                state.lessons = [...currentPlan.lessons];
                
                // Add activity
                addActivity('lesson_added', 'Stunde hinzugefügt', `${subject} am ${getDayName(creatingDraft.day)}`, 'plus');
            } else if (editId) {
                const l = currentPlan.lessons.find(x => x.id === editId); if (!l) return;
                const oldSubject = l.subject;
                l.subject = subject; l.teacher = teacher; l.room = room; l.color = color; l.importance = importance;
                currentPlan.lessons = currentPlan.lessons.map(x => x.id === l.id ? { ...l } : x);
                // Sync state.lessons with currentPlan.lessons for immediate "Als Nächstes" updates
                state.lessons = [...currentPlan.lessons];
                
                // Add activity
                addActivity('lesson_edited', 'Stunde bearbeitet', `${oldSubject} → ${subject}`, 'edit');
            }

            isCreating = false; creatingDraft = null; editId = null;
            saveCurrentWeekPlan(); renderGrid(); hideModal(editModal);
        }

        function currentOrNextLesson() {
            const now = new Date();
            const today = (now.getDay() + 6) % 7; // Mo=0
            const nowMin = minutesSinceStart(now);
            const currentWeekKey = getCurrentWeekKey();

            // 1) Check current week for lesson happening right now
            const currentPlan = weekPlans.get(currentWeekKey);
            if (currentPlan) {
                const block = currentPlan.periodMinutes + currentPlan.breakMinutes;
                const todayLs = currentPlan.lessons.filter(l => l.day === today);
                for (const l of todayLs) {
                    const start = l.startIndex * block;
                    const end = start + l.span * currentPlan.periodMinutes;
                    if (nowMin >= start && nowMin < end) {
                        return { type: "now", l, start, end, dayIndex: today, offset: 0 };
                    }
                }
            }

            // 2) Search for next lesson across ALL weeks
            const allUpcomingLessons = [];
            
            // Get all week keys and sort them chronologically
            const allWeekKeys = Array.from(weekPlans.keys()).sort((a, b) => weekKeyCompare(a, b));
            
            // Find current week index and check from there onwards
            const currentWeekIndex = allWeekKeys.findIndex(key => key === currentWeekKey);
            const weeksToCheck = allWeekKeys.slice(Math.max(0, currentWeekIndex));
            
            for (const weekKey of weeksToCheck) {
                const plan = weekPlans.get(weekKey);
                if (!plan || !plan.lessons.length) continue;
                
                const weekOffset = weekKeyCompare(weekKey, currentWeekKey);
                const block = plan.periodMinutes + plan.breakMinutes;
                
                for (const l of plan.lessons) {
                    const start = l.startIndex * block;
                    const end = start + l.span * plan.periodMinutes;
                    
                    // Skip if this is in the past (only for current week)
                    if (weekOffset === 0) {
                        if (l.day < today) continue;
                        if (l.day === today && start <= nowMin) continue;
                    }
                    
                    // Calculate actual day offset from today
                    const currentDay = (now.getDay() + 6) % 7; // Monday = 0
                    const daysFromToday = (weekOffset * 7) + l.day - currentDay;
                    
                    allUpcomingLessons.push({
                        l,
                        start,
                        end,
                        dayIndex: l.day,
                        offset: Math.max(0, daysFromToday)
                    });
                }
            }
            
            // Sort by week offset first, then by day, then by start time
            allUpcomingLessons.sort((a, b) => {
                if (a.offset !== b.offset) return a.offset - b.offset;
                if (a.dayIndex !== b.dayIndex) return a.dayIndex - b.dayIndex;
                return a.start - b.start;
            });
            
            if (allUpcomingLessons.length > 0) {
                return { type: "next", ...allUpcomingLessons[0] };
            }

            return null;
        }

        function findFolderForSubject(subject) {
            const s = (subject || "").trim().toLowerCase();
            return folderState.folders.find(f => (f.name || "").trim().toLowerCase() === s) || null;
        }



        function removeLesson(id) { 
            const currentPlan = getOrCreateWeekPlan(currentPlanWeek);
            const lesson = currentPlan.lessons.find(l => l.id === id);
            currentPlan.lessons = currentPlan.lessons.filter(l => l.id !== id); 
            // Sync state.lessons with currentPlan.lessons for immediate "Als Nächstes" updates
            state.lessons = [...currentPlan.lessons];
            saveCurrentWeekPlan(); 
            renderGrid(); 
            hideModal(editModal); 
            hideModal(infoModal);
            
            // Add activity
            if (lesson) {
                addActivity('lesson_deleted', 'Stunde gelöscht', `${lesson.subject} am ${getDayName(lesson.day)}`, 'trash');
            }
        }
        function openCreate(day, periodIndex) {
            const defaultSubject = dataState.subjects[0] || '';
            const preset = findPresetForSubject(defaultSubject);
            const suggestedColor = colorForSubject(defaultSubject);

            isCreating = true;
            creatingDraft = { day, startIndex: periodIndex, span: 1, color: suggestedColor };

            editId = null;
            fSubject.value = defaultSubject;
            renderTeacherSelect(preset?.teacher || '');
            fRoom.value = preset?.room || '';
            if (fColorSwatch) fColorSwatch.style.background = suggestedColor;

            // Reset importance checkbox
            const fImportance = byId('fImportance');
            if (fImportance) fImportance.checked = false;

            timePreview.textContent =
                `Zeit: ${timeLabelFromMinutes(dayStart, (periodIndex * (state.periodMinutes + state.breakMinutes)))}–` +
                `${timeLabelFromMinutes(dayStart, (periodIndex * (state.periodMinutes + state.breakMinutes)) + state.periodMinutes)}`;

            document.querySelector('#editModal h2').textContent = 'Fach anlegen';
            byId('deleteLesson').style.display = 'none';
            byId('saveLesson').textContent = 'Anlegen';

            showModal(editModal, '#fSubject');
        }

        byId('saveLesson')?.addEventListener('click', updateLessonFromForm);
        byId('deleteLesson')?.addEventListener('click', () => { if (editId) removeLesson(editId); });
        editModal.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); updateLessonFromForm(); } });

        // --- Activity Tracking System ---------------------------------
        
        function addActivity(type, title, description, icon = 'document') {
            const activities = JSON.parse(localStorage.getItem('recentActivities') || '[]');
            const now = new Date();
            
            const activity = {
                id: Date.now(),
                type: type,
                title: title,
                description: description,
                icon: icon,
                timestamp: now.toISOString(),
                timeAgo: getTimeAgo(now)
            };
            
            // Add to beginning of array
            activities.unshift(activity);
            
            // Keep only last 10 activities
            if (activities.length > 10) {
                activities.splice(10);
            }
            
            // Save to localStorage
            localStorage.setItem('recentActivities', JSON.stringify(activities));
            
            // Update display
            updateActivityDisplay();
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'Gerade eben';
            if (diffMins < 60) return `Vor ${diffMins} Min`;
            if (diffHours < 24) return `Vor ${diffHours} Std`;
            if (diffDays < 7) return `Vor ${diffDays} Tag${diffDays > 1 ? 'en' : ''}`;
            return date.toLocaleDateString('de-DE');
        }
        
        function updateActivityDisplay() {
            const container = byId('recentActivity');
            if (!container) return;
            
            const activities = JSON.parse(localStorage.getItem('recentActivities') || '[]');
            
            if (activities.length === 0) {
                container.innerHTML = `
                    <div class="activity-item">
                        <div class="activity-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14,2 14,8 20,8"></polyline>
                            </svg>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Willkommen bei stunova!</div>
                            <div class="activity-description">Erstelle deinen ersten Stundenplan oder lade Daten aus einer Datei hoch.</div>
                            <div class="activity-time">Gerade eben</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = activities.map(activity => {
                const iconSvg = getActivityIcon(activity.icon);
                return `
                    <div class="activity-item">
                        <div class="activity-icon">
                            ${iconSvg}
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-description">${activity.description}</div>
                            <div class="activity-time">${activity.timeAgo}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getActivityIcon(iconType) {
            const icons = {
                'document': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14,2 14,8 20,8"></polyline>
                </svg>`,
                'plus': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>`,
                'edit': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>`,
                'trash': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3,6 5,6 21,6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>`,
                'calendar': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>`,
                'settings': `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>`
            };
            return icons[iconType] || icons['document'];
        }
        
        function getDayName(dayIndex) {
            const days = ['Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag', 'Sonntag'];
            return days[dayIndex] || 'Unbekannt';
        }
        
        // --- helpers (singleton listeners) ---------------------------------
        const OPEN_KEY = 'sidebar_open_states_v1';
        let openStates = {};
        try { openStates = JSON.parse(localStorage.getItem(OPEN_KEY) || '{}'); } catch { openStates = {}; }
        const saveOpenStates = () => localStorage.setItem(OPEN_KEY, JSON.stringify(openStates));

        let accordionHandlersInstalled = false;
        let sidebarOutsideHandler = null;
        let sidebarEscHandler = null;

        function installAccordionGlobalHandlers() {
            if (accordionHandlersInstalled) return; // prevent stacking
            const acc = document.getElementById('dataSidebar');
            if (!acc) return;

            sidebarOutsideHandler = (e) => {
                if (!e.target.closest('#dataSidebar')) {
                    acc.querySelectorAll('details[open]').forEach(d => {
                        d.open = false;
                        const key = d.dataset.groupKey;
                        if (key) openStates[key] = false;
                    });
                    saveOpenStates();
                }
            };
            document.addEventListener('mousedown', sidebarOutsideHandler);

            sidebarEscHandler = (e) => {
                if (e.key === 'Escape') {
                    acc.querySelectorAll('details[open]').forEach(d => {
                        d.open = false;
                        const key = d.dataset.groupKey;
                        if (key) openStates[key] = false;
                    });
                    saveOpenStates();
                }
            };
            window.addEventListener('keydown', sidebarEscHandler);

            accordionHandlersInstalled = true;
        }

        /* =================== DATEN-SEITENLEISTE (foldable) =================== */
        const dataSidebar = byId('dataSidebar');
        function renderDataSidebar() {
            if (!dataSidebar) return;
            dataSidebar.innerHTML = '';

            const groups = [
                { key: 'teachers', label: 'Lehrkräfte' },
                { key: 'rooms', label: 'Räume' },
                { key: 'subjects', label: 'Fächer (Vorlagen)' },
                { key: 'classes', label: 'Klassen' }
            ];

            groups.forEach(g => {
                const det = document.createElement('details');
                det.dataset.groupKey = g.key;
                det.open = openStates[g.key] !== undefined ? !!openStates[g.key] : true;

                const sum = document.createElement('summary');
                sum.textContent = g.label;

                // Prevent closing when already open; allow opening when closed
                sum.addEventListener('click', (e) => {
                    if (det.open) {           // currently open -> keep open
                        e.preventDefault();
                        e.stopPropagation();
                    }
                    // if closed, native toggle will open it; we sync state on 'toggle'
                });

                det.addEventListener('toggle', () => {
                    openStates[g.key] = det.open;
                    saveOpenStates();
                });

                det.appendChild(sum);

                const list = document.createElement('div');
                list.className = 'side-list';

                const arr = dataState[g.key];
                arr.forEach((val, idx) => {
                    const row = document.createElement('div'); row.className = 'side-row';
                    const inp = document.createElement('input'); inp.value = val;
                    const del = document.createElement('button'); del.className = 'btn mini danger'; del.textContent = 'Löschen';

                    del.addEventListener('click', () => {
                        arr.splice(idx, 1);
                        saveData();
                        renderDataSidebar();
                        renderTeacherSelect();
                    });
                    inp.addEventListener('input', () => {
                        arr[idx] = inp.value;
                        saveData();
                        renderTeacherSelect();
                    });

                    row.append(inp, del);
                    list.appendChild(row);
                });

                const addRow = document.createElement('div'); addRow.className = 'side-row';
                const addInp = document.createElement('input'); addInp.placeholder = `Neu (${g.label.slice(0, -1)})`;
                const addBtn = document.createElement('button'); addBtn.className = 'btn mini primary'; addBtn.textContent = 'Hinzufügen';

                const doAdd = () => {
                    const v = (addInp.value || '').trim();
                    if (!v) return;
                    if (!arr.includes(v)) arr.push(v);
                    addInp.value = '';
                    saveData();
                    renderDataSidebar();
                    renderTeacherSelect();
                };
                addBtn.addEventListener('click', doAdd);
                addInp.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); doAdd(); } });

                addRow.append(addInp, addBtn);
                list.appendChild(addRow);

                det.appendChild(list);
                dataSidebar.appendChild(det);
            });

            // ensure outside click / Esc behaviour stays wired after every render
            installAccordionGlobalHandlers();
        }

        function renderSettingsStats() {
            // Update settings stats cards
            byId('settingsDaysCount').textContent = state.days.length;
            byId('settingsPeriodLength').textContent = state.periodMinutes;
            byId('settingsPeriodCount').textContent = state.periodCount;
            byId('settingsBreakLength').textContent = state.breakMinutes;
        }

        function upcomingLessons(max = 3) {
            const now = new Date();
            const todayIdx = (now.getDay() + 6) % 7;
            const block = state.periodMinutes + state.breakMinutes;
            const nowMin = minutesSinceStart(now);

            // alle kommenden (inkl. aktuell laufend)
            const result = [];
            for (let offset = 0; offset < 14 && result.length < max; offset++) {
                const dayIndex = (todayIdx + offset) % state.days.length;
                const list = state.lessons
                    .filter(l => l.day === dayIndex)
                    .map(l => {
                        const startMin = l.startIndex * block;
                        const endMin = startMin + l.span * state.periodMinutes;
                        const isToday = offset === 0;
                        const type = isToday && nowMin >= startMin && nowMin < endMin ? 'now' : 'next';
                        return { l, dayIndex, startMin, endMin, offset, type };
                    })
                    .filter(x => x.type === 'now' || x.offset > 0 || (x.offset === 0 && x.startMin >= nowMin))
                    .sort((a, b) => a.startMin - b.startMin);

                for (const it of list) {
                    result.push(it);
                    if (result.length >= max) break;
                }
            }
            return result;
        }
        function folderChipHtml(subject) {
            const folder = findFolderForSubject(subject);
            if (!folder) {
                return `<button class="btn mini primary" id="ovHeroCreateFolder">Ordner anlegen</button>`;
            }
            const col = folder.color || '#e2e8f0';
            return `<span class="folder-chip clickable" id="ovHeroFolder" data-folder-id="${folder.id}" style="--col:${col}">
                <span class="swatch"></span>${folder.name}
            </span>`;
        }

        function renderHeroSingle() {
            const info = getCurrentOrNextLesson();
            const heroSub = byId('ovHeroSub');

            if (!info) {
                heroSub.innerHTML = 'Heute: <strong>keine Stunde mehr</strong>.';
                return;
            }

            const { l, type, start, end, offset } = info;
            const startLbl = timeLabelFromMinutes(dayStart, start);
            const endLbl = timeLabelFromMinutes(dayStart, end);
            const dayLbl =
                type === 'now' ? 'Jetzt' :
                    offset === 0 ? 'Als Nächstes' :
                        offset === 1 ? 'Morgen' :
                            (state.days[(l.day)] || `Tag ${l.day + 1}`);

            const rest = type === 'now'
                ? ` <span class="meta">(${Math.max(0, Math.ceil(end - minutesSinceStart(new Date())))} Min übrig)</span>`
                : '';

            heroSub.innerHTML = `${dayLbl}: <strong>${l.subject}</strong> · ${startLbl}–${endLbl} · Raum ${l.room || '–'} · ${l.teacher || ''}${rest}
                        &nbsp; ${folderChipHtml(l.subject)}`;
        }

        function buildHeroSingleHtml() {
            const info = getCurrentOrNext();
            if (!info) return 'Heute: <strong>keine Stunde mehr</strong>.';

            const { l } = info;
            const start = timeLabelFromMinutes(dayStart, info.startMin);
            const end = timeLabelFromMinutes(dayStart, info.endMin);

            const label =
                info.type === 'now' ? 'Jetzt' :
                    info.offset === 0 ? 'Als Nächstes' :
                        info.offset === 1 ? 'Morgen' :
                            (state.days[info.dayIndex] || `Tag ${info.dayIndex + 1}`);

            const rest = info.type === 'now'
                ? ` <span class="meta">(${Math.max(0, Math.ceil(info.endMin - minutesSinceStart(new Date())))} Min übrig)</span>`
                : '';

            return `<div><strong>${label}:</strong> ${l.subject} · ${start}–${end} · Raum ${l.room || '–'} · ${l.teacher || ''}${rest}
                    &nbsp; ${folderChipHtml(l.subject)}</div>`;
        }

        function buildHeroListHtml() {
            const items = upcomingLessons(3);
            if (!items.length) return 'Heute: <strong>keine Stunde mehr</strong>.';

            const li = items.map(info => {
                const { l } = info;
                const start = timeLabelFromMinutes(dayStart, info.startMin);
                const end = timeLabelFromMinutes(dayStart, info.endMin);

                const dayLabel =
                    info.type === 'now' ? 'Jetzt' :
                        info.offset === 0 ? 'Als Nächstes' :
                            info.offset === 1 ? 'Morgen' :
                                (state.days[info.dayIndex] || `Tag ${info.dayIndex + 1}`);

                // optional: Restzeit bei "Jetzt"
                const rest = info.type === 'now'
                    ? ` <span class="meta">(${Math.max(0, Math.ceil(info.endMin - minutesSinceStart(new Date())))} Min übrig)</span>`
                    : '';

                return `<li>
        <strong>${dayLabel}:</strong> ${l.subject} · ${start}–${end} · Raum ${l.room || '–'} · ${l.teacher || ''}${rest}
        &nbsp; ${folderChipHtml(l.subject)}
        </li>`;
            });

            return `<ul>${li.join('')}</ul>`;
        }

        function getCurrentOrNext() {
            const now = new Date();
            const todayIdx = (now.getDay() + 6) % 7;
            const block = state.periodMinutes + state.breakMinutes;
            const nowMin = minutesSinceStart(now);

            // 1) Läuft gerade (heute)?
            const today = state.lessons
                .filter(l => l.day === todayIdx)
                .map(l => {
                    const startMin = l.startIndex * block;
                    const endMin = startMin + l.span * state.periodMinutes;
                    return { l, dayIndex: todayIdx, startMin, endMin, offset: 0 };
                })
                .sort((a, b) => a.startMin - b.startMin);

            const running = today.find(x => nowMin >= x.startMin && nowMin < x.endMin);
            if (running) return { ...running, type: 'now' };

            // 2) Nächste Stunde ab jetzt vorwärts suchen (heute inkl. nach jetzt)
            for (let offset = 0; offset < 14; offset++) {
                const d = (todayIdx + offset) % state.days.length;
                const list = state.lessons
                    .filter(l => l.day === d)
                    .map(l => {
                        const startMin = l.startIndex * block;
                        const endMin = startMin + l.span * state.periodMinutes;
                        return { l, dayIndex: d, startMin, endMin, offset };
                    })
                    .filter(x => offset > 0 ? true : x.startMin >= nowMin)
                    .sort((a, b) => a.startMin - b.startMin);

                if (list.length) return { ...list[0], type: 'next' };
            }

            return null; // gar nichts in den nächsten 2 Wochen
        }
        function renderHeroCompact() {
            const host = byId('ovHeroSub');
            const info = currentOrNextLesson();

            if (!info) {
                host.innerHTML = `<div class="hero-compact">
                                    <div>
                                    <div class="hc-title">Heute: keine Stunde mehr</div>
                                    <div class="hc-meta">Alles erledigt ✨</div>
                                    </div>
                                    <div style="width:56px;height:56px"></div>
                                </div>`;
                return;
            }

            const { l, type, start, end, dayIndex, offset } = info;
            const title = (type === 'now') ? 'Jetzt' : (offset === 0 ? 'Als Nächstes' : (offset === 1 ? 'Morgen' : (state.days[dayIndex] || 'Demnächst')));
            const startLbl = timeLabelFromMinutes(dayStart, start);
            const endLbl = timeLabelFromMinutes(dayStart, end);
            const dayLbl = state.days[dayIndex] || `Tag ${dayIndex + 1}`;

            const meta = `${dayLbl}: <strong>${l.subject}</strong> ${startLbl}–${endLbl} | Raum ${l.room || '–'} · ${l.teacher || ''}`;

            // folder tile
            const folder = findFolderForSubject(l.subject);
            const col = folder?.color || '#e5e7eb';
            const rightHtml = folder
                ? `<button class="folder-tile" id="ovHeroFolder" data-folder-id="${folder.id}" style="--col:${col}">
                        <span class="swatch"></span>
                    </button>`
                : `<button class="folder-tile" id="ovHeroCreateFolder" style="--col:#e5e7eb" title="Ordner anlegen">
                        <span class="swatch"></span>
                    </button>`;

            host.innerHTML = `<div class="hero-compact">
                    <div>
                        <div class="hc-title">${title}</div>
                        <div class="hc-meta">${meta}</div>
                    </div>
                    ${rightHtml}
                </div>`;

            // clicks
            byId('ovHeroFolder')?.addEventListener('click', (e) => {
                const id = e.currentTarget.getAttribute('data-folder-id');
                if (id) { byId('navFolders').click(); openFolderDetail(id); }
            });
            byId('ovHeroCreateFolder')?.addEventListener('click', () => {
                // prefill with subject name + color
                byId('navFolders').click();
                openFolderEdit(null);
                folderNameInput.value = l.subject || 'Neuer Ordner';
                folderColorInput.value = col;
            });
        }

        /* =================== ANALYSIS =================== */
        function renderAnalysis() {
            // Get current week's plan for analysis
            const currentPlan = getDisplayWeekPlan();
            
            // Calculate statistics
            const weekStats = calcWeekStatsFor(currentPlan);
            const busyFree = calcBusyFreeBlocksFor(currentPlan);
            const utilization = Math.round((busyFree.busyBlocks / (currentPlan.periodCount * currentPlan.days.length)) * 100);
            const avgPerDay = Math.round(weekStats.count / currentPlan.days.length);
            
            // Update stat cards
            byId('analysisTotalHours').textContent = weekStats.hours;
            byId('analysisFreeBlocks').textContent = busyFree.freeBlocks;
            byId('analysisUtilization').textContent = `${utilization}%`;
            byId('analysisAverage').textContent = avgPerDay;
            
            // Render charts
            const subjDist = subjectDistributionFor(currentPlan);
            drawBars('barSubjects', subjDist.labels, subjDist.values);
            
            const teacherDist = teacherDistributionFor(currentPlan);
            drawBars('barTeachers', teacherDist.labels, teacherDist.values);
            
            const roomDist = roomDistributionFor(currentPlan);
            drawBars('barRooms', roomDist.labels, roomDist.values);
            
            const timeDist = timeSlotDistributionFor(currentPlan);
            drawBars('barTimeSlots', timeDist.labels, timeDist.values);
        }
        
        function teacherDistributionFor(plan) {
            const map = new Map();
            plan.lessons.forEach(l => {
                const teacher = l.teacher || 'Unbekannt';
                map.set(teacher, (map.get(teacher) || 0) + l.span);
            });
            const labels = [...map.keys()];
            const values = labels.map(k => map.get(k));
            return { labels, values };
        }
        
        function roomDistributionFor(plan) {
            const map = new Map();
            plan.lessons.forEach(l => {
                const room = l.room || 'Unbekannt';
                map.set(room, (map.get(room) || 0) + l.span);
            });
            const labels = [...map.keys()];
            const values = labels.map(k => map.get(k));
            return { labels, values };
        }
        
        function timeSlotDistributionFor(plan) {
            const map = new Map();
            plan.lessons.forEach(l => {
                const timeSlot = `${l.startIndex + 1}. Stunde`;
                map.set(timeSlot, (map.get(timeSlot) || 0) + 1);
            });
            const labels = [...map.keys()];
            const values = labels.map(k => map.get(k));
            return { labels, values };
        }

        /* =================== OVERVIEW (breit & visuals) =================== */
        
        // Week key generation and management
        function getCurrentWeekKey() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            
            // If it's Saturday (6) or Sunday (0), show the next week
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                // Move to next Monday to get the next week
                const nextMonday = new Date(now);
                nextMonday.setDate(now.getDate() + (dayOfWeek === 0 ? 1 : 2)); // Sunday -> Monday, Saturday -> Monday
                
                const year = nextMonday.getFullYear();
                const week = getWeekNumber(nextMonday);
                return `${year}-W${week}`;
            }
            
            // For Monday-Friday, use the current week
            const year = now.getFullYear();
            const week = getWeekNumber(now);
            return `${year}-W${week}`;
        }
        
        function normalizeWeekKey(weekKey) {
            // Ensure week key is properly formatted and valid
            if (!weekKey || typeof weekKey !== 'string') {
                return getCurrentWeekKey();
            }
            
            const parts = weekKey.split('-W');
            if (parts.length !== 2) {
                return getCurrentWeekKey();
            }
            
            const year = parseInt(parts[0]);
            const week = parseInt(parts[1]);
            
            if (isNaN(year) || isNaN(week) || week < 1 || week > 53) {
                return getCurrentWeekKey();
            }
            
            return weekKey;
        }
        
        function weekKeyCompare(a, b) { // "YYYY-Www"
            const [ay, aw] = a.split('-W').map(Number);
            const [by, bw] = b.split('-W').map(Number);
            if (ay !== by) return ay - by;
            return aw - bw;
        }
        
        function getWeekKeyFromOffset(offset) {
            const now = new Date();
            const targetDate = new Date(now);
            targetDate.setDate(now.getDate() + (offset * 7));
            const year = targetDate.getFullYear();
            const week = getWeekNumber(targetDate);
            return `${year}-W${week}`;
        }
        
        function getMaxPeriodsForDay(dayStartHour, dayStartMinute, periodMinutes, breakMinutes) {
            const dayStartTotalMinutes = dayStartHour * 60 + dayStartMinute;
            const availableMinutes = 24 * 60 - dayStartTotalMinutes; // Minutes until midnight
            const blockMinutes = periodMinutes + breakMinutes;
            
            // Calculate how many complete periods fit
            const maxPeriods = Math.floor(availableMinutes / blockMinutes);
            
            // Check if the last period would exceed 23:59
            const lastPeriodEndTime = dayStartTotalMinutes + (maxPeriods * blockMinutes) + periodMinutes;
            if (lastPeriodEndTime >= 24 * 60) {
                return Math.max(0, maxPeriods - 1);
            }
            
            return maxPeriods;
        }

        function validateAndAdjustSettings() {
            const startTimeSlider = byId('plan-startTimeSlider');
            const periodMinSlider = byId('plan-periodMinSlider');
            const breakMinSlider = byId('plan-breakMinSlider');
            const periodCountSlider = byId('plan-periodCountSlider');
            
            if (!startTimeSlider || !periodMinSlider || !breakMinSlider || !periodCountSlider) {
                return;
            }
            
            const currentStartHour = parseInt(startTimeSlider.value);
            const currentPeriodMinutes = parseInt(periodMinSlider.value);
            const currentBreakMinutes = parseInt(breakMinSlider.value);
            const currentPeriodCount = parseInt(periodCountSlider.value);
            
            // Calculate maximum periods for current settings
            const maxPeriods = getMaxPeriodsForDay(currentStartHour, 0, currentPeriodMinutes, currentBreakMinutes);
            
            // Update period count slider max value
            const newMax = Math.max(maxPeriods, 4); // Minimum 4 periods
            periodCountSlider.max = newMax;
            
            // If current value exceeds new max, adjust it
            if (currentPeriodCount > newMax) {
                periodCountSlider.value = newMax;
                const periodCountValue = byId('plan-periodCountValue');
                if (periodCountValue) {
                    periodCountValue.textContent = newMax;
                }
                console.log('Adjusted period count from', currentPeriodCount, 'to', newMax, 'due to time constraints');
            }
            
            console.log('Validated settings - Start:', currentStartHour + ':00', 'Period:', currentPeriodMinutes + 'min', 'Break:', currentBreakMinutes + 'min', 'Max periods:', maxPeriods, 'Current:', currentPeriodCount);
        }

        function updateSliderMaxValues() {
            validateAndAdjustSettings();
        }

        function getOrCreateWeekPlan(weekKey) {
            if (!weekPlans.has(weekKey)) {
                const newPlan = {
                    lessons: [],
                    days: [...state.days], // Use state for consistency
                    periodMinutes: state.periodMinutes,
                    breakMinutes: state.breakMinutes,
                    periodCount: state.periodCount,
                    timeSlots: [], // Individual time slots for this week
                    dayStart: { h: dayStart.h, m: dayStart.m } // Week-specific start time, initialized from global dayStart
                };
                weekPlans.set(weekKey, newPlan);
            }
            return weekPlans.get(weekKey);
        }
        function getDisplayWeekPlan() {
            // Use the current plan week for overview data (where lessons are actually stored)
            const plan = getOrCreateWeekPlan(currentPlanWeek);
            
            return plan;
        }

        function getHeatmapWeekPlan() {
            // Use the heatmap week for heatmap-specific data
            const plan = getOrCreateWeekPlan(currentHeatmapWeek);
            
            return plan;
        }
        function calcWeekStatsFor(plan) {
            const minutes = plan.lessons.reduce((sum, l) => sum + l.span * plan.periodMinutes, 0);
            return { count: plan.lessons.length, minutes, hours: Math.round(minutes / 60) };
        }

        function calcTodayStatsFor(plan) {
            const now = new Date();
            const day = (now.getDay() + 6) % 7;
            const occ = new Set(plan.lessons.filter(l => l.day === day).flatMap(l =>
                Array.from({ length: l.span }, (_, i) => l.startIndex + i)
            ));
            const busy = occ.size;
            const free = Math.max(0, plan.periodCount - busy);
            return { busyBlocks: busy, freeBlocks: free };
        }
        function buildHeatMatrixFor(plan) {
            // Create matrix with days as rows (as expected by drawHeatmap)
            const m = Array.from({ length: plan.days.length }, () => []);
            
            // Only show data if the week has lessons
            if (!plan.lessons || plan.lessons.length === 0) {
                return m; // Return empty matrix for weeks with no lessons
            }
            
            for (const l of plan.lessons) {
                const color = (l.color && l.color.trim()) || dataState.subjectColors[(l.subject || "").trim()] || "#60a5fa";
                if (l.day >= 0 && l.day < plan.days.length) {
                    m[l.day].push({
                        subject: l.subject,
                        teacher: l.teacher,
                        room: l.room,
                        color: color,
                        importance: !!l.importance,
                        startIndex: l.startIndex,
                        span: l.span
                    });
                }
            }
            return m;
        }

        function subjectDistributionFor(plan) {
            const map = new Map();
            for (const l of plan.lessons) {
                const key = (l.subject || '—').trim();
                map.set(key, (map.get(key) || 0) + 1);
            }
            const labels = [...map.keys()];
            const values = labels.map(k => map.get(k));
            return { labels, values };
        }

        function switchToWeekPlan(weekKey) {
            try {
                console.log('Switching to week:', weekKey);
                
            const plan = getOrCreateWeekPlan(weekKey);
                if (!plan) {
                    console.error('Failed to get or create plan for week:', weekKey);
                    return;
                }
                
            currentPlanWeek = weekKey;
                
                // Save the current plan week to localStorage
                try {
                    localStorage.setItem('currentPlanWeek', weekKey);
                } catch (e) {
                    console.warn('Failed to save currentPlanWeek to localStorage:', e);
                }
            
            // Update state with the selected week's data
            state.lessons = [...plan.lessons];
            state.days = [...plan.days];
            state.periodMinutes = plan.periodMinutes;
            state.breakMinutes = plan.breakMinutes;
            state.periodCount = plan.periodCount;
            
            console.log('Updated state with plan values:', {
                periodMinutes: state.periodMinutes,
                periodCount: state.periodCount,
                breakMinutes: state.breakMinutes
            });
            
            // Save current state and render
            savePlan();
            renderGrid();
            updatePlanWeekDisplay();
            
            // Update side panel if it's open
            const panel = byId('timetableStructurePanel');
            if (panel && panel.classList.contains('open')) {
                updatePlanSettingsForCurrentWeek();
            }
                
                console.log('Successfully switched to week:', weekKey);
                
            } catch (error) {
                console.error('Error in switchToWeekPlan:', error);
            }
        }
        
        function saveCurrentWeekPlan() {
            const plan = weekPlans.get(currentPlanWeek);
            if (plan) {
                // Don't overwrite plan.lessons - they may have been updated by resize/drag operations
                // Only update other properties if they differ
                if (plan.days.length !== state.days.length || !plan.days.every((d, i) => d === state.days[i])) {
                    plan.days = [...state.days];
                }
                if (plan.periodMinutes !== state.periodMinutes) {
                    plan.periodMinutes = state.periodMinutes;
                }
                if (plan.breakMinutes !== state.breakMinutes) {
                    plan.breakMinutes = state.breakMinutes;
                }
                // Don't overwrite plan.periodCount if it's larger than state.periodCount
                // This allows dynamic row creation beyond the slider limit
                if (plan.periodCount < state.periodCount) {
                    plan.periodCount = state.periodCount;
                }
            } else {
                // Create the plan if it doesn't exist
                weekPlans.set(currentPlanWeek, {
                    lessons: [...state.lessons],
                    days: [...state.days],
                    periodMinutes: state.periodMinutes,
                    breakMinutes: state.breakMinutes,
                    periodCount: state.periodCount
                });
            }
        }
        
        // Week navigation functions
        function updateWeekDisplay() {
            const weekDisplay = byId('weekDisplay');
            if (!weekDisplay) {
                console.warn('weekDisplay element not found');
                return;
            }
            
            // Heatmap now uses its own independent week
            const dateRange = getWeekDateRange(currentHeatmapWeek);
            const currentWeekKey = getCurrentWeekKey();
            
            // Check if this is the current week
            const isCurrentWeek = currentHeatmapWeek === currentWeekKey;
            
            const heatmapWeekNumber = currentHeatmapWeek.split('-W')[1];
            weekDisplay.innerHTML = `<strong>W${heatmapWeekNumber}</strong><br>${dateRange}`;
            weekDisplay.classList.toggle('current-week', isCurrentWeek);
        }
        
        function updatePlanWeekDisplay() {
            const planWeekDisplay = byId('planWeekDisplay');
            if (!planWeekDisplay) {
                console.warn('planWeekDisplay element not found');
                return;
            }
            
            if (!currentPlanWeek) {
                console.warn('currentPlanWeek is not set');
                return;
            }
            
            const weekNumber = currentPlanWeek.split('-W')[1];
            if (!weekNumber) {
                console.warn('Invalid currentPlanWeek format:', currentPlanWeek);
                return;
            }
            
            const dateRange = getWeekDateRange(currentPlanWeek);
            const currentWeekKey = getCurrentWeekKey();
            
            // Update timetable structure banner week display
            const timetableWeekBadge = byId('currentWeekBadge');
            if (timetableWeekBadge) {
                timetableWeekBadge.textContent = `Week ${weekNumber}`;
            }
            
            // Check if this is the current week
            const isCurrentWeek = currentPlanWeek === currentWeekKey;
            
            const planWeekNumber = currentPlanWeek.split('-W')[1];
            planWeekDisplay.innerHTML = `<strong>W${planWeekNumber}</strong><br>${dateRange}`;
            planWeekDisplay.classList.toggle('current-week', isCurrentWeek);
            
            
            console.log('Updated plan week display to:', dateRange);
        }
        
        
        
        function attachCellEventListeners(cell, dayIndex, periodIndex) {
            // Use event delegation for better performance
            cell.addEventListener('dragover', e => { 
                e.preventDefault(); 
                cell.classList.add('over'); 
            });
            
            cell.addEventListener('dragleave', () => cell.classList.remove('over'));
            
            cell.addEventListener('drop', e => {
                e.preventDefault(); 
                cell.classList.remove('over');
                const id = e.dataTransfer?.getData('text/plain'); 
                if (!id) return;
                
                const currentPlan = getOrCreateWeekPlan(currentPlanWeek);
                const idx = currentPlan.lessons.findIndex(l => l.id === id); 
                if (idx < 0) return;
                
                const l = { ...currentPlan.lessons[idx] }; 
                l.day = dayIndex; 
                l.startIndex = periodIndex; 
                l.span = Math.min(l.span, currentPlan.timeSlots.length - l.startIndex);
                
                const next = [...currentPlan.lessons]; 
                next[idx] = l; 
                currentPlan.lessons = resolveCollisions(next, currentPlan.timeSlots.length); 
                // Sync state.lessons with currentPlan.lessons for immediate "Als Nächstes" updates
                state.lessons = [...currentPlan.lessons];
                saveCurrentWeekPlan(); 
                renderGrid();
            });
        }
        
        function removeTimeSlot(index) {
            const plan = weekPlans.get(currentPlanWeek);
            if (!plan || !plan.timeSlots || index >= plan.timeSlots.length) {
                console.warn('Invalid time slot index:', index);
                return;
            }
            
            // Remove the time slot
            plan.timeSlots.splice(index, 1);
            
            // Update periodCount
            plan.periodCount = plan.timeSlots.length;
            
            // Save and re-render
            saveWeekPlans();
            renderGrid();
            
            console.log('Removed time slot at index:', index, 'for week:', currentPlanWeek);
        }
        
        function getWeekNumber(date) {
            // ISO 8601 week number calculation
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7; // Convert Sunday (0) to 7
            d.setUTCDate(d.getUTCDate() + 4 - dayNum); // Move to Thursday of the same week
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        function getWeekDateRange(weekKey) {
            try {
                const [year, week] = weekKey.split('-W').map(Number);
                
                // Use ISO 8601 week calculation to get the Monday of the given week
                // This ensures we get the correct Monday for the ISO week number
                const simple = new Date(year, 0, 1 + (week - 1) * 7);
                const dow = simple.getDay();
                const ISOweekStart = simple;
                
                // Adjust to get the Monday of the ISO week
                if (dow <= 4) {
                    ISOweekStart.setDate(simple.getDate() - dow + 1);
                } else {
                    ISOweekStart.setDate(simple.getDate() + 8 - dow);
                }
                
                // Calculate Friday of the same week (Monday + 4 days)
                const targetFriday = new Date(ISOweekStart);
                targetFriday.setDate(ISOweekStart.getDate() + 4);
                
                // Format dates as DD.MM.YYYY
                const formatDate = (date) => {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}.${month}.${year}`;
                };
                
                // Return formatted date range with better spacing
                return `${formatDate(ISOweekStart)} – ${formatDate(targetFriday)}`;
            } catch (error) {
                console.error('Error calculating week date range:', error);
                return weekKey; // Fallback to week key
            }
        }
        
        function navigateWeek(direction) {
            // Heatmap navigation is now independent from plan timetable
            navigateHeatmapWeek(direction);
            
            // Update heatmap display only
            updateWeekDisplay();
            renderOverview();
        }
        
        function navigateHeatmapWeek(direction) {
            try {
                const currentWeekKey = currentHeatmapWeek;
                if (!currentWeekKey) {
                    console.error('currentHeatmapWeek is not set');
                    return;
                }

                const [year, week] = currentWeekKey.split('-W').map(Number);
                const currentDate = new Date(year, 0, 1);
                const weekStart = new Date(currentDate.getTime() + (week - 1) * 7 * 24 * 60 * 60 * 1000);
                
                // Add/subtract weeks
                const newDate = new Date(weekStart.getTime() + direction * 7 * 24 * 60 * 60 * 1000);
                const newYear = newDate.getFullYear();
                const newWeek = getWeekNumber(newDate);
                const newWeekKey = `${newYear}-W${newWeek}`;
                
                currentHeatmapWeek = newWeekKey;
                
                // Calculate new offset for overview
                const baseWeekKey = getCurrentWeekKey();
                const weekDiff = weekKeyCompare(newWeekKey, baseWeekKey);
                currentWeekOffset = weekDiff;
                overviewWeekKey = newWeekKey; // Update overview week key
                
                // Save to localStorage
                try {
                    localStorage.setItem('currentHeatmapWeek', newWeekKey);
                    localStorage.setItem('currentWeekOffset', currentWeekOffset.toString());
                    localStorage.setItem('overviewWeekKey', newWeekKey);
                } catch (e) {
                    console.warn('Failed to save week keys to localStorage:', e);
                }
                
                console.log('Heatmap week changed to:', newWeekKey);
            } catch (error) {
                console.error('Error navigating heatmap week:', error);
            }
        }
        function getDisplayWeekLessons() {
            const plan = weekPlans.get(currentPlanWeek);
            return plan ? plan.lessons : [];
        }
        function navigatePlanWeek(direction) {
            try {
            const currentWeekKey = currentPlanWeek;
                if (!currentWeekKey) {
                    console.error('currentPlanWeek is not set');
                    return;
                }
                
            const currentWeekNum = parseInt(currentWeekKey.split('-W')[1]);
            const year = parseInt(currentWeekKey.split('-W')[0]);
                
                if (isNaN(currentWeekNum) || isNaN(year)) {
                    console.error('Invalid week key format:', currentWeekKey);
                    return;
                }
            
            // Calculate target week
                let targetWeekNum = currentWeekNum + direction;
                let targetYear = year;
                
                // Handle year boundaries
                if (targetWeekNum < 1) {
                    targetYear--;
                    // Check if previous year has 53 weeks
                    const prevYearWeeks = getWeekNumber(new Date(targetYear, 11, 31));
                    targetWeekNum = prevYearWeeks;
                } else if (targetWeekNum > 52) {
                    // Check if current year has 53 weeks
                    const currentYearWeeks = getWeekNumber(new Date(targetYear, 11, 31));
                    if (targetWeekNum > currentYearWeeks) {
                        targetYear++;
                        targetWeekNum = 1;
                    }
                }
                
                const targetWeekKey = `${targetYear}-W${targetWeekNum}`;
            
            // Check if week exists or create it
            if (!weekPlans.has(targetWeekKey)) {
                // Create new week
                getOrCreateWeekPlan(targetWeekKey);
            }
            
            switchToWeekPlan(targetWeekKey);
            
            // Update both displays (plan and heatmap)
            updatePlanWeekDisplay();
            updateWeekDisplay();
                
            } catch (error) {
                console.error('Error in navigatePlanWeek:', error);
            }
        }
        
        
        function checkAutoNextWeek() {
            // Auto-switching disabled - user controls week navigation manually
            // This prevents the heatmap from automatically switching to future weeks
            return;
        }
        
        function renderOverview() {
            try {
                // Check if we should auto-switch to next week
                checkAutoNextWeek();
                
                // Ensure overview week plan exists
                if (!weekPlans.has(overviewWeekKey)) {
                    getOrCreateWeekPlan(overviewWeekKey);
                }
                
                // Force save all week plans to ensure data persistence
                saveWeekPlans();
            
            // Get the overview week plan for statistics (where lessons are actually stored)
            const selectedPlan = getOrCreateWeekPlan(overviewWeekKey);
            if (!selectedPlan) {
                console.error('Failed to get or create overview week plan');
                return;
            }
            
            // Use selected week's data for statistics
            const weekStats = calcWeekStatsFor(selectedPlan);
            const kpiWeekLessons = byId('kpiWeekLessons');
            const kpiWeekMinutes = byId('kpiWeekMinutes');
            if (kpiWeekLessons) kpiWeekLessons.textContent = weekStats.count.toString();
            if (kpiWeekMinutes) kpiWeekMinutes.textContent = `${weekStats.minutes} Min · ${weekStats.hours} h`;

            const todayStats = calcTodayStatsFor(selectedPlan);
            const kpiFreeToday = byId('kpiFreeToday');
            const kpiBusyToday = byId('kpiBusyToday');
            if (kpiFreeToday) kpiFreeToday.textContent = todayStats.freeBlocks.toString();
            if (kpiBusyToday) kpiBusyToday.textContent = `${todayStats.busyBlocks} belegt`;

            const subjectsSet = new Set(selectedPlan.lessons.map(l => (l.subject || '').trim()).filter(Boolean));
            const kpiSubjects = byId('kpiSubjects');
            const kpiFolders = byId('kpiFolders');
            if (kpiSubjects) kpiSubjects.textContent = subjectsSet.size.toString();
            if (kpiFolders) kpiFolders.textContent = `Ordner: ${folderState.folders.length}`;

            // Update week display
            updateWeekDisplay();
            
            // Use overview week for heatmap display (same as statistics)
            // Ensure heatmap week is synchronized with overview week
            currentHeatmapWeek = overviewWeekKey;
            const heatmapMatrix = buildHeatMatrixFor(selectedPlan);
            const heatmapElement = byId('heatmap');
            if (heatmapElement) {
                drawHeatmap('heatmap', heatmapMatrix);
            }
            
            // Use overview week for other displays
            const subjDist = subjectDistributionFor(selectedPlan);
            const barSubjectsElement = byId('barSubjects');
            if (barSubjectsElement) {
                drawBars('barSubjects', subjDist.labels, subjDist.values);
            }
            const listTodayElement = byId('listToday');
            if (listTodayElement) {
                renderTodayList('listToday', selectedPlan);
            }
            const listRecentElement = byId('listRecent');
            if (listRecentElement) {
                renderRecentFiles('listRecent');
            }

            // **NEU**: Kompakte Box in den neuen Platzhalter
            const host = byId('ovHeroInline');
            if (host) {
                // nutzt deine vorhandene current/next-Logik:
                const info = getCurrentOrNextLesson();   // oder currentOrNextLesson()
                if (!info) {
                    // Always show "Als Nächstes" even when no lessons found
                    host.innerHTML = `
                        <div class="hero-compact">
                            <div>
                                <div class="hc-title">Als Nächstes</div>
                                <div class="hc-meta">Keine Stunden geplant</div>
                            </div>
                            <div style="width:56px;height:56px"></div>
                        </div>`;
                } else {
                    const { l, type, start, end, dayIndex, weekKey, offset } = info;
                    const title = type === 'now' ? 'Jetzt' : 'Als Nächstes';
                    const startLbl = timeLabelFromMinutes(dayStart, start);
                    const endLbl = timeLabelFromMinutes(dayStart, end);
                    const dayLbl = state.days[dayIndex] || `Tag ${dayIndex + 1}`;
                    
                    // Add week information if it's in a different week
                    let weekInfo = '';
                    if (weekKey && offset > 0) {
                        const weekNumber = weekKey.split('-W')[1];
                        weekInfo = ` (KW ${weekNumber})`;
                    }
                    
                    const meta = `${dayLbl}${weekInfo}: <strong>${l.subject}</strong> ${startLbl}–${endLbl} | Raum ${l.room || '–'} | ${l.teacher || ''}`;

                    const folder = findFolderForSubject(l.subject);
                    const col = folder?.color || '#e5e7eb';
                    const folderHtml = folder
                        ? `<button class="folder-tile" id="ovHeroFolder" data-folder-id="${folder.id}" style="--col:${col}"><span class="swatch"></span></button>`
                        : `<button class="folder-tile" id="ovHeroCreateFolder" style="--col:#e5e7eb" title="Ordner anlegen"><span class="swatch"></span></button>`;
                    host.innerHTML = `
                            <div class="hero-compact">
                                <div>
                                <div class="hc-title">${title}</div>
                                <div class="hc-meta">${meta}</div>
                                </div>
                                ${folderHtml}
                            </div>`;

                    byId('ovHeroFolder')?.addEventListener('click', e => {
                        const id = e.currentTarget.getAttribute('data-folder-id');
                        if (id) { byId('navFolders').click(); openFolderDetail(id); }
                    });
                    byId('ovHeroCreateFolder')?.addEventListener('click', () => {
                        byId('navFolders').click(); openFolderEdit(null);
                    });
                }
            }

            // Pomodoro-Init wie gehabt
            initPomodoroOnce();
            
            
            // Update "Als Nächstes" section
            updateNextUpSection();
            
            } catch (error) {
                console.error('renderOverview: Error during render:', error);
                // Try to render at least the basic content
                const host = byId('ovHeroInline');
                if (host) {
                    host.innerHTML = `
                        <div class="hero-compact">
                            <div>
                                <div class="hc-title">Übersicht</div>
                                <div class="hc-meta">Lade Inhalt...</div>
                            </div>
                            <div style="width:56px;height:56px"></div>
                        </div>`;
                }
            }
        }
        
        
        function updateNextUpSection() {
            try {
                const nextUpTitle = byId('nextUpTitle');
                const nextUpSubtitle = byId('nextUpSubtitle');
                const nextUpTitleHeute = byId('nextUpTitleHeute');
                const nextUpSubtitleHeute = byId('nextUpSubtitleHeute');
                const nextUpInHeute = byId('nextUpInHeute');
                const nextUpActions = document.querySelector('.next-up-actions');
                
                if (!nextUpTitle || !nextUpSubtitle) return;
                
                // Get current or next lesson using existing logic
                const info = getCurrentOrNextLesson();
                
                if (!info) {
                    // No lessons found - show create button
                    nextUpTitle.textContent = t('nextUp');
                    nextUpSubtitle.textContent = t('noLessonsPlanned');
                    
                    // Show create button
                    if (nextUpActions) {
                        nextUpActions.style.display = 'block';
                        const createBtn = nextUpActions.querySelector('.btn');
                        if (createBtn) {
                            createBtn.textContent = t('createClass') || 'Stunde hinzufügen';
                            createBtn.onclick = () => navigateToWeekWithRemainingDays();
                        }
                    }
                    
                    // Hide next up in Heute card
                    if (nextUpInHeute) {
                        nextUpInHeute.style.display = 'none';
                    }
                } else {
                    const { l, type, start, end, dayIndex, offset, weekKey } = info;
                    const startLbl = timeLabelFromMinutes(dayStart, start);
                    const endLbl = timeLabelFromMinutes(dayStart, end);
                    const dayLbl = state.days[dayIndex] || `Tag ${dayIndex + 1}`;
                    
                    // Calculate time until lesson
                    const now = new Date();
                    const lessonDate = new Date(now);
                    lessonDate.setDate(now.getDate() + offset);
                    const timeUntil = Math.max(0, Math.ceil((lessonDate.getTime() - now.getTime()) / (1000 * 60)));
                    
                    // Determine title based on type and offset
                    let title = t('nextUp');
                    if (type === 'now') {
                        title = t('now');
                    } else if (offset === 0) {
                        title = t('nextUp');
                    } else if (offset === 1) {
                        title = t('tomorrow');
                    } else if (offset > 1) {
                        title = `${dayLbl} (in ${offset} Tagen)`;
                    }
                    
                    // Format subtitle with comprehensive lesson details
                    let subtitle = `${l.subject} ${startLbl}–${endLbl}`;
                    
                    // Add room information
                    if (l.room) {
                        subtitle += ` • Raum ${l.room}`;
                    }
                    
                    // Add teacher information
                    if (l.teacher) {
                        subtitle += ` • ${l.teacher}`;
                    }
                    
                    // Add duration information
                    const duration = l.span * state.periodMinutes;
                    subtitle += ` • ${duration} Min`;
                    
                    // Add importance indicator
                    if (l.importance) {
                        subtitle += ` • <span class="ico"><svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"></polygon></svg></span> Wichtig`;
                    }
                    
                    // Add week info if it's in a different week
                    if (weekKey && weekKey !== getCurrentWeekKey()) {
                        const weekNum = getWeekNumber(new Date(weekKey));
                        subtitle += ` • KW ${weekNum}`;
                    }
                    
                    // Add time until lesson
                    if (type !== 'now' && offset >= 0) {
                        if (offset === 0) {
                            subtitle += ` • in ${Math.max(0, Math.ceil((start - minutesSinceStart(now)) / 60))}h`;
                        } else {
                            subtitle += ` • in ${offset} Tag${offset > 1 ? 'en' : ''}`;
                        }
                    }
                    
                    // Update main next up section
                    nextUpTitle.textContent = title;
                    nextUpSubtitle.textContent = subtitle;
                    
                    // Hide create button when lessons exist
                    if (nextUpActions) {
                        nextUpActions.style.display = 'none';
                    }
                    
                    // Update Heute card - show all today's lessons using existing renderTodayList
                    const listTodayElement = byId('listToday');
                    if (listTodayElement) {
                        renderTodayList('listToday', selectedPlan);
                    }
                    
                    // Hide the old next-up section since we're using the list now
                    if (nextUpInHeute) {
                        nextUpInHeute.style.display = 'none';
                    }
                }
                
            } catch (error) {
                console.error('Error updating next up section:', error);
            }
        }

        function navigateToWeekWithRemainingDays() {
            try {
                const now = new Date();
                const today = (now.getDay() + 6) % 7; // Convert to Monday=0 format
                const currentWeekKey = getCurrentWeekKey();
                
                // Get all week keys and sort them chronologically
                const allWeekKeys = Array.from(weekPlans.keys()).sort((a, b) => weekKeyCompare(a, b));
                
                // Find current week index and check from there onwards
                const currentWeekIndex = allWeekKeys.findIndex(key => key === currentWeekKey);
                const weeksToCheck = allWeekKeys.slice(Math.max(0, currentWeekIndex));
                
                // Look for the first week that has remaining days
                for (const weekKey of weeksToCheck) {
                    const plan = weekPlans.get(weekKey);
                    if (!plan || !plan.days || plan.days.length === 0) continue;
                    
                    const weekOffset = weekKeyCompare(weekKey, currentWeekKey);
                    
                    // Check if this week has any remaining days
                    for (let dayIndex = 0; dayIndex < plan.days.length; dayIndex++) {
                        // For current week, only check days from today onwards
                        if (weekOffset === 0 && dayIndex < today) continue;
                        
                        // Check if this day has any lessons
                        const dayLessons = plan.lessons.filter(l => l.day === dayIndex);
                        
                        // If this day has no lessons or has some empty periods, it's a good candidate
                        if (dayLessons.length === 0 || dayLessons.length < plan.periodCount) {
                            // Navigate to Plan section and switch to this week
                            slideToPage('pagePlan');
                            activatePill(byId('navPlan'));
                            
                            // Switch to the target week
                            currentPlanWeek = weekKey;
                            localStorage.setItem('currentPlanWeek', currentPlanWeek);
                            
                            // Render the grid for this week
                            renderGrid();
                            updatePlanSettingsForCurrentWeek();
                            
                            console.log(`Navigated to week ${weekKey}, day ${dayIndex} (${plan.days[dayIndex]})`);
                            return;
                        }
                    }
                }
                
                // If no week with remaining days found, just go to current week
                slideToPage('pagePlan');
                activatePill(byId('navPlan'));
                currentPlanWeek = currentWeekKey;
                localStorage.setItem('currentPlanWeek', currentWeekKey);
                renderGrid();
                updatePlanSettingsForCurrentWeek();
                
            } catch (error) {
                console.error('Error navigating to week with remaining days:', error);
                // Fallback: just go to Plan section
                slideToPage('pagePlan');
                activatePill(byId('navPlan'));
                updatePlanSettingsForCurrentWeek();
            }
        }

        function getCurrentOrNextLesson() {
            const now = new Date();
            const today = (now.getDay() + 6) % 7;
            const nowMin = minutesSinceStart(now);
            const block = state.periodMinutes + state.breakMinutes;
            const currentWeekKey = getCurrentWeekKey();

            // First, check if there's a lesson happening right now (current week only)
            const currentPlan = weekPlans.get(currentWeekKey);
            if (currentPlan && currentPlan.lessons.length > 0) {
                const todayLs = currentPlan.lessons.filter(l => l.day === today);
                for (const l of todayLs) {
                    const start = l.startIndex * block;
                    const end = start + l.span * state.periodMinutes;
                    if (nowMin >= start && nowMin < end) {
                        return { type: 'now', l, start, end, dayIndex: today, offset: 0, weekKey: currentWeekKey };
                    }
                }
            }

            // Search for next lesson across ALL weeks
            const allUpcomingLessons = [];

            // Get all week keys and sort them chronologically
            const allWeekKeys = Array.from(weekPlans.keys()).sort((a, b) => weekKeyCompare(a, b));
            
            // Find current week index and check from there onwards
            const currentWeekIndex = allWeekKeys.findIndex(key => key === currentWeekKey);
            const weeksToCheck = allWeekKeys.slice(Math.max(0, currentWeekIndex));

            for (const weekKey of weeksToCheck) {
                const plan = weekPlans.get(weekKey);
                if (!plan || !plan.lessons.length) continue;
                
                const weekOffset = weekKeyCompare(weekKey, currentWeekKey);
                
                for (const l of plan.lessons) {
                    const start = l.startIndex * block;
                    const end = start + l.span * state.periodMinutes;
                    const lessonDay = l.day;
                    
                    // Skip lessons in the past
                    if (weekOffset === 0) {
                        if (lessonDay < today) continue;
                        if (lessonDay === today && start <= nowMin) continue;
                    }
                    
                    // Calculate actual day offset from today
                    const currentDay = (now.getDay() + 6) % 7; // Monday = 0
                    const daysFromToday = (weekOffset * 7) + lessonDay - currentDay;
                    
                    allUpcomingLessons.push({
                        l,
                        start,
                        end,
                        dayIndex: lessonDay,
                        offset: Math.max(0, daysFromToday),
                        weekKey,
                        absoluteDay: lessonDay + (weekOffset * 7)
                    });
                }
            }

            // Fallback to state.lessons if no week plans exist
            if (allUpcomingLessons.length === 0 && state.lessons.length > 0) {
                for (const l of state.lessons) {
                    const start = l.startIndex * block;
                    const end = start + l.span * state.periodMinutes;
                    const lessonDay = l.day;

                    // Skip if this lesson is in the past
                    if (lessonDay < today) continue;
                    if (lessonDay === today && start <= nowMin) continue;
                    // Calculate actual day offset from today for fallback lessons
                    const currentDay = (now.getDay() + 6) % 7; // Monday = 0
                    const daysFromToday = lessonDay - currentDay;
                    
                    allUpcomingLessons.push({
                        l,
                        start,
                        end,
                        dayIndex: lessonDay,
                        offset: Math.max(0, daysFromToday),
                        weekKey: currentWeekKey,
                        absoluteDay: lessonDay
                    });
                }
            }
            
            // Sort by day offset first, then by day, then by start time
            allUpcomingLessons.sort((a, b) => {
                if (a.offset !== b.offset) return a.offset - b.offset;
                if (a.dayIndex !== b.dayIndex) return a.dayIndex - b.dayIndex;
                return a.start - b.start;
            });
            
            if (allUpcomingLessons.length > 0) {
                return { type: "next", ...allUpcomingLessons[0] };
            }

            return null;
        }

        function getTodayLessons() {
            const now = new Date();
            const today = (now.getDay() + 6) % 7;
            const nowMin = minutesSinceStart(now);
            const block = state.periodMinutes + state.breakMinutes;
            const currentWeekKey = getCurrentWeekKey();

            const currentPlan = weekPlans.get(currentWeekKey);
            if (!currentPlan || !currentPlan.lessons.length) {
                return { lessons: [], currentLesson: null };
            }

            const todayLs = currentPlan.lessons.filter(l => l.day === today);
            const allTodayLessons = [];
            let currentLesson = null;

            for (const l of todayLs) {
                const start = l.startIndex * block;
                const end = start + l.span * state.periodMinutes;
                
                const lessonInfo = {
                    l,
                    start,
                    end,
                    dayIndex: today,
                    offset: 0,
                    weekKey: currentWeekKey,
                    isCurrent: nowMin >= start && nowMin < end,
                    isPast: end <= nowMin,
                    isFuture: start > nowMin
                };

                allTodayLessons.push(lessonInfo);
                
                if (lessonInfo.isCurrent) {
                    currentLesson = lessonInfo;
                }
            }

            // Sort by start time
            allTodayLessons.sort((a, b) => a.start - b.start);

            return { 
                lessons: allTodayLessons, 
                currentLesson: currentLesson,
                hasLessons: allTodayLessons.length > 0
            };
        }

        function renderOverviewHeroCompact() {
            const heroSub = byId('ovHeroSub');
            const info = getCurrentOrNextLesson();

            if (!info) {
                heroSub.innerHTML = `<div class="hero-compact">
                    <div><div class="hc-title">Heute: nichts mehr anstehend</div>
                    <div class="hc-meta">Alles geschafft <span class="ico"><svg viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4"></path><circle cx="12" cy="12" r="10"></circle></svg></span></div></div>
                    <div style="width:60px;height:60px"></div>
                    </div>`;
                return;
            }

            const { l, type, start, end, dayIndex } = info;
            const title = type === 'now' ? 'Jetzt' : 'Als Nächstes';
            const startLbl = timeLabelFromMinutes(dayStart, start);
            const endLbl = timeLabelFromMinutes(dayStart, end);
            const dayLbl = state.days[dayIndex] || `Tag ${dayIndex + 1}`;
            const meta = `${dayLbl}: <strong>${l.subject}</strong> ${startLbl}–${endLbl} | Raum ${l.room || '–'} | ${l.teacher || ''}`;

            const folder = findFolderForSubject(l.subject);
            const col = folder?.color || '#e5e7eb';
            const folderHtml = folder
                ? `<button class="folder-tile" id="ovHeroFolder" data-folder-id="${folder.id}" style="--col:${col}">
                        <span class="swatch"></span>
                    </button>`
                : `<button class="folder-tile" id="ovHeroCreateFolder" style="--col:#e5e7eb" title="Ordner anlegen">
                        <span class="swatch"></span>
                    </button>`;

            heroSub.innerHTML = `
                    <div class="hero-compact">
                    <div>
                    <div class="hc-title">${title}</div>
                    <div class="hc-meta">${meta}</div>
                    </div>
                    ${folderHtml}
                    </div>`;

            // Ordner-Klicks
            byId('ovHeroFolder')?.addEventListener('click', e => {
                const id = e.currentTarget.getAttribute('data-folder-id');
                if (id) { byId('navFolders').click(); openFolderDetail(id); }
            });
            byId('ovHeroCreateFolder')?.addEventListener('click', () => {
                byId('navFolders').click();
                openFolderEdit(null);
            });
        }


        function nextLessonLabel() {
            const info = currentOrNextLesson();
            if (info.type === 'none') return 'Heute: <strong>keine Stunde mehr</strong>.';

            const l = info.lesson;
            const start = timeLabelFromMinutes(dayStart, info.startMin);
            const end = timeLabelFromMinutes(dayStart, info.endMin);

            const dayLabel =
                (info.type === 'now')
                    ? 'Jetzt'
                    : (info.offset === 0
                        ? 'Als Nächstes'
                        : (info.offset === 1
                            ? 'Morgen'
                            : (state.days[info.dayIndex] || `Tag ${info.dayIndex + 1}`)));

            // Ordner ermitteln
            const folder = findFolderForSubject(l.subject);
            const folderHtml = folder
                ? `<span class="badge clickable" id="ovHeroFolder" data-folder-id="${folder.id}">Ordner: ${folder.name}</span>`
                : `<button class="btn mini primary" id="ovHeroCreateFolder">Ordner anlegen</button>`;

            // Restzeit, wenn gerade läuft
            let restHtml = '';
            if (info.type === 'now') {
                const minsLeft = Math.max(0, Math.ceil(info.endMin - minutesSinceStart(new Date())));
                restHtml = ` • <span class="meta">(${minsLeft} Min übrig)</span>`;
            }

            return `${dayLabel}: <strong>${l.subject}</strong> · ${start}–${end} · Raum ${l.room || '–'} · ${l.teacher || ''}${restHtml} &nbsp; ${folderHtml}`;
        }


        function calcWeekStats() {
            const minutes = state.lessons.reduce((sum, l) => sum + l.span * state.periodMinutes, 0);
            return { count: state.lessons.length, minutes, hours: Math.round(minutes / 60) };
        }
        function calcTodayStats() {
            const now = new Date(); const day = (now.getDay() + 6) % 7;
            const occ = new Set(state.lessons.filter(l => l.day === day).flatMap(l => {
                return Array.from({ length: l.span }, (_, i) => l.startIndex + i);
            }));
            const busy = occ.size;
            const free = Math.max(0, state.periodCount - busy);
            return { busyBlocks: busy, freeBlocks: free };
        }

        // returns an array of same shape but with color strings or null
        function buildHeatMatrix() {
            // matrix[period][day] = { color, importance } | null
            const m = Array.from({ length: state.periodCount }, () => Array(state.days.length).fill(null));

            for (const l of state.lessons) {
                const color = (l.color && l.color.trim()) || dataState.subjectColors[(l.subject || "").trim()] || "#60a5fa";
                for (let i = 0; i < l.span; i++) {
                    const p = l.startIndex + i;
                    if (p >= 0 && p < state.periodCount && l.day < state.days.length) {
                        // if multiple items collide visually, first wins
                        if (!m[p][l.day]) {
                            m[p][l.day] = { color, importance: !!l.importance };
                        }
                    }
                }
            }
            return m; // periods as rows (colors)
        }


        function subjectDistribution() {
            const map = new Map();
            for (const l of state.lessons) {
                const key = (l.subject || '—').trim();
                map.set(key, (map.get(key) || 0) + 1);
            }
            const labels = [...map.keys()];
            const values = labels.map(k => map.get(k));
            return { labels, values };
        }

        function drawHeatmap(id, matrix) {
            const el = byId(id); if (!el) return;

            // Clean up any existing tooltips before redrawing
            document.querySelectorAll('.heatmap-tooltip').forEach(tooltip => {
                if (tooltip.parentNode) {
                    tooltip.parentNode.removeChild(tooltip);
                }
            });

            el.innerHTML = '';
            const containerW = el.clientWidth || 300;

            // Use state for heatmap dimensions
            const days = state.days;
            const periodCount = state.periodCount;

            // Calculate cell dimensions - make cells much wider to reduce white space
            const cellW = Math.max(35, Math.floor(containerW / (days.length + 0.5)));
            const cellH = Math.max(18, 20); // Fixed height per cell
            
            // Reduce time column width further
            const timeColumnWidth = Math.max(30, Math.floor(cellW * 0.5)); // Make time column even narrower

            // Calculate total dimensions based on actual content
            const w = timeColumnWidth + cellW * days.length;
            const h = cellH * (periodCount + 1);

            // Update container height to fit content
            el.style.height = h + 'px';

            const svg = svgEl('svg', { width: w, height: h });

            // day headers
            days.forEach((d, dx) => svg.appendChild(svgText(d, timeColumnWidth + cellW * dx + cellW / 2, cellH * 0.6)));

            // period labels
            for (let p = 0; p < periodCount; p++) {
                const lbl = timeLabelFromMinutes(dayStart, p * (state.periodMinutes + state.breakMinutes));
                svg.appendChild(svgText(lbl, timeColumnWidth * 0.5, cellH * (p + 1.5)));
            }
            
            // Add horizontal lines between hours (only in the lesson area)
            for (let p = 1; p < periodCount; p++) {
                const lineY = cellH * (p + 1);
                const horizontalLine = svgEl('line', {
                    x1: timeColumnWidth,
                    y1: lineY,
                    x2: w,
                    y2: lineY,
                    stroke: '#e5e7eb',
                    'stroke-width': '1'
                });
                svg.appendChild(horizontalLine);
            }

            // Render lessons as continuous blocks
            for (let d = 0; d < days.length; d++) {
                const dayLessons = matrix[d] || [];
                
                dayLessons.forEach(lesson => {
                    const x = timeColumnWidth + cellW * d;
                    const y = cellH * (lesson.startIndex + 1);
                    const width = cellW;
                    const height = cellH * lesson.span;
                    
                    const color = lesson.color || dataState.subjectColors[(lesson.subject || "").trim()] || "#60a5fa";
                    const rect = svgRect(x + 2, y + 2, width - 4, height - 4, 6, color);

                    // Add hover functionality
                    rect.style.cursor = 'pointer';
                    rect.addEventListener('mouseenter', (e) => {
                        const timeRange = formatRange(lesson);
                        const importanceText = lesson.importance ? ' ⚠️ Wichtig' : '';
                        const tooltipContent = `${lesson.subject}${importanceText}\n${timeRange}\nRaum: ${lesson.room || '–'}\nLehrer: ${lesson.teacher || '–'}`;

                        // Create tooltip
                        const tooltip = document.createElement('div');
                        tooltip.className = 'heatmap-tooltip';
                        tooltip.textContent = tooltipContent;
                        tooltip.style.whiteSpace = 'pre-line';
                        document.body.appendChild(tooltip);

                        // Position tooltip
                        const rectBounds = rect.getBoundingClientRect();
                        const tooltipBounds = tooltip.getBoundingClientRect();

                        let left = rectBounds.left + (rectBounds.width / 2) - (tooltipBounds.width / 2);
                        let top = rectBounds.top - tooltipBounds.height - 10;

                        // Adjust if tooltip goes off screen
                        if (left < 10) left = 10;
                        if (left + tooltipBounds.width > window.innerWidth - 10) {
                            left = window.innerWidth - tooltipBounds.width - 10;
                        }
                        if (top < 10) {
                            top = rectBounds.bottom + 10;
                            tooltip.style.transform = 'translateY(0)';
                        }

                        tooltip.style.left = left + 'px';
                        tooltip.style.top = top + 'px';

                        // Show tooltip
                        setTimeout(() => tooltip.classList.add('show'), 10);

                        // Store tooltip reference for cleanup
                        rect._tooltip = tooltip;
                    });

                    rect.addEventListener('mouseleave', () => {
                        if (rect._tooltip) {
                            rect._tooltip.classList.remove('show');
                            setTimeout(() => {
                                if (rect._tooltip && rect._tooltip.parentNode) {
                                    rect._tooltip.parentNode.removeChild(rect._tooltip);
                                }
                                rect._tooltip = null;
                            }, 200);
                        }
                    });

                    svg.appendChild(rect);

                    // Add border for important lessons
                    if (lesson.importance) {
                        const border = svgRect(x + 1, y + 1, width - 2, height - 2, 6, 'none');
                        border.setAttribute('stroke', '#f59e0b');
                        border.setAttribute('stroke-width', '2');
                        svg.appendChild(border);
                    }
                });
            }
            el.appendChild(svg);

            // Add red time line to heatmap (only on current weekday, solid line)
            const currentTime = new Date();
            const today = ((currentTime.getDay() + 6) % 7); // Mo=0
            const nowMin = minutesSinceStart(currentTime);
            const totalSpan = periodCount * (state.periodMinutes + state.breakMinutes);
            const showRed = today < days.length && nowMin >= 0 && nowMin <= totalSpan;

            if (showRed) {
                const block = state.periodMinutes + state.breakMinutes;
                const redLineY = ((nowMin / block) * cellH) + cellH; // +cellH for header offset

                // Create solid red line only on current weekday
                const currentDayX = timeColumnWidth + cellW * today;
                const redLine = svgEl('line', {
                    x1: currentDayX,
                    y1: redLineY,
                    x2: currentDayX + cellW,
                    y2: redLineY,
                    stroke: '#ef4444',
                    'stroke-width': '2'
                });
                svg.appendChild(redLine);
            }

            // Add completed overlays for past days and individual lessons
            const currentWeekKey = getCurrentWeekKey();
            const isPastWeek = weekKeyCompare(currentHeatmapWeek, currentWeekKey) < 0;
            const isCurrentWeek = currentHeatmapWeek === currentWeekKey;
            const dayOfWeek = new Date().getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            
            const heatmapPlan = getHeatmapWeekPlan();
            for (let d = 0; d < state.days.length; d++) {
                const dayLessons = heatmapPlan.lessons.filter(l => l.day === d);
                
                if (isPastWeek) {
                    // Past weeks: full overlay for all days
                    const completedOverlay = svgEl('rect', {
                        x: timeColumnWidth + cellW * d,
                        y: cellH,
                        width: cellW,
                        height: h - cellH,
                        fill: 'rgba(34, 197, 94, 0.1)',
                        'pointer-events': 'none'
                    });
                    svg.appendChild(completedOverlay);

                    const checkmark = svgEl('text', {
                        x: timeColumnWidth + cellW * d + cellW / 2,
                        y: h / 2,
                        'text-anchor': 'middle',
                        'dominant-baseline': 'middle',
                        fill: 'rgba(255, 255, 255, 0.8)',
                        'font-size': '48',
                        'font-weight': '900',
                        'pointer-events': 'none'
                    });
                    checkmark.textContent = '✓';
                    svg.appendChild(checkmark);
                } else if (isCurrentWeek && d < today && dayOfWeek !== 0 && dayOfWeek !== 6) {
                    // Current week: only past days (but not on weekends)
                    const completedOverlay = svgEl('rect', {
                        x: timeColumnWidth + cellW * d,
                        y: cellH,
                        width: cellW,
                        height: h - cellH,
                        fill: 'rgba(34, 197, 94, 0.1)',
                        'pointer-events': 'none'
                    });
                    svg.appendChild(completedOverlay);

                    const checkmark = svgEl('text', {
                        x: timeColumnWidth + cellW * d + cellW / 2,
                        y: h / 2,
                        'text-anchor': 'middle',
                        'dominant-baseline': 'middle',
                        fill: 'rgba(255, 255, 255, 0.8)',
                        'font-size': '48',
                        'font-weight': '900',
                        'pointer-events': 'none'
                    });
                    checkmark.textContent = '✓';
                    svg.appendChild(checkmark);
                } else if (isCurrentWeek && d === today && showRed && dayOfWeek !== 0 && dayOfWeek !== 6) {
                    // Today: overlay up to current time
                    const block = heatmapPlan.periodMinutes + heatmapPlan.breakMinutes;
                    const currentProgressY = ((nowMin / block) * cellH) + cellH;
                    
                    if (currentProgressY > cellH) {
                        const completedOverlay = svgEl('rect', {
                            x: timeColumnWidth + cellW * d,
                            y: cellH,
                            width: cellW,
                            height: currentProgressY - cellH,
                            fill: 'rgba(34, 197, 94, 0.1)',
                            'pointer-events': 'none'
                        });
                        svg.appendChild(completedOverlay);
                    }
                    
                    // Mark individual completed lessons
                    dayLessons.forEach(lesson => {
                        const lessonEnd = (lesson.startIndex * block) + (lesson.span * heatmapPlan.periodMinutes);
                        if (nowMin > lessonEnd) {
                            const lessonY = cellH * (lesson.startIndex + 1);
                            const lessonHeight = cellH * lesson.span;
                            
                            const lessonOverlay = svgEl('rect', {
                                x: timeColumnWidth + cellW * d + 2,
                                y: lessonY + 2,
                                width: cellW - 4,
                                height: lessonHeight - 4,
                                fill: 'rgba(34, 197, 94, 0.2)',
                                'pointer-events': 'none'
                            });
                            svg.appendChild(lessonOverlay);
                        }
                    });
                }
            }

            // Add global cleanup for tooltips on scroll/resize
            const cleanupTooltips = () => {
                document.querySelectorAll('.heatmap-tooltip').forEach(tooltip => {
                    if (tooltip.parentNode) {
                        tooltip.parentNode.removeChild(tooltip);
                    }
                });
            };

            // Clean up tooltips on various events
            window.addEventListener('scroll', cleanupTooltips);
            window.addEventListener('resize', cleanupTooltips);

            // Also clean up when clicking elsewhere
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.chart-wrap')) {
                    cleanupTooltips();
                }
            });
        }


        function drawBars(id, labels, values) {
            const el = byId(id); if (!el) return; el.innerHTML = '';
            if (!labels.length) { el.innerHTML = '<div class="small">Keine Daten</div>'; return; }
            const w = el.clientWidth || 300; const h = el.clientHeight || 220;
            const padL = 90, padR = 12, padT = 10, padB = 24;
            const max = Math.max(...values, 1);
            const barH = Math.min(26, Math.floor((h - padT - padB) / labels.length) - 6);

            const svg = svgEl('svg', { width: w, height: h });
            labels.forEach((lab, i) => {
                const y = padT + i * (barH + 8);
                const val = values[i];
                const bw = ((w - padL - padR) * val) / max;
                svg.appendChild(svgText(lab, padL - 10, y + barH * 0.75, 'end'));
                svg.appendChild(svgRect(padL, y, bw, barH, 8, '#34d399'));
                svg.appendChild(svgText(String(val), padL + bw + 6, y + barH * 0.75, 'start', 12, '#475569'));
            });
            el.appendChild(svg);
        }

        function svgEl(tag, attrs) { const n = document.createElementNS('http://www.w3.org/2000/svg', tag); for (const k in attrs) n.setAttribute(k, attrs[k]); return n; }
        function svgRect(x, y, w, h, r, fill) { const rct = svgEl('rect', { x, y, width: w, height: h, rx: r, ry: r, fill }); return rct; }
        function svgText(text, x, y, anchor = 'middle', size = 12, fill = '#0f172a') {
            const t = svgEl('text', { x, y, 'text-anchor': anchor, 'dominant-baseline': 'middle', fill, 'font-size': size }); t.textContent = text; return t;
        }

        /* ===== Listen ===== */
        function renderTodayList(targetId, plan = null) {
            const box = byId(targetId); if (!box) return; box.innerHTML = '';
            const now = new Date(); const day = (now.getDay() + 6) % 7;
            const block = (plan?.periodMinutes || state.periodMinutes) + (plan?.breakMinutes || state.breakMinutes);
            const lessons = plan?.lessons || state.lessons;
            const list = lessons
                .filter(l => l.day === day)
                .map(l => {
                    const startMin = l.startIndex * block;
                    const endMin = startMin + l.span * (plan?.periodMinutes || state.periodMinutes);
                    return { l, start: timeLabelFromMinutes(dayStart, startMin), end: timeLabelFromMinutes(dayStart, endMin) };
                })
                .sort((a, b) => a.start.localeCompare(b.start));

            if (!list.length) { box.innerHTML = '<div class="small">Heute nichts geplant.</div>'; return; }
            list.forEach(it => {
                const row = document.createElement('div'); row.className = 'mini-item';
                
                // Find folder for this subject
                const folder = findFolderForSubject(it.l.subject);
                const folderHtml = folder
                    ? `<button class="folder-tile" data-folder-id="${folder.id}" style="--col:${folder.color || '#e5e7eb'}" title="Ordner öffnen"><span class="swatch"></span></button>`
                    : `<button class="folder-tile" data-folder-id="create" style="--col:#e5e7eb" title="Ordner anlegen"><span class="swatch"></span></button>`;
                
                row.innerHTML = `<div><strong>${it.l.subject}</strong><div class="meta">${it.start}–${it.end} · Raum ${it.l.room || '–'} · ${it.l.teacher || ''}</div></div>
                <div class="mini-item-right">
                    <span class="badge">${it.l.span}×${state.periodMinutes}</span>
                    ${folderHtml}
                </div>`;
                
                // Add click handlers
                row.addEventListener('click', (e) => {
                    if (!e.target.closest('.folder-tile')) {
                        openInfo(it.l.id);
                    }
                });
                
                // Folder click handler
                const folderBtn = row.querySelector('.folder-tile');
                folderBtn?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const folderId = folderBtn.getAttribute('data-folder-id');
                    if (folderId === 'create') {
                        byId('navFolders')?.click();
                        openFolderEdit(null);
                    } else {
                        byId('navFolders')?.click();
                        openFolderDetail(folderId);
                    }
                });
                
                box.appendChild(row);
            });
        }

        function renderRecentFiles(targetId) {
            const box = byId(targetId); if (!box) return; box.innerHTML = '';
            const items = folderState.folders.flatMap(f => f.items.map(it => ({ ...it, folder: f.name })))
                .sort((a, b) => new Date(b.added) - new Date(a.added)).slice(0, 6);
            if (!items.length) { box.innerHTML = '<div class="small">Noch keine Dateien.</div>'; return; }
            items.forEach(it => {
                const row = document.createElement('div'); row.className = 'mini-item';
                row.innerHTML = `<div><strong>${it.name}</strong><div class="meta">${it.folder} • ${it.ext.toUpperCase()} • ${new Date(it.added).toLocaleString()}</div></div>
                    <span class="badge">${it.topic}</span>`;
                row.addEventListener('click', () => { hideModal(document.querySelector('.modal[aria-hidden="false"]') || { setAttribute: () => { } }); byId('navFolders').click(); });
                box.appendChild(row);
            });
        }

        /* ===== Pomodoro-Timer (25/5) ===== */
        /* ===== Pomodoro-Timer (25/5) – Toggle Start/Pause ===== */
        let pom = { lenFocus: 25 * 60, lenBreak: 5 * 60, left: 25 * 60, mode: 'focus', running: false, t: null };

        function initPomodoroOnce() {
            if (initPomodoroOnce.did) return; initPomodoroOnce.did = true;

            const face = byId('pomFace');
            const pomCard = byId('pomCard');

            // Check if all required elements exist
            if (!face || !pomCard) {
                console.warn('Pomodoro elements not found, skipping initialization');
                return;
            }

            const fmt = s => {
                if (s >= 3600) {
                    // HH:MM:SS format for times >= 1 hour
                    const hours = Math.floor(s / 3600);
                    const minutes = Math.floor((s % 3600) / 60);
                    const seconds = s % 60;
                    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                } else {
                    // MM:SS format for times < 1 hour
                    return `${String(Math.floor(s / 60)).padStart(2, '0')}:${String(s % 60).padStart(2, '0')}`;
                }
            };

            const setToggleUI = () => {
                if (pom.running) {
                    face.classList.add('running');
                } else {
                    face.classList.remove('running');
                }
            };

            const render = () => {
                const timerDisplay = face.querySelector('.timer-display');
                if (timerDisplay) {
                    timerDisplay.textContent = fmt(pom.left);
                } else {
                    face.textContent = fmt(pom.left);
                }
            };

            const formatTimeInput = (input) => {
                // Remove all non-digits
                const digits = input.replace(/\D/g, '');
                
                if (digits.length === 0) return '';
                if (digits.length <= 2) return digits;
                if (digits.length === 3) return digits.slice(0, 2) + ':' + digits.slice(2);
                if (digits.length === 4) return digits.slice(0, 2) + ':' + digits.slice(2);
                if (digits.length === 5) return digits.slice(0, 2) + ':' + digits.slice(2, 4) + ':' + digits.slice(4);
                if (digits.length === 6) return digits.slice(0, 2) + ':' + digits.slice(2, 4) + ':' + digits.slice(4);
                
                // Limit to 6 digits (99:59:59)
                return digits.slice(0, 6).replace(/(\d{2})(\d{2})(\d{2})/, '$1:$2:$3');
            };
            
            const parseTimeInput = (input) => {
                // Remove all non-digits and colons
                const clean = input.replace(/[^\d:]/g, '');
                
                if (clean === '') return null;
                
                // Split by colons
                const parts = clean.split(':');
                
                if (parts.length === 1) {
                    // Single number - determine format
                    const num = parseInt(parts[0]);
                    if (num < 60) {
                        return num; // seconds
                    } else if (num < 100) {
                        return num * 60; // minutes
                    } else if (parts[0].length === 4) {
                        // 4 digits: HHMM or MMSS format
                        const str = parts[0].padStart(4, '0');
                        const first = parseInt(str.slice(0, 2));
                        const second = parseInt(str.slice(2, 4));
                        
                        if (first < 24) {
                            return first * 3600 + second * 60; // HH:MM format
                        } else {
                            return first * 60 + second; // MM:SS format
                        }
                    } else if (parts[0].length === 6) {
                        // 6 digits: HHMMSS format
                        const str = parts[0].padStart(6, '0');
                        const hours = parseInt(str.slice(0, 2));
                        const minutes = parseInt(str.slice(2, 4));
                        const seconds = parseInt(str.slice(4, 6));
                        return hours * 3600 + minutes * 60 + seconds;
                    } else {
                        // Other lengths: treat as MM:SS
                        const str = parts[0].padStart(4, '0');
                        const first = parseInt(str.slice(0, 2));
                        const second = parseInt(str.slice(2, 4));
                        return first * 60 + second;
                    }
                } else if (parts.length === 2) {
                    // MM:SS format - normalize invalid values
                    let minutes = parseInt(parts[0]) || 0;
                    let seconds = parseInt(parts[1]) || 0;
                    
                    // Normalize seconds (carry over to minutes)
                    if (seconds >= 60) {
                        minutes += Math.floor(seconds / 60);
                        seconds = seconds % 60;
                    }
                    
                    // Limit minutes to 99 (99:59 = 5999 seconds)
                    if (minutes > 99) {
                        minutes = 99;
                        seconds = 59;
                    }
                    
                    return minutes * 60 + seconds;
                } else if (parts.length === 3) {
                    // HH:MM:SS format - normalize invalid values
                    let hours = parseInt(parts[0]) || 0;
                    let minutes = parseInt(parts[1]) || 0;
                    let seconds = parseInt(parts[2]) || 0;
                    
                    // Normalize seconds (carry over to minutes)
                    if (seconds >= 60) {
                        minutes += Math.floor(seconds / 60);
                        seconds = seconds % 60;
                    }
                    
                    // Normalize minutes (carry over to hours)
                    if (minutes >= 60) {
                        hours += Math.floor(minutes / 60);
                        minutes = minutes % 60;
                    }
                    
                    // Limit hours to 99 (99:59:59 = 359999 seconds)
                    if (hours > 99) {
                        hours = 99;
                        minutes = 59;
                        seconds = 59;
                    }
                    
                    return hours * 3600 + minutes * 60 + seconds;
                }
                
                return null;
            };
            
            const startEditMode = () => {
                if (pom.running) return; // Don't allow editing while running
                
                const timerDisplay = face.querySelector('.timer-display');
                if (!timerDisplay) return;
                
                const currentTime = timerDisplay.textContent;
                timerDisplay.contentEditable = true;
                timerDisplay.textContent = '';
                timerDisplay.focus();
                
                // Add edit mode styling
                timerDisplay.classList.add('editing');
                
                const finishEdit = () => {
                    timerDisplay.contentEditable = false;
                    timerDisplay.classList.remove('editing');
                    
                    const timeText = timerDisplay.textContent.trim();
                    const totalSeconds = parseTimeInput(timeText);
                    
                    if (totalSeconds !== null && totalSeconds > 0 && totalSeconds <= 359999) { // Max 99:59:59
                        pom.left = totalSeconds;
                        pom.lenFocus = totalSeconds;
                        render();
                    } else {
                        // Reset to valid default if invalid
                        pom.lenFocus = 25 * 60;
                        pom.left = pom.lenFocus;
                        render();
                    }
                };
                
                // Handle input events for real-time formatting
                timerDisplay.addEventListener('input', (e) => {
                    const formatted = formatTimeInput(e.target.textContent);
                    e.target.textContent = formatted;
                    
                    // Set cursor to end
                    const range = document.createRange();
                    const sel = window.getSelection();
                    range.selectNodeContents(e.target);
                    range.collapse(false);
                    sel.removeAllRanges();
                    sel.addRange(range);
                });
                
                // Finish edit on Enter key
                timerDisplay.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        finishEdit();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        timerDisplay.contentEditable = false;
                        timerDisplay.classList.remove('editing');
                        render(); // Reset to current time
                    }
                });
                
                // Finish edit on blur (click outside)
                timerDisplay.addEventListener('blur', finishEdit);
            };
            
            const triggerTimerEndEffects = () => {
                // Add red background and blinking to timer
                pomCard.classList.add('timer-ended');
                
                // Add website blinking effect
                document.body.classList.add('website-blink');
                
                // Remove effects after animation completes
                setTimeout(() => {
                    pomCard.classList.remove('timer-ended');
                    document.body.classList.remove('website-blink');
                }, 6000); // 2s * 3 blinks = 6s total
            };

            const tick = () => {
                if (!pom.running) return;
                pom.left--;
                if (pom.left <= 0) {
                    // Trigger end effects when timer reaches 0
                    triggerTimerEndEffects();
                    
                    if (pom.mode === 'focus') { pom.mode = 'break'; pom.left = pom.lenBreak; }
                    else { pom.mode = 'focus'; pom.left = pom.lenFocus; }
                }
                render();
            };

            const toggleTimer = () => {
                pom.running = !pom.running;
                if (pom.running && !pom.t) {
                    pom.t = setInterval(tick, 1000);
                } else if (!pom.running && pom.t) {
                    clearInterval(pom.t);
                    pom.t = null;
                }
                setToggleUI();
                render();
            };

            let clickTimeout = null;
            let isDoubleClick = false;
            
            face.addEventListener('click', (e) => {
                if (isDoubleClick) {
                    isDoubleClick = false;
                    return;
                }
                
                clickTimeout = setTimeout(() => {
                    if (!isDoubleClick) {
                        toggleTimer();
                    }
                }, 200); // Wait 200ms to see if it's a double click
            });
            
            // Add double-click to edit mode for timer display
            const timerDisplay = face.querySelector('.timer-display');
            if (timerDisplay) {
                timerDisplay.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    isDoubleClick = true;
                    clearTimeout(clickTimeout);
                    startEditMode();
                });
            }

            byId('pomReset')?.addEventListener('click', (e) => {
                e.stopPropagation();
                pom.running = false;
                pom.mode = 'focus';
                // Ensure lenFocus is valid, fallback to 25 minutes
                if (pom.lenFocus <= 0 || pom.lenFocus > 359999) {
                    pom.lenFocus = 25 * 60;
                }
                pom.left = pom.lenFocus;
                if (pom.t) {
                    clearInterval(pom.t);
                    pom.t = null;
                }
                setToggleUI();
                render();
            });

            setToggleUI();
            render();
        }

        // Quick-Links
        byId('ovGoPlan')?.addEventListener('click', () => byId('navPlan').click());
        byId('ovGoFolders')?.addEventListener('click', () => byId('navFolders').click());
        byId('ovGoSettings')?.addEventListener('click', () => byId('navSettings').click());

        function renderPresetManager() {
            const host = byId('presetManager');
            if (!host) return;
            const subjColors = dataState.subjectColors || {};
            const presets = dataState.presets || [];

            // subjects + colors editor
            const subjects = [...new Set([...(dataState.subjects || []), ...Object.keys(subjColors)])].sort((a, b) => a.localeCompare(b));
            let html = `
                            <h4 style="margin:8px 0 6px">Fachfarben</h4>
                            <table class="preset-table">
                            <thead><tr><th>Fach</th><th>Farbe</th><th style="width:1%"></th></tr></thead>
                            <tbody>
                                ${subjects.map(s => `
                                <tr data-subj="${s}">
                                    <td>${s}</td>
                                    <td><input class="inline-color" type="color" value="${subjColors[s] || '#60a5fa'}" data-role="subj-color"></td>
                                    <td><button class="btn mini danger" data-role="remove-subj">Entfernen</button></td>
                                </tr>
                                `).join('')}
                                <tr>
                                <td><input class="inline-input" placeholder="Neues Fach"></td>
                                <td><input class="inline-color" type="color" value="#60a5fa"></td>
                                <td><button class="btn mini primary" data-role="add-subj">Hinzufügen</button></td>
                                </tr>
                            </tbody>
                            </table>
                        `;

            // presets editor
            html += `
                            <h4 style="margin:16px 0 6px">Presets (Fach → Vorgaben)</h4>
                            <table class="preset-table">
                            <thead><tr><th>Fach</th><th>Lehrer:in</th><th>Raum</th><th>Farbe</th><th style="width:1%"></th></tr></thead>
                            <tbody>
                                ${presets.map((p, i) => `
                                <tr data-idx="${i}">
                                    <td><input class="inline-input" value="${p.subject || ''}" placeholder="Fach"></td>
                                    <td><input class="inline-input" value="${p.teacher || ''}" list="teacherList" placeholder="Lehrer:in"></td>
                                    <td><input class="inline-input" value="${p.room || ''}" list="roomList" placeholder="Raum"></td>
                                    <td><input class="inline-color" type="color" value="${p.color || dataState.subjectColors[p.subject] || '#60a5fa'}"></td>
                                    <td class="preset-row-actions"><button class="btn mini danger" data-role="remove-preset">×</button></td>
                                </tr>
                                `).join('')}
                                <tr data-idx="new">
                                <td><input class="inline-input" placeholder="Fach"></td>
                                <td><input class="inline-input" list="teacherList" placeholder="Lehrer:in"></td>
                                <td><input class="inline-input" list="roomList" placeholder="Raum"></td>
                                <td><input class="inline-color" type="color" value="#60a5fa"></td>
                                <td><button class="btn mini primary" data-role="add-preset">Hinzufügen</button></td>
                                </tr>
                            </tbody>
                            </table>
                        `;

            host.innerHTML = html;

            // Wire subject color table
            host.querySelectorAll('[data-role="subj-color"]').forEach(inp => {
                inp.addEventListener('input', (e) => {
                    const row = e.target.closest('tr');
                    const subj = row.dataset.subj;
                    dataState.subjectColors[subj] = e.target.value;
                    saveData();
                });
            });
            host.querySelectorAll('[data-role="remove-subj"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const row = btn.closest('tr'); const subj = row.dataset.subj;
                    delete dataState.subjectColors[subj];
                    // do not remove from subjects[] list here; color removal only
                    saveData(); renderPresetManager();
                });
            });
            host.querySelector('[data-role="add-subj"]')?.addEventListener('click', () => {
                const row = host.querySelector('table tbody tr:last-child');
                const subj = row.querySelector('input.inline-input').value.trim();
                const col = row.querySelector('input.inline-color').value;
                if (!subj) return;
                if (!dataState.subjects.includes(subj)) dataState.subjects.push(subj);
                dataState.subjectColors[subj] = col;
                saveData(); renderPresetManager();
            });

            // Wire presets table
            host.querySelectorAll('[data-role="remove-preset"]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const i = Number(btn.closest('tr').dataset.idx);
                    dataState.presets.splice(i, 1);
                    saveData(); renderPresetManager();
                });
            });
            host.querySelector('[data-role="add-preset"]')?.addEventListener('click', () => {
                const row = host.querySelector('tr[data-idx="new"]');
                const [s, t, r] = row.querySelectorAll('input.inline-input');
                const col = row.querySelector('input.inline-color').value;
                const subject = (s.value || '').trim();
                if (!subject) return;
                dataState.presets.push({ subject, teacher: t.value.trim(), room: r.value.trim(), color: col });
                if (!dataState.subjects.includes(subject)) dataState.subjects.push(subject);
                if (!dataState.subjectColors[subject]) dataState.subjectColors[subject] = col;
                saveData(); renderPresetManager();
            });
        }

        /* =================== FOLDERS (wie gehabt) =================== */
        const foldersGrid = byId('foldersGrid'); const foldersEmpty = byId('foldersEmpty'); const dropzone = byId('dropzone'); const fileInput = byId('fileInput'); const newFolderBtn = byId('newFolderBtn'); const manageFoldersBtn = byId('manageFoldersBtn');
        const folderEditModal = byId('folderEditModal'); const folderNameInput = byId('folderNameInput'); const folderColorInput = byId('folderColorInput'); const folderSaveBtn = byId('folderSaveBtn'); const folderDeleteBtn = byId('folderDeleteBtn');
        const foldersManageModal = byId('foldersManageModal'); const manageList = byId('manageList');
        const folderDetailModal = byId('folderDetailModal'); const folderDetailTitle = byId('folderDetailTitle'); const folderDetailGrid = byId('folderDetailGrid');
        let editingFolderId = null;

        function renderFolders() {
            if (!foldersGrid) return;
            foldersGrid.innerHTML = ''; if (!folderState.folders.length) { if (foldersEmpty) foldersEmpty.hidden = false; return; } if (foldersEmpty) foldersEmpty.hidden = true;
            folderState.folders.forEach(f => {
                const card = div('folder-card');
                const top = div('folder-top'); const shape = div('folder-shape'); shape.style.background = f.color || '#e2e8f0'; const tab = div('folder-tab'); shape.appendChild(tab);
                const name = div('folder-name', f.name); const count = div('count-badge', `${f.items.length}`); const handle = div('drag-handle', '⋮⋮'); top.append(shape, name, count, handle); card.append(top);
                const actions = div('folder-actions');
                const openBtn = document.createElement('button'); openBtn.className = 'btn mini'; openBtn.textContent = 'Öffnen'; openBtn.addEventListener('click', () => openFolderDetail(f.id));
                const editBtn = document.createElement('button'); editBtn.className = 'btn mini ghost'; editBtn.textContent = 'Bearbeiten'; editBtn.addEventListener('click', () => openFolderEdit(f.id));
                actions.append(openBtn, editBtn); card.append(actions); foldersGrid.appendChild(card);
            });
        }
        function openFolderEdit(id = null) {
            editingFolderId = id; let name = '', color = colors[Math.floor(Math.random() * colors.length)];
            if (id) { const f = folderState.folders.find(x => x.id === id); if (!f) return; name = f.name; color = f.color || color; }
            folderNameInput.value = name; folderColorInput.value = color; folderDeleteBtn.style.display = id ? '' : 'none'; showModal(folderEditModal, '#folderNameInput');
        }
        folderSaveBtn.addEventListener('click', () => {
            const name = (folderNameInput.value || '').trim() || 'Neuer Ordner'; const color = folderColorInput.value || '#e2e8f0';
            if (editingFolderId) { const idx = folderState.folders.findIndex(f => f.id === editingFolderId); if (idx >= 0) folderState.folders[idx] = { ...folderState.folders[idx], name, color }; }
            else folderState.folders.push({ id: uid(), name, color, items: [] });
            saveFolders(); hideModal(folderEditModal); renderFolders();
        });
        folderDeleteBtn.addEventListener('click', () => { if (!editingFolderId) return; if (!confirm('Diesen Ordner wirklich löschen? Dateien darin werden verworfen.')) return; folderState.folders = folderState.folders.filter(f => f.id !== editingFolderId); saveFolders(); hideModal(folderEditModal); renderFolders(); });
        newFolderBtn.addEventListener('click', () => openFolderEdit(null));
        manageFoldersBtn.addEventListener('click', () => openFoldersManage());

        function openFoldersManage() {
            manageList.innerHTML = ''; if (!folderState.folders.length) { manageList.innerHTML = '<div class="small" style="padding:8px">Keine Ordner vorhanden.</div>'; }
            else folderState.folders.forEach((f, idx) => {
                const row = div('file-tile'); row.setAttribute('draggable', 'true'); row.dataset.index = String(idx); row.style.borderStyle = 'solid';
                row.innerHTML = `<div><strong>⋮⋮ ${f.name}</strong></div><div class="small">${f.items.length} Elemente</div>`;
                row.addEventListener('dragstart', e => { row.classList.add('dragging'); e.dataTransfer.setData('text/plain', row.dataset.index); });
                row.addEventListener('dragend', () => row.classList.remove('dragging'));
                row.addEventListener('dragover', e => e.preventDefault());
                row.addEventListener('drop', e => { e.preventDefault(); const from = Number(e.dataTransfer.getData('text/plain')); const to = Number(row.dataset.index); if (Number.isNaN(from) || Number.isNaN(to) || from === to) return; const arr = [...folderState.folders]; const [moved] = arr.splice(from, 1); arr.splice(to, 0, moved); folderState.folders = arr; saveFolders(); openFoldersManage(); });
                row.addEventListener('click', () => { hideModal(foldersManageModal); openFolderEdit(f.id); });
                manageList.appendChild(row);
            });
            showModal(foldersManageModal, '.file-tile');
        }
        function openFolderDetail(id) {
            const f = folderState.folders.find(x => x.id === id); if (!f) return; folderDetailTitle.textContent = `Ordner: ${f.name}`;
            folderDetailGrid.innerHTML = ''; if (!f.items.length) { folderDetailGrid.innerHTML = '<div class="small">Keine Dateien in diesem Ordner.</div>'; }
            else f.items.forEach(it => folderDetailGrid.appendChild(fileTile(it, () => { f.items = f.items.filter(x => x.id !== it.id); saveFolders(); openFolderDetail(id); renderFolders(); })));
            showModal(folderDetailModal, '.btn.ghost');
        }

        /* Upload & analysis */
        dropzone?.addEventListener('click', () => fileInput.click());
        dropzone?.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('over'); });
        dropzone?.addEventListener('dragleave', () => dropzone.classList.remove('over'));
        dropzone?.addEventListener('drop', e => { e.preventDefault(); dropzone.classList.remove('over'); const files = [...(e.dataTransfer?.files || [])]; if (files.length) handleFiles(files); });
        fileInput?.addEventListener('change', () => { const files = [...(fileInput.files || [])]; if (files.length) handleFiles(files); fileInput.value = ''; });

        function extFromName(name) { const m = /\.([a-z0-9]+)$/i.exec(name); return m ? m[1].toLowerCase() : 'txt'; }
        function fileTile(item, onRemove) {
            const t = div('file-tile'); const ico = div('file-ico'); const ext = div('ext', item.ext.toUpperCase());
            const name = div('file-name', item.name); const meta = div('file-meta', `${item.topic} • Note: ${item.grade}/100 • ${new Date(item.added).toLocaleString()}`);
            const hueMap = { pdf: '#ef4444', doc: '#5b21b6', docx: '#5b21b6', ppt: '#d97706', pptx: '#d97706', xls: '#16a34a', xlsx: '#16a34a', md: '#0ea5e9', txt: '#64748b', json: '#10b981', js: '#f59e0b', ts: '#6366f1', py: '#22c55e', cs: '#9333ea', java: '#ea580c' };
            ico.style.background = (hueMap[item.ext] || '#eef2f7');
            t.append(ico, ext, name, meta); const actions = div('tile-actions'); const del = document.createElement('button'); del.className = 'btn mini danger'; del.textContent = 'Entfernen'; del.addEventListener('click', onRemove); actions.append(del); t.append(actions); return t;
        }
        async function handleFiles(files) {
            for (const file of files) {
                const name = file.name; const ext = extFromName(name);
                let text = ''; if (file.type?.startsWith('text/') || /\.(md|json|cs|py|js|ts|java|html|css)$/i.test(name)) { text = await file.text(); }
                else if (/\.pdf$/i.test(name)) { text = '[PDF – Inhalt nicht analysiert]'; } else { text = '[Unbekannter Dateityp – rudimentär analysiert]'; }
                const analysis = analyzeFileContent(text, name);
                const folderId = ensureFolderForTopic(analysis.topic);
                const item = { id: uid(), name, ext, topic: analysis.topic, grade: analysis.grade, notes: analysis.notes, added: new Date().toISOString() };
                const f = folderState.folders.find(x => x.id === folderId); f.items.unshift(item);
            }
            saveFolders(); renderFolders(); alert('Dateien analysiert und einsortiert.');
        }
        function analyzeFileContent(text, filename) {
            const lower = (text + ' ' + filename).toLowerCase();
            const topics = [{ topic: 'Mathe', kws: ['mathe', 'algebra', 'geometrie', 'gleichung', 'funktion', 'statistik', 'integral', 'ableitung'] }, { topic: 'Deutsch', kws: ['deutsch', 'grammatik', 'gedicht', 'satz', 'analyse', 'interpretation', 'rechtschreibung'] }, { topic: 'Englisch', kws: ['englisch', 'english', 'grammar', 'essay', 'vocabulary'] }, { topic: 'Informatik', kws: ['informatik', 'programm', 'code', 'algorithmus', 'java', 'python', 'javascript', 'html', 'css', 'daten'] }, { topic: 'Biologie', kws: ['biologie', 'zelle', 'gen', 'dna', 'evolution', 'pflanze', 'tier'] }, { topic: 'Chemie', kws: ['chemie', 'reaktion', 'säure', 'base', 'molekül', 'atom', 'periodensystem'] }, { topic: 'Physik', kws: ['physik', 'kraft', 'energie', 'bewegung', 'spannung', 'strom', 'welle'] }, { topic: 'Geschichte', kws: ['geschichte', 'antik', 'mittelalter', 'krieg', 'revolution', 'historisch'] }, { topic: 'Geographie', kws: ['geographie', 'erde', 'klima', 'karte', 'kontinent', 'geologie'] }];
            let best = { topic: 'Allgemein', score: 0 }; topics.forEach(t => { const hits = t.kws.reduce((a, kw) => a + (lower.includes(kw) ? 1 : 0), 0); if (hits > best.score) best = { topic: t.topic, score: hits }; });
            let grade = 60; const rewards = [/\b\d{2,}\b/g, /#{1,6}\s\w+/g, /```[\s\S]*?```/g, /\b(formel|beweis|beispiel|definition)\b/gi, /\bquelle|referenz|literatur\b/gi];
            const penalties = [/\b(stimmt nicht|falsch|fehler|unklar|widerspruch)\b/gi, /\?\?/g, /\b(lorem ipsum|platzhalter)\b/gi];
            rewards.forEach(rx => { const m = lower.match(rx); if (m) grade += Math.min(10, m.length * 2); });
            penalties.forEach(rx => { const m = lower.match(rx); if (m) grade -= Math.min(20, m.length * 4); });
            grade = clamp(Math.round(grade), 1, 100);
            const notes = `Erkannter Themenbereich: ${best.topic}. (Heuristische Bewertung – offline)`;
            return { topic: best.topic, grade, notes };
        }
        function ensureFolderForTopic(topic) { let f = folderState.folders.find(x => x.name.toLowerCase() === topic.toLowerCase()); if (!f) { const color = colors[Math.floor(Math.random() * colors.length)]; f = { id: uid(), name: topic, color, items: [] }; folderState.folders.push(f); } return f.id; }

        /* =================== SETTINGS (Section) =================== */
        const daysInput = byId('daysInput'), periodMinInput = byId('periodMinInput'), periodCountInput = byId('periodCountInput'), breakMinInput = byId('breakMinInput');
        
        // Auto-save settings on input change
        function autoSaveSettings() {
            // Get selected weekdays from checkboxes
            const selectedDays = [];
            const dayCheckboxes = ['day-mo', 'day-di', 'day-mi', 'day-do', 'day-fr', 'day-sa', 'day-so'];
            const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            
            dayCheckboxes.forEach((id, index) => {
                const checkbox = byId(id);
                if (checkbox && checkbox.checked) {
                    selectedDays.push(dayNames[index]);
                }
            });
            
            state.days = selectedDays.length ? selectedDays : defaultDays;
            const newPeriodMinutes = clamp(parseInt(byId('periodMinSlider')?.value || '45', 10), 15, 120);
            const newPeriodCount = clamp(parseInt(byId('periodCountSlider')?.value || '8', 10), 4, 50);
            const newBreakMinutes = clamp(parseInt(byId('breakMinSlider')?.value || '5', 10), 0, 60);
            
            // Check if any settings changed and regenerate time slots for all weeks if needed
            const settingsChanged = state.periodMinutes !== newPeriodMinutes || 
                                  state.periodCount !== newPeriodCount || 
                                  state.breakMinutes !== newBreakMinutes;
            
            state.periodMinutes = newPeriodMinutes;
            state.periodCount = newPeriodCount;
            state.breakMinutes = newBreakMinutes;
            
            if (settingsChanged) {
                // Regenerate time slots for all existing week plans
                weekPlans.forEach((plan, weekKey) => {
                    plan.periodMinutes = state.periodMinutes;
                    plan.periodCount = state.periodCount;
                    plan.breakMinutes = state.breakMinutes;
                    regenerateTimeSlotsForPeriodCount(plan);
                });
            }
            
            // Sync overview state with new settings
            syncOverviewState();
            
            savePlan();
            renderGrid();
            renderOverview();
            renderSettingsStats(); // Update settings stats cards
        }
        
        // Populate settings inputs with current state
        function populateSettingsInputs() {
            // Set weekday checkboxes
            const dayCheckboxes = ['day-mo', 'day-di', 'day-mi', 'day-do', 'day-fr', 'day-sa', 'day-so'];
            const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            
            dayCheckboxes.forEach((id, index) => {
                const checkbox = byId(id);
                if (checkbox) {
                    checkbox.checked = state.days.includes(dayNames[index]);
                }
            });
            
            // Set sliders and their values
            const periodMinSlider = byId('periodMinSlider');
            const periodMinValue = byId('periodMinValue');
            if (periodMinSlider && periodMinValue) {
                periodMinSlider.value = state.periodMinutes;
                periodMinValue.textContent = state.periodMinutes;
            }
            
            const periodCountSlider = byId('periodCountSlider');
            const periodCountValue = byId('periodCountValue');
            if (periodCountSlider && periodCountValue) {
                periodCountSlider.value = state.periodCount;
                periodCountValue.textContent = state.periodCount;
            }
            
            const breakMinSlider = byId('breakMinSlider');
            const breakMinValue = byId('breakMinValue');
            if (breakMinSlider && breakMinValue) {
                breakMinSlider.value = state.breakMinutes;
                breakMinValue.textContent = state.breakMinutes;
            }
        }
        
        // Add event listeners for auto-save
        function initializeSettingsControls() {
            // Weekday checkboxes with range selection
            const dayCheckboxes = ['day-mo', 'day-di', 'day-mi', 'day-do', 'day-fr', 'day-sa', 'day-so'];
            dayCheckboxes.forEach((id, index) => {
                const checkbox = byId(id);
                if (checkbox) {
                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            // Select this day and all previous days
                            for (let i = 0; i <= index; i++) {
                                const prevCheckbox = byId(dayCheckboxes[i]);
                                if (prevCheckbox) {
                                    prevCheckbox.checked = true;
                                }
                            }
                        } else {
                            // Unselect this day and all following days
                            for (let i = index; i < dayCheckboxes.length; i++) {
                                const nextCheckbox = byId(dayCheckboxes[i]);
                                if (nextCheckbox) {
                                    nextCheckbox.checked = false;
                                }
                            }
                        }
                        autoSaveSettings();
                    });
                }
            });
            
            // Sliders with value updates
            const periodMinSlider = byId('periodMinSlider');
            const periodMinValue = byId('periodMinValue');
            if (periodMinSlider && periodMinValue) {
                periodMinSlider.addEventListener('input', (e) => {
                    periodMinValue.textContent = e.target.value;
                    autoSaveSettings();
                });
            }
            
            const periodCountSlider = byId('periodCountSlider');
            const periodCountValue = byId('periodCountValue');
            if (periodCountSlider && periodCountValue) {
                periodCountSlider.addEventListener('input', (e) => {
                    periodCountValue.textContent = e.target.value;
                    autoSaveSettings();
                });
            }
            
            const breakMinSlider = byId('breakMinSlider');
            const breakMinValue = byId('breakMinValue');
            if (breakMinSlider && breakMinValue) {
                breakMinSlider.addEventListener('input', (e) => {
                    breakMinValue.textContent = e.target.value;
                    autoSaveSettings();
                });
            }
        }
        
        // Initialize settings controls
        initializeSettingsControls();
        
        // Initialize plan settings
        initializePlanSettings();
        
        // Navigation initialization is now handled in initializeApp() to avoid conflicts
        
        // Populate settings inputs on page load
        populateSettingsInputs();
        
        // Plan settings functionality
        function initializePlanSettings() {
            // Initialize data arrays
            window.planData = {
                subjects: JSON.parse(localStorage.getItem('planSubjects') || '[]'),
                teachers: JSON.parse(localStorage.getItem('planTeachers') || '[]'),
                rooms: JSON.parse(localStorage.getItem('planRooms') || '[]'),
                colors: JSON.parse(localStorage.getItem('planColors') || '[]'),
                presets: JSON.parse(localStorage.getItem('planPresets') || '[]')
            };
            
            // Initialize default colors if empty
            if (window.planData.colors.length === 0) {
                window.planData.colors = [
                    { name: 'Blau', color: '#6366f1' },
                    { name: 'Rot', color: '#ef4444' },
                    { name: 'Grün', color: '#10b981' },
                    { name: 'Gelb', color: '#f59e0b' },
                    { name: 'Lila', color: '#8b5cf6' },
                    { name: 'Orange', color: '#f97316' }
                ];
                savePlanData();
            }
            
            // Render all components
            renderDataLists();
            renderColorPresets();
            renderPresets();
            
            // Attach event listeners
            attachPlanSettingsListeners();
            
            // Initialize week-specific settings
            updatePlanSettingsForCurrentWeek();
            attachWeekSpecificSettingsListeners();
        }

        function updatePlanSettingsForCurrentWeek() {
            const plan = weekPlans.get(currentPlanWeek);
            if (!plan) {
                console.warn('No plan found for week:', currentPlanWeek);
                return;
            }

            console.log('Updating plan settings for week:', currentPlanWeek, 'with values:', {
                periodMinutes: plan.periodMinutes,
                periodCount: plan.periodCount,
                breakMinutes: plan.breakMinutes
            });

            // Update week badge
            const weekBadge = byId('currentWeekBadge');
            if (weekBadge) {
                const weekNumber = currentPlanWeek.split('-W')[1];
                weekBadge.textContent = `W${weekNumber}`;
            }

            // Update weekday checkboxes
            const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            dayNames.forEach((day, index) => {
                const checkbox = byId(`plan-day-${day.toLowerCase()}`);
                if (checkbox) {
                    checkbox.checked = plan.days.includes(day);
                }
            });

            // Update sliders
            const periodMinSlider = byId('plan-periodMinSlider');
            const periodMinValue = byId('plan-periodMinValue');
            if (periodMinSlider && periodMinValue) {
                periodMinSlider.value = plan.periodMinutes;
                periodMinValue.textContent = plan.periodMinutes;
                console.log('Updated periodMinSlider to:', plan.periodMinutes);
            }

            const periodCountSlider = byId('plan-periodCountSlider');
            const periodCountValue = byId('plan-periodCountValue');
            if (periodCountSlider && periodCountValue) {
                periodCountSlider.value = plan.periodCount;
                periodCountValue.textContent = plan.periodCount;
                console.log('Updated periodCountSlider to:', plan.periodCount);
            }

            const breakMinSlider = byId('plan-breakMinSlider');
            const breakMinValue = byId('plan-breakMinValue');
            if (breakMinSlider && breakMinValue) {
                breakMinSlider.value = plan.breakMinutes;
                breakMinValue.textContent = plan.breakMinutes;
                console.log('Updated breakMinSlider to:', plan.breakMinutes);
            }

            const startTimeSlider = byId('plan-startTimeSlider');
            const startTimeValue = byId('plan-startTimeValue');
            if (startTimeSlider && startTimeValue) {
                startTimeSlider.value = plan.dayStart.h;
                startTimeValue.textContent = `${plan.dayStart.h.toString().padStart(2, '0')}:00`;
                console.log('Updated startTimeSlider to:', plan.dayStart.h);
            }
            
            // Update slider max values after setting all values
            validateAndAdjustSettings();
        }

        function attachWeekSpecificSettingsListeners() {
            // Weekday checkboxes with range selection
            const dayNames = ['mo', 'di', 'mi', 'do', 'fr', 'sa', 'so'];
            dayNames.forEach((day, index) => {
                const checkbox = byId(`plan-day-${day}`);
                if (checkbox) {
                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            // Select this day and all previous days
                            for (let i = 0; i <= index; i++) {
                                const prevCheckbox = byId(`plan-day-${dayNames[i]}`);
                                if (prevCheckbox) {
                                    prevCheckbox.checked = true;
                                }
                            }
                        } else {
                            // Unselect this day and all following days
                            for (let i = index; i < dayNames.length; i++) {
                                const nextCheckbox = byId(`plan-day-${dayNames[i]}`);
                                if (nextCheckbox) {
                                    nextCheckbox.checked = false;
                                }
                            }
                        }
                        savePlanSettingsForCurrentWeek();
                    });
                }
            });

            // Sliders
            const periodMinSlider = byId('plan-periodMinSlider');
            const periodMinValue = byId('plan-periodMinValue');
            if (periodMinSlider && periodMinValue) {
                periodMinSlider.addEventListener('input', (e) => {
                    periodMinValue.textContent = e.target.value;
                    updateSliderMaxValues(); // Update max values when period duration changes
                    savePlanSettingsForCurrentWeek();
                });
            }

            const periodCountSlider = byId('plan-periodCountSlider');
            const periodCountValue = byId('plan-periodCountValue');
            if (periodCountSlider && periodCountValue) {
                periodCountSlider.addEventListener('input', (e) => {
                    periodCountValue.textContent = e.target.value;
                    savePlanSettingsForCurrentWeek();
                });
            }

            const breakMinSlider = byId('plan-breakMinSlider');
            const breakMinValue = byId('plan-breakMinValue');
            if (breakMinSlider && breakMinValue) {
                breakMinSlider.addEventListener('input', (e) => {
                    breakMinValue.textContent = e.target.value;
                    updateSliderMaxValues(); // Update max values when break duration changes
                    savePlanSettingsForCurrentWeek();
                });
            }

            const startTimeSlider = byId('plan-startTimeSlider');
            const startTimeValue = byId('plan-startTimeValue');
            if (startTimeSlider && startTimeValue) {
                startTimeSlider.addEventListener('input', (e) => {
                    const hour = parseInt(e.target.value);
                    startTimeValue.textContent = `${hour.toString().padStart(2, '0')}:00`;
                    updateSliderMaxValues(); // Update max values when start time changes
                    savePlanSettingsForCurrentWeek();
                });
            }
        }

        function savePlanSettingsForCurrentWeek() {
            console.log('=== SAVE PLAN SETTINGS ===');
            
            const plan = weekPlans.get(currentPlanWeek);
            if (!plan) {
                console.warn('No plan found for current week:', currentPlanWeek);
                return;
            }

            // Update days
            const dayNames = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            const selectedDays = [];
            dayNames.forEach((day, index) => {
                const checkbox = byId(`plan-day-${day.toLowerCase()}`);
                if (checkbox && checkbox.checked) {
                    selectedDays.push(day);
                }
            });
            plan.days = selectedDays.length ? selectedDays : ['Mo', 'Di', 'Mi', 'Do', 'Fr'];

            // Update period settings from sliders
            const newPeriodMinutes = clamp(parseInt(byId('plan-periodMinSlider')?.value || '45', 10), 15, 120);
            const newPeriodCount = clamp(parseInt(byId('plan-periodCountSlider')?.value || '8', 10), 4, 50);
            const newBreakMinutes = clamp(parseInt(byId('plan-breakMinSlider')?.value || '5', 10), 0, 60);
            const newStartHour = clamp(parseInt(byId('plan-startTimeSlider')?.value || '8', 10), 0, 23);
            
            console.log('Slider values:', {
                periodMinutes: newPeriodMinutes,
                periodCount: newPeriodCount,
                breakMinutes: newBreakMinutes,
                startHour: newStartHour
            });
            
            console.log('Old plan values:', {
                periodMinutes: plan.periodMinutes,
                periodCount: plan.periodCount,
                breakMinutes: plan.breakMinutes,
                dayStart: plan.dayStart
            });
            
            // Always update plan values
            plan.periodMinutes = newPeriodMinutes;
            plan.breakMinutes = newBreakMinutes;
            plan.dayStart = { h: newStartHour, m: 0 }; // Update week-specific start time
            
            // Calculate maximum possible periods for this start time
            const maxPeriods = getMaxPeriodsForDay(newStartHour, 0, newPeriodMinutes, newBreakMinutes);
            plan.periodCount = Math.min(newPeriodCount, maxPeriods);
            
            console.log('Max periods for start time', newStartHour + ':00:', maxPeriods);
            console.log('Setting period count to:', plan.periodCount);
            
            // Also update the global state to ensure consistency
            state.periodMinutes = newPeriodMinutes;
            state.periodCount = newPeriodCount;
            state.breakMinutes = newBreakMinutes;
            
            console.log('Updated plan values:', {
                periodMinutes: plan.periodMinutes,
                periodCount: plan.periodCount,
                breakMinutes: plan.breakMinutes,
                dayStart: plan.dayStart
            });

            // Save and re-render
            saveWeekPlans();
            renderGrid();
            renderOverview();
            
            console.log('=== PLAN SETTINGS SAVED ===');
        }
        
        function attachPlanSettingsListeners() {
            // Data input listeners
            byId('addSubjectBtn')?.addEventListener('click', () => addDataItem('subjects'));
            byId('addTeacherBtn')?.addEventListener('click', () => addDataItem('teachers'));
            byId('addRoomBtn')?.addEventListener('click', () => addDataItem('rooms'));
            byId('addColorBtn')?.addEventListener('click', () => addColorPreset());
            
            // Preset listeners
            const addPresetBtn = byId('addPresetBtn');
            const createPresetBtn = byId('createPresetBtn');
            
            if (addPresetBtn && !addPresetBtn.hasAttribute('data-listener-added')) {
                addPresetBtn.addEventListener('click', () => addQuickPreset());
                addPresetBtn.setAttribute('data-listener-added', 'true');
            }
            
            if (createPresetBtn && !createPresetBtn.hasAttribute('data-listener-added')) {
                createPresetBtn.addEventListener('click', () => showPresetModal());
                createPresetBtn.setAttribute('data-listener-added', 'true');
            }
            
            // Enter key listeners
            ['subjectsInput', 'teachersInput', 'roomsInput', 'colorNameInput'].forEach(id => {
                byId(id)?.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (id === 'colorNameInput') {
                            addColorPreset();
                        } else {
                            addDataItem(id.replace('Input', ''));
                        }
                    }
                });
            });
        }
        
        function addDataItem(type) {
            const input = byId(`${type}Input`);
            if (!input || !input.value.trim()) return;
            
            const items = input.value.split(',').map(s => s.trim()).filter(Boolean);
            window.planData[type].push(...items);
            window.planData[type] = [...new Set(window.planData[type])]; // Remove duplicates
            
            input.value = '';
            renderDataLists();
            savePlanData();
        }
        
        function removeDataItem(type, index) {
            window.planData[type].splice(index, 1);
            renderDataLists();
            savePlanData();
        }
        
        function addColorPreset() {
            const colorInput = byId('customColor');
            const nameInput = byId('colorNameInput');
            
            if (!colorInput || !nameInput || !nameInput.value.trim()) return;
            
            const newColor = {
                name: nameInput.value.trim(),
                color: colorInput.value
            };
            
            window.planData.colors.push(newColor);
            nameInput.value = '';
            renderColorPresets();
            savePlanData();
        }
        
        function removeColorPreset(index) {
            window.planData.colors.splice(index, 1);
            renderColorPresets();
            savePlanData();
        }
        
        function renderDataLists() {
            ['subjects', 'teachers', 'rooms'].forEach(type => {
                const container = byId(`${type}List`);
                const countElement = byId(`${type}Count`);
                
                if (!container) return;
                
                container.innerHTML = window.planData[type].map((item, index) => `
                    <div class="color-preset">
                        <span class="color-preset-name">${item}</span>
                        <button class="preset-btn delete" onclick="removeDataItem('${type}', ${index})" title="Entfernen">×</button>
                    </div>
                `).join('');
                
                if (countElement) {
                    countElement.textContent = window.planData[type].length;
                }
            });
            
            // Update colors count
            const colorsCount = byId('colorsCount');
            if (colorsCount) {
                colorsCount.textContent = window.planData.colors.length;
            }
        }
        
        function renderColorPresets() {
            const container = byId('colorsList');
            if (!container) return;
            
            container.innerHTML = window.planData.colors.map((colorPreset, index) => `
                <div class="color-preset" onclick="selectColorPreset(${index})">
                    <div class="color-preset-preview" style="background: ${colorPreset.color}"></div>
                    <span class="color-preset-name">${colorPreset.name}</span>
                    <button class="preset-btn delete" onclick="event.stopPropagation(); removeColorPreset(${index})" title="Entfernen">×</button>
                </div>
            `).join('');
        }
        
        function selectColorPreset(index) {
            const colorPreset = window.planData.colors[index];
            byId('customColor').value = colorPreset.color;
            byId('colorNameInput').value = colorPreset.name;
        }
        
        function renderPresets() {
            const container = byId('presetsList');
            const count = byId('presetsCount');
            
            if (!container) return;
            
            if (window.planData.presets.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #9ca3af; font-size: 13px;">
                        Noch keine Presets erstellt.<br>
                        Klicken Sie auf "Preset" um ein neues zu erstellen.
                    </div>
                `;
            } else {
                container.innerHTML = window.planData.presets.map((preset, index) => `
                    <div class="preset-container">
                        <div class="preset-item" data-index="${index}">
                            <div class="preset-color" style="background: ${preset.color}"></div>
                            <div class="preset-info">
                                <h4 class="preset-name">${preset.name}</h4>
                                <p class="preset-details">${preset.subject} • ${preset.teacher} • ${preset.room}</p>
                            </div>
                            <div class="preset-actions">
                                <button class="preset-btn edit" onclick="togglePresetEdit(${index})" title="Bearbeiten">✏</button>
                                <button class="preset-btn delete" onclick="deletePreset(${index})" title="Löschen">×</button>
                            </div>
                        </div>
                        <div class="preset-edit-panel" id="presetEdit${index}" style="display: none;">
                            <div class="preset-edit-form">
                                <div class="preset-edit-row">
                                    <div class="preset-edit-field">
                                        <label>Name</label>
                                        <input type="text" id="editName${index}" value="${preset.name}" class="preset-edit-input">
                                    </div>
                                    <div class="preset-edit-field">
                                        <label>Fach</label>
                                        <select id="editSubject${index}" class="preset-edit-input">
                                            <option value="">Fach wählen...</option>
                                            ${window.planData.subjects.map(subject => `<option value="${subject}" ${subject === preset.subject ? 'selected' : ''}>${subject}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                                <div class="preset-edit-row">
                                    <div class="preset-edit-field">
                                        <label>Lehrer</label>
                                        <select id="editTeacher${index}" class="preset-edit-input">
                                            <option value="">Lehrer wählen...</option>
                                            ${window.planData.teachers.map(teacher => `<option value="${teacher}" ${teacher === preset.teacher ? 'selected' : ''}>${teacher}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="preset-edit-field">
                                        <label>Raum</label>
                                        <select id="editRoom${index}" class="preset-edit-input">
                                            <option value="">Raum wählen...</option>
                                            ${window.planData.rooms.map(room => `<option value="${room}" ${room === preset.room ? 'selected' : ''}>${room}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                                <div class="preset-edit-row">
                                    <div class="preset-edit-field">
                                        <label>Farbe</label>
                                        <select id="editColor${index}" class="preset-edit-input">
                                            <option value="">Farbe wählen...</option>
                                            ${window.planData.colors.map(colorPreset => `<option value="${colorPreset.color}" ${colorPreset.color === preset.color ? 'selected' : ''}>${colorPreset.name}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="preset-edit-field">
                                        <label>Dauer</label>
                                        <input type="number" id="editDuration${index}" value="${preset.duration || 2}" min="1" max="8" class="preset-edit-input">
                                    </div>
                                </div>
                                <div class="preset-edit-actions">
                                    <button class="btn mini ghost" onclick="cancelPresetEdit(${index})">Abbrechen</button>
                                    <button class="btn mini primary" onclick="savePresetEdit(${index})">Speichern</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            if (count) {
                count.textContent = `${window.planData.presets.length} Preset${window.planData.presets.length !== 1 ? 's' : ''}`;
            }
        }
        
        function showPresetModal() {
            // Check if modal already exists
            const existingModal = document.querySelector('.preset-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create preset modal
            const modal = document.createElement('div');
            modal.className = 'modal preset-modal';
            modal.setAttribute('aria-hidden', 'true');
            modal.innerHTML = `
                <div class="backdrop"></div>
                <div class="dialog">
                    <button class="close-x" onclick="closePresetModal()">×</button>
                    <h3>Neues Preset erstellen</h3>
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="presetName" placeholder="z.B. Mathematik Grundkurs" class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Fach</label>
                            <select id="presetSubject" class="form-input">
                                <option value="">Fach wählen...</option>
                                ${window.planData.subjects.map(subject => `<option value="${subject}">${subject}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Lehrer</label>
                            <select id="presetTeacher" class="form-input">
                                <option value="">Lehrer wählen...</option>
                                ${window.planData.teachers.map(teacher => `<option value="${teacher}">${teacher}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Raum</label>
                            <select id="presetRoom" class="form-input">
                                <option value="">Raum wählen...</option>
                                ${window.planData.rooms.map(room => `<option value="${room}">${room}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Farbe</label>
                            <select id="presetColor" class="form-input">
                                <option value="">Farbe wählen...</option>
                                ${window.planData.colors.map(colorPreset => `<option value="${colorPreset.color}" data-name="${colorPreset.name}">${colorPreset.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Dauer</label>
                            <select id="presetDuration" class="form-input">
                                <option value="1">1 Stunde (45 Min)</option>
                                <option value="2" selected>2 Stunden (90 Min)</option>
                                <option value="3">3 Stunden (135 Min)</option>
                                <option value="4">4 Stunden (180 Min)</option>
                                <option value="5">5 Stunden (225 Min)</option>
                                <option value="6">6 Stunden (270 Min)</option>
                            </select>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn ghost" onclick="closePresetModal()">Abbrechen</button>
                        <button class="btn primary" onclick="savePreset()">Speichern</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            showModal(modal, '#presetName');
        }
        
        function closePresetModal() {
            const modal = document.querySelector('.preset-modal');
            if (modal) {
                hideModal(modal);
                setTimeout(() => modal.remove(), 300);
            }
        }
        
        function savePreset() {
            const name = byId('presetName')?.value.trim();
            const subject = byId('presetSubject')?.value;
            const teacher = byId('presetTeacher')?.value;
            const room = byId('presetRoom')?.value;
            const color = byId('presetColor')?.value;
            const duration = parseInt(byId('presetDuration')?.value || '2');
            
            if (!name || !subject || !teacher || !room || !color) {
                alert('Bitte füllen Sie alle Felder aus.');
                return;
            }
            
            const preset = {
                id: Date.now(),
                name,
                subject,
                teacher,
                room,
                color,
                duration
            };
            
            window.planData.presets.push(preset);
            renderPresets();
            savePlanData();
            closePresetModal();
        }
        
        function togglePresetEdit(index) {
            const editPanel = byId(`presetEdit${index}`);
            if (!editPanel) return;
            
            // Close any other open edit panels
            document.querySelectorAll('.preset-edit-panel').forEach(panel => {
                if (panel.id !== `presetEdit${index}`) {
                    panel.style.display = 'none';
                }
            });
            
            // Toggle current panel
            if (editPanel.style.display === 'none') {
                editPanel.style.display = 'block';
            } else {
                editPanel.style.display = 'none';
            }
        }

        function cancelPresetEdit(index) {
            const editPanel = byId(`presetEdit${index}`);
            if (editPanel) {
                editPanel.style.display = 'none';
            }
        }

        function savePresetEdit(index) {
            const name = byId(`editName${index}`)?.value.trim();
            const subject = byId(`editSubject${index}`)?.value;
            const teacher = byId(`editTeacher${index}`)?.value;
            const room = byId(`editRoom${index}`)?.value;
            const color = byId(`editColor${index}`)?.value;
            const duration = parseInt(byId(`editDuration${index}`)?.value || '2');
            
            if (!name || !subject || !teacher || !room || !color) {
                alert('Bitte füllen Sie alle Felder aus.');
                return;
            }
            
            // Update preset
            window.planData.presets[index] = {
                ...window.planData.presets[index],
                name,
                subject,
                teacher,
                room,
                color,
                duration
            };
            
            // Close edit panel and re-render
            cancelPresetEdit(index);
            renderPresets();
            savePlanData();
        }
        
        function updatePreset(index) {
            const name = byId('presetName')?.value.trim();
            const subject = byId('presetSubject')?.value;
            const teacher = byId('presetTeacher')?.value;
            const room = byId('presetRoom')?.value;
            const color = byId('presetColor')?.value;
            const duration = parseInt(byId('presetDuration')?.value || '2');
            
            if (!name || !subject || !teacher || !room || !color) {
                alert('Bitte füllen Sie alle Felder aus.');
                return;
            }
            
            window.planData.presets[index] = {
                ...window.planData.presets[index],
                name,
                subject,
                teacher,
                room,
                color,
                duration
            };
            
            renderPresets();
            savePlanData();
            closePresetModal();
        }
        
        function deletePreset(index) {
            if (confirm('Preset wirklich löschen?')) {
                window.planData.presets.splice(index, 1);
                renderPresets();
                savePlanData();
            }
        }
        
        function addQuickPreset() {
            // Prevent multiple rapid clicks
            const addPresetBtn = byId('addPresetBtn');
            if (addPresetBtn && addPresetBtn.disabled) {
                return;
            }
            
            // Disable button temporarily
            if (addPresetBtn) {
                addPresetBtn.disabled = true;
                setTimeout(() => {
                    addPresetBtn.disabled = false;
                }, 500);
            }
            
            // Check if we have data to create a preset
            if (window.planData.subjects.length === 0 || window.planData.teachers.length === 0 || window.planData.rooms.length === 0 || window.planData.colors.length === 0) {
                alert('Bitte fügen Sie zuerst Fächer, Lehrer, Räume und Farben hinzu.');
                return;
            }
            
            // Create a quick preset with first available data
            const preset = {
                id: Date.now(),
                name: `Preset ${window.planData.presets.length + 1}`,
                subject: window.planData.subjects[0],
                teacher: window.planData.teachers[0],
                room: window.planData.rooms[0],
                color: window.planData.colors[0].color,
                duration: 2
            };
            
            window.planData.presets.push(preset);
            renderPresets();
            savePlanData();
        }
        
        function savePlanData() {
            localStorage.setItem('planSubjects', JSON.stringify(window.planData.subjects));
            localStorage.setItem('planTeachers', JSON.stringify(window.planData.teachers));
            localStorage.setItem('planRooms', JSON.stringify(window.planData.rooms));
            localStorage.setItem('planColors', JSON.stringify(window.planData.colors));
            localStorage.setItem('planPresets', JSON.stringify(window.planData.presets));
        }
        
        function focusInput(inputId) {
            const input = byId(inputId);
            if (input) {
                input.focus();
                input.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function togglePlanSettings() {
            const settingsContainer = document.querySelector('.plan-settings');
            const header = document.querySelector('.plan-settings-header');
            
            if (settingsContainer && header) {
                settingsContainer.classList.toggle('collapsed');
                header.classList.toggle('collapsed');
            }
        }

        function toggleTimetableStructurePanel() {
            const panel = byId('timetableStructurePanel');
            if (panel) {
                panel.classList.toggle('open');
                
                // Update settings when opening panel
                if (panel.classList.contains('open')) {
                    updatePlanSettingsForCurrentWeek();
                }
            }
        }
        function saveSettingsFromForm() {
            const parsedDays = daysInput.value.split(',').map(s => s.trim()).filter(Boolean);
            state.days = parsedDays.length ? parsedDays : defaultDays;
            state.periodMinutes = clamp(parseInt(periodMinInput.value || '45', 10), 15, 120);
            state.periodCount = clamp(parseInt(periodCountInput.value || '8', 10), 4, 16);
            state.breakMinutes = clamp(parseInt(breakMinInput.value || '5', 10), 0, 60);
            savePlan(); renderGrid(); activatePill(byId('navPlan')); pagePlan.hidden = false; pageSettings.hidden = true;
        }

        /* =================== MODAL helpers =================== */
        let lastActiveEl = null;
        function showModal(modal, focusSel) { lastActiveEl = document.activeElement; modal.setAttribute('aria-hidden', 'false'); document.body.style.overflow = 'hidden'; (focusSel && modal.querySelector(focusSel) || modal.querySelector('input,button,select,textarea,[tabindex]'))?.focus(); }
        function hideModal(modal) { modal.setAttribute('aria-hidden', 'true'); document.body.style.overflow = ''; if (lastActiveEl && lastActiveEl.focus) lastActiveEl.focus(); }
        // Close modal only if the actual backdrop itself was clicked
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', e => {
                // Only close if click target IS the modal element or its .backdrop
                if (e.target === modal || e.target.classList.contains('backdrop')) {
                    hideModal(modal);
                }
            });
        });
        document.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', () => { const m = btn.closest('.modal'); if (m) hideModal(m); }));
        // esc + focus trap
        function trapFocus(e) { const open = [byId('infoModal'), byId('editModal'), byId('foldersManageModal'), byId('folderEditModal'), byId('folderDetailModal')].find(m => m.getAttribute('aria-hidden') === 'false'); if (!open) return; const f = [...open.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])')].filter(el => !el.hasAttribute('disabled')); if (!f.length) return; const first = f[0], last = f[f.length - 1]; if (e.key === 'Tab') { if (e.shiftKey && document.activeElement === first) { last.focus(); e.preventDefault(); } else if (!e.shiftKey && document.activeElement === last) { first.focus(); e.preventDefault(); } } else if (e.key === 'Escape') { hideModal(open); } }
        window.addEventListener('keydown', trapFocus);

        /* =================== HELPERS / INIT =================== */
        function div(cls, html) { const d = document.createElement('div'); if (cls) d.className = cls; if (html != null) d.innerHTML = html; return d; }

        // Initialize everything when DOM is ready
        function initializeApp() {
            loadAll();
            
            // Initialize settings early
            initializeSettingsToggles();
            initializeSettingsActions();
            
            // Update UI text based on current language
            updateUIText();
            
            // Sync overview state with current settings
            syncOverviewState();
            
            // Ensure overview week plan exists
            if (!weekPlans.has(overviewWeekKey)) {
                getOrCreateWeekPlan(overviewWeekKey);
            }
            
            // Only reset if no valid settings exist
            if (!localStorage.getItem(LS_PLAN) || state.lessons.length === 0) {
                console.log('No saved settings found, initializing with defaults');
                resetAllTimetableSettings();
            } else {
                console.log('Loading saved settings from localStorage');
                // Ensure current week plan exists
                if (!weekPlans.has(currentPlanWeek)) {
                    getOrCreateWeekPlan(currentPlanWeek);
                }
            }
            
            // Initialize current week plan if it doesn't exist
            if (!weekPlans.has(currentPlanWeek)) {
                getOrCreateWeekPlan(currentPlanWeek);
                // Copy current state to the week plan
                saveCurrentWeekPlan();
            } else {
                // Load the current week plan data into state
                const plan = weekPlans.get(currentPlanWeek);
                if (plan) {
                    state.lessons = [...plan.lessons];
                    state.days = [...plan.days];
                    state.periodMinutes = plan.periodMinutes;
                    state.breakMinutes = plan.breakMinutes;
                    state.periodCount = plan.periodCount;
                }
            }
            
            // Ensure overview week plan exists
            if (!weekPlans.has(overviewWeekKey)) {
                getOrCreateWeekPlan(overviewWeekKey);
            }
            
            // Ensure current week plan has the latest data from state
            saveCurrentWeekPlan();
            
            // Heatmap and Plan sections are independent - no synchronization
            
            // Initialize page visibility - restore last active page or default to overview
            const lastActivePage = sessionStorage.getItem('lastActivePage') || 'pageOverview';
            
            // Hide all pages first
            pageOverview.hidden = true;
            pagePlan.hidden = true;
            pageAnalysis.hidden = true;
            pageFolders.hidden = true;
            pageSettings.hidden = true;
            
            // Show the last active page
            const targetPage = byId(lastActivePage);
            if (targetPage) {
                targetPage.hidden = false;
                targetPage.classList.add('active');
                currentPage = lastActivePage; // Update currentPage variable
            } else {
                // Fallback to overview if page not found
                pageOverview.hidden = false;
                pageOverview.classList.add('active');
                currentPage = 'pageOverview';
            }
            
            // Activate corresponding pill with small delay to ensure DOM is ready
            setTimeout(() => {
                const lastActivePillId = lastActivePage.replace('page', 'nav');
                const targetPill = byId(lastActivePillId);
                if (targetPill) {
                    activatePill(targetPill);
                } else {
                    // Fallback to overview pill
                    activatePill(byId('navOverview'));
                }
            }, 50);
            
            renderGrid(); renderCurrent(); renderTeacherSelect(); renderDataSidebar(); renderFolders(); renderOverview();
            
            // Initialize week displays after loading
            updatePlanWeekDisplay();
            updateWeekDisplay();
            
            // Initialize activity display
            updateActivityDisplay();
        }

        // Run initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            // DOM is already ready
            initializeApp();
        }

        // ticker
        setInterval(() => {
            if (isResizing) {
                renderCurrent();
                if (redlineTip && !redlineTip.hidden) {
                    redlineTip.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                }
                return;
            }

            if (!pagePlan.hidden) {
                renderGrid();
                renderCurrent();
            } else if (!pageOverview.hidden) {
                renderOverview();
                renderCurrent(); // die kleine Leiste unter der Pillbar bleibt aktuell
            } else if (!pageAnalysis.hidden) {
                renderAnalysis();
            }

            if (redlineTip && !redlineTip.hidden) {
                redlineTip.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            }
        }, 1000);

        // --- Additions: helper to jump to tabs + make overview boxes clickable ---
        const goTo = (which) => {
            if (which === 'plan') byId('navPlan')?.click();
            else if (which === 'analysis') byId('navAnalysis')?.click();
            else if (which === 'folders') byId('navFolders')?.click();
            else if (which === 'settings') byId('navSettings')?.click();
            else byId('navOverview')?.click();
        };

        // after your existing renderOverview() definition runs, we (re)wire clicks each time:
        const _renderOverviewOrig = window.renderOverview;
        window.renderOverview = function () {
            _renderOverviewOrig();
            // Ordner-Badge im Hero: direkt zum Ordner
            const folderBadge = byId('ovHeroFolder');
            if (folderBadge) {
                folderBadge.addEventListener('click', (e) => {
                    e.stopPropagation(); // verhindert, dass der Hero zum Plan springt
                    const fid = folderBadge.getAttribute('data-folder-id');
                    if (!fid) return;
                    // Ordner-Detail öffnen
                    const f = folderState.folders.find(x => x.id === fid);
                    if (f) { openFolderDetail(f.id); }
                    // außerdem zur Folders-Seite wechseln
                    byId('navFolders')?.click();
                }, { once: false });
            }

            // Falls noch kein Ordner existiert: Anlegen-Button
            const createBtn = byId('ovHeroCreateFolder');
            if (createBtn) {
                createBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Fachname aus dem gerade/nächsten Lesson-Label ziehen
                    const info = currentOrNextLesson();
                    const subj = info && info.lesson ? (info.lesson.subject || 'Allgemein') : 'Allgemein';
                    // neuen Ordner anlegen (Farbe aus Fachfarbe)
                    const color = colorForSubject(subj);
                    const f = { id: uid(), name: subj, color, items: [] };
                    folderState.folders.unshift(f);
                    saveFolders();
                    renderFolders();
                    // gleich öffnen
                    byId('navFolders')?.click();
                    openFolderDetail(f.id);
                }, { once: true });
            }

            // click targets
            byId('ovHeroBox')?.addEventListener('click', () => goTo('plan'), { once: false });
            byId('kpiWeekBox')?.addEventListener('click', () => goTo('plan'), { once: false });
            byId('kpiFreeBox')?.addEventListener('click', () => goTo('plan'), { once: false });
            byId('kpiSubjectsBox')?.addEventListener('click', () => goTo('plan'), { once: false });
            byId('kpiFolders')?.addEventListener('click', (e) => { e.stopPropagation(); goTo('folders'); }, { once: false });

            byId('heatmapCard')?.addEventListener('click', (e) => {
                // Don't navigate if clicking on week navigation buttons
                if (!e.target.closest('.week-nav')) {
                    goTo('plan');
                }
            }, { once: false });

            byId('todayCard')?.addEventListener('click', () => goTo('plan'), { once: false });
            byId('recentCard')?.addEventListener('click', () => goTo('folders'), { once: false });
        };

        // Additional safety check for renderOverview after initialization
        setTimeout(() => {
            if (typeof window.renderOverview === 'function') {
                window.renderOverview();
            }
        }, 200);
        // smoke tests
        (function () { console.log('%cSelf-tests…', 'font-weight:bold'); console.assert(timeLabelFromMinutes({ h: 8, m: 0 }, 45) === '08:45', 'timeLabelFromMinutes'); console.log('%cOK', 'color:green'); })();
    </script>
</body>
</html>